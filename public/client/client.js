import{playWave as g_,setWaveVolume as $_,BZip2 as J_,playMidi as B_,stopMidi as S_,setMidiVolume as U_}from"./deps.js";var O0=document.getElementById("canvas"),d=O0.getContext("2d",{willReadFrequently:!0}),v0=document.createElement("canvas"),D0=document.createElement("img"),a0=v0.getContext("2d",{willReadFrequently:!0});class F0{key=0n;next=null;prev=null;unlink(){if(this.prev!=null){if(this.prev.next=this.next,this.next)this.next.prev=this.prev;this.next=null,this.prev=null}}}class j0 extends F0{next2=null;prev2=null;unlink2(){if(this.prev2!==null){if(this.prev2.next2=this.next2,this.next2)this.next2.prev2=this.prev2;this.next2=null,this.prev2=null}}}class T extends j0{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind(_,R,E){this.pixels=_,this.width2d=R,this.height2d=E,this.setBounds(0,0,R,E)}static resetBounds(){this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0}static setBounds(_,R,E,b){if(_<0)_=0;if(R<0)R=0;if(E>this.width2d)E=this.width2d;if(b>this.height2d)b=this.height2d;this.top=R,this.bottom=b,this.left=_,this.right=E,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0}static clear(){let _=this.width2d*this.height2d;for(let R=0;R<_;R++)this.pixels[R]=0}static drawRect(_,R,E,b,G){this.drawHorizontalLine(_,R,G,E),this.drawHorizontalLine(_,R+b-1,G,E),this.drawVerticalLine(_,R,G,b),this.drawVerticalLine(_+E-1,R,G,b)}static drawHorizontalLine(_,R,E,b){if(R<this.top||R>=this.bottom)return;if(_<this.left)b-=this.left-_,_=this.left;if(_+b>this.right)b=this.right-_;let G=_+R*this.width2d;for(let N=0;N<b;N++)this.pixels[G+N]=E}static drawVerticalLine(_,R,E,b){if(_<this.left||_>=this.right)return;if(R<this.top)b-=this.top-R,R=this.top;if(R+b>this.bottom)b=this.bottom-R;let G=_+R*this.width2d;for(let N=0;N<b;N++)this.pixels[G+N*this.width2d]=E}static drawLine(_,R,E,b,G){let N=Math.abs(E-_),L=Math.abs(b-R),H=_<E?1:-1,I=R<b?1:-1,Q=N-L;while(!0){if(_>=this.left&&_<this.right&&R>=this.top&&R<this.bottom)this.pixels[_+R*this.width2d]=G;if(_===E&&R===b)break;let q=2*Q;if(q>-L)Q=Q-L,_=_+H;if(q<N)Q=Q+N,R=R+I}}static fillRect2d(_,R,E,b,G){if(_<this.left)E-=this.left-_,_=this.left;if(R<this.top)b-=this.top-R,R=this.top;if(_+E>this.right)E=this.right-_;if(R+b>this.bottom)b=this.bottom-R;let N=this.width2d-E,L=_+R*this.width2d;for(let H=-b;H<0;H++){for(let I=-E;I<0;I++)this.pixels[L++]=G;L+=N}}static fillRectAlpha(_,R,E,b,G,N){if(_<this.left)E-=this.left-_,_=this.left;if(R<this.top)b-=this.top-R,R=this.top;if(_+E>this.right)E=this.right-_;if(R+b>this.bottom)b=this.bottom-R;let L=256-N,H=(G>>16&255)*N,I=(G>>8&255)*N,Q=(G&255)*N,q=this.width2d-E,O=_+R*this.width2d;for(let U=0;U<b;U++){for(let $=-E;$<0;$++){let K=(this.pixels[O]>>16&255)*L,u=(this.pixels[O]>>8&255)*L,F=(this.pixels[O]&255)*L,k=(H+K>>8<<16)+(I+u>>8<<8)+(Q+F>>8);this.pixels[O++]=k}O+=q}}static fillCircle(_,R,E,b,G){let N=256-G,L=(b>>16&255)*G,H=(b>>8&255)*G,I=(b&255)*G,Q=R-E;if(Q<0)Q=0;let q=R+E;if(q>=this.height2d)q=this.height2d-1;for(let O=Q;O<=q;O++){let U=O-R,$=Math.sqrt(E*E-U*U)|0,K=_-$;if(K<0)K=0;let u=_+$;if(u>=this.width2d)u=this.width2d-1;let F=K+O*this.width2d;for(let k=K;k<=u;k++){let j=(this.pixels[F]>>16&255)*N,m=(this.pixels[F]>>8&255)*N,Y=(this.pixels[F]&255)*N,X=(L+j>>8<<16)+(H+m>>8<<8)+(I+Y>>8);this.pixels[F++]=X}}}static setPixel(_,R,E){if(_<this.left||_>=this.right||R<this.top||R>=this.bottom)return;this.pixels[_+R*this.width2d]=E}}class m0{sentinel=new F0;current=null;constructor(){this.sentinel.next=this.sentinel,this.sentinel.prev=this.sentinel}addTail(_){if(_.prev)_.unlink();if(_.prev=this.sentinel.prev,_.next=this.sentinel,_.prev)_.prev.next=_;_.next.prev=_}addHead(_){if(_.prev)_.unlink();if(_.prev=this.sentinel,_.next=this.sentinel.next,_.prev.next=_,_.next)_.next.prev=_}removeHead(){let _=this.sentinel.next;if(_===this.sentinel)return null;return _?.unlink(),_}head(){let _=this.sentinel.next;if(_===this.sentinel)return this.current=null,null;return this.current=_?.next||null,_}tail(){let _=this.sentinel.prev;if(_===this.sentinel)return this.current=null,null;return this.current=_?.prev||null,_}next(){let _=this.current;if(_===this.sentinel)return this.current=null,null;return this.current=_?.next||null,_}prev(){let _=this.current;if(_===this.sentinel)return this.current=null,null;return this.current=_?.prev||null,_}clear(){while(!0){let _=this.sentinel.next;if(_===this.sentinel)return;_?.unlink()}}}var B0=async(_)=>new Promise((R)=>setTimeout(R,_)),c0=async(_)=>new Uint8Array(await(await fetch(_)).arrayBuffer());function K_(_,R,E,b,G){while(G--)E[b++]=_[R++]}function T_(_){let R=0n;for(let E=0;E<_.length;E++)R=R<<8n|BigInt(_[E]);return R}function V_(_){let R=[];while(_>0n)R.unshift(Number(_&0xffn)),_>>=8n;if(R[0]&128)R.unshift(0);return new Uint8Array(R)}function j_(_,R,E){let b=1n;while(R>0n){if(R%2n===1n)b=b*_%E;_=_*_%E,R>>=1n}return b}class f extends j0{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new m0;static cacheMid=new m0;static cacheMax=new m0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let _=0;_<32;_++)f.bitmask[_]=(1<<_)-1;f.bitmask[32]=4294967295;for(let _=0;_<256;_++){let R=_;for(let E=0;E<8;E++)if((R&1)===1)R=R>>>1^f.CRC32_POLYNOMIAL;else R>>>=1;f.crctable[_]=R}}static crc32(_){let R=4294967295;for(let E=0;E<_.length;E++)R=R>>>8^f.crctable[(R^_[E])&255];return~R}view;data;pos=0;bitPos=0;random=null;constructor(_){if(!_)throw new Error;super();if(_ instanceof Int8Array)this.data=new Uint8Array(_);else this.data=_;this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.length-this.pos}static alloc(_){let R=null;if(_===0&&f.cacheMinCount>0)f.cacheMinCount--,R=f.cacheMin.removeHead();else if(_===1&&f.cacheMidCount>0)f.cacheMidCount--,R=f.cacheMid.removeHead();else if(_===2&&f.cacheMaxCount>0)f.cacheMaxCount--,R=f.cacheMax.removeHead();if(R)return R.pos=0,R;if(_===0)return new f(new Uint8Array(100));else if(_===1)return new f(new Uint8Array(5000));return new f(new Uint8Array(30000))}release(){if(this.pos=0,this.view.byteLength===100&&f.cacheMinCount<1000)f.cacheMin.addTail(this),f.cacheMinCount++;else if(this.view.byteLength===5000&&f.cacheMidCount<250)f.cacheMid.addTail(this),f.cacheMidCount++;else if(this.view.byteLength===30000&&f.cacheMaxCount<50)f.cacheMax.addTail(this),f.cacheMaxCount++}g1(){return this.view.getUint8(this.pos++)}g1b(){return this.view.getInt8(this.pos++)}g2(){let _=this.view.getUint16(this.pos);return this.pos+=2,_}g2b(){let _=this.view.getInt16(this.pos);return this.pos+=2,_}g3(){let _=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,_}g4(){let _=this.view.getInt32(this.pos);return this.pos+=4,_}g8(){let _=this.view.getBigInt64(this.pos);return this.pos+=8,_}gsmart(){return this.view.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmarts(){return this.view.getUint8(this.pos)<128?this.g1():this.g2()-32768}gjstr(){let _=this.view,R=_.byteLength,E="",b;while((b=_.getUint8(this.pos++))!==10&&this.pos<R)E+=String.fromCharCode(b);return E}gdata(_,R,E){E.set(this.data.subarray(this.pos,this.pos+_),R),this.pos+=_}p1isaac(_){this.view.setUint8(this.pos++,_+(this.random?.nextInt??0)&255)}p1(_){this.view.setUint8(this.pos++,_)}p2(_){this.view.setUint16(this.pos,_),this.pos+=2}ip2(_){this.view.setUint16(this.pos,_,!0),this.pos+=2}p3(_){this.view.setUint8(this.pos++,_>>16),this.view.setUint16(this.pos,_),this.pos+=2}p4(_){this.view.setInt32(this.pos,_),this.pos+=4}ip4(_){this.view.setInt32(this.pos,_,!0),this.pos+=4}p8(_){this.view.setBigInt64(this.pos,_),this.pos+=8}pjstr(_){let R=this.view,E=_.length;for(let b=0;b<E;b++)R.setUint8(this.pos++,_.charCodeAt(b));R.setUint8(this.pos++,10)}pdata(_,R,E){this.data.set(_.subarray(E,E+R),this.pos),this.pos+=R-E}psize1(_){this.view.setUint8(this.pos-_-1,_)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(_){let R=this.bitPos>>>3,E=8-(this.bitPos&7),b=0;this.bitPos+=_;for(;_>E;E=8)b+=(this.view.getUint8(R++)&f.bitmask[E])<<_-E,_-=E;if(_===E)b+=this.view.getUint8(R)&f.bitmask[E];else b+=this.view.getUint8(R)>>>E-_&f.bitmask[_];return b}rsaenc(_,R){let E=this.pos;this.pos=0;let b=new Uint8Array(E);this.gdata(E,0,b);let G=T_(b),N=j_(G,R,_),L=V_(N);this.pos=0,this.p1(L.length),this.pdata(L,L.length,0)}}class I0 extends j0{pixels;width2d;height2d;cropX;cropY;cropW;cropH;rgbPal;constructor(_,R,E){super();this.pixels=new Int8Array(_*R),this.width2d=this.cropW=_,this.height2d=this.cropH=R,this.cropX=this.cropY=0,this.rgbPal=E}static fromArchive(_,R,E=0){let b=new f(_.read(R+".dat")),G=new f(_.read("index.dat"));G.pos=b.g2();let N=G.g2(),L=G.g2(),H=G.g1(),I=new Int32Array(H);for(let F=1;F<H;F++)if(I[F]=G.g3(),I[F]===0)I[F]=1;for(let F=0;F<E;F++)G.pos+=2,b.pos+=G.g2()*G.g2(),G.pos+=1;if(b.pos>b.length||G.pos>G.length)throw new Error;let Q=G.g1(),q=G.g1(),O=G.g2(),U=G.g2(),$=new I0(O,U,I);$.cropX=Q,$.cropY=q,$.cropW=N,$.cropH=L;let K=$.pixels,u=G.g1();if(u===0){let F=$.width2d*$.height2d;for(let k=0;k<F;k++)K[k]=b.g1b()}else if(u===1){let{width2d:F,height2d:k}=$;for(let j=0;j<F;j++)for(let m=0;m<k;m++)K[j+m*F]=b.g1b()}return $}draw(_,R){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let E=_+R*T.width2d,b=0,G=this.height2d,N=this.width2d,L=T.width2d-N,H=0;if(R<T.top){let I=T.top-R;G-=I,R=T.top,b+=I*N,E+=I*T.width2d}if(R+G>T.bottom)G-=R+G-T.bottom;if(_<T.left){let I=T.left-_;N-=I,_=T.left,b+=I,E+=I,H+=I,L+=I}if(_+N>T.right){let I=_+N-T.right;N-=I,H+=I,L+=I}if(N>0&&G>0)this.copyImage(N,G,this.pixels,b,H,T.pixels,E,L)}flipHorizontally(){let _=this.pixels,R=this.width2d,E=this.height2d;for(let b=0;b<E;b++){let G=R/2|0;for(let N=0;N<G;N++){let L=N+b*R,H=R-N-1+b*R,I=_[L];_[L]=_[H],_[H]=I}}}flipVertically(){let _=this.pixels,R=this.width2d,E=this.height2d;for(let b=0;b<(E/2|0);b++)for(let G=0;G<R;G++){let N=G+b*R,L=G+(E-b-1)*R,H=_[N];_[N]=_[L],_[L]=H}}translate2d(_,R,E){for(let b=0;b<this.rgbPal.length;b++){let G=this.rgbPal[b]>>16&255;if(G+=_,G<0)G=0;else if(G>255)G=255;let N=this.rgbPal[b]>>8&255;if(N+=R,N<0)N=0;else if(N>255)N=255;let L=this.rgbPal[b]&255;if(L+=E,L<0)L=0;else if(L>255)L=255;this.rgbPal[b]=(G<<16)+(N<<8)+L}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;let _=new Int8Array(this.cropW*this.cropH),R=0;for(let E=0;E<this.height2d;E++)for(let b=0;b<this.width2d;b++)_[(b+this.cropX>>1)+(E+this.cropY>>1)*this.cropW]=this.pixels[R++];this.pixels=_,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width2d===this.cropW&&this.height2d===this.cropH)return;let _=new Int8Array(this.cropW*this.cropH),R=0;for(let E=0;E<this.height2d;E++)for(let b=0;b<this.width2d;b++)_[b+this.cropX+(E+this.cropY)*this.cropW]=this.pixels[R++];this.pixels=_,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}copyImage(_,R,E,b,G,N,L,H){let I=-(_>>2);_=-(_&3);for(let Q=-R;Q<0;Q++){for(let q=I;q<0;q++){let O=E[b++];if(O===0)L++;else N[L++]=this.rgbPal[O&255];if(O=E[b++],O===0)L++;else N[L++]=this.rgbPal[O&255];if(O=E[b++],O===0)L++;else N[L++]=this.rgbPal[O&255];if(O=E[b++],O===0)L++;else N[L++]=this.rgbPal[O&255]}for(let q=_;q<0;q++){let O=E[b++];if(O===0)L++;else N[L++]=this.rgbPal[O&255]}L+=H,b+=G}}clip(_,R,E,b){try{let G=this.width2d,N=this.height2d,L=0,H=0,I=(G<<16)/E|0,Q=(N<<16)/b|0,q=this.cropW,O=this.cropH,U=(q<<16)/E|0,$=(O<<16)/b|0;if(_=_+(this.cropX*E+q-1)/q|0,R=R+(this.cropY*b+O-1)/O|0,this.cropX*E%q!=0)L=(q-this.cropX*E%q<<16)/E|0;if(this.cropY*b%O!=0)H=(O-this.cropY*b%O<<16)/b|0;E=E*(this.width2d-(L>>16))/q|0,b=b*(this.height2d-(H>>16))/O|0;let K=_+R*T.width2d,u=T.width2d-E,F;if(R<T.top)F=T.top-R,b-=F,R=0,K+=F*T.width2d,H+=$*F;if(R+b>T.bottom)b-=R+b-T.bottom;if(_<T.left)F=T.left-_,E-=F,_=0,K+=F,L+=U*F,u+=F;if(_+E>T.right)F=_+E-T.right,E-=F,u+=F;this.plot_scale(T.pixels,this.pixels,this.rgbPal,L,H,K,u,E,b,U,$,G)}catch(G){}}plot_scale(_,R,E,b,G,N,L,H,I,Q,q,O){try{let U=b;for(let $=-I;$<0;$++){let K=(G>>16)*O;for(let u=-H;u<0;u++){let F=R[(b>>16)+K];if(F==0)N++;else _[N++]=E[F&255];b+=Q}G+=q,b=U,N+=L}}catch(U){}}}class C extends Array{constructor(_,R){super(_);for(let E=0;E<_;E++)this[E]=R}}class F_ extends Array{constructor(_,R,E){super(_);for(let b=0;b<_;b++){this[b]=new Array(R);for(let G=0;G<R;G++)this[b][G]=E}}}class C0 extends Array{constructor(_,R,E,b){super(_);for(let G=0;G<_;G++){this[G]=new Array(R);for(let N=0;N<R;N++){this[G][N]=new Array(E);for(let L=0;L<E;L++)this[G][N][L]=b}}}}class d0 extends Array{constructor(_,R,E,b,G){super(_);for(let N=0;N<_;N++){this[N]=new Array(R);for(let L=0;L<R;L++){this[N][L]=new Array(E);for(let H=0;H<E;H++){this[N][L][H]=new Array(b);for(let I=0;I<b;I++)this[N][L][H][I]=G}}}}}class M0 extends Array{constructor(_,R,E){super(_);for(let b=0;b<_;b++){this[b]=new Array(R);for(let G=0;G<R;G++)this[b][G]=new Uint8Array(E)}}}class X0 extends Array{constructor(_,R){super(_);for(let E=0;E<_;E++)this[E]=new Int32Array(R)}}class h0 extends Array{constructor(_,R,E){super(_);for(let b=0;b<_;b++){this[b]=new Array(R);for(let G=0;G<R;G++)this[b][G]=new Int32Array(E)}}}class w extends T{static lowMemory=!1;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static hslPal=new Int32Array(65536);static textures=new C(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new C(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texPal=new C(50,null);static opaque=!1;static textureTranslucent=new C(50,!1);static averageTextureRGB=new Int32Array(50);static{for(let _=1;_<512;_++)this.reciprocal15[_]=32768/_|0;for(let _=1;_<2048;_++)this.reciprocal16[_]=65536/_|0;for(let _=0;_<2048;_++)this.sin[_]=Math.sin(_*0.0030679615757712823)*65536|0,this.cos[_]=Math.cos(_*0.0030679615757712823)*65536|0}static init2D(){this.lineOffset=new Int32Array(T.height2d);for(let _=0;_<T.height2d;_++)this.lineOffset[_]=T.width2d*_;this.centerX=T.width2d/2|0,this.centerY=T.height2d/2|0}static init3D(_,R){this.lineOffset=new Int32Array(R);for(let E=0;E<R;E++)this.lineOffset[E]=_*E;this.centerX=_/2|0,this.centerY=R/2|0}static clearTexels(){this.texelPool=null,this.activeTexels.fill(null)}static unpackTextures(_){this.textureCount=0;for(let R=0;R<50;R++)try{if(this.textures[R]=I0.fromArchive(_,R.toString()),this.lowMemory&&this.textures[R]?.cropW===128)this.textures[R]?.shrink();else this.textures[R]?.crop();this.textureCount++}catch(E){}}static getAverageTextureRGB(_){if(this.averageTextureRGB[_]!==0)return this.averageTextureRGB[_];let R=this.texPal[_];if(!R)return 0;let E=0,b=0,G=0,N=R.length;for(let H=0;H<N;H++)E+=R[H]>>16&255,b+=R[H]>>8&255,G+=R[H]&255;let L=((E/N|0)<<16)+((b/N|0)<<8)+(G/N|0);if(L=this.setGamma(L,1.4),L===0)L=1;return this.averageTextureRGB[_]=L,L}static setBrightness(_){let R=_+Math.random()*0.03-0.015,E=0;for(let b=0;b<512;b++){let G=(b/8|0)/64+0.0078125,N=(b&7)/8+0.0625;for(let L=0;L<128;L++){let H=L/128,I=H,Q=H,q=H;if(N!==0){let u;if(H<0.5)u=H*(N+1);else u=H+N-H*N;let F=H*2-u,k=G+0.3333333333333333;if(k>1)k--;let j=G-0.3333333333333333;if(j<0)j++;if(k*6<1)I=F+(u-F)*6*k;else if(k*2<1)I=u;else if(k*3<2)I=F+(u-F)*(0.6666666666666666-k)*6;else I=F;if(G*6<1)Q=F+(u-F)*6*G;else if(G*2<1)Q=u;else if(G*3<2)Q=F+(u-F)*(0.6666666666666666-G)*6;else Q=F;if(j*6<1)q=F+(u-F)*6*j;else if(j*2<1)q=u;else if(j*3<2)q=F+(u-F)*(0.6666666666666666-j)*6;else q=F}let O=I*256|0,U=Q*256|0,$=q*256|0,K=(O<<16)+(U<<8)+$;this.hslPal[E++]=this.setGamma(K,R)}}for(let b=0;b<50;b++){let G=this.textures[b];if(!G)continue;let N=G.rgbPal;this.texPal[b]=new Int32Array(N.length);for(let L=0;L<N.length;L++){let H=this.texPal[b];if(!H)continue;H[L]=this.setGamma(N[L],R)}}for(let b=0;b<50;b++)this.pushTexture(b)}static setGamma(_,R){let E=(_>>16)/256,b=(_>>8&255)/256,G=(_&255)/256,N=Math.pow(E,R),L=Math.pow(b,R),H=Math.pow(G,R),I=N*256|0,Q=L*256|0,q=H*256|0;return(I<<16)+(Q<<8)+q}static initPool(_){if(this.texelPool)return;if(this.poolSize=_,this.lowMemory)this.texelPool=new X0(_,16384);else this.texelPool=new X0(_,65536);this.activeTexels.fill(null)}static fillGouraudTriangle(_,R,E,b,G,N,L,H,I){let Q=0,q=0;if(G!==b)Q=(R-_<<16)/(G-b)|0,q=(H-L<<15)/(G-b)|0;let O=0,U=0;if(N!==G)O=(E-R<<16)/(N-G)|0,U=(I-H<<15)/(N-G)|0;let $=0,K=0;if(N!==b)$=(_-E<<16)/(b-N)|0,K=(L-I<<15)/(b-N)|0;if(b<=G&&b<=N){if(b<T.bottom){if(G>T.bottom)G=T.bottom;if(N>T.bottom)N=T.bottom;if(G<N){if(E=_<<=16,I=L<<=15,b<0)E-=$*b,_-=Q*b,I-=K*b,L-=q*b,b=0;if(R<<=16,H<<=15,G<0)R-=O*G,H-=U*G,G=0;if(b!==G&&$<Q||b===G&&$>O){N-=G,G-=b,b=w.lineOffset[b];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawGouraudScanline(E>>16,R>>16,I>>7,H>>7,T.pixels,b,0),E+=$,R+=O,I+=K,H+=U,b+=T.width2d}this.drawGouraudScanline(E>>16,_>>16,I>>7,L>>7,T.pixels,b,0),E+=$,_+=Q,I+=K,L+=q,b+=T.width2d}}else{N-=G,G-=b,b=w.lineOffset[b];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawGouraudScanline(R>>16,E>>16,H>>7,I>>7,T.pixels,b,0),E+=$,R+=O,I+=K,H+=U,b+=T.width2d}this.drawGouraudScanline(_>>16,E>>16,L>>7,I>>7,T.pixels,b,0),E+=$,_+=Q,I+=K,L+=q,b+=T.width2d}}}else{if(R=_<<=16,H=L<<=15,b<0)R-=$*b,_-=Q*b,H-=K*b,L-=q*b,b=0;if(E<<=16,I<<=15,N<0)E-=O*N,I-=U*N,N=0;if(b!==N&&$<Q||b===N&&O>Q){G-=N,N-=b,b=w.lineOffset[b];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(E>>16,_>>16,I>>7,L>>7,T.pixels,b,0),E+=O,_+=Q,I+=U,L+=q,b+=T.width2d}this.drawGouraudScanline(R>>16,_>>16,H>>7,L>>7,T.pixels,b,0),R+=$,_+=Q,H+=K,L+=q,b+=T.width2d}}else{G-=N,N-=b,b=w.lineOffset[b];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(_>>16,E>>16,L>>7,I>>7,T.pixels,b,0),E+=O,_+=Q,I+=U,L+=q,b+=T.width2d}this.drawGouraudScanline(_>>16,R>>16,L>>7,H>>7,T.pixels,b,0),R+=$,_+=Q,H+=K,L+=q,b+=T.width2d}}}}}else if(G<=N){if(G<T.bottom){if(N>T.bottom)N=T.bottom;if(b>T.bottom)b=T.bottom;if(N<b){if(_=R<<=16,L=H<<=15,G<0)_-=Q*G,R-=O*G,L-=q*G,H-=U*G,G=0;if(E<<=16,I<<=15,N<0)E-=$*N,I-=K*N,N=0;if(G!==N&&Q<O||G===N&&Q>$){b-=N,N-=G,G=w.lineOffset[G];while(!0){if(N--,N<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(_>>16,E>>16,L>>7,I>>7,T.pixels,G,0),_+=Q,E+=$,L+=q,I+=K,G+=T.width2d}this.drawGouraudScanline(_>>16,R>>16,L>>7,H>>7,T.pixels,G,0),_+=Q,R+=O,L+=q,H+=U,G+=T.width2d}}else{b-=N,N-=G,G=w.lineOffset[G];while(!0){if(N--,N<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(E>>16,_>>16,I>>7,L>>7,T.pixels,G,0),_+=Q,E+=$,L+=q,I+=K,G+=T.width2d}this.drawGouraudScanline(R>>16,_>>16,H>>7,L>>7,T.pixels,G,0),_+=Q,R+=O,L+=q,H+=U,G+=T.width2d}}}else{if(E=R<<=16,I=H<<=15,G<0)E-=Q*G,R-=O*G,I-=q*G,H-=U*G,G=0;if(_<<=16,L<<=15,b<0)_-=$*b,L-=K*b,b=0;if(N-=b,b-=G,G=w.lineOffset[G],Q<O)while(!0){if(b--,b<0)while(!0){if(N--,N<0)return;this.drawGouraudScanline(_>>16,R>>16,L>>7,H>>7,T.pixels,G,0),_+=$,R+=O,L+=K,H+=U,G+=T.width2d}this.drawGouraudScanline(E>>16,R>>16,I>>7,H>>7,T.pixels,G,0),E+=Q,R+=O,I+=q,H+=U,G+=T.width2d}else while(!0){if(b--,b<0)while(!0){if(N--,N<0)return;this.drawGouraudScanline(R>>16,_>>16,H>>7,L>>7,T.pixels,G,0),_+=$,R+=O,L+=K,H+=U,G+=T.width2d}this.drawGouraudScanline(R>>16,E>>16,H>>7,I>>7,T.pixels,G,0),E+=Q,R+=O,I+=q,H+=U,G+=T.width2d}}}}else if(N<T.bottom){if(b>T.bottom)b=T.bottom;if(G>T.bottom)G=T.bottom;if(b<G){if(R=E<<=16,H=I<<=15,N<0)R-=O*N,E-=$*N,H-=U*N,I-=K*N,N=0;if(_<<=16,L<<=15,b<0)_-=Q*b,L-=q*b,b=0;if(G-=b,b-=N,N=w.lineOffset[N],O<$)while(!0){if(b--,b<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(R>>16,_>>16,H>>7,L>>7,T.pixels,N,0),R+=O,_+=Q,H+=U,L+=q,N+=T.width2d}this.drawGouraudScanline(R>>16,E>>16,H>>7,I>>7,T.pixels,N,0),R+=O,E+=$,H+=U,I+=K,N+=T.width2d}else while(!0){if(b--,b<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(_>>16,R>>16,L>>7,H>>7,T.pixels,N,0),R+=O,_+=Q,H+=U,L+=q,N+=T.width2d}this.drawGouraudScanline(E>>16,R>>16,I>>7,H>>7,T.pixels,N,0),R+=O,E+=$,H+=U,I+=K,N+=T.width2d}}else{if(_=E<<=16,L=I<<=15,N<0)_-=O*N,E-=$*N,L-=U*N,I-=K*N,N=0;if(R<<=16,H<<=15,G<0)R-=Q*G,H-=q*G,G=0;if(b-=G,G-=N,N=w.lineOffset[N],O<$)while(!0){if(G--,G<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(R>>16,E>>16,H>>7,I>>7,T.pixels,N,0),R+=Q,E+=$,H+=q,I+=K,N+=T.width2d}this.drawGouraudScanline(_>>16,E>>16,L>>7,I>>7,T.pixels,N,0),_+=O,E+=$,L+=U,I+=K,N+=T.width2d}else while(!0){if(G--,G<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(E>>16,R>>16,I>>7,H>>7,T.pixels,N,0),R+=Q,E+=$,H+=q,I+=K,N+=T.width2d}this.drawGouraudScanline(E>>16,_>>16,I>>7,L>>7,T.pixels,N,0),_+=O,E+=$,L+=U,I+=K,N+=T.width2d}}}}static drawGouraudScanline(_,R,E,b,G,N,L){let H;if(w.jagged){let I;if(w.clipX){if(R-_>3)I=(b-E)/(R-_)|0;else I=0;if(R>T.boundX)R=T.boundX;if(_<0)E-=_*I,_=0;if(_>=R)return;N+=_,L=R-_>>2,I<<=2}else if(_<R)if(N+=_,L=R-_>>2,L>0)I=(b-E)*w.reciprocal15[L]>>15;else I=0;else return;if(w.alpha===0)while(!0){if(L--,L<0){if(L=R-_&3,L>0){H=w.hslPal[E>>8];do G[N++]=H,L--;while(L>0);return}break}H=w.hslPal[E>>8],E+=I,G[N++]=H,G[N++]=H,G[N++]=H,G[N++]=H}else{let Q=w.alpha,q=256-w.alpha;while(!0){if(L--,L<0){if(L=R-_&3,L>0){H=w.hslPal[E>>8],H=((H&16711935)*q>>8&16711935)+((H&65280)*q>>8&65280);do G[N++]=H+((G[N]&16711935)*Q>>8&16711935)+((G[N]&65280)*Q>>8&65280),L--;while(L>0)}break}H=w.hslPal[E>>8],E+=I,H=((H&16711935)*q>>8&16711935)+((H&65280)*q>>8&65280),G[N++]=H+((G[N]&16711935)*Q>>8&16711935)+((G[N]&65280)*Q>>8&65280),G[N++]=H+((G[N]&16711935)*Q>>8&16711935)+((G[N]&65280)*Q>>8&65280),G[N++]=H+((G[N]&16711935)*Q>>8&16711935)+((G[N]&65280)*Q>>8&65280),G[N++]=H+((G[N]&16711935)*Q>>8&16711935)+((G[N]&65280)*Q>>8&65280)}}}else if(_<R){let I=(b-E)/(R-_)|0;if(w.clipX){if(R>T.boundX)R=T.boundX;if(_<0)E-=_*I,_=0;if(_>=R)return}if(N+=_,L=R-_,w.alpha===0)do G[N++]=w.hslPal[E>>8],E+=I,L--;while(L>0);else{let Q=w.alpha,q=256-w.alpha;do H=w.hslPal[E>>8],E+=I,H=((H&16711935)*q>>8&16711935)+((H&65280)*q>>8&65280),G[N++]=H+((G[N]&16711935)*Q>>8&16711935)+((G[N]&65280)*Q>>8&65280),L--;while(L>0)}}}static fillTriangle(_,R,E,b,G,N,L){let H=0;if(G!==b)H=(R-_<<16)/(G-b)|0;let I=0;if(N!==G)I=(E-R<<16)/(N-G)|0;let Q=0;if(N!==b)Q=(_-E<<16)/(b-N)|0;if(b<=G&&b<=N){if(b<T.bottom){if(G>T.bottom)G=T.bottom;if(N>T.bottom)N=T.bottom;if(G<N){if(E=_<<=16,b<0)E-=Q*b,_-=H*b,b=0;if(R<<=16,G<0)R-=I*G,G=0;if(b!==G&&Q<H||b===G&&Q>I){N-=G,G-=b,b=this.lineOffset[b];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawScanline(E>>16,R>>16,T.pixels,b,L),E+=Q,R+=I,b+=T.width2d}this.drawScanline(E>>16,_>>16,T.pixels,b,L),E+=Q,_+=H,b+=T.width2d}}else{N-=G,G-=b,b=this.lineOffset[b];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawScanline(R>>16,E>>16,T.pixels,b,L),E+=Q,R+=I,b+=T.width2d}this.drawScanline(_>>16,E>>16,T.pixels,b,L),E+=Q,_+=H,b+=T.width2d}}}else{if(R=_<<=16,b<0)R-=Q*b,_-=H*b,b=0;if(E<<=16,N<0)E-=I*N,N=0;if(b!==N&&Q<H||b===N&&I>H){G-=N,N-=b,b=this.lineOffset[b];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawScanline(E>>16,_>>16,T.pixels,b,L),E+=I,_+=H,b+=T.width2d}this.drawScanline(R>>16,_>>16,T.pixels,b,L),R+=Q,_+=H,b+=T.width2d}}else{G-=N,N-=b,b=this.lineOffset[b];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawScanline(_>>16,E>>16,T.pixels,b,L),E+=I,_+=H,b+=T.width2d}this.drawScanline(_>>16,R>>16,T.pixels,b,L),R+=Q,_+=H,b+=T.width2d}}}}}else if(G<=N){if(G<T.bottom){if(N>T.bottom)N=T.bottom;if(b>T.bottom)b=T.bottom;if(N<b){if(_=R<<=16,G<0)_-=H*G,R-=I*G,G=0;if(E<<=16,N<0)E-=Q*N,N=0;if(G!==N&&H<I||G===N&&H>Q){b-=N,N-=G,G=this.lineOffset[G];while(!0){if(N--,N<0)while(!0){if(b--,b<0)return;this.drawScanline(_>>16,E>>16,T.pixels,G,L),_+=H,E+=Q,G+=T.width2d}this.drawScanline(_>>16,R>>16,T.pixels,G,L),_+=H,R+=I,G+=T.width2d}}else{b-=N,N-=G,G=this.lineOffset[G];while(!0){if(N--,N<0)while(!0){if(b--,b<0)return;this.drawScanline(E>>16,_>>16,T.pixels,G,L),_+=H,E+=Q,G+=T.width2d}this.drawScanline(R>>16,_>>16,T.pixels,G,L),_+=H,R+=I,G+=T.width2d}}}else{if(E=R<<=16,G<0)E-=H*G,R-=I*G,G=0;if(_<<=16,b<0)_-=Q*b,b=0;if(H<I){N-=b,b-=G,G=this.lineOffset[G];while(!0){if(b--,b<0)while(!0){if(N--,N<0)return;this.drawScanline(_>>16,R>>16,T.pixels,G,L),_+=Q,R+=I,G+=T.width2d}this.drawScanline(E>>16,R>>16,T.pixels,G,L),E+=H,R+=I,G+=T.width2d}}else{N-=b,b-=G,G=this.lineOffset[G];while(!0){if(b--,b<0)while(!0){if(N--,N<0)return;this.drawScanline(R>>16,_>>16,T.pixels,G,L),_+=Q,R+=I,G+=T.width2d}this.drawScanline(R>>16,E>>16,T.pixels,G,L),E+=H,R+=I,G+=T.width2d}}}}}else if(N<T.bottom){if(b>T.bottom)b=T.bottom;if(G>T.bottom)G=T.bottom;if(b<G){if(R=E<<=16,N<0)R-=I*N,E-=Q*N,N=0;if(_<<=16,b<0)_-=H*b,b=0;if(I<Q){G-=b,b-=N,N=this.lineOffset[N];while(!0){if(b--,b<0)while(!0){if(G--,G<0)return;this.drawScanline(R>>16,_>>16,T.pixels,N,L),R+=I,_+=H,N+=T.width2d}this.drawScanline(R>>16,E>>16,T.pixels,N,L),R+=I,E+=Q,N+=T.width2d}}else{G-=b,b-=N,N=this.lineOffset[N];while(!0){if(b--,b<0)while(!0){if(G--,G<0)return;this.drawScanline(_>>16,R>>16,T.pixels,N,L),R+=I,_+=H,N+=T.width2d}this.drawScanline(E>>16,R>>16,T.pixels,N,L),R+=I,E+=Q,N+=T.width2d}}}else{if(_=E<<=16,N<0)_-=I*N,E-=Q*N,N=0;if(R<<=16,G<0)R-=H*G,G=0;if(I<Q){b-=G,G-=N,N=this.lineOffset[N];while(!0){if(G--,G<0)while(!0){if(b--,b<0)return;this.drawScanline(R>>16,E>>16,T.pixels,N,L),R+=H,E+=Q,N+=T.width2d}this.drawScanline(_>>16,E>>16,T.pixels,N,L),_+=I,E+=Q,N+=T.width2d}}else{b-=G,G-=N,N=this.lineOffset[N];while(!0){if(G--,G<0)while(!0){if(b--,b<0)return;this.drawScanline(E>>16,R>>16,T.pixels,N,L),R+=H,E+=Q,N+=T.width2d}this.drawScanline(E>>16,_>>16,T.pixels,N,L),_+=I,E+=Q,N+=T.width2d}}}}}static fillTexturedTriangle(_,R,E,b,G,N,L,H,I,Q,q,O,U,$,K,u,F,k,j){let m=this.getTexels(j);this.opaque=!this.textureTranslucent[j];let Y=Q-U,X=q-K,B=O-F,z=$-Q,Z=u-q,g=k-O,M=z*q-Z*Q<<14,S=Z*O-g*q<<8,A=g*Q-z*O<<5,W=Y*q-X*Q<<14,v=X*O-B*q<<8,n=B*Q-Y*O<<5,D=X*z-Y*Z<<14,i=B*Z-X*g<<8,x=Y*g-B*z<<5,c=0,R0=0;if(G!==b)c=(R-_<<16)/(G-b)|0,R0=(H-L<<16)/(G-b)|0;let t=0,q0=0;if(N!==G)t=(E-R<<16)/(N-G)|0,q0=(I-H<<16)/(N-G)|0;let H0=0,J0=0;if(N!==b)H0=(_-E<<16)/(b-N)|0,J0=(L-I<<16)/(b-N)|0;if(b<=G&&b<=N){if(b<T.bottom){if(G>T.bottom)G=T.bottom;if(N>T.bottom)N=T.bottom;if(G<N){if(E=_<<=16,I=L<<=16,b<0)E-=H0*b,_-=c*b,I-=J0*b,L-=R0*b,b=0;if(R<<=16,H<<=16,G<0)R-=t*G,H-=q0*G,G=0;let U0=b-this.centerY;if(M+=A*U0,W+=n*U0,D+=x*U0,M|=0,W|=0,D|=0,b!==G&&H0<c||b===G&&H0>t){N-=G,G-=b,b=this.lineOffset[b];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawTexturedScanline(E>>16,R>>16,T.pixels,b,m,0,0,M,W,D,S,v,i,I>>8,H>>8),E+=H0,R+=t,I+=J0,H+=q0,b+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(E>>16,_>>16,T.pixels,b,m,0,0,M,W,D,S,v,i,I>>8,L>>8),E+=H0,_+=c,I+=J0,L+=R0,b+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}else{N-=G,G-=b,b=this.lineOffset[b];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawTexturedScanline(R>>16,E>>16,T.pixels,b,m,0,0,M,W,D,S,v,i,H>>8,I>>8),E+=H0,R+=t,I+=J0,H+=q0,b+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(_>>16,E>>16,T.pixels,b,m,0,0,M,W,D,S,v,i,L>>8,I>>8),E+=H0,_+=c,I+=J0,L+=R0,b+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}}else{if(R=_<<=16,H=L<<=16,b<0)R-=H0*b,_-=c*b,H-=J0*b,L-=R0*b,b=0;if(E<<=16,I<<=16,N<0)E-=t*N,I-=q0*N,N=0;let U0=b-this.centerY;if(M+=A*U0,W+=n*U0,D+=x*U0,M|=0,W|=0,D|=0,(b===N||H0>=c)&&(b!==N||t<=c)){G-=N,N-=b,b=this.lineOffset[b];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(_>>16,E>>16,T.pixels,b,m,0,0,M,W,D,S,v,i,L>>8,I>>8),E+=t,_+=c,I+=q0,L+=R0,b+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(_>>16,R>>16,T.pixels,b,m,0,0,M,W,D,S,v,i,L>>8,H>>8),R+=H0,_+=c,H+=J0,L+=R0,b+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}else{G-=N,N-=b,b=this.lineOffset[b];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(E>>16,_>>16,T.pixels,b,m,0,0,M,W,D,S,v,i,I>>8,L>>8),E+=t,_+=c,I+=q0,L+=R0,b+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(R>>16,_>>16,T.pixels,b,m,0,0,M,W,D,S,v,i,H>>8,L>>8),R+=H0,_+=c,H+=J0,L+=R0,b+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}}}}else if(G<=N){if(G<T.bottom){if(N>T.bottom)N=T.bottom;if(b>T.bottom)b=T.bottom;if(N<b){if(_=R<<=16,L=H<<=16,G<0)_-=c*G,R-=t*G,L-=R0*G,H-=q0*G,G=0;if(E<<=16,I<<=16,N<0)E-=H0*N,I-=J0*N,N=0;let U0=G-this.centerY;if(M+=A*U0,W+=n*U0,D+=x*U0,M|=0,W|=0,D|=0,G!==N&&c<t||G===N&&c>H0){b-=N,N-=G,G=this.lineOffset[G];while(!0){if(N--,N<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(_>>16,E>>16,T.pixels,G,m,0,0,M,W,D,S,v,i,L>>8,I>>8),_+=c,E+=H0,L+=R0,I+=J0,G+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(_>>16,R>>16,T.pixels,G,m,0,0,M,W,D,S,v,i,L>>8,H>>8),_+=c,R+=t,L+=R0,H+=q0,G+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}else{b-=N,N-=G,G=this.lineOffset[G];while(!0){if(N--,N<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(E>>16,_>>16,T.pixels,G,m,0,0,M,W,D,S,v,i,I>>8,L>>8),_+=c,E+=H0,L+=R0,I+=J0,G+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(R>>16,_>>16,T.pixels,G,m,0,0,M,W,D,S,v,i,H>>8,L>>8),_+=c,R+=t,L+=R0,H+=q0,G+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}}else{if(E=R<<=16,I=H<<=16,G<0)E-=c*G,R-=t*G,I-=R0*G,H-=q0*G,G=0;if(_<<=16,L<<=16,b<0)_-=H0*b,L-=J0*b,b=0;let U0=G-this.centerY;if(M+=A*U0,W+=n*U0,D+=x*U0,M|=0,W|=0,D|=0,N-=b,b-=G,G=this.lineOffset[G],c<t)while(!0){if(b--,b<0)while(!0){if(N--,N<0)return;this.drawTexturedScanline(_>>16,R>>16,T.pixels,G,m,0,0,M,W,D,S,v,i,L>>8,H>>8),_+=H0,R+=t,L+=J0,H+=q0,G+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(E>>16,R>>16,T.pixels,G,m,0,0,M,W,D,S,v,i,I>>8,H>>8),E+=c,R+=t,I+=R0,H+=q0,G+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}else while(!0){if(b--,b<0)while(!0){if(N--,N<0)return;this.drawTexturedScanline(R>>16,_>>16,T.pixels,G,m,0,0,M,W,D,S,v,i,H>>8,L>>8),_+=H0,R+=t,L+=J0,H+=q0,G+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(R>>16,E>>16,T.pixels,G,m,0,0,M,W,D,S,v,i,H>>8,I>>8),E+=c,R+=t,I+=R0,H+=q0,G+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}}}else if(N<T.bottom){if(b>T.bottom)b=T.bottom;if(G>T.bottom)G=T.bottom;if(b<G){if(R=E<<=16,H=I<<=16,N<0)R-=t*N,E-=H0*N,H-=q0*N,I-=J0*N,N=0;if(_<<=16,L<<=16,b<0)_-=c*b,L-=R0*b,b=0;let U0=N-this.centerY;if(M+=A*U0,W+=n*U0,D+=x*U0,M|=0,W|=0,D|=0,G-=b,b-=N,N=this.lineOffset[N],t<H0)while(!0){if(b--,b<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(R>>16,_>>16,T.pixels,N,m,0,0,M,W,D,S,v,i,H>>8,L>>8),R+=t,_+=c,H+=q0,L+=R0,N+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(R>>16,E>>16,T.pixels,N,m,0,0,M,W,D,S,v,i,H>>8,I>>8),R+=t,E+=H0,H+=q0,I+=J0,N+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}else while(!0){if(b--,b<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(_>>16,R>>16,T.pixels,N,m,0,0,M,W,D,S,v,i,L>>8,H>>8),R+=t,_+=c,H+=q0,L+=R0,N+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(E>>16,R>>16,T.pixels,N,m,0,0,M,W,D,S,v,i,I>>8,H>>8),R+=t,E+=H0,H+=q0,I+=J0,N+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}else{if(_=E<<=16,L=I<<=16,N<0)_-=t*N,E-=H0*N,L-=q0*N,I-=J0*N,N=0;if(R<<=16,H<<=16,G<0)R-=c*G,H-=R0*G,G=0;let U0=N-this.centerY;if(M+=A*U0,W+=n*U0,D+=x*U0,M|=0,W|=0,D|=0,b-=G,G-=N,N=this.lineOffset[N],t<H0)while(!0){if(G--,G<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(R>>16,E>>16,T.pixels,N,m,0,0,M,W,D,S,v,i,H>>8,I>>8),R+=c,E+=H0,H+=R0,I+=J0,N+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(_>>16,E>>16,T.pixels,N,m,0,0,M,W,D,S,v,i,L>>8,I>>8),_+=t,E+=H0,L+=q0,I+=J0,N+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}else while(!0){if(G--,G<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(E>>16,R>>16,T.pixels,N,m,0,0,M,W,D,S,v,i,I>>8,H>>8),R+=c,E+=H0,H+=R0,I+=J0,N+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}this.drawTexturedScanline(E>>16,_>>16,T.pixels,N,m,0,0,M,W,D,S,v,i,I>>8,L>>8),_+=t,E+=H0,L+=q0,I+=J0,N+=T.width2d,M+=A,W+=n,D+=x,M|=0,W|=0,D|=0}}}}static drawTexturedScanline(_,R,E,b,G,N,L,H,I,Q,q,O,U,$,K){if(_>=R)return;let u,F;if(this.clipX){if(u=(K-$)/(R-_)|0,R>T.boundX)R=T.boundX;if(_<0)$-=_*u,_=0;if(_>=R)return;F=R-_>>3,u<<=12}else if(R-_>7)F=R-_>>3,u=(K-$)*this.reciprocal15[F]>>6;else F=0,u=0;$<<=9,b+=_;let k,j,m,Y,X,B,z;if(this.lowMemory&&G){if(k=0,j=0,Y=_-this.centerX,H=H+(q>>3)*Y,I=I+(O>>3)*Y,Q=Q+(U>>3)*Y,H|=0,I|=0,Q|=0,m=Q>>12,m!==0){if(N=H/m|0,L=I/m|0,N<0)N=0;else if(N>4032)N=4032}if(H=H+q,I=I+O,Q=Q+U,H|=0,I|=0,Q|=0,m=Q>>12,m!==0){if(k=H/m|0,j=I/m|0,k<7)k=7;else if(k>4032)k=4032}if(X=k-N>>3,B=j-L>>3,N+=$>>3&786432,z=$>>23,this.opaque){while(F-- >0){if(E[b++]=G[(L&4032)+(N>>6)]>>>z,N+=X,L+=B,E[b++]=G[(L&4032)+(N>>6)]>>>z,N+=X,L+=B,E[b++]=G[(L&4032)+(N>>6)]>>>z,N+=X,L+=B,E[b++]=G[(L&4032)+(N>>6)]>>>z,N+=X,L+=B,E[b++]=G[(L&4032)+(N>>6)]>>>z,N+=X,L+=B,E[b++]=G[(L&4032)+(N>>6)]>>>z,N+=X,L+=B,E[b++]=G[(L&4032)+(N>>6)]>>>z,N+=X,L+=B,E[b++]=G[(L&4032)+(N>>6)]>>>z,N=k,L=j,H+=q,I+=O,Q+=U,m=Q>>12,m!==0){if(k=H/m|0,j=I/m|0,k<7)k=7;else if(k>4032)k=4032}X=k-N>>3,B=j-L>>3,$+=u,N+=$>>3&786432,z=$>>23}F=R-_&7;while(F-- >0)E[b++]=G[(L&4032)+(N>>6)]>>>z,N+=X,L+=B}else{while(F-- >0){let Z;if((Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;if(b=b+1,N+=X,L+=B,(Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;if(b=b+1,N=k,L=j,H+=q,I+=O,Q+=U,H|=0,I|=0,Q|=0,m=Q>>12,m!==0){if(k=H/m|0,j=I/m|0,k<7)k=7;else if(k>4032)k=4032}X=k-N>>3,B=j-L>>3,$+=u,N+=$>>3&786432,z=$>>23}F=R-_&7;while(F-- >0){let Z;if((Z=G[(L&4032)+(N>>6)]>>>z)!==0)E[b]=Z;b++,N+=X,L+=B}}return}if(k=0,j=0,Y=_-this.centerX,H=H+(q>>3)*Y,I=I+(O>>3)*Y,Q=Q+(U>>3)*Y,H|=0,I|=0,Q|=0,m=Q>>14,m!==0){if(N=H/m|0,L=I/m|0,N<0)N=0;else if(N>16256)N=16256}if(H=H+q,I=I+O,Q=Q+U,H|=0,I|=0,Q|=0,m=Q>>14,m!==0){if(k=H/m|0,j=I/m|0,k<7)k=7;else if(k>16256)k=16256}if(X=k-N>>3,B=j-L>>3,N+=$&6291456,z=$>>23,this.opaque&&G){while(F-- >0){if(E[b++]=G[(L&16256)+(N>>7)]>>>z,N+=X,L+=B,E[b++]=G[(L&16256)+(N>>7)]>>>z,N+=X,L+=B,E[b++]=G[(L&16256)+(N>>7)]>>>z,N+=X,L+=B,E[b++]=G[(L&16256)+(N>>7)]>>>z,N+=X,L+=B,E[b++]=G[(L&16256)+(N>>7)]>>>z,N+=X,L+=B,E[b++]=G[(L&16256)+(N>>7)]>>>z,N+=X,L+=B,E[b++]=G[(L&16256)+(N>>7)]>>>z,N+=X,L+=B,E[b++]=G[(L&16256)+(N>>7)]>>>z,N=k,L=j,H+=q,I+=O,Q+=U,H|=0,I|=0,Q|=0,m=Q>>14,m!==0){if(k=H/m|0,j=I/m|0,k<7)k=7;else if(k>16256)k=16256}X=k-N>>3,B=j-L>>3,$+=u,N+=$&6291456,z=$>>23}F=R-_&7;while(F-- >0)E[b++]=G[(L&16256)+(N>>7)]>>>z,N+=X,L+=B;return}while(F-- >0&&G){let Z;if((Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;if(b=b+1,N+=X,L+=B,(Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;if(b++,N+=X,L+=B,(Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;if(b++,N=k,L=j,H+=q,I+=O,Q+=U,H|=0,I|=0,Q|=0,m=Q>>14,m!==0){if(k=H/m|0,j=I/m|0,k<7)k=7;else if(k>16256)k=16256}X=k-N>>3,B=j-L>>3,$+=u,N+=$&6291456,z=$>>23}F=R-_&7;while(F-- >0&&G){let Z;if((Z=G[(L&16256)+(N>>7)]>>>z)!==0)E[b]=Z;b++,N+=X,L+=B}}static drawScanline(_,R,E,b,G){if(this.clipX){if(R>T.boundX)R=T.boundX;if(_<0)_=0}if(_>=R)return;b+=_;let N=R-_>>2;if(this.alpha===0)while(!0){if(N--,N<0){N=R-_&3;while(!0){if(N--,N<0)return;E[b++]=G}}E[b++]=G,E[b++]=G,E[b++]=G,E[b++]=G}let L=this.alpha,H=256-this.alpha;G=((G&16711935)*H>>8&16711935)+((G&65280)*H>>8&65280);while(!0){if(N--,N<0){N=R-_&3;while(!0){if(N--,N<0)return;E[b++]=G+((E[b]&16711935)*L>>8&16711935)+((E[b]&65280)*L>>8&65280)}}E[b++]=G+((E[b]&16711935)*L>>8&16711935)+((E[b]&65280)*L>>8&65280),E[b++]=G+((E[b]&16711935)*L>>8&16711935)+((E[b]&65280)*L>>8&65280),E[b++]=G+((E[b]&16711935)*L>>8&16711935)+((E[b]&65280)*L>>8&65280),E[b++]=G+((E[b]&16711935)*L>>8&16711935)+((E[b]&65280)*L>>8&65280)}}static pushTexture(_){if(this.activeTexels[_]&&this.texelPool)this.texelPool[this.poolSize++]=this.activeTexels[_],this.activeTexels[_]=null}static getTexels(_){if(this.textureCycle[_]=this.cycle++,this.activeTexels[_])return this.activeTexels[_];let R;if(this.poolSize>0&&this.texelPool)R=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let G=0,N=-1;for(let L=0;L<this.textureCount;L++)if(this.activeTexels[L]&&(this.textureCycle[L]<G||N===-1))G=this.textureCycle[L],N=L;R=this.activeTexels[N],this.activeTexels[N]=null}this.activeTexels[_]=R;let E=this.textures[_],b=this.texPal[_];if(!R||!E||!b)return null;if(this.lowMemory){this.textureTranslucent[_]=!1;for(let G=0;G<4096;G++){let N=R[G]=b[E.pixels[G]]&16316671;if(N===0)this.textureTranslucent[_]=!0;R[G+4096]=N-(N>>>3)&16316671,R[G+8192]=N-(N>>>2)&16316671,R[G+12288]=N-(N>>>2)-(N>>>3)&16316671}}else{if(E.width2d===64)for(let G=0;G<128;G++)for(let N=0;N<128;N++)R[N+(G<<7|0)]=b[E.pixels[(N>>1)+(G>>1<<6|0)]];else for(let G=0;G<16384;G++)R[G]=b[E.pixels[G]];this.textureTranslucent[_]=!1;for(let G=0;G<16384;G++){R[G]&=16316671;let N=R[G];if(N===0)this.textureTranslucent[_]=!0;R[G+16384]=N-(N>>>3)&16316671,R[G+32768]=N-(N>>>2)&16316671,R[G+49152]=N-(N>>>2)-(N>>>3)&16316671}}return R}}class b0{image;width2d;height2d;ctx;paint;pixels;constructor(_,R,E=d){this.ctx=E,this.image=this.ctx.getImageData(0,0,_,R),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(_*R),this.width2d=_,this.height2d=R,this.bind()}clear(){this.pixels.fill(0)}bind(){T.bind(this.pixels,this.width2d,this.height2d)}draw(_,R){this.#_(),this.ctx.putImageData(this.image,_,R)}#_(){let _=this.pixels.length,R=this.pixels,E=this.paint;for(let b=0;b<_;b++){let G=R[b];E[b]=G>>16&255|(G>>8&255)<<8|(G&255)<<16|4278190080}}}var k_=["F11","F12"],P=new Map;P.set("ArrowLeft",{code:37,ch:1});P.set("ArrowRight",{code:39,ch:2});P.set("ArrowUp",{code:38,ch:3});P.set("ArrowDown",{code:40,ch:4});P.set("Control",{code:17,ch:5});P.set("Shift",{code:16,ch:6});P.set("Alt",{code:18,ch:7});P.set("Backspace",{code:8,ch:8});P.set("Tab",{code:9,ch:9});P.set("Enter",{code:10,ch:10});P.set("Escape",{code:27,ch:27});P.set(" ",{code:32,ch:32});P.set("Delete",{code:127,ch:127});P.set("Home",{code:36,ch:1000});P.set("End",{code:35,ch:1001});P.set("PageUp",{code:33,ch:1002});P.set("PageDown",{code:34,ch:1003});P.set("F1",{code:112,ch:1008});P.set("F2",{code:113,ch:1009});P.set("F3",{code:114,ch:1010});P.set("F4",{code:115,ch:1011});P.set("F5",{code:116,ch:1012});P.set("F6",{code:117,ch:1013});P.set("F7",{code:118,ch:1014});P.set("F8",{code:119,ch:1015});P.set("F9",{code:120,ch:1016});P.set("F10",{code:121,ch:1017});P.set("F11",{code:122,ch:1018});P.set("F12",{code:123,ch:1019});P.set("CapsLock",{code:20,ch:65535});P.set("Meta",{code:524,ch:65535});P.set("Insert",{code:155,ch:65535});P.set("`",{code:192,ch:96});P.set("~",{code:192,ch:126});P.set("!",{code:49,ch:33});P.set("@",{code:50,ch:64});P.set("#",{code:51,ch:35});P.set("$",{code:52,ch:36});P.set("%",{code:53,ch:37});P.set("^",{code:54,ch:94});P.set("&",{code:55,ch:38});P.set("*",{code:56,ch:42});P.set("(",{code:57,ch:40});P.set(")",{code:48,ch:41});P.set("-",{code:45,ch:45});P.set("_",{code:45,ch:95});P.set("=",{code:61,ch:61});P.set("+",{code:61,ch:43});P.set("[",{code:91,ch:91});P.set("{",{code:91,ch:123});P.set("]",{code:93,ch:93});P.set("}",{code:93,ch:125});P.set("\\",{code:92,ch:92});P.set("|",{code:92,ch:124});P.set(";",{code:59,ch:59});P.set(":",{code:59,ch:58});P.set("'",{code:222,ch:39});P.set('"',{code:222,ch:34});P.set(",",{code:44,ch:44});P.set("<",{code:44,ch:60});P.set(".",{code:46,ch:46});P.set(">",{code:46,ch:62});P.set("/",{code:47,ch:47});P.set("?",{code:47,ch:63});P.set("0",{code:48,ch:48});P.set("1",{code:49,ch:49});P.set("2",{code:50,ch:50});P.set("3",{code:51,ch:51});P.set("4",{code:52,ch:52});P.set("5",{code:53,ch:53});P.set("6",{code:54,ch:54});P.set("7",{code:55,ch:55});P.set("8",{code:56,ch:56});P.set("9",{code:57,ch:57});P.set("a",{code:65,ch:97});P.set("b",{code:66,ch:98});P.set("c",{code:67,ch:99});P.set("d",{code:68,ch:100});P.set("e",{code:69,ch:101});P.set("f",{code:70,ch:102});P.set("g",{code:71,ch:103});P.set("h",{code:72,ch:104});P.set("i",{code:73,ch:105});P.set("j",{code:74,ch:106});P.set("k",{code:75,ch:107});P.set("l",{code:76,ch:108});P.set("m",{code:77,ch:109});P.set("n",{code:78,ch:110});P.set("o",{code:79,ch:111});P.set("p",{code:80,ch:112});P.set("q",{code:81,ch:113});P.set("r",{code:82,ch:114});P.set("s",{code:83,ch:115});P.set("t",{code:84,ch:116});P.set("u",{code:85,ch:117});P.set("v",{code:86,ch:118});P.set("w",{code:87,ch:119});P.set("x",{code:88,ch:120});P.set("y",{code:89,ch:121});P.set("z",{code:90,ch:122});P.set("A",{code:65,ch:65});P.set("B",{code:66,ch:66});P.set("C",{code:67,ch:67});P.set("D",{code:68,ch:68});P.set("E",{code:69,ch:69});P.set("F",{code:70,ch:70});P.set("G",{code:71,ch:71});P.set("H",{code:72,ch:72});P.set("I",{code:73,ch:73});P.set("J",{code:74,ch:74});P.set("K",{code:75,ch:75});P.set("L",{code:76,ch:76});P.set("M",{code:77,ch:77});P.set("N",{code:78,ch:78});P.set("O",{code:79,ch:79});P.set("P",{code:80,ch:80});P.set("Q",{code:81,ch:81});P.set("R",{code:82,ch:82});P.set("S",{code:83,ch:83});P.set("T",{code:84,ch:84});P.set("U",{code:85,ch:85});P.set("V",{code:86,ch:86});P.set("W",{code:87,ch:87});P.set("X",{code:88,ch:88});P.set("Y",{code:89,ch:89});P.set("Z",{code:90,ch:90});class $0{static trackingActive=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled(){this.outBuffer=f.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.trackingActive=!0}static setDisabled(){this.trackingActive=!1,this.outBuffer=null}static flush(){let _=null;if(this.oldBuffer&&this.trackingActive)_=this.oldBuffer;return this.oldBuffer=null,_}static stop(){let _=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.trackingActive)_=this.outBuffer;return this.setDisabled(),_}static mousePressed(_,R,E){if(!(this.trackingActive&&_>=0&&_<789&&R>=0&&R<532))return;this.trackedCount++;let b=performance.now(),G=(b-this.lastTime)/10|0;if(G>250)G=250;if(this.lastTime=b,this.ensureCapacity(5),E===2)this.outBuffer?.p1(1);else this.outBuffer?.p1(2);this.outBuffer?.p1(G),this.outBuffer?.p3(_+(R<<10))}static mouseReleased(_){if(!this.trackingActive)return;this.trackedCount++;let R=performance.now(),E=(R-this.lastTime)/10|0;if(E>250)E=250;if(this.lastTime=R,this.ensureCapacity(2),_===2)this.outBuffer?.p1(3);else this.outBuffer?.p1(4);this.outBuffer?.p1(E)}static mouseMoved(_,R){if(!(this.trackingActive&&_>=0&&_<789&&R>=0&&R<532))return;let E=performance.now();if(E-this.lastMoveTime>=50){this.lastMoveTime=E,this.trackedCount++;let b=(E-this.lastTime)/10|0;if(b>250)b=250;if(this.lastTime=E,_-this.lastX<8&&_-this.lastX>=-8&&R-this.lastY<8&&R-this.lastY>=-8)this.ensureCapacity(3),this.outBuffer?.p1(5),this.outBuffer?.p1(b),this.outBuffer?.p1(_+(R-this.lastY+8<<4)+8-this.lastX);else if(_-this.lastX<128&&_-this.lastX>=-128&&R-this.lastY<128&&R-this.lastY>=-128)this.ensureCapacity(4),this.outBuffer?.p1(6),this.outBuffer?.p1(b),this.outBuffer?.p1(_+128-this.lastX),this.outBuffer?.p1(R+128-this.lastY);else this.ensureCapacity(5),this.outBuffer?.p1(7),this.outBuffer?.p1(b),this.outBuffer?.p3(_+(R<<10));this.lastX=_,this.lastY=R}}static keyPressed(_){if(!this.trackingActive)return;this.trackedCount++;let R=performance.now(),E=(R-this.lastTime)/10|0;if(E>250)E=250;if(this.lastTime=R,_===1000)_=11;else if(_===1001)_=12;else if(_===1002)_=14;else if(_===1003)_=15;else if(_>=1008)_-=992;this.ensureCapacity(3),this.outBuffer?.p1(8),this.outBuffer?.p1(E),this.outBuffer?.p1(_)}static keyReleased(_){if(!this.trackingActive)return;this.trackedCount++;let R=performance.now(),E=(R-this.lastTime)/10|0;if(E>250)E=250;if(this.lastTime=R,_===1000)_=11;else if(_===1001)_=12;else if(_===1002)_=14;else if(_===1003)_=15;else if(_>=1008)_-=992;this.ensureCapacity(3),this.outBuffer?.p1(9),this.outBuffer?.p1(E),this.outBuffer?.p1(_)}static focusGained(){if(!this.trackingActive)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer?.p1(10),this.outBuffer?.p1(R)}static focusLost(){if(!this.trackingActive)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer?.p1(11),this.outBuffer?.p1(R)}static mouseEntered(){if(!this.trackingActive)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer?.p1(12),this.outBuffer?.p1(R)}static mouseExited(){if(!this.trackingActive)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer?.p1(13),this.outBuffer?.p1(R)}static ensureCapacity(_){if(!this.outBuffer)return;if(this.outBuffer.pos+_>=500){let R=this.outBuffer;this.outBuffer=f.alloc(1),this.oldBuffer=R}}}class t0{slowestMS=0;averageMS=[];averageIndexMS=0;drawArea=null;state=0;deltime=20;mindel=1;otim=[];fps=0;fpos=0;frameTime=[];redrawScreen=!0;resizeToFit=!1;tfps=50;hasFocus=!0;ingame=!1;idleCycles=Date.now();mouseButton=0;mouseX=-1;mouseY=-1;mouseClickButton=0;mouseClickX=-1;mouseClickY=-1;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;input=null;touching=!1;startedInViewport=!1;startedInTabArea=!1;time=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;async load(){}async update(){}async draw(){}async refresh(){}constructor(_=!1){if(O0.tabIndex=-1,d.fillStyle="black",d.fillRect(0,0,O0.width,O0.height),this.resizeToFit=_,this.resizeToFit)this.resize(window.innerWidth,window.innerHeight);else this.resize(O0.width,O0.height)}get width(){return O0.width}get height(){return O0.height}resize(_,R){O0.width=_,O0.height=R,this.drawArea=new b0(_,R),w.init2D()}async run(){if(O0.addEventListener("resize",()=>{if(this.resizeToFit)this.resize(window.innerWidth,window.innerHeight)},!1),O0.onfocus=this.onfocus.bind(this),O0.onblur=this.onblur.bind(this),O0.onmousedown=this.onmousedown.bind(this),O0.onmouseup=this.onmouseup.bind(this),O0.onmouseenter=this.onmouseenter.bind(this),O0.onmouseleave=this.onmouseleave.bind(this),O0.onmousemove=this.onmousemove.bind(this),O0.onkeydown=this.onkeydown.bind(this),O0.onkeyup=this.onkeyup.bind(this),this.isMobile)O0.ontouchstart=this.ontouchstart.bind(this),O0.ontouchend=this.ontouchend.bind(this),O0.ontouchmove=this.ontouchmove.bind(this);O0.oncontextmenu=(N)=>{N.preventDefault()},window.oncontextmenu=(N)=>{N.preventDefault()},await this.showProgress(0,"Loading..."),await this.load();for(let N=0;N<10;N++)this.otim[N]=performance.now();let _,R=0,E=256,b=1,G=0;while(this.state>=0){if(this.state>0){if(this.state--,this.state===0){this.shutdown();return}}let N=E,L=b;E=300,b=1,_=performance.now();let H=this.otim[R];if(H===0)E=N,b=L;else if(_>H)E=this.deltime*2560/(_-H)|0;if(E<25)E=25;else if(E>256)E=256,b=this.deltime-(_-H)/10|0;if(this.otim[R]=_,R=(R+1)%10,b>1){for(let Q=0;Q<10;Q++)if(this.otim[Q]!==0)this.otim[Q]+=b}if(b<this.mindel)b=this.mindel;await B0(b);while(G<256)await this.update(),this.mouseClickButton=0,this.keyQueueReadPos=this.keyQueueWritePos,G+=E;if(G&=255,this.deltime>0)this.fps=E*1000/(this.deltime*256)|0;let I=performance.now();if(await this.draw(),this.frameTime[this.fpos]=(performance.now()-I)/1000,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50){let Q=1000/this.tfps-(performance.now()-_);if(Q>0)await B0(Q)}}if(this.state===-1)this.shutdown()}shutdown(){this.state=-2}setFramerate(_){this.deltime=1000/_|0}setTargetedFramerate(_){this.tfps=Math.max(Math.min(50,_|0),0)}start(){if(this.state>=0)this.state=0}stop(){if(this.state>=0)this.state=4000/this.deltime|0}destroy(){this.state=-1}async showProgress(_,R){let E=this.width,b=this.height;if(this.redrawScreen)d.fillStyle="black",d.fillRect(0,0,E,b),this.redrawScreen=!1;let G=b/2-18;d.fillStyle="rgb(140, 17, 17)",d.rect((E/2|0)-152,G,304,34),d.fillRect((E/2|0)-150,G+2,_*3,30),d.fillStyle="black",d.fillRect((E/2|0)-150+_*3,G+2,300-_*3,30),d.font="bold 13px helvetica, sans-serif",d.textAlign="center",d.fillStyle="white",d.fillText(R,E/2|0,G+22),await B0(5)}pollKey(){let _=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos)_=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127;return _}get ms(){let _=this.frameTime.length,R=0;for(let b=0;b<_;b++)R+=this.frameTime[b];let E=R/_*1000;if(E>this.slowestMS)this.slowestMS=E;return this.averageMS[this.averageIndexMS]=E,this.averageIndexMS=(this.averageIndexMS+1)%250,E}get msAvg(){return this.averageMS.reduce((_,R)=>_+R,0)/250}onkeydown(_){this.idleCycles=Date.now();let R=P.get(_.key);if(!R||_.code.length===0&&!_.isTrusted)return;let E=R.ch;if(_.ctrlKey){if(E>=65&&E<=93||E==95)E-=64;else if(E>=97&&E<=122)E-=96}if(E>0&&E<128)this.actionKey[E]=1;if(E>4)this.keyQueue[this.keyQueueWritePos]=E,this.keyQueueWritePos=this.keyQueueWritePos+1&127;if($0.trackingActive)$0.keyPressed(E);if(!k_.includes(_.key))_.preventDefault()}onkeyup(_){this.idleCycles=Date.now();let R=P.get(_.key);if(!R||_.code.length===0&&!_.isTrusted)return;let E=R.ch;if(_.ctrlKey){if(E>=65&&E<=93||E==95)E-=64;else if(E>=97&&E<=122)E-=96}if(E>0&&E<128)this.actionKey[E]=0;if($0.trackingActive)$0.keyReleased(E);if(!k_.includes(_.key))_.preventDefault()}onmousedown(_){if(this.touching=!1,_.clientX>0||_.clientY>0)this.setMousePosition(_);if(this.idleCycles=Date.now(),this.mouseClickX=this.mouseX,this.mouseClickY=this.mouseY,this.isMobile&&!this.isCapacitor){if(this.insideMobileInputArea()&&!this.insideChatPopupArea()){this.mouseClickButton=1,this.mouseButton=1;return}if(_.timeStamp>=this.time+500)this.mouseClickButton=2,this.mouseButton=2;else this.mouseClickButton=1,this.mouseButton=1}else if(_.button===2)this.mouseClickButton=2,this.mouseButton=2;else if(_.button===0)this.mouseClickButton=1,this.mouseButton=1;if($0.trackingActive)$0.mousePressed(this.mouseClickX,this.mouseClickY,_.button)}onmouseup(_){if(this.setMousePosition(_),this.idleCycles=Date.now(),this.mouseButton=0,$0.trackingActive)$0.mouseReleased(_.button)}onmouseenter(_){if(this.setMousePosition(_),$0.trackingActive)$0.mouseEntered()}onmouseleave(_){if(this.setMousePosition(_),this.idleCycles=Date.now(),this.mouseX=-1,this.mouseY=-1,this.mouseButton=0,this.mouseClickX=-1,this.mouseClickY=-1,$0.trackingActive)$0.mouseExited()}onmousemove(_){if(this.setMousePosition(_),this.idleCycles=Date.now(),$0.trackingActive)$0.mouseMoved(this.mouseX,this.mouseY)}onfocus(_){if(this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),$0.trackingActive)$0.focusGained()}onblur(_){this.hasFocus=!1;for(let R=0;R<128;R++)this.actionKey[R]=0;if($0.trackingActive)$0.focusLost()}ontouchstart(_){if(!this.isMobile)return;if(this.input!==null)this.input.parentNode?.removeChild(this.input),this.input=null;this.touching=!0;let R=_.changedTouches[0],E=R.clientX|0,b=R.clientY|0;this.onmousemove(new MouseEvent("mousemove",{clientX:E,clientY:b})),this.sx=this.nx=this.mx=R.screenX|0,this.sy=this.ny=this.my=R.screenY|0,this.time=_.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea()}ontouchend(_){if(!this.isMobile||!this.touching)return;let R=_.changedTouches[0],E=R.clientX|0,b=R.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:E,clientY:b})),this.nx=R.screenX|0,this.ny=R.screenY|0,this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.startedInViewport&&!this.insideViewportArea()){this.touching=!1;return}else if(this.startedInTabArea&&!this.insideTabArea()){this.touching=!1;return}else if(this.insideMobileInputArea()){if(this.input!==null){if(this.input.parentNode?.contains(this.input))this.input.parentNode?.removeChild(this.input);this.input=null}let H=document.createElement("input");if(this.insideUsernameArea())H.setAttribute("id","username"),H.setAttribute("placeholder","Username");else if(this.inPasswordArea())H.setAttribute("id","password"),H.setAttribute("placeholder","Password");else if(this.insideChatInputArea())H.setAttribute("id","chatinput"),H.setAttribute("placeholder","Chatinput");else if(this.insideChatPopupArea())H.setAttribute("id","chatpopup"),H.setAttribute("placeholder","Chatpopup");else if(this.insideReportInterfaceTextArea())H.setAttribute("id","reportinput"),H.setAttribute("placeholder","Username");if(this.isAndroid)H.setAttribute("type","password");else H.setAttribute("type",this.inPasswordArea()?"password":"text");if(H.setAttribute("autofocus","autofocus"),H.setAttribute("spellcheck","false"),H.setAttribute("autocomplete","off"),H.setAttribute("style",`position: fixed; left: ${E}px; top: ${b}px; width: 1px; height: 1px; opacity: 0;`),document.body.appendChild(H),H.focus(),H.click(),this.isAndroid)H.oninput=(I)=>{if(!(I instanceof InputEvent))return;let Q=I,q=Q.data;if(q===null)return;if(Q.inputType!=="insertText")return;this.onkeydown(new KeyboardEvent("keydown",{key:q,code:q}))};H.onkeydown=(I)=>{if(this.isAndroid){if(I.key==="Enter"||I.key==="Backspace")this.onkeydown(new KeyboardEvent("keydown",{key:I.key,code:I.key}));return}this.onkeydown(new KeyboardEvent("keydown",{key:I.key,code:I.key}))},H.onkeyup=(I)=>{if(this.isAndroid){if(I.key==="Enter"||I.key==="Backspace")this.onkeyup(new KeyboardEvent("keyup",{key:I.key,code:I.key}));return}this.onkeyup(new KeyboardEvent("keyup",{key:I.key,code:I.key}))},H.onfocus=(I)=>{this.input?.parentNode?.removeChild(this.input),this.input=null,this.onfocus(I)},this.input=H,this.touching=!1;return}let N=_.timeStamp>=this.time+500,L=Math.abs(this.sx-this.nx)>16||Math.abs(this.sy-this.ny)>16;if(N&&!L)this.touching=!0,this.onmousedown(new MouseEvent("mousedown",{clientX:E,clientY:b,button:2})),this.onmouseup(new MouseEvent("mouseup",{clientX:E,clientY:b,button:2}))}ontouchmove(_){if(!this.isMobile||!this.touching)return;if(_.touches.length>1)return;_.preventDefault();let R=_.changedTouches[0],E=R.clientX|0,b=R.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:E,clientY:b})),this.nx=R.screenX|0,this.ny=R.screenY|0,this.startedInViewport&&this.getViewportInterfaceId()===-1){if(this.mx-this.nx>0)this.rotate(2);else if(this.mx-this.nx<0)this.rotate(0);if(this.my-this.ny>0)this.rotate(3);else if(this.my-this.ny<0)this.rotate(1)}else if(this.startedInTabArea||this.getViewportInterfaceId()!==-1)this.onmousedown(new MouseEvent("mousedown",{clientX:E,clientY:b,button:1}));this.mx=this.nx,this.my=this.ny}get isMobile(){return["Android","webOS","iPhone","iPad","iPod","BlackBerry","Windows Phone"].some((R)=>navigator.userAgent.includes(R))}get isAndroid(){return["Android"].some((R)=>navigator.userAgent.includes(R))}get isCapacitor(){return["Capacitor"].some((R)=>navigator.userAgent.includes(R))}insideViewportArea(){return this.ingame&&this.mouseX>=8&&this.mouseX<=520&&this.mouseY>=11&&this.mouseY<=345}insideMobileInputArea(){return this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()||this.insideReportInterfaceTextArea()}insideChatInputArea(){return this.ingame&&this.getChatInterfaceId()===-1&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=449&&this.mouseY<=482}insideChatPopupArea(){return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=383&&this.mouseY<=482}insideReportInterfaceTextArea(){if(!this.ingame)return!1;let _=this.getViewportInterfaceId(),R=this.getReportAbuseInterfaceId();if(_===-1||R===-1)return!1;if(_!==R)return!1;let E=82,b=137,G=E+366,N=b+26;return this.mouseX>=E&&this.mouseX<=G&&this.mouseY>=b&&this.mouseY<=N}insideTabArea(){return this.ingame&&this.mouseX>=562&&this.mouseX<=752&&this.mouseY>=231&&this.mouseY<=492}insideUsernameArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=262&&this.mouseY<=279}inPasswordArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=279&&this.mouseY<=296}rotate(_){if(_===0)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowLeft",code:"ArrowLeft"}));else if(_===1)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowUp",code:"ArrowUp"}));else if(_===2)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowRight",code:"ArrowRight"}));else if(_===3)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown"}))}isFullScreen(){return document.fullscreenElement!==null}setMousePosition(_){let R=this.width,E=this.height,b=O0.getBoundingClientRect(),G={x:_.clientX-b.left,y:_.clientY-b.top};if(this.isFullScreen()){let N=R/E,H=window.innerWidth/window.innerHeight>=N,I=0,Q=0,q=0,O=0;if(H)I=window.innerHeight*N,Q=window.innerHeight,q=(window.innerWidth-I)/2;else I=window.innerWidth,Q=window.innerWidth/N,O=(window.innerHeight-Q)/2;let U=R/I,$=E/Q;this.mouseX=(G.x-q)*U|0,this.mouseY=(G.y-O)*$|0}else{let N=O0.width/b.width,L=O0.height/b.height;this.mouseX=G.x*N|0,this.mouseY=G.y*L|0}if(this.mouseX<0)this.mouseX=0;if(this.mouseY<0)this.mouseY=0;if(this.mouseX>R)this.mouseX=R;if(this.mouseY>E)this.mouseY=E}}class k0{id;debugname=null;constructor(_){this.id=_}unpackType(_){while(!0){let R=_.g1();if(R===0)break;this.unpack(R,_)}return this}}class N0 extends k0{static totalCount=0;static instances=[];static unpack(_){let R=new f(_.read("flo.dat"));this.totalCount=R.g2();for(let E=0;E<this.totalCount;E++)this.instances[E]=new N0(E).unpackType(R)}static hsl24to16(_,R,E){if(E>179)R=R/2|0;if(E>192)R=R/2|0;if(E>217)R=R/2|0;if(E>243)R=R/2|0;return((_/4|0)<<10)+((R/32|0)<<7)+(E/2|0)}static mulHSL(_,R){if(_===-1)return 12345678;if(R=R*(_&127)/128|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}static adjustLightness(_,R){if(_===-2)return 12345678;if(_===-1){if(R<0)R=0;else if(R>127)R=127;return 127-R}else{if(R=R*(_&127)/128|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}}rgb=0;overlayTexture=-1;opcode3=!1;occlude=!0;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;unpack(_,R){if(_===1)this.rgb=R.g3(),this.setColor(this.rgb);else if(_===2)this.overlayTexture=R.g1();else if(_===3)this.opcode3=!0;else if(_===5)this.occlude=!1;else if(_===6)this.debugname=R.gjstr()}setColor(_){let R=(_>>16&255)/256,E=(_>>8&255)/256,b=(_&255)/256,G=R;if(E<R)G=E;if(b<G)G=b;let N=R;if(E>R)N=E;if(b>N)N=b;let L=0,H=0,I=(G+N)/2;if(G!==N){if(I<0.5)H=(N-G)/(N+G);if(I>=0.5)H=(N-G)/(2-N-G);if(R===N)L=(E-b)/(N-G);else if(E===N)L=(b-R)/(N-G)+2;else if(b===N)L=(R-E)/(N-G)+4}if(L/=6,this.hue=L*256|0,this.saturation=H*256|0,this.lightness=I*256|0,this.saturation<0)this.saturation=0;else if(this.saturation>255)this.saturation=255;if(this.lightness<0)this.lightness=0;else if(this.lightness>255)this.lightness=255;if(I>0.5)this.luminance=(1-I)*H*512|0;else this.luminance=I*H*512|0;if(this.luminance<1)this.luminance=1;this.chroma=L*this.luminance|0;let Q=this.hue+(Math.random()*16|0)-8;if(Q<0)Q=0;else if(Q>255)Q=255;let q=this.saturation+(Math.random()*48|0)-24;if(q<0)q=0;else if(q>255)q=255;let O=this.lightness+(Math.random()*48|0)-24;if(O<0)O=0;else if(O>255)O=255;this.hsl=N0.hsl24to16(Q,q,O)}}class g0{static instances=[];static unpack(_){let R=new f(_.read("base_head.dat")),E=new f(_.read("base_type.dat")),b=new f(_.read("base_label.dat")),G=R.g2();R.pos+=2;for(let N=0;N<G;N++){let L=R.g2(),H=R.g1(),I=new Uint8Array(H),Q=new C(H,null);for(let q=0;q<H;q++){I[q]=E.g1();let O=b.g1(),U=new Uint8Array(O);for(let $=0;$<O;$++)U[$]=b.g1();Q[q]=U}this.instances[L]=new g0,this.instances[L].animLength=H,this.instances[L].animTypes=I,this.instances[L].animLabels=Q}}animLength=0;animTypes=null;animLabels=null}class A0{static instances=[];static unpack(_){let R=new f(_.read("frame_head.dat")),E=new f(_.read("frame_tran1.dat")),b=new f(_.read("frame_tran2.dat")),G=new f(_.read("frame_del.dat")),N=R.g2();R.pos+=2;let L=new Int32Array(500),H=new Int32Array(500),I=new Int32Array(500),Q=new Int32Array(500);for(let q=0;q<N;q++){let O=R.g2(),U=this.instances[O]=new A0;U.frameDelay=G.g1();let $=R.g2(),K=g0.instances[$];U.base=K;let u=R.g1(),F=-1,k=0;for(let j=0;j<u;j++){if(!K.animTypes)throw new Error;let m=E.g1();if(m>0){if(K.animTypes[j]!==0){for(let X=j-1;X>F;X--)if(K.animTypes[X]===0){L[k]=X,H[k]=0,I[k]=0,Q[k]=0,k++;break}}L[k]=j;let Y=0;if(K.animTypes[L[k]]===3)Y=128;if((m&1)===0)H[k]=Y;else H[k]=b.gsmart();if((m&2)===0)I[k]=Y;else I[k]=b.gsmart();if((m&4)===0)Q[k]=Y;else Q[k]=b.gsmart();F=j,k++}}U.frameLength=k,U.bases=new Int32Array(k),U.x=new Int32Array(k),U.y=new Int32Array(k),U.z=new Int32Array(k);for(let j=0;j<k;j++)U.bases[j]=L[j],U.x[j]=H[j],U.y[j]=I[j],U.z[j]=Q[j]}}frameDelay=0;base=null;frameLength=0;bases=null;x=null;y=null;z=null}class r extends k0{static totalCount=0;static instances=[];seqFrameCount=0;seqFrames=null;seqIframes=null;seqDelay=null;replayoff=-1;walkmerge=null;stretches=!1;seqPriority=5;righthand=-1;lefthand=-1;replaycount=99;seqDuration=0;static unpack(_){let R=new f(_.read("seq.dat"));this.totalCount=R.g2();for(let E=0;E<this.totalCount;E++){let b=new r(E).unpackType(R);if(b.seqFrameCount===0)b.seqFrameCount=1,b.seqFrames=new Int16Array(1),b.seqFrames[0]=-1,b.seqIframes=new Int16Array(1),b.seqIframes[0]=-1,b.seqDelay=new Int16Array(1),b.seqDelay[0]=-1;this.instances[E]=b}}unpack(_,R){if(_===1){this.seqFrameCount=R.g1(),this.seqFrames=new Int16Array(this.seqFrameCount),this.seqIframes=new Int16Array(this.seqFrameCount),this.seqDelay=new Int16Array(this.seqFrameCount);for(let E=0;E<this.seqFrameCount;E++){if(this.seqFrames[E]=R.g2(),this.seqIframes[E]=R.g2(),this.seqIframes[E]===65535)this.seqIframes[E]=-1;if(this.seqDelay[E]=R.g2(),this.seqDelay[E]===0)this.seqDelay[E]=A0.instances[this.seqFrames[E]].frameDelay;if(this.seqDelay[E]===0)this.seqDelay[E]=1;this.seqDuration+=this.seqDelay[E]}}else if(_===2)this.replayoff=R.g2();else if(_===3){let E=R.g1();this.walkmerge=new Int32Array(E+1);for(let b=0;b<E;b++)this.walkmerge[b]=R.g1();this.walkmerge[E]=9999999}else if(_===4)this.stretches=!0;else if(_===5)this.seqPriority=R.g1();else if(_===6)this.righthand=R.g2();else if(_===7)this.lefthand=R.g2();else if(_===8)this.replaycount=R.g1()}}class l0{bucketCount;buckets;constructor(_){this.buckets=new Array(_),this.bucketCount=_;for(let R=0;R<_;R++){let E=this.buckets[R]=new F0;E.next=E,E.prev=E}}get(_){let R=this.buckets[Number(_&BigInt(this.bucketCount-1))];for(let E=R.next;E!==R;E=E.next){if(!E)continue;if(E.key===_)return E}return null}put(_,R){if(R.prev)R.unlink();let E=this.buckets[Number(_&BigInt(this.bucketCount-1))];if(R.prev=E.prev,R.next=E,R.prev)R.prev.next=R;R.next.prev=R,R.key=_}}class o0{head=new j0;constructor(){this.head.next2=this.head,this.head.prev2=this.head}push(_){if(_.prev2)_.unlink2();if(_.prev2=this.head.prev2,_.next2=this.head,_.prev2)_.prev2.next2=_;_.next2.prev2=_}pop(){let _=this.head.next2;if(_===this.head)return null;else return _?.unlink2(),_}}class u0{capacity;hashtable=new l0(1024);cacheHistory=new o0;cacheAvailable;constructor(_){this.capacity=_,this.cacheAvailable=_}get(_){let R=this.hashtable.get(_);if(R)this.cacheHistory.push(R);return R}put(_,R){if(this.cacheAvailable===0){let E=this.cacheHistory.pop();E?.unlink(),E?.unlink2()}else this.cacheAvailable--;this.hashtable.put(_,R),this.cacheHistory.push(R)}clear(){while(!0){let _=this.cacheHistory.pop();if(!_){this.cacheAvailable=this.capacity;return}_.unlink(),_.unlink2()}}}class h{static WALL_STRAIGHT=new h(0,0);static WALL_DIAGONAL_CORNER=new h(1,0);static WALL_L=new h(2,0);static WALL_SQUARE_CORNER=new h(3,0);static WALLDECOR_STRAIGHT_NOOFFSET=new h(4,1);static WALLDECOR_STRAIGHT_OFFSET=new h(5,1);static WALLDECOR_DIAGONAL_OFFSET=new h(6,1);static WALLDECOR_DIAGONAL_NOOFFSET=new h(7,1);static WALLDECOR_DIAGONAL_BOTH=new h(8,1);static WALL_DIAGONAL=new h(9,2);static CENTREPIECE_STRAIGHT=new h(10,2);static CENTREPIECE_DIAGONAL=new h(11,2);static ROOF_STRAIGHT=new h(12,2);static ROOF_DIAGONAL_WITH_ROOFEDGE=new h(13,2);static ROOF_DIAGONAL=new h(14,2);static ROOF_L_CONCAVE=new h(15,2);static ROOF_L_CONVEX=new h(16,2);static ROOF_FLAT=new h(17,2);static ROOFEDGE_STRAIGHT=new h(18,2);static ROOFEDGE_DIAGONAL_CORNER=new h(19,2);static ROOFEDGE_L=new h(20,2);static ROOFEDGE_SQUARE_CORNER=new h(21,2);static GROUND_DECOR=new h(22,3);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(_){let R=this.values();for(let E=0;E<R.length;E++){let b=R[E];if(b.id===_)return b}throw Error("shape not found")}id;layer;constructor(_,R){this.id=_,this.layer=R}}class m_{vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColorsOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1;data=null}class e0{x=0;y=0;z=0;w=0}class J extends j0{static modelMeta=null;static head=null;static face1=null;static face2=null;static face3=null;static face4=null;static face5=null;static point1=null;static point2=null;static point3=null;static point4=null;static point5=null;static vertex1=null;static vertex2=null;static axis=null;static faceClippedX=new C(4096,!1);static faceNearClipped=new C(4096,!1);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new X0(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new X0(12,2000);static tmpPriority10FaceDepth=new Int32Array(2000);static tmpPriority11FaceDepth=new Int32Array(2000);static tmpPriorityDepthSum=new Int32Array(12);static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColor=new Int32Array(10);static baseX=0;static baseY=0;static baseZ=0;static checkHover=!1;static mouseX=0;static mouseY=0;static pickedCount=0;static picked=new Int32Array(1000);static checkHoverFace=!1;static unpack(_){try{J.head=new f(_.read("ob_head.dat")),J.face1=new f(_.read("ob_face1.dat")),J.face2=new f(_.read("ob_face2.dat")),J.face3=new f(_.read("ob_face3.dat")),J.face4=new f(_.read("ob_face4.dat")),J.face5=new f(_.read("ob_face5.dat")),J.point1=new f(_.read("ob_point1.dat")),J.point2=new f(_.read("ob_point2.dat")),J.point3=new f(_.read("ob_point3.dat")),J.point4=new f(_.read("ob_point4.dat")),J.point5=new f(_.read("ob_point5.dat")),J.vertex1=new f(_.read("ob_vertex1.dat")),J.vertex2=new f(_.read("ob_vertex2.dat")),J.axis=new f(_.read("ob_axis.dat")),J.head.pos=0,J.point1.pos=0,J.point2.pos=0,J.point3.pos=0,J.point4.pos=0,J.vertex1.pos=0,J.vertex2.pos=0;let R=J.head.g2();J.modelMeta=new C(R+100,null);let E=0,b=0,G=0,N=0,L=0,H=0,I=0;for(let Q=0;Q<R;Q++){let q=J.head.g2(),O=new m_;O.vertexCount=J.head.g2(),O.faceCount=J.head.g2(),O.texturedFaceCount=J.head.g1(),O.vertexFlagsOffset=J.point1.pos,O.vertexXOffset=J.point2.pos,O.vertexYOffset=J.point3.pos,O.vertexZOffset=J.point4.pos,O.faceVerticesOffset=J.vertex1.pos,O.faceOrientationsOffset=J.vertex2.pos;let U=J.head.g1(),$=J.head.g1(),K=J.head.g1(),u=J.head.g1(),F=J.head.g1();for(let k=0;k<O.vertexCount;k++){let j=J.point1.g1();if((j&1)!==0)J.point2.gsmart();if((j&2)!==0)J.point3.gsmart();if((j&4)!==0)J.point4.gsmart()}for(let k=0;k<O.faceCount;k++){if(J.vertex2.g1()===1)J.vertex1.gsmart(),J.vertex1.gsmart();J.vertex1.gsmart()}if(O.faceColorsOffset=G,G+=O.faceCount*2,U===1)O.faceInfosOffset=N,N+=O.faceCount;if($===255)O.facePrioritiesOffset=L,L+=O.faceCount;else O.facePrioritiesOffset=-$-1;if(K===1)O.faceAlphasOffset=H,H+=O.faceCount;if(u===1)O.faceLabelsOffset=I,I+=O.faceCount;if(F===1)O.vertexLabelsOffset=b,b+=O.vertexCount;O.faceTextureAxisOffset=E,E+=O.texturedFaceCount,J.modelMeta[q]=O}}catch(R){}}static mulColorLightness(_,R,E){if((E&2)===2){if(R<0)R=0;else if(R>127)R=127;return 127-R}if(R=R*(_&127)>>7,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}static modelCopyFaces(_,R,E){let{vertexCount:b,faceCount:G,texturedFaceCount:N}=_,L;if(R){L=new Int32Array(b);for(let $=0;$<b;$++)L[$]=_.vertexY[$]}else L=_.vertexY;let H,I,Q,q,O=null,U=null;if(E){H=new Int32Array(G),I=new Int32Array(G),Q=new Int32Array(G);for(let $=0;$<G;$++){if(_.faceColorA)H[$]=_.faceColorA[$];if(_.faceColorB)I[$]=_.faceColorB[$];if(_.faceColorC)Q[$]=_.faceColorC[$]}if(q=new Int32Array(G),!_.faceInfo)for(let $=0;$<G;$++)q[$]=0;else for(let $=0;$<G;$++)q[$]=_.faceInfo[$];O=new C(b,null);for(let $=0;$<b;$++){let K=O[$]=new e0;if(_.vertexNormal){let u=_.vertexNormal[$];if(u)K.x=u.x,K.y=u.y,K.z=u.z,K.w=u.w}}U=_.vertexNormalOriginal}else H=_.faceColorA,I=_.faceColorB,Q=_.faceColorC,q=_.faceInfo;return new J({vertexCount:b,vertexX:_.vertexX,vertexY:L,vertexZ:_.vertexZ,faceCount:G,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:H,faceColorB:I,faceColorC:Q,faceInfo:q,facePriority:_.facePriority,faceAlpha:_.faceAlpha,faceColor:_.faceColor,priorityVal:_.priorityVal,texturedFaceCount:N,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,minX:_.minX,maxX:_.maxX,minZ:_.minZ,maxZ:_.maxZ,radius:_.radius,minY:_.minY,maxY:_.maxY,maxDepth:_.maxDepth,minDepth:_.minDepth,vertexNormal:O,vertexNormalOriginal:U})}static modelShareColored(_,R,E,b){let{vertexCount:G,faceCount:N,texturedFaceCount:L}=_,H,I,Q;if(b)H=_.vertexX,I=_.vertexY,Q=_.vertexZ;else{H=new Int32Array(G),I=new Int32Array(G),Q=new Int32Array(G);for(let U=0;U<G;U++)H[U]=_.vertexX[U],I[U]=_.vertexY[U],Q[U]=_.vertexZ[U]}let q;if(R)q=_.faceColor;else{q=new Int32Array(N);for(let U=0;U<N;U++)if(_.faceColor)q[U]=_.faceColor[U]}let O;if(E)O=_.faceAlpha;else if(O=new Int32Array(N),!_.faceAlpha)for(let U=0;U<N;U++)O[U]=0;else for(let U=0;U<N;U++)O[U]=_.faceAlpha[U];return new J({vertexCount:G,vertexX:H,vertexY:I,vertexZ:Q,faceCount:N,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:O,faceColor:q,priorityVal:_.priorityVal,texturedFaceCount:L,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,vertexLabel:_.vertexLabel,faceLabel:_.faceLabel})}static modelShareAlpha(_,R){let{vertexCount:E,faceCount:b,texturedFaceCount:G}=_,N=new Int32Array(E),L=new Int32Array(E),H=new Int32Array(E);for(let Q=0;Q<E;Q++)N[Q]=_.vertexX[Q],L[Q]=_.vertexY[Q],H[Q]=_.vertexZ[Q];let I;if(R)I=_.faceAlpha;else if(I=new Int32Array(b),!_.faceAlpha)for(let Q=0;Q<b;Q++)I[Q]=0;else for(let Q=0;Q<b;Q++)I[Q]=_.faceAlpha[Q];return new J({vertexCount:E,vertexX:N,vertexY:L,vertexZ:H,faceCount:b,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:_.faceColorA,faceColorB:_.faceColorB,faceColorC:_.faceColorC,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:I,faceColor:_.faceColor,priorityVal:_.priorityVal,texturedFaceCount:G,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,labelVertices:_.labelVertices,labelFaces:_.labelFaces})}static modelFromModelsBounds(_,R){let E=!1,b=!1,G=!1,N=!1,L=0,H=0,I=0,Q=-1;for(let S=0;S<R;S++){let A=_[S];if(A){if(L+=A.vertexCount,H+=A.faceCount,I+=A.texturedFaceCount,E||=A.faceInfo!==null,!A.facePriority){if(Q===-1)Q=A.priorityVal;if(Q!==A.priorityVal)b=!0}else b=!0;G||=A.faceAlpha!==null,N||=A.faceColor!==null}}let q=new Int32Array(L),O=new Int32Array(L),U=new Int32Array(L),$=new Int32Array(H),K=new Int32Array(H),u=new Int32Array(H),F=new Int32Array(H),k=new Int32Array(H),j=new Int32Array(H),m=new Int32Array(I),Y=new Int32Array(I),X=new Int32Array(I),B=null;if(E)B=new Int32Array(H);let z=null;if(b)z=new Int32Array(H);let Z=null;if(G)Z=new Int32Array(H);let g=null;if(N)g=new Int32Array(H);L=0,H=0,I=0;for(let S=0;S<R;S++){let A=_[S];if(A){let W=L;for(let v=0;v<A.vertexCount;v++)q[L]=A.vertexX[v],O[L]=A.vertexY[v],U[L]=A.vertexZ[v],L++;for(let v=0;v<A.faceCount;v++){if($[H]=A.faceVertexA[v]+W,K[H]=A.faceVertexB[v]+W,u[H]=A.faceVertexC[v]+W,A.faceColorA)F[H]=A.faceColorA[v];if(A.faceColorB)k[H]=A.faceColorB[v];if(A.faceColorC)j[H]=A.faceColorC[v];if(E){if(!A.faceInfo){if(B)B[H]=0}else if(B)B[H]=A.faceInfo[v]}if(b){if(!A.facePriority){if(z)z[H]=A.priorityVal}else if(z)z[H]=A.facePriority[v]}if(G){if(!A.faceAlpha){if(Z)Z[H]=0}else if(Z)Z[H]=A.faceAlpha[v]}if(N&&A.faceColor){if(g)g[H]=A.faceColor[v]}H++}for(let v=0;v<A.texturedFaceCount;v++)m[I]=A.texturedVertexA[v]+W,Y[I]=A.texturedVertexB[v]+W,X[I]=A.texturedVertexC[v]+W,I++}}let M=new J({vertexCount:L,vertexX:q,vertexY:O,vertexZ:U,faceCount:H,faceVertexA:$,faceVertexB:K,faceVertexC:u,faceColorA:F,faceColorB:k,faceColorC:j,faceInfo:B,facePriority:z,faceAlpha:Z,faceColor:g,priorityVal:Q,texturedFaceCount:I,texturedVertexA:m,texturedVertexB:Y,texturedVertexC:X});return M.calculateBoundsCylinder(),M}static modelFromModels(_,R){let E=!1,b=!1,G=!1,N=!1,L=0,H=0,I=0,Q=-1;for(let M=0;M<R;M++){let S=_[M];if(S){if(L+=S.vertexCount,H+=S.faceCount,I+=S.texturedFaceCount,E||=S.faceInfo!==null,!S.facePriority){if(Q===-1)Q=S.priorityVal;if(Q!==S.priorityVal)b=!0}else b=!0;G||=S.faceAlpha!==null,N||=S.faceLabel!==null}}let q=new Int32Array(L),O=new Int32Array(L),U=new Int32Array(L),$=new Int32Array(L),K=new Int32Array(H),u=new Int32Array(H),F=new Int32Array(H),k=new Int32Array(I),j=new Int32Array(I),m=new Int32Array(I),Y=null;if(E)Y=new Int32Array(H);let X=null;if(b)X=new Int32Array(H);let B=null;if(G)B=new Int32Array(H);let z=null;if(N)z=new Int32Array(H);let Z=new Int32Array(H);L=0,H=0,I=0;let g=(M,S,A,W,v,n,D)=>{let i=-1,x=M.vertexX[S],c=M.vertexY[S],R0=M.vertexZ[S];for(let t=0;t<D;t++)if(x===A[t]&&c===W[t]&&R0===v[t]){i=t;break}if(i===-1){if(A[D]=x,W[D]=c,v[D]=R0,n&&M.vertexLabel)n[D]=M.vertexLabel[S];i=D++}return{vertex:i,vertexCount:D}};for(let M=0;M<R;M++){let S=_[M];if(S){for(let A=0;A<S.faceCount;A++){if(E){if(!S.faceInfo){if(Y)Y[H]=0}else if(Y)Y[H]=S.faceInfo[A]}if(b){if(!S.facePriority){if(X)X[H]=S.priorityVal}else if(X)X[H]=S.facePriority[A]}if(G){if(!S.faceAlpha){if(B)B[H]=0}else if(B)B[H]=S.faceAlpha[A]}if(N&&S.faceLabel){if(z)z[H]=S.faceLabel[A]}if(S.faceColor)Z[H]=S.faceColor[A];let W=g(S,S.faceVertexA[A],q,O,U,$,L);L=W.vertexCount;let v=g(S,S.faceVertexB[A],q,O,U,$,L);L=v.vertexCount;let n=g(S,S.faceVertexC[A],q,O,U,$,L);L=n.vertexCount,K[H]=W.vertex,u[H]=v.vertex,F[H]=n.vertex,H++}for(let A=0;A<S.texturedFaceCount;A++){let W=g(S,S.texturedVertexA[A],q,O,U,$,L);L=W.vertexCount;let v=g(S,S.texturedVertexB[A],q,O,U,$,L);L=v.vertexCount;let n=g(S,S.texturedVertexC[A],q,O,U,$,L);L=n.vertexCount,k[I]=W.vertex,j[I]=v.vertex,m[I]=n.vertex,I++}}}return new J({vertexCount:L,vertexX:q,vertexY:O,vertexZ:U,faceCount:H,faceVertexA:K,faceVertexB:u,faceVertexC:F,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:Y,facePriority:X,faceAlpha:B,faceColor:Z,priorityVal:Q,texturedFaceCount:I,texturedVertexA:k,texturedVertexB:j,texturedVertexC:m,vertexLabel:$,faceLabel:z})}static model(_){if(!J.modelMeta)throw new Error;let R=J.modelMeta[_];if(!R)throw new Error;if(!J.head||!J.face1||!J.face2||!J.face3||!J.face4||!J.face5||!J.point1||!J.point2||!J.point3||!J.point4||!J.point5||!J.vertex1||!J.vertex2||!J.axis)throw new Error;let{vertexCount:E,faceCount:b,texturedFaceCount:G}=R,N=new Int32Array(E),L=new Int32Array(E),H=new Int32Array(E),I=new Int32Array(b),Q=new Int32Array(b),q=new Int32Array(b),O=new Int32Array(G),U=new Int32Array(G),$=new Int32Array(G),K=null;if(R.vertexLabelsOffset>=0)K=new Int32Array(E);let u=null;if(R.faceInfosOffset>=0)u=new Int32Array(b);let F=null,k=0;if(R.facePrioritiesOffset>=0)F=new Int32Array(b);else k=-R.facePrioritiesOffset-1;let j=null;if(R.faceAlphasOffset>=0)j=new Int32Array(b);let m=null;if(R.faceLabelsOffset>=0)m=new Int32Array(b);let Y=new Int32Array(b);J.point1.pos=R.vertexFlagsOffset,J.point2.pos=R.vertexXOffset,J.point3.pos=R.vertexYOffset,J.point4.pos=R.vertexZOffset,J.point5.pos=R.vertexLabelsOffset;let X=0,B=0,z=0,Z,g,M;for(let A=0;A<E;A++){let W=J.point1.g1();if(Z=0,(W&1)!==0)Z=J.point2.gsmart();if(g=0,(W&2)!==0)g=J.point3.gsmart();if(M=0,(W&4)!==0)M=J.point4.gsmart();if(N[A]=X+Z,L[A]=B+g,H[A]=z+M,X=N[A],B=L[A],z=H[A],K)K[A]=J.point5.g1()}J.face1.pos=R.faceColorsOffset,J.face2.pos=R.faceInfosOffset,J.face3.pos=R.facePrioritiesOffset,J.face4.pos=R.faceAlphasOffset,J.face5.pos=R.faceLabelsOffset;for(let A=0;A<b;A++){if(Y[A]=J.face1.g2(),u)u[A]=J.face2.g1();if(F)F[A]=J.face3.g1();if(j)j[A]=J.face4.g1();if(m)m[A]=J.face5.g1()}J.vertex1.pos=R.faceVerticesOffset,J.vertex2.pos=R.faceOrientationsOffset,Z=0,g=0,M=0;let S=0;for(let A=0;A<b;A++){let W=J.vertex2.g1();if(W===1)Z=J.vertex1.gsmart()+S,S=Z,g=J.vertex1.gsmart()+S,S=g,M=J.vertex1.gsmart()+S,S=M;else if(W===2)g=M,M=J.vertex1.gsmart()+S,S=M;else if(W===3)Z=M,M=J.vertex1.gsmart()+S,S=M;else if(W===4){let v=Z;Z=g,g=v,M=J.vertex1.gsmart()+S,S=M}I[A]=Z,Q[A]=g,q[A]=M}J.axis.pos=R.faceTextureAxisOffset*6;for(let A=0;A<G;A++)O[A]=J.axis.g2(),U[A]=J.axis.g2(),$[A]=J.axis.g2();return new J({vertexCount:E,vertexX:N,vertexY:L,vertexZ:H,faceCount:b,faceVertexA:I,faceVertexB:Q,faceVertexC:q,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:u,facePriority:F,faceAlpha:j,faceColor:Y,priorityVal:k,texturedFaceCount:G,texturedVertexA:O,texturedVertexB:U,texturedVertexC:$,vertexLabel:K,faceLabel:m})}vertexCount;vertexX;vertexY;vertexZ;faceCount;faceVertexA;faceVertexB;faceVertexC;faceColorA;faceColorB;faceColorC;faceInfo;facePriority;faceAlpha;faceColor;priorityVal;texturedFaceCount;texturedVertexA;texturedVertexB;texturedVertexC;minX;maxX;minZ;maxZ;radius;minY;maxY;maxDepth;minDepth;vertexLabel;faceLabel;labelVertices;labelFaces;vertexNormal;vertexNormalOriginal;objRaise=0;pickable=!1;pickedFace=-1;pickedFaceDepth=-1;constructor(_){super();this.vertexCount=_.vertexCount,this.vertexX=_.vertexX,this.vertexY=_.vertexY,this.vertexZ=_.vertexZ,this.faceCount=_.faceCount,this.faceVertexA=_.faceVertexA,this.faceVertexB=_.faceVertexB,this.faceVertexC=_.faceVertexC,this.faceColorA=_.faceColorA,this.faceColorB=_.faceColorB,this.faceColorC=_.faceColorC,this.faceInfo=_.faceInfo,this.facePriority=_.facePriority,this.faceAlpha=_.faceAlpha,this.faceColor=_.faceColor,this.priorityVal=_.priorityVal,this.texturedFaceCount=_.texturedFaceCount,this.texturedVertexA=_.texturedVertexA,this.texturedVertexB=_.texturedVertexB,this.texturedVertexC=_.texturedVertexC,this.minX=_.minX??0,this.maxX=_.maxX??0,this.minZ=_.minZ??0,this.maxZ=_.maxZ??0,this.radius=_.radius??0,this.minY=_.minY??0,this.maxY=_.maxY??0,this.maxDepth=_.maxDepth??0,this.minDepth=_.minDepth??0,this.vertexLabel=_.vertexLabel??null,this.faceLabel=_.faceLabel??null,this.labelVertices=_.labelVertices??null,this.labelFaces=_.labelFaces??null,this.vertexNormal=_.vertexNormal??null,this.vertexNormalOriginal=_.vertexNormalOriginal??null}calculateBoundsCylinder(){this.maxY=0,this.radius=0,this.minY=0;for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_],E=this.vertexY[_],b=this.vertexZ[_];if(-E>this.maxY)this.maxY=-E;if(E>this.minY)this.minY=E;let G=R*R+b*b;if(G>this.radius)this.radius=G}this.radius=Math.sqrt(this.radius)+0.99|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0)}calculateBoundsY(){this.maxY=0,this.minY=0;for(let _=0;_<this.vertexCount;_++){let R=this.vertexY[_];if(-R>this.maxY)this.maxY=-R;if(R>this.minY)this.minY=R}this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0)}createLabelReferences(){if(this.vertexLabel){let _=new Int32Array(256),R=0;for(let b=0;b<this.vertexCount;b++){let G=this.vertexLabel[b];if(_[G]++,G>R)R=G}this.labelVertices=new C(R+1,null);for(let b=0;b<=R;b++)this.labelVertices[b]=new Int32Array(_[b]),_[b]=0;let E=0;while(E<this.vertexCount){let b=this.vertexLabel[E],G=this.labelVertices[b];if(!G)continue;G[_[b]++]=E++}this.vertexLabel=null}if(this.faceLabel){let _=new Int32Array(256),R=0;for(let b=0;b<this.faceCount;b++){let G=this.faceLabel[b];if(_[G]++,G>R)R=G}this.labelFaces=new C(R+1,null);for(let b=0;b<=R;b++)this.labelFaces[b]=new Int32Array(_[b]),_[b]=0;let E=0;while(E<this.faceCount){let b=this.faceLabel[E],G=this.labelFaces[b];if(!G)continue;G[_[b]++]=E++}this.faceLabel=null}}applyTransforms(_,R,E){if(_===-1)return;if(!E||R===-1)this.applyTransform(_);else{let b=A0.instances[_],G=A0.instances[R],N=b.base;J.baseX=0,J.baseY=0,J.baseZ=0;let L=0,H=E[L++];for(let I=0;I<b.frameLength;I++){if(!b.bases)continue;let Q=b.bases[I];while(Q>H)H=E[L++];if(N&&N.animTypes&&b.x&&b.y&&b.z&&N.animLabels&&(Q!==H||N.animTypes[Q]===0))this.applyTransform2(b.x[I],b.y[I],b.z[I],N.animLabels[Q],N.animTypes[Q])}J.baseX=0,J.baseY=0,J.baseZ=0,L=0,H=E[L++];for(let I=0;I<G.frameLength;I++){if(!G.bases)continue;let Q=G.bases[I];while(Q>H)H=E[L++];if(N&&N.animTypes&&G.x&&G.y&&G.z&&N.animLabels&&(Q===H||N.animTypes[Q]===0))this.applyTransform2(G.x[I],G.y[I],G.z[I],N.animLabels[Q],N.animTypes[Q])}}}applyTransform(_){if(!this.labelVertices||_===-1||!A0.instances[_])return;let R=A0.instances[_],E=R.base;J.baseX=0,J.baseY=0,J.baseZ=0;for(let b=0;b<R.frameLength;b++){if(!R.bases||!R.x||!R.y||!R.z||!E||!E.animLabels||!E.animTypes)continue;let G=R.bases[b];this.applyTransform2(R.x[b],R.y[b],R.z[b],E.animLabels[G],E.animTypes[G])}}rotateY90(){for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_];this.vertexX[_]=this.vertexZ[_],this.vertexZ[_]=-R}}rotateX(_){let R=w.sin[_],E=w.cos[_];for(let b=0;b<this.vertexCount;b++){let G=this.vertexY[b]*E-this.vertexZ[b]*R>>16;this.vertexZ[b]=this.vertexY[b]*R+this.vertexZ[b]*E>>16,this.vertexY[b]=G}}translateModel(_,R,E){for(let b=0;b<this.vertexCount;b++)this.vertexX[b]+=R,this.vertexY[b]+=_,this.vertexZ[b]+=E}recolor(_,R){if(!this.faceColor)return;for(let E=0;E<this.faceCount;E++)if(this.faceColor[E]===_)this.faceColor[E]=R}rotateY180(){for(let _=0;_<this.vertexCount;_++)this.vertexZ[_]=-this.vertexZ[_];for(let _=0;_<this.faceCount;_++){let R=this.faceVertexA[_];this.faceVertexA[_]=this.faceVertexC[_],this.faceVertexC[_]=R}}scale(_,R,E){for(let b=0;b<this.vertexCount;b++)this.vertexX[b]=this.vertexX[b]*_/128|0,this.vertexY[b]=this.vertexY[b]*R/128|0,this.vertexZ[b]=this.vertexZ[b]*E/128|0}calculateNormals(_,R,E,b,G,N){let L=Math.sqrt(E*E+b*b+G*G)|0,H=R*L>>8;if(!this.faceColorA||!this.faceColorB||!this.faceColorC)this.faceColorA=new Int32Array(this.faceCount),this.faceColorB=new Int32Array(this.faceCount),this.faceColorC=new Int32Array(this.faceCount);if(!this.vertexNormal){this.vertexNormal=new C(this.vertexCount,null);for(let I=0;I<this.vertexCount;I++)this.vertexNormal[I]=new e0}for(let I=0;I<this.faceCount;I++){let Q=this.faceVertexA[I],q=this.faceVertexB[I],O=this.faceVertexC[I],U=this.vertexX[q]-this.vertexX[Q],$=this.vertexY[q]-this.vertexY[Q],K=this.vertexZ[q]-this.vertexZ[Q],u=this.vertexX[O]-this.vertexX[Q],F=this.vertexY[O]-this.vertexY[Q],k=this.vertexZ[O]-this.vertexZ[Q],j=$*k-F*K,m=K*u-k*U,Y=U*F-u*$;while(j>8192||m>8192||Y>8192||j<-8192||m<-8192||Y<-8192)j>>=1,m>>=1,Y>>=1;let X=Math.sqrt(j*j+m*m+Y*Y)|0;if(X<=0)X=1;if(j=j*256/X|0,m=m*256/X|0,Y=Y*256/X|0,!this.faceInfo||(this.faceInfo[I]&1)===0){let B=this.vertexNormal[Q];if(B)B.x+=j,B.y+=m,B.z+=Y,B.w++;if(B=this.vertexNormal[q],B)B.x+=j,B.y+=m,B.z+=Y,B.w++;if(B=this.vertexNormal[O],B)B.x+=j,B.y+=m,B.z+=Y,B.w++}else{let B=_+((E*j+b*m+G*Y)/(H+(H/2|0))|0);if(this.faceColor)this.faceColorA[I]=J.mulColorLightness(this.faceColor[I],B,this.faceInfo[I])}}if(N)this.applyLighting(_,H,E,b,G);else{this.vertexNormalOriginal=new C(this.vertexCount,null);for(let I=0;I<this.vertexCount;I++){let Q=this.vertexNormal[I],q=new e0;if(Q)q.x=Q.x,q.y=Q.y,q.z=Q.z,q.w=Q.w;this.vertexNormalOriginal[I]=q}}if(N)this.calculateBoundsCylinder();else this.calculateBoundsAABB()}applyLighting(_,R,E,b,G){for(let N=0;N<this.faceCount;N++){let L=this.faceVertexA[N],H=this.faceVertexB[N],I=this.faceVertexC[N];if(!this.faceInfo&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){let Q=this.faceColor[N],q=this.vertexNormal[L];if(q)this.faceColorA[N]=J.mulColorLightness(Q,_+((E*q.x+b*q.y+G*q.z)/(R*q.w)|0),0);let O=this.vertexNormal[H];if(O)this.faceColorB[N]=J.mulColorLightness(Q,_+((E*O.x+b*O.y+G*O.z)/(R*O.w)|0),0);let U=this.vertexNormal[I];if(U)this.faceColorC[N]=J.mulColorLightness(Q,_+((E*U.x+b*U.y+G*U.z)/(R*U.w)|0),0)}else if(this.faceInfo&&(this.faceInfo[N]&1)===0&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){let Q=this.faceColor[N],q=this.faceInfo[N],O=this.vertexNormal[L];if(O)this.faceColorA[N]=J.mulColorLightness(Q,_+((E*O.x+b*O.y+G*O.z)/(R*O.w)|0),q);let U=this.vertexNormal[H];if(U)this.faceColorB[N]=J.mulColorLightness(Q,_+((E*U.x+b*U.y+G*U.z)/(R*U.w)|0),q);let $=this.vertexNormal[I];if($)this.faceColorC[N]=J.mulColorLightness(Q,_+((E*$.x+b*$.y+G*$.z)/(R*$.w)|0),q)}}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo){for(let N=0;N<this.faceCount;N++)if((this.faceInfo[N]&2)===2)return}this.faceColor=null}drawSimple(_,R,E,b,G,N,L){let H=w.sin[_],I=w.cos[_],Q=w.sin[R],q=w.cos[R],O=w.sin[E],U=w.cos[E],$=w.sin[b],K=w.cos[b],u=N*$+L*K>>16;for(let F=0;F<this.vertexCount;F++){let k=this.vertexX[F],j=this.vertexY[F],m=this.vertexZ[F],Y;if(E!==0)Y=j*O+k*U>>16,j=j*U-k*O>>16,k=Y;if(_!==0)Y=j*I-m*H>>16,m=j*H+m*I>>16,j=Y;if(R!==0)Y=m*Q+k*q>>16,m=m*q-k*Q>>16,k=Y;if(k+=G,j+=N,m+=L,Y=j*K-m*$>>16,m=j*$+m*K>>16,j=Y,J.vertexScreenX&&J.vertexScreenY&&J.vertexScreenZ)J.vertexScreenZ[F]=m-u,J.vertexScreenX[F]=w.centerX+((k<<9)/m|0),J.vertexScreenY[F]=w.centerY+((j<<9)/m|0);if(this.texturedFaceCount>0&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ)J.vertexViewSpaceX[F]=k,J.vertexViewSpaceY[F]=j,J.vertexViewSpaceZ[F]=m}try{this.draw2(!1,!1,0)}catch(F){}}draw(_,R,E,b,G,N,L,H,I){let Q=H*G-N*b>>16,q=L*R+Q*E>>16,O=this.radius*E>>16,U=q+O;if(U<=50||q>=3500)return;let $=H*b+N*G>>16,K=$-this.radius<<9;if((K/U|0)>=T.centerX2d)return;let u=$+this.radius<<9;if((u/U|0)<=-T.centerX2d)return;let F=L*E-Q*R>>16,k=this.radius*R>>16,j=F+k<<9;if((j/U|0)<=-T.centerY2d)return;let m=k+(this.maxY*E>>16),Y=F-m<<9;if((Y/U|0)>=T.centerY2d)return;let X=O+(this.maxY*R>>16),B=q-X<=50,z=!1;if(I>0&&J.checkHover){let A=q-O;if(A<=50)A=50;if($>0)K=K/U|0,u=u/A|0;else u=u/U|0,K=K/A|0;if(F>0)Y=Y/U|0,j=j/A|0;else j=j/U|0,Y=Y/A|0;let W=J.mouseX-w.centerX,v=J.mouseY-w.centerY;if(W>K&&W<u&&v>Y&&v<j)if(this.pickable)J.picked[J.pickedCount++]=I;else z=!0}let Z=w.centerX,g=w.centerY,M=0,S=0;if(_!==0)M=w.sin[_],S=w.cos[_];for(let A=0;A<this.vertexCount;A++){let W=this.vertexX[A],v=this.vertexY[A],n=this.vertexZ[A],D;if(_!==0)D=n*M+W*S>>16,n=n*S-W*M>>16,W=D;if(W+=N,v+=L,n+=H,D=n*b+W*G>>16,n=n*G-W*b>>16,W=D,D=v*E-n*R>>16,n=v*R+n*E>>16,v=D,J.vertexScreenZ)J.vertexScreenZ[A]=n-q;if(n>=50&&J.vertexScreenX&&J.vertexScreenY)J.vertexScreenX[A]=Z+((W<<9)/n|0),J.vertexScreenY[A]=g+((v<<9)/n|0);else if(J.vertexScreenX)J.vertexScreenX[A]=-5000,B=!0;if((B||this.texturedFaceCount>0)&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ)J.vertexViewSpaceX[A]=W,J.vertexViewSpaceY[A]=v,J.vertexViewSpaceZ[A]=n}try{this.draw2(B,z,I)}catch(A){}}draw2(_,R,E,b=!1){if(J.checkHoverFace)this.pickedFace=-1,this.pickedFaceDepth=-1;for(let H=0;H<this.maxDepth;H++)if(J.tmpDepthFaceCount)J.tmpDepthFaceCount[H]=0;for(let H=0;H<this.faceCount;H++){if(this.faceInfo&&this.faceInfo[H]===-1)continue;if(J.vertexScreenX&&J.vertexScreenY&&J.vertexScreenZ&&J.tmpDepthFaces&&J.tmpDepthFaceCount){let I=this.faceVertexA[H],Q=this.faceVertexB[H],q=this.faceVertexC[H],O=J.vertexScreenX[I],U=J.vertexScreenX[Q],$=J.vertexScreenX[q],K=J.vertexScreenY[I],u=J.vertexScreenY[Q],F=J.vertexScreenY[q],k=J.vertexScreenZ[I],j=J.vertexScreenZ[Q],m=J.vertexScreenZ[q];if(_&&(O===-5000||U===-5000||$===-5000)){if(J.faceNearClipped)J.faceNearClipped[H]=!0;if(J.tmpDepthFaces&&J.tmpDepthFaceCount){let Y=((k+j+m)/3|0)+this.minDepth;J.tmpDepthFaces[Y][J.tmpDepthFaceCount[Y]++]=H}}else{if(R&&this.pointWithinTriangle(J.mouseX,J.mouseY,K,u,F,O,U,$))J.picked[J.pickedCount++]=E,R=!1;let Y=O-U,X=K-u,B=$-U,z=F-u;if(Y*z-X*B<=0)continue;if(J.faceNearClipped)J.faceNearClipped[H]=!1;if(J.faceClippedX)J.faceClippedX[H]=O<0||U<0||$<0||O>T.boundX||U>T.boundX||$>T.boundX;if(J.tmpDepthFaces&&J.tmpDepthFaceCount){let Z=((k+j+m)/3|0)+this.minDepth;if(J.tmpDepthFaces[Z][J.tmpDepthFaceCount[Z]++]=H,J.checkHoverFace&&this.pointWithinTriangle(J.mouseX,J.mouseY,K,u,F,O,U,$)&&this.pickedFaceDepth<Z)this.pickedFace=H,this.pickedFaceDepth=Z}}}}if(!this.facePriority&&J.tmpDepthFaceCount){for(let H=this.maxDepth-1;H>=0;H--){let I=J.tmpDepthFaceCount[H];if(I<=0)continue;if(J.tmpDepthFaces){let Q=J.tmpDepthFaces[H];for(let q=0;q<I;q++)try{this.drawFace(Q[q],b)}catch(O){}}}return}for(let H=0;H<12;H++)if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum)J.tmpPriorityFaceCount[H]=0,J.tmpPriorityDepthSum[H]=0;if(J.tmpDepthFaceCount)for(let H=this.maxDepth-1;H>=0;H--){let I=J.tmpDepthFaceCount[H];if(I>0&&J.tmpDepthFaces){let Q=J.tmpDepthFaces[H];for(let q=0;q<I;q++)if(this.facePriority&&J.tmpPriorityFaceCount&&J.tmpPriorityFaces){let O=Q[q],U=this.facePriority[O],$=J.tmpPriorityFaceCount[U]++;if(J.tmpPriorityFaces[U][$]=O,U<10&&J.tmpPriorityDepthSum)J.tmpPriorityDepthSum[U]+=H;else if(U===10&&J.tmpPriority10FaceDepth)J.tmpPriority10FaceDepth[$]=H;else if(J.tmpPriority11FaceDepth)J.tmpPriority11FaceDepth[$]=H}}}let G=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[1]>0||J.tmpPriorityFaceCount[2]>0))G=(J.tmpPriorityDepthSum[1]+J.tmpPriorityDepthSum[2])/(J.tmpPriorityFaceCount[1]+J.tmpPriorityFaceCount[2])|0;let N=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[3]>0||J.tmpPriorityFaceCount[4]>0))N=(J.tmpPriorityDepthSum[3]+J.tmpPriorityDepthSum[4])/(J.tmpPriorityFaceCount[3]+J.tmpPriorityFaceCount[4])|0;let L=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[6]>0||J.tmpPriorityFaceCount[8]>0))L=(J.tmpPriorityDepthSum[6]+J.tmpPriorityDepthSum[8])/(J.tmpPriorityFaceCount[6]+J.tmpPriorityFaceCount[8])|0;if(J.tmpPriorityFaceCount&&J.tmpPriorityFaces){let H=0,I=J.tmpPriorityFaceCount[10],Q=J.tmpPriorityFaces[10],q=J.tmpPriority10FaceDepth;if(H===I)H=0,I=J.tmpPriorityFaceCount[11],Q=J.tmpPriorityFaces[11],q=J.tmpPriority11FaceDepth;let O;if(H<I&&q)O=q[H];else O=-1000;for(let U=0;U<10;U++){while(U===0&&O>G)try{if(this.drawFace(Q[H++],b),H===I&&Q!==J.tmpPriorityFaces[11])H=0,I=J.tmpPriorityFaceCount[11],Q=J.tmpPriorityFaces[11],q=J.tmpPriority11FaceDepth;if(H<I&&q)O=q[H];else O=-1000}catch(u){}while(U===3&&O>N)try{if(this.drawFace(Q[H++],b),H===I&&Q!==J.tmpPriorityFaces[11])H=0,I=J.tmpPriorityFaceCount[11],Q=J.tmpPriorityFaces[11],q=J.tmpPriority11FaceDepth;if(H<I&&q)O=q[H];else O=-1000}catch(u){}while(U===5&&O>L)try{if(this.drawFace(Q[H++],b),H===I&&Q!==J.tmpPriorityFaces[11])H=0,I=J.tmpPriorityFaceCount[11],Q=J.tmpPriorityFaces[11],q=J.tmpPriority11FaceDepth;if(H<I&&q)O=q[H];else O=-1000}catch(u){}let $=J.tmpPriorityFaceCount[U],K=J.tmpPriorityFaces[U];for(let u=0;u<$;u++)try{this.drawFace(K[u],b)}catch(F){}}while(O!==-1000)try{if(this.drawFace(Q[H++],b),H===I&&Q!==J.tmpPriorityFaces[11])H=0,Q=J.tmpPriorityFaces[11],I=J.tmpPriorityFaceCount[11],q=J.tmpPriority11FaceDepth;if(H<I&&q)O=q[H];else O=-1000}catch(U){}}}drawFace(_,R=!1){if(J.faceNearClipped&&J.faceNearClipped[_]){this.drawNearClippedFace(_,R);return}let E=this.faceVertexA[_],b=this.faceVertexB[_],G=this.faceVertexC[_];if(J.faceClippedX)w.clipX=J.faceClippedX[_];if(!this.faceAlpha)w.alpha=0;else w.alpha=this.faceAlpha[_];let N;if(!this.faceInfo)N=0;else N=this.faceInfo[_]&3;if(R&&J.vertexScreenX&&J.vertexScreenY&&this.faceColorA&&this.faceColorB&&this.faceColorC)w.drawLine(J.vertexScreenX[E],J.vertexScreenY[E],J.vertexScreenX[b],J.vertexScreenY[b],w.hslPal[this.faceColorA[_]]),w.drawLine(J.vertexScreenX[b],J.vertexScreenY[b],J.vertexScreenX[G],J.vertexScreenY[G],w.hslPal[this.faceColorB[_]]),w.drawLine(J.vertexScreenX[G],J.vertexScreenY[G],J.vertexScreenX[E],J.vertexScreenY[E],w.hslPal[this.faceColorC[_]]);else if(N===0&&this.faceColorA&&this.faceColorB&&this.faceColorC&&J.vertexScreenX&&J.vertexScreenY)w.fillGouraudTriangle(J.vertexScreenX[E],J.vertexScreenX[b],J.vertexScreenX[G],J.vertexScreenY[E],J.vertexScreenY[b],J.vertexScreenY[G],this.faceColorA[_],this.faceColorB[_],this.faceColorC[_]);else if(N===1&&this.faceColorA&&J.vertexScreenX&&J.vertexScreenY)w.fillTriangle(J.vertexScreenX[E],J.vertexScreenX[b],J.vertexScreenX[G],J.vertexScreenY[E],J.vertexScreenY[b],J.vertexScreenY[G],w.hslPal[this.faceColorA[_]]);else if(N===2&&this.faceInfo&&this.faceColor&&this.faceColorA&&this.faceColorB&&this.faceColorC&&J.vertexScreenX&&J.vertexScreenY&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let L=this.faceInfo[_]>>2,H=this.texturedVertexA[L],I=this.texturedVertexB[L],Q=this.texturedVertexC[L];w.fillTexturedTriangle(J.vertexScreenX[E],J.vertexScreenX[b],J.vertexScreenX[G],J.vertexScreenY[E],J.vertexScreenY[b],J.vertexScreenY[G],this.faceColorA[_],this.faceColorB[_],this.faceColorC[_],J.vertexViewSpaceX[H],J.vertexViewSpaceY[H],J.vertexViewSpaceZ[H],J.vertexViewSpaceX[I],J.vertexViewSpaceX[Q],J.vertexViewSpaceY[I],J.vertexViewSpaceY[Q],J.vertexViewSpaceZ[I],J.vertexViewSpaceZ[Q],this.faceColor[_])}else if(N===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&J.vertexScreenX&&J.vertexScreenY&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let L=this.faceInfo[_]>>2,H=this.texturedVertexA[L],I=this.texturedVertexB[L],Q=this.texturedVertexC[L];w.fillTexturedTriangle(J.vertexScreenX[E],J.vertexScreenX[b],J.vertexScreenX[G],J.vertexScreenY[E],J.vertexScreenY[b],J.vertexScreenY[G],this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],J.vertexViewSpaceX[H],J.vertexViewSpaceY[H],J.vertexViewSpaceZ[H],J.vertexViewSpaceX[I],J.vertexViewSpaceX[Q],J.vertexViewSpaceY[I],J.vertexViewSpaceY[Q],J.vertexViewSpaceZ[I],J.vertexViewSpaceZ[Q],this.faceColor[_])}}drawNearClippedFace(_,R=!1){let E=0;if(J.vertexViewSpaceZ){let Q=w.centerX,q=w.centerY,O=this.faceVertexA[_],U=this.faceVertexB[_],$=this.faceVertexC[_],K=J.vertexViewSpaceZ[O],u=J.vertexViewSpaceZ[U],F=J.vertexViewSpaceZ[$];if(K>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColorA)J.clippedX[E]=J.vertexScreenX[O],J.clippedY[E]=J.vertexScreenY[O],J.clippedColor[E++]=this.faceColorA[_];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColorA){let k=J.vertexViewSpaceX[O],j=J.vertexViewSpaceY[O],m=this.faceColorA[_];if(F>=50&&this.faceColorC){let Y=(50-K)*w.reciprocal16[F-K];J.clippedX[E]=Q+((k+((J.vertexViewSpaceX[$]-k)*Y>>16)<<9)/50|0),J.clippedY[E]=q+((j+((J.vertexViewSpaceY[$]-j)*Y>>16)<<9)/50|0),J.clippedColor[E++]=m+((this.faceColorC[_]-m)*Y>>16)}if(u>=50&&this.faceColorB){let Y=(50-K)*w.reciprocal16[u-K];J.clippedX[E]=Q+((k+((J.vertexViewSpaceX[U]-k)*Y>>16)<<9)/50|0),J.clippedY[E]=q+((j+((J.vertexViewSpaceY[U]-j)*Y>>16)<<9)/50|0),J.clippedColor[E++]=m+((this.faceColorB[_]-m)*Y>>16)}}if(u>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColorB)J.clippedX[E]=J.vertexScreenX[U],J.clippedY[E]=J.vertexScreenY[U],J.clippedColor[E++]=this.faceColorB[_];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColorB){let k=J.vertexViewSpaceX[U],j=J.vertexViewSpaceY[U],m=this.faceColorB[_];if(K>=50&&this.faceColorA){let Y=(50-u)*w.reciprocal16[K-u];J.clippedX[E]=Q+((k+((J.vertexViewSpaceX[O]-k)*Y>>16)<<9)/50|0),J.clippedY[E]=q+((j+((J.vertexViewSpaceY[O]-j)*Y>>16)<<9)/50|0),J.clippedColor[E++]=m+((this.faceColorA[_]-m)*Y>>16)}if(F>=50&&this.faceColorC){let Y=(50-u)*w.reciprocal16[F-u];J.clippedX[E]=Q+((k+((J.vertexViewSpaceX[$]-k)*Y>>16)<<9)/50|0),J.clippedY[E]=q+((j+((J.vertexViewSpaceY[$]-j)*Y>>16)<<9)/50|0),J.clippedColor[E++]=m+((this.faceColorC[_]-m)*Y>>16)}}if(F>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColorC)J.clippedX[E]=J.vertexScreenX[$],J.clippedY[E]=J.vertexScreenY[$],J.clippedColor[E++]=this.faceColorC[_];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColorC){let k=J.vertexViewSpaceX[$],j=J.vertexViewSpaceY[$],m=this.faceColorC[_];if(u>=50&&this.faceColorB){let Y=(50-F)*w.reciprocal16[u-F];J.clippedX[E]=Q+((k+((J.vertexViewSpaceX[U]-k)*Y>>16)<<9)/50|0),J.clippedY[E]=q+((j+((J.vertexViewSpaceY[U]-j)*Y>>16)<<9)/50|0),J.clippedColor[E++]=m+((this.faceColorB[_]-m)*Y>>16)}if(K>=50&&this.faceColorA){let Y=(50-F)*w.reciprocal16[K-F];J.clippedX[E]=Q+((k+((J.vertexViewSpaceX[O]-k)*Y>>16)<<9)/50|0),J.clippedY[E]=q+((j+((J.vertexViewSpaceY[O]-j)*Y>>16)<<9)/50|0),J.clippedColor[E++]=m+((this.faceColorA[_]-m)*Y>>16)}}}let b=J.clippedX[0],G=J.clippedX[1],N=J.clippedX[2],L=J.clippedY[0],H=J.clippedY[1],I=J.clippedY[2];if((b-G)*(I-H)-(L-H)*(N-G)<=0)return;if(w.clipX=!1,E===3){if(b<0||G<0||N<0||b>T.boundX||G>T.boundX||N>T.boundX)w.clipX=!0;let Q;if(!this.faceInfo)Q=0;else Q=this.faceInfo[_]&3;if(R)w.drawLine(b,G,L,H,J.clippedColor[0]),w.drawLine(G,N,H,I,J.clippedColor[1]),w.drawLine(N,b,I,L,J.clippedColor[2]);else if(Q===0)w.fillGouraudTriangle(b,G,N,L,H,I,J.clippedColor[0],J.clippedColor[1],J.clippedColor[2]);else if(Q===1&&this.faceColorA)w.fillTriangle(b,G,N,L,H,I,w.hslPal[this.faceColorA[_]]);else if(Q===2&&this.faceInfo&&this.faceColor&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let q=this.faceInfo[_]>>2,O=this.texturedVertexA[q],U=this.texturedVertexB[q],$=this.texturedVertexC[q];w.fillTexturedTriangle(b,G,N,L,H,I,J.clippedColor[0],J.clippedColor[1],J.clippedColor[2],J.vertexViewSpaceX[O],J.vertexViewSpaceY[O],J.vertexViewSpaceZ[O],J.vertexViewSpaceX[U],J.vertexViewSpaceX[$],J.vertexViewSpaceY[U],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[U],J.vertexViewSpaceZ[$],this.faceColor[_])}else if(Q===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let q=this.faceInfo[_]>>2,O=this.texturedVertexA[q],U=this.texturedVertexB[q],$=this.texturedVertexC[q];w.fillTexturedTriangle(b,G,N,L,H,I,this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],J.vertexViewSpaceX[O],J.vertexViewSpaceY[O],J.vertexViewSpaceZ[O],J.vertexViewSpaceX[U],J.vertexViewSpaceX[$],J.vertexViewSpaceY[U],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[U],J.vertexViewSpaceZ[$],this.faceColor[_])}}else if(E===4){if(b<0||G<0||N<0||b>T.boundX||G>T.boundX||N>T.boundX||J.clippedX[3]<0||J.clippedX[3]>T.boundX)w.clipX=!0;let Q;if(!this.faceInfo)Q=0;else Q=this.faceInfo[_]&3;if(R)w.drawLine(b,G,L,H,J.clippedColor[0]),w.drawLine(G,N,H,I,J.clippedColor[1]),w.drawLine(N,J.clippedX[3],I,J.clippedY[3],J.clippedColor[2]),w.drawLine(J.clippedX[3],b,J.clippedY[3],L,J.clippedColor[3]);else if(Q===0)w.fillGouraudTriangle(b,G,N,L,H,I,J.clippedColor[0],J.clippedColor[1],J.clippedColor[2]),w.fillGouraudTriangle(b,N,J.clippedX[3],L,I,J.clippedY[3],J.clippedColor[0],J.clippedColor[2],J.clippedColor[3]);else if(Q===1){if(this.faceColorA){let q=w.hslPal[this.faceColorA[_]];w.fillTriangle(b,G,N,L,H,I,q),w.fillTriangle(b,N,J.clippedX[3],L,I,J.clippedY[3],q)}}else if(Q===2&&this.faceInfo&&this.faceColor&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let q=this.faceInfo[_]>>2,O=this.texturedVertexA[q],U=this.texturedVertexB[q],$=this.texturedVertexC[q];w.fillTexturedTriangle(b,G,N,L,H,I,J.clippedColor[0],J.clippedColor[1],J.clippedColor[2],J.vertexViewSpaceX[O],J.vertexViewSpaceY[O],J.vertexViewSpaceZ[O],J.vertexViewSpaceX[U],J.vertexViewSpaceX[$],J.vertexViewSpaceY[U],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[U],J.vertexViewSpaceZ[$],this.faceColor[_]),w.fillTexturedTriangle(b,N,J.clippedX[3],L,I,J.clippedY[3],J.clippedColor[0],J.clippedColor[2],J.clippedColor[3],J.vertexViewSpaceX[O],J.vertexViewSpaceY[O],J.vertexViewSpaceZ[O],J.vertexViewSpaceX[U],J.vertexViewSpaceX[$],J.vertexViewSpaceY[U],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[U],J.vertexViewSpaceZ[$],this.faceColor[_])}else if(Q===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let q=this.faceInfo[_]>>2,O=this.texturedVertexA[q],U=this.texturedVertexB[q],$=this.texturedVertexC[q];w.fillTexturedTriangle(b,G,N,L,H,I,this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],J.vertexViewSpaceX[O],J.vertexViewSpaceY[O],J.vertexViewSpaceZ[O],J.vertexViewSpaceX[U],J.vertexViewSpaceX[$],J.vertexViewSpaceY[U],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[U],J.vertexViewSpaceZ[$],this.faceColor[_]),w.fillTexturedTriangle(b,N,J.clippedX[3],L,I,J.clippedY[3],this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],J.vertexViewSpaceX[O],J.vertexViewSpaceY[O],J.vertexViewSpaceZ[O],J.vertexViewSpaceX[U],J.vertexViewSpaceX[$],J.vertexViewSpaceY[U],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[U],J.vertexViewSpaceZ[$],this.faceColor[_])}}}applyTransform2(_,R,E,b,G){if(!b)return;let N=b.length;if(G===0){let L=0;J.baseX=0,J.baseY=0,J.baseZ=0;for(let H=0;H<N;H++){if(!this.labelVertices)continue;let I=b[H];if(I<this.labelVertices.length){let Q=this.labelVertices[I];if(Q)for(let q=0;q<Q.length;q++){let O=Q[q];J.baseX+=this.vertexX[O],J.baseY+=this.vertexY[O],J.baseZ+=this.vertexZ[O],L++}}}if(L>0)J.baseX=(J.baseX/L|0)+_,J.baseY=(J.baseY/L|0)+R,J.baseZ=(J.baseZ/L|0)+E;else J.baseX=_,J.baseY=R,J.baseZ=E}else if(G===1)for(let L=0;L<N;L++){let H=b[L];if(!this.labelVertices||H>=this.labelVertices.length)continue;let I=this.labelVertices[H];if(I)for(let Q=0;Q<I.length;Q++){let q=I[Q];this.vertexX[q]+=_,this.vertexY[q]+=R,this.vertexZ[q]+=E}}else if(G===2)for(let L=0;L<N;L++){let H=b[L];if(!this.labelVertices||H>=this.labelVertices.length)continue;let I=this.labelVertices[H];if(I)for(let Q=0;Q<I.length;Q++){let q=I[Q];this.vertexX[q]-=J.baseX,this.vertexY[q]-=J.baseY,this.vertexZ[q]-=J.baseZ;let O=(_&255)*8,U=(R&255)*8,$=(E&255)*8,K,u;if($!==0){K=w.sin[$],u=w.cos[$];let F=this.vertexY[q]*K+this.vertexX[q]*u>>16;this.vertexY[q]=this.vertexY[q]*u-this.vertexX[q]*K>>16,this.vertexX[q]=F}if(O!==0){K=w.sin[O],u=w.cos[O];let F=this.vertexY[q]*u-this.vertexZ[q]*K>>16;this.vertexZ[q]=this.vertexY[q]*K+this.vertexZ[q]*u>>16,this.vertexY[q]=F}if(U!==0){K=w.sin[U],u=w.cos[U];let F=this.vertexZ[q]*K+this.vertexX[q]*u>>16;this.vertexZ[q]=this.vertexZ[q]*u-this.vertexX[q]*K>>16,this.vertexX[q]=F}this.vertexX[q]+=J.baseX,this.vertexY[q]+=J.baseY,this.vertexZ[q]+=J.baseZ}}else if(G===3)for(let L=0;L<N;L++){let H=b[L];if(!this.labelVertices||H>=this.labelVertices.length)continue;let I=this.labelVertices[H];if(I)for(let Q=0;Q<I.length;Q++){let q=I[Q];this.vertexX[q]-=J.baseX,this.vertexY[q]-=J.baseY,this.vertexZ[q]-=J.baseZ,this.vertexX[q]=this.vertexX[q]*_/128|0,this.vertexY[q]=this.vertexY[q]*R/128|0,this.vertexZ[q]=this.vertexZ[q]*E/128|0,this.vertexX[q]+=J.baseX,this.vertexY[q]+=J.baseY,this.vertexZ[q]+=J.baseZ}}else if(G===5&&this.labelFaces&&this.faceAlpha)for(let L=0;L<N;L++){let H=b[L];if(H>=this.labelFaces.length)continue;let I=this.labelFaces[H];if(I)for(let Q=0;Q<I.length;Q++){let q=I[Q];if(this.faceAlpha[q]+=_*8,this.faceAlpha[q]<0)this.faceAlpha[q]=0;if(this.faceAlpha[q]>255)this.faceAlpha[q]=255}}}calculateBoundsAABB(){this.maxY=0,this.radius=0,this.minY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_],E=this.vertexY[_],b=this.vertexZ[_];if(R<this.minX)this.minX=R;if(R>this.maxX)this.maxX=R;if(b<this.minZ)this.minZ=b;if(b>this.maxZ)this.maxZ=b;if(-E>this.maxY)this.maxY=-E;if(E>this.minY)this.minY=E;let G=R*R+b*b;if(G>this.radius)this.radius=G}this.radius=Math.sqrt(this.radius)|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0)}pointWithinTriangle(_,R,E,b,G,N,L,H){if(R<E&&R<b&&R<G)return!1;else if(R>E&&R>b&&R>G)return!1;else if(_<N&&_<L&&_<H)return!1;else return _<=N||_<=L||_<=H}drawFaceOutline(_){if(!J.vertexScreenX||!J.vertexScreenY||!this.faceColorA||!this.faceColorB||!this.faceColorC)return;let R=this.faceVertexA[_],E=this.faceVertexB[_],b=this.faceVertexC[_];w.drawLine(J.vertexScreenX[R],J.vertexScreenY[R],J.vertexScreenX[E],J.vertexScreenY[E],w.hslPal[1000]),w.drawLine(J.vertexScreenX[E],J.vertexScreenY[E],J.vertexScreenX[b],J.vertexScreenY[b],w.hslPal[1000]),w.drawLine(J.vertexScreenX[b],J.vertexScreenY[b],J.vertexScreenX[R],J.vertexScreenY[R],w.hslPal[1000])}}class Q0 extends k0{static totalCount=0;static typeCache=null;static dat=null;static offsets=null;static cachePos=0;static modelCacheStatic=new u0(500);static modelCacheDynamic=new u0(30);static unpack(_){this.dat=new f(_.read("loc.dat"));let R=new f(_.read("loc.idx"));this.totalCount=R.g2(),this.offsets=new Int32Array(this.totalCount);let E=2;for(let b=0;b<this.totalCount;b++)this.offsets[b]=E,E+=R.g2();this.typeCache=new C(10,null);for(let b=0;b<10;b++)this.typeCache[b]=new Q0(-1)}static get(_){if(!this.typeCache||!this.offsets||!this.dat)throw new Error;for(let E=0;E<10;E++){let b=this.typeCache[E];if(!b)continue;if(b.id===_)return b}this.cachePos=(this.cachePos+1)%10;let R=this.typeCache[this.cachePos];if(this.dat.pos=this.offsets[_],R.id=_,R.reset(),R.unpackType(this.dat),!R.shapes)R.shapes=new Int32Array(1);if(R.active2===-1&&R.shapes){if(R.locActive=R.shapes.length>0&&R.shapes[0]===h.CENTREPIECE_STRAIGHT.id,R.op)R.locActive=!0}return R}models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;locActive=!1;active2=-1;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;disposeAlpha=!1;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;offsetx=0;offsety=0;offsetz=0;forcedecor=!1;unpack(_,R){if(_===1){let E=R.g1();this.models=new Int32Array(E),this.shapes=new Int32Array(E);for(let b=0;b<E;b++)this.models[b]=R.g2(),this.shapes[b]=R.g1()}else if(_===2)this.name=R.gjstr();else if(_===3)this.desc=R.gjstr();else if(_===14)this.width=R.g1();else if(_===15)this.length=R.g1();else if(_===17)this.blockwalk=!1;else if(_===18)this.blockrange=!1;else if(_===19){if(this.active2=R.g1(),this.active2===1)this.locActive=!0}else if(_===21)this.hillskew=!0;else if(_===22)this.sharelight=!0;else if(_===23)this.occlude=!0;else if(_===24){if(this.anim=R.g2(),this.anim===65535)this.anim=-1}else if(_===25)this.disposeAlpha=!0;else if(_===28)this.wallwidth=R.g1();else if(_===29)this.ambient=R.g1b();else if(_===39)this.contrast=R.g1b();else if(_>=30&&_<39){if(!this.op)this.op=new C(5,null);if(this.op[_-30]=R.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_===40){let E=R.g1();this.recol_s=new Uint16Array(E),this.recol_d=new Uint16Array(E);for(let b=0;b<E;b++)this.recol_s[b]=R.g2(),this.recol_d[b]=R.g2()}else if(_===60)this.mapfunction=R.g2();else if(_===62)this.mirror=!0;else if(_===64)this.shadow=!1;else if(_===65)this.resizex=R.g2();else if(_===66)this.resizey=R.g2();else if(_===67)this.resizez=R.g2();else if(_===68)this.mapscene=R.g2();else if(_===69)this.forceapproach=R.g1();else if(_===70)this.offsetx=R.g2b();else if(_===71)this.offsety=R.g2b();else if(_===72)this.offsetz=R.g2b();else if(_===73)this.forcedecor=!0}getModel(_,R,E,b,G,N,L){if(!this.shapes)return null;let H=-1;for(let F=0;F<this.shapes.length;F++)if(this.shapes[F]===_){H=F;break}if(H===-1)return null;let I=BigInt(BigInt(this.id)<<6n)+BigInt(BigInt(H)<<3n)+BigInt(R)+BigInt(BigInt(L)+1n<<32n),Q=Q0.modelCacheDynamic?.get(I);if(Q){if(this.hillskew||this.sharelight)Q=J.modelCopyFaces(Q,this.hillskew,this.sharelight);if(this.hillskew){let F=(E+b+G+N)/4|0;for(let k=0;k<Q.vertexCount;k++){let j=Q.vertexX[k],m=Q.vertexZ[k],Y=E+((b-E)*(j+64)/128|0),X=N+((G-N)*(j+64)/128|0),B=Y+((X-Y)*(m+64)/128|0);Q.vertexY[k]+=B-F}Q.calculateBoundsY()}return Q}if(!this.models)return null;if(H>=this.models.length)return null;let q=this.models[H];if(q===-1)return null;let O=this.mirror!==R>3;if(O)q+=65536;let U=Q0.modelCacheStatic?.get(BigInt(q));if(!U){if(U=J.model(q&65535),O)U.rotateY180();Q0.modelCacheStatic?.put(BigInt(q),U)}let $=this.resizex!==128||this.resizey!==128||this.resizez!==128,K=this.offsetx!==0||this.offsety!==0||this.offsetz!==0,u=J.modelShareColored(U,!this.recol_s,!this.disposeAlpha,R===0&&L===-1&&!$&&!K);if(L!==-1)u.createLabelReferences(),u.applyTransform(L),u.labelFaces=null,u.labelVertices=null;while(R-- >0)u.rotateY90();if(this.recol_s&&this.recol_d)for(let F=0;F<this.recol_s.length;F++)u.recolor(this.recol_s[F],this.recol_d[F]);if($)u.scale(this.resizex,this.resizey,this.resizez);if(K)u.translateModel(this.offsety,this.offsetx,this.offsetz);if(u.calculateNormals((this.ambient&255)+64,(this.contrast&255)*5+768,-50,-10,-50,!this.sharelight),this.blockwalk)u.objRaise=u.maxY;if(Q0.modelCacheDynamic?.put(I,u),this.hillskew||this.sharelight)u=J.modelCopyFaces(u,this.hillskew,this.sharelight);if(this.hillskew){let F=(E+b+G+N)/4|0;for(let k=0;k<u.vertexCount;k++){let j=u.vertexX[k],m=u.vertexZ[k],Y=E+((b-E)*(j+64)/128|0),X=N+((G-N)*(j+64)/128|0),B=Y+((X-Y)*(m+64)/128|0);u.vertexY[k]+=B-F}u.calculateBoundsY()}return u}reset(){this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.locActive=!1,this.active2=-1,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.wallwidth=16,this.ambient=0,this.contrast=0,this.op=null,this.disposeAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.offsetx=0,this.offsety=0,this.offsetz=0,this.forcedecor=!1}}async function Y_(_){if(_[0]!==255)_[0]=255;URL.revokeObjectURL(D0.src),D0.src=URL.createObjectURL(new Blob([_],{type:"image/jpeg"})),await new Promise((b)=>D0.onload=()=>b()),a0.clearRect(0,0,v0.width,v0.height);let R=D0.naturalWidth,E=D0.naturalHeight;return v0.width=R,v0.height=E,a0.drawImage(D0,0,0),a0.getImageData(0,0,R,E)}class e extends j0{pixels;width2d;height2d;cropX;cropY;cropW;cropH;constructor(_,R){super();this.pixels=new Int32Array(_*R),this.width2d=this.cropW=_,this.height2d=this.cropH=R,this.cropX=this.cropY=0}static async fromJpeg(_,R){let E=_.read(R+".dat");if(!E)throw new Error;let b=await Y_(E),G=new e(b.width,b.height),N=new Uint32Array(b.data.buffer),L=G.pixels;for(let H=0;H<L.length;H++){let I=N[H];L[H]=(I>>24&255)<<24|(I&255)<<16|(I>>8&255)<<8|I>>16&255}return G}static fromArchive(_,R,E=0){let b=new f(_.read(R+".dat")),G=new f(_.read("index.dat"));G.pos=b.g2();let N=G.g2(),L=G.g2(),H=G.g1(),I=[],Q=H-1;for(let F=0;F<Q;F++)if(I[F+1]=G.g3(),I[F+1]===0)I[F+1]=1;for(let F=0;F<E;F++)G.pos+=2,b.pos+=G.g2()*G.g2(),G.pos+=1;if(b.pos>b.length||G.pos>G.length)throw new Error;let q=G.g1(),O=G.g1(),U=G.g2(),$=G.g2(),K=new e(U,$);K.cropX=q,K.cropY=O,K.cropW=N,K.cropH=L;let u=G.g1();if(u===0){let F=K.width2d*K.height2d;for(let k=0;k<F;k++)K.pixels[k]=I[b.g1()]}else if(u===1){let F=K.width2d;for(let k=0;k<F;k++){let j=K.height2d;for(let m=0;m<j;m++)K.pixels[k+m*F]=I[b.g1()]}}return K}bind(){T.bind(this.pixels,this.width2d,this.height2d)}draw(_,R){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let E=_+R*T.width2d,b=0,G=this.height2d,N=this.width2d,L=T.width2d-N,H=0;if(R<T.top){let I=T.top-R;G-=I,R=T.top,b+=I*N,E+=I*T.width2d}if(R+G>T.bottom)G-=R+G-T.bottom;if(_<T.left){let I=T.left-_;N-=I,_=T.left,b+=I,E+=I,H+=I,L+=I}if(_+N>T.right){let I=_+N-T.right;N-=I,H+=I,L+=I}if(N>0&&G>0)this.copyImageDraw(N,G,this.pixels,b,H,T.pixels,E,L)}drawAlpha(_,R,E){R|=0,E|=0,R+=this.cropX,E+=this.cropY;let b=R+E*T.width2d,G=0,N=this.height2d,L=this.width2d,H=T.width2d-L,I=0;if(E<T.top){let Q=T.top-E;N-=Q,E=T.top,G+=Q*L,b+=Q*T.width2d}if(E+N>T.bottom)N-=E+N-T.bottom;if(R<T.left){let Q=T.left-R;L-=Q,R=T.left,G+=Q,b+=Q,I+=Q,H+=Q}if(R+L>T.right){let Q=R+L-T.right;L-=Q,I+=Q,H+=Q}if(L>0&&N>0)this.copyPixelsAlpha(L,N,this.pixels,G,I,T.pixels,b,H,_)}blitOpaque(_,R){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let E=_+R*T.width2d,b=0,G=this.height2d,N=this.width2d,L=T.width2d-N,H=0;if(R<T.top){let I=T.top-R;G-=I,R=T.top,b+=I*N,E+=I*T.width2d}if(R+G>T.bottom)G-=R+G-T.bottom;if(_<T.left){let I=T.left-_;N-=I,_=T.left,b+=I,E+=I,H+=I,L+=I}if(_+N>T.right){let I=_+N-T.right;N-=I,H+=I,L+=I}if(N>0&&G>0)this.copyImageBlitOpaque(N,G,this.pixels,b,H,T.pixels,E,L)}flipHorizontally(){let _=this.pixels,R=this.width2d,E=this.height2d;for(let b=0;b<E;b++){let G=R/2|0;for(let N=0;N<G;N++){let L=N+b*R,H=R-N-1+b*R,I=_[L];_[L]=_[H],_[H]=I}}}flipVertically(){let _=this.pixels,R=this.width2d,E=this.height2d;for(let b=0;b<(E/2|0);b++)for(let G=0;G<R;G++){let N=G+b*R,L=G+(E-b-1)*R,H=_[N];_[N]=_[L],_[L]=H}}translate2d(_,R,E){for(let b=0;b<this.pixels.length;b++){let G=this.pixels[b];if(G!==0){let N=G>>16&255;if(N+=_,N<1)N=1;else if(N>255)N=255;let L=G>>8&255;if(L+=R,L<1)L=1;else if(L>255)L=255;let H=G&255;if(H+=E,H<1)H=1;else if(H>255)H=255;this.pixels[b]=(N<<16)+(L<<8)+H}}}crop(_,R,E,b){_|=0,R|=0,E|=0,b|=0;try{let G=this.width2d,N=0,L=0,H=this.cropW,I=this.cropH,Q=(H<<16)/E|0,q=(I<<16)/b|0;if(_+=(this.cropX*E+H-1)/H|0,R+=(this.cropY*b+I-1)/I|0,this.cropX*E%H!==0)N=(H-this.cropX*E%H<<16)/E|0;if(this.cropY*b%I!==0)L=(I-this.cropY*b%I<<16)/b|0;E=E*(this.width2d-(N>>16))/H|0,b=b*(this.height2d-(L>>16))/I|0;let O=_+R*T.width2d,U=T.width2d-E;if(R<T.top){let $=T.top-R;b-=$,R=0,O+=$*T.width2d,L+=q*$}if(R+b>T.bottom)b-=R+b-T.bottom;if(_<T.left){let $=T.left-_;E-=$,_=0,O+=$,N+=Q*$,U+=$}if(_+E>T.right){let $=_+E-T.right;E-=$,U+=$}this.scale(E,b,this.pixels,N,L,T.pixels,U,O,G,Q,q)}catch(G){}}drawRotatedMasked(_,R,E,b,G,N,L,H,I,Q){_|=0,R|=0,E|=0,b|=0;try{let q=-E/2|0,O=-b/2|0,U=Math.sin(I/326.11)*65536|0,$=Math.cos(I/326.11)*65536|0,K=U*Q>>8,u=$*Q>>8,F=(L<<16)+O*K+q*u,k=(H<<16)+(O*u-q*K),j=_+R*T.width2d;for(let m=0;m<b;m++){let Y=G[m],X=j+Y,B=F+u*Y,z=k-K*Y;for(let Z=-N[m];Z<0;Z++)T.pixels[X++]=this.pixels[(B>>16)+(z>>16)*this.width2d],B+=u,z-=K;F+=K,k+=u,j+=T.width2d}}catch(q){}}drawMasked(_,R,E){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let b=_+R*T.width2d,G=0,N=this.height2d,L=this.width2d,H=T.width2d-L,I=0;if(R<T.top){let Q=T.top-R;N-=Q,R=T.top,G+=Q*L,b+=Q*T.width2d}if(R+N>T.bottom)N-=R+N-T.bottom;if(_<T.left){let Q=T.left-_;L-=Q,_=T.left,G+=Q,b+=Q,I+=Q,H+=Q}if(_+L>T.right){let Q=_+L-T.right;L-=Q,I+=Q,H+=Q}if(L>0&&N>0)this.copyPixelsMasked(L,N,this.pixels,I,G,T.pixels,b,H,E.pixels)}scale(_,R,E,b,G,N,L,H,I,Q,q){try{let O=b;for(let U=-R;U<0;U++){let $=(G>>16)*I;for(let K=-_;K<0;K++){let u=E[(b>>16)+$];if(u===0)H++;else N[H++]=u;b+=Q}G+=q,b=O,H+=L}}catch(O){}}copyImageBlitOpaque(_,R,E,b,G,N,L,H){let I=-(_>>2);_=-(_&3);for(let Q=-R;Q<0;Q++){for(let q=I;q<0;q++)N[L++]=E[b++],N[L++]=E[b++],N[L++]=E[b++],N[L++]=E[b++];for(let q=_;q<0;q++)N[L++]=E[b++];L+=H,b+=G}}copyPixelsAlpha(_,R,E,b,G,N,L,H,I){let Q=256-I;for(let q=-R;q<0;q++){for(let O=-_;O<0;O++){let U=E[b++];if(U===0)L++;else{let $=N[L];N[L++]=((U&16711935)*I+($&16711935)*Q&4278255360)+((U&65280)*I+($&65280)*Q&16711680)>>8}}L+=H,b+=G}}copyImageDraw(_,R,E,b,G,N,L,H){let I=-(_>>2);_=-(_&3);for(let Q=-R;Q<0;Q++){for(let q=I;q<0;q++){let O=E[b++];if(O===0)L++;else N[L++]=O;if(O=E[b++],O===0)L++;else N[L++]=O;if(O=E[b++],O===0)L++;else N[L++]=O;if(O=E[b++],O===0)L++;else N[L++]=O}for(let q=_;q<0;q++){let O=E[b++];if(O===0)L++;else N[L++]=O}L+=H,b+=G}}copyPixelsMasked(_,R,E,b,G,N,L,H,I){let Q=-(_>>2);_=-(_&3);for(let q=-R;q<0;q++){for(let O=Q;O<0;O++){let U=E[G++];if(U!==0&&I[L]===0)N[L++]=U;else L++;if(U=E[G++],U!==0&&I[L]===0)N[L++]=U;else L++;if(U=E[G++],U!==0&&I[L]===0)N[L++]=U;else L++;if(U=E[G++],U!==0&&I[L]===0)N[L++]=U;else L++}for(let O=_;O<0;O++){let U=E[G++];if(U!==0&&I[L]===0)N[L++]=U;else L++}L+=H,G+=b}}}class _0 extends k0{static totalCount=0;static typeCache=null;static dat=null;static offsets=null;static cachePos=0;static membersWorld=!0;static modelCache=new u0(50);static iconCache=new u0(200);static unpack(_,R){this.membersWorld=R,this.dat=new f(_.read("obj.dat"));let E=new f(_.read("obj.idx"));this.totalCount=E.g2(),this.offsets=new Int32Array(this.totalCount);let b=2;for(let G=0;G<this.totalCount;G++)this.offsets[G]=b,b+=E.g2();this.typeCache=new C(10,null);for(let G=0;G<10;G++)this.typeCache[G]=new _0(-1)}static get(_){if(!this.typeCache||!this.offsets||!this.dat)throw new Error;for(let E=0;E<10;E++){let b=this.typeCache[E];if(!b)continue;if(b.id===_)return b}this.cachePos=(this.cachePos+1)%10;let R=this.typeCache[this.cachePos];if(this.dat.pos=this.offsets[_],R.id=_,R.reset(),R.unpackType(this.dat),R.certtemplate!==-1)R.toCertificate();if(!this.membersWorld&&R.members)R.name="Members Object",R.desc="Login to a members' server to use this object.",R.op=null,R.iop=null;return R}static getIcon(_,R){if(_0.iconCache){let k=_0.iconCache.get(BigInt(_));if(k&&k.cropH!==R&&k.cropH!==-1)k.unlink(),k=null;if(k)return k}let E=_0.get(_);if(!E.countobj)R=-1;if(E.countobj&&E.countco&&R>1){let k=-1;for(let j=0;j<10;j++)if(R>=E.countco[j]&&E.countco[j]!==0)k=E.countobj[j];if(k!==-1)E=_0.get(k)}let b=new e(32,32),G=w.centerX,N=w.centerY,L=w.lineOffset,H=T.pixels,I=T.width2d,Q=T.height2d,q=T.left,O=T.right,U=T.top,$=T.bottom;w.jagged=!1,T.bind(b.pixels,32,32),T.fillRect2d(0,0,32,32,0),w.init2D();let K=E.getInterfaceModel(1),u=w.sin[E.xan2d]*E.zoom2d>>16,F=w.cos[E.xan2d]*E.zoom2d>>16;K.drawSimple(0,E.yan2d,E.zan2d,E.xan2d,E.xof2d,u+(K.maxY/2|0)+E.yof2d,F+E.yof2d);for(let k=31;k>=0;k--)for(let j=31;j>=0;j--){if(b.pixels[k+j*32]!==0)continue;if(k>0&&b.pixels[k+j*32-1]>1)b.pixels[k+j*32]=1;else if(j>0&&b.pixels[k+(j-1)*32]>1)b.pixels[k+j*32]=1;else if(k<31&&b.pixels[k+j*32+1]>1)b.pixels[k+j*32]=1;else if(j<31&&b.pixels[k+(j+1)*32]>1)b.pixels[k+j*32]=1}for(let k=31;k>=0;k--)for(let j=31;j>=0;j--)if(b.pixels[k+j*32]===0&&k>0&&j>0&&b.pixels[k+(j-1)*32-1]>0)b.pixels[k+j*32]=3153952;if(E.certtemplate!==-1){let k=this.getIcon(E.certlink,10),j=k.cropW,m=k.cropH;k.cropW=32,k.cropH=32,k.crop(5,5,22,22),k.cropW=j,k.cropH=m}if(_0.iconCache?.put(BigInt(_),b),T.bind(H,I,Q),T.setBounds(q,U,O,$),w.centerX=G,w.centerY=N,w.lineOffset=L,w.jagged=!0,E.stackable)b.cropW=33;else b.cropW=32;return b.cropH=R,b}model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2000;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;unpack(_,R){if(_===1)this.model=R.g2();else if(_===2)this.name=R.gjstr();else if(_===3)this.desc=R.gjstr();else if(_===4)this.zoom2d=R.g2();else if(_===5)this.xan2d=R.g2();else if(_===6)this.yan2d=R.g2();else if(_===7){if(this.xof2d=R.g2b(),this.xof2d>32767)this.xof2d-=65536}else if(_===8){if(this.yof2d=R.g2b(),this.yof2d>32767)this.yof2d-=65536}else if(_===9)this.code9=!0;else if(_===10)this.code10=R.g2();else if(_===11)this.stackable=!0;else if(_===12)this.cost=R.g4();else if(_===16)this.members=!0;else if(_===23)this.manwear=R.g2(),this.manwearOffsetY=R.g1b();else if(_===24)this.manwear2=R.g2();else if(_===25)this.womanwear=R.g2(),this.womanwearOffsetY=R.g1b();else if(_===26)this.womanwear2=R.g2();else if(_>=30&&_<35){if(!this.op)this.op=new C(5,null);if(this.op[_-30]=R.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_>=35&&_<40){if(!this.iop)this.iop=new C(5,null);this.iop[_-35]=R.gjstr()}else if(_===40){let E=R.g1();this.recol_s=new Uint16Array(E),this.recol_d=new Uint16Array(E);for(let b=0;b<E;b++)this.recol_s[b]=R.g2(),this.recol_d[b]=R.g2()}else if(_===78)this.manwear3=R.g2();else if(_===79)this.womanwear3=R.g2();else if(_===90)this.manhead=R.g2();else if(_===91)this.womanhead=R.g2();else if(_===92)this.manhead2=R.g2();else if(_===93)this.womanhead2=R.g2();else if(_===95)this.zan2d=R.g2();else if(_===97)this.certlink=R.g2();else if(_===98)this.certtemplate=R.g2();else if(_>=100&&_<110){if(!this.countobj||!this.countco)this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10);this.countobj[_-100]=R.g2(),this.countco[_-100]=R.g2()}}getWornModel(_){let R=this.manwear;if(_===1)R=this.womanwear;if(R===-1)return null;let E=this.manwear2,b=this.manwear3;if(_===1)E=this.womanwear2,b=this.womanwear3;let G=J.model(R);if(E!==-1){let N=J.model(E);if(b===-1){let L=[G,N];G=J.modelFromModels(L,2)}else{let L=J.model(b),H=[G,N,L];G=J.modelFromModels(H,3)}}if(_===0&&this.manwearOffsetY!==0)G.translateModel(this.manwearOffsetY,0,0);if(_===1&&this.womanwearOffsetY!==0)G.translateModel(this.womanwearOffsetY,0,0);if(this.recol_s&&this.recol_d)for(let N=0;N<this.recol_s.length;N++)G.recolor(this.recol_s[N],this.recol_d[N]);return G}getHeadModel(_){let R=this.manhead;if(_===1)R=this.womanhead;if(R===-1)return null;let E=this.manhead2;if(_===1)E=this.womanhead2;let b=J.model(R);if(E!==-1){let G=J.model(E),N=[b,G];b=J.modelFromModels(N,2)}if(this.recol_s&&this.recol_d)for(let G=0;G<this.recol_s.length;G++)b.recolor(this.recol_s[G],this.recol_d[G]);return b}getInterfaceModel(_){if(this.countobj&&this.countco&&_>1){let E=-1;for(let b=0;b<10;b++)if(_>=this.countco[b]&&this.countco[b]!==0)E=this.countobj[b];if(E!==-1)return _0.get(E).getInterfaceModel(1)}if(_0.modelCache){let E=_0.modelCache.get(BigInt(this.id));if(E)return E}let R=J.model(this.model);if(this.recol_s&&this.recol_d)for(let E=0;E<this.recol_s.length;E++)R.recolor(this.recol_s[E],this.recol_d[E]);return R.calculateNormals(64,768,-50,-10,-50,!0),R.pickable=!0,_0.modelCache?.put(BigInt(this.id),R),R}toCertificate(){let _=_0.get(this.certtemplate);this.model=_.model,this.zoom2d=_.zoom2d,this.xan2d=_.xan2d,this.yan2d=_.yan2d,this.zan2d=_.zan2d,this.xof2d=_.xof2d,this.yof2d=_.yof2d,this.recol_s=_.recol_s,this.recol_d=_.recol_d;let R=_0.get(this.certlink);this.name=R.name,this.members=R.members,this.cost=R.cost;let E="a",b=(R.name||"").toLowerCase().charAt(0);if(b==="a"||b==="e"||b==="i"||b==="o"||b==="u")E="an";this.desc=`Swap this note at any bank for ${E} ${R.name}.`,this.stackable=!0}reset(){this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2000,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.op=null,this.iop=null,this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1}}class w0 extends k0{static totalCount=0;static typeCache=null;static dat=null;static offsets=null;static cachePos=0;static modelCache=new u0(30);static unpack(_){this.dat=new f(_.read("npc.dat"));let R=new f(_.read("npc.idx"));this.totalCount=R.g2(),this.offsets=new Int32Array(this.totalCount);let E=2;for(let b=0;b<this.totalCount;b++)this.offsets[b]=E,E+=R.g2();this.typeCache=new C(20,null);for(let b=0;b<20;b++)this.typeCache[b]=new w0(-1)}static get(_){if(!this.typeCache||!this.offsets||!this.dat)throw new Error;for(let E=0;E<20;E++){let b=this.typeCache[E];if(!b)continue;if(b.id===_)return b}this.cachePos=(this.cachePos+1)%20;let R=this.typeCache[this.cachePos]=new w0(_);return this.dat.pos=this.offsets[_],R.unpackType(this.dat),R}name=null;desc=null;size=1;models=null;heads=null;disposeAlpha=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;unpack(_,R){if(_===1){let E=R.g1();this.models=new Uint16Array(E);for(let b=0;b<E;b++)this.models[b]=R.g2()}else if(_===2)this.name=R.gjstr();else if(_===3)this.desc=R.gjstr();else if(_===12)this.size=R.g1b();else if(_===13)this.readyanim=R.g2();else if(_===14)this.walkanim=R.g2();else if(_===16)this.disposeAlpha=!0;else if(_===17)this.walkanim=R.g2(),this.walkanim_b=R.g2(),this.walkanim_r=R.g2(),this.walkanim_l=R.g2();else if(_>=30&&_<40){if(!this.op)this.op=new C(5,null);if(this.op[_-30]=R.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_===40){let E=R.g1();this.recol_s=new Uint16Array(E),this.recol_d=new Uint16Array(E);for(let b=0;b<E;b++)this.recol_s[b]=R.g2(),this.recol_d[b]=R.g2()}else if(_===60){let E=R.g1();this.heads=new Uint16Array(E);for(let b=0;b<E;b++)this.heads[b]=R.g2()}else if(_===90)this.resizex=R.g2();else if(_===91)this.resizey=R.g2();else if(_===92)this.resizez=R.g2();else if(_===93)this.minimap=!1;else if(_===95)this.vislevel=R.g2();else if(_===97)this.resizeh=R.g2();else if(_===98)this.resizev=R.g2()}getSequencedModel(_,R,E){let b=null,G=null;if(w0.modelCache){if(G=w0.modelCache.get(BigInt(this.id)),!G&&this.models){let N=new C(this.models.length,null);for(let L=0;L<this.models.length;L++)N[L]=J.model(this.models[L]);if(N.length===1)G=N[0];else G=J.modelFromModels(N,N.length);if(this.recol_s&&this.recol_d)for(let L=0;L<this.recol_s.length;L++)G?.recolor(this.recol_s[L],this.recol_d[L]);if(G?.createLabelReferences(),G?.calculateNormals(64,850,-30,-50,-30,!0),G)w0.modelCache.put(BigInt(this.id),G)}}if(G){if(b=J.modelShareAlpha(G,!this.disposeAlpha),_!==-1&&R!==-1)b.applyTransforms(_,R,E);else if(_!==-1)b.applyTransform(_);if(this.resizeh!==128||this.resizev!==128)b.scale(this.resizeh,this.resizev,this.resizeh);if(b.calculateBoundsCylinder(),b.labelFaces=null,b.labelVertices=null,this.size===1)b.pickable=!0;return b}return null}getHeadModel(){if(!this.heads)return null;let _=new C(this.heads.length,null);for(let E=0;E<this.heads.length;E++)_[E]=J.model(this.heads[E]);let R;if(_.length===1)R=_[0];else R=J.modelFromModels(_,_.length);if(this.recol_s&&this.recol_d)for(let E=0;E<this.recol_s.length;E++)R?.recolor(this.recol_s[E],this.recol_d[E]);return R}}class Y0 extends k0{static totalCount=0;static instances=[];static unpack(_){let R=new f(_.read("idk.dat"));this.totalCount=R.g2();for(let E=0;E<this.totalCount;E++)this.instances[E]=new Y0(E).unpackType(R)}bodyPart=-1;models=null;heads=new Int32Array(5).fill(-1);recol_s=new Int32Array(6);recol_d=new Int32Array(6);disableKit=!1;unpack(_,R){if(_===1)this.bodyPart=R.g1();else if(_===2){let E=R.g1();this.models=new Int32Array(E);for(let b=0;b<E;b++)this.models[b]=R.g2()}else if(_===3)this.disableKit=!0;else if(_>=40&&_<50)this.recol_s[_-40]=R.g2();else if(_>=50&&_<60)this.recol_d[_-50]=R.g2();else if(_>=60&&_<70)this.heads[_-60]=R.g2()}getModel(){if(!this.models)return null;let _=new C(this.models.length,null);for(let E=0;E<this.models.length;E++)_[E]=J.model(this.models[E]);let R;if(_.length===1)R=_[0];else R=J.modelFromModels(_,_.length);for(let E=0;E<6&&this.recol_s[E]!==0;E++)R?.recolor(this.recol_s[E],this.recol_d[E]);return R}getHeadModel(){let _=0,R=new C(5,null);for(let b=0;b<5;b++)if(this.heads[b]!==-1)R[_++]=J.model(this.heads[b]);let E=J.modelFromModels(R,_);for(let b=0;b<6&&this.recol_s[b]!==0;b++)E.recolor(this.recol_s[b],this.recol_d[b]);return E}}class T0 extends k0{static totalCount=0;static instances=[];static modelCache=new u0(30);static unpack(_){let R=new f(_.read("spotanim.dat"));this.totalCount=R.g2();for(let E=0;E<this.totalCount;E++)this.instances[E]=new T0(E).unpackType(R)}model=0;anim=-1;seq=null;disposeAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;spotAngle=0;ambient=0;contrast=0;unpack(_,R){if(_===1)this.model=R.g2();else if(_===2){if(this.anim=R.g2(),r.instances)this.seq=r.instances[this.anim]}else if(_===3)this.disposeAlpha=!0;else if(_===4)this.resizeh=R.g2();else if(_===5)this.resizev=R.g2();else if(_===6)this.spotAngle=R.g2();else if(_===7)this.ambient=R.g1();else if(_===8)this.contrast=R.g1();else if(_>=40&&_<50)this.recol_s[_-40]=R.g2();else if(_>=50&&_<60)this.recol_d[_-50]=R.g2()}getModel(){let _=T0.modelCache?.get(BigInt(this.id));if(_)return _;_=J.model(this.model);for(let R=0;R<6;R++)if(this.recol_s[0]!==0)_.recolor(this.recol_s[R],this.recol_d[R]);return T0.modelCache?.put(BigInt(this.id),_),_}}class S0 extends k0{static totalCount=0;static instances=[];static code3=[];static code3Count=0;static unpack(_){let R=new f(_.read("varp.dat"));this.totalCount=R.g2();for(let E=0;E<this.totalCount;E++)this.instances[E]=new S0(E).unpackType(R)}scope=0;varType=0;code3=!1;protect=!0;clientcode=0;code7=0;transmit=!1;code8=!1;unpack(_,R){if(_===1)this.scope=R.g1();else if(_===2)this.varType=R.g1();else if(_===3)this.code3=!0,S0.code3[S0.code3Count++]=this.id;else if(_===4)this.protect=!1;else if(_===5)this.clientcode=R.g2();else if(_===6)this.transmit=!0;else if(_===7)this.code7=R.g4();else if(_===8)this.code8=!0;else if(_===10)this.debugname=R.gjstr()}}class l{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37(_){_=_.trim();let R=0n;for(let E=0;E<_.length&&E<12;E++){let b=_.charCodeAt(E);if(R*=37n,b>=65&&b<=90)R+=BigInt(b+1-65);else if(b>=97&&b<=122)R+=BigInt(b+1-97);else if(b>=48&&b<=57)R+=BigInt(b+27-48)}return R}static fromBase37(_){if(_<0n||_>=6582952005840035281n)return"invalid_name";if(_%37n===0n)return"invalid_name";let R=0,E=Array(12);while(_!==0n){let b=_;_/=37n,E[11-R++]=this.BASE37_LOOKUP[Number(b-_*37n)]}return E.slice(12-R).join("")}static toSentenceCase(_){let R=[..._.toLowerCase()],E=!0;for(let b=0;b<R.length;b++){let G=R[b];if(E&&G>="a"&&G<="z")R[b]=G.toUpperCase(),E=!1;if(G==="."||G==="!")E=!0}return R.join("")}static toAsterisks(_){let R="";for(let E=0;E<_.length;E++)R=R+"*";return R}static formatIPv4(_){return(_>>24&255)+"."+(_>>16&255)+"."+(_>>8&255)+"."+(_&255)}static formatName(_){if(_.length===0)return _;let R=[..._];for(let E=0;E<R.length;E++)if(R[E]==="_"){if(R[E]=" ",E+1<R.length&&R[E+1]>="a"&&R[E+1]<="z")R[E+1]=String.fromCharCode(R[E+1].charCodeAt(0)+65-97)}if(R[0]>="a"&&R[0]<="z")R[0]=String.fromCharCode(R[0].charCodeAt(0)+65-97);return R.join("")}static hashCode(_){let R=_.toUpperCase(),E=0n;for(let b=0;b<R.length;b++)E=E*61n+BigInt(R.charCodeAt(b))-32n,E=E+(E>>56n)&0xffffffffffffffn;return E}}class s{static instances=[];static imageCache=null;static modelCache=null;static unpack(_,R,E){this.imageCache=new u0(50000),this.modelCache=new u0(50000);let b=new f(_.read("data")),G=-1;b.pos+=2;while(b.pos<b.length){let N=b.g2();if(N===65535)G=b.g2(),N=b.g2();let L=this.instances[N]=new s;if(L.id=N,L.layer=G,L.comType=b.g1(),L.buttonType=b.g1(),L.clientCode=b.g2(),L.width=b.g2(),L.height=b.g2(),L.overLayer=b.g1(),L.overLayer===0)L.overLayer=-1;else L.overLayer=(L.overLayer-1<<8)+b.g1();let H=b.g1();if(H>0){L.scriptComparator=new Uint8Array(H),L.scriptOperand=new Uint16Array(H);for(let Q=0;Q<H;Q++)L.scriptComparator[Q]=b.g1(),L.scriptOperand[Q]=b.g2()}let I=b.g1();if(I>0){L.script=new C(I,null);for(let Q=0;Q<I;Q++){let q=b.g2(),O=new Uint16Array(q);L.script[Q]=O;for(let U=0;U<q;U++)O[U]=b.g2()}}if(L.comType===0){L.scroll=b.g2(),L.hide=b.g1()===1;let Q=b.g1();L.childId=new Array(Q),L.childX=new Array(Q),L.childY=new Array(Q);for(let q=0;q<Q;q++)L.childId[q]=b.g2(),L.childX[q]=b.g2b(),L.childY[q]=b.g2b()}if(L.comType===1)b.pos+=3;if(L.comType===2){L.invSlotObjId=new Int32Array(L.width*L.height),L.invSlotObjCount=new Int32Array(L.width*L.height),L.draggable=b.g1()===1,L.interactable=b.g1()===1,L.usable=b.g1()===1,L.marginX=b.g1(),L.marginY=b.g1(),L.invSlotOffsetX=new Int16Array(20),L.invSlotOffsetY=new Int16Array(20),L.invSlotSprite=new C(20,null);for(let Q=0;Q<20;Q++)if(b.g1()===1){L.invSlotOffsetX[Q]=b.g2b(),L.invSlotOffsetY[Q]=b.g2b();let q=b.gjstr();if(q.length>0){let O=q.lastIndexOf(",");L.invSlotSprite[Q]=this.getImage(R,q.substring(0,O),parseInt(q.substring(O+1),10))}}L.iops=new C(5,null);for(let Q=0;Q<5;Q++){let q=b.gjstr();if(L.iops[Q]=q,q.length===0)L.iops[Q]=null}}if(L.comType===3)L.fill=b.g1()===1;if(L.comType===4||L.comType===1){L.center=b.g1()===1;let Q=b.g1();if(E)L.font=E[Q];L.shadowed=b.g1()===1}if(L.comType===4)L.text=b.gjstr(),L.activeText=b.gjstr();if(L.comType===1||L.comType===3||L.comType===4)L.colour=b.g4();if(L.comType===3||L.comType===4)L.activeColour=b.g4(),L.overColour=b.g4();if(L.comType===5){let Q=b.gjstr();if(Q.length>0){let O=Q.lastIndexOf(",");L.graphic=this.getImage(R,Q.substring(0,O),parseInt(Q.substring(O+1),10))}let q=b.gjstr();if(q.length>0){let O=q.lastIndexOf(",");L.activeGraphic=this.getImage(R,q.substring(0,O),parseInt(q.substring(O+1),10))}}if(L.comType===6){let Q=b.g1();if(Q!==0)L.model=this.getModel((Q-1<<8)+b.g1());let q=b.g1();if(q!==0)L.activeModel=this.getModel((q-1<<8)+b.g1());if(L.anim=b.g1(),L.anim===0)L.anim=-1;else L.anim=(L.anim-1<<8)+b.g1();if(L.activeAnim=b.g1(),L.activeAnim===0)L.activeAnim=-1;else L.activeAnim=(L.activeAnim-1<<8)+b.g1();L.zoom=b.g2(),L.xan=b.g2(),L.yan=b.g2()}if(L.comType===7){L.invSlotObjId=new Int32Array(L.width*L.height),L.invSlotObjCount=new Int32Array(L.width*L.height),L.center=b.g1()===1;let Q=b.g1();if(E)L.font=E[Q];L.shadowed=b.g1()===1,L.colour=b.g4(),L.marginX=b.g2b(),L.marginY=b.g2b(),L.interactable=b.g1()===1,L.iops=new C(5,null);for(let q=0;q<5;q++){let O=b.gjstr();if(L.iops[q]=O,O.length===0)L.iops[q]=null}}if(L.buttonType===2||L.comType===2)L.actionVerb=b.gjstr(),L.action=b.gjstr(),L.actionTarget=b.g2();if(L.buttonType===1||L.buttonType===4||L.buttonType===5||L.buttonType===6){if(L.option=b.gjstr(),L.option.length===0){if(L.buttonType===1)L.option="Ok";else if(L.buttonType===4)L.option="Select";else if(L.buttonType===5)L.option="Select";else if(L.buttonType===6)L.option="Continue"}}}this.imageCache=null,this.modelCache=null}static getImage(_,R,E){let b=l.hashCode(R)<<8n|BigInt(E);if(this.imageCache){let N=this.imageCache.get(b);if(N)return N}let G;try{G=e.fromArchive(_,R,E),this.imageCache?.put(b,G)}catch(N){return null}return G}static getModel(_){if(this.modelCache){let E=this.modelCache.get(BigInt(_));if(E)return E}let R=J.model(_);return this.modelCache?.put(BigInt(_),R),R}id=-1;layer=-1;comType=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;script=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;invSlotOffsetX=null;invSlotOffsetY=null;invSlotSprite=null;iops=null;fill=!1;center=!1;font=null;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=null;activeModel=null;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null;x=0;y=0;scrollPosition=0;invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;getModel(_,R,E){let b=this.model;if(E)b=this.activeModel;if(!b)return null;if(_===-1&&R===-1&&!b.faceColor)return b;let G=J.modelShareColored(b,!0,!0,!1);if(_!==-1||R!==-1)G.createLabelReferences();if(_!==-1)G.applyTransform(_);if(R!==-1)G.applyTransform(R);return G.calculateNormals(64,768,-50,-10,-50,!0),G}getAbsoluteX(){if(this.layer===this.id)return this.x;let _=s.instances[this.layer];if(!_.childId||!_.childX||!_.childY)return this.x;let R=_.childId.indexOf(this.id);if(R===-1)return this.x;let E=_.childX[R];while(_.layer!==_.id){let b=s.instances[_.layer];if(b.childId&&b.childX&&b.childY){if(R=b.childId.indexOf(_.id),R!==-1)E+=b.childX[R]}_=b}return E}getAbsoluteY(){if(this.layer===this.id)return this.y;let _=s.instances[this.layer];if(!_.childId||!_.childX||!_.childY)return this.y;let R=_.childId.indexOf(this.id);if(R===-1)return this.y;let E=_.childY[R];while(_.layer!==_.id){let b=s.instances[_.layer];if(b.childId&&b.childX&&b.childY){if(R=b.childId.indexOf(_.id),R!==-1)E+=b.childY[R]}_=b}return E}outline(_){let R=this.getAbsoluteX(),E=this.getAbsoluteY();T.drawRect(R,E,this.width,this.height,_)}move(_,R){if(this.layer===this.id)return;this.x=0,this.y=0;let E=s.instances[this.layer];if(E.childId&&E.childX&&E.childY){let b=E.childId.indexOf(this.id);if(b!==-1)E.childX[b]=_,E.childY[b]=R}}delete(){if(this.layer===this.id)return;let _=s.instances[this.layer];if(_.childId&&_.childX&&_.childY){let R=_.childId.indexOf(this.id);if(R!==-1)_.childId.splice(R,1),_.childX.splice(R,1),_.childY.splice(R,1)}}}class o{static index=(_,R)=>_*104+R;startX;startZ;sizeX;sizeZ;flags;constructor(){this.startX=0,this.startZ=0,this.sizeX=104,this.sizeZ=104,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset(){for(let _=0;_<this.sizeX;_++)for(let R=0;R<this.sizeZ;R++){let E=o.index(_,R);if(_===0||R===0||_===this.sizeX-1||R===this.sizeZ-1)this.flags[E]=16777215;else this.flags[E]=0}}addFloor(_,R){this.flags[o.index(_-this.startX,R-this.startZ)]|=2097152}removeFloor(_,R){this.flags[o.index(_-this.startX,R-this.startZ)]&=~2097152}addLoc(_,R,E,b,G,N){let L=256;if(N)L|=131072;let H=_-this.startX,I=R-this.startZ;if(G===1||G===3){let Q=E;E=b,b=Q}for(let Q=H;Q<H+E;Q++){if(!(Q>=0&&Q<this.sizeX))continue;for(let q=I;q<I+b;q++){if(!(q>=0&&q<this.sizeZ))continue;this.add(Q,q,L)}}}removeLoc(_,R,E,b,G,N){let L=256;if(N)L|=131072;let H=_-this.startX,I=R-this.startZ;if(G===1||G===3){let Q=E;E=b,b=Q}for(let Q=H;Q<H+E;Q++){if(!(Q>=0&&Q<this.sizeX))continue;for(let q=I;q<I+b;q++){if(!(q>=0&&q<this.sizeZ))continue;this.remove(Q,q,L)}}}addWall(_,R,E,b,G){let N=_-this.startX,L=R-this.startZ,H=G?65536:128,I=G?4096:8,Q=G?1024:2,q=G?16384:32,O=G?512:1,U=G?8192:16,$=G?2048:4,K=G?32768:64;if(E===h.WALL_STRAIGHT.id){if(b===0)this.add(N,L,H),this.add(N-1,L,I);else if(b===1)this.add(N,L,Q),this.add(N,L+1,q);else if(b===2)this.add(N,L,I),this.add(N+1,L,H);else if(b===3)this.add(N,L,q),this.add(N,L-1,Q)}else if(E===h.WALL_DIAGONAL_CORNER.id||E===h.WALL_SQUARE_CORNER.id){if(b===0)this.add(N,L,O),this.add(N-1,L+1,U);else if(b===1)this.add(N,L,$),this.add(N+1,L+1,K);else if(b===2)this.add(N,L,U),this.add(N+1,L-1,O);else if(b===3)this.add(N,L,K),this.add(N-1,L-1,$)}else if(E===h.WALL_L.id){if(b===0)this.add(N,L,Q|H),this.add(N-1,L,I),this.add(N,L+1,q);else if(b===1)this.add(N,L,Q|I),this.add(N,L+1,q),this.add(N+1,L,H);else if(b===2)this.add(N,L,q|I),this.add(N+1,L,H),this.add(N,L-1,Q);else if(b===3)this.add(N,L,q|H),this.add(N,L-1,Q),this.add(N-1,L,I)}if(G)this.addWall(_,R,E,b,!1)}removeWall(_,R,E,b,G){let N=_-this.startX,L=R-this.startZ,H=G?65536:128,I=G?4096:8,Q=G?1024:2,q=G?16384:32,O=G?512:1,U=G?8192:16,$=G?2048:4,K=G?32768:64;if(E===h.WALL_STRAIGHT.id){if(b===0)this.remove(N,L,H),this.remove(N-1,L,I);else if(b===1)this.remove(N,L,Q),this.remove(N,L+1,q);else if(b===2)this.remove(N,L,I),this.remove(N+1,L,H);else if(b===3)this.remove(N,L,q),this.remove(N,L-1,Q)}else if(E===h.WALL_DIAGONAL_CORNER.id||E===h.WALL_SQUARE_CORNER.id){if(b===0)this.remove(N,L,O),this.remove(N-1,L+1,U);else if(b===1)this.remove(N,L,$),this.remove(N+1,L+1,K);else if(b===2)this.remove(N,L,U),this.remove(N+1,L-1,O);else if(b===3)this.remove(N,L,K),this.remove(N-1,L-1,$)}else if(E===h.WALL_L.id){if(b===0)this.remove(N,L,Q|H),this.remove(N-1,L,I),this.remove(N,L+1,q);else if(b===1)this.remove(N,L,Q|I),this.remove(N,L+1,q),this.remove(N+1,L,H);else if(b===2)this.remove(N,L,q|I),this.remove(N+1,L,H),this.remove(N,L-1,Q);else if(b===3)this.remove(N,L,q|H),this.remove(N,L-1,Q),this.remove(N-1,L,I)}if(G)this.removeWall(_,R,E,b,!1)}reachedWall(_,R,E,b,G,N){if(_===E&&R===b)return!0;let L=_-this.startX,H=R-this.startZ,I=E-this.startX,Q=b-this.startZ,q=o.index(L,H);if(G===h.WALL_STRAIGHT.id){if(N===0){if(L===I-1&&H===Q)return!0;else if(L===I&&H===Q+1&&(this.flags[q]&2621728)===0)return!0;else if(L===I&&H===Q-1&&(this.flags[q]&2621698)===0)return!0}else if(N===1){if(L===I&&H===Q+1)return!0;else if(L===I-1&&H===Q&&(this.flags[q]&2621704)===0)return!0;else if(L===I+1&&H===Q&&(this.flags[q]&2621824)===0)return!0}else if(N===2){if(L===I+1&&H===Q)return!0;else if(L===I&&H===Q+1&&(this.flags[q]&2621728)===0)return!0;else if(L===I&&H===Q-1&&(this.flags[q]&2621698)===0)return!0}else if(N===3){if(L===I&&H===Q-1)return!0;else if(L===I-1&&H===Q&&(this.flags[q]&2621704)===0)return!0;else if(L===I+1&&H===Q&&(this.flags[q]&2621824)===0)return!0}}else if(G===h.WALL_L.id){if(N===0){if(L===I-1&&H===Q)return!0;else if(L===I&&H===Q+1)return!0;else if(L===I+1&&H===Q&&(this.flags[q]&2621824)===0)return!0;else if(L===I&&H===Q-1&&(this.flags[q]&2621698)===0)return!0}else if(N===1){if(L===I-1&&H===Q&&(this.flags[q]&2621704)===0)return!0;else if(L===I&&H===Q+1)return!0;else if(L===I+1&&H===Q)return!0;else if(L===I&&H===Q-1&&(this.flags[q]&2621698)===0)return!0}else if(N===2){if(L===I-1&&H===Q&&(this.flags[q]&2621704)===0)return!0;else if(L===I&&H===Q+1&&(this.flags[q]&2621728)===0)return!0;else if(L===I+1&&H===Q)return!0;else if(L===I&&H===Q-1)return!0}else if(N===3){if(L===I-1&&H===Q)return!0;else if(L===I&&H===Q+1&&(this.flags[q]&2621728)===0)return!0;else if(L===I+1&&H===Q&&(this.flags[q]&2621824)===0)return!0;else if(L===I&&H===Q-1)return!0}}else if(G===h.WALL_DIAGONAL.id){if(L===I&&H===Q+1&&(this.flags[q]&32)===0)return!0;else if(L===I&&H===Q-1&&(this.flags[q]&2)===0)return!0;else if(L===I-1&&H===Q&&(this.flags[q]&8)===0)return!0;else if(L===I+1&&H===Q&&(this.flags[q]&128)===0)return!0}return!1}reachedWallDecoration(_,R,E,b,G,N){if(_===E&&R===b)return!0;let L=_-this.startX,H=R-this.startZ,I=E-this.startX,Q=b-this.startZ,q=o.index(L,H);if(G===h.WALLDECOR_DIAGONAL_OFFSET.id||G===h.WALLDECOR_DIAGONAL_NOOFFSET.id){if(G===h.WALLDECOR_DIAGONAL_NOOFFSET.id)N=N+2&3;if(N===0){if(L===I+1&&H===Q&&(this.flags[q]&128)===0)return!0;else if(L===I&&H===Q-1&&(this.flags[q]&2)===0)return!0}else if(N===1){if(L===I-1&&H===Q&&(this.flags[q]&8)===0)return!0;else if(L===I&&H===Q-1&&(this.flags[q]&2)===0)return!0}else if(N===2){if(L===I-1&&H===Q&&(this.flags[q]&8)===0)return!0;else if(L===I&&H===Q+1&&(this.flags[q]&32)===0)return!0}else if(N===3){if(L===I+1&&H===Q&&(this.flags[q]&128)===0)return!0;else if(L===I&&H===Q+1&&(this.flags[q]&32)===0)return!0}}else if(G===h.WALLDECOR_DIAGONAL_BOTH.id){if(L===I&&H===Q+1&&(this.flags[q]&32)===0)return!0;else if(L===I&&H===Q-1&&(this.flags[q]&2)===0)return!0;else if(L===I-1&&H===Q&&(this.flags[q]&8)===0)return!0;else if(L===I+1&&H===Q&&(this.flags[q]&128)===0)return!0}return!1}reachedLoc(_,R,E,b,G,N,L){let H=E+G-1,I=b+N-1,Q=o.index(_-this.startX,R-this.startZ);if(_>=E&&_<=H&&R>=b&&R<=I)return!0;else if(_===E-1&&R>=b&&R<=I&&(this.flags[Q]&8)===0&&(L&8)===0)return!0;else if(_===H+1&&R>=b&&R<=I&&(this.flags[Q]&128)===0&&(L&2)===0)return!0;else if(R===b-1&&_>=E&&_<=H&&(this.flags[Q]&2)===0&&(L&4)===0)return!0;else if(R===I+1&&_>=E&&_<=H&&(this.flags[Q]&32)===0&&(L&1)===0)return!0;return!1}add(_,R,E){this.flags[o.index(_,R)]|=E}remove(_,R,E){this.flags[o.index(_,R)]&=16777215-E}}class R_{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(_,R,E,b,G,N,L,H,I,Q,q){this.minTileX=_,this.maxTileX=R,this.minTileZ=E,this.maxTileZ=b,this.type=G,this.minX=N,this.maxX=L,this.minZ=H,this.maxZ=I,this.minY=Q,this.maxY=q}}class E_{y;x;z;model;typecode;info;constructor(_,R,E,b,G,N){this.y=_,this.x=R,this.z=E,this.model=b,this.typecode=G,this.info=N}}class b_{locLevel;y;x;z;model;entity;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;typecode;info;distance=0;cycle=0;constructor(_,R,E,b,G,N,L,H,I,Q,q,O,U){this.locLevel=_,this.y=R,this.x=E,this.z=b,this.model=G,this.entity=N,this.yaw=L,this.minSceneTileX=H,this.maxSceneTileX=I,this.minSceneTileZ=Q,this.maxSceneTileZ=q,this.typecode=O,this.info=U}}class G_{y;x;z;topObj;middleObj;bottomObj;typecode;offset;constructor(_,R,E,b,G,N,L,H){this.y=_,this.x=R,this.z=E,this.topObj=b,this.middleObj=G,this.bottomObj=N,this.typecode=L,this.offset=H}}class Z0 extends F0{groundLevel;x;z;occludeLevel;locs;locSpan;underlay=null;overlay=null;wall=null;wallDecoration=null;groundDecoration=null;objStack=null;bridge=null;locCount=0;locSpans=0;drawLevel=0;groundVisible=!1;update=!1;containsLocs=!1;checkLocSpans=0;blockLocSpans=0;inverseBlockLocSpans=0;backWallTypes=0;constructor(_,R,E){super();this.occludeLevel=this.groundLevel=_,this.x=R,this.z=E,this.locs=new C(5,null),this.locSpan=new Int32Array(5)}}class y{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=this.FULL_SQUARE*3/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;shapeAngle;backgroundRgb;foregroundRgb;constructor(_,R,E,b,G,N,L,H,I,Q,q,O,U,$,K,u,F,k,j){this.flat=!(F!==b||F!==$||F!==H),this.shape=R,this.shapeAngle=N,this.backgroundRgb=U,this.foregroundRgb=I;let m=y.SHAPE_POINTS[R],Y=m.length;this.vertexX=new Int32Array(Y),this.vertexY=new Int32Array(Y),this.vertexZ=new Int32Array(Y);let X=new Int32Array(Y),B=new Int32Array(Y),z=_*y.FULL_SQUARE,Z=k*y.FULL_SQUARE;for(let A=0;A<Y;A++){let W=m[A];if((W&1)===0&&W<=8)W=(W-N-N-1&7)+1;if(W>8&&W<=12)W=(W-N-9&3)+9;if(W>12&&W<=16)W=(W-N-13&3)+13;let v,n,D,i,x;if(W===1)v=z,n=Z,D=F,i=L,x=Q;else if(W===2)v=z+y.HALF_SQUARE,n=Z,D=F+b>>1,i=L+j>>1,x=Q+E>>1;else if(W===3)v=z+y.FULL_SQUARE,n=Z,D=b,i=j,x=E;else if(W===4)v=z+y.FULL_SQUARE,n=Z+y.HALF_SQUARE,D=b+$>>1,i=j+G>>1,x=E+K>>1;else if(W===5)v=z+y.FULL_SQUARE,n=Z+y.FULL_SQUARE,D=$,i=G,x=K;else if(W===6)v=z+y.HALF_SQUARE,n=Z+y.FULL_SQUARE,D=$+H>>1,i=G+u>>1,x=K+O>>1;else if(W===7)v=z,n=Z+y.FULL_SQUARE,D=H,i=u,x=O;else if(W===8)v=z,n=Z+y.HALF_SQUARE,D=H+F>>1,i=u+L>>1,x=O+Q>>1;else if(W===9)v=z+y.HALF_SQUARE,n=Z+y.CORNER_SMALL,D=F+b>>1,i=L+j>>1,x=Q+E>>1;else if(W===10)v=z+y.CORNER_BIG,n=Z+y.HALF_SQUARE,D=b+$>>1,i=j+G>>1,x=E+K>>1;else if(W===11)v=z+y.HALF_SQUARE,n=Z+y.CORNER_BIG,D=$+H>>1,i=G+u>>1,x=K+O>>1;else if(W===12)v=z+y.CORNER_SMALL,n=Z+y.HALF_SQUARE,D=H+F>>1,i=u+L>>1,x=O+Q>>1;else if(W===13)v=z+y.CORNER_SMALL,n=Z+y.CORNER_SMALL,D=F,i=L,x=Q;else if(W===14)v=z+y.CORNER_BIG,n=Z+y.CORNER_SMALL,D=b,i=j,x=E;else if(W===15)v=z+y.CORNER_BIG,n=Z+y.CORNER_BIG,D=$,i=G,x=K;else v=z+y.CORNER_SMALL,n=Z+y.CORNER_BIG,D=H,i=u,x=O;this.vertexX[A]=v,this.vertexY[A]=D,this.vertexZ[A]=n,X[A]=i,B[A]=x}let g=y.SHAPE_PATHS[R],M=g.length/4|0;if(this.triangleVertexA=new Int32Array(M),this.triangleVertexB=new Int32Array(M),this.triangleVertexC=new Int32Array(M),this.triangleColorA=new Int32Array(M),this.triangleColorB=new Int32Array(M),this.triangleColorC=new Int32Array(M),q!==-1)this.triangleTextureIds=new Int32Array(M);else this.triangleTextureIds=null;let S=0;for(let A=0;A<M;A++){let W=g[S],v=g[S+1],n=g[S+2],D=g[S+3];if(S+=4,v<4)v=v-N&3;if(n<4)n=n-N&3;if(D<4)D=D-N&3;if(this.triangleVertexA[A]=v,this.triangleVertexB[A]=n,this.triangleVertexC[A]=D,W===0){if(this.triangleColorA[A]=X[v],this.triangleColorB[A]=X[n],this.triangleColorC[A]=X[D],this.triangleTextureIds)this.triangleTextureIds[A]=-1}else if(this.triangleColorA[A]=B[v],this.triangleColorB[A]=B[n],this.triangleColorC[A]=B[D],this.triangleTextureIds)this.triangleTextureIds[A]=q}}}class p0{southwestColor;southeastColor;northeastColor;northwestColor;textureId;colour;flat;constructor(_,R,E,b,G,N,L){this.southwestColor=_,this.southeastColor=R,this.northeastColor=E,this.northwestColor=b,this.textureId=G,this.colour=N,this.flat=L}}class N_{y;x;z;typeA;typeB;modelA;modelB;typecode;info;constructor(_,R,E,b,G,N,L,H,I){this.y=_,this.x=R,this.z=E,this.typeA=b,this.typeB=G,this.modelA=N,this.modelB=L,this.typecode=H,this.info=I}}class L_{y;x;z;decorType;decorAngle;model;typecode;info;constructor(_,R,E,b,G,N,L,H){this.y=_,this.x=R,this.z=E,this.decorType=b,this.decorAngle=G,this.model=N,this.typecode=L,this.info=H}}class V{static visibilityMatrix=new d0(8,32,51,51,!1);static locBuffer=new C(100,null);static levelOccluderCount=new Int32Array(4);static levelOccluders=new F_(4,500,null);static activeOccluders=new C(500,null);static drawTileQueue=new m0;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=!1;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS=Int8Array.of(0,0,2,0,0,2,1,1,0);static WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS=Int8Array.of(2,0,0,2,0,0,0,4,4);static WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS=Int8Array.of(0,4,4,8,0,0,8,0,0);static WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=!0;static init(_,R,E,b,G){this.viewportLeft=0,this.viewportTop=0,this.viewportRight=_,this.viewportBottom=R,this.viewportCenterX=_/2|0,this.viewportCenterY=R/2|0;let N=new d0(9,32,53,53,!1);for(let L=128;L<=384;L+=32)for(let H=0;H<2048;H+=64){this.sinEyePitch=w.sin[L],this.cosEyePitch=w.cos[L],this.sinEyeYaw=w.sin[H],this.cosEyeYaw=w.cos[H];let I=(L-128)/32|0,Q=H/64|0;for(let q=-26;q<=26;q++)for(let O=-26;O<=26;O++){let U=q*128,$=O*128,K=!1;for(let u=-E;u<=b;u+=128)if(this.testPoint(U,$,G[I]+u)){K=!0;break}N[I][Q][q+25+1][O+25+1]=K}}for(let L=0;L<8;L++)for(let H=0;H<32;H++)for(let I=-25;I<25;I++)for(let Q=-25;Q<25;Q++){let q=!1;_:for(let O=-1;O<=1;O++)for(let U=-1;U<=1;U++){if(N[L][H][I+O+25+1][Q+U+25+1]){q=!0;break _}if(N[L][(H+1)%31][I+O+25+1][Q+U+25+1]){q=!0;break _}if(N[L+1][H][I+O+25+1][Q+U+25+1]){q=!0;break _}if(N[L+1][(H+1)%31][I+O+25+1][Q+U+25+1]){q=!0;break _}}this.visibilityMatrix[L][H][I+25][Q+25]=q}}static addOccluder(_,R,E,b,G,N,L,H){V.levelOccluders[_][V.levelOccluderCount[_]++]=new R_(E/128|0,N/128|0,G/128|0,H/128|0,R,E,N,G,H,b,L)}static testPoint(_,R,E){let b=R*this.sinEyeYaw+_*this.cosEyeYaw>>16,G=R*this.cosEyeYaw-_*this.sinEyeYaw>>16,N=E*this.sinEyePitch+G*this.cosEyePitch>>16,L=E*this.cosEyePitch-G*this.sinEyePitch>>16;if(N<50||N>3500)return!1;let H=this.viewportCenterX+((b<<9)/N|0),I=this.viewportCenterY+((L<<9)/N|0);return H>=this.viewportLeft&&H<=this.viewportRight&&I>=this.viewportTop&&I<=this.viewportBottom}maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;temporaryLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;temporaryLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(_,R,E,b){this.maxLevel=E,this.maxTileX=b,this.maxTileZ=R,this.levelTiles=new C0(E,b,R,null),this.levelTileOcclusionCycles=new h0(E,b+1,R+1),this.levelHeightmaps=_,this.temporaryLocs=new C(5000,null),this.mergeIndexA=new Int32Array(1e4),this.mergeIndexB=new Int32Array(1e4),this.reset()}reset(){for(let _=0;_<this.maxLevel;_++)for(let R=0;R<this.maxTileX;R++)for(let E=0;E<this.maxTileZ;E++)this.levelTiles[_][R][E]=null;for(let _=0;_<4;_++){for(let R=0;R<V.levelOccluderCount[_];R++)V.levelOccluders[_][R]=null;V.levelOccluderCount[_]=0}for(let _=0;_<this.temporaryLocCount;_++)this.temporaryLocs[_]=null;this.temporaryLocCount=0,V.locBuffer.fill(null)}setMinLevel(_){this.minLevel=_;for(let R=0;R<this.maxTileX;R++)for(let E=0;E<this.maxTileZ;E++)this.levelTiles[_][R][E]=new Z0(_,R,E)}setBridge(_,R){let E=this.levelTiles[0][_][R];for(let G=0;G<3;G++){this.levelTiles[G][_][R]=this.levelTiles[G+1][_][R];let N=this.levelTiles[G][_][R];if(N)N.groundLevel--}if(!this.levelTiles[0][_][R])this.levelTiles[0][_][R]=new Z0(0,_,R);let b=this.levelTiles[0][_][R];if(b)b.bridge=E;this.levelTiles[3][_][R]=null}setDrawLevel(_,R,E,b){let G=this.levelTiles[_][R][E];if(!G)return;G.drawLevel=b}setTile(_,R,E,b,G,N,L,H,I,Q,q,O,U,$,K,u,F,k,j,m){if(b===0){for(let X=_;X>=0;X--)if(!this.levelTiles[X][R][E])this.levelTiles[X][R][E]=new Z0(X,R,E);let Y=this.levelTiles[_][R][E];if(Y)Y.underlay=new p0(q,O,U,$,-1,j,!1)}else if(b===1){for(let X=_;X>=0;X--)if(!this.levelTiles[X][R][E])this.levelTiles[X][R][E]=new Z0(X,R,E);let Y=this.levelTiles[_][R][E];if(Y)Y.underlay=new p0(K,u,F,k,N,m,L===H&&L===I&&L===Q)}else{for(let X=_;X>=0;X--)if(!this.levelTiles[X][R][E])this.levelTiles[X][R][E]=new Z0(X,R,E);let Y=this.levelTiles[_][R][E];if(Y)Y.overlay=new y(R,b,u,H,U,G,q,Q,m,K,N,k,j,I,F,$,L,E,O)}}addGroundDecoration(_,R,E,b,G,N,L){if(!this.levelTiles[R][E][b])this.levelTiles[R][E][b]=new Z0(R,E,b);let H=this.levelTiles[R][E][b];if(H)H.groundDecoration=new E_(G,E*128+64,b*128+64,_,N,L)}removeGroundDecoration(_,R,E){let b=this.levelTiles[_][R][E];if(!b)return;b.groundDecoration=null}addObjStack(_,R,E,b,G,N,L,H){let I=0,Q=this.levelTiles[b][_][R];if(Q)for(let O=0;O<Q.locCount;O++){let U=Q.locs[O];if(!U||!U.model)continue;let $=U.model.objRaise;if($>I)I=$}else this.levelTiles[b][_][R]=new Z0(b,_,R);let q=this.levelTiles[b][_][R];if(q)q.objStack=new G_(E,_*128+64,R*128+64,N,L,H,G,I)}removeObjStack(_,R,E){let b=this.levelTiles[_][R][E];if(!b)return;b.objStack=null}addWall(_,R,E,b,G,N,L,H,I,Q){if(!L&&!H)return;for(let O=_;O>=0;O--)if(!this.levelTiles[O][R][E])this.levelTiles[O][R][E]=new Z0(O,R,E);let q=this.levelTiles[_][R][E];if(q)q.wall=new N_(b,R*128+64,E*128+64,G,N,L,H,I,Q)}removeWall(_,R,E,b){let G=this.levelTiles[_][R][E];if(b===1&&G)G.wall=null}setWallDecoration(_,R,E,b,G,N,L,H,I,Q,q){if(!H)return;for(let U=_;U>=0;U--)if(!this.levelTiles[U][R][E])this.levelTiles[U][R][E]=new Z0(U,R,E);let O=this.levelTiles[_][R][E];if(O)O.wallDecoration=new L_(b,R*128+G+64,E*128+N+64,q,Q,H,L,I)}removeWallDecoration(_,R,E){let b=this.levelTiles[_][R][E];if(!b)return;b.wallDecoration=null}setWallDecorationOffset(_,R,E,b){let G=this.levelTiles[_][R][E];if(!G)return;let N=G.wallDecoration;if(!N)return;let L=R*128+64,H=E*128+64;N.x=L+((N.x-L)*b/16|0),N.z=H+((N.z-H)*b/16|0)}setWallDecorationModel(_,R,E,b){if(!b)return;let G=this.levelTiles[_][R][E];if(!G)return;let N=G.wallDecoration;if(!N)return;N.model=b}setGroundDecorationModel(_,R,E,b){if(!b)return;let G=this.levelTiles[_][R][E];if(!G)return;let N=G.groundDecoration;if(!N)return;N.model=b}setWallModel(_,R,E,b){if(!b)return;let G=this.levelTiles[_][R][E];if(!G)return;let N=G.wall;if(!N)return;N.modelA=b}setWallModels(_,R,E,b,G){if(!b)return;let N=this.levelTiles[E][_][R];if(!N)return;let L=N.wall;if(!L)return;L.modelA=b,L.modelB=G}addLoc(_,R,E,b,G,N,L,H,I,Q,q){if(!G&&!N)return!0;let O=R*128+I*64,U=E*128+Q*64;return this.addLoc2(O,U,b,_,R,E,I,Q,G,N,L,H,q,!1)}addTemporary(_,R,E,b,G,N,L,H,I,Q){if(!G&&!N)return!0;let q=R-I,O=b-I,U=R+I,$=b+I;if(Q){if(H>640&&H<1408)$+=128;if(H>1152&&H<1920)U+=128;if(H>1664||H<384)O-=128;if(H>128&&H<896)q-=128}return q=q/128|0,O=O/128|0,U=U/128|0,$=$/128|0,this.addLoc2(R,b,E,_,q,O,U+1-q,$-O+1,G,N,L,0,H,!0)}addTemporary2(_,R,E,b,G,N,L,H,I,Q,q,O){return!I&&!Q||this.addLoc2(R,b,E,_,G,N,L+1-G,H-N+1,I,Q,q,0,O,!0)}removeLoc(_,R,E){let b=this.levelTiles[_][R][E];if(!b)return;for(let G=0;G<b.locCount;G++){let N=b.locs[G];if(N&&(N.typecode>>29&3)===2&&N.minSceneTileX===R&&N.minSceneTileZ===E){this.removeLoc2(N);return}}}setLocModel(_,R,E,b){if(!b)return;let G=this.levelTiles[_][R][E];if(!G)return;for(let N=0;N<G.locCount;N++){let L=G.locs[N];if(L&&(L.typecode>>29&3)===2){L.model=b;return}}}clearTemporaryLocs(){for(let _=0;_<this.temporaryLocCount;_++){let R=this.temporaryLocs[_];if(R)this.removeLoc2(R);this.temporaryLocs[_]=null}this.temporaryLocCount=0}getWallTypecode(_,R,E){let b=this.levelTiles[_][R][E];return!b||!b.wall?0:b.wall.typecode}getDecorTypecode(_,R,E){let b=this.levelTiles[_][E][R];return!b||!b.wallDecoration?0:b.wallDecoration.typecode}getLocTypecode(_,R,E){let b=this.levelTiles[_][R][E];if(!b)return 0;for(let G=0;G<b.locCount;G++){let N=b.locs[G];if(N&&(N.typecode>>29&3)===2&&N.minSceneTileX===R&&N.minSceneTileZ===E)return N.typecode}return 0}getGroundDecorTypecode(_,R,E){let b=this.levelTiles[_][R][E];return!b||!b.groundDecoration?0:b.groundDecoration.typecode}getInfo(_,R,E,b){let G=this.levelTiles[_][R][E];if(!G)return-1;else if(G.wall&&G.wall.typecode===b)return G.wall.info&255;else if(G.wallDecoration&&G.wallDecoration.typecode===b)return G.wallDecoration.info&255;else if(G.groundDecoration&&G.groundDecoration.typecode===b)return G.groundDecoration.info&255;else{for(let N=0;N<G.locCount;N++){let L=G.locs[N];if(L&&L.typecode===b)return L.info&255}return-1}}buildModels(_,R,E,b,G){let N=Math.sqrt(E*E+b*b+G*G)|0,L=R*N>>8;for(let H=0;H<this.maxLevel;H++)for(let I=0;I<this.maxTileX;I++)for(let Q=0;Q<this.maxTileZ;Q++){let q=this.levelTiles[H][I][Q];if(!q)continue;let O=q.wall;if(O&&O.modelA&&O.modelA.vertexNormal){if(this.mergeLocNormals(H,I,Q,1,1,O.modelA),O.modelB&&O.modelB.vertexNormal)this.mergeLocNormals(H,I,Q,1,1,O.modelB),this.mergeNormals(O.modelA,O.modelB,0,0,0,!1),O.modelB.applyLighting(_,L,E,b,G);O.modelA.applyLighting(_,L,E,b,G)}for(let $=0;$<q.locCount;$++){let K=q.locs[$];if(K&&K.model&&K.model.vertexNormal)this.mergeLocNormals(H,I,Q,K.maxSceneTileX+1-K.minSceneTileX,K.maxSceneTileZ-K.minSceneTileZ+1,K.model),K.model.applyLighting(_,L,E,b,G)}let U=q.groundDecoration;if(U&&U.model&&U.model.vertexNormal)this.mergeGroundDecorationNormals(H,I,Q,U.model),U.model.applyLighting(_,L,E,b,G)}}mergeGroundDecorationNormals(_,R,E,b){if(R<this.maxTileX){let G=this.levelTiles[_][R+1][E];if(G&&G.groundDecoration&&G.groundDecoration.model&&G.groundDecoration.model.vertexNormal)this.mergeNormals(b,G.groundDecoration.model,128,0,0,!0)}if(E<this.maxTileX){let G=this.levelTiles[_][R][E+1];if(G&&G.groundDecoration&&G.groundDecoration.model&&G.groundDecoration.model.vertexNormal)this.mergeNormals(b,G.groundDecoration.model,0,0,128,!0)}if(R<this.maxTileX&&E<this.maxTileZ){let G=this.levelTiles[_][R+1][E+1];if(G&&G.groundDecoration&&G.groundDecoration.model&&G.groundDecoration.model.vertexNormal)this.mergeNormals(b,G.groundDecoration.model,128,0,128,!0)}if(R<this.maxTileX&&E>0){let G=this.levelTiles[_][R+1][E-1];if(G&&G.groundDecoration&&G.groundDecoration.model&&G.groundDecoration.model.vertexNormal)this.mergeNormals(b,G.groundDecoration.model,128,0,-128,!0)}}mergeLocNormals(_,R,E,b,G,N){let L=!0,H=R,I=R+b,Q=E-1,q=E+G;for(let O=_;O<=_+1;O++){if(O===this.maxLevel)continue;for(let U=H;U<=I;U++){if(U<0||U>=this.maxTileX)continue;for(let $=Q;$<=q;$++){if($<0||$>=this.maxTileZ||L&&U<I&&$<q&&($>=E||U===R))continue;let K=this.levelTiles[O][U][$];if(!K)continue;let u=(U-R)*128+(1-b)*64,F=($-E)*128+(1-G)*64,k=((this.levelHeightmaps[O][U][$]+this.levelHeightmaps[O][U+1][$]+this.levelHeightmaps[O][U][$+1]+this.levelHeightmaps[O][U+1][$+1])/4|0)-((this.levelHeightmaps[_][R][E]+this.levelHeightmaps[_][R+1][E]+this.levelHeightmaps[_][R][E+1]+this.levelHeightmaps[_][R+1][E+1])/4|0),j=K.wall;if(j&&j.modelA&&j.modelA.vertexNormal)this.mergeNormals(N,j.modelA,u,k,F,L);if(j&&j.modelB&&j.modelB.vertexNormal)this.mergeNormals(N,j.modelB,u,k,F,L);for(let m=0;m<K.locCount;m++){let Y=K.locs[m];if(!Y||!Y.model||!Y.model.vertexNormal)continue;let X=Y.maxSceneTileX+1-Y.minSceneTileX,B=Y.maxSceneTileZ+1-Y.minSceneTileZ;this.mergeNormals(N,Y.model,(Y.minSceneTileX-R)*128+(X-b)*64,k,(Y.minSceneTileZ-E)*128+(B-G)*64,L)}}}H--,L=!1}}mergeNormals(_,R,E,b,G,N){this.tmpMergeIndex++;let L=0,H=R.vertexX,I=R.vertexCount;if(_.vertexNormal&&_.vertexNormalOriginal)for(let Q=0;Q<_.vertexCount;Q++){let q=_.vertexNormal[Q],O=_.vertexNormalOriginal[Q];if(O&&O.w!==0){let U=_.vertexY[Q]-b;if(U>R.minY)continue;let $=_.vertexX[Q]-E;if($<R.minX||$>R.maxX)continue;let K=_.vertexZ[Q]-G;if(K<R.minZ||K>R.maxZ)continue;if(R.vertexNormal&&R.vertexNormalOriginal)for(let u=0;u<I;u++){let F=R.vertexNormal[u],k=R.vertexNormalOriginal[u];if($!==H[u]||K!==R.vertexZ[u]||U!==R.vertexY[u]||k&&k.w===0)continue;if(q&&F&&k)q.x+=k.x,q.y+=k.y,q.z+=k.z,q.w+=k.w,F.x+=O.x,F.y+=O.y,F.z+=O.z,F.w+=O.w,L++;this.mergeIndexA[Q]=this.tmpMergeIndex,this.mergeIndexB[u]=this.tmpMergeIndex}}}if(L<3||!N)return;if(_.faceInfo){for(let Q=0;Q<_.faceCount;Q++)if(this.mergeIndexA[_.faceVertexA[Q]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexB[Q]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexC[Q]]===this.tmpMergeIndex)_.faceInfo[Q]=-1}if(R.faceInfo){for(let Q=0;Q<R.faceCount;Q++)if(this.mergeIndexB[R.faceVertexA[Q]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexB[Q]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexC[Q]]===this.tmpMergeIndex)R.faceInfo[Q]=-1}}drawMinimapTile(_,R,E,b,G,N){let L=this.levelTiles[_][R][E];if(!L)return;let H=L.underlay;if(H){let F=H.colour;if(F!==0)for(let k=0;k<4;k++)b[G]=F,b[G+1]=F,b[G+2]=F,b[G+3]=F,G+=N;return}let I=L.overlay;if(!I)return;let{shape:Q,shapeAngle:q,backgroundRgb:O,foregroundRgb:U}=I,$=V.MINIMAP_TILE_MASK[Q],K=V.MINIMAP_TILE_ROTATION_MAP[q],u=0;if(O!==0){for(let F=0;F<4;F++)b[G]=$[K[u++]]===0?O:U,b[G+1]=$[K[u++]]===0?O:U,b[G+2]=$[K[u++]]===0?O:U,b[G+3]=$[K[u++]]===0?O:U,G+=N;return}for(let F=0;F<4;F++){if($[K[u++]]!==0)b[G]=U;if($[K[u++]]!==0)b[G+1]=U;if($[K[u++]]!==0)b[G+2]=U;if($[K[u++]]!==0)b[G+3]=U;G+=N}}click(_,R){V.takingInput=!0,V.mouseX=_,V.mouseY=R,V.clickTileX=-1,V.clickTileZ=-1}draw(_,R,E,b,G,N,L){if(_<0)_=0;else if(_>=this.maxTileX*128)_=this.maxTileX*128-1;if(E<0)E=0;else if(E>=this.maxTileZ*128)E=this.maxTileZ*128-1;if(V.cycle++,V.sinEyePitch=w.sin[N],V.cosEyePitch=w.cos[N],V.sinEyeYaw=w.sin[G],V.cosEyeYaw=w.cos[G],V.visibilityMap=V.visibilityMatrix[(N-128)/32|0][G/64|0],V.eyeX=_,V.eyeY=R,V.eyeZ=E,V.eyeTileX=_/128|0,V.eyeTileZ=E/128|0,V.topLevel=b,V.minDrawTileX=V.eyeTileX-25,V.minDrawTileX<0)V.minDrawTileX=0;if(V.minDrawTileZ=V.eyeTileZ-25,V.minDrawTileZ<0)V.minDrawTileZ=0;if(V.maxDrawTileX=V.eyeTileX+25,V.maxDrawTileX>this.maxTileX)V.maxDrawTileX=this.maxTileX;if(V.maxDrawTileZ=V.eyeTileZ+25,V.maxDrawTileZ>this.maxTileZ)V.maxDrawTileZ=this.maxTileZ;this.updateActiveOccluders(),V.tilesRemaining=0;for(let H=this.minLevel;H<this.maxLevel;H++){let I=this.levelTiles[H];for(let Q=V.minDrawTileX;Q<V.maxDrawTileX;Q++)for(let q=V.minDrawTileZ;q<V.maxDrawTileZ;q++){let O=I[Q][q];if(!O)continue;if(O.drawLevel<=b&&(V.visibilityMap[Q+25-V.eyeTileX][q+25-V.eyeTileZ]||this.levelHeightmaps[H][Q][q]-R>=2000))O.groundVisible=!0,O.update=!0,O.containsLocs=O.locCount>0,V.tilesRemaining++;else O.groundVisible=!1,O.update=!1,O.checkLocSpans=0}}for(let H=this.minLevel;H<this.maxLevel;H++){let I=this.levelTiles[H];for(let Q=-25;Q<=0;Q++){let q=V.eyeTileX+Q,O=V.eyeTileX-Q;if(q<V.minDrawTileX&&O>=V.maxDrawTileX)continue;for(let U=-25;U<=0;U++){let $=V.eyeTileZ+U,K=V.eyeTileZ-U,u;if(q>=V.minDrawTileX){if($>=V.minDrawTileZ){if(u=I[q][$],u&&u.groundVisible)this.drawTile(u,!0,L)}if(K<V.maxDrawTileZ){if(u=I[q][K],u&&u.groundVisible)this.drawTile(u,!0,L)}}if(O<V.maxDrawTileX){if($>=V.minDrawTileZ){if(u=I[O][$],u&&u.groundVisible)this.drawTile(u,!0,L)}if(K<V.maxDrawTileZ){if(u=I[O][K],u&&u.groundVisible)this.drawTile(u,!0,L)}}if(V.tilesRemaining===0){V.takingInput=!1;return}}}}for(let H=this.minLevel;H<this.maxLevel;H++){let I=this.levelTiles[H];for(let Q=-25;Q<=0;Q++){let q=V.eyeTileX+Q,O=V.eyeTileX-Q;if(q<V.minDrawTileX&&O>=V.maxDrawTileX)continue;for(let U=-25;U<=0;U++){let $=V.eyeTileZ+U,K=V.eyeTileZ-U,u;if(q>=V.minDrawTileX){if($>=V.minDrawTileZ){if(u=I[q][$],u&&u.groundVisible)this.drawTile(u,!1,L)}if(K<V.maxDrawTileZ){if(u=I[q][K],u&&u.groundVisible)this.drawTile(u,!1,L)}}if(O<V.maxDrawTileX){if($>=V.minDrawTileZ){if(u=I[O][$],u&&u.groundVisible)this.drawTile(u,!1,L)}if(K<V.maxDrawTileZ){if(u=I[O][K],u&&u.groundVisible)this.drawTile(u,!1,L)}}if(V.tilesRemaining===0){V.takingInput=!1;return}}}}}addLoc2(_,R,E,b,G,N,L,H,I,Q,q,O,U,$){if(!I&&!Q)return!1;for(let u=G;u<G+L;u++)for(let F=N;F<N+H;F++){if(u<0||F<0||u>=this.maxTileX||F>=this.maxTileZ)return!1;let k=this.levelTiles[b][u][F];if(k&&k.locCount>=5)return!1}let K=new b_(b,E,_,R,I,Q,U,G,G+L-1,N,N+H-1,q,O);for(let u=G;u<G+L;u++)for(let F=N;F<N+H;F++){let k=0;if(u>G)k|=1;if(u<G+L-1)k+=4;if(F>N)k+=8;if(F<N+H-1)k+=2;for(let m=b;m>=0;m--)if(!this.levelTiles[m][u][F])this.levelTiles[m][u][F]=new Z0(m,u,F);let j=this.levelTiles[b][u][F];if(j)j.locs[j.locCount]=K,j.locSpan[j.locCount]=k,j.locSpans|=k,j.locCount++}if($)this.temporaryLocs[this.temporaryLocCount++]=K;return!0}removeLoc2(_){for(let R=_.minSceneTileX;R<=_.maxSceneTileX;R++)for(let E=_.minSceneTileZ;E<=_.maxSceneTileZ;E++){let b=this.levelTiles[_.locLevel][R][E];if(!b)continue;for(let G=0;G<b.locCount;G++)if(b.locs[G]===_){b.locCount--;for(let N=G;N<b.locCount;N++)b.locs[N]=b.locs[N+1],b.locSpan[N]=b.locSpan[N+1];b.locs[b.locCount]=null;break}b.locSpans=0;for(let G=0;G<b.locCount;G++)b.locSpans|=b.locSpan[G]}}updateActiveOccluders(){let _=V.levelOccluderCount[V.topLevel],R=V.levelOccluders[V.topLevel];V.activeOccluderCount=0;for(let E=0;E<_;E++){let b=R[E];if(!b)continue;let G,N,L,H;if(b.type===1){if(G=b.minTileX+25-V.eyeTileX,G>=0&&G<=50){if(N=b.minTileZ+25-V.eyeTileZ,N<0)N=0;if(L=b.maxTileZ+25-V.eyeTileZ,L>50)L=50;let I=!1;while(N<=L)if(V.visibilityMap&&V.visibilityMap[G][N++]){I=!0;break}if(I){if(H=V.eyeX-b.minX,H>32)b.mode=1;else{if(H>=-32)continue;b.mode=2,H=-H}b.minDeltaZ=(b.minZ-V.eyeZ<<8)/H|0,b.maxDeltaZ=(b.maxZ-V.eyeZ<<8)/H|0,b.minDeltaY=(b.minY-V.eyeY<<8)/H|0,b.maxDeltaY=(b.maxY-V.eyeY<<8)/H|0,V.activeOccluders[V.activeOccluderCount++]=b}}}else if(b.type===2){if(G=b.minTileZ+25-V.eyeTileZ,G>=0&&G<=50){if(N=b.minTileX+25-V.eyeTileX,N<0)N=0;if(L=b.maxTileX+25-V.eyeTileX,L>50)L=50;let I=!1;while(N<=L)if(V.visibilityMap&&V.visibilityMap[N++][G]){I=!0;break}if(I){if(H=V.eyeZ-b.minZ,H>32)b.mode=3;else{if(H>=-32)continue;b.mode=4,H=-H}b.minDeltaX=(b.minX-V.eyeX<<8)/H|0,b.maxDeltaX=(b.maxX-V.eyeX<<8)/H|0,b.minDeltaY=(b.minY-V.eyeY<<8)/H|0,b.maxDeltaY=(b.maxY-V.eyeY<<8)/H|0,V.activeOccluders[V.activeOccluderCount++]=b}}}else if(b.type===4){if(G=b.minY-V.eyeY,G>128){if(N=b.minTileZ+25-V.eyeTileZ,N<0)N=0;if(L=b.maxTileZ+25-V.eyeTileZ,L>50)L=50;if(N<=L){let I=b.minTileX+25-V.eyeTileX;if(I<0)I=0;if(H=b.maxTileX+25-V.eyeTileX,H>50)H=50;let Q=!1;_:for(let q=I;q<=H;q++)for(let O=N;O<=L;O++)if(V.visibilityMap&&V.visibilityMap[q][O]){Q=!0;break _}if(Q)b.mode=5,b.minDeltaX=(b.minX-V.eyeX<<8)/G|0,b.maxDeltaX=(b.maxX-V.eyeX<<8)/G|0,b.minDeltaZ=(b.minZ-V.eyeZ<<8)/G|0,b.maxDeltaZ=(b.maxZ-V.eyeZ<<8)/G|0,V.activeOccluders[V.activeOccluderCount++]=b}}}}}drawTile(_,R,E){V.drawTileQueue.addTail(_);while(!0){let b;do if(b=V.drawTileQueue.removeHead(),!b)return;while(!b.update);let{x:G,z:N,groundLevel:L,occludeLevel:H}=b,I=this.levelTiles[L];if(b.groundVisible){if(R){if(L>0){let F=this.levelTiles[L-1][G][N];if(F&&F.update)continue}if(G<=V.eyeTileX&&G>V.minDrawTileX){let F=I[G-1][N];if(F&&F.update&&(F.groundVisible||(b.locSpans&1)===0))continue}if(G>=V.eyeTileX&&G<V.maxDrawTileX-1){let F=I[G+1][N];if(F&&F.update&&(F.groundVisible||(b.locSpans&4)===0))continue}if(N<=V.eyeTileZ&&N>V.minDrawTileZ){let F=I[G][N-1];if(F&&F.update&&(F.groundVisible||(b.locSpans&8)===0))continue}if(N>=V.eyeTileZ&&N<V.maxDrawTileZ-1){let F=I[G][N+1];if(F&&F.update&&(F.groundVisible||(b.locSpans&2)===0))continue}}else R=!0;if(b.groundVisible=!1,b.bridge){let F=b.bridge;if(!F.underlay){if(F.overlay&&!this.tileVisible(0,G,N))this.drawTileOverlay(G,N,F.overlay,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}else if(!this.tileVisible(0,G,N))this.drawTileUnderlay(F.underlay,0,G,N,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw);let k=F.wall;if(k)k.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,k.x-V.eyeX,k.y-V.eyeY,k.z-V.eyeZ,k.typecode);for(let j=0;j<F.locCount;j++){let m=F.locs[j];if(m){let Y=m.model;if(!Y)Y=m.entity?.draw(E)??null;Y?.draw(m.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,m.x-V.eyeX,m.y-V.eyeY,m.z-V.eyeZ,m.typecode)}}}let q=!1;if(!b.underlay){if(b.overlay&&!this.tileVisible(H,G,N))q=!0,this.drawTileOverlay(G,N,b.overlay,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}else if(!this.tileVisible(H,G,N))q=!0,this.drawTileUnderlay(b.underlay,H,G,N,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw);let O=0,U=0,$=b.wall,K=b.wallDecoration;if($||K){if(V.eyeTileX===G)O+=1;else if(V.eyeTileX<G)O+=2;if(V.eyeTileZ===N)O+=3;else if(V.eyeTileZ>N)O+=6;U=V.FRONT_WALL_TYPES[O],b.backWallTypes=V.BACK_WALL_TYPES[O]}if($){if(($.typeA&V.DIRECTION_ALLOW_WALL_CORNER_TYPE[O])===0)b.checkLocSpans=0;else if($.typeA===16)b.checkLocSpans=3,b.blockLocSpans=V.WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS[O],b.inverseBlockLocSpans=3-b.blockLocSpans;else if($.typeA===32)b.checkLocSpans=6,b.blockLocSpans=V.WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS[O],b.inverseBlockLocSpans=6-b.blockLocSpans;else if($.typeA===64)b.checkLocSpans=12,b.blockLocSpans=V.WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS[O],b.inverseBlockLocSpans=12-b.blockLocSpans;else b.checkLocSpans=9,b.blockLocSpans=V.WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS[O],b.inverseBlockLocSpans=9-b.blockLocSpans;if(($.typeA&U)!==0&&!this.wallVisible(H,G,N,$.typeA))$.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,$.x-V.eyeX,$.y-V.eyeY,$.z-V.eyeZ,$.typecode);if(($.typeB&U)!==0&&!this.wallVisible(H,G,N,$.typeB))$.modelB?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,$.x-V.eyeX,$.y-V.eyeY,$.z-V.eyeZ,$.typecode)}if(K&&!this.visible(H,G,N,K.model.maxY)){if((K.decorType&U)!==0)K.model.draw(K.decorAngle,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,K.x-V.eyeX,K.y-V.eyeY,K.z-V.eyeZ,K.typecode);else if((K.decorType&768)!==0){let F=K.x-V.eyeX,k=K.y-V.eyeY,j=K.z-V.eyeZ,m=K.decorAngle,Y;if(m===1||m===2)Y=-F;else Y=F;let X;if(m===2||m===3)X=-j;else X=j;if((K.decorType&256)!==0&&X<Y){let B=F+V.WALL_DECORATION_INSET_X[m],z=j+V.WALL_DECORATION_INSET_Z[m];K.model.draw(m*512+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,B,k,z,K.typecode)}if((K.decorType&512)!==0&&X>Y){let B=F+V.WALL_DECORATION_OUTSET_X[m],z=j+V.WALL_DECORATION_OUTSET_Z[m];K.model.draw(m*512+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,B,k,z,K.typecode)}}}if(q){let F=b.groundDecoration;if(F)F.model?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,F.x-V.eyeX,F.y-V.eyeY,F.z-V.eyeZ,F.typecode);let k=b.objStack;if(k&&k.offset===0){if(k.bottomObj)k.bottomObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,k.x-V.eyeX,k.y-V.eyeY,k.z-V.eyeZ,k.typecode);if(k.middleObj)k.middleObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,k.x-V.eyeX,k.y-V.eyeY,k.z-V.eyeZ,k.typecode);if(k.topObj)k.topObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,k.x-V.eyeX,k.y-V.eyeY,k.z-V.eyeZ,k.typecode)}}let u=b.locSpans;if(u!==0){if(G<V.eyeTileX&&(u&4)!==0){let F=I[G+1][N];if(F&&F.update)V.drawTileQueue.addTail(F)}if(N<V.eyeTileZ&&(u&2)!==0){let F=I[G][N+1];if(F&&F.update)V.drawTileQueue.addTail(F)}if(G>V.eyeTileX&&(u&1)!==0){let F=I[G-1][N];if(F&&F.update)V.drawTileQueue.addTail(F)}if(N>V.eyeTileZ&&(u&8)!==0){let F=I[G][N-1];if(F&&F.update)V.drawTileQueue.addTail(F)}}}if(b.checkLocSpans!==0){let q=!0;for(let O=0;O<b.locCount;O++){let U=b.locs[O];if(!U)continue;if(U.cycle!==V.cycle&&(b.locSpan[O]&b.checkLocSpans)===b.blockLocSpans){q=!1;break}}if(q){let O=b.wall;if(O&&!this.wallVisible(H,G,N,O.typeA))O.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY,O.z-V.eyeZ,O.typecode);b.checkLocSpans=0}}if(b.containsLocs){let q=b.locCount;b.containsLocs=!1;let O=0;_:for(let U=0;U<q;U++){let $=b.locs[U];if(!$||$.cycle===V.cycle)continue;for(let j=$.minSceneTileX;j<=$.maxSceneTileX;j++)for(let m=$.minSceneTileZ;m<=$.maxSceneTileZ;m++){let Y=I[j][m];if(!Y)continue;if(!Y.groundVisible){if(Y.checkLocSpans===0)continue;let X=0;if(j>$.minSceneTileX)X+=1;if(j<$.maxSceneTileX)X+=4;if(m>$.minSceneTileZ)X+=8;if(m<$.maxSceneTileZ)X+=2;if((X&Y.checkLocSpans)!==b.inverseBlockLocSpans)continue}b.containsLocs=!0;continue _}V.locBuffer[O++]=$;let K=V.eyeTileX-$.minSceneTileX,u=$.maxSceneTileX-V.eyeTileX;if(u>K)K=u;let F=V.eyeTileZ-$.minSceneTileZ,k=$.maxSceneTileZ-V.eyeTileZ;if(k>F)$.distance=K+k;else $.distance=K+F}while(!0){let U=-50,$=-1;for(let u=0;u<O;u++){let F=V.locBuffer[u];if(!F)continue;if(F.cycle!==V.cycle){if(F.distance>U)U=F.distance,$=u}}if($===-1)break;let K=V.locBuffer[$];if(K){K.cycle=V.cycle;let u=K.model;if(!u)u=K.entity?.draw(E)??null;if(u&&!this.locVisible(H,K.minSceneTileX,K.maxSceneTileX,K.minSceneTileZ,K.maxSceneTileZ,u.maxY))u.draw(K.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,K.x-V.eyeX,K.y-V.eyeY,K.z-V.eyeZ,K.typecode);for(let F=K.minSceneTileX;F<=K.maxSceneTileX;F++)for(let k=K.minSceneTileZ;k<=K.maxSceneTileZ;k++){let j=I[F][k];if(!j)continue;if(j.checkLocSpans!==0)V.drawTileQueue.addTail(j);else if((F!==G||k!==N)&&j.update)V.drawTileQueue.addTail(j)}}}if(b.containsLocs)continue}if(!b.update||b.checkLocSpans!==0)continue;if(G<=V.eyeTileX&&G>V.minDrawTileX){let q=I[G-1][N];if(q&&q.update)continue}if(G>=V.eyeTileX&&G<V.maxDrawTileX-1){let q=I[G+1][N];if(q&&q.update)continue}if(N<=V.eyeTileZ&&N>V.minDrawTileZ){let q=I[G][N-1];if(q&&q.update)continue}if(N>=V.eyeTileZ&&N<V.maxDrawTileZ-1){let q=I[G][N+1];if(q&&q.update)continue}b.update=!1,V.tilesRemaining--;let Q=b.objStack;if(Q&&Q.offset!==0){if(Q.bottomObj)Q.bottomObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,Q.x-V.eyeX,Q.y-V.eyeY-Q.offset,Q.z-V.eyeZ,Q.typecode);if(Q.middleObj)Q.middleObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,Q.x-V.eyeX,Q.y-V.eyeY-Q.offset,Q.z-V.eyeZ,Q.typecode);if(Q.topObj)Q.topObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,Q.x-V.eyeX,Q.y-V.eyeY-Q.offset,Q.z-V.eyeZ,Q.typecode)}if(b.backWallTypes!==0){let q=b.wallDecoration;if(q&&!this.visible(H,G,N,q.model.maxY)){if((q.decorType&b.backWallTypes)!==0)q.model.draw(q.decorAngle,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,q.x-V.eyeX,q.y-V.eyeY,q.z-V.eyeZ,q.typecode);else if((q.decorType&768)!==0){let U=q.x-V.eyeX,$=q.y-V.eyeY,K=q.z-V.eyeZ,u=q.decorAngle,F;if(u===1||u===2)F=-U;else F=U;let k;if(u===2||u===3)k=-K;else k=K;if((q.decorType&256)!==0&&k>=F){let j=U+V.WALL_DECORATION_INSET_X[u],m=K+V.WALL_DECORATION_INSET_Z[u];q.model.draw(u*512+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,j,$,m,q.typecode)}if((q.decorType&512)!==0&&k<=F){let j=U+V.WALL_DECORATION_OUTSET_X[u],m=K+V.WALL_DECORATION_OUTSET_Z[u];q.model.draw(u*512+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,j,$,m,q.typecode)}}}let O=b.wall;if(O){if((O.typeB&b.backWallTypes)!==0&&!this.wallVisible(H,G,N,O.typeB))O.modelB?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY,O.z-V.eyeZ,O.typecode);if((O.typeA&b.backWallTypes)!==0&&!this.wallVisible(H,G,N,O.typeA))O.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY,O.z-V.eyeZ,O.typecode)}}if(L<this.maxLevel-1){let q=this.levelTiles[L+1][G][N];if(q&&q.update)V.drawTileQueue.addTail(q)}if(G<V.eyeTileX){let q=I[G+1][N];if(q&&q.update)V.drawTileQueue.addTail(q)}if(N<V.eyeTileZ){let q=I[G][N+1];if(q&&q.update)V.drawTileQueue.addTail(q)}if(G>V.eyeTileX){let q=I[G-1][N];if(q&&q.update)V.drawTileQueue.addTail(q)}if(N>V.eyeTileZ){let q=I[G][N-1];if(q&&q.update)V.drawTileQueue.addTail(q)}}}drawTileUnderlay(_,R,E,b,G,N,L,H){let I,Q=I=(E<<7)-V.eyeX,q,O=q=(b<<7)-V.eyeZ,U,$=U=Q+128,K,u=K=O+128,F=this.levelHeightmaps[R][E][b]-V.eyeY,k=this.levelHeightmaps[R][E+1][b]-V.eyeY,j=this.levelHeightmaps[R][E+1][b+1]-V.eyeY,m=this.levelHeightmaps[R][E][b+1]-V.eyeY,Y=O*L+Q*H>>16;if(O=O*H-Q*L>>16,Q=Y,Y=F*N-O*G>>16,O=F*G+O*N>>16,F=Y,O<50)return;if(Y=q*L+$*H>>16,q=q*H-$*L>>16,$=Y,Y=k*N-q*G>>16,q=k*G+q*N>>16,k=Y,q<50)return;if(Y=u*L+U*H>>16,u=u*H-U*L>>16,U=Y,Y=j*N-u*G>>16,u=j*G+u*N>>16,j=Y,u<50)return;if(Y=K*L+I*H>>16,K=K*H-I*L>>16,I=Y,Y=m*N-K*G>>16,K=m*G+K*N>>16,m=Y,K<50)return;let X=w.centerX+((Q<<9)/O|0),B=w.centerY+((F<<9)/O|0),z=w.centerX+(($<<9)/q|0),Z=w.centerY+((k<<9)/q|0),g=w.centerX+((U<<9)/u|0),M=w.centerY+((j<<9)/u|0),S=w.centerX+((I<<9)/K|0),A=w.centerY+((m<<9)/K|0);if(w.alpha=0,(g-S)*(Z-A)-(M-A)*(z-S)>0){if(w.clipX=g<0||S<0||z<0||g>T.boundX||S>T.boundX||z>T.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,M,A,Z,g,S,z))V.clickTileX=E,V.clickTileZ=b;if(_.textureId===-1){if(_.northeastColor!==12345678)w.fillGouraudTriangle(g,S,z,M,A,Z,_.northeastColor,_.northwestColor,_.southeastColor)}else if(V.lowMemory){let W=V.TEXTURE_HSL[_.textureId];w.fillGouraudTriangle(g,S,z,M,A,Z,this.mulLightness(W,_.northeastColor),this.mulLightness(W,_.northwestColor),this.mulLightness(W,_.southeastColor))}else if(_.flat)w.fillTexturedTriangle(g,S,z,M,A,Z,_.northeastColor,_.northwestColor,_.southeastColor,Q,F,O,$,I,k,m,q,K,_.textureId);else w.fillTexturedTriangle(g,S,z,M,A,Z,_.northeastColor,_.northwestColor,_.southeastColor,U,j,u,I,$,m,k,K,q,_.textureId)}if((X-z)*(A-Z)-(B-Z)*(S-z)<=0)return;if(w.clipX=X<0||z<0||S<0||X>T.boundX||z>T.boundX||S>T.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,B,Z,A,X,z,S))V.clickTileX=E,V.clickTileZ=b;if(_.textureId!==-1){if(!V.lowMemory){w.fillTexturedTriangle(X,z,S,B,Z,A,_.southwestColor,_.southeastColor,_.northwestColor,Q,F,O,$,I,k,m,q,K,_.textureId);return}let W=V.TEXTURE_HSL[_.textureId];w.fillGouraudTriangle(X,z,S,B,Z,A,this.mulLightness(W,_.southwestColor),this.mulLightness(W,_.southeastColor),this.mulLightness(W,_.northwestColor))}else if(_.southwestColor!==12345678)w.fillGouraudTriangle(X,z,S,B,Z,A,_.southwestColor,_.southeastColor,_.northwestColor)}drawTileOverlay(_,R,E,b,G,N,L){let H=E.vertexX.length;for(let I=0;I<H;I++){let Q=E.vertexX[I]-V.eyeX,q=E.vertexY[I]-V.eyeY,O=E.vertexZ[I]-V.eyeZ,U=O*N+Q*L>>16;if(O=O*L-Q*N>>16,Q=U,U=q*G-O*b>>16,O=q*b+O*G>>16,q=U,O<50)return;if(E.triangleTextureIds)y.tmpViewspaceX[I]=Q,y.tmpViewspaceY[I]=q,y.tmpViewspaceZ[I]=O;y.tmpScreenX[I]=w.centerX+((Q<<9)/O|0),y.tmpScreenY[I]=w.centerY+((q<<9)/O|0)}w.alpha=0,H=E.triangleVertexA.length;for(let I=0;I<H;I++){let Q=E.triangleVertexA[I],q=E.triangleVertexB[I],O=E.triangleVertexC[I],U=y.tmpScreenX[Q],$=y.tmpScreenX[q],K=y.tmpScreenX[O],u=y.tmpScreenY[Q],F=y.tmpScreenY[q],k=y.tmpScreenY[O];if((U-$)*(k-F)-(u-F)*(K-$)>0){if(w.clipX=U<0||$<0||K<0||U>T.boundX||$>T.boundX||K>T.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,u,F,k,U,$,K))V.clickTileX=_,V.clickTileZ=R;if(!E.triangleTextureIds||E.triangleTextureIds[I]===-1){if(E.triangleColorA[I]!==12345678)w.fillGouraudTriangle(U,$,K,u,F,k,E.triangleColorA[I],E.triangleColorB[I],E.triangleColorC[I])}else if(V.lowMemory){let j=V.TEXTURE_HSL[E.triangleTextureIds[I]];w.fillGouraudTriangle(U,$,K,u,F,k,this.mulLightness(j,E.triangleColorA[I]),this.mulLightness(j,E.triangleColorB[I]),this.mulLightness(j,E.triangleColorC[I]))}else if(E.flat)w.fillTexturedTriangle(U,$,K,u,F,k,E.triangleColorA[I],E.triangleColorB[I],E.triangleColorC[I],y.tmpViewspaceX[0],y.tmpViewspaceY[0],y.tmpViewspaceZ[0],y.tmpViewspaceX[1],y.tmpViewspaceX[3],y.tmpViewspaceY[1],y.tmpViewspaceY[3],y.tmpViewspaceZ[1],y.tmpViewspaceZ[3],E.triangleTextureIds[I]);else w.fillTexturedTriangle(U,$,K,u,F,k,E.triangleColorA[I],E.triangleColorB[I],E.triangleColorC[I],y.tmpViewspaceX[Q],y.tmpViewspaceY[Q],y.tmpViewspaceZ[Q],y.tmpViewspaceX[q],y.tmpViewspaceX[O],y.tmpViewspaceY[q],y.tmpViewspaceY[O],y.tmpViewspaceZ[q],y.tmpViewspaceZ[O],E.triangleTextureIds[I])}}}tileVisible(_,R,E){let b=this.levelTileOcclusionCycles[_][R][E];if(b===-V.cycle)return!1;else if(b===V.cycle)return!0;else{let G=R<<7,N=E<<7;if(this.occluded(G+1,this.levelHeightmaps[_][R][E],N+1)&&this.occluded(G+128-1,this.levelHeightmaps[_][R+1][E],N+1)&&this.occluded(G+128-1,this.levelHeightmaps[_][R+1][E+1],N+128-1)&&this.occluded(G+1,this.levelHeightmaps[_][R][E+1],N+128-1))return this.levelTileOcclusionCycles[_][R][E]=V.cycle,!0;else return this.levelTileOcclusionCycles[_][R][E]=-V.cycle,!1}}wallVisible(_,R,E,b){if(!this.tileVisible(_,R,E))return!1;let G=R<<7,N=E<<7,L=this.levelHeightmaps[_][R][E]-1,H=L-120,I=L-230,Q=L-238;if(b<16){if(b===1){if(G>V.eyeX){if(!this.occluded(G,L,N))return!1;if(!this.occluded(G,L,N+128))return!1}if(_>0){if(!this.occluded(G,H,N))return!1;if(!this.occluded(G,H,N+128))return!1}if(!this.occluded(G,I,N))return!1;return this.occluded(G,I,N+128)}if(b===2){if(N<V.eyeZ){if(!this.occluded(G,L,N+128))return!1;if(!this.occluded(G+128,L,N+128))return!1}if(_>0){if(!this.occluded(G,H,N+128))return!1;if(!this.occluded(G+128,H,N+128))return!1}if(!this.occluded(G,I,N+128))return!1;return this.occluded(G+128,I,N+128)}if(b===4){if(G<V.eyeX){if(!this.occluded(G+128,L,N))return!1;if(!this.occluded(G+128,L,N+128))return!1}if(_>0){if(!this.occluded(G+128,H,N))return!1;if(!this.occluded(G+128,H,N+128))return!1}if(!this.occluded(G+128,I,N))return!1;return this.occluded(G+128,I,N+128)}if(b===8){if(N>V.eyeZ){if(!this.occluded(G,L,N))return!1;if(!this.occluded(G+128,L,N))return!1}if(_>0){if(!this.occluded(G,H,N))return!1;if(!this.occluded(G+128,H,N))return!1}if(!this.occluded(G,I,N))return!1;return this.occluded(G+128,I,N)}}if(!this.occluded(G+64,Q,N+64))return!1;else if(b===16)return this.occluded(G,I,N+128);else if(b===32)return this.occluded(G+128,I,N+128);else if(b===64)return this.occluded(G+128,I,N);else if(b===128)return this.occluded(G,I,N);return!0}visible(_,R,E,b){if(this.tileVisible(_,R,E)){let G=R<<7,N=E<<7;return this.occluded(G+1,this.levelHeightmaps[_][R][E]-b,N+1)&&this.occluded(G+128-1,this.levelHeightmaps[_][R+1][E]-b,N+1)&&this.occluded(G+128-1,this.levelHeightmaps[_][R+1][E+1]-b,N+128-1)&&this.occluded(G+1,this.levelHeightmaps[_][R][E+1]-b,N+128-1)}return!1}locVisible(_,R,E,b,G,N){let L,H;if(R!==E||b!==G){for(L=R;L<=E;L++)for(H=b;H<=G;H++)if(this.levelTileOcclusionCycles[_][L][H]===-V.cycle)return!1;H=(R<<7)+1;let I=(b<<7)+2,Q=this.levelHeightmaps[_][R][b]-N;if(!this.occluded(H,Q,I))return!1;let q=(E<<7)-1;if(!this.occluded(q,Q,I))return!1;let O=(G<<7)-1;if(!this.occluded(H,Q,O))return!1;else return this.occluded(q,Q,O)}else if(this.tileVisible(_,R,b))return L=R<<7,H=b<<7,this.occluded(L+1,this.levelHeightmaps[_][R][b]-N,H+1)&&this.occluded(L+128-1,this.levelHeightmaps[_][R+1][b]-N,H+1)&&this.occluded(L+128-1,this.levelHeightmaps[_][R+1][b+1]-N,H+128-1)&&this.occluded(L+1,this.levelHeightmaps[_][R][b+1]-N,H+128-1);return!1}occluded(_,R,E){for(let b=0;b<V.activeOccluderCount;b++){let G=V.activeOccluders[b];if(!G)continue;if(G.mode===1){let N=G.minX-_;if(N>0){let L=G.minZ+(G.minDeltaZ*N>>8),H=G.maxZ+(G.maxDeltaZ*N>>8),I=G.minY+(G.minDeltaY*N>>8),Q=G.maxY+(G.maxDeltaY*N>>8);if(E>=L&&E<=H&&R>=I&&R<=Q)return!0}}else if(G.mode===2){let N=_-G.minX;if(N>0){let L=G.minZ+(G.minDeltaZ*N>>8),H=G.maxZ+(G.maxDeltaZ*N>>8),I=G.minY+(G.minDeltaY*N>>8),Q=G.maxY+(G.maxDeltaY*N>>8);if(E>=L&&E<=H&&R>=I&&R<=Q)return!0}}else if(G.mode===3){let N=G.minZ-E;if(N>0){let L=G.minX+(G.minDeltaX*N>>8),H=G.maxX+(G.maxDeltaX*N>>8),I=G.minY+(G.minDeltaY*N>>8),Q=G.maxY+(G.maxDeltaY*N>>8);if(_>=L&&_<=H&&R>=I&&R<=Q)return!0}}else if(G.mode===4){let N=E-G.minZ;if(N>0){let L=G.minX+(G.minDeltaX*N>>8),H=G.maxX+(G.maxDeltaX*N>>8),I=G.minY+(G.minDeltaY*N>>8),Q=G.maxY+(G.maxDeltaY*N>>8);if(_>=L&&_<=H&&R>=I&&R<=Q)return!0}}else if(G.mode===5){let N=R-G.minY;if(N>0){let L=G.minX+(G.minDeltaX*N>>8),H=G.maxX+(G.maxDeltaX*N>>8),I=G.minZ+(G.minDeltaZ*N>>8),Q=G.maxZ+(G.maxDeltaZ*N>>8);if(_>=L&&_<=H&&E>=I&&E<=Q)return!0}}}return!1}pointInsideTriangle(_,R,E,b,G,N,L,H){if(R<E&&R<b&&R<G)return!1;else if(R>E&&R>b&&R>G)return!1;else if(_<N&&_<L&&_<H)return!1;else if(_>N&&_>L&&_>H)return!1;let I=(R-E)*(L-N)-(_-N)*(b-E),Q=(R-G)*(N-H)-(_-H)*(E-G),q=(R-b)*(H-L)-(_-L)*(G-b);return I*q>0&&q*Q>0}mulLightness(_,R){if(R=(127-R)*(_&127)/160|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}}class G0 extends F0{heightmapSW;heightmapSE;heightmapNE;heightmapNW;index;seq;seqFrame;seqCycle;constructor(_,R,E,b,G,N,L){super();if(this.heightmapSW=R,this.heightmapSE=E,this.heightmapNE=b,this.heightmapNW=G,this.index=_,this.seq=N,L&&N.replayoff!==-1&&this.seq.seqDelay)this.seqFrame=Math.random()*this.seq.seqFrameCount|0,this.seqCycle=Math.random()*this.seq.seqDelay[this.seqFrame]|0;else this.seqFrame=-1,this.seqCycle=0}}class a{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(Math.random()*17|0)-8;static randomLightnessOffset=(Math.random()*33|0)-16;static lowMemory=!0;static levelBuilt=0;static fullbright=!1;static perlin(_,R){let E=this.perlinScale(_+45365,R+91923,4)+(this.perlinScale(_+10294,R+37821,2)-128>>1)+(this.perlinScale(_,R,1)-128>>2)-128;if(E=(E*0.3|0)+35,E<10)E=10;else if(E>60)E=60;return E}static perlinScale(_,R,E){let b=_/E|0,G=_&E-1,N=R/E|0,L=R&E-1,H=this.smoothNoise(b,N),I=this.smoothNoise(b+1,N),Q=this.smoothNoise(b,N+1),q=this.smoothNoise(b+1,N+1),O=this.interpolate(H,I,G,E),U=this.interpolate(Q,q,G,E);return this.interpolate(O,U,L,E)}static interpolate(_,R,E,b){let G=65536-w.cos[E*1024/b|0]>>1;return(_*(65536-G)>>16)+(R*G>>16)}static smoothNoise(_,R){let E=this.noise(_-1,R-1)+this.noise(_+1,R-1)+this.noise(_-1,R+1)+this.noise(_+1,R+1),b=this.noise(_-1,R)+this.noise(_+1,R)+this.noise(_,R-1)+this.noise(_,R+1),G=this.noise(_,R);return(E/16|0)+(b/8|0)+(G/4|0)}static noise(_,R){let E=_+R*57,b=BigInt(E<<13^E);return Number((b*(b*b*15731n+789221n)+1376312589n&0x7fffffffn)>>19n)&255}static addLoc(_,R,E,b,G,N,L,H,I,Q,q){let O=G[q][R][E],U=G[q][R+1][E],$=G[q][R+1][E+1],K=G[q][R][E+1],u=O+U+$+K>>2,F=Q0.get(H),k=R+(E<<7)+(H<<14)+1073741824|0;if(!F.locActive)k+=-2147483648;k|=0;let j=((Q<<6)+I|0)<<24>>24;if(I===h.GROUND_DECOR.id){if(b?.addGroundDecoration(F.getModel(h.GROUND_DECOR.id,Q,O,U,$,K,-1),_,R,E,u,k,j),F.blockwalk&&F.locActive)L?.addFloor(R,E);if(F.anim!==-1)N.addTail(new G0(H,_,3,R,E,r.instances[F.anim],!0))}else if(I===h.CENTREPIECE_STRAIGHT.id||I===h.CENTREPIECE_DIAGONAL.id){let m=F.getModel(h.CENTREPIECE_STRAIGHT.id,Q,O,U,$,K,-1);if(m){let Y=0;if(I===h.CENTREPIECE_DIAGONAL.id)Y+=256;let X,B;if(Q===1||Q===3)X=F.length,B=F.width;else X=F.width,B=F.length;b?.addLoc(_,R,E,u,m,null,k,j,X,B,Y)}if(F.blockwalk)L?.addLoc(R,E,F.width,F.length,Q,F.blockrange);if(F.anim!==-1)N.addTail(new G0(H,_,2,R,E,r.instances[F.anim],!0))}else if(I>=h.ROOF_STRAIGHT.id){if(b?.addLoc(_,R,E,u,F.getModel(I,Q,O,U,$,K,-1),null,k,j,1,1,0),F.blockwalk)L?.addLoc(R,E,F.width,F.length,Q,F.blockrange);if(F.anim!==-1)N.addTail(new G0(H,_,2,R,E,r.instances[F.anim],!0))}else if(I===h.WALL_STRAIGHT.id){if(b?.addWall(_,R,E,u,a.ROTATION_WALL_TYPE[Q],0,F.getModel(h.WALL_STRAIGHT.id,Q,O,U,$,K,-1),null,k,j),F.blockwalk)L?.addWall(R,E,I,Q,F.blockrange);if(F.anim!==-1)N.addTail(new G0(H,_,0,R,E,r.instances[F.anim],!0))}else if(I===h.WALL_DIAGONAL_CORNER.id){if(b?.addWall(_,R,E,u,a.ROTATION_WALL_CORNER_TYPE[Q],0,F.getModel(h.WALL_DIAGONAL_CORNER.id,Q,O,U,$,K,-1),null,k,j),F.blockwalk)L?.addWall(R,E,I,Q,F.blockrange);if(F.anim!==-1)N.addTail(new G0(H,_,0,R,E,r.instances[F.anim],!0))}else if(I===h.WALL_L.id){let m=Q+1&3;if(b?.addWall(_,R,E,u,a.ROTATION_WALL_TYPE[Q],a.ROTATION_WALL_TYPE[m],F.getModel(h.WALL_L.id,Q+4,O,U,$,K,-1),F.getModel(h.WALL_L.id,m,O,U,$,K,-1),k,j),F.blockwalk)L?.addWall(R,E,I,Q,F.blockrange);if(F.anim!==-1)N.addTail(new G0(H,_,0,R,E,r.instances[F.anim],!0))}else if(I===h.WALL_SQUARE_CORNER.id){if(b?.addWall(_,R,E,u,a.ROTATION_WALL_CORNER_TYPE[Q],0,F.getModel(h.WALL_SQUARE_CORNER.id,Q,O,U,$,K,-1),null,k,j),F.blockwalk)L?.addWall(R,E,I,Q,F.blockrange);if(F.anim!==-1)N.addTail(new G0(H,_,0,R,E,r.instances[F.anim],!0))}else if(I===h.WALL_DIAGONAL.id){if(b?.addLoc(_,R,E,u,F.getModel(I,Q,O,U,$,K,-1),null,k,j,1,1,0),F.blockwalk)L?.addLoc(R,E,F.width,F.length,Q,F.blockrange);if(F.anim!==-1)N.addTail(new G0(H,_,2,R,E,r.instances[F.anim],!0))}else if(I===h.WALLDECOR_STRAIGHT_NOOFFSET.id){if(b?.setWallDecoration(_,R,E,u,0,0,k,F.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,O,U,$,K,-1),j,Q*512,a.ROTATION_WALL_TYPE[Q]),F.anim!==-1)N.addTail(new G0(H,_,1,R,E,r.instances[F.anim],!0))}else if(I===h.WALLDECOR_STRAIGHT_OFFSET.id){let m=16;if(b){let Y=b.getWallTypecode(_,R,E);if(Y>0)m=Q0.get(Y>>14&32767).wallwidth}if(b?.setWallDecoration(_,R,E,u,a.WALL_DECORATION_ROTATION_FORWARD_X[Q]*m,a.WALL_DECORATION_ROTATION_FORWARD_Z[Q]*m,k,F.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,O,U,$,K,-1),j,Q*512,a.ROTATION_WALL_TYPE[Q]),F.anim!==-1)N.addTail(new G0(H,_,1,R,E,r.instances[F.anim],!0))}else if(I===h.WALLDECOR_DIAGONAL_OFFSET.id){if(b?.setWallDecoration(_,R,E,u,0,0,k,F.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,O,U,$,K,-1),j,Q,256),F.anim!==-1)N.addTail(new G0(H,_,1,R,E,r.instances[F.anim],!0))}else if(I===h.WALLDECOR_DIAGONAL_NOOFFSET.id){if(b?.setWallDecoration(_,R,E,u,0,0,k,F.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,O,U,$,K,-1),j,Q,512),F.anim!==-1)N.addTail(new G0(H,_,1,R,E,r.instances[F.anim],!0))}else if(I===h.WALLDECOR_DIAGONAL_BOTH.id){if(b?.setWallDecoration(_,R,E,u,0,0,k,F.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,O,U,$,K,-1),j,Q,768),F.anim!==-1)N.addTail(new G0(H,_,1,R,E,r.instances[F.anim],!0))}}maxTileX;maxTileZ;levelHeightmap;levelTileFlags;levelTileUnderlayIds;levelTileOverlayIds;levelTileOverlayShape;levelTileOverlayRotation;levelShademap;levelLightmap;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;levelOccludemap;constructor(_,R,E,b){this.maxTileX=_,this.maxTileZ=R,this.levelHeightmap=E,this.levelTileFlags=b,this.levelTileUnderlayIds=new M0(4,_,R),this.levelTileOverlayIds=new M0(4,_,R),this.levelTileOverlayShape=new M0(4,_,R),this.levelTileOverlayRotation=new M0(4,_,R),this.levelOccludemap=new h0(4,_+1,R+1),this.levelShademap=new M0(4,_+1,R+1),this.levelLightmap=new X0(_+1,R+1),this.blendChroma=new Int32Array(R),this.blendSaturation=new Int32Array(R),this.blendLightness=new Int32Array(R),this.blendLuminance=new Int32Array(R),this.blendMagnitude=new Int32Array(R)}build(_,R){for(let E=0;E<4;E++)for(let b=0;b<104;b++)for(let G=0;G<104;G++)if((this.levelTileFlags[E][b][G]&1)===1){let N=E;if((this.levelTileFlags[1][b][G]&2)===2)N--;if(N>=0)R[N]?.addFloor(b,G)}if(a.randomHueOffset+=(Math.random()*5|0)-2,a.randomHueOffset<-8)a.randomHueOffset=-8;else if(a.randomHueOffset>8)a.randomHueOffset=8;if(a.randomLightnessOffset+=(Math.random()*5|0)-2,a.randomLightnessOffset<-16)a.randomLightnessOffset=-16;else if(a.randomLightnessOffset>16)a.randomLightnessOffset=16;for(let E=0;E<4;E++){let b=this.levelShademap[E],G=96,N=768,L=-50,H=-10,I=-50,q=768*(Math.sqrt(5100)|0)>>8;for(let O=1;O<this.maxTileZ-1;O++)for(let U=1;U<this.maxTileX-1;U++){let $=this.levelHeightmap[E][U+1][O]-this.levelHeightmap[E][U-1][O],K=this.levelHeightmap[E][U][O+1]-this.levelHeightmap[E][U][O-1],u=Math.sqrt($*$+K*K+65536)|0,F=($<<8)/u|0,k=65536/u|0,j=(K<<8)/u|0,m=96+((-50*F+-10*k+-50*j)/q|0),Y=(b[U-1][O]>>2)+(b[U+1][O]>>3)+(b[U][O-1]>>2)+(b[U][O+1]>>3)+(b[U][O]>>1);this.levelLightmap[U][O]=m-Y}for(let O=0;O<this.maxTileZ;O++)this.blendChroma[O]=0,this.blendSaturation[O]=0,this.blendLightness[O]=0,this.blendLuminance[O]=0,this.blendMagnitude[O]=0;for(let O=-5;O<this.maxTileX+5;O++){for(let U=0;U<this.maxTileZ;U++){let $=O+5,K;if($>=0&&$<this.maxTileX){let F=this.levelTileUnderlayIds[E][$][U]&255;if(F>0){let k=N0.instances[F-1];this.blendChroma[U]+=k.chroma,this.blendSaturation[U]+=k.saturation,this.blendLightness[U]+=k.lightness,this.blendLuminance[U]+=k.luminance,K=this.blendMagnitude[U]++}}let u=O-5;if(u>=0&&u<this.maxTileX){let F=this.levelTileUnderlayIds[E][u][U]&255;if(F>0){let k=N0.instances[F-1];this.blendChroma[U]-=k.chroma,this.blendSaturation[U]-=k.saturation,this.blendLightness[U]-=k.lightness,this.blendLuminance[U]-=k.luminance,K=this.blendMagnitude[U]--}}}if(O>=1&&O<this.maxTileX-1){let U=0,$=0,K=0,u=0,F=0;for(let k=-5;k<this.maxTileZ+5;k++){let j=k+5;if(j>=0&&j<this.maxTileZ)U+=this.blendChroma[j],$+=this.blendSaturation[j],K+=this.blendLightness[j],u+=this.blendLuminance[j],F+=this.blendMagnitude[j];let m=k-5;if(m>=0&&m<this.maxTileZ)U-=this.blendChroma[m],$-=this.blendSaturation[m],K-=this.blendLightness[m],u-=this.blendLuminance[m],F-=this.blendMagnitude[m];if(k>=1&&k<this.maxTileZ-1&&(!a.lowMemory||(this.levelTileFlags[E][O][k]&16)===0&&this.getDrawLevel(E,O,k)===a.levelBuilt)){let Y=this.levelTileUnderlayIds[E][O][k]&255,X=this.levelTileOverlayIds[E][O][k]&255;if(Y>0||X>0){let B=this.levelHeightmap[E][O][k],z=this.levelHeightmap[E][O+1][k],Z=this.levelHeightmap[E][O+1][k+1],g=this.levelHeightmap[E][O][k+1],M=this.levelLightmap[O][k],S=this.levelLightmap[O+1][k],A=this.levelLightmap[O+1][k+1],W=this.levelLightmap[O][k+1],v=-1,n=-1;if(Y>0){let i=U*256/u|0,x=$/F|0,c=K/F|0;v=N0.hsl24to16(i,x,c);let R0=i+a.randomHueOffset&255;if(c+=a.randomLightnessOffset,c<0)c=0;else if(c>255)c=255;n=N0.hsl24to16(R0,x,c)}if(E>0){let i=Y!==0||this.levelTileOverlayShape[E][O][k]===0;if(X>0&&!N0.instances[X-1].occlude)i=!1;if(i&&B===z&&B===Z&&B===g)this.levelOccludemap[E][O][k]|=2340}let D=0;if(v!==-1)D=w.hslPal[N0.mulHSL(n,96)];if(X===0)_?.setTile(E,O,k,0,0,-1,B,z,Z,g,N0.mulHSL(v,M),N0.mulHSL(v,S),N0.mulHSL(v,A),N0.mulHSL(v,W),0,0,0,0,D,0);else{let i=this.levelTileOverlayShape[E][O][k]+1,x=this.levelTileOverlayRotation[E][O][k],c=N0.instances[X-1],R0=c.overlayTexture,t,q0;if(R0>=0)q0=w.getAverageTextureRGB(R0),t=-1;else if(c.rgb===16711935)q0=0,t=-2,R0=-1;else t=N0.hsl24to16(c.hue,c.saturation,c.lightness),q0=w.hslPal[N0.adjustLightness(c.hsl,96)];_?.setTile(E,O,k,i,x,R0,B,z,Z,g,N0.mulHSL(v,M),N0.mulHSL(v,S),N0.mulHSL(v,A),N0.mulHSL(v,W),N0.adjustLightness(t,M),N0.adjustLightness(t,S),N0.adjustLightness(t,A),N0.adjustLightness(t,W),D,q0)}}}}}}for(let O=1;O<this.maxTileZ-1;O++)for(let U=1;U<this.maxTileX-1;U++)_?.setDrawLevel(E,U,O,this.getDrawLevel(E,U,O))}if(!a.fullbright)_?.buildModels(64,768,-50,-10,-50);for(let E=0;E<this.maxTileX;E++)for(let b=0;b<this.maxTileZ;b++)if((this.levelTileFlags[1][E][b]&2)===2)_?.setBridge(E,b);if(!a.fullbright){let E=1,b=2,G=4;for(let N=0;N<4;N++){if(N>0)E<<=3,b<<=3,G<<=3;for(let L=0;L<=N;L++)for(let H=0;H<=this.maxTileZ;H++)for(let I=0;I<=this.maxTileX;I++){if((this.levelOccludemap[L][I][H]&E)!==0){let Q=H,q=H,O=L,U=L;while(Q>0&&(this.levelOccludemap[L][I][Q-1]&E)!==0)Q--;while(q<this.maxTileZ&&(this.levelOccludemap[L][I][q+1]&E)!==0)q++;_:while(O>0){for(let K=Q;K<=q;K++)if((this.levelOccludemap[O-1][I][K]&E)===0)break _;O--}_:while(U<N){for(let K=Q;K<=q;K++)if((this.levelOccludemap[U+1][I][K]&E)===0)break _;U++}if((U+1-O)*(q+1-Q)>=8){let K=this.levelHeightmap[U][I][Q]-240,u=this.levelHeightmap[O][I][Q];V.addOccluder(N,1,I*128,K,Q*128,I*128,u,q*128+128);for(let F=O;F<=U;F++)for(let k=Q;k<=q;k++)this.levelOccludemap[F][I][k]&=~E}}if((this.levelOccludemap[L][I][H]&b)!==0){let Q=I,q=I,O=L,U=L;while(Q>0&&(this.levelOccludemap[L][Q-1][H]&b)!==0)Q--;while(q<this.maxTileX&&(this.levelOccludemap[L][q+1][H]&b)!==0)q++;_:while(O>0){for(let K=Q;K<=q;K++)if((this.levelOccludemap[O-1][K][H]&b)===0)break _;O--}_:while(U<N){for(let K=Q;K<=q;K++)if((this.levelOccludemap[U+1][K][H]&b)===0)break _;U++}if((U+1-O)*(q+1-Q)>=8){let K=this.levelHeightmap[U][Q][H]-240,u=this.levelHeightmap[O][Q][H];V.addOccluder(N,2,Q*128,K,H*128,q*128+128,u,H*128);for(let F=O;F<=U;F++)for(let k=Q;k<=q;k++)this.levelOccludemap[F][k][H]&=~b}}if((this.levelOccludemap[L][I][H]&G)!==0){let Q=I,q=I,O=H,U=H;while(O>0&&(this.levelOccludemap[L][I][O-1]&G)!==0)O--;while(U<this.maxTileZ&&(this.levelOccludemap[L][I][U+1]&G)!==0)U++;_:while(Q>0){for(let $=O;$<=U;$++)if((this.levelOccludemap[L][Q-1][$]&G)===0)break _;Q--}_:while(q<this.maxTileX){for(let $=O;$<=U;$++)if((this.levelOccludemap[L][q+1][$]&G)===0)break _;q++}if((q+1-Q)*(U+1-O)>=4){let $=this.levelHeightmap[L][Q][O];V.addOccluder(N,4,Q*128,$,O*128,q*128+128,$,U*128+128);for(let K=Q;K<=q;K++)for(let u=O;u<=U;u++)this.levelOccludemap[L][K][u]&=~G}}}}}}clearLandscape(_,R,E,b){let G=0;for(let N=0;N<N0.totalCount;N++)if(N0.instances[N].debugname?.toLowerCase()==="water"){G=N+1<<24>>24;break}for(let N=_;N<_+E;N++)for(let L=R;L<R+b;L++)if(L>=0&&L<this.maxTileX&&N>=0&&N<this.maxTileZ){this.levelTileOverlayIds[0][L][N]=G;for(let H=0;H<4;H++)this.levelHeightmap[H][L][N]=0,this.levelTileFlags[H][L][N]=0}}readLandscape(_,R,E,b,G){let N=new f(G);for(let L=0;L<4;L++)for(let H=0;H<64;H++)for(let I=0;I<64;I++){let Q=H+E,q=I+b,O;if(Q>=0&&Q<104&&q>=0&&q<104){this.levelTileFlags[L][Q][q]=0;while(!0){if(O=N.g1(),O===0){if(L===0)this.levelHeightmap[0][Q][q]=-a.perlin(Q+_+932731,q+556238+R)*8;else this.levelHeightmap[L][Q][q]=this.levelHeightmap[L-1][Q][q]-240;break}if(O===1){let U=N.g1();if(U===1)U=0;if(L===0)this.levelHeightmap[0][Q][q]=-U*8;else this.levelHeightmap[L][Q][q]=this.levelHeightmap[L-1][Q][q]-U*8;break}if(O<=49)this.levelTileOverlayIds[L][Q][q]=N.g1b(),this.levelTileOverlayShape[L][Q][q]=((O-2)/4|0)<<24>>24,this.levelTileOverlayRotation[L][Q][q]=(O-2&3)<<24>>24;else if(O<=81)this.levelTileFlags[L][Q][q]=O-49<<24>>24;else this.levelTileUnderlayIds[L][Q][q]=O-81<<24>>24}}else while(!0){if(O=N.g1(),O===0)break;if(O===1){N.g1();break}if(O<=49)N.g1()}}}readLocs(_,R,E,b,G,N){let L=new f(b),H=-1;while(!0){let I=L.gsmarts();if(I===0)return;H+=I;let Q=0;while(!0){let q=L.gsmarts();if(q===0)break;Q+=q-1;let O=Q&63,U=Q>>6&63,$=Q>>12,K=L.g1(),u=K>>2,F=K&3,k=U+G,j=O+N;if(k>0&&j>0&&k<104-1&&j<104-1){let m=$;if((this.levelTileFlags[1][k][j]&2)===2)m=$-1;let Y=null;if(m>=0)Y=E[m];this.addLoc($,k,j,_,R,Y,H,u,F)}}}}addLoc(_,R,E,b,G,N,L,H,I){if(a.lowMemory){if((this.levelTileFlags[_][R][E]&16)!==0)return;if(this.getDrawLevel(_,R,E)!==a.levelBuilt)return}let Q=this.levelHeightmap[_][R][E],q=this.levelHeightmap[_][R+1][E],O=this.levelHeightmap[_][R+1][E+1],U=this.levelHeightmap[_][R][E+1],$=Q+q+O+U>>2,K=Q0.get(L),u=R+(E<<7)+(L<<14)+1073741824|0;if(!K.locActive)u+=-2147483648;u|=0;let F=((I<<6)+H|0)<<24>>24;if(H===h.GROUND_DECOR.id){if(!a.lowMemory||K.locActive||K.forcedecor){if(b?.addGroundDecoration(K.getModel(h.GROUND_DECOR.id,I,Q,q,O,U,-1),_,R,E,$,u,F),K.blockwalk&&K.locActive)N?.addFloor(R,E);if(K.anim!==-1)G.addTail(new G0(L,_,3,R,E,r.instances[K.anim],!0))}}else if(H===h.CENTREPIECE_STRAIGHT.id||H===h.CENTREPIECE_DIAGONAL.id){let k=K.getModel(h.CENTREPIECE_STRAIGHT.id,I,Q,q,O,U,-1);if(k){let j=0;if(H===h.CENTREPIECE_DIAGONAL.id)j+=256;let m,Y;if(I===1||I===3)m=K.length,Y=K.width;else m=K.width,Y=K.length;if(b?.addLoc(_,R,E,$,k,null,u,F,m,Y,j)&&K.shadow)for(let X=0;X<=m;X++)for(let B=0;B<=Y;B++){let z=k.radius/4|0;if(z>30)z=30;if(z>this.levelShademap[_][R+X][E+B])this.levelShademap[_][R+X][E+B]=z<<24>>24}}if(K.blockwalk)N?.addLoc(R,E,K.width,K.length,I,K.blockrange);if(K.anim!==-1)G.addTail(new G0(L,_,2,R,E,r.instances[K.anim],!0))}else if(H>=h.ROOF_STRAIGHT.id){if(b?.addLoc(_,R,E,$,K.getModel(H,I,Q,q,O,U,-1),null,u,F,1,1,0),H>=h.ROOF_STRAIGHT.id&&H<=h.ROOF_FLAT.id&&H!==h.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&_>0)this.levelOccludemap[_][R][E]|=2340;if(K.blockwalk)N?.addLoc(R,E,K.width,K.length,I,K.blockrange);if(K.anim!==-1)G.addTail(new G0(L,_,2,R,E,r.instances[K.anim],!0))}else if(H===h.WALL_STRAIGHT.id){if(b?.addWall(_,R,E,$,a.ROTATION_WALL_TYPE[I],0,K.getModel(h.WALL_STRAIGHT.id,I,Q,q,O,U,-1),null,u,F),I===0){if(K.shadow)this.levelShademap[_][R][E]=50,this.levelShademap[_][R][E+1]=50;if(K.occlude)this.levelOccludemap[_][R][E]|=585}else if(I===1){if(K.shadow)this.levelShademap[_][R][E+1]=50,this.levelShademap[_][R+1][E+1]=50;if(K.occlude)this.levelOccludemap[_][R][E+1]|=1170}else if(I===2){if(K.shadow)this.levelShademap[_][R+1][E]=50,this.levelShademap[_][R+1][E+1]=50;if(K.occlude)this.levelOccludemap[_][R+1][E]|=585}else if(I===3){if(K.shadow)this.levelShademap[_][R][E]=50,this.levelShademap[_][R+1][E]=50;if(K.occlude)this.levelOccludemap[_][R][E]|=1170}if(K.blockwalk)N?.addWall(R,E,H,I,K.blockrange);if(K.anim!==-1)G.addTail(new G0(L,_,0,R,E,r.instances[K.anim],!0));if(K.wallwidth!==16)b?.setWallDecorationOffset(_,R,E,K.wallwidth)}else if(H===h.WALL_DIAGONAL_CORNER.id){if(b?.addWall(_,R,E,$,a.ROTATION_WALL_CORNER_TYPE[I],0,K.getModel(h.WALL_DIAGONAL_CORNER.id,I,Q,q,O,U,-1),null,u,F),K.shadow){if(I===0)this.levelShademap[_][R][E+1]=50;else if(I===1)this.levelShademap[_][R+1][E+1]=50;else if(I===2)this.levelShademap[_][R+1][E]=50;else if(I===3)this.levelShademap[_][R][E]=50}if(K.blockwalk)N?.addWall(R,E,H,I,K.blockrange);if(K.anim!==-1)G.addTail(new G0(L,_,0,R,E,r.instances[K.anim],!0))}else if(H===h.WALL_L.id){let k=I+1&3;if(b?.addWall(_,R,E,$,a.ROTATION_WALL_TYPE[I],a.ROTATION_WALL_TYPE[k],K.getModel(h.WALL_L.id,I+4,Q,q,O,U,-1),K.getModel(h.WALL_L.id,k,Q,q,O,U,-1),u,F),K.occlude){if(I===0)this.levelOccludemap[_][R][E]|=265,this.levelOccludemap[_][R][E+1]|=1170;else if(I===1)this.levelOccludemap[_][R][E+1]|=1170,this.levelOccludemap[_][R+1][E]|=585;else if(I===2)this.levelOccludemap[_][R+1][E]|=585,this.levelOccludemap[_][R][E]|=1170;else if(I===3)this.levelOccludemap[_][R][E]|=1170,this.levelOccludemap[_][R][E]|=585}if(K.blockwalk)N?.addWall(R,E,H,I,K.blockrange);if(K.anim!==-1)G.addTail(new G0(L,_,0,R,E,r.instances[K.anim],!0));if(K.wallwidth!==16)b?.setWallDecorationOffset(_,R,E,K.wallwidth)}else if(H===h.WALL_SQUARE_CORNER.id){if(b?.addWall(_,R,E,$,a.ROTATION_WALL_CORNER_TYPE[I],0,K.getModel(h.WALL_SQUARE_CORNER.id,I,Q,q,O,U,-1),null,u,F),K.shadow){if(I===0)this.levelShademap[_][R][E+1]=50;else if(I===1)this.levelShademap[_][R+1][E+1]=50;else if(I===2)this.levelShademap[_][R+1][E]=50;else if(I===3)this.levelShademap[_][R][E]=50}if(K.blockwalk)N?.addWall(R,E,H,I,K.blockrange);if(K.anim!==-1)G.addTail(new G0(L,_,0,R,E,r.instances[K.anim],!0))}else if(H===h.WALL_DIAGONAL.id){if(b?.addLoc(_,R,E,$,K.getModel(H,I,Q,q,O,U,-1),null,u,F,1,1,0),K.blockwalk)N?.addLoc(R,E,K.width,K.length,I,K.blockrange);if(K.anim!==-1)G.addTail(new G0(L,_,2,R,E,r.instances[K.anim],!0))}else if(H===h.WALLDECOR_STRAIGHT_NOOFFSET.id){if(b?.setWallDecoration(_,R,E,$,0,0,u,K.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,Q,q,O,U,-1),F,I*512,a.ROTATION_WALL_TYPE[I]),K.anim!==-1)G.addTail(new G0(L,_,1,R,E,r.instances[K.anim],!0))}else if(H===h.WALLDECOR_STRAIGHT_OFFSET.id){let k=16;if(b){let j=b.getWallTypecode(_,R,E);if(j>0)k=Q0.get(j>>14&32767).wallwidth}if(b?.setWallDecoration(_,R,E,$,a.WALL_DECORATION_ROTATION_FORWARD_X[I]*k,a.WALL_DECORATION_ROTATION_FORWARD_Z[I]*k,u,K.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,Q,q,O,U,-1),F,I*512,a.ROTATION_WALL_TYPE[I]),K.anim!==-1)G.addTail(new G0(L,_,1,R,E,r.instances[K.anim],!0))}else if(H===h.WALLDECOR_DIAGONAL_OFFSET.id){if(b?.setWallDecoration(_,R,E,$,0,0,u,K.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,Q,q,O,U,-1),F,I,256),K.anim!==-1)G.addTail(new G0(L,_,1,R,E,r.instances[K.anim],!0))}else if(H===h.WALLDECOR_DIAGONAL_NOOFFSET.id){if(b?.setWallDecoration(_,R,E,$,0,0,u,K.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,Q,q,O,U,-1),F,I,512),K.anim!==-1)G.addTail(new G0(L,_,1,R,E,r.instances[K.anim],!0))}else if(H===h.WALLDECOR_DIAGONAL_BOTH.id){if(b?.setWallDecoration(_,R,E,$,0,0,u,K.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,Q,q,O,U,-1),F,I,768),K.anim!==-1)G.addTail(new G0(L,_,1,R,E,r.instances[K.anim],!0))}}getDrawLevel(_,R,E){if((this.levelTileFlags[_][R][E]&8)===0)return _<=0||(this.levelTileFlags[1][R][E]&2)===0?_:_-1;return 0}}class z0 extends F0{}class n0 extends z0{x=0;z=0;yaw=0;seqStretches=!1;size=1;seqStandId=-1;seqTurnId=-1;seqWalkId=-1;seqTurnAroundId=-1;seqTurnLeftId=-1;seqTurnRightId=-1;seqRunId=-1;chat=null;chatTimer=100;chatColor=0;chatStyle=0;damage=0;damageType=0;combatCycle=-1000;health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimOffset=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;maxY=0;dstYaw=0;routeLength=0;routeFlagX=new Int32Array(10);routeFlagZ=new Int32Array(10);routeRun=new C(10,!1);seqTrigger=0;lastMask=-1;lastMaskCycle=-1;lastFaceX=-1;lastFaceZ=-1;move(_,R,E){if(this.primarySeqId!==-1&&r.instances[this.primarySeqId].seqPriority<=1)this.primarySeqId=-1;if(!_){let b=R-this.routeFlagX[0],G=E-this.routeFlagZ[0];if(b>=-8&&b<=8&&G>=-8&&G<=8){if(this.routeLength<9)this.routeLength++;for(let N=this.routeLength;N>0;N--)this.routeFlagX[N]=this.routeFlagX[N-1],this.routeFlagZ[N]=this.routeFlagZ[N-1],this.routeRun[N]=this.routeRun[N-1];this.routeFlagX[0]=R,this.routeFlagZ[0]=E,this.routeRun[0]=!1;return}}this.routeLength=0,this.seqTrigger=0,this.routeFlagX[0]=R,this.routeFlagZ[0]=E,this.x=this.routeFlagX[0]*128+this.size*64,this.z=this.routeFlagZ[0]*128+this.size*64}step(_,R){let E=this.routeFlagX[0],b=this.routeFlagZ[0];if(R===0)E--,b++;else if(R===1)b++;else if(R===2)E++,b++;else if(R===3)E--;else if(R===4)E++;else if(R===5)E--,b--;else if(R===6)b--;else if(R===7)E++,b--;if(this.primarySeqId!==-1&&r.instances[this.primarySeqId].seqPriority<=1)this.primarySeqId=-1;if(this.routeLength<9)this.routeLength++;for(let G=this.routeLength;G>0;G--)this.routeFlagX[G]=this.routeFlagX[G-1],this.routeFlagZ[G]=this.routeFlagZ[G-1],this.routeRun[G]=this.routeRun[G-1];this.routeFlagX[0]=E,this.routeFlagZ[0]=b,this.routeRun[0]=_}}class H_ extends n0{npcType=null;draw(_){if(!this.npcType)return null;if(this.spotanimId===-1||this.spotanimFrame===-1)return this.getSequencedModel();let R=this.getSequencedModel();if(!R)return null;let E=T0.instances[this.spotanimId],b=J.modelShareColored(E.getModel(),!0,!E.disposeAlpha,!1);if(b.translateModel(-this.spotanimOffset,0,0),b.createLabelReferences(),E.seq&&E.seq.seqFrames)b.applyTransform(E.seq.seqFrames[this.spotanimFrame]);if(b.labelFaces=null,b.labelVertices=null,E.resizeh!==128||E.resizev!==128)b.scale(E.resizeh,E.resizev,E.resizeh);b.calculateNormals(64+E.ambient,850+E.contrast,-30,-50,-30,!0);let G=[R,b],N=J.modelFromModelsBounds(G,2);if(this.npcType.size===1)N.pickable=!0;return N}isVisibleNow(){return this.npcType!==null}getSequencedModel(){if(!this.npcType)return null;if(this.primarySeqId>=0&&this.primarySeqDelay===0){let E=r.instances[this.primarySeqId].seqFrames;if(E){let b=E[this.primarySeqFrame],G=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){let N=r.instances[this.secondarySeqId].seqFrames;if(N)G=N[this.secondarySeqFrame]}return this.npcType.getSequencedModel(b,G,r.instances[this.primarySeqId].walkmerge)}}let _=-1;if(this.secondarySeqId>=0){let E=r.instances[this.secondarySeqId].seqFrames;if(E)_=E[this.secondarySeqFrame]}let R=this.npcType.getSequencedModel(_,-1,null);if(!R)return null;return this.maxY=R.maxY,R}}class K0 extends n0{static TORSO_RECOLORS=[9104,10275,7595,3610,7975,8526,918,38802,24466,10145,58654,5027,1457,16565,34991,25486];static DESIGN_IDK_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];static modelCache=new u0(200);name=null;playerVisible=!1;gender=0;headicons=0;appearances=new Uint16Array(12);colors=new Uint16Array(5);combatLevel=0;appearanceHashcode=0n;y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;lowMemory=!1;draw(_){if(!this.playerVisible)return null;let R=this.getSequencedModel();if(this.maxY=R.maxY,R.pickable=!0,this.lowMemory)return R;if(this.spotanimId!==-1&&this.spotanimFrame!==-1){let E=T0.instances[this.spotanimId],b=J.modelShareColored(E.getModel(),!0,!E.disposeAlpha,!1);if(b.translateModel(-this.spotanimOffset,0,0),b.createLabelReferences(),E.seq&&E.seq.seqFrames)b.applyTransform(E.seq.seqFrames[this.spotanimFrame]);if(b.labelFaces=null,b.labelVertices=null,E.resizeh!==128||E.resizev!==128)b.scale(E.resizeh,E.resizev,E.resizeh);b.calculateNormals(E.ambient+64,E.contrast+850,-30,-50,-30,!0);let G=[R,b];R=J.modelFromModelsBounds(G,2)}if(this.locModel){if(_>=this.locStopCycle)this.locModel=null;if(_>=this.locStartCycle&&_<this.locStopCycle){let E=this.locModel;if(E){if(E.translateModel(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),this.dstYaw===512)E.rotateY90(),E.rotateY90(),E.rotateY90();else if(this.dstYaw===1024)E.rotateY90(),E.rotateY90();else if(this.dstYaw===1536)E.rotateY90();let b=[R,E];if(R=J.modelFromModelsBounds(b,2),this.dstYaw===512)E.rotateY90();else if(this.dstYaw===1024)E.rotateY90(),E.rotateY90();else if(this.dstYaw===1536)E.rotateY90(),E.rotateY90(),E.rotateY90();E.translateModel(this.y-this.locOffsetY,this.x-this.locOffsetX,this.z-this.locOffsetZ)}}}return R.pickable=!0,R}isVisibleNow(){return this.playerVisible}read(_){_.pos=0,this.gender=_.g1(),this.headicons=_.g1();for(let R=0;R<12;R++){let E=_.g1();if(E===0)this.appearances[R]=0;else this.appearances[R]=(E<<8)+_.g1()}for(let R=0;R<5;R++){let E=_.g1();if(E<0||E>=K0.DESIGN_IDK_COLORS[R].length)E=0;this.colors[R]=E}if(this.seqStandId=_.g2(),this.seqStandId===65535)this.seqStandId=-1;if(this.seqTurnId=_.g2(),this.seqTurnId===65535)this.seqTurnId=-1;if(this.seqWalkId=_.g2(),this.seqWalkId===65535)this.seqWalkId=-1;if(this.seqTurnAroundId=_.g2(),this.seqTurnAroundId===65535)this.seqTurnAroundId=-1;if(this.seqTurnLeftId=_.g2(),this.seqTurnLeftId===65535)this.seqTurnLeftId=-1;if(this.seqTurnRightId=_.g2(),this.seqTurnRightId===65535)this.seqTurnRightId=-1;if(this.seqRunId=_.g2(),this.seqRunId===65535)this.seqRunId=-1;this.name=l.formatName(l.fromBase37(_.g8())),this.combatLevel=_.g1(),this.playerVisible=!0,this.appearanceHashcode=0n;for(let R=0;R<12;R++)if(this.appearanceHashcode<<=0x4n,this.appearances[R]>=256)this.appearanceHashcode+=BigInt(this.appearances[R])-256n;if(this.appearances[0]>=256)this.appearanceHashcode+=BigInt(this.appearances[0])-256n>>4n;if(this.appearances[1]>=256)this.appearanceHashcode+=BigInt(this.appearances[1])-256n>>8n;for(let R=0;R<5;R++)this.appearanceHashcode<<=0x3n,this.appearanceHashcode+=BigInt(this.colors[R]);this.appearanceHashcode<<=0x1n,this.appearanceHashcode+=BigInt(this.gender)}getHeadModel(){if(!this.playerVisible)return null;let _=new C(12,null),R=0;for(let b=0;b<12;b++){let G=this.appearances[b];if(G>=256&&G<512)_[R++]=Y0.instances[G-256].getHeadModel();if(G>=512){let N=_0.get(G-512).getHeadModel(this.gender);if(N)_[R++]=N}}let E=J.modelFromModels(_,R);for(let b=0;b<5;b++){if(this.colors[b]===0)continue;if(E.recolor(K0.DESIGN_IDK_COLORS[b][0],K0.DESIGN_IDK_COLORS[b][this.colors[b]]),b===1)E.recolor(K0.TORSO_RECOLORS[0],K0.TORSO_RECOLORS[this.colors[b]])}return E}getSequencedModel(){let _=this.appearanceHashcode,R=-1,E=-1,b=-1,G=-1;if(this.primarySeqId>=0&&this.primarySeqDelay===0){let H=r.instances[this.primarySeqId];if(H.seqFrames)R=H.seqFrames[this.primarySeqFrame];if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){let I=r.instances[this.secondarySeqId].seqFrames;if(I)E=I[this.secondarySeqFrame]}if(H.righthand>=0)b=H.righthand,_+=BigInt(b-this.appearances[5])<<8n;if(H.lefthand>=0)G=H.lefthand,_+=BigInt(G-this.appearances[3])<<16n}else if(this.secondarySeqId>=0){let H=r.instances[this.secondarySeqId].seqFrames;if(H)R=H[this.secondarySeqFrame]}let N=K0.modelCache?.get(_);if(!N){let H=new C(12,null),I=0;for(let Q=0;Q<12;Q++){let q=this.appearances[Q];if(G>=0&&Q===3)q=G;if(b>=0&&Q===5)q=b;if(q>=256&&q<512){let O=Y0.instances[q-256].getModel();if(O)H[I++]=O}if(q>=512){let U=_0.get(q-512).getWornModel(this.gender);if(U)H[I++]=U}}N=J.modelFromModels(H,I);for(let Q=0;Q<5;Q++){if(this.colors[Q]===0)continue;if(N.recolor(K0.DESIGN_IDK_COLORS[Q][0],K0.DESIGN_IDK_COLORS[Q][this.colors[Q]]),Q===1)N.recolor(K0.TORSO_RECOLORS[0],K0.TORSO_RECOLORS[this.colors[Q]])}N.createLabelReferences(),N.calculateNormals(64,850,-30,-50,-30,!0),K0.modelCache?.put(_,N)}if(this.lowMemory)return N;let L=J.modelShareAlpha(N,!0);if(R!==-1&&E!==-1)L.applyTransforms(R,E,r.instances[this.primarySeqId].walkmerge);else if(R!==-1)L.applyTransform(R);return L.calculateBoundsCylinder(),L.labelFaces=null,L.labelVertices=null,L}}class I_ extends F0{duration=-1;locIndex=0;locAngle=0;shape=0;plane=0;layer=0;x=0;z=0;lastLocIndex=0;lastAngle=0;lastShape=0;delay=0}class r0 extends F0{index;count;constructor(_,R){super();this.index=_,this.count=R}}class Q_ extends z0{spotanim;projLevel;srcX;srcZ;srcY;projOffsetY;startCycle;lastCycle;peakPitch;projArc;projTarget;mobile=!1;x=0;z=0;y=0;projVelocityX=0;projVelocityZ=0;projVelocity=0;projVelocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(_,R,E,b,G,N,L,H,I,Q,q){super();this.spotanim=T0.instances[_],this.projLevel=R,this.srcX=E,this.srcZ=G,this.srcY=b,this.startCycle=N,this.lastCycle=L,this.peakPitch=H,this.projArc=I,this.projTarget=Q,this.projOffsetY=q}updateVelocity(_,R,E,b){if(!this.mobile){let N=_-this.srcX,L=E-this.srcZ,H=Math.sqrt(N*N+L*L);this.x=this.srcX+N*this.projArc/H,this.z=this.srcZ+L*this.projArc/H,this.y=this.srcY}let G=this.lastCycle+1-b;if(this.projVelocityX=(_-this.x)/G,this.projVelocityZ=(E-this.z)/G,this.projVelocity=Math.sqrt(this.projVelocityX*this.projVelocityX+this.projVelocityZ*this.projVelocityZ),!this.mobile)this.projVelocityY=-this.projVelocity*Math.tan(this.peakPitch*0.02454369);this.accelerationY=(R-this.y-this.projVelocityY*G)*2/(G*G)}update(_){if(this.mobile=!0,this.x+=this.projVelocityX*_,this.z+=this.projVelocityZ*_,this.y+=this.projVelocityY*_+this.accelerationY*0.5*_*_,this.projVelocityY+=this.accelerationY*_,this.yaw=(Math.atan2(this.projVelocityX,this.projVelocityZ)*325.949+1024|0)&2047,this.pitch=(Math.atan2(this.projVelocityY,this.projVelocity)*325.949|0)&2047,!this.spotanim.seq||!this.spotanim.seq.seqDelay)return;this.seqCycle+=_;while(this.seqCycle>this.spotanim.seq.seqDelay[this.seqFrame])if(this.seqCycle-=this.spotanim.seq.seqDelay[this.seqFrame]+1,this.seqFrame++,this.seqFrame>=this.spotanim.seq.seqFrameCount)this.seqFrame=0}draw(){let _=this.spotanim.getModel(),R=J.modelShareColored(_,!0,!this.spotanim.disposeAlpha,!1);if(this.spotanim.seq&&this.spotanim.seq.seqFrames)R.createLabelReferences(),R.applyTransform(this.spotanim.seq.seqFrames[this.seqFrame]),R.labelFaces=null,R.labelVertices=null;if(this.spotanim.resizeh!==128||this.spotanim.resizev!==128)R.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh);return R.rotateX(this.pitch),R.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,!0),R}}class q_ extends z0{spotType;spotLevel;x;z;y;startCycle;seqComplete=!1;seqFrame=0;seqCycle=0;constructor(_,R,E,b,G,N,L){super();this.spotType=T0.instances[_],this.spotLevel=R,this.x=E,this.z=b,this.y=G,this.startCycle=N+L}update(_){if(!this.spotType.seq||!this.spotType.seq.seqDelay)return;for(this.seqCycle+=_;this.seqCycle>this.spotType.seq.seqDelay[this.seqFrame];)if(this.seqCycle-=this.spotType.seq.seqDelay[this.seqFrame]+1,this.seqFrame++,this.seqFrame>=this.spotType.seq.seqFrameCount)this.seqFrame=0,this.seqComplete=!0}draw(){let _=this.spotType.getModel(),R=J.modelShareColored(_,!0,!this.spotType.disposeAlpha,!1);if(!this.seqComplete&&this.spotType.seq&&this.spotType.seq.seqFrames)R.createLabelReferences(),R.applyTransform(this.spotType.seq.seqFrames[this.seqFrame]),R.labelFaces=null,R.labelVertices=null;if(this.spotType.resizeh!==128||this.spotType.resizev!==128)R.scale(this.spotType.resizeh,this.spotType.resizev,this.spotType.resizeh);if(this.spotType.spotAngle!==0){if(this.spotType.spotAngle===90)R.rotateY90();else if(this.spotType.spotAngle===180)R.rotateY90(),R.rotateY90();else if(this.spotType.spotAngle===270)R.rotateY90(),R.rotateY90(),R.rotateY90()}return R.calculateNormals(64+this.spotType.ambient,850+this.spotType.contrast,-30,-50,-30,!0),R}}class O_{seed;constructor(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}setSeed(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(_){return this.seed=this.seed*0x5deece66dn+0xbn&(1n<<48n)-1n,Number(this.seed)>>>48-_}}class V0 extends j0{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new O_(BigInt(Date.now()));height2d=0;static{let _=navigator.userAgent.includes("Capacitor");for(let R=0;R<256;R++){let E=V0.CHARSET.indexOf(String.fromCharCode(R));if(_){if(E>=63)E--}if(E===-1)E=74;V0.CHARCODESET[R]=E}}static fromArchive(_,R){let E=new f(_.read(R+".dat")),b=new f(_.read("index.dat"));b.pos=E.g2()+4;let G=b.g1();if(G>0)b.pos+=(G-1)*3;let N=new V0;for(let L=0;L<94;L++){N.charOffsetX[L]=b.g1(),N.charOffsetY[L]=b.g1();let H=N.charMaskWidth[L]=b.g2(),I=N.charMaskHeight[L]=b.g2(),Q=b.g1(),q=H*I;if(N.charMask[L]=new Int8Array(q),Q===0)for(let O=0;O<H*I;O++)N.charMask[L][O]=E.g1b();else if(Q===1)for(let O=0;O<H;O++)for(let U=0;U<I;U++)N.charMask[L][O+U*H]=E.g1b();if(I>N.height2d)N.height2d=I;N.charOffsetX[L]=1,N.charAdvance[L]=H+2;{let O=0;for(let U=I/7|0;U<I;U++)O+=N.charMask[L][U*H];if(O<=(I/7|0))N.charAdvance[L]--,N.charOffsetX[L]=0}{let O=0;for(let U=I/7|0;U<I;U++)O+=N.charMask[L][H+U*H-1];if(O<=(I/7|0))N.charAdvance[L]--}}N.charAdvance[94]=N.charAdvance[8];for(let L=0;L<256;L++)N.drawWidth[L]=N.charAdvance[V0.CHARCODESET[L]];return N}drawString(_,R,E,b){if(!E)return;_|=0,R|=0;let G=E.length;R-=this.height2d;for(let N=0;N<G;N++){let L=V0.CHARCODESET[E.charCodeAt(N)];if(L!==94)this.drawChar(this.charMask[L],_+this.charOffsetX[L],R+this.charOffsetY[L],this.charMaskWidth[L],this.charMaskHeight[L],b);_+=this.charAdvance[L]}}drawStringTaggable(_,R,E,b,G){_|=0,R|=0;let N=E.length;R-=this.height2d;for(let L=0;L<N;L++)if(E.charAt(L)==="@"&&L+4<N&&E.charAt(L+4)==="@")b=this.evaluateTag(E.substring(L+1,L+4)),L+=4;else{let H=V0.CHARCODESET[E.charCodeAt(L)];if(H!==94){if(G)this.drawChar(this.charMask[H],_+this.charOffsetX[H]+1,R+this.charOffsetY[H]+1,this.charMaskWidth[H],this.charMaskHeight[H],0);this.drawChar(this.charMask[H],_+this.charOffsetX[H],R+this.charOffsetY[H],this.charMaskWidth[H],this.charMaskHeight[H],b)}_+=this.charAdvance[H]}}stringWidth(_){if(!_)return 0;let R=_.length,E=0;for(let b=0;b<R;b++)if(_.charAt(b)==="@"&&b+4<R&&_.charAt(b+4)==="@")b+=4;else E+=this.drawWidth[_.charCodeAt(b)];return E}drawStringTaggableCenter(_,R,E,b,G){_|=0,R|=0,this.drawStringTaggable(_-(this.stringWidth(E)/2|0),R,E,b,G)}drawStringCenter(_,R,E,b){if(!E)return;_|=0,R|=0,this.drawString(_-(this.stringWidth(E)/2|0),R,E,b)}drawStringTooltip(_,R,E,b,G,N){_|=0,R|=0,this.random.setSeed(BigInt(N));let L=(this.random.nextInt()&31)+192,H=R-this.height2d;for(let I=0;I<E.length;I++)if(E.charAt(I)==="@"&&I+4<E.length&&E.charAt(I+4)==="@")b=this.evaluateTag(E.substring(I+1,I+4)),I+=4;else{let Q=V0.CHARCODESET[E.charCodeAt(I)];if(Q!==94){if(G)this.drawCharAlpha(_+this.charOffsetX[Q]+1,H+this.charOffsetY[Q]+1,this.charMaskWidth[Q],this.charMaskHeight[Q],0,192,this.charMask[Q]);this.drawCharAlpha(_+this.charOffsetX[Q],H+this.charOffsetY[Q],this.charMaskWidth[Q],this.charMaskHeight[Q],b,L,this.charMask[Q])}if(_+=this.charAdvance[Q],(this.random.nextInt()&3)===0)_++}}drawStringRight(_,R,E,b,G=!0){if(_|=0,R|=0,G)this.drawString(_-this.stringWidth(E)+1,R+1,E,0);this.drawString(_-this.stringWidth(E),R,E,b)}drawCenteredWave(_,R,E,b,G){if(!E)return;_|=0,R|=0,_-=this.stringWidth(E)/2|0;let N=R-this.height2d;for(let L=0;L<E.length;L++){let H=V0.CHARCODESET[E.charCodeAt(L)];if(H!=94)this.drawChar(this.charMask[H],_+this.charOffsetX[H],N+this.charOffsetY[H]+(Math.sin(L/2+G/5)*5|0),this.charMaskWidth[H],this.charMaskHeight[H],b);_+=this.charAdvance[H]}}drawChar(_,R,E,b,G,N){R|=0,E|=0,b|=0,G|=0;let L=R+E*T.width2d,H=T.width2d-b,I=0,Q=0;if(E<T.top){let q=T.top-E;G-=q,E=T.top,Q+=q*b,L+=q*T.width2d}if(E+G>=T.bottom)G-=E+G+1-T.bottom;if(R<T.left){let q=T.left-R;b-=q,R=T.left,Q+=q,L+=q,I+=q,H+=q}if(R+b>=T.right){let q=R+b+1-T.right;b-=q,I+=q,H+=q}if(b>0&&G>0)this.drawMask(b,G,_,Q,I,T.pixels,L,H,N)}drawCharAlpha(_,R,E,b,G,N,L){_|=0,R|=0,E|=0,b|=0;let H=_+R*T.width2d,I=T.width2d-E,Q=0,q=0;if(R<T.top){let O=T.top-R;b-=O,R=T.top,q+=O*E,H+=O*T.width2d}if(R+b>=T.bottom)b-=R+b+1-T.bottom;if(_<T.left){let O=T.left-_;E-=O,_=T.left,q+=O,H+=O,Q+=O,I+=O}if(_+E>=T.right){let O=_+E+1-T.right;E-=O,Q+=O,I+=O}if(E>0&&b>0)this.drawMaskAlpha(E,b,T.pixels,H,I,L,q,Q,G,N)}drawMask(_,R,E,b,G,N,L,H,I){_|=0,R|=0;let Q=-(_>>2);_=-(_&3);for(let q=-R;q<0;q++){for(let O=Q;O<0;O++){if(E[b++]===0)L++;else N[L++]=I;if(E[b++]===0)L++;else N[L++]=I;if(E[b++]===0)L++;else N[L++]=I;if(E[b++]===0)L++;else N[L++]=I}for(let O=_;O<0;O++)if(E[b++]===0)L++;else N[L++]=I;L+=H,b+=G}}drawMaskAlpha(_,R,E,b,G,N,L,H,I,Q){_|=0,R|=0;let q=((I&16711935)*Q&4278255360)+((I&65280)*Q&16711680)>>8,O=256-Q;for(let U=-R;U<0;U++){for(let $=-_;$<0;$++)if(N[L++]===0)b++;else{let K=E[b];E[b++]=(((K&16711935)*O&4278255360)+((K&65280)*O&16711680)>>8)+q}b+=G,L+=H}}evaluateTag(_){if(_==="red")return 16711680;else if(_==="gre")return 65280;else if(_==="blu")return 255;else if(_==="yel")return 16776960;else if(_==="cya")return 65535;else if(_==="mag")return 16711935;else if(_==="whi")return 16777215;else if(_==="bla")return 0;else if(_==="lre")return 16748608;else if(_==="dre")return 8388608;else if(_==="dbl")return 128;else if(_==="or1")return 16756736;else if(_==="or2")return 16740352;else if(_==="or3")return 16723968;else if(_==="gr1")return 12648192;else if(_==="gr2")return 8453888;else if(_==="gr3")return 4259584;else return 0}split(_,R){if(_.length===0)return[_];let E=[];while(_.length>0){if(this.stringWidth(_)<=R&&_.indexOf("|")===-1){E.push(_);break}let G=_.length;for(let N=0;N<_.length;N++)if(_[N]===" "){if(this.stringWidth(_.substring(0,N))>R)break;G=N}else if(_[N]==="|"){G=N;break}E.push(_.substring(0,G)),_=_.substring(G+1)}return E}}class y0{socket;wsin;wsout;closed=!1;ioerror=!1;static async openSocket(_,R){return await new Promise((E,b)=>{let N=new WebSocket(`${R?"wss":"ws"}://${_}`,"binary");N.addEventListener("open",()=>{E(N)}),N.addEventListener("error",()=>{b(N)})})}constructor(_){_.onclose=this.onclose,_.onerror=this.onerror,this.wsin=new X_(_,5000),this.wsout=new Z_(_,5000),this.socket=_}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(_,R){if(!this.closed)this.wsout.write(_,R)}async read(){return this.closed?0:await this.wsin.read()}async readBytes(_,R,E){if(this.closed)return;await this.wsin.readBytes(_,R,E)}close(){this.closed=!0,this.socket.close(),this.wsin.close(),this.wsout.close()}onclose=(_)=>{if(this.closed)return;this.close()};onerror=(_)=>{if(this.closed)return;this.ioerror=!0,this.close()}}class Z_{socket;limit;closed=!1;ioerror=!1;constructor(_,R){this.socket=_,this.limit=R}write(_,R){if(this.closed)return;if(this.ioerror)throw this.ioerror=!1,new Error;if(R>this.limit||_.length>this.limit)throw new Error;try{this.socket.send(_.slice(0,R))}catch(E){this.ioerror=!0}}close(){this.closed=!0}}class A_{bytes;position;constructor(_){this.bytes=_,this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class X_{limit;queue=[];event=null;callback=null;closed=!1;total=0;constructor(_,R){this.limit=R,_.binaryType="arraybuffer",_.onmessage=this.onmessage}get available(){return this.total}onmessage=(_)=>{if(this.closed)throw new Error;let R=new A_(new Uint8Array(_.data));if(this.total+=R.available,this.callback){let E=this.callback;this.callback=null,E(R)}else this.queue.push(R)};async read(){if(this.closed)throw new Error;return await Promise.race([new Promise((_)=>{if(!this.event||this.event.available===0)this.event=this.queue.shift()??null;if(this.event&&this.event.available>0)_(this.event.read),this.total--;else this.callback=(R)=>{this.event=R,this.total--,_(R.read)}}),new Promise((_,R)=>{setTimeout(()=>{if(this.closed)R(new Error);else R(new Error)},20000)})])}async readBytes(_,R,E){if(this.closed)throw new Error;for(let b=0;b<E;b++)_[R+b]=await this.read();return _}close(){this.closed=!0,this.callback=null,this.event=null,this.queue=[]}}class x0{db;constructor(_){_.onerror=this.onerror,_.onclose=this.onclose,this.db=_}static async openDatabase(){return await new Promise((_,R)=>{let E=indexedDB.open("lostcity",1);E.onsuccess=(b)=>{let G=b.target;_(G.result)},E.onupgradeneeded=(b)=>{b.target.result.createObjectStore("cache")},E.onerror=(b)=>{let G=b.target;R(G.result)}})}async cacheload(_){return await new Promise((R)=>{let G=this.db.transaction("cache","readonly").objectStore("cache").get(_);G.onsuccess=()=>{if(G.result)R(new Uint8Array(G.result));else R(void 0)},G.onerror=()=>{R(void 0)}})}async cachesave(_,R){if(R===null)return;return await new Promise((E,b)=>{let L=this.db.transaction("cache","readwrite").objectStore("cache").put(R,_);L.onsuccess=()=>{E()},L.onerror=()=>{E()}})}onclose=(_)=>{};onerror=(_)=>{}}class i0{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(_){for(let R=0;R<_.length;R++)this.rsl[R]=_[R];this.init()}get nextInt(){if(this.count--===0)this.isaac(),this.count=255;return this.rsl[this.count]}init(){let _=2654435769,R=2654435769,E=2654435769,b=2654435769,G=2654435769,N=2654435769,L=2654435769,H=2654435769;for(let I=0;I<4;I++)_^=R<<11,b+=_,R+=E,R^=E>>>2,G+=R,E+=b,E^=b<<8,N+=E,b+=G,b^=G>>>16,L+=b,G+=N,G^=N<<10,H+=G,N+=L,N^=L>>>4,_+=N,L+=H,L^=H<<8,R+=L,H+=_,H^=_>>>9,E+=H,_+=R;for(let I=0;I<256;I+=8)_+=this.rsl[I],R+=this.rsl[I+1],E+=this.rsl[I+2],b+=this.rsl[I+3],G+=this.rsl[I+4],N+=this.rsl[I+5],L+=this.rsl[I+6],H+=this.rsl[I+7],_^=R<<11,b+=_,R+=E,R^=E>>>2,G+=R,E+=b,E^=b<<8,N+=E,b+=G,b^=G>>>16,L+=b,G+=N,G^=N<<10,H+=G,N+=L,N^=L>>>4,_+=N,L+=H,L^=H<<8,R+=L,H+=_,H^=_>>>9,E+=H,_+=R,this.mem[I]=_,this.mem[I+1]=R,this.mem[I+2]=E,this.mem[I+3]=b,this.mem[I+4]=G,this.mem[I+5]=N,this.mem[I+6]=L,this.mem[I+7]=H;for(let I=0;I<256;I+=8)_+=this.mem[I],R+=this.mem[I+1],E+=this.mem[I+2],b+=this.mem[I+3],G+=this.mem[I+4],N+=this.mem[I+5],L+=this.mem[I+6],H+=this.mem[I+7],_^=R<<11,b+=_,R+=E,R^=E>>>2,G+=R,E+=b,E^=b<<8,N+=E,b+=G,b^=G>>>16,L+=b,G+=N,G^=N<<10,H+=G,N+=L,N^=L>>>4,_+=N,L+=H,L^=H<<8,R+=L,H+=_,H^=_>>>9,E+=H,_+=R,this.mem[I]=_,this.mem[I+1]=R,this.mem[I+2]=E,this.mem[I+3]=b,this.mem[I+4]=G,this.mem[I+5]=N,this.mem[I+6]=L,this.mem[I+7]=H;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let _=0;_<256;_++){let R=this.mem[_],E=_&3;if(E===0)this.a^=this.a<<13;else if(E===1)this.a^=this.a>>>6;else if(E===2)this.a^=this.a<<2;else if(E===3)this.a^=this.a>>>16;this.a+=this.mem[_+128&255];let b;this.mem[_]=b=this.mem[R>>>2&255]+this.a+this.b,this.rsl[_]=this.b=this.mem[b>>>8>>>2&255]+R}}}import{BZip2 as W_}from"./deps.js";class s0{static genHash(_){let R=0;_=_.toUpperCase();for(let E=0;E<_.length;E++)R=R*61+_.charCodeAt(E)-32|0;return R}jagSrc;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(_){let R=new f(new Uint8Array(_)),E=R.g3(),b=R.g3();if(E===b)this.jagSrc=_,this.compressedWhole=!1;else this.jagSrc=W_.decompress(_.subarray(6),E,!0),R=new f(new Uint8Array(this.jagSrc)),this.compressedWhole=!0;this.fileCount=R.g2(),this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let G=R.pos+this.fileCount*10;for(let N=0;N<this.fileCount;N++)this.fileHash.push(R.g4()),this.fileUnpackedSize.push(R.g3()),this.filePackedSize.push(R.g3()),this.fileOffset.push(G),G+=this.filePackedSize[N]}read(_){let R=s0.genHash(_),E=this.fileHash.indexOf(R);if(E===-1)return null;return this.readIndex(E)}readIndex(_){if(_<0||_>=this.fileCount)return null;if(this.fileUnpacked[_])return this.fileUnpacked[_];let R=this.fileOffset[_],E=R+this.filePackedSize[_],b=new Uint8Array(this.jagSrc.subarray(R,R+E));if(this.compressedWhole)return this.fileUnpacked[_]=b,b;else{let G=W_.decompress(b,this.fileUnpackedSize[_],!0);return this.fileUnpacked[_]=G,G}}}var M_=[0,-2,4,6,-1,0,0,2,0,0,0,0,5,4,2,2,0,0,0,0,2,-2,2,14,0,6,3,0,4,0,0,0,3,0,0,0,0,0,0,0,0,-1,4,2,6,0,6,0,0,3,7,0,0,0,-1,0,0,0,0,4,0,0,0,0,0,0,0,0,1,15,0,0,0,0,6,0,2,0,0,0,2,0,0,0,1,0,0,4,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,-2,0,0,2,0,0,0,2,9,0,0,0,0,0,4,0,0,0,3,7,9,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,3,2,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,-2,2,0,0,0,0,0,6,0,0,0,2,0,2,0,0,0,-2,0,0,4,0,0,0,0,6,0,0,-2,-2,0,0,0,0,0,0,-2,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0];class P0{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((_)=>_.charCodeAt(0)));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((_)=>_.charCodeAt(0)));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((_)=>_.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack(_){let R=new f(_.read("fragmentsenc.txt")),E=new f(_.read("badenc.txt")),b=new f(_.read("domainenc.txt")),G=new f(_.read("tldlist.txt"));this.read(E,b,R,G)}static filter(_){let R=[..._];this.format(R);let E=R.join("").trim(),b=E.toLowerCase(),G=[...b];this.filterTlds(G),this.filterBadWords(G),this.filterDomains(G),this.filterFragments(G);for(let N=0;N<this.whitelist.length;N++){let L=-1;while((L=b.indexOf(this.whitelist[N],L+1))!==-1){let H=[...this.whitelist[N]];for(let I=0;I<H.length;I++)G[I+L]=H[I]}}return this.replaceUppercases(G,[...E]),this.formatUppercases(G),G.join("").trim()}static read(_,R,E,b){this.readBadWords(_),this.readDomains(R),this.readFragments(E),this.readTld(b)}static readTld(_){let R=_.g4();for(let E=0;E<R;E++)this.tldTypes[E]=_.g1(),this.tlds[E]=new Uint16Array(_.g1()).map(()=>_.g1())}static readBadWords(_){let R=_.g4();for(let E=0;E<R;E++){this.bads[E]=new Uint16Array(_.g1()).map(()=>_.g1());let b=new Array(_.g1()).fill([]).map(()=>[_.g1b(),_.g1b()]);if(b.length>0)this.badCombinations[E]=b}}static readDomains(_){let R=_.g4();for(let E=0;E<R;E++)this.domains[E]=new Uint16Array(_.g1()).map(()=>_.g1())}static readFragments(_){let R=_.g4();for(let E=0;E<R;E++)this.fragments[E]=_.g2()}static filterTlds(_){let R=[..._],E=[..._];this.filterBadCombinations(null,R,this.PERIOD),this.filterBadCombinations(null,E,this.SLASH);for(let b=0;b<this.tlds.length;b++)this.filterTld(E,this.tldTypes[b],_,this.tlds[b],R)}static filterBadWords(_){for(let R=0;R<2;R++)for(let E=this.bads.length-1;E>=0;E--)this.filterBadCombinations(this.badCombinations[E],_,this.bads[E])}static filterDomains(_){let R=[..._],E=[..._];this.filterBadCombinations(null,R,this.AMPERSAT),this.filterBadCombinations(null,E,this.PERIOD);for(let b=this.domains.length-1;b>=0;b--)this.filterDomain(E,R,this.domains[b],_)}static filterFragments(_){for(let R=0;R<_.length;){let E=this.indexOfNumber(_,R);if(E===-1)return;let b=!1;for(let L=R;L>=0&&L<E&&!b;L++)if(!this.isSymbol(_[L])&&!this.isNotLowercaseAlpha(_[L]))b=!0;let G=0;if(b)G=0;if(G===0)G=1,R=E;let N=0;for(let L=E;L<_.length&&L<R;L++)N=N*10+_[L].charCodeAt(0)-48;if(N<=255&&R-E<=8)G++;else G=0;if(G===4)this.maskChars(E,R,_),G=0;R=this.indexOfNonNumber(R,_)}}static isBadFragment(_){if(this.isNumericalChars(_))return!0;let R=this.getInteger(_),E=this.fragments,b=E.length;if(R===E[0]||R===E[b-1])return!0;let G=0,N=b-1;while(G<=N){let L=(G+N)/2|0;if(R===E[L])return!0;else if(R<E[L])N=L-1;else G=L+1}return!1}static getInteger(_){if(_.length>6)return 0;let R=0;for(let E=0;E<_.length;E++){let b=_[_.length-E-1];if(this.isLowercaseAlpha(b))R=R*38+b.charCodeAt(0)+1-97;else if(b==="'")R=R*38+27;else if(this.isNumerical(b))R=R*38+b.charCodeAt(0)+28-48;else if(b!=="\x00")return 0}return R}static indexOfNumber(_,R){for(let E=R;E<_.length&&E>=0;E++)if(this.isNumerical(_[E]))return E;return-1}static indexOfNonNumber(_,R){for(let E=_;E<R.length&&E>=0;E++)if(!this.isNumerical(R[E]))return E;return R.length}static getEmulatedDomainCharLen(_,R,E){if(R===E)return 1;else if(R==="o"&&E==="0")return 1;else if(R==="o"&&E==="("&&_===")")return 2;else if(R==="c"&&(E==="("||E==="<"||E==="["))return 1;else if(R==="e"&&E==="€")return 1;else if(R==="s"&&E==="$")return 1;else if(R==="l"&&E==="i")return 1;return 0}static filterDomain(_,R,E,b){let G=E.length,N=b.length;for(let L=0;L<=N-G;L++){let{matched:H,currentIndex:I}=this.findMatchingDomain(L,E,b);if(!H)continue;let Q=this.prefixSymbolStatus(L,b,3,R,["@"]),q=this.suffixSymbolStatus(I-1,b,3,_,[".",","]);if(!(Q>2||q>2))continue;this.maskChars(L,I,b)}}static findMatchingDomain(_,R,E){let b=R.length,G=_,N=0;while(G<E.length&&N<b){let L=E[G],H=G+1<E.length?E[G+1]:"\x00",I=this.getEmulatedDomainCharLen(H,String.fromCharCode(R[N]),L);if(I>0)G+=I,N++;else{if(N===0)break;let Q=this.getEmulatedDomainCharLen(H,String.fromCharCode(R[N-1]),L);if(Q>0){if(G+=Q,N===1)_++}else{if(N>=b||!this.isSymbol(L))break;G++}}}return{matched:N>=b,currentIndex:G}}static filterBadCombinations(_,R,E){if(E.length>R.length)return;for(let b=0;b<=R.length-E.length;b++){let G=b,{currentIndex:N,badIndex:L,hasSymbol:H,hasNumber:I,hasDigit:Q}=this.processBadCharacters(R,E,G);G=N;let q=R[G],O=G+1<R.length?R[G+1]:"\x00";if(!(L>=E.length&&(!I||!Q)))continue;let U=!0,$;if(H){let F=!1,k=!1;if(b-1<0||this.isSymbol(R[b-1])&&R[b-1]!=="'")F=!0;if(G>=R.length||this.isSymbol(R[G])&&R[G]!=="'")k=!0;if(!F||!k){let j=!1;if($=b-2,F)$=b;while(!j&&$<G){if($>=0&&(!this.isSymbol(R[$])||R[$]==="'")){let m=[],Y;for(Y=0;Y<3&&$+Y<R.length&&(!this.isSymbol(R[$+Y])||R[$+Y]==="'");Y++)m[Y]=R[$+Y];let X=!0;if(Y===0)X=!1;if(Y<3&&$-1>=0&&(!this.isSymbol(R[$-1])||R[$-1]==="'"))X=!1;if(X&&!this.isBadFragment(m))j=!0}$++}if(!j)U=!1}}else{if(q=" ",b-1>=0)q=R[b-1];if(O=" ",G<R.length)O=R[G];let F=this.getIndex(q),k=this.getIndex(O);if(_&&this.comboMatches(F,_,k))U=!1}if(!U)continue;let K=0,u=0;for(let F=b;F<G;F++)if(this.isNumerical(R[F]))K++;else if(this.isAlpha(R[F]))u++;if(K<=u)this.maskChars(b,G,R)}}static processBadCharacters(_,R,E){let b=E,G=0,N=0,L=!1,H=!1,I=!1;for(;b<_.length&&!(H&&I);){if(b>=_.length||H&&I)break;let Q=_[b],q=b+1<_.length?_[b+1]:"\x00",O;if(G<R.length&&(O=this.getEmulatedBadCharLen(q,String.fromCharCode(R[G]),Q))>0){if(O===1&&this.isNumerical(Q))H=!0;if(O===2&&(this.isNumerical(Q)||this.isNumerical(q)))H=!0;b+=O,G++}else{if(G===0)break;let U;if((U=this.getEmulatedBadCharLen(q,String.fromCharCode(R[G-1]),Q))>0)b+=U;else{if(G>=R.length||!this.isNotLowercaseAlpha(Q))break;if(this.isSymbol(Q)&&Q!=="'")L=!0;if(this.isNumerical(Q))I=!0;if(b++,N++,(N*100/(b-E)|0)>90)break}}}return{currentIndex:b,badIndex:G,hasSymbol:L,hasNumber:H,hasDigit:I}}static getEmulatedBadCharLen(_,R,E){if(R===E)return 1;if(R>="a"&&R<="m"){if(R==="a"){if(E!=="4"&&E!=="@"&&E!=="^"){if(E==="/"&&_==="\\")return 2;return 0}return 1}if(R==="b"){if(E!=="6"&&E!=="8"){if(E==="1"&&_==="3")return 2;return 0}return 1}if(R==="c"){if(E!=="("&&E!=="<"&&E!=="{"&&E!=="[")return 0;return 1}if(R==="d"){if(E==="["&&_===")")return 2;return 0}if(R==="e"){if(E!=="3"&&E!=="€")return 0;return 1}if(R==="f"){if(E==="p"&&_==="h")return 2;if(E==="£")return 1;return 0}if(R==="g"){if(E!=="9"&&E!=="6")return 0;return 1}if(R==="h"){if(E==="#")return 1;return 0}if(R==="i"){if(E!=="y"&&E!=="l"&&E!=="j"&&E!=="1"&&E!=="!"&&E!==":"&&E!==";"&&E!=="|")return 0;return 1}if(R==="j")return 0;if(R==="k")return 0;if(R==="l"){if(E!=="1"&&E!=="|"&&E!=="i")return 0;return 1}if(R==="m")return 0}if(R>="n"&&R<="z"){if(R==="n")return 0;if(R==="o"){if(E!=="0"&&E!=="*"){if((E!=="("||_!==")")&&(E!=="["||_!=="]")&&(E!=="{"||_!=="}")&&(E!=="<"||_!==">"))return 0;return 2}return 1}if(R==="p")return 0;if(R==="q")return 0;if(R==="r")return 0;if(R==="s"){if(E!=="5"&&E!=="z"&&E!=="$"&&E!=="2")return 0;return 1}if(R==="t"){if(E!=="7"&&E!=="+")return 0;return 1}if(R==="u"){if(E==="v")return 1;if((E!=="\\"||_!=="/")&&(E!=="\\"||_!=="|")&&(E!=="|"||_!=="/"))return 0;return 2}if(R==="v"){if((E!=="\\"||_!=="/")&&(E!=="\\"||_!=="|")&&(E!=="|"||_!=="/"))return 0;return 2}if(R==="w"){if(E==="v"&&_==="v")return 2;return 0}if(R==="x"){if((E!==")"||_!=="(")&&(E!=="}"||_!=="{")&&(E!=="]"||_!=="[")&&(E!==">"||_!=="<"))return 0;return 2}if(R==="y")return 0;if(R==="z")return 0}if(R>="0"&&R<="9")if(R==="0")if(E==="o"||E==="O")return 1;else if((E!=="("||_!==")")&&(E!=="{"||_!=="}")&&(E!=="["||_!=="]"))return 0;else return 2;else if(R==="1")return E==="l"?1:0;else return 0;else if(R===",")return E==="."?1:0;else if(R===".")return E===","?1:0;else if(R==="!")return E==="i"?1:0;return 0}static comboMatches(_,R,E){let b=0,G=R.length-1;while(b<=G){let N=(b+G)/2|0;if(R[N][0]===_&&R[N][1]===E)return!0;else if(_<R[N][0]||_===R[N][0]&&E<R[N][1])G=N-1;else b=N+1}return!1}static getIndex(_){if(this.isLowercaseAlpha(_))return _.charCodeAt(0)+1-97;else if(_==="'")return 28;else if(this.isNumerical(_))return _.charCodeAt(0)+29-48;return 27}static filterTld(_,R,E,b,G){if(b.length>E.length)return;for(let N=0;N<=E.length-b.length;N++){let{currentIndex:L,tldIndex:H}=this.processTlds(E,b,N);if(H<b.length)continue;let I=!1,Q=this.prefixSymbolStatus(N,E,3,G,[",","."]),q=this.suffixSymbolStatus(L-1,E,5,_,["\\","/"]);if(R===1&&Q>0&&q>0)I=!0;if(R===2&&(Q>2&&q>0||Q>0&&q>2))I=!0;if(R===3&&Q>0&&q>2)I=!0;if(!I)continue;let O=N,U=L-1,$=!1,K;if(Q>2){if(Q===4){$=!1;for(K=N-1;K>=0;K--)if($){if(G[K]!=="*")break;O=K}else if(G[K]==="*")O=K,$=!0}$=!1;for(K=O-1;K>=0;K--)if($){if(this.isSymbol(E[K]))break;O=K}else if(!this.isSymbol(E[K]))$=!0,O=K}if(q>2){if(q===4){$=!1;for(K=U+1;K<E.length;K++)if($){if(_[K]!=="*")break;U=K}else if(_[K]==="*")U=K,$=!0}$=!1;for(K=U+1;K<E.length;K++)if($){if(this.isSymbol(E[K]))break;U=K}else if(!this.isSymbol(E[K]))$=!0,U=K}this.maskChars(O,U+1,E)}}static processTlds(_,R,E){let b=0;while(E<_.length&&b<R.length){let G=_[E],N=E+1<_.length?_[E+1]:"\x00",L;if((L=this.getEmulatedDomainCharLen(N,String.fromCharCode(R[b]),G))>0)E+=L,b++;else{if(b===0)break;let H;if((H=this.getEmulatedDomainCharLen(N,String.fromCharCode(R[b-1]),G))>0)E+=H;else{if(!this.isSymbol(G))break;E++}}}return{currentIndex:E,tldIndex:b}}static isSymbol(_){return!this.isAlpha(_)&&!this.isNumerical(_)}static isNotLowercaseAlpha(_){return this.isLowercaseAlpha(_)?_==="v"||_==="x"||_==="j"||_==="q"||_==="z":!0}static isAlpha(_){return this.isLowercaseAlpha(_)||this.isUppercaseAlpha(_)}static isNumerical(_){return _>="0"&&_<="9"}static isLowercaseAlpha(_){return _>="a"&&_<="z"}static isUppercaseAlpha(_){return _>="A"&&_<="Z"}static isNumericalChars(_){for(let R=0;R<_.length;R++)if(!this.isNumerical(_[R])&&_[R]!=="\x00")return!1;return!0}static maskChars(_,R,E){for(let b=_;b<R;b++)E[b]="*"}static maskedCountBackwards(_,R){let E=0;for(let b=R-1;b>=0&&this.isSymbol(_[b]);b--)if(_[b]==="*")E++;return E}static maskedCountForwards(_,R){let E=0;for(let b=R+1;b<_.length&&this.isSymbol(_[b]);b++)if(_[b]==="*")E++;return E}static maskedCharsStatus(_,R,E,b,G){if((G?this.maskedCountBackwards(R,E):this.maskedCountForwards(R,E))>=b)return 4;else if(this.isSymbol(G?_[E-1]:_[E+1]))return 1;return 0}static prefixSymbolStatus(_,R,E,b,G){if(_===0)return 2;for(let N=_-1;N>=0&&this.isSymbol(R[N]);N--)if(G.includes(R[N]))return 3;return this.maskedCharsStatus(R,b,_,E,!0)}static suffixSymbolStatus(_,R,E,b,G){if(_+1===R.length)return 2;for(let N=_+1;N<R.length&&this.isSymbol(R[N]);N++)if(G.includes(R[N]))return 3;return this.maskedCharsStatus(R,b,_,E,!1)}static format(_){let R=0;for(let E=0;E<_.length;E++){if(this.isCharacterAllowed(_[E]))_[R]=_[E];else _[R]=" ";if(R===0||_[R]!==" "||_[R-1]!==" ")R++}for(let E=R;E<_.length;E++)_[E]=" "}static isCharacterAllowed(_){return _>=" "&&_<=""||_===" "||_===`
`||_==="\t"||_==="£"||_==="€"}static replaceUppercases(_,R){for(let E=0;E<R.length;E++)if(_[E]!=="*"&&this.isUppercaseAlpha(R[E]))_[E]=R[E]}static formatUppercases(_){let R=!0;for(let E=0;E<_.length;E++){let b=_[E];if(!this.isAlpha(b))R=!0;else if(R){if(this.isLowercaseAlpha(b))R=!1}else if(this.isUppercaseAlpha(b))_[E]=String.fromCharCode(b.charCodeAt(0)+97-65)}}}class f0{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","£","$","%",'"',"[","]"];static charBuffer=[];static unpack(_,R){let E=0,b=-1,G;for(let L=0;L<R&&E<100;L++){let H=_.g1();if(G=H>>4&15,b!==-1)this.charBuffer[E++]=this.TABLE[(b<<4)+G-195],b=-1;else if(G<13)this.charBuffer[E++]=this.TABLE[G];else b=G;if(G=H&15,b!==-1)this.charBuffer[E++]=this.TABLE[(b<<4)+G-195],b=-1;else if(G<13)this.charBuffer[E++]=this.TABLE[G];else b=G}let N=!0;for(let L=0;L<E;L++){let H=this.charBuffer[L];if(N&&H>="a"&&H<="z")this.charBuffer[L]=H.toUpperCase(),N=!1;if(H==="."||H==="!")N=!0}return this.charBuffer.slice(0,E).join("")}static pack(_,R){if(R.length>80)R=R.substring(0,80);R=R.toLowerCase();let E=-1;for(let b=0;b<R.length;b++){let G=R.charAt(b),N=0;for(let L=0;L<this.TABLE.length;L++)if(G===this.TABLE[L]){N=L;break}if(N>12)N+=195;if(E===-1)if(N<13)E=N;else _.p1(N);else if(N<13)_.p1((E<<4)+N),E=-1;else _.p1((E<<4)+(N>>4)),E=N&15}if(E!==-1)_.p1(E<<4)}}class W0{start=0;end=0;form=0;envLength=0;shapeDelta=null;shapePeak=null;envThreshold=0;envPosition=0;delta=0;envAmplitude=0;ticks=0;read(_){this.form=_.g1(),this.start=_.g4(),this.end=_.g4(),this.envLength=_.g1(),this.shapeDelta=new Int32Array(this.envLength),this.shapePeak=new Int32Array(this.envLength);for(let R=0;R<this.envLength;R++)this.shapeDelta[R]=_.g2(),this.shapePeak[R]=_.g2()}reset(){this.envThreshold=0,this.envPosition=0,this.delta=0,this.envAmplitude=0,this.ticks=0}evaluateAt(_){if(this.ticks>=this.envThreshold&&this.shapePeak&&this.shapeDelta){if(this.envAmplitude=this.shapePeak[this.envPosition++]<<15,this.envPosition>=this.envLength)this.envPosition=this.envLength-1;if(this.envThreshold=this.shapeDelta[this.envPosition]/65536*_|0,this.envThreshold>this.ticks)this.delta=((this.shapePeak[this.envPosition]<<15)-this.envAmplitude)/(this.envThreshold-this.ticks)|0}return this.envAmplitude+=this.delta,this.ticks++,this.envAmplitude-this.delta>>15}}class L0{static toneSrc=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;envRelease=null;envAttack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);toneStart=0;toneLength=500;reverbVolume=100;reverbDelay=0;static init(){this.noise=new Int32Array(32768);for(let _=0;_<32768;_++)if(Math.random()>0.5)this.noise[_]=1;else this.noise[_]=-1;this.sin=new Int32Array(32768);for(let _=0;_<32768;_++)this.sin[_]=Math.sin(_/5215.1903)*16384|0;this.toneSrc=new Int32Array(220500)}generate(_,R){for(let Q=0;Q<_;Q++)L0.toneSrc[Q]=0;if(R<10)return L0.toneSrc;let E=_/R|0;this.frequencyBase?.reset(),this.amplitudeBase?.reset();let b=0,G=0,N=0;if(this.frequencyModRate&&this.frequencyModRange)this.frequencyModRate.reset(),this.frequencyModRange.reset(),b=(this.frequencyModRate.end-this.frequencyModRate.start)*32.768/E|0,G=this.frequencyModRate.start*32.768/E|0;let L=0,H=0,I=0;if(this.amplitudeModRate&&this.amplitudeModRange)this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),L=(this.amplitudeModRate.end-this.amplitudeModRate.start)*32.768/E|0,H=this.amplitudeModRate.start*32.768/E|0;for(let Q=0;Q<5;Q++)if(this.frequencyBase&&this.harmonicVolume[Q]!==0)L0.tmpPhases[Q]=0,L0.tmpDelays[Q]=this.harmonicDelay[Q]*E,L0.tmpVolumes[Q]=(this.harmonicVolume[Q]<<14)/100|0,L0.tmpSemitones[Q]=(this.frequencyBase.end-this.frequencyBase.start)*32.768*Math.pow(1.0057929410678534,this.harmonicSemitone[Q])/E|0,L0.tmpStarts[Q]=this.frequencyBase.start*32.768/E|0;if(this.frequencyBase&&this.amplitudeBase)for(let Q=0;Q<_;Q++){let q=this.frequencyBase.evaluateAt(_),O=this.amplitudeBase.evaluateAt(_);if(this.frequencyModRate&&this.frequencyModRange){let U=this.frequencyModRate.evaluateAt(_),$=this.frequencyModRange.evaluateAt(_);q+=this.generate2($,N,this.frequencyModRate.form)>>1,N+=(U*b>>16)+G}if(this.amplitudeModRate&&this.amplitudeModRange){let U=this.amplitudeModRate.evaluateAt(_),$=this.amplitudeModRange.evaluateAt(_);O=O*((this.generate2($,I,this.amplitudeModRate.form)>>1)+32768)>>15,I+=(U*L>>16)+H}for(let U=0;U<5;U++)if(this.harmonicVolume[U]!==0){let $=Q+L0.tmpDelays[U];if($<_)L0.toneSrc[$]+=this.generate2(O*L0.tmpVolumes[U]>>15,L0.tmpPhases[U],this.frequencyBase.form),L0.tmpPhases[U]+=(q*L0.tmpSemitones[U]>>16)+L0.tmpStarts[U]}}if(this.envRelease&&this.envAttack){this.envRelease.reset(),this.envAttack.reset();let Q=0,q=!0;for(let O=0;O<_;O++){let U=this.envRelease.evaluateAt(_),$=this.envAttack.evaluateAt(_),K;if(q)K=this.envRelease.start+((this.envRelease.end-this.envRelease.start)*U>>8);else K=this.envRelease.start+((this.envRelease.end-this.envRelease.start)*$>>8);if(Q+=256,Q>=K)Q=0,q=!q;if(q)L0.toneSrc[O]=0}}if(this.reverbDelay>0&&this.reverbVolume>0){let Q=this.reverbDelay*E;for(let q=Q;q<_;q++)L0.toneSrc[q]+=L0.toneSrc[q-Q]*this.reverbVolume/100|0,L0.toneSrc[q]|=0}for(let Q=0;Q<_;Q++){if(L0.toneSrc[Q]<-32768)L0.toneSrc[Q]=-32768;if(L0.toneSrc[Q]>32767)L0.toneSrc[Q]=32767}return L0.toneSrc}generate2(_,R,E){if(E===1)return(R&32767)<16384?_:-_;else if(E===2)return L0.sin[R&32767]*_>>14;else if(E===3)return((R&32767)*_>>14)-_;else if(E===4)return L0.noise[(R/2607|0)&32767]*_;else return 0}read(_){if(this.frequencyBase=new W0,this.frequencyBase.read(_),this.amplitudeBase=new W0,this.amplitudeBase.read(_),_.g1()!==0)_.pos--,this.frequencyModRate=new W0,this.frequencyModRate.read(_),this.frequencyModRange=new W0,this.frequencyModRange.read(_);if(_.g1()!==0)_.pos--,this.amplitudeModRate=new W0,this.amplitudeModRate.read(_),this.amplitudeModRange=new W0,this.amplitudeModRange.read(_);if(_.g1()!==0)_.pos--,this.envRelease=new W0,this.envRelease.read(_),this.envAttack=new W0,this.envAttack.read(_);for(let R=0;R<10;R++){let E=_.gsmarts();if(E===0)break;this.harmonicVolume[R]=E,this.harmonicSemitone[R]=_.gsmart(),this.harmonicDelay[R]=_.gsmarts()}this.reverbDelay=_.gsmarts(),this.reverbVolume=_.gsmarts(),this.toneLength=_.g2(),this.toneStart=_.g2()}}class E0{static delays=new Int32Array(1000);static waveBytes=null;static waveBuffer=null;static tracks=new C(1000,null);tones=new C(10,null);waveLoopBegin=0;waveLoopEnd=0;static unpack(_){let R=new f(_.read("sounds.dat"));this.waveBytes=new Uint8Array(441000),this.waveBuffer=new f(this.waveBytes),L0.init();while(!0){let E=R.g2();if(E===65535)break;let b=new E0;b.read(R),this.tracks[E]=b,this.delays[E]=b.trim()}}static generate(_,R){if(!this.tracks[_])return null;return this.tracks[_]?.getWave(R)??null}read(_){for(let R=0;R<10;R++)if(_.g1()!==0)_.pos--,this.tones[R]=new L0,this.tones[R]?.read(_);this.waveLoopBegin=_.g2(),this.waveLoopEnd=_.g2()}trim(){let _=9999999;for(let R=0;R<10;R++)if(this.tones[R]&&(this.tones[R].toneStart/20|0)<_)_=this.tones[R].toneStart/20|0;if(this.waveLoopBegin<this.waveLoopEnd&&(this.waveLoopBegin/20|0)<_)_=this.waveLoopBegin/20|0;if(_===9999999||_===0)return 0;for(let R=0;R<10;R++)if(this.tones[R])this.tones[R].toneStart-=_*20;if(this.waveLoopBegin<this.waveLoopEnd)this.waveLoopBegin-=_*20,this.waveLoopEnd-=_*20;return _}getWave(_){let R=this.generate(_);return E0.waveBuffer.pos=0,E0.waveBuffer?.p4(1380533830),E0.waveBuffer?.ip4(R+36),E0.waveBuffer?.p4(1463899717),E0.waveBuffer?.p4(1718449184),E0.waveBuffer?.ip4(16),E0.waveBuffer?.ip2(1),E0.waveBuffer?.ip2(1),E0.waveBuffer?.ip4(22050),E0.waveBuffer?.ip4(22050),E0.waveBuffer?.ip2(1),E0.waveBuffer?.ip2(8),E0.waveBuffer?.p4(1684108385),E0.waveBuffer?.ip4(R),E0.waveBuffer.pos+=R,E0.waveBuffer}generate(_){let R=0;for(let L=0;L<10;L++)if(this.tones[L]&&this.tones[L].toneLength+this.tones[L].toneStart>R)R=this.tones[L].toneLength+this.tones[L].toneStart;if(R===0)return 0;let E=R*22050/1000|0,b=this.waveLoopBegin*22050/1000|0,G=this.waveLoopEnd*22050/1000|0;if(b<0||G<0||G>E||b>=G)_=0;let N=E+(G-b)*(_-1);for(let L=44;L<N+44;L++)if(E0.waveBytes)E0.waveBytes[L]=-128;for(let L=0;L<10;L++)if(this.tones[L]){let H=this.tones[L].toneLength*22050/1000|0,I=this.tones[L].toneStart*22050/1000|0,Q=this.tones[L].generate(H,this.tones[L].toneLength);for(let q=0;q<H;q++)if(E0.waveBytes)E0.waveBytes[q+I+44]+=Q[q]>>8<<24>>24}if(_>1){b+=44,G+=44,E+=44,N+=44;let L=N-E;for(let H=E-1;H>=G;H--)if(E0.waveBytes)E0.waveBytes[H+L]=E0.waveBytes[H];for(let H=1;H<_;H++){let I=(G-b)*H;for(let Q=b;Q<G;Q++)if(E0.waveBytes)E0.waveBytes[Q+I]=E0.waveBytes[Q]}N-=44}return N}}class p extends t0{static nodeId=10;static members=!0;static lowMemory=!1;static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;errorMessage=null;db=null;loopCycle=0;archiveChecksums=[];netStream=null;in=f.alloc(1);out=f.alloc(1);loginout=f.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;inPacketType=0;inPacketSize=0;lastPacketType0=0;lastPacketType1=0;lastPacketType2=0;titleArchive=null;redrawTitleBackground=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";usernameInput="";passwordInput="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBacktop2=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new C(13,null);imageMinimap=null;imageCompass=null;imageMapscene=new C(50,null);imageMapfunction=new C(50,null);imageHitmarks=new C(20,null);imageHeadicons=new C(20,null);imageMapflag=null;imageCrosses=new C(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new C(1000,null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new s;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];publicChatSetting=0;privateChatSetting=0;tradeChatSetting=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialAction=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new C(100,null);messageTextSender=new C(100,null);messageTextType=new Int32Array(100);messageTextIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;mouseButtonsOption=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceID=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1000);activeMapFunctionZ=new Int32Array(1000);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;cameraOffsetCycle=0;cameraAnticheatOffsetX=0;cameraAnticheatOffsetZ=0;cameraAnticheatAngle=0;cameraOffsetXModifier=2;cameraOffsetZModifier=2;cameraOffsetYawModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new C(5,!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;minimapOffsetCycle=0;minimapAnticheatAngle=0;minimapZoom=0;minimapZoomModifier=1;minimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLandReady=null;sceneMapLocData=null;sceneMapLocReady=null;sceneMapIndex=null;sceneAwaitingSync=!1;scenePrevBaseTileX=0;scenePrevBaseTileZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new C(4,null);currentLevel=0;cameraMovedWrite=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new X0(104,104);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new C(2048,null);playerCount=0;playerIds=new Int32Array(2048);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(2048);entityRemovalIds=new Int32Array(1000);playerAppearanceBuffer=new C(2048,null);npcs=new C(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new m0;spotanims=new m0;locList=new m0;objStacks=new C0(4,104,104,null);addedLocs=new m0;bfsStepX=new Int32Array(4000);bfsStepZ=new Int32Array(4000);bfsDirection=new Int32Array(104*104);bfsCost=new Int32Array(104*104);tryMoveNearest=0;localPlayer=null;energy=0;inMultizone=0;localPid=-1;weightCarried=0;heartbeatTimer=0;wildernessLevel=0;worldLocationState=0;rights=!1;designGenderMale=!0;updateDesignModel=!1;designIdentikits=new Int32Array(7);designColors=new Int32Array(5);static CHAT_COLORS=Int32Array.of(16776960,16711680,65280,65535,16711935,16777215);friendCount=0;chatCount=0;chatX=new Int32Array(50);chatY=new Int32Array(50);chatHeight=new Int32Array(50);chatWidth=new Int32Array(50);chatColors=new Int32Array(50);chatStyles=new Int32Array(50);chatTimers=new Int32Array(50);chats=new C(50,null);friendName=new C(100,null);friendName37=new BigInt64Array(100);friendWorld=new Int32Array(100);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=64;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=!0;currentMidi=null;midiCrc=0;midiSize=0;midiVolume=64;displayFps=!1;static setHighMemory(){V.lowMemory=!1,w.lowMemory=!1,p.lowMemory=!1,a.lowMemory=!1}static setLowMemory(){V.lowMemory=!0,w.lowMemory=!0,p.lowMemory=!0,a.lowMemory=!0}constructor(_,R,E){super();if(typeof _==="undefined"||typeof R==="undefined"||typeof E==="undefined")return;if(p.nodeId=_,p.members=E,R)p.setLowMemory();else p.setHighMemory();this.run()}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}getReportAbuseInterfaceId(){return this.reportAbuseInterfaceID}unloadTitle(){if(this.flameActive=!1,this.flamesInterval)clearInterval(this.flamesInterval),this.flamesInterval=null;this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null}async loadArchive(_,R,E,b){let G=5,N=await this.db?.cacheload(_);if(N&&f.crc32(N)!==E)N=void 0;if(N)return new s0(N);while(!N){await this.showProgress(b,`Requesting ${R}`);try{N=await c0(`/${_}${E}`)}catch(L){N=void 0;for(let H=G;H>0;H--)await this.showProgress(b,`Error loading - Will retry in ${H} secs.`),await B0(1000);if(G*=2,G>60)G=60}}return await this.db?.cachesave(_,N),new s0(N)}async setMidi(_,R,E,b){try{let G=await this.db?.cacheload(_+".mid");if(G&&R!==12345678&&f.crc32(G)!==R)G=void 0;if(!G||!G.length)try{if(G=await c0(`/${_}_${R}.mid`),E!==G.length)G=G.slice(0,E)}catch(N){}if(!G)return;try{await this.db?.cachesave(_+".mid",G);let N=J_.decompress(G,-1,!1,!0);B_(N,this.midiVolume,b)}catch(N){}}catch(G){}}drawError(){d.fillStyle="black",d.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.flameActive=!1;let _=35;if(this.errorLoading)d.font="bold 16px helvetica, sans-serif",d.textAlign="left",d.fillStyle="yellow",d.fillText("Sorry, an error has occured whilst loading RuneScape",30,_),_+=50,d.fillStyle="white",d.fillText("To fix this try the following (in order):",30,_),_+=50,d.font="bold 12px helvetica, sans-serif",d.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_),_+=30,d.fillText("2: Try clearing your web-browsers cache",30,_),_+=30,d.fillText("3: Try using a different game-world",30,_),_+=30,d.fillText("4: Try rebooting your computer",30,_);else if(this.errorHost)d.font="bold 20px helvetica, sans-serif",d.textAlign="left",d.fillStyle="white",d.fillText("Error - unable to load game!",50,50),d.fillText("To play RuneScape make sure you play from an approved domain",50,100);else if(this.errorStarted)d.font="bold 13px helvetica, sans-serif",d.textAlign="left",d.fillStyle="yellow",d.fillText("Error a copy of RuneScape already appears to be loaded",30,_),_+=50,d.fillStyle="white",d.fillText("To fix this try the following (in order):",30,_),_+=50,d.font="bold 12px helvetica, sans-serif",d.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_),_+=30,d.fillText("2: Try rebooting your computer, and reloading",30,_);if(this.errorMessage)_+=50,d.fillStyle="red",d.fillText("Error: "+this.errorMessage,30,_)}executeInterfaceScript(_){if(!_.scriptComparator)return!1;for(let R=0;R<_.scriptComparator.length;R++){let E=this.executeClientscript1(_,R);if(!_.scriptOperand)return!1;let b=_.scriptOperand[R];if(_.scriptComparator[R]===2){if(E>=b)return!1}else if(_.scriptComparator[R]===3){if(E<=b)return!1}else if(_.scriptComparator[R]===4){if(E===b)return!1}else if(E!==b)return!1}return!0}drawScrollbar(_,R,E,b,G){this.imageScrollbar0?.draw(_,R),this.imageScrollbar1?.draw(_,R+G-16),T.fillRect2d(_,R+16,16,G-32,2301979);let N=(G-32)*G/b|0;if(N<8)N=8;let L=(G-N-32)*E/(b-G)|0;T.fillRect2d(_,R+L+16,16,N,5063219),T.drawVerticalLine(_,R+L+16,7759444,N),T.drawVerticalLine(_+1,R+L+16,7759444,N),T.drawHorizontalLine(_,R+L+16,7759444,16),T.drawHorizontalLine(_,R+L+17,7759444,16),T.drawVerticalLine(_+15,R+L+16,3353893,N),T.drawVerticalLine(_+14,R+L+17,3353893,N-1),T.drawHorizontalLine(_,R+L+N+15,3353893,16),T.drawHorizontalLine(_+1,R+L+N+14,3353893,15)}updateInterfaceAnimation(_,R){let E=!1,b=s.instances[_];if(!b.childId)return!1;for(let G=0;G<b.childId.length&&b.childId[G]!==-1;G++){let N=s.instances[b.childId[G]];if(N.comType===1)E||=this.updateInterfaceAnimation(N.id,R);if(N.comType===6&&(N.anim!==-1||N.activeAnim!==-1)){let L=this.executeInterfaceScript(N),H;if(L)H=N.activeAnim;else H=N.anim;if(H!==-1){let I=r.instances[H];if(N.seqCycle+=R,I.seqDelay)while(N.seqCycle>I.seqDelay[N.seqFrame]){if(N.seqCycle-=I.seqDelay[N.seqFrame]+1,N.seqFrame++,N.seqFrame>=I.seqFrameCount){if(N.seqFrame-=I.replayoff,N.seqFrame<0||N.seqFrame>=I.seqFrameCount)N.seqFrame=0}E=!0}}}}return E}drawInterface(_,R,E,b,G=!1){if(_.comType!==0||!_.childId||_.hide&&this.viewportHoveredInterfaceIndex!==_.id&&this.sidebarHoveredInterfaceIndex!==_.id&&this.chatHoveredInterfaceIndex!==_.id)return;let N=T.left,L=T.top,H=T.right,I=T.bottom;T.setBounds(R,E,R+_.width,E+_.height);let Q=_.childId.length;for(let q=0;q<Q;q++){if(!_.childX||!_.childY)continue;let O=_.childX[q]+R,U=_.childY[q]+E-b,$=s.instances[_.childId[q]];if(O+=$.x,U+=$.y,G)T.drawRect(O,U,$.width,$.height,16777215);if($.clientCode>0)this.updateInterfaceContent($);if($.comType===0){if($.scrollPosition>$.scroll-$.height)$.scrollPosition=$.scroll-$.height;if($.scrollPosition<0)$.scrollPosition=0;if(this.drawInterface($,O,U,$.scrollPosition,G),$.scroll>$.height)this.drawScrollbar(O+$.width,U,$.scrollPosition,$.scroll,$.height)}else if($.comType===2){let K=0;for(let u=0;u<$.height;u++)for(let F=0;F<$.width;F++){if(!$.invSlotOffsetX||!$.invSlotOffsetY||!$.invSlotObjId||!$.invSlotObjCount)continue;let k=O+F*($.marginX+32),j=U+u*($.marginY+32);if(K<20)k+=$.invSlotOffsetX[K],j+=$.invSlotOffsetY[K];if($.invSlotObjId[K]>0){let m=0,Y=0,X=$.invSlotObjId[K]-1;if(k>=-32&&k<=512&&j>=-32&&j<=334||this.objDragArea!==0&&this.objDragSlot===K){let B=_0.getIcon(X,$.invSlotObjCount[K]);if(this.objDragArea!==0&&this.objDragSlot===K&&this.objDragInterfaceId===$.id){if(m=this.mouseX-this.objGrabX,Y=this.mouseY-this.objGrabY,m<5&&m>-5)m=0;if(Y<5&&Y>-5)Y=0;if(this.objDragCycles<5)m=0,Y=0;B.drawAlpha(128,k+m,j+Y)}else if(this.selectedArea!==0&&this.selectedItem===K&&this.selectedInterface===$.id)B.drawAlpha(128,k,j);else B.draw(k,j);if(B.cropW===33||$.invSlotObjCount[K]!==1){let z=$.invSlotObjCount[K];this.fontPlain11?.drawString(k+m+1,j+10+Y,this.formatObjCount(z),0),this.fontPlain11?.drawString(k+m,j+9+Y,this.formatObjCount(z),16776960)}}}else if($.invSlotSprite&&K<20)$.invSlotSprite[K]?.draw(k,j);K++}}else if($.comType===3)if($.fill)T.fillRect2d(O,U,$.width,$.height,$.colour);else T.drawRect(O,U,$.width,$.height,$.colour);else if($.comType===4){let{font:K,colour:u,text:F}=$;if((this.chatHoveredInterfaceIndex===$.id||this.sidebarHoveredInterfaceIndex===$.id||this.viewportHoveredInterfaceIndex===$.id)&&$.overColour!==0)u=$.overColour;if(this.executeInterfaceScript($)){if(u=$.activeColour,$.activeText&&$.activeText.length>0)F=$.activeText}if($.buttonType===6&&this.pressedContinueOption)F="Please wait...",u=$.colour;if(!K||!F)continue;for(let k=U+K.height2d;F.length>0;k+=K.height2d){if(F.indexOf("%")!==-1){do{let Y=F.indexOf("%1");if(Y===-1)break;F=F.substring(0,Y)+this.getIntString(this.executeClientscript1($,0))+F.substring(Y+2)}while(!0);do{let Y=F.indexOf("%2");if(Y===-1)break;F=F.substring(0,Y)+this.getIntString(this.executeClientscript1($,1))+F.substring(Y+2)}while(!0);do{let Y=F.indexOf("%3");if(Y===-1)break;F=F.substring(0,Y)+this.getIntString(this.executeClientscript1($,2))+F.substring(Y+2)}while(!0);do{let Y=F.indexOf("%4");if(Y===-1)break;F=F.substring(0,Y)+this.getIntString(this.executeClientscript1($,3))+F.substring(Y+2)}while(!0);do{let Y=F.indexOf("%5");if(Y===-1)break;F=F.substring(0,Y)+this.getIntString(this.executeClientscript1($,4))+F.substring(Y+2)}while(!0)}let j=F.indexOf("\\n"),m;if(j!==-1)m=F.substring(0,j),F=F.substring(j+2);else m=F,F="";if($.center)K.drawStringTaggableCenter(O+($.width/2|0),k,m,u,$.shadowed);else K.drawStringTaggable(O,k,m,u,$.shadowed)}}else if($.comType===5){let K;if(this.executeInterfaceScript($))K=$.activeGraphic;else K=$.graphic;K?.draw(O,U)}else if($.comType===6){let K=w.centerX,u=w.centerY;w.centerX=O+($.width/2|0),w.centerY=U+($.height/2|0);let F=w.sin[$.xan]*$.zoom>>16,k=w.cos[$.xan]*$.zoom>>16,j=this.executeInterfaceScript($),m;if(j)m=$.activeAnim;else m=$.anim;let Y=null;if(m===-1)Y=$.getModel(-1,-1,j);else{let X=r.instances[m];if(X.seqFrames&&X.seqIframes)Y=$.getModel(X.seqFrames[$.seqFrame],X.seqIframes[$.seqFrame],j)}if(Y)Y.drawSimple(0,$.yan,0,$.xan,0,F,k);w.centerX=K,w.centerY=u}else if($.comType===7){let K=$.font;if(!K||!$.invSlotObjId||!$.invSlotObjCount)continue;let u=0;for(let F=0;F<$.height;F++)for(let k=0;k<$.width;k++){if($.invSlotObjId[u]>0){let j=_0.get($.invSlotObjId[u]-1),m=j.name;if(j.stackable||$.invSlotObjCount[u]!==1)m=m+" x"+this.formatObjCountTagged($.invSlotObjCount[u]);if(!m)continue;let Y=O+k*($.marginX+115),X=U+F*($.marginY+12);if($.center)K.drawStringTaggableCenter(Y+($.width/2|0),X,m,$.colour,$.shadowed);else K.drawStringTaggable(Y,X,m,$.colour,$.shadowed)}u++}}}T.setBounds(N,L,H,I)}updateInterfaceContent(_){let R=_.clientCode;if(R>=1&&R<=100)if(R--,R>=this.friendCount)_.text="",_.buttonType=0;else _.text=this.friendName[R],_.buttonType=1;else if(R>=101&&R<=200)if(R-=101,R>=this.friendCount)_.text="",_.buttonType=0;else{if(this.friendWorld[R]===0)_.text="@red@Offline";else if(this.friendWorld[R]===p.nodeId)_.text="@gre@World-"+(this.friendWorld[R]-9);else _.text="@yel@World-"+(this.friendWorld[R]-9);_.buttonType=1}else if(R===203){if(_.scroll=this.friendCount*15+20,_.scroll<=_.height)_.scroll=_.height+1}else if(R>=401&&R<=500)if(R-=401,R>=this.ignoreCount)_.text="",_.buttonType=0;else _.text=l.formatName(l.fromBase37(this.ignoreName37[R])),_.buttonType=1;else if(R===503){if(_.scroll=this.ignoreCount*15+20,_.scroll<=_.height)_.scroll=_.height+1}else if(R===327){if(_.xan=150,_.yan=(Math.sin(this.loopCycle/40)*256|0)&2047,this.updateDesignModel){this.updateDesignModel=!1;let E=new C(7,null),b=0;for(let N=0;N<7;N++){let L=this.designIdentikits[N];if(L>=0)E[b++]=Y0.instances[L].getModel()}let G=J.modelFromModels(E,b);for(let N=0;N<5;N++)if(this.designColors[N]!==0){if(G.recolor(K0.DESIGN_IDK_COLORS[N][0],K0.DESIGN_IDK_COLORS[N][this.designColors[N]]),N===1)G.recolor(K0.TORSO_RECOLORS[0],K0.TORSO_RECOLORS[this.designColors[N]])}if(this.localPlayer){let N=r.instances[this.localPlayer.seqStandId].seqFrames;if(N)G.createLabelReferences(),G.applyTransform(N[0]),G.calculateNormals(64,850,-30,-50,-30,!0),_.model=G}}}else if(R===324){if(!this.genderButtonImage0)this.genderButtonImage0=_.graphic,this.genderButtonImage1=_.activeGraphic;if(this.designGenderMale)_.graphic=this.genderButtonImage1;else _.graphic=this.genderButtonImage0}else if(R===325){if(!this.genderButtonImage0)this.genderButtonImage0=_.graphic,this.genderButtonImage1=_.activeGraphic;if(this.designGenderMale)_.graphic=this.genderButtonImage0;else _.graphic=this.genderButtonImage1}else if(R===600)if(_.text=this.reportAbuseInput,this.loopCycle%20<10)_.text=_.text+"|";else _.text=_.text+" ";else if(R===613)if(!this.rights)_.text="";else if(this.reportAbuseMuteOption)_.colour=16711680,_.text="Moderator option: Mute player for 48 hours: <ON>";else _.colour=16777215,_.text="Moderator option: Mute player for 48 hours: <OFF>";else if(R===650||R===655)if(this.lastAddress===0)_.text="";else{let E;if(this.daysSinceLastLogin===0)E="earlier today";else if(this.daysSinceLastLogin===1)E="yesterday";else E=this.daysSinceLastLogin+" days ago";let b=l.formatIPv4(this.lastAddress);_.text="You last logged in "+E+(b==="127.0.0.1"?".":" from: "+b)}else if(R===651){if(this.unreadMessages===0)_.text="0 unread messages",_.colour=16776960;if(this.unreadMessages===1)_.text="1 unread message",_.colour=65280;if(this.unreadMessages>1)_.text=this.unreadMessages+" unread messages",_.colour=65280}else if(R===652)if(this.daysSinceRecoveriesChanged===201)_.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="You have not yet set any password recovery questions.";else{let E;if(this.daysSinceRecoveriesChanged===0)E="Earlier today";else if(this.daysSinceRecoveriesChanged===1)E="Yesterday";else E=this.daysSinceRecoveriesChanged+" days ago";_.text=E+" you changed your recovery questions"}else if(R===653)if(this.daysSinceRecoveriesChanged===201)_.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="We strongly recommend you do so now to secure your account.";else _.text="If you do not remember making this change then cancel it immediately";else if(R===654)if(this.daysSinceRecoveriesChanged===201)_.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="Do this from the 'account management' area on our front webpage";else _.text="Do this from the 'account management' area on our front webpage"}executeClientscript1(_,R){if(!_.script||R>=_.script.length)return-2;try{let E=_.script[R];if(!E)return-1;let b=0,G=0;while(!0){let N=E[G++];if(N===0)return b;if(N===1)b+=this.skillLevel[E[G++]];else if(N===2)b+=this.skillBaseLevel[E[G++]];else if(N===3)b+=this.skillExperience[E[G++]];else if(N===4){let L=s.instances[E[G++]],H=E[G++]+1;if(L.invSlotObjId&&L.invSlotObjCount){for(let I=0;I<L.invSlotObjId.length;I++)if(L.invSlotObjId[I]===H)b+=L.invSlotObjCount[I]}else b+=0}else if(N===5)b+=this.varps[E[G++]];else if(N===6)b+=this.levelExperience[this.skillBaseLevel[E[G++]]-1];else if(N===7)b+=this.varps[E[G++]]*100/46875|0;else if(N===8)b+=this.localPlayer?.combatLevel||0;else if(N===9)for(let L=0;L<19;L++){if(L===18)L=20;b+=this.skillBaseLevel[L]}else if(N===10){let L=s.instances[E[G++]],H=E[G++]+1;for(let I=0;I<L.invSlotObjId.length;I++)if(L.invSlotObjId[I]===H){b+=999999999;break}}else if(N===11)b+=this.energy;else if(N===12)b+=this.weightCarried;else if(N===13){let L=this.varps[E[G++]],H=E[G++];b+=(L&1<<H)===0?0:1}}}catch(E){return-1}}getIntString(_){return _<999999999?String(_):"*"}formatObjCountTagged(_){let R=String(_);for(let E=R.length-3;E>0;E-=3)R=R.substring(0,E)+","+R.substring(E);if(R.length>8)R="@gre@"+R.substring(0,R.length-8)+" million @whi@("+R+")";else if(R.length>4)R="@cya@"+R.substring(0,R.length-4)+"K @whi@("+R+")";return" "+R}formatObjCount(_){if(_<1e5)return String(_);else if(_<1e7)return(_/1000|0)+"K";else return(_/1e6|0)+"M"}async load(){if(this.isMobile&&p.lowMemory)this.setTargetedFramerate(30);if(this.alreadyStarted){this.errorStarted=!0;return}this.alreadyStarted=!0;try{await this.showProgress(10,"Connecting to fileserver");try{this.db=new x0(await x0.openDatabase())}catch(Z){this.db=null}let _=new f(await c0("/crc"));for(let Z=0;Z<9;Z++)this.archiveChecksums[Z]=_.g4();if(!p.lowMemory)await this.setMidi("scape_main",12345678,40000,!1);let R=await this.loadArchive("title","title screen",this.archiveChecksums[1],10);this.titleArchive=R,this.fontPlain11=V0.fromArchive(R,"p11"),this.fontPlain12=V0.fromArchive(R,"p12"),this.fontBold12=V0.fromArchive(R,"b12"),this.fontQuill8=V0.fromArchive(R,"q8"),await this.loadTitleBackground(),this.loadTitleImages();let E=await this.loadArchive("config","config",this.archiveChecksums[2],15),b=await this.loadArchive("interface","interface",this.archiveChecksums[3],20),G=await this.loadArchive("media","2d graphics",this.archiveChecksums[4],30),N=await this.loadArchive("models","3d graphics",this.archiveChecksums[5],40),L=await this.loadArchive("textures","textures",this.archiveChecksums[6],60),H=await this.loadArchive("wordenc","chat system",this.archiveChecksums[7],65),I=await this.loadArchive("sounds","sound effects",this.archiveChecksums[8],70);if(this.levelTileFlags=new M0(4,104,104),this.levelHeightmap=new h0(4,104+1,104+1),this.levelHeightmap)this.scene=new V(this.levelHeightmap,104,4,104);for(let Z=0;Z<4;Z++)this.levelCollisionMap[Z]=new o;this.imageMinimap=new e(512,512),await this.showProgress(75,"Unpacking media"),this.imageInvback=I0.fromArchive(G,"invback",0),this.imageChatback=I0.fromArchive(G,"chatback",0),this.imageMapback=I0.fromArchive(G,"mapback",0),this.imageBackbase1=I0.fromArchive(G,"backbase1",0),this.imageBackbase2=I0.fromArchive(G,"backbase2",0),this.imageBackhmid1=I0.fromArchive(G,"backhmid1",0);for(let Z=0;Z<13;Z++)this.imageSideicons[Z]=I0.fromArchive(G,"sideicons",Z);this.imageCompass=e.fromArchive(G,"compass",0);try{for(let Z=0;Z<50;Z++){if(Z===22)continue;this.imageMapscene[Z]=I0.fromArchive(G,"mapscene",Z)}}catch(Z){}try{for(let Z=0;Z<50;Z++)this.imageMapfunction[Z]=e.fromArchive(G,"mapfunction",Z)}catch(Z){}try{for(let Z=0;Z<20;Z++)this.imageHitmarks[Z]=e.fromArchive(G,"hitmarks",Z)}catch(Z){}try{for(let Z=0;Z<20;Z++)this.imageHeadicons[Z]=e.fromArchive(G,"headicons",Z)}catch(Z){}this.imageMapflag=e.fromArchive(G,"mapflag",0);for(let Z=0;Z<8;Z++)this.imageCrosses[Z]=e.fromArchive(G,"cross",Z);this.imageMapdot0=e.fromArchive(G,"mapdots",0),this.imageMapdot1=e.fromArchive(G,"mapdots",1),this.imageMapdot2=e.fromArchive(G,"mapdots",2),this.imageMapdot3=e.fromArchive(G,"mapdots",3),this.imageScrollbar0=I0.fromArchive(G,"scrollbar",0),this.imageScrollbar1=I0.fromArchive(G,"scrollbar",1),this.imageRedstone1=I0.fromArchive(G,"redstone1",0),this.imageRedstone2=I0.fromArchive(G,"redstone2",0),this.imageRedstone3=I0.fromArchive(G,"redstone3",0),this.imageRedstone1h=I0.fromArchive(G,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=I0.fromArchive(G,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=I0.fromArchive(G,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=I0.fromArchive(G,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=I0.fromArchive(G,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=I0.fromArchive(G,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=I0.fromArchive(G,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();let Q=e.fromArchive(G,"backleft1",0);this.areaBackleft1=new b0(Q.width2d,Q.height2d),Q.blitOpaque(0,0);let q=e.fromArchive(G,"backleft2",0);this.areaBackleft2=new b0(q.width2d,q.height2d),q.blitOpaque(0,0);let O=e.fromArchive(G,"backright1",0);this.areaBackright1=new b0(O.width2d,O.height2d),O.blitOpaque(0,0);let U=e.fromArchive(G,"backright2",0);this.areaBackright2=new b0(U.width2d,U.height2d),U.blitOpaque(0,0);let $=e.fromArchive(G,"backtop1",0);this.areaBacktop1=new b0($.width2d,$.height2d),$.blitOpaque(0,0);let K=e.fromArchive(G,"backtop2",0);this.areaBacktop2=new b0(K.width2d,K.height2d),K.blitOpaque(0,0);let u=e.fromArchive(G,"backvmid1",0);this.areaBackvmid1=new b0(u.width2d,u.height2d),u.blitOpaque(0,0);let F=e.fromArchive(G,"backvmid2",0);this.areaBackvmid2=new b0(F.width2d,F.height2d),F.blitOpaque(0,0);let k=e.fromArchive(G,"backvmid3",0);this.areaBackvmid3=new b0(k.width2d,k.height2d),k.blitOpaque(0,0);let j=e.fromArchive(G,"backhmid2",0);this.areaBackhmid2=new b0(j.width2d,j.height2d),j.blitOpaque(0,0);let m=(Math.random()*21|0)-10,Y=(Math.random()*21|0)-10,X=(Math.random()*21|0)-10,B=(Math.random()*41|0)-20;for(let Z=0;Z<50;Z++){if(this.imageMapfunction[Z])this.imageMapfunction[Z]?.translate2d(m+B,Y+B,X+B);if(this.imageMapscene[Z])this.imageMapscene[Z]?.translate2d(m+B,Y+B,X+B)}if(await this.showProgress(80,"Unpacking textures"),w.unpackTextures(L),w.setBrightness(0.8),w.initPool(20),await this.showProgress(83,"Unpacking models"),J.unpack(N),g0.unpack(N),A0.unpack(N),await this.showProgress(86,"Unpacking config"),r.unpack(E),Q0.unpack(E),N0.unpack(E),_0.unpack(E,p.members),w0.unpack(E),Y0.unpack(E),T0.unpack(E),S0.unpack(E),!p.lowMemory)await this.showProgress(90,"Unpacking sounds"),E0.unpack(I);await this.showProgress(92,"Unpacking interfaces"),s.unpack(b,G,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.showProgress(97,"Preparing game engine");for(let Z=0;Z<33;Z++){let g=999,M=0;for(let S=0;S<35;S++)if(this.imageMapback.pixels[S+Z*this.imageMapback.width2d]===0){if(g===999)g=S}else if(g!==999){M=S;break}this.compassMaskLineOffsets[Z]=g,this.compassMaskLineLengths[Z]=M-g}for(let Z=9;Z<160;Z++){let g=999,M=0;for(let S=10;S<168;S++)if(this.imageMapback.pixels[S+Z*this.imageMapback.width2d]===0&&(S>34||Z>34)){if(g===999)g=S}else if(g!==999){M=S;break}this.minimapMaskLineOffsets[Z-9]=g-21,this.minimapMaskLineLengths[Z-9]=M-g}w.init3D(479,96),this.areaChatbackOffsets=w.lineOffset,w.init3D(190,261),this.areaSidebarOffsets=w.lineOffset,w.init3D(512,334),this.areaViewportOffsets=w.lineOffset;let z=new Int32Array(9);for(let Z=0;Z<9;Z++){let g=Z*32+128+15,M=g*3+600,S=w.sin[g];z[Z]=M*S>>16}V.init(512,334,500,800,z),P0.unpack(H),this.initializeLevelExperience()}catch(_){if(this.errorLoading=!0,_ instanceof Error)this.errorMessage=_.message}}async update(){if(this.errorStarted||this.errorLoading||this.errorHost)return;if(this.loopCycle++,this.ingame)await this.updateGame();else await this.updateTitleScreen()}async draw(){if(this.errorStarted||this.errorLoading||this.errorHost){this.drawError();return}if(this.ingame)this.drawGame();else await this.drawTitleScreen();this.dragCycles=0}async refresh(){this.redrawTitleBackground=!0}async showProgress(_,R){if(await this.loadTitle(),!this.titleArchive){await super.showProgress(_,R);return}this.imageTitle4?.bind();let E=360,b=200,G=20;this.fontBold12?.drawStringCenter(E/2|0,(b/2|0)-G-26,"RuneScape is loading - please wait...",16777215);let N=(b/2|0)-18-G;if(T.drawRect((E/2|0)-152,N,304,34,9179409),T.drawRect((E/2|0)-151,N+1,302,32,0),T.fillRect2d((E/2|0)-150,N+2,_*3,30,9179409),T.fillRect2d((E/2|0)-150+_*3,N+2,300-_*3,30,0),this.fontBold12?.drawStringCenter(E/2|0,(b/2|0)+5-G,R,16777215),this.imageTitle4?.draw(214,186),this.redrawTitleBackground){if(this.redrawTitleBackground=!1,!this.flameActive)this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(661,0);this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186)}await B0(5)}runFlames(){if(!this.flameActive)return;this.updateFlames(),this.updateFlames(),this.drawFlames()}async loadTitle(){if(!this.imageTitle2){if(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new b0(128,265),T.clear(),this.imageTitle1=new b0(128,265),T.clear(),this.imageTitle2=new b0(533,186),T.clear(),this.imageTitle3=new b0(360,146),T.clear(),this.imageTitle4=new b0(360,200),T.clear(),this.imageTitle5=new b0(214,267),T.clear(),this.imageTitle6=new b0(215,267),T.clear(),this.imageTitle7=new b0(86,79),T.clear(),this.imageTitle8=new b0(87,79),T.clear(),this.titleArchive)await this.loadTitleBackground(),this.loadTitleImages();this.redrawTitleBackground=!0}}async loadTitleBackground(){if(!this.titleArchive)return;let _=await e.fromJpeg(this.titleArchive,"title");this.imageTitle0?.bind(),_.blitOpaque(0,0),this.imageTitle1?.bind(),_.blitOpaque(-661,0),this.imageTitle2?.bind(),_.blitOpaque(-128,0),this.imageTitle3?.bind(),_.blitOpaque(-214,-386),this.imageTitle4?.bind(),_.blitOpaque(-214,-186),this.imageTitle5?.bind(),_.blitOpaque(0,-265),this.imageTitle6?.bind(),_.blitOpaque(-128,-186),this.imageTitle7?.bind(),_.blitOpaque(-128,-186),this.imageTitle8?.bind(),_.blitOpaque(-574,-186),_.flipHorizontally(),this.imageTitle0?.bind(),_.blitOpaque(394,0),this.imageTitle1?.bind(),_.blitOpaque(-267,0),this.imageTitle2?.bind(),_.blitOpaque(266,0),this.imageTitle3?.bind(),_.blitOpaque(180,-386),this.imageTitle4?.bind(),_.blitOpaque(180,-186),this.imageTitle5?.bind(),_.blitOpaque(394,-265),this.imageTitle6?.bind(),_.blitOpaque(-180,-265),this.imageTitle7?.bind(),_.blitOpaque(212,-186),this.imageTitle8?.bind(),_.blitOpaque(-180,-186);let R=e.fromArchive(this.titleArchive,"logo");this.imageTitle2?.bind(),R.draw((this.width/2|0)-(R.width2d/2|0)-128,18)}updateFlameBuffer(_){if(!this.flameBuffer0||!this.flameBuffer1)return;let R=256;this.flameBuffer0.fill(0);for(let E=0;E<5000;E++){let b=Math.random()*128*R|0;this.flameBuffer0[b]=Math.random()*256|0}for(let E=0;E<20;E++){for(let G=1;G<R-1;G++)for(let N=1;N<127;N++){let L=N+(G<<7);this.flameBuffer1[L]=(this.flameBuffer0[L-1]+this.flameBuffer0[L+1]+this.flameBuffer0[L-128]+this.flameBuffer0[L+128])/4|0}let b=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=b}if(_){let E=0;for(let b=0;b<_.height2d;b++)for(let G=0;G<_.width2d;G++)if(_.pixels[E++]!==0){let N=G+_.cropX+16,L=b+_.cropY+16,H=N+(L<<7);this.flameBuffer0[H]=0}}}loadTitleImages(){if(!this.titleArchive)return;this.imageTitlebox=I0.fromArchive(this.titleArchive,"titlebox"),this.imageTitlebutton=I0.fromArchive(this.titleArchive,"titlebutton");for(let _=0;_<12;_++)this.imageRunes[_]=I0.fromArchive(this.titleArchive,"runes",_);if(this.imageFlamesLeft=new e(128,265),this.imageFlamesRight=new e(128,265),this.imageTitle0)K_(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920);if(this.imageTitle1)K_(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920);this.flameGradient0=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient0[_]=_*262144;for(let _=0;_<64;_++)this.flameGradient0[_+64]=_*1024+16711680;for(let _=0;_<64;_++)this.flameGradient0[_+128]=_*4+16776960;for(let _=0;_<64;_++)this.flameGradient0[_+192]=16777215;this.flameGradient1=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient1[_]=_*1024;for(let _=0;_<64;_++)this.flameGradient1[_+64]=_*4+65280;for(let _=0;_<64;_++)this.flameGradient1[_+128]=_*262144+65535;for(let _=0;_<64;_++)this.flameGradient1[_+192]=16777215;this.flameGradient2=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient2[_]=_*4;for(let _=0;_<64;_++)this.flameGradient2[_+64]=_*262144+255;for(let _=0;_<64;_++)this.flameGradient2[_+128]=_*1024+16711935;for(let _=0;_<64;_++)this.flameGradient2[_+192]=16777215;this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),this.showProgress(10,"Connecting to fileserver").then(()=>{if(!this.flameActive)this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames.bind(this),35)})}async updateTitleScreen(){if(this.titleScreenState===0){let _=(this.width/2|0)-80,R=(this.height/2|0)+20;if(R+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.titleScreenState=3,this.titleLoginField=0;if(_=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0}else if(this.titleScreenState===2){let _=(this.height/2|0)-40;if(_+=30,_+=25,this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_)this.titleLoginField=0;if(_+=15,this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_)this.titleLoginField=1;let R=(this.width/2|0)-80,E=(this.height/2|0)+50;if(E+=20,this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=E-20&&this.mouseClickY<=E+20)await this.tryLogin(this.usernameInput,this.passwordInput,!1);if(R=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=E-20&&this.mouseClickY<=E+20)this.titleScreenState=0,this.usernameInput="",this.passwordInput="";while(!0){let b=this.pollKey();if(b===-1)return;let G=!1;for(let N=0;N<V0.CHARSET.length;N++)if(String.fromCharCode(b)===V0.CHARSET.charAt(N)){G=!0;break}if(this.titleLoginField===0){if(b===8&&this.usernameInput.length>0)this.usernameInput=this.usernameInput.substring(0,this.usernameInput.length-1);if(b===9||b===10||b===13)this.titleLoginField=1;if(G)this.usernameInput=this.usernameInput+String.fromCharCode(b);if(this.usernameInput.length>12)this.usernameInput=this.usernameInput.substring(0,12)}else if(this.titleLoginField===1){if(b===8&&this.passwordInput.length>0)this.passwordInput=this.passwordInput.substring(0,this.passwordInput.length-1);if(b===9||b===10||b===13)this.titleLoginField=0;if(G)this.passwordInput=this.passwordInput+String.fromCharCode(b);if(this.passwordInput.length>20)this.passwordInput=this.passwordInput.substring(0,20)}}}else if(this.titleScreenState===3){let _=this.width/2|0,R=(this.height/2|0)+50;if(R+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.titleScreenState=0}}async drawTitleScreen(){await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0);let _=360,R=200;if(this.titleScreenState===0){let E=_/2|0,b=(R/2|0)-20;this.fontBold12?.drawStringTaggableCenter(E,b,"Welcome to RuneScape",16776960,!0),E=(_/2|0)-80,b=(R/2|0)+20,this.imageTitlebutton?.draw(E-73,b-20),this.fontBold12?.drawStringTaggableCenter(E,b+5,"New user",16777215,!0),E=(_/2|0)+80,this.imageTitlebutton?.draw(E-73,b-20),this.fontBold12?.drawStringTaggableCenter(E,b+5,"Existing User",16777215,!0)}else if(this.titleScreenState===2){let E=(_/2|0)-80,b=(R/2|0)-40;if(this.loginMessage0.length>0)this.fontBold12?.drawStringTaggableCenter(_/2,b-15,this.loginMessage0,16776960,!0),this.fontBold12?.drawStringTaggableCenter(_/2,b,this.loginMessage1,16776960,!0),b+=30;else this.fontBold12?.drawStringTaggableCenter(_/2,b-7,this.loginMessage1,16776960,!0),b+=30;this.fontBold12?.drawStringTaggable(_/2-90,b,`Username: ${this.usernameInput}${this.titleLoginField===0&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),b+=15,this.fontBold12?.drawStringTaggable(_/2-88,b,`Password: ${l.toAsterisks(this.passwordInput)}${this.titleLoginField===1&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),b=(R/2|0)+50,this.imageTitlebutton?.draw(E-73,b-20),this.fontBold12?.drawStringTaggableCenter(E,b+5,"Login",16777215,!0),E=(_/2|0)+80,this.imageTitlebutton?.draw(E-73,b-20),this.fontBold12?.drawStringTaggableCenter(E,b+5,"Cancel",16777215,!0)}else if(this.titleScreenState===3){this.fontBold12?.drawStringTaggableCenter(_/2,R/2-60,"Create a free account",16776960,!0);let E=_/2|0,b=(R/2|0)-35;this.fontBold12?.drawStringTaggableCenter(_/2|0,b,"To create a new account you need to",16777215,!0),b+=15,this.fontBold12?.drawStringTaggableCenter(_/2|0,b,"go back to the main RuneScape webpage",16777215,!0),b+=15,this.fontBold12?.drawStringTaggableCenter(_/2|0,b,"and choose the red 'create account'",16777215,!0),b+=15,this.fontBold12?.drawStringTaggableCenter(_/2|0,b,"button at the top right of that page.",16777215,!0),b=(R/2|0)+50,this.imageTitlebutton?.draw(E-73,b-20),this.fontBold12?.drawStringTaggableCenter(E,b+5,"Cancel",16777215,!0)}if(this.imageTitle4?.draw(214,186),this.redrawTitleBackground)this.redrawTitleBackground=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186)}async tryLogin(_,R,E){try{if(!E)this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitleScreen();this.netStream=new y0(await y0.openSocket(window.location.host,window.location.protocol==="https:")),await this.netStream.readBytes(this.in.data,0,8),this.in.pos=0,this.serverSeed=this.in.g8();let b=new Int32Array([Math.floor(Math.random()*99999999),Math.floor(Math.random()*99999999),Number(this.serverSeed>>32n),Number(this.serverSeed&BigInt(4294967295))]);if(this.out.pos=0,this.out.p1(10),this.out.p4(b[0]),this.out.p4(b[1]),this.out.p4(b[2]),this.out.p4(b[3]),this.out.p4(1337),this.out.pjstr(_),this.out.pjstr(R),this.out.rsaenc(BigInt("7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789"),BigInt("58778699976184461502525193738213253649000149147835990136706041084440742975821")),this.loginout.pos=0,E)this.loginout.p1(18);else this.loginout.p1(16);this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(225),this.loginout.p1(p.lowMemory?1:0);for(let N=0;N<9;N++)this.loginout.p4(this.archiveChecksums[N]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new i0(b);for(let N=0;N<4;N++)b[N]+=50;this.randomIn=new i0(b),this.netStream?.write(this.loginout.data,this.loginout.pos);let G=await this.netStream.read();if(G===1){await B0(2000),await this.tryLogin(_,R,E);return}if(G===2||G===18){this.rights=G===18,$0.setDisabled(),this.ingame=!0,this.out.pos=0,this.in.pos=0,this.inPacketType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.inPacketSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=Date.now();for(let N=0;N<100;N++)this.messageText[N]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.cameraAnticheatOffsetX=(Math.random()*100|0)-50,this.cameraAnticheatOffsetZ=(Math.random()*110|0)-55,this.cameraAnticheatAngle=(Math.random()*80|0)-40,this.minimapAnticheatAngle=(Math.random()*120|0)-60,this.minimapZoom=(Math.random()*30|0)-20,this.orbitCameraYaw=(Math.random()*20|0)-10&2047,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0,this.npcCount=0;for(let N=0;N<2048;N++)this.players[N]=null,this.playerAppearanceBuffer[N]=null;for(let N=0;N<8192;N++)this.npcs[N]=null;this.localPlayer=this.players[2047]=new K0,this.projectiles.clear(),this.spotanims.clear();for(let N=0;N<4;N++)for(let L=0;L<104;L++)for(let H=0;H<104;H++)this.objStacks[N][L][H]=null;this.addedLocs=new m0,this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,this.designGenderMale=!0,this.validateCharacterDesign();for(let N=0;N<5;N++)this.designColors[N]=0;p.oplogic1=0,p.oplogic2=0,p.oplogic3=0,p.oplogic4=0,p.oplogic5=0,p.oplogic6=0,p.oplogic7=0,p.oplogic8=0,p.oplogic9=0,this.prepareGameScreen();return}if(G===3){this.loginMessage0="",this.loginMessage1="Invalid username or password.";return}if(G===4){this.loginMessage0="Your account has been disabled.",this.loginMessage1="Please check your message-centre for details.";return}if(G===5){this.loginMessage0="Your account is already logged in.",this.loginMessage1="Try again in 60 secs...";return}if(G===6){this.loginMessage0="RuneScape has been updated!",this.loginMessage1="Please reload this page.";return}if(G===7){this.loginMessage0="This world is full.",this.loginMessage1="Please use a different world.";return}if(G===8){this.loginMessage0="Unable to connect.",this.loginMessage1="Login server offline.";return}if(G===9){this.loginMessage0="Login limit exceeded.",this.loginMessage1="Too many connections from your address.";return}if(G===10){this.loginMessage0="Unable to connect.",this.loginMessage1="Bad session id.";return}if(G===11){this.loginMessage1="Login server rejected session.",this.loginMessage1="Please try again.";return}if(G===12){this.loginMessage0="You need a members account to login to this world.",this.loginMessage1="Please subscribe, or use a different world.";return}if(G===13){this.loginMessage0="Could not complete login.",this.loginMessage1="Please try using a different world.";return}if(G===14){this.loginMessage0="The server is being updated.",this.loginMessage1="Please wait 1 minute and try again.";return}if(G===15){this.ingame=!0,this.out.pos=0,this.in.pos=0,this.inPacketType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.inPacketSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,this.menuVisible=!1;return}if(G===16){this.loginMessage0="Login attempts exceeded.",this.loginMessage1="Please wait 1 minute and try again.";return}if(G===17)this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first"}catch(b){this.loginMessage0="",this.loginMessage1="Error connecting to server."}}async updateGame(){if(this.players===null)return;if(this.systemUpdateTimer>1)this.systemUpdateTimer--;if(this.idleTimeout>0)this.idleTimeout--;for(let _=0;_<5&&await this.read();_++);if(this.ingame){for(let R=0;R<this.waveCount;R++)if(this.waveDelay[R]<=0){try{let E=E0.generate(this.waveIds[R],this.waveLoops[R]);if(!E)throw new Error;if(Date.now()+(E.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0))this.lastWaveLength=E.pos,this.lastWaveStartTime=Date.now(),this.lastWaveId=this.waveIds[R],this.lastWaveLoops=this.waveLoops[R],await g_(E.data.slice(0,E.pos))}catch(E){}this.waveCount--;for(let E=R;E<this.waveCount;E++)this.waveIds[E]=this.waveIds[E+1],this.waveLoops[E]=this.waveLoops[E+1],this.waveDelay[E]=this.waveDelay[E+1];R--}else this.waveDelay[R]--;if(this.nextMusicDelay>0){if(this.nextMusicDelay-=20,this.nextMusicDelay<0)this.nextMusicDelay=0;if(this.nextMusicDelay===0&&this.midiActive&&!p.lowMemory&&this.currentMidi)await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,!1)}let _=$0.flush();if(_)this.out.p1isaac(81),this.out.p2(_.pos),this.out.pdata(_.data,_.pos,0),_.release();if(this.updateSceneState(),this.updateAddedLocs(),this.idleNetCycles++,this.idleNetCycles>250)await this.tryReconnect();if(this.updatePlayers(),this.updateNpcs(),this.updateEntityChats(),(this.actionKey[1]===1||this.actionKey[2]===1||this.actionKey[3]===1||this.actionKey[4]===1)&&this.cameraMovedWrite++>5)this.cameraMovedWrite=0,this.out.p1isaac(189),this.out.p2(this.orbitCameraPitch),this.out.p2(this.orbitCameraYaw),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom);if(this.sceneDelta++,this.crossMode!==0){if(this.crossCycle+=20,this.crossCycle>=400)this.crossMode=0}if(this.selectedArea!==0){if(this.selectedCycle++,this.selectedCycle>=15){if(this.selectedArea===2)this.redrawSidebar=!0;if(this.selectedArea===3)this.redrawChatback=!0;this.selectedArea=0}}if(this.objDragArea!==0){if(this.objDragCycles++,this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)this.objGrabThreshold=!0;if(this.mouseButton===0){if(this.objDragArea===2)this.redrawSidebar=!0;if(this.objDragArea===3)this.redrawChatback=!0;if(this.objDragArea=0,this.objGrabThreshold&&this.objDragCycles>=5){if(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){let R=s.instances[this.objDragInterfaceId];if(R.invSlotObjId){let E=R.invSlotObjId[this.hoveredSlot];R.invSlotObjId[this.hoveredSlot]=R.invSlotObjId[this.objDragSlot],R.invSlotObjId[this.objDragSlot]=E}if(R.invSlotObjCount){let E=R.invSlotObjCount[this.hoveredSlot];R.invSlotObjCount[this.hoveredSlot]=R.invSlotObjCount[this.objDragSlot],R.invSlotObjCount[this.objDragSlot]=E}this.out.p1isaac(159),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot)}}else if((this.mouseButtonsOption===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)this.showContextMenu();else if(this.menuSize>0)await this.useMenuOption(this.menuSize-1);this.selectedCycle=10,this.mouseClickButton=0}}if(p.cyclelogic3++,p.cyclelogic3>127)p.cyclelogic3=0,this.out.p1isaac(215),this.out.p3(4991788);if(V.clickTileX!==-1){if(this.localPlayer){let R=V.clickTileX,E=V.clickTileZ,b=this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],R,E,0,0,0,0,0,0,!0);if(V.clickTileX=-1,b)this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=1,this.crossCycle=0}}if(this.mouseClickButton===1&&this.modalMessage)this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0;if(await this.handleMouseInput(),this.handleMinimapInput(),this.handleTabInput(),this.handleChatSettingsInput(),this.mouseButton===1||this.mouseClickButton===1)this.dragCycles++;if(this.sceneState===2)this.updateOrbitCamera();if(this.sceneState===2&&this.cutscene)this.applyCutscene();for(let R=0;R<5;R++)this.cameraModifierCycle[R]++;if(await this.handleInputKey(),Date.now()-this.idleCycles>90000)this.idleTimeout=250,this.idleCycles=Date.now()-1e4,this.out.p1isaac(70);if(this.cameraOffsetCycle++,this.cameraOffsetCycle>500){this.cameraOffsetCycle=0;let R=Math.random()*8|0;if((R&1)===1)this.cameraAnticheatOffsetX+=this.cameraOffsetXModifier;if((R&2)===2)this.cameraAnticheatOffsetZ+=this.cameraOffsetZModifier;if((R&4)===4)this.cameraAnticheatAngle+=this.cameraOffsetYawModifier}if(this.cameraAnticheatOffsetX<-50)this.cameraOffsetXModifier=2;if(this.cameraAnticheatOffsetX>50)this.cameraOffsetXModifier=-2;if(this.cameraAnticheatOffsetZ<-55)this.cameraOffsetZModifier=2;if(this.cameraAnticheatOffsetZ>55)this.cameraOffsetZModifier=-2;if(this.cameraAnticheatAngle<-40)this.cameraOffsetYawModifier=1;if(this.cameraAnticheatAngle>40)this.cameraOffsetYawModifier=-1;if(this.minimapOffsetCycle++,this.minimapOffsetCycle>500){this.minimapOffsetCycle=0;let R=Math.random()*8|0;if((R&1)===1)this.minimapAnticheatAngle+=this.minimapAngleModifier;if((R&2)===2)this.minimapZoom+=this.minimapZoomModifier}if(this.minimapAnticheatAngle<-60)this.minimapAngleModifier=2;if(this.minimapAnticheatAngle>60)this.minimapAngleModifier=-2;if(this.minimapZoom<-20)this.minimapZoomModifier=1;if(this.minimapZoom>10)this.minimapZoomModifier=-1;if(p.cyclelogic4++,p.cyclelogic4>110)p.cyclelogic4=0,this.out.p1isaac(236),this.out.p4(0);if(this.heartbeatTimer++,this.heartbeatTimer>50)this.out.p1isaac(108);try{if(this.netStream&&this.out.pos>0)this.netStream.write(this.out.data,this.out.pos),this.out.pos=0,this.heartbeatTimer=0}catch(R){await this.tryReconnect()}}}updateSceneState(){if(p.lowMemory&&this.sceneState===2&&a.levelBuilt!==this.currentLevel)this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(8,11),this.sceneState=1;if(this.sceneState===1)this.checkScene();if(this.sceneState===2&&this.currentLevel!==this.minimapLevel)this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel)}checkScene(){if(!this.sceneMapLandData||!this.sceneMapLandReady||!this.sceneMapLocData||!this.sceneMapLocReady)return-1000;for(let _=0;_<this.sceneMapLandReady.length;_++){if(this.sceneMapLandReady[_]===!1)return-1;if(this.sceneMapLocReady[_]===!1)return-2}if(this.sceneAwaitingSync)return-3;return this.sceneState=2,a.levelBuilt=this.currentLevel,this.buildScene(),0}updateAddedLocs(){if(this.sceneState!==2)return;for(let _=this.addedLocs.head();_;_=this.addedLocs.next()){if(_.duration>0)_.duration--;if(_.duration!=0){if(_.delay>0)_.delay--;if(_.delay===0&&_.x>=1&&_.z>=1&&_.x<=102&&_.z<=102){if(this.addLoc(_.plane,_.x,_.z,_.locIndex,_.locAngle,_.shape,_.layer),_.delay=-1,_.lastLocIndex===_.locIndex&&_.lastLocIndex===-1)_.unlink();else if(_.lastLocIndex===_.locIndex&&_.lastAngle===_.locAngle&&_.lastShape===_.shape)_.unlink()}}else this.addLoc(_.plane,_.x,_.z,_.lastLocIndex,_.lastAngle,_.lastShape,_.layer),_.unlink()}if(p.cyclelogic5++,p.cyclelogic5>85)p.cyclelogic5=0,this.out.p1isaac(85)}clearAddedLocs(){for(let _=this.addedLocs.head();_;_=this.addedLocs.next())if(_.duration===-1)_.delay=0,this.storeLoc(_);else _.unlink()}appendLoc(_,R,E,b,G,N,L,H,I){let Q=null;for(let q=this.addedLocs.head();q;q=this.addedLocs.next())if(q.plane===this.currentLevel&&q.x===H&&q.z===G&&q.layer===b){Q=q;break}if(!Q)Q=new I_,Q.plane=L,Q.layer=b,Q.x=H,Q.z=G,this.storeLoc(Q),this.addedLocs.addTail(Q);Q.locIndex=R,Q.shape=N,Q.locAngle=E,Q.delay=I,Q.duration=_}storeLoc(_){if(!this.scene)return;let R=0,E=-1,b=0,G=0;if(_.layer===0)R=this.scene.getWallTypecode(_.plane,_.x,_.z);else if(_.layer===1)R=this.scene.getDecorTypecode(_.plane,_.z,_.x);else if(_.layer===2)R=this.scene.getLocTypecode(_.plane,_.x,_.z);else if(_.layer===3)R=this.scene.getGroundDecorTypecode(_.plane,_.x,_.z);if(R!==0){let N=this.scene.getInfo(_.plane,_.x,_.z,R);E=R>>14&32767,b=N&31,G=N>>6}_.lastLocIndex=E,_.lastShape=b,_.lastAngle=G}drawGame(){if(this.players===null)return;if(this.redrawTitleBackground){if(this.redrawTitleBackground=!1,this.areaBackleft1?.draw(0,11),this.areaBackleft2?.draw(0,375),this.areaBackright1?.draw(729,5),this.areaBackright2?.draw(752,231),this.areaBacktop1?.draw(0,0),this.areaBacktop2?.draw(561,0),this.areaBackvmid1?.draw(520,11),this.areaBackvmid2?.draw(520,231),this.areaBackvmid3?.draw(501,375),this.areaBackhmid2?.draw(0,345),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,this.sceneState!==2)this.areaViewport?.draw(8,11),this.areaMapback?.draw(561,5)}if(this.sceneState===2)this.drawScene();if(this.menuVisible&&this.menuArea===1)this.redrawSidebar=!0;let _=!1;if(this.sidebarInterfaceId!==-1){if(_=this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta),_)this.redrawSidebar=!0}if(this.selectedArea===2)this.redrawSidebar=!0;if(this.objDragArea===2)this.redrawSidebar=!0;if(this.redrawSidebar)this.drawSidebar(),this.redrawSidebar=!1;if(this.chatInterfaceId===-1){if(this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,this.mouseX>453&&this.mouseX<565&&this.mouseY>350)this.handleScrollInput(this.mouseX-22,this.mouseY-375,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let R=this.chatScrollHeight-this.chatInterface.scrollPosition-77;if(R<0)R=0;if(R>this.chatScrollHeight-77)R=this.chatScrollHeight-77;if(this.chatScrollOffset!==R)this.chatScrollOffset=R,this.redrawChatback=!0}if(this.chatInterfaceId!==-1){if(_=this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta),_)this.redrawChatback=!0}if(this.selectedArea===3)this.redrawChatback=!0;if(this.objDragArea===3)this.redrawChatback=!0;if(this.modalMessage)this.redrawChatback=!0;if(this.menuVisible&&this.menuArea===2)this.redrawChatback=!0;if(this.redrawChatback)this.drawChatback(),this.redrawChatback=!1;if(this.sceneState===2)this.drawMinimap(),this.areaMapback?.draw(561,5);if(this.flashingTab!==-1)this.redrawSideicons=!0;if(this.redrawSideicons){if(this.flashingTab!==-1&&this.flashingTab===this.selectedTab)this.flashingTab=-1,this.out.p1isaac(175),this.out.p1(this.selectedTab);if(this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===0)this.imageRedstone1?.draw(29,30);else if(this.selectedTab===1)this.imageRedstone2?.draw(59,29);else if(this.selectedTab===2)this.imageRedstone2?.draw(87,29);else if(this.selectedTab===3)this.imageRedstone3?.draw(115,29);else if(this.selectedTab===4)this.imageRedstone2h?.draw(156,29);else if(this.selectedTab===5)this.imageRedstone2h?.draw(184,29);else if(this.selectedTab===6)this.imageRedstone1h?.draw(212,30)}if(this.tabInterfaceId[0]!==-1&&(this.flashingTab!==0||this.loopCycle%20<10))this.imageSideicons[0]?.draw(35,34);if(this.tabInterfaceId[1]!==-1&&(this.flashingTab!==1||this.loopCycle%20<10))this.imageSideicons[1]?.draw(59,32);if(this.tabInterfaceId[2]!==-1&&(this.flashingTab!==2||this.loopCycle%20<10))this.imageSideicons[2]?.draw(86,32);if(this.tabInterfaceId[3]!==-1&&(this.flashingTab!==3||this.loopCycle%20<10))this.imageSideicons[3]?.draw(121,33);if(this.tabInterfaceId[4]!==-1&&(this.flashingTab!==4||this.loopCycle%20<10))this.imageSideicons[4]?.draw(157,34);if(this.tabInterfaceId[5]!==-1&&(this.flashingTab!==5||this.loopCycle%20<10))this.imageSideicons[5]?.draw(185,32);if(this.tabInterfaceId[6]!==-1&&(this.flashingTab!==6||this.loopCycle%20<10))this.imageSideicons[6]?.draw(212,34)}if(this.areaBackhmid1?.draw(520,165),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===7)this.imageRedstone1v?.draw(49,0);else if(this.selectedTab===8)this.imageRedstone2v?.draw(81,0);else if(this.selectedTab===9)this.imageRedstone2v?.draw(108,0);else if(this.selectedTab===10)this.imageRedstone3v?.draw(136,1);else if(this.selectedTab===11)this.imageRedstone2hv?.draw(178,0);else if(this.selectedTab===12)this.imageRedstone2hv?.draw(205,0);else if(this.selectedTab===13)this.imageRedstone1hv?.draw(233,0)}if(this.tabInterfaceId[8]!==-1&&(this.flashingTab!==8||this.loopCycle%20<10))this.imageSideicons[7]?.draw(80,2);if(this.tabInterfaceId[9]!==-1&&(this.flashingTab!==9||this.loopCycle%20<10))this.imageSideicons[8]?.draw(107,3);if(this.tabInterfaceId[10]!==-1&&(this.flashingTab!==10||this.loopCycle%20<10))this.imageSideicons[9]?.draw(142,4);if(this.tabInterfaceId[11]!==-1&&(this.flashingTab!==11||this.loopCycle%20<10))this.imageSideicons[10]?.draw(179,2);if(this.tabInterfaceId[12]!==-1&&(this.flashingTab!==12||this.loopCycle%20<10))this.imageSideicons[11]?.draw(206,2);if(this.tabInterfaceId[13]!==-1&&(this.flashingTab!==13||this.loopCycle%20<10))this.imageSideicons[12]?.draw(230,2)}this.areaBackbase2?.draw(501,492),this.areaViewport?.bind()}if(this.redrawPrivacySettings){if(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(57,33,"Public chat",16777215,!0),this.publicChatSetting===0)this.fontPlain12?.drawStringTaggableCenter(57,46,"On",65280,!0);if(this.publicChatSetting===1)this.fontPlain12?.drawStringTaggableCenter(57,46,"Friends",16776960,!0);if(this.publicChatSetting===2)this.fontPlain12?.drawStringTaggableCenter(57,46,"Off",16711680,!0);if(this.publicChatSetting===3)this.fontPlain12?.drawStringTaggableCenter(57,46,"Hide",65535,!0);if(this.fontPlain12?.drawStringTaggableCenter(186,33,"Private chat",16777215,!0),this.privateChatSetting===0)this.fontPlain12?.drawStringTaggableCenter(186,46,"On",65280,!0);if(this.privateChatSetting===1)this.fontPlain12?.drawStringTaggableCenter(186,46,"Friends",16776960,!0);if(this.privateChatSetting===2)this.fontPlain12?.drawStringTaggableCenter(186,46,"Off",16711680,!0);if(this.fontPlain12?.drawStringTaggableCenter(326,33,"Trade/duel",16777215,!0),this.tradeChatSetting===0)this.fontPlain12?.drawStringTaggableCenter(326,46,"On",65280,!0);if(this.tradeChatSetting===1)this.fontPlain12?.drawStringTaggableCenter(326,46,"Friends",16776960,!0);if(this.tradeChatSetting===2)this.fontPlain12?.drawStringTaggableCenter(326,46,"Off",16711680,!0);this.fontPlain12?.drawStringTaggableCenter(462,38,"Report abuse",16777215,!0),this.areaBackbase1?.draw(0,471),this.areaViewport?.bind()}this.sceneDelta=0}drawScene(){if(this.sceneCycle++,this.pushPlayers(),this.pushNpcs(),this.pushProjectiles(),this.pushSpotanims(),this.pushLocs(),!this.cutscene){let H=this.orbitCameraPitch;if((this.cameraPitchClamp/256|0)>H)H=this.cameraPitchClamp/256|0;if(this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>H)H=this.cameraModifierWobbleScale[4]+128;let I=this.orbitCameraYaw+this.cameraAnticheatAngle&2047;if(this.localPlayer)this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,I,H,H*3+600);if(p.cyclelogic2++,p.cyclelogic2>1802){p.cyclelogic2=0,this.out.p1isaac(146),this.out.p1(0);let Q=this.out.pos;if(this.out.p2(29711),this.out.p1(70),this.out.p1(Math.random()*256|0),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),(Math.random()*2|0)===0)this.out.p1(13);if((Math.random()*2|0)===0)this.out.p2(57856);this.out.p2(Math.random()*65536|0),this.out.psize1(this.out.pos-Q)}}let _;if(this.cutscene)_=this.getTopLevelCutscene();else _=this.getTopLevel();let R=this.cameraX,E=this.cameraY,b=this.cameraZ,G=this.cameraPitch,N=this.cameraYaw,L;for(let H=0;H<5;H++)if(this.cameraModifierEnabled[H]){if(L=Math.random()*(this.cameraModifierJitter[H]*2+1)-this.cameraModifierJitter[H]+Math.sin(this.cameraModifierCycle[H]*(this.cameraModifierWobbleSpeed[H]/100))*this.cameraModifierWobbleScale[H]|0,H===0)this.cameraX+=L;if(H===1)this.cameraY+=L;if(H===2)this.cameraZ+=L;if(H===3)this.cameraYaw=this.cameraYaw+L&2047;if(H===4){if(this.cameraPitch+=L,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}}L=w.cycle,J.checkHover=!0,J.pickedCount=0,J.mouseX=this.mouseX-8,J.mouseY=this.mouseY-11,T.clear(),this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,_,this.cameraYaw,this.cameraPitch,this.loopCycle),this.scene?.clearTemporaryLocs(),this.draw2DEntityElements(),this.drawTileHint(),this.updateTextures(L),this.draw3DEntityElements(),this.areaViewport?.draw(8,11),this.cameraX=R,this.cameraY=E,this.cameraZ=b,this.cameraPitch=G,this.cameraYaw=N}clearCaches(){Q0.modelCacheStatic?.clear(),Q0.modelCacheDynamic?.clear(),w0.modelCache?.clear(),_0.modelCache?.clear(),_0.iconCache?.clear(),K0.modelCache?.clear(),T0.modelCache?.clear()}projectFromEntity(_,R){this.projectFromGround(_.x,R,_.z)}projectFromGround(_,R,E){if(_<128||E<128||_>13056||E>13056){this.projectX=-1,this.projectY=-1;return}let b=this.getHeightmapY(this.currentLevel,_,E)-R;this.project(_,b,E)}project(_,R,E){let b=_-this.cameraX,G=R-this.cameraY,N=E-this.cameraZ,L=w.sin[this.cameraPitch],H=w.cos[this.cameraPitch],I=w.sin[this.cameraYaw],Q=w.cos[this.cameraYaw],q=N*I+b*Q>>16;if(N=N*Q-b*I>>16,b=q,q=G*H-N*L>>16,N=G*L+N*H>>16,G=q,N>=50)this.projectX=w.centerX+((b<<9)/N|0),this.projectY=w.centerY+((G<<9)/N|0);else this.projectX=-1,this.projectY=-1}draw2DEntityElements(){this.chatCount=0;for(let _=-1;_<this.playerCount+this.npcCount;_++){let R=null;if(_===-1)R=this.localPlayer;else if(_<this.playerCount)R=this.players[this.playerIds[_]];else R=this.npcs[this.npcIds[_-this.playerCount]];if(!R||!R.isVisibleNow())continue;if(_<this.playerCount){let E=30,b=R;if(b.headicons!==0){if(this.projectFromEntity(R,R.maxY+15),this.projectX>-1){for(let G=0;G<8;G++)if((b.headicons&1<<G)!==0)this.imageHeadicons[G]?.draw(this.projectX-12,this.projectY-E),E-=25}}if(_>=0&&this.hintType===10&&this.hintPlayer===this.playerIds[_]){if(this.projectFromEntity(R,R.maxY+15),this.projectX>-1)this.imageHeadicons[7]?.draw(this.projectX-12,this.projectY-E)}}else if(this.hintType===1&&this.hintNpc===this.npcIds[_-this.playerCount]&&this.loopCycle%20<10){if(this.projectFromEntity(R,R.maxY+15),this.projectX>-1)this.imageHeadicons[2]?.draw(this.projectX-12,this.projectY-28)}if(R.chat&&(_>=this.playerCount||this.publicChatSetting===0||this.publicChatSetting===3||this.publicChatSetting===1&&this.isFriend(R.name))){if(this.projectFromEntity(R,R.maxY),this.projectX>-1&&this.chatCount<50&&this.fontBold12){if(this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(R.chat)/2|0,this.chatHeight[this.chatCount]=this.fontBold12.height2d,this.chatX[this.chatCount]=this.projectX,this.chatY[this.chatCount]=this.projectY,this.chatColors[this.chatCount]=R.chatColor,this.chatStyles[this.chatCount]=R.chatStyle,this.chatTimers[this.chatCount]=R.chatTimer,this.chats[this.chatCount++]=R.chat,this.chatEffects===0&&R.chatStyle===1)this.chatHeight[this.chatCount]+=10,this.chatY[this.chatCount]+=5;if(this.chatEffects===0&&R.chatStyle===2)this.chatWidth[this.chatCount]=60}}if(R.combatCycle>this.loopCycle+100){if(this.projectFromEntity(R,R.maxY+15),this.projectX>-1){let E=R.health*30/R.totalHealth|0;if(E>30)E=30;T.fillRect2d(this.projectX-15,this.projectY-3,E,5,65280),T.fillRect2d(this.projectX-15+E,this.projectY-3,30-E,5,16711680)}}if(R.combatCycle>this.loopCycle+330){if(this.projectFromEntity(R,R.maxY/2|0),this.projectX>-1)this.imageHitmarks[R.damageType]?.draw(this.projectX-12,this.projectY-12),this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,R.damage.toString(),0),this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,R.damage.toString(),16777215)}}for(let _=0;_<this.chatCount;_++){let R=this.chatX[_],E=this.chatY[_],b=this.chatWidth[_],G=this.chatHeight[_],N=!0;while(N){N=!1;for(let H=0;H<_;H++)if(E+2>this.chatY[H]-this.chatHeight[H]&&E-G<this.chatY[H]+2&&R-b<this.chatX[H]+this.chatWidth[H]&&R+b>this.chatX[H]-this.chatWidth[H]&&this.chatY[H]-this.chatHeight[H]<E)E=this.chatY[H]-this.chatHeight[H],N=!0}this.projectX=this.chatX[_],this.projectY=this.chatY[_]=E;let L=this.chats[_];if(this.chatEffects===0){let H=16776960;if(this.chatColors[_]<6)H=p.CHAT_COLORS[this.chatColors[_]];if(this.chatColors[_]===6)H=this.sceneCycle%20<10?16711680:16776960;if(this.chatColors[_]===7)H=this.sceneCycle%20<10?255:65535;if(this.chatColors[_]===8)H=this.sceneCycle%20<10?45056:8454016;if(this.chatColors[_]===9){let I=150-this.chatTimers[_];if(I<50)H=I*1280+16711680;else if(I<100)H=16776960-(I-50)*327680;else if(I<150)H=(I-100)*5+65280}if(this.chatColors[_]===10){let I=150-this.chatTimers[_];if(I<50)H=I*5+16711680;else if(I<100)H=16711935-(I-50)*327680;else if(I<150)H=(I-100)*327680+255-(I-100)*5}if(this.chatColors[_]===11){let I=150-this.chatTimers[_];if(I<50)H=16777215-I*327685;else if(I<100)H=(I-50)*327685+65280;else if(I<150)H=16777215-(I-100)*327680}if(this.chatStyles[_]===0)this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,L,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,L,H);if(this.chatStyles[_]===1)this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,L,0,this.sceneCycle),this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,L,H,this.sceneCycle);if(this.chatStyles[_]===2){let I=this.fontBold12?.stringWidth(L)??0,Q=(150-this.chatTimers[_])*(I+100)/150;T.setBounds(this.projectX-50,0,this.projectX+50,334),this.fontBold12?.drawString(this.projectX+50-Q,this.projectY+1,L,0),this.fontBold12?.drawString(this.projectX+50-Q,this.projectY,L,H),T.resetBounds()}}else this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,L,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,L,16776960)}}drawTileHint(){if(this.hintType!==2||!this.imageHeadicons[2])return;if(this.projectFromGround((this.hintTileX-this.sceneBaseTileX<<7)+this.hintOffsetX,this.hintHeight*2,(this.hintTileZ-this.sceneBaseTileZ<<7)+this.hintOffsetZ),this.projectX>-1&&this.loopCycle%20<10)this.imageHeadicons[2].draw(this.projectX-12,this.projectY-28)}draw3DEntityElements(){if(this.drawPrivateMessages(),this.crossMode===1)this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-8,this.crossY-8-11);if(this.crossMode===2)this.imageCrosses[(this.crossCycle/100|0)+4]?.draw(this.crossX-8-8,this.crossY-8-11);if(this.viewportInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(s.instances[this.viewportInterfaceId],0,0,0);if(this.drawWildyLevel(),!this.menuVisible)this.handleInput(),this.drawTooltip();else if(this.menuArea===0)this.drawMenu();if(this.inMultizone===1)if(this.wildernessLevel>0||this.worldLocationState===1)this.imageHeadicons[1]?.draw(472,258);else this.imageHeadicons[1]?.draw(472,296);if(this.wildernessLevel>0)this.imageHeadicons[0]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,16776960);if(this.worldLocationState===1)this.imageHeadicons[6]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",16776960);if(this.displayFps){let _=507,R=20,E=16776960;if(this.fps<15)E=16711680;this.fontPlain12?.drawStringRight(_,R,"Fps:"+this.fps,E),R+=15;let b=-1;if(typeof window.performance.memory!=="undefined")b=window.performance.memory.usedJSHeapSize/1024|0;if(b!==-1)this.fontPlain12?.drawStringRight(_,R,"Mem:"+b+"k",16776960)}if(this.systemUpdateTimer!==0){let _=this.systemUpdateTimer/50|0,R=_/60|0;if(_%=60,_<10)this.fontPlain12?.drawString(4,329,"System update in: "+R+":0"+_,16776960);else this.fontPlain12?.drawString(4,329,"System update in: "+R+":"+_,16776960)}}drawPrivateMessages(){if(this.splitPrivateChat===0)return;let _=this.fontPlain12,R=0;if(this.systemUpdateTimer!==0)R=1;for(let E=0;E<100;E++){if(!this.messageText[E])continue;let b=this.messageTextType[E],G;if((b===3||b===7)&&(b===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageTextSender[E]))){if(G=329-R*13,_?.drawString(4,G,"From "+this.messageTextSender[E]+": "+this.messageText[E],0),_?.drawString(4,G-1,"From "+this.messageTextSender[E]+": "+this.messageText[E],65535),R++,R>=5)return}if(b===5&&this.privateChatSetting<2){if(G=329-R*13,_?.drawString(4,G,this.messageText[E],0),_?.drawString(4,G-1,this.messageText[E],65535),R++,R>=5)return}if(b===6&&this.privateChatSetting<2){if(G=329-R*13,_?.drawString(4,G,"To "+this.messageTextSender[E]+": "+this.messageText[E],0),_?.drawString(4,G-1,"To "+this.messageTextSender[E]+": "+this.messageText[E],65535),R++,R>=5)return}}}drawWildyLevel(){if(!this.localPlayer)return;let _=(this.localPlayer.x>>7)+this.sceneBaseTileX,R=(this.localPlayer.z>>7)+this.sceneBaseTileZ;if(_>=2944&&_<3392&&R>=3520&&R<6400)this.wildernessLevel=((R-3520)/8|0)+1;else if(_>=2944&&_<3392&&R>=9920&&R<12800)this.wildernessLevel=((R-9920)/8|0)+1;else this.wildernessLevel=0;if(this.worldLocationState=0,_>=3328&&_<3392&&R>=3200&&R<3264){let E=_&63,b=R&63;if(E>=4&&E<=29&&b>=44&&b<=58)this.worldLocationState=1;else if(E>=36&&E<=61&&b>=44&&b<=58)this.worldLocationState=1;else if(E>=4&&E<=29&&b>=25&&b<=39)this.worldLocationState=1;else if(E>=36&&E<=61&&b>=25&&b<=39)this.worldLocationState=1;else if(E>=4&&E<=29&&b>=6&&b<=20)this.worldLocationState=1;else if(E>=36&&E<=61&&b>=6&&b<=20)this.worldLocationState=1}if(this.worldLocationState===0&&_>=3328&&_<=3393&&R>=3203&&R<=3325)this.worldLocationState=2;if(this.overrideChat=0,_>=3053&&_<=3156&&R>=3056&&R<=3136)this.overrideChat=1;else if(_>=3072&&_<=3118&&R>=9492&&R<=9535)this.overrideChat=1;if(this.overrideChat===1&&_>=3139&&_<=3199&&R>=3008&&R<=3062)this.overrideChat=0}drawSidebar(){if(this.areaSidebar?.bind(),this.areaSidebarOffsets)w.lineOffset=this.areaSidebarOffsets;if(this.imageInvback?.draw(0,0),this.sidebarInterfaceId!==-1)this.drawInterface(s.instances[this.sidebarInterfaceId],0,0,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.drawInterface(s.instances[this.tabInterfaceId[this.selectedTab]],0,0,0);if(this.menuVisible&&this.menuArea===1)this.drawMenu();if(this.areaSidebar?.draw(562,231),this.areaViewport?.bind(),this.areaViewportOffsets)w.lineOffset=this.areaViewportOffsets}drawChatback(){if(this.areaChatback?.bind(),this.areaChatbackOffsets)w.lineOffset=this.areaChatbackOffsets;if(this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,0),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",128);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",0),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",128);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,0),this.fontBold12?.drawStringCenter(239,60,"Click to continue",128);else if(this.chatInterfaceId!==-1)this.drawInterface(s.instances[this.chatInterfaceId],0,0,0);else if(this.stickyChatInterfaceId===-1){let _=this.fontPlain12,R=0;T.setBounds(0,0,463,77);for(let E=0;E<100;E++){let b=this.messageText[E];if(!b)continue;let G=this.messageTextType[E],N=this.chatScrollOffset+70-R*14;if(G===0){if(N>0&&N<110)_?.drawString(4,N,b,0);R++}if(G===1){if(N>0&&N<110)_?.drawString(4,N,this.messageTextSender[E]+":",16777215),_?.drawString(_.stringWidth(this.messageTextSender[E])+12,N,b,255);R++}if(G===2&&(this.publicChatSetting===0||this.publicChatSetting===1&&this.isFriend(this.messageTextSender[E]))){if(N>0&&N<110)_?.drawString(4,N,this.messageTextSender[E]+":",0),_?.drawString(_.stringWidth(this.messageTextSender[E])+12,N,b,255);R++}if((G===3||G===7)&&this.splitPrivateChat===0&&(G===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageTextSender[E]))){if(N>0&&N<110)_?.drawString(4,N,"From "+this.messageTextSender[E]+":",0),_?.drawString(_.stringWidth("From "+this.messageTextSender[E])+12,N,b,8388608);R++}if(G===4&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageTextSender[E]))){if(N>0&&N<110)_?.drawString(4,N,this.messageTextSender[E]+" "+this.messageText[E],8388736);R++}if(G===5&&this.splitPrivateChat===0&&this.privateChatSetting<2){if(N>0&&N<110)_?.drawString(4,N,b,8388608);R++}if(G===6&&this.splitPrivateChat===0&&this.privateChatSetting<2){if(N>0&&N<110)_?.drawString(4,N,"To "+this.messageTextSender[E]+":",0),_?.drawString(_.stringWidth("To "+this.messageTextSender[E])+12,N,b,8388608);R++}if(G===8&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageTextSender[E]))){if(N>0&&N<110)_?.drawString(4,N,this.messageTextSender[E]+" "+this.messageText[E],13350793);R++}}if(T.resetBounds(),this.chatScrollHeight=R*14+7,this.chatScrollHeight<78)this.chatScrollHeight=78;this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77),_?.drawString(4,90,l.formatName(this.usernameInput)+":",0),_?.drawString(_.stringWidth(this.usernameInput+": ")+6,90,this.chatTyped+"*",255),T.drawHorizontalLine(0,77,0,479)}else this.drawInterface(s.instances[this.stickyChatInterfaceId],0,0,0);if(this.menuVisible&&this.menuArea===2)this.drawMenu();if(this.areaChatback?.draw(22,375),this.areaViewport?.bind(),this.areaViewportOffsets)w.lineOffset=this.areaViewportOffsets}drawMinimap(){if(this.areaMapback?.bind(),!this.localPlayer)return;let _=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,R=(this.localPlayer.x/32|0)+48,E=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(21,9,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,R,E,_,this.minimapZoom+256),this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let b=0;b<this.activeMapFunctionCount;b++)R=this.activeMapFunctionX[b]*4+2-(this.localPlayer.x/32|0),E=this.activeMapFunctionZ[b]*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(E,this.activeMapFunctions[b],R);for(let b=0;b<104;b++)for(let G=0;G<104;G++)if(this.objStacks[this.currentLevel][b][G])R=b*4+2-(this.localPlayer.x/32|0),E=G*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(E,this.imageMapdot0,R);for(let b=0;b<this.npcCount;b++){let G=this.npcs[this.npcIds[b]];if(G&&G.isVisibleNow()&&G.npcType&&G.npcType.minimap)R=(G.x/32|0)-(this.localPlayer.x/32|0),E=(G.z/32|0)-(this.localPlayer.z/32|0),this.drawOnMinimap(E,this.imageMapdot1,R)}for(let b=0;b<this.playerCount;b++){let G=this.players[this.playerIds[b]];if(G&&G.isVisibleNow()&&G.name){R=(G.x/32|0)-(this.localPlayer.x/32|0),E=(G.z/32|0)-(this.localPlayer.z/32|0);let N=!1,L=l.toBase37(G.name);for(let H=0;H<this.friendCount;H++)if(L===this.friendName37[H]&&this.friendWorld[H]!==0){N=!0;break}if(N)this.drawOnMinimap(E,this.imageMapdot3,R);else this.drawOnMinimap(E,this.imageMapdot2,R)}}if(this.flagSceneTileX!==0)R=this.flagSceneTileX*4+2-(this.localPlayer.x/32|0),E=this.flagSceneTileZ*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(E,this.imageMapflag,R);T.fillRect2d(93,82,3,3,16777215),this.areaViewport?.bind()}drawOnMinimap(_,R,E){if(!R)return;let b=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,G=E*E+_*_;if(G>6400)return;let N=w.sin[b],L=w.cos[b];N=N*256/(this.minimapZoom+256)|0,L=L*256/(this.minimapZoom+256)|0;let H=_*N+E*L>>16,I=_*L-E*N>>16;if(G>2500&&this.imageMapback)R.drawMasked(H+94-(R.cropW/2|0),83-I-(R.cropH/2|0),this.imageMapback);else R.draw(H+94-(R.cropW/2|0),83-I-(R.cropH/2|0))}createMinimap(_){if(!this.imageMinimap)return;let R=this.imageMinimap.pixels,E=R.length;for(let N=0;N<E;N++)R[N]=0;for(let N=1;N<104-1;N++){let L=(104-1-N)*512*4+24628;for(let H=1;H<104-1;H++){if(this.levelTileFlags&&(this.levelTileFlags[_][H][N]&24)===0)this.scene?.drawMinimapTile(_,H,N,R,L,512);if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][H][N]&8)!==0)this.scene?.drawMinimapTile(_+1,H,N,R,L,512);L+=4}}let b=((Math.random()*20|0)+238-10<<16)+((Math.random()*20|0)+238-10<<8)+(Math.random()*20|0)+238-10,G=(Math.random()*20|0)+238-10<<16;this.imageMinimap.bind();for(let N=1;N<104-1;N++)for(let L=1;L<104-1;L++){if(this.levelTileFlags&&(this.levelTileFlags[_][L][N]&24)===0)this.drawMinimapLoc(L,N,_,b,G);if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][L][N]&8)!==0)this.drawMinimapLoc(L,N,_+1,b,G)}this.areaViewport?.bind(),this.activeMapFunctionCount=0;for(let N=0;N<104;N++)for(let L=0;L<104;L++){let H=this.scene?.getGroundDecorTypecode(this.currentLevel,N,L)??0;if(H===0)continue;H=H>>14&32767;let I=Q0.get(H).mapfunction;if(I<0)continue;let Q=N,q=L;if(I!==22&&I!==29&&I!==34&&I!==36&&I!==46&&I!==47&&I!==48){let O=104,U=104,$=this.levelCollisionMap[this.currentLevel];if($){let K=$.flags;for(let u=0;u<10;u++){let F=Math.random()*4|0;if(F===0&&Q>0&&Q>N-3&&(K[o.index(Q-1,q)]&2621704)===0)Q--;if(F===1&&Q<O-1&&Q<N+3&&(K[o.index(Q+1,q)]&2621824)===0)Q++;if(F===2&&q>0&&q>L-3&&(K[o.index(Q,q-1)]&2621698)===0)q--;if(F===3&&q<U-1&&q<L+3&&(K[o.index(Q,q+1)]&2621728)===0)q++}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[I],this.activeMapFunctionX[this.activeMapFunctionCount]=Q,this.activeMapFunctionZ[this.activeMapFunctionCount]=q,this.activeMapFunctionCount++}}drawMinimapLoc(_,R,E,b,G){if(!this.scene||!this.imageMinimap)return;let N=this.scene.getWallTypecode(E,_,R);if(N!==0){let L=this.scene.getInfo(E,_,R,N),H=L>>6&3,I=L&31,Q=b;if(N>0)Q=G;let q=this.imageMinimap.pixels,O=_*4+(103-R)*512*4+24624,U=N>>14&32767,$=Q0.get(U);if($.mapscene===-1){if(I===h.WALL_STRAIGHT.id||I===h.WALL_L.id){if(H===0)q[O]=Q,q[O+512]=Q,q[O+1024]=Q,q[O+1536]=Q;else if(H===1)q[O]=Q,q[O+1]=Q,q[O+2]=Q,q[O+3]=Q;else if(H===2)q[O+3]=Q,q[O+3+512]=Q,q[O+3+1024]=Q,q[O+3+1536]=Q;else if(H===3)q[O+1536]=Q,q[O+1536+1]=Q,q[O+1536+2]=Q,q[O+1536+3]=Q}if(I===h.WALL_SQUARE_CORNER.id){if(H===0)q[O]=Q;else if(H===1)q[O+3]=Q;else if(H===2)q[O+3+1536]=Q;else if(H===3)q[O+1536]=Q}if(I===h.WALL_L.id){if(H===3)q[O]=Q,q[O+512]=Q,q[O+1024]=Q,q[O+1536]=Q;else if(H===0)q[O]=Q,q[O+1]=Q,q[O+2]=Q,q[O+3]=Q;else if(H===1)q[O+3]=Q,q[O+3+512]=Q,q[O+3+1024]=Q,q[O+3+1536]=Q;else if(H===2)q[O+1536]=Q,q[O+1536+1]=Q,q[O+1536+2]=Q,q[O+1536+3]=Q}}else{let K=this.imageMapscene[$.mapscene];if(K){let u=($.width*4-K.width2d)/2|0,F=($.length*4-K.height2d)/2|0;K.draw(_*4+48+u,(104-R-$.length)*4+F+48)}}}if(N=this.scene.getLocTypecode(E,_,R),N!==0){let L=this.scene.getInfo(E,_,R,N),H=L>>6&3,I=L&31,Q=N>>14&32767,q=Q0.get(Q);if(q.mapscene!==-1){let O=this.imageMapscene[q.mapscene];if(O){let U=(q.width*4-O.width2d)/2|0,$=(q.length*4-O.height2d)/2|0;O.draw(_*4+48+U,(104-R-q.length)*4+$+48)}}else if(I===h.WALL_DIAGONAL.id){let O=15658734;if(N>0)O=15597568;let U=this.imageMinimap.pixels,$=_*4+(104-1-R)*512*4+24624;if(H===0||H===2)U[$+1536]=O,U[$+1024+1]=O,U[$+512+2]=O,U[$+3]=O;else U[$]=O,U[$+512+1]=O,U[$+1024+2]=O,U[$+1536+3]=O}}if(N=this.scene.getGroundDecorTypecode(E,_,R),N!==0){let L=Q0.get(N>>14&32767);if(L.mapscene!==-1){let H=this.imageMapscene[L.mapscene];if(H){let I=(L.width*4-H.width2d)/2|0,Q=(L.length*4-H.height2d)/2|0;H.draw(_*4+48+I,(104-R-L.length)*4+Q+48)}}}}drawTooltip(){if(this.menuSize<2&&this.objSelected===0&&this.spellSelected===0)return;let _;if(this.objSelected===1&&this.menuSize<2)_="Use "+this.objSelectedName+" with...";else if(this.spellSelected===1&&this.menuSize<2)_=this.spellCaption+"...";else _=this.menuOption[this.menuSize-1];if(this.menuSize>2)_=_+"@whi@ / "+(this.menuSize-2)+" more options";this.fontBold12?.drawStringTooltip(4,15,_,16777215,!0,this.loopCycle/1000|0)}drawMenu(){let _=this.menuX,R=this.menuY,E=this.menuWidth,b=this.menuHeight,G=6116423;T.fillRect2d(_,R,E,b,G),T.fillRect2d(_+1,R+1,E-2,16,0),T.drawRect(_+1,R+18,E-2,b-19,0),this.fontBold12?.drawString(_+3,R+14,"Choose Option",G);let N=this.mouseX,L=this.mouseY;if(this.menuArea===0)N-=8,L-=11;if(this.menuArea===1)N-=562,L-=231;if(this.menuArea===2)N-=22,L-=375;for(let H=0;H<this.menuSize;H++){let I=R+(this.menuSize-1-H)*15+31,Q=16777215;if(N>_&&N<_+E&&L>I-13&&L<I+3)Q=16776960;this.fontBold12?.drawStringTaggable(_+3,I,this.menuOption[H],Q,!0)}}async handleMouseInput(){if(this.objDragArea!==0)return;let _=this.mouseClickButton;if(this.spellSelected===1&&this.mouseClickX>=520&&this.mouseClickY>=165&&this.mouseClickX<=788&&this.mouseClickY<=230)_=0;if(this.menuVisible){if(_!==1){let R=this.mouseX,E=this.mouseY;if(this.menuArea===0)R-=8,E-=11;else if(this.menuArea===1)R-=562,E-=231;else if(this.menuArea===2)R-=22,E-=375;if(R<this.menuX-10||R>this.menuX+this.menuWidth+10||E<this.menuY-10||E>this.menuY+this.menuHeight+10){if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;if(this.menuArea===2)this.redrawChatback=!0}}if(_===1){let R=this.menuX,E=this.menuY,b=this.menuWidth,G=this.mouseClickX,N=this.mouseClickY;if(this.menuArea===0)G-=8,N-=11;else if(this.menuArea===1)G-=562,N-=231;else if(this.menuArea===2)G-=22,N-=375;let L=-1;for(let H=0;H<this.menuSize;H++){let I=E+(this.menuSize-1-H)*15+31;if(G>R&&G<R+b&&N>I-13&&N<I+3)L=H}if(L!==-1)await this.useMenuOption(L);if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;else if(this.menuArea===2)this.redrawChatback=!0}}else{if(_===1&&this.menuSize>0){let R=this.menuAction[this.menuSize-1];if(R===602||R===596||R===22||R===892||R===415||R===405||R===38||R===422||R===478||R===347||R===188){let E=this.menuParamB[this.menuSize-1],b=this.menuParamC[this.menuSize-1];if(s.instances[b].draggable){if(this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=b,this.objDragSlot=E,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,s.instances[b].layer===this.viewportInterfaceId)this.objDragArea=1;if(s.instances[b].layer===this.chatInterfaceId)this.objDragArea=3;return}}}if(_===1&&(this.mouseButtonsOption===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)_=2;if(_===1&&this.menuSize>0)await this.useMenuOption(this.menuSize-1);if(_!==2||this.menuSize<=0)return;this.showContextMenu()}}handleMinimapInput(){if(this.mouseClickButton===1&&this.localPlayer){let _=this.mouseClickX-21-561,R=this.mouseClickY-9-5;if(_>=0&&R>=0&&_<146&&R<151){_-=73,R-=75;let E=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,b=w.sin[E],G=w.cos[E];b=b*(this.minimapZoom+256)>>8,G=G*(this.minimapZoom+256)>>8;let N=R*b+_*G>>11,L=R*G-_*b>>11,H=this.localPlayer.x+N>>7,I=this.localPlayer.z-L>>7;if(this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],H,I,1,0,0,0,0,0,!0))this.out.p1(_),this.out.p1(R),this.out.p2(this.orbitCameraYaw),this.out.p1(57),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom),this.out.p1(89),this.out.p2(this.localPlayer.x),this.out.p2(this.localPlayer.z),this.out.p1(this.tryMoveNearest),this.out.p1(63)}}}isAddFriendOption(_){if(_<0)return!1;let R=this.menuAction[_];if(R>=2000)R-=2000;return R===406}async useMenuOption(_){if(_<0)return;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;let R=this.menuAction[_],E=this.menuParamA[_],b=this.menuParamB[_],G=this.menuParamC[_];if(R>=2000)R-=2000;if(R===903||R===363){let N=this.menuOption[_],L=N.indexOf("@whi@");if(L!==-1){N=N.substring(L+5).trim();let H=l.formatName(l.fromBase37(l.toBase37(N))),I=!1;for(let Q=0;Q<this.playerCount;Q++){let q=this.players[this.playerIds[Q]];if(q&&q.name&&q.name.toLowerCase()===H.toLowerCase()&&this.localPlayer){if(this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],q.routeFlagX[0],q.routeFlagZ[0],2,1,1,0,0,0,!1),R===903)this.out.p1isaac(206);else if(R===363)this.out.p1isaac(164);this.out.p2(this.playerIds[Q]),I=!0;break}}if(!I)this.addMessage(0,"Unable to find "+H,"")}}else if(R===450&&this.interactWithLoc(75,b,G,E))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface);else if(R===405||R===38||R===422||R===478||R===347){if(R===478){if((b&3)===0)p.oplogic5++;if(p.oplogic5>=90)this.out.p1isaac(220);this.out.p1isaac(157)}else if(R===347)this.out.p1isaac(211);else if(R===422)this.out.p1isaac(133);else if(R===405){if(p.oplogic3+=E,p.oplogic3>=97)this.out.p1isaac(30),this.out.p3(14953816);this.out.p1isaac(195)}else if(R===38)this.out.p1isaac(71);if(this.out.p2(E),this.out.p2(b),this.out.p2(G),this.selectedCycle=0,this.selectedInterface=G,this.selectedItem=b,this.selectedArea=2,s.instances[G].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.instances[G].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===728||R===542||R===6||R===963||R===245){let N=this.npcs[E];if(N&&this.localPlayer){if(this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],N.routeFlagX[0],N.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===542)this.out.p1isaac(8);else if(R===6){if((E&3)===0)p.oplogic2++;if(p.oplogic2>=124)this.out.p1isaac(88),this.out.p4(0);this.out.p1isaac(27)}else if(R===963)this.out.p1isaac(113);else if(R===728)this.out.p1isaac(194);else if(R===245){if((E&3)===0)p.oplogic4++;if(p.oplogic4>=85)this.out.p1isaac(176),this.out.p2(39596);this.out.p1isaac(100)}this.out.p2(E)}}else if(R===217){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],b,G,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],b,G,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(239),this.out.p2(b+this.sceneBaseTileX),this.out.p2(G+this.sceneBaseTileZ),this.out.p2(E),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}}else if(R===1175){let N=E>>14&32767,L=Q0.get(N),H;if(!L.desc)H="It's a "+L.name+".";else H=L.desc;this.addMessage(0,H,"")}else if(R===285)this.interactWithLoc(245,b,G,E);else if(R===881){if(this.out.p1isaac(130),this.out.p2(E),this.out.p2(b),this.out.p2(G),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=G,this.selectedItem=b,this.selectedArea=2,s.instances[G].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.instances[G].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===391){if(this.out.p1isaac(48),this.out.p2(E),this.out.p2(b),this.out.p2(G),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=G,this.selectedItem=b,this.selectedArea=2,s.instances[G].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.instances[G].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===660)if(this.menuVisible)this.scene?.click(b-8,G-11);else this.scene?.click(this.mouseClickX-8,this.mouseClickY-11);else if(R===188){this.objSelected=1,this.objSelectedSlot=b,this.objSelectedInterface=G,this.objInterface=E,this.objSelectedName=_0.get(E).name,this.spellSelected=0;return}else if(R===44){if(!this.pressedContinueOption)this.out.p1isaac(235),this.out.p2(G),this.pressedContinueOption=!0}else if(R===1773){let N=_0.get(E),L;if(G>=1e5)L=G+" x "+N.name;else if(!N.desc)L="It's a "+N.name+".";else L=N.desc;this.addMessage(0,L,"")}else if(R===900){let N=this.npcs[E];if(N&&this.localPlayer)this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],N.routeFlagX[0],N.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(202),this.out.p2(E),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(R===1373||R===1544||R===151||R===1101){let N=this.players[E];if(N&&this.localPlayer){if(this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],N.routeFlagX[0],N.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===1101)this.out.p1isaac(164);else if(R===151){if(p.oplogic8++,p.oplogic8>=90)this.out.p1isaac(2),this.out.p2(31114);this.out.p1isaac(53)}else if(R===1373)this.out.p1isaac(206);else if(R===1544)this.out.p1isaac(185);this.out.p2(E)}}else if(R===265){let N=this.npcs[E];if(N&&this.localPlayer)this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],N.routeFlagX[0],N.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(134),this.out.p2(E),this.out.p2(this.activeSpellId)}else if(R===679){let N=this.menuOption[_],L=N.indexOf("@whi@");if(L!==-1){let H=l.toBase37(N.substring(L+5).trim()),I=-1;for(let Q=0;Q<this.friendCount;Q++)if(this.friendName37[Q]===H){I=Q;break}if(I!==-1&&this.friendWorld[I]>0)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=3,this.socialName37=this.friendName37[I],this.socialMessage="Enter message to send to "+this.friendName[I]}}else if(R===55){if(this.interactWithLoc(9,b,G,E))this.out.p2(this.activeSpellId)}else if(R===224||R===993||R===99||R===746||R===877){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],b,G,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],b,G,2,1,1,0,0,0,!1);if(this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===224)this.out.p1isaac(140);else if(R===746)this.out.p1isaac(178);else if(R===877)this.out.p1isaac(247);else if(R===99)this.out.p1isaac(200);else if(R===993)this.out.p1isaac(40);this.out.p2(b+this.sceneBaseTileX),this.out.p2(G+this.sceneBaseTileZ),this.out.p2(E)}}else if(R===1607){let N=this.npcs[E];if(N&&N.npcType){let L;if(!N.npcType.desc)L="It's a "+N.npcType.name+".";else L=N.npcType.desc;this.addMessage(0,L,"")}}else if(R===504)this.interactWithLoc(172,b,G,E);else if(R===930){let N=s.instances[G];this.spellSelected=1,this.activeSpellId=G,this.activeSpellFlags=N.actionTarget,this.objSelected=0;let L=N.actionVerb;if(L&&L.indexOf(" ")!==-1)L=L.substring(0,L.indexOf(" "));let H=N.actionVerb;if(H&&H.indexOf(" ")!==-1)H=H.substring(H.indexOf(" ")+1);if(this.spellCaption=L+" "+N.action+" "+H,this.activeSpellFlags===16)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;return}else if(R===951){let N=s.instances[G],L=!0;if(N.clientCode>0)L=this.handleInterfaceAction(N);if(L)this.out.p1isaac(155),this.out.p2(G)}else if(R===602||R===596||R===22||R===892||R===415){if(R===22)this.out.p1isaac(212);else if(R===415){if((G&3)===0)p.oplogic7++;if(p.oplogic7>=55)this.out.p1isaac(17),this.out.p4(0);this.out.p1isaac(6)}else if(R===602)this.out.p1isaac(31);else if(R===892){if((b&3)===0)p.oplogic9++;if(p.oplogic9>=130)this.out.p1isaac(238),this.out.p1(177);this.out.p1isaac(38)}else if(R===596)this.out.p1isaac(59);if(this.out.p2(E),this.out.p2(b),this.out.p2(G),this.selectedCycle=0,this.selectedInterface=G,this.selectedItem=b,this.selectedArea=2,s.instances[G].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.instances[G].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===581){if((E&3)===0)p.oplogic1++;if(p.oplogic1>=99)this.out.p1isaac(7),this.out.p4(0);this.interactWithLoc(97,b,G,E)}else if(R===965){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],b,G,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],b,G,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(138),this.out.p2(b+this.sceneBaseTileX),this.out.p2(G+this.sceneBaseTileZ),this.out.p2(E),this.out.p2(this.activeSpellId)}}else if(R===1501){if(p.oplogic6+=this.sceneBaseTileZ,p.oplogic6>=92)this.out.p1isaac(66),this.out.p4(0);this.interactWithLoc(116,b,G,E)}else if(R===364)this.interactWithLoc(96,b,G,E);else if(R===1102){let N=_0.get(E),L;if(!N.desc)L="It's a "+N.name+".";else L=N.desc;this.addMessage(0,L,"")}else if(R===960){this.out.p1isaac(155),this.out.p2(G);let N=s.instances[G];if(N.script&&N.script[0]&&N.script[0][0]===5){let L=N.script[0][1];if(N.scriptOperand&&this.varps[L]!==N.scriptOperand[0])this.varps[L]=N.scriptOperand[0],await this.updateVarp(L),this.redrawSidebar=!0}}else if(R===34){let N=this.menuOption[_],L=N.indexOf("@whi@");if(L!==-1){this.closeInterfaces(),this.reportAbuseInput=N.substring(L+5).trim(),this.reportAbuseMuteOption=!1;for(let H=0;H<s.instances.length;H++)if(s.instances[H]&&s.instances[H].clientCode===600){this.reportAbuseInterfaceID=this.viewportInterfaceId=s.instances[H].layer;break}}}else if(R===947)this.closeInterfaces();else if(R===367){let N=this.players[E];if(N&&this.localPlayer)this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],N.routeFlagX[0],N.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(248),this.out.p2(E),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(R===465){this.out.p1isaac(155),this.out.p2(G);let N=s.instances[G];if(N.script&&N.script[0]&&N.script[0][0]===5){let L=N.script[0][1];this.varps[L]=1-this.varps[L],await this.updateVarp(L),this.redrawSidebar=!0}}else if(R===406||R===436||R===557||R===556){let N=this.menuOption[_],L=N.indexOf("@whi@");if(L!==-1){let H=l.toBase37(N.substring(L+5).trim());if(R===406)this.addFriend(H);else if(R===436)this.addIgnore(H);else if(R===557)this.removeFriend(H);else if(R===556)this.removeIgnore(H)}}else if(R===651){let N=this.players[E];if(N&&this.localPlayer)this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],N.routeFlagX[0],N.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(177),this.out.p2(E),this.out.p2(this.activeSpellId)}this.objSelected=0,this.spellSelected=0}handleInterfaceAction(_){let R=_.clientCode;if(R===201)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=1,this.socialMessage="Enter name of friend to add to list";if(R===202)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=2,this.socialMessage="Enter name of friend to delete from list";if(R===205)return this.idleTimeout=250,!0;if(R===501)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=4,this.socialMessage="Enter name of player to add to list";if(R===502)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=5,this.socialMessage="Enter name of player to delete from list";if(R>=300&&R<=313){let E=(R-300)/2|0,b=R&1,G=this.designIdentikits[E];if(G!==-1)while(!0){if(b===0){if(G--,G<0)G=Y0.totalCount-1}if(b===1){if(G++,G>=Y0.totalCount)G=0}if(!Y0.instances[G].disableKit&&Y0.instances[G].bodyPart===E+(this.designGenderMale?0:7)){this.designIdentikits[E]=G,this.updateDesignModel=!0;break}}}if(R>=314&&R<=323){let E=(R-314)/2|0,b=R&1,G=this.designColors[E];if(b===0){if(G--,G<0)G=K0.DESIGN_IDK_COLORS[E].length-1}if(b===1){if(G++,G>=K0.DESIGN_IDK_COLORS[E].length)G=0}this.designColors[E]=G,this.updateDesignModel=!0}if(R===324&&!this.designGenderMale)this.designGenderMale=!0,this.validateCharacterDesign();if(R===325&&this.designGenderMale)this.designGenderMale=!1,this.validateCharacterDesign();if(R===326){this.out.p1isaac(52),this.out.p1(this.designGenderMale?0:1);for(let E=0;E<7;E++)this.out.p1(this.designIdentikits[E]);for(let E=0;E<5;E++)this.out.p1(this.designColors[E]);return!0}if(R===613)this.reportAbuseMuteOption=!this.reportAbuseMuteOption;if(R>=601&&R<=612){if(this.closeInterfaces(),this.reportAbuseInput.length>0)this.out.p1isaac(190),this.out.p8(l.toBase37(this.reportAbuseInput)),this.out.p1(R-601),this.out.p1(this.reportAbuseMuteOption?1:0)}return!1}validateCharacterDesign(){this.updateDesignModel=!0;for(let _=0;_<7;_++){this.designIdentikits[_]=-1;for(let R=0;R<Y0.totalCount;R++)if(!Y0.instances[R].disableKit&&Y0.instances[R].bodyPart===_+(this.designGenderMale?0:7)){this.designIdentikits[_]=R;break}}}interactWithLoc(_,R,E,b){if(!this.localPlayer||!this.scene)return!1;let G=b>>14&32767,N=this.scene.getInfo(this.currentLevel,R,E,b);if(N===-1)return!1;let L=N&31,H=N>>6&3;if(L===h.CENTREPIECE_STRAIGHT.id||L===h.CENTREPIECE_DIAGONAL.id||L===h.GROUND_DECOR.id){let I=Q0.get(G),Q,q;if(H===0||H===2)Q=I.width,q=I.length;else Q=I.length,q=I.width;let O=I.forceapproach;if(H!==0)O=(O<<H&15)+(O>>4-H);this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],R,E,2,Q,q,0,0,O,!1)}else this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],R,E,2,0,0,H,L+1,0,!1);return this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(_),this.out.p2(R+this.sceneBaseTileX),this.out.p2(E+this.sceneBaseTileZ),this.out.p2(G),!0}handleTabInput(){if(this.mouseClickButton===1){if(this.mouseClickX>=549&&this.mouseClickX<=583&&this.mouseClickY>=195&&this.mouseClickY<231&&this.tabInterfaceId[0]!==-1)this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0;else if(this.mouseClickX>=579&&this.mouseClickX<=609&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[1]!==-1)this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0;else if(this.mouseClickX>=607&&this.mouseClickX<=637&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[2]!==-1)this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0;else if(this.mouseClickX>=635&&this.mouseClickX<=679&&this.mouseClickY>=194&&this.mouseClickY<229&&this.tabInterfaceId[3]!==-1)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;else if(this.mouseClickX>=676&&this.mouseClickX<=706&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[4]!==-1)this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0;else if(this.mouseClickX>=704&&this.mouseClickX<=734&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[5]!==-1)this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0;else if(this.mouseClickX>=732&&this.mouseClickX<=766&&this.mouseClickY>=195&&this.mouseClickY<231&&this.tabInterfaceId[6]!==-1)this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0;else if(this.mouseClickX>=550&&this.mouseClickX<=584&&this.mouseClickY>=492&&this.mouseClickY<528&&this.tabInterfaceId[7]!==-1)this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0;else if(this.mouseClickX>=582&&this.mouseClickX<=612&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[8]!==-1)this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0;else if(this.mouseClickX>=609&&this.mouseClickX<=639&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[9]!==-1)this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0;else if(this.mouseClickX>=637&&this.mouseClickX<=681&&this.mouseClickY>=493&&this.mouseClickY<528&&this.tabInterfaceId[10]!==-1)this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0;else if(this.mouseClickX>=679&&this.mouseClickX<=709&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[11]!==-1)this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0;else if(this.mouseClickX>=706&&this.mouseClickX<=736&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[12]!==-1)this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0;else if(this.mouseClickX>=734&&this.mouseClickX<=768&&this.mouseClickY>=492&&this.mouseClickY<528&&this.tabInterfaceId[13]!==-1)this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0;if(p.cyclelogic1++,p.cyclelogic1>150)p.cyclelogic1=0,this.out.p1isaac(233),this.out.p1(43)}}async handleInputKey(){while(!0){let _;do while(!0){if(_=this.pollKey(),_===-1)return;if(this.viewportInterfaceId!==-1&&this.viewportInterfaceId===this.reportAbuseInterfaceID){if(_===8&&this.reportAbuseInput.length>0)this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1);break}if(this.showSocialInput){if(_>=32&&_<=122&&this.socialInput.length<80)this.socialInput=this.socialInput+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.socialInput.length>0)this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0;if(_===13||_===10){this.showSocialInput=!1,this.redrawChatback=!0;let R;if(this.socialAction===1)R=l.toBase37(this.socialInput),this.addFriend(R);if(this.socialAction===2&&this.friendCount>0)R=l.toBase37(this.socialInput),this.removeFriend(R);if(this.socialAction===3&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(148),this.out.p1(0);let E=this.out.pos;if(this.out.p8(this.socialName37),f0.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-E),this.socialInput=l.toSentenceCase(this.socialInput),this.socialInput=P0.filter(this.socialInput),this.addMessage(6,this.socialInput,l.formatName(l.fromBase37(this.socialName37))),this.privateChatSetting===2)this.privateChatSetting=1,this.redrawPrivacySettings=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting)}if(this.socialAction===4&&this.ignoreCount<100)R=l.toBase37(this.socialInput),this.addIgnore(R);if(this.socialAction===5&&this.ignoreCount>0)R=l.toBase37(this.socialInput),this.removeIgnore(R)}}else if(this.chatbackInputOpen){if(_>=48&&_<=57&&this.chatbackInput.length<10)this.chatbackInput=this.chatbackInput+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.chatbackInput.length>0)this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0;if(_===13||_===10){if(this.chatbackInput.length>0){let R=0;try{R=parseInt(this.chatbackInput,10)}catch(E){}this.out.p1isaac(237),this.out.p4(R)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(this.chatInterfaceId===-1){if(_>=32&&(_<=122||this.chatTyped.startsWith("::")&&_<=126)&&this.chatTyped.length<80)this.chatTyped=this.chatTyped+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.chatTyped.length>0)this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0;if((_===13||_===10)&&this.chatTyped.length>0){if(this.chatTyped.startsWith("::"))if(this.chatTyped==="::fpson")this.displayFps=!0;else if(this.chatTyped==="::fpsoff")this.displayFps=!1;else if(this.chatTyped.startsWith("::fps "))try{let R=parseInt(this.chatTyped.substring(6))||50;this.setTargetedFramerate(R)}catch(R){}else this.out.p1isaac(4),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let R=0;if(this.chatTyped.startsWith("yellow:"))R=0,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("red:"))R=1,this.chatTyped=this.chatTyped.substring(4);else if(this.chatTyped.startsWith("green:"))R=2,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("cyan:"))R=3,this.chatTyped=this.chatTyped.substring(5);else if(this.chatTyped.startsWith("purple:"))R=4,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("white:"))R=5,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("flash1:"))R=6,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash2:"))R=7,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash3:"))R=8,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("glow1:"))R=9,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow2:"))R=10,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow3:"))R=11,this.chatTyped=this.chatTyped.substring(6);let E=0;if(this.chatTyped.startsWith("wave:"))E=1,this.chatTyped=this.chatTyped.substring(5);if(this.chatTyped.startsWith("scroll:"))E=2,this.chatTyped=this.chatTyped.substring(7);this.out.p1isaac(158),this.out.p1(0);let b=this.out.pos;if(this.out.p1(R),this.out.p1(E),f0.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-b),this.chatTyped=l.toSentenceCase(this.chatTyped),this.chatTyped=P0.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name)this.localPlayer.chat=this.chatTyped,this.localPlayer.chatColor=R,this.localPlayer.chatStyle=E,this.localPlayer.chatTimer=150,this.addMessage(2,this.localPlayer.chat,this.localPlayer.name);if(this.publicChatSetting===2)this.publicChatSetting=3,this.redrawPrivacySettings=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting)}this.chatTyped="",this.redrawChatback=!0}}}while((_<97||_>122)&&(_<65||_>90)&&(_<48||_>57)&&_!==32);if(this.reportAbuseInput.length<12)this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(_)}}handleChatSettingsInput(){if(this.mouseClickButton===1){if(this.mouseClickX>=8&&this.mouseClickX<=108&&this.mouseClickY>=490&&this.mouseClickY<=522)this.publicChatSetting=(this.publicChatSetting+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=137&&this.mouseClickX<=237&&this.mouseClickY>=490&&this.mouseClickY<=522)this.privateChatSetting=(this.privateChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=275&&this.mouseClickX<=375&&this.mouseClickY>=490&&this.mouseClickY<=522)this.tradeChatSetting=(this.tradeChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=416&&this.mouseClickX<=516&&this.mouseClickY>=490&&this.mouseClickY<=522){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let _=0;_<s.instances.length;_++)if(s.instances[_]&&s.instances[_].clientCode===600){this.reportAbuseInterfaceID=this.viewportInterfaceId=s.instances[_].layer;return}}}}handleScrollInput(_,R,E,b,G,N,L,H){if(this.scrollGrabbed)this.scrollInputPadding=32;else this.scrollInputPadding=0;if(this.scrollGrabbed=!1,_>=N&&_<N+16&&R>=L&&R<L+16){if(H.scrollPosition-=this.dragCycles*4,G)this.redrawSidebar=!0}else if(_>=N&&_<N+16&&R>=L+b-16&&R<L+b){if(H.scrollPosition+=this.dragCycles*4,G)this.redrawSidebar=!0}else if(_>=N-this.scrollInputPadding&&_<N+this.scrollInputPadding+16&&R>=L+16&&R<L+b-16&&this.dragCycles>0){let I=(b-32)*b/E|0;if(I<8)I=8;let Q=R-L-(I/2|0)-16,q=b-I-32;if(H.scrollPosition=(E-b)*Q/q|0,G)this.redrawSidebar=!0;this.scrollGrabbed=!0}}prepareGameScreen(){if(!this.areaChatback)this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new b0(479,96),this.areaMapback=new b0(168,160),T.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new b0(190,261),this.areaViewport=new b0(512,334),T.clear(),this.areaBackbase1=new b0(501,61),this.areaBackbase2=new b0(288,40),this.areaBackhmid1=new b0(269,66),this.redrawTitleBackground=!0}isFriend(_){if(!_)return!1;for(let R=0;R<this.friendCount;R++)if(_.toLowerCase()===this.friendName[R]?.toLowerCase())return!0;if(!this.localPlayer)return!1;return _.toLowerCase()===this.localPlayer.name?.toLowerCase()}addFriend(_){if(_===0n)return;if(this.friendCount>=100){this.addMessage(0,"Your friends list is full. Max of 100 hit","");return}let R=l.formatName(l.fromBase37(_));for(let E=0;E<this.friendCount;E++)if(this.friendName37[E]===_){this.addMessage(0,R+" is already on your friend list","");return}for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===_){this.addMessage(0,"Please remove "+R+" from your ignore list first","");return}if(!this.localPlayer||!this.localPlayer.name)return;if(R!==this.localPlayer.name)this.friendName[this.friendCount]=R,this.friendName37[this.friendCount]=_,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(118),this.out.p8(_)}removeFriend(_){if(_===0n)return;for(let R=0;R<this.friendCount;R++)if(this.friendName37[R]===_){this.friendCount--,this.redrawSidebar=!0;for(let E=R;E<this.friendCount;E++)this.friendName[E]=this.friendName[E+1],this.friendWorld[E]=this.friendWorld[E+1],this.friendName37[E]=this.friendName37[E+1];this.out.p1isaac(11),this.out.p8(_);return}}addIgnore(_){if(_===0n)return;if(this.ignoreCount>=100){this.addMessage(0,"Your ignore list is full. Max of 100 hit","");return}let R=l.formatName(l.fromBase37(_));for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===_){this.addMessage(0,R+" is already on your ignore list","");return}for(let E=0;E<this.friendCount;E++)if(this.friendName37[E]===_){this.addMessage(0,"Please remove "+R+" from your friend list first","");return}this.ignoreName37[this.ignoreCount++]=_,this.redrawSidebar=!0,this.out.p1isaac(79),this.out.p8(_)}removeIgnore(_){if(_===0n)return;for(let R=0;R<this.ignoreCount;R++)if(this.ignoreName37[R]===_){this.ignoreCount--,this.redrawSidebar=!0;for(let E=R;E<this.ignoreCount;E++)this.ignoreName37[E]=this.ignoreName37[E+1];this.out.p1isaac(171),this.out.p8(_);return}}sortObjStacks(_,R){let E=this.objStacks[this.currentLevel][_][R];if(!E){this.scene?.removeObjStack(this.currentLevel,_,R);return}let b=-99999999,G=null;for(let $=E.head();$;$=E.next()){let K=_0.get($.index),u=K.cost;if(K.stackable)u*=$.count+1;if(u>b)b=u,G=$}if(!G)return;E.addHead(G);let N=-1,L=-1,H=0,I=0;for(let $=E.head();$;$=E.next()){if($.index!==G.index&&N===-1)N=$.index,H=$.count;if($.index!==G.index&&$.index!==N&&L===-1)L=$.index,I=$.count}let Q=null;if(N!==-1)Q=_0.get(N).getInterfaceModel(H);let q=null;if(L!==-1)q=_0.get(L).getInterfaceModel(I);let O=_+(R<<7)+1610612736|0,U=_0.get(G.index);this.scene?.addObjStack(_,R,this.getHeightmapY(this.currentLevel,_*128+64,R*128+64),this.currentLevel,O,U.getInterfaceModel(G.count),q,Q)}addLoc(_,R,E,b,G,N,L){if(R<1||E<1||R>102||E>102)return;if(p.lowMemory&&_!==this.currentLevel)return;if(!this.scene)return;let H=0;if(L===0)H=this.scene.getWallTypecode(_,R,E);else if(L===1)H=this.scene.getDecorTypecode(_,E,R);else if(L===2)H=this.scene.getLocTypecode(_,R,E);else if(L===3)H=this.scene.getGroundDecorTypecode(_,R,E);if(H!==0){let I=this.scene.getInfo(_,R,E,H),Q=H>>14&32767,q=I&31,O=I>>6;if(L===0){this.scene?.removeWall(_,R,E,1);let U=Q0.get(Q);if(U.blockwalk)this.levelCollisionMap[_]?.removeWall(R,E,q,O,U.blockrange)}else if(L===1)this.scene?.removeWallDecoration(_,R,E);else if(L===2){this.scene.removeLoc(_,R,E);let U=Q0.get(Q);if(R+U.width>104-1||E+U.width>104-1||R+U.length>104-1||E+U.length>104-1)return;if(U.blockwalk)this.levelCollisionMap[_]?.removeLoc(R,E,U.width,U.length,O,U.blockrange)}else if(L===3){this.scene?.removeGroundDecoration(_,R,E);let U=Q0.get(Q);if(U.blockwalk&&U.locActive)this.levelCollisionMap[_]?.removeFloor(R,E)}}if(b>=0){let I=_;if(this.levelTileFlags&&_<3&&(this.levelTileFlags[1][R][E]&2)===2)I=_+1;if(this.levelHeightmap)a.addLoc(_,R,E,this.scene,this.levelHeightmap,this.locList,this.levelCollisionMap[_],b,N,G,I)}}closeInterfaces(){if(this.out.p1isaac(231),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1;this.viewportInterfaceId=-1}async tryReconnect(){if(this.idleTimeout>0)await this.logout();else if(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",0),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",16777215),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",0),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",16777215),this.areaViewport?.draw(8,11),this.flagSceneTileX=0,this.netStream?.close(),this.ingame=!1,await this.tryLogin(this.usernameInput,this.passwordInput,!0),!this.ingame)await this.logout()}async logout(){if(this.netStream)this.netStream.close();this.netStream=null,this.ingame=!1,this.titleScreenState=0,this.usernameInput="",this.passwordInput="",$0.setDisabled(),this.clearCaches(),this.scene?.reset();for(let _=0;_<4;_++)this.levelCollisionMap[_]?.reset();S_(!1),this.currentMidi=null,this.nextMusicDelay=0}async read(){if(!this.netStream)return!1;try{let _=this.netStream.available;if(_===0)return!1;if(this.inPacketType===-1){if(await this.netStream.readBytes(this.in.data,0,1),this.inPacketType=this.in.data[0]&255,this.randomIn)this.inPacketType=this.inPacketType-this.randomIn.nextInt&255;this.inPacketSize=M_[this.inPacketType],_--}if(this.inPacketSize===-1){if(_<=0)return!1;await this.netStream.readBytes(this.in.data,0,1),this.inPacketSize=this.in.data[0]&255,_--}if(this.inPacketSize===-2){if(_<=1)return!1;await this.netStream.readBytes(this.in.data,0,2),this.in.pos=0,this.inPacketSize=this.in.g2(),_-=2}if(_<this.inPacketSize)return!1;if(this.in.pos=0,await this.netStream.readBytes(this.in.data,0,this.inPacketSize),this.idleNetCycles=0,this.lastPacketType2=this.lastPacketType1,this.lastPacketType1=this.lastPacketType0,this.lastPacketType0=this.inPacketType,this.inPacketType===150){let R=this.in.g2(),E=this.in.g1b();if(this.varCache[R]=E,this.varps[R]!==E){if(this.varps[R]=E,await this.updateVarp(R),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.inPacketType=-1,!0}if(this.inPacketType===152){let R=this.in.g8(),E=this.in.g1(),b=l.formatName(l.fromBase37(R));for(let N=0;N<this.friendCount;N++)if(R===this.friendName37[N]){if(this.friendWorld[N]!==E){if(this.friendWorld[N]=E,this.redrawSidebar=!0,E>0)this.addMessage(5,b+" has logged in.","");if(E===0)this.addMessage(5,b+" has logged out.","")}b=null;break}if(b&&this.friendCount<100)this.friendName37[this.friendCount]=R,this.friendName[this.friendCount]=b,this.friendWorld[this.friendCount]=E,this.friendCount++,this.redrawSidebar=!0;let G=!1;while(!G){G=!0;for(let N=0;N<this.friendCount-1;N++)if(this.friendWorld[N]!==p.nodeId&&this.friendWorld[N+1]===p.nodeId||this.friendWorld[N]===0&&this.friendWorld[N+1]!==0){let L=this.friendWorld[N];this.friendWorld[N]=this.friendWorld[N+1],this.friendWorld[N+1]=L;let H=this.friendName[N];this.friendName[N]=this.friendName[N+1],this.friendName[N+1]=H;let I=this.friendName37[N];this.friendName37[N]=this.friendName37[N+1],this.friendName37[N+1]=I,this.redrawSidebar=!0,G=!1}}return this.inPacketType=-1,!0}if(this.inPacketType===43)return this.systemUpdateTimer=this.in.g2()*30,this.inPacketType=-1,!0;if(this.inPacketType===80){let R=this.in.g1(),E=this.in.g1();if(this.sceneMapIndex&&this.sceneMapLandData&&this.sceneMapLandReady){let b=-1;for(let G=0;G<this.sceneMapIndex.length;G++)if(this.sceneMapIndex[G]===(R<<8)+E)b=G;if(b!==-1)this.db?.cachesave(`m${R}_${E}`,this.sceneMapLandData[b]),this.sceneMapLandReady[b]=!0}return this.inPacketType=-1,!0}if(this.inPacketType===1)return this.readNpcInfo(this.in,this.inPacketSize),this.inPacketType=-1,!0;if(this.inPacketType===237){let R=this.in.g2(),E=this.in.g2();if(this.sceneCenterZoneX===R&&this.sceneCenterZoneZ===E&&this.sceneState!==0)return this.inPacketType=-1,!0;this.sceneCenterZoneX=R,this.sceneCenterZoneZ=E,this.sceneBaseTileX=(this.sceneCenterZoneX-6)*8,this.sceneBaseTileZ=(this.sceneCenterZoneZ-6)*8,this.sceneState=1,this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(8,11);let b=(this.inPacketSize-2)/10|0;this.sceneMapLandData=new C(b,null),this.sceneMapLandReady=new C(b,!1),this.sceneMapLocData=new C(b,null),this.sceneMapLocReady=new C(b,!1),this.sceneMapIndex=new Int32Array(b),this.out.p1isaac(150),this.out.p1(0);let G=0;for(let $=0;$<b;$++){let K=this.in.g1(),u=this.in.g1(),F=this.in.g4(),k=this.in.g4();this.sceneMapIndex[$]=(K<<8)+u;let j;if(F!==0){if(j=await this.db?.cacheload(`m${K}_${u}`),j&&f.crc32(j)!==F)j=void 0;if(!j)this.out.p1(0),this.out.p1(K),this.out.p1(u),G+=3;else this.sceneMapLandData[$]=j,this.sceneMapLandReady[$]=!0}else this.sceneMapLandReady[$]=!0;if(k!==0){if(j=await this.db?.cacheload(`l${K}_${u}`),j&&f.crc32(j)!==k)j=void 0;if(!j)this.out.p1(1),this.out.p1(K),this.out.p1(u),G+=3;else this.sceneMapLocData[$]=j,this.sceneMapLocReady[$]=!0}else this.sceneMapLocReady[$]=!0}if(this.out.psize1(G),this.areaViewport?.bind(),this.sceneState===0)this.fontPlain12?.drawStringCenter(257,166,"Map area updated since last visit, so load will take longer this time only",0),this.fontPlain12?.drawStringCenter(256,165,"Map area updated since last visit, so load will take longer this time only",16777215);this.areaViewport?.draw(8,11);let N=this.sceneBaseTileX-this.scenePrevBaseTileX,L=this.sceneBaseTileZ-this.scenePrevBaseTileZ;this.scenePrevBaseTileX=this.sceneBaseTileX,this.scenePrevBaseTileZ=this.sceneBaseTileZ;for(let $=0;$<8192;$++){let K=this.npcs[$];if(K){for(let u=0;u<10;u++)K.routeFlagX[u]-=N,K.routeFlagZ[u]-=L;K.x-=N*128,K.z-=L*128}}for(let $=0;$<2048;$++){let K=this.players[$];if(K){for(let u=0;u<10;u++)K.routeFlagX[u]-=N,K.routeFlagZ[u]-=L;K.x-=N*128,K.z-=L*128}}this.sceneAwaitingSync=!0;let H=0,I=104,Q=1;if(N<0)H=104-1,I=-1,Q=-1;let q=0,O=104,U=1;if(L<0)q=104-1,O=-1,U=-1;for(let $=H;$!==I;$+=Q)for(let K=q;K!==O;K+=U){let u=$+N,F=K+L;for(let k=0;k<4;k++)if(u>=0&&F>=0&&u<104&&F<104)this.objStacks[k][$][K]=this.objStacks[k][u][F];else this.objStacks[k][$][K]=null}for(let $=this.addedLocs.head();$;$=this.addedLocs.next())if($.x-=N,$.z-=L,$.x<0||$.z<0||$.x>=104||$.z>=104)$.unlink();if(this.flagSceneTileX!==0)this.flagSceneTileX-=N,this.flagSceneTileZ-=L;return this.cutscene=!1,this.inPacketType=-1,!0}if(this.inPacketType===197)return s.instances[this.in.g2()].model=this.localPlayer?.getHeadModel()||null,this.inPacketType=-1,!0;if(this.inPacketType===25){if(this.hintType=this.in.g1(),this.hintType===1)this.hintNpc=this.in.g2();if(this.hintType>=2&&this.hintType<=6){if(this.hintType===2)this.hintOffsetX=64,this.hintOffsetZ=64;if(this.hintType===3)this.hintOffsetX=0,this.hintOffsetZ=64;if(this.hintType===4)this.hintOffsetX=128,this.hintOffsetZ=64;if(this.hintType===5)this.hintOffsetX=64,this.hintOffsetZ=0;if(this.hintType===6)this.hintOffsetX=64,this.hintOffsetZ=128;this.hintType=2,this.hintTileX=this.in.g2(),this.hintTileZ=this.in.g2(),this.hintHeight=this.in.g1()}if(this.hintType===10)this.hintPlayer=this.in.g2();return this.inPacketType=-1,!0}if(this.inPacketType===54){let R=this.in.gjstr(),E=this.in.g4(),b=this.in.g4();if(R!==this.currentMidi&&this.midiActive&&!p.lowMemory)await this.setMidi(R,E,b,!0);return this.currentMidi=R,this.midiCrc=E,this.midiSize=b,this.nextMusicDelay=0,this.inPacketType=-1,!0}if(this.inPacketType===142)return await this.logout(),this.inPacketType=-1,!1;if(this.inPacketType===20){let R=this.in.g1(),E=this.in.g1();if(this.sceneMapIndex&&this.sceneMapLocData&&this.sceneMapLocReady){let b=-1;for(let G=0;G<this.sceneMapIndex.length;G++)if(this.sceneMapIndex[G]===(R<<8)+E)b=G;if(b!==-1)this.db?.cachesave(`l${R}_${E}`,this.sceneMapLocData[b]),this.sceneMapLocReady[b]=!0}return this.inPacketType=-1,!0}if(this.inPacketType===19)return this.flagSceneTileX=0,this.inPacketType=-1,!0;if(this.inPacketType===139)return this.localPid=this.in.g2(),this.inPacketType=-1,!0;if(this.inPacketType===151||this.inPacketType===23||this.inPacketType===50||this.inPacketType===191||this.inPacketType===69||this.inPacketType===49||this.inPacketType===223||this.inPacketType===42||this.inPacketType===76||this.inPacketType===59)return this.readZonePacket(this.in,this.inPacketType),this.inPacketType=-1,!0;if(this.inPacketType===28){let R=this.in.g2(),E=this.in.g2();if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=R,this.sidebarInterfaceId=E,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(this.inPacketType===175){let R=this.in.g2(),E=this.in.g4();if(this.varCache[R]=E,this.varps[R]!==E){if(this.varps[R]=E,await this.updateVarp(R),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.inPacketType=-1,!0}if(this.inPacketType===146){let R=this.in.g2();return s.instances[R].anim=this.in.g2(),this.inPacketType=-1,!0}if(this.inPacketType===167){let R=this.in.g2(),E=this.in.g1();if(R===65535)R=-1;return this.tabInterfaceId[E]=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.inPacketType=-1,!0}if(this.inPacketType===220){let R=this.in.g1(),E=this.in.g1(),b=this.in.g2(),G=this.in.g2(),N=-1;if(this.sceneMapIndex){for(let L=0;L<this.sceneMapIndex.length;L++)if(this.sceneMapIndex[L]===(R<<8)+E)N=L}if(N!==-1&&this.sceneMapLocData){if(!this.sceneMapLocData[N]||this.sceneMapLocData[N]?.length!==G)this.sceneMapLocData[N]=new Uint8Array(G);let L=this.sceneMapLocData[N];if(L)this.in.gdata(this.inPacketSize-6,b,L)}return this.inPacketType=-1,!0}if(this.inPacketType===133){let R=$0.stop();if(R)this.out.p1isaac(81),this.out.p2(R.pos),this.out.pdata(R.data,R.pos,0),R.release();return this.inPacketType=-1,!0}if(this.inPacketType===98){this.redrawSidebar=!0;let R=this.in.g2(),E=s.instances[R],b=this.in.g1();if(E.invSlotObjId&&E.invSlotObjCount){for(let G=0;G<b;G++){E.invSlotObjId[G]=this.in.g2();let N=this.in.g1();if(N===255)N=this.in.g4();E.invSlotObjCount[G]=N}for(let G=b;G<E.invSlotObjId.length;G++)E.invSlotObjId[G]=0,E.invSlotObjCount[G]=0}else for(let G=0;G<b;G++)if(this.in.g2(),this.in.g1()===255)this.in.g4();return this.inPacketType=-1,!0}if(this.inPacketType===226)return $0.setEnabled(),this.inPacketType=-1,!0;if(this.inPacketType===243)return this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.inPacketType=-1,!0;if(this.inPacketType===15){let R=s.instances[this.in.g2()];if(R.invSlotObjId)for(let E=0;E<R.invSlotObjId.length;E++)R.invSlotObjId[E]=-1,R.invSlotObjId[E]=0;return this.inPacketType=-1,!0}if(this.inPacketType===140){if(this.lastAddress=this.in.g4(),this.daysSinceLastLogin=this.in.g2(),this.daysSinceRecoveriesChanged=this.in.g1(),this.unreadMessages=this.in.g2(),this.lastAddress!==0&&this.viewportInterfaceId===-1){this.closeInterfaces();let R=650;if(this.daysSinceRecoveriesChanged!==201)R=655;this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let E=0;E<s.instances.length;E++)if(s.instances[E]&&s.instances[E].clientCode===R){this.viewportInterfaceId=s.instances[E].layer;break}}return this.inPacketType=-1,!0}if(this.inPacketType===126){if(this.flashingTab=this.in.g1(),this.flashingTab===this.selectedTab){if(this.flashingTab===3)this.selectedTab=1;else this.selectedTab=3;this.redrawSidebar=!0}return this.inPacketType=-1,!0}if(this.inPacketType===212){if(this.midiActive&&!p.lowMemory){let R=this.in.g2(),E=this.in.data.subarray(this.in.pos,this.inPacketSize),b=J_.decompress(E,-1,!1,!0);B_(b,this.midiVolume,!1),this.nextMusicDelay=R}return this.inPacketType=-1,!0}if(this.inPacketType===254)return this.inMultizone=this.in.g1(),this.inPacketType=-1,!0;if(this.inPacketType===12){let R=this.in.g2(),E=this.in.g1(),b=this.in.g2();if(this.waveEnabled&&!p.lowMemory&&this.waveCount<50)this.waveIds[this.waveCount]=R,this.waveLoops[this.waveCount]=E,this.waveDelay[this.waveCount]=b+E0.delays[R],this.waveCount++;return this.inPacketType=-1,!0}if(this.inPacketType===204){let R=this.in.g2(),E=this.in.g2(),b=w0.get(E);return s.instances[R].model=b.getHeadModel(),this.inPacketType=-1,!0}if(this.inPacketType===7)return this.baseX=this.in.g1(),this.baseZ=this.in.g1(),this.inPacketType=-1,!0;if(this.inPacketType===103){let R=this.in.g2(),E=this.in.g2(),b=this.in.g2();return s.instances[R].model?.recolor(E,b),this.inPacketType=-1,!0}if(this.inPacketType===32)return this.publicChatSetting=this.in.g1(),this.privateChatSetting=this.in.g1(),this.tradeChatSetting=this.in.g1(),this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.inPacketType=-1,!0;if(this.inPacketType===195){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.sidebarInterfaceId=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(this.inPacketType===14){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.chatInterfaceId=R,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(this.inPacketType===209){let R=this.in.g2(),E=this.in.g2b(),b=this.in.g2b(),G=s.instances[R];return G.x=E,G.y=b,this.inPacketType=-1,!0}if(this.inPacketType===3){if(this.cutscene=!0,this.cutsceneSrcLocalTileX=this.in.g1(),this.cutsceneSrcLocalTileZ=this.in.g1(),this.cutsceneSrcHeight=this.in.g2(),this.cutsceneMoveSpeed=this.in.g1(),this.cutsceneMoveAcceleration=this.in.g1(),this.cutsceneMoveAcceleration>=100)this.cameraX=this.cutsceneSrcLocalTileX*128+64,this.cameraZ=this.cutsceneSrcLocalTileZ*128+64,this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;return this.inPacketType=-1,!0}if(this.inPacketType===135){this.baseX=this.in.g1(),this.baseZ=this.in.g1();for(let R=this.baseX;R<this.baseX+8;R++)for(let E=this.baseZ;E<this.baseZ+8;E++)if(this.objStacks[this.currentLevel][R][E])this.objStacks[this.currentLevel][R][E]=null,this.sortObjStacks(R,E);for(let R=this.addedLocs.head();R;R=this.addedLocs.next())if(R.x>=this.baseX&&R.x<this.baseX+8&&R.z>=this.baseZ&&R.z<this.baseZ+8&&R.plane===this.currentLevel)R.duration=0;return this.inPacketType=-1,!0}if(this.inPacketType===132){let R=this.in.g1(),E=this.in.g1(),b=this.in.g2(),G=this.in.g2(),N=-1;if(this.sceneMapIndex){for(let L=0;L<this.sceneMapIndex.length;L++)if(this.sceneMapIndex[L]===(R<<8)+E)N=L}if(N!==-1&&this.sceneMapLandData){if(!this.sceneMapLandData[N]||this.sceneMapLandData[N]?.length!==G)this.sceneMapLandData[N]=new Uint8Array(G);let L=this.sceneMapLandData[N];if(L)this.in.gdata(this.inPacketSize-6,b,L)}return this.inPacketType=-1,!0}if(this.inPacketType===41){let R=this.in.g8(),E=this.in.g4(),b=this.in.g1(),G=!1;for(let N=0;N<100;N++)if(this.messageTextIds[N]===E){G=!0;break}if(b<=1){for(let N=0;N<this.ignoreCount;N++)if(this.ignoreName37[N]===R){G=!0;break}}if(!G&&this.overrideChat===0)try{this.messageTextIds[this.privateMessageCount]=E,this.privateMessageCount=(this.privateMessageCount+1)%100;let N=f0.unpack(this.in,this.inPacketSize-13),L=P0.filter(N);if(b>1)this.addMessage(7,L,l.formatName(l.fromBase37(R)));else this.addMessage(3,L,l.formatName(l.fromBase37(R)))}catch(N){}return this.inPacketType=-1,!0}if(this.inPacketType===193){for(let R=0;R<this.varps.length;R++)if(this.varps[R]!==this.varCache[R])this.varps[R]=this.varCache[R],await this.updateVarp(R),this.redrawSidebar=!0;return this.inPacketType=-1,!0}if(this.inPacketType===87){let R=this.in.g2(),E=this.in.g2();return s.instances[R].model=J.model(E),this.inPacketType=-1,!0}if(this.inPacketType===185)return this.stickyChatInterfaceId=this.in.g2b(),this.redrawChatback=!0,this.inPacketType=-1,!0;if(this.inPacketType===68){if(this.selectedTab===12)this.redrawSidebar=!0;return this.energy=this.in.g1(),this.inPacketType=-1,!0}if(this.inPacketType===74){if(this.cutscene=!0,this.cutsceneDstLocalTileX=this.in.g1(),this.cutsceneDstLocalTileZ=this.in.g1(),this.cutsceneDstHeight=this.in.g2(),this.cutsceneRotateSpeed=this.in.g1(),this.cutsceneRotateAcceleration=this.in.g1(),this.cutsceneRotateAcceleration>=100){let R=this.cutsceneDstLocalTileX*128+64,E=this.cutsceneDstLocalTileZ*128+64,b=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,G=R-this.cameraX,N=b-this.cameraY,L=E-this.cameraZ,H=Math.sqrt(G*G+L*L)|0;if(this.cameraPitch=(Math.atan2(N,H)*325.949|0)&2047,this.cameraYaw=(Math.atan2(G,L)*-325.949|0)&2047,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}return this.inPacketType=-1,!0}if(this.inPacketType===84)return this.selectedTab=this.in.g1(),this.redrawSidebar=!0,this.redrawSideicons=!0,this.inPacketType=-1,!0;if(this.inPacketType===4){let R=this.in.gjstr(),E;if(R.endsWith(":tradereq:")){let b=R.substring(0,R.indexOf(":"));E=l.toBase37(b);let G=!1;for(let N=0;N<this.ignoreCount;N++)if(this.ignoreName37[N]===E){G=!0;break}if(!G&&this.overrideChat===0)this.addMessage(4,"wishes to trade with you.",b)}else if(R.endsWith(":duelreq:")){let b=R.substring(0,R.indexOf(":"));E=l.toBase37(b);let G=!1;for(let N=0;N<this.ignoreCount;N++)if(this.ignoreName37[N]===E){G=!0;break}if(!G&&this.overrideChat===0)this.addMessage(8,"wishes to duel with you.",b)}else this.addMessage(0,R,"");return this.inPacketType=-1,!0}if(this.inPacketType===46){let R=this.in.g2(),E=this.in.g2(),b=this.in.g2(),G=_0.get(E);return s.instances[R].model=G.getInterfaceModel(50),s.instances[R].xan=G.xan2d,s.instances[R].yan=G.yan2d,s.instances[R].zoom=G.zoom2d*100/b|0,this.inPacketType=-1,!0}if(this.inPacketType===168){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=R,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(this.inPacketType===2){let R=this.in.g2(),E=this.in.g2(),b=E>>10&31,G=E>>5&31,N=E&31;return s.instances[R].colour=(b<<19)+(G<<11)+(N<<3),this.inPacketType=-1,!0}if(this.inPacketType===136){for(let R=0;R<this.players.length;R++){let E=this.players[R];if(!E)continue;E.primarySeqId=-1}for(let R=0;R<this.npcs.length;R++){let E=this.npcs[R];if(!E)continue;E.primarySeqId=-1}return this.inPacketType=-1,!0}if(this.inPacketType===26){let R=this.in.g2();return s.instances[R].hide=this.in.g1()===1,this.inPacketType=-1,!0}if(this.inPacketType===21){this.ignoreCount=this.inPacketSize/8|0;for(let R=0;R<this.ignoreCount;R++)this.ignoreName37[R]=this.in.g8();return this.inPacketType=-1,!0}if(this.inPacketType===239){this.cutscene=!1;for(let R=0;R<5;R++)this.cameraModifierEnabled[R]=!1;return this.inPacketType=-1,!0}if(this.inPacketType===129){if(this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(this.inPacketType===201){let R=this.in.g2();if(s.instances[R].text=this.in.gjstr(),s.instances[R].layer===this.tabInterfaceId[this.selectedTab])this.redrawSidebar=!0;return this.inPacketType=-1,!0}if(this.inPacketType===44){this.redrawSidebar=!0;let R=this.in.g1(),E=this.in.g4(),b=this.in.g1();this.skillExperience[R]=E,this.skillLevel[R]=b,this.skillBaseLevel[R]=1;for(let G=0;G<98;G++)if(E>=this.levelExperience[G])this.skillBaseLevel[R]=G+2;return this.inPacketType=-1,!0}if(this.inPacketType===162){this.baseX=this.in.g1(),this.baseZ=this.in.g1();while(this.in.pos<this.inPacketSize){let R=this.in.g1();this.readZonePacket(this.in,R)}return this.inPacketType=-1,!0}if(this.inPacketType===22){if(this.selectedTab===12)this.redrawSidebar=!0;return this.weightCarried=this.in.g2b(),this.inPacketType=-1,!0}if(this.inPacketType===13){let R=this.in.g1(),E=this.in.g1(),b=this.in.g1(),G=this.in.g1();return this.cameraModifierEnabled[R]=!0,this.cameraModifierJitter[R]=E,this.cameraModifierWobbleScale[R]=b,this.cameraModifierWobbleSpeed[R]=G,this.cameraModifierCycle[R]=0,this.inPacketType=-1,!0}if(this.inPacketType===213){this.redrawSidebar=!0;let R=this.in.g2(),E=s.instances[R];while(this.in.pos<this.inPacketSize){let b=this.in.g1(),G=this.in.g2(),N=this.in.g1();if(N===255)N=this.in.g4();if(E.invSlotObjId&&E.invSlotObjCount&&b>=0&&b<E.invSlotObjId.length)E.invSlotObjId[b]=G,E.invSlotObjCount[b]=N}return this.inPacketType=-1,!0}if(this.inPacketType===184)return this.readPlayerInfo(this.in,this.inPacketSize),this.sceneAwaitingSync=!1,this.inPacketType=-1,!0;await this.logout()}catch(_){await this.logout()}return!0}buildScene(){try{this.minimapLevel=-1,this.locList.clear(),this.spotanims.clear(),this.projectiles.clear(),w.clearTexels(),this.clearCaches(),this.scene?.reset();for(let E=0;E<4;E++)this.levelCollisionMap[E]?.reset();let _=new a(104,104,this.levelHeightmap,this.levelTileFlags);a.lowMemory=p.lowMemory;let R=this.sceneMapLandData?.length??0;if(this.sceneMapIndex)for(let E=0;E<R;E++){let b=this.sceneMapIndex[E]>>8,G=this.sceneMapIndex[E]&255;if(b===33&&G>=71&&G<=73){a.lowMemory=!1;break}}if(p.lowMemory)this.scene?.setMinLevel(this.currentLevel);else this.scene?.setMinLevel(0);if(this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(108);for(let E=0;E<R;E++){let b=(this.sceneMapIndex[E]>>8)*64-this.sceneBaseTileX,G=(this.sceneMapIndex[E]&255)*64-this.sceneBaseTileZ,N=this.sceneMapLandData[E];if(N){let L=J_.decompress(N,-1,!1,!0);_.readLandscape((this.sceneCenterZoneX-6)*8,(this.sceneCenterZoneZ-6)*8,b,G,L)}else if(this.sceneCenterZoneZ<800)_.clearLandscape(G,b,64,64)}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(108);for(let E=0;E<R;E++){let b=(this.sceneMapIndex[E]>>8)*64-this.sceneBaseTileX,G=(this.sceneMapIndex[E]&255)*64-this.sceneBaseTileZ,N=this.sceneMapLocData[E];if(N){let L=J_.decompress(N,-1,!1,!0);_.readLocs(this.scene,this.locList,this.levelCollisionMap,L,b,G)}}}this.out.p1isaac(108),_.build(this.scene,this.levelCollisionMap),this.areaViewport?.bind(),this.out.p1isaac(108);for(let E=this.locList.head();E;E=this.locList.next())if((this.levelTileFlags&&this.levelTileFlags[1][E.heightmapNE][E.heightmapNW]&2)===2){if(E.heightmapSW--,E.heightmapSW<0)E.unlink()}for(let E=0;E<104;E++)for(let b=0;b<104;b++)this.sortObjStacks(E,b);this.clearAddedLocs()}catch(_){}Q0.modelCacheStatic?.clear(),w.initPool(20)}resetInterfaceAnimation(_){let R=s.instances[_];if(!R.childId)return;for(let E=0;E<R.childId.length&&R.childId[E]!==-1;E++){let b=s.instances[R.childId[E]];if(b.comType===1)this.resetInterfaceAnimation(b.id);b.seqFrame=0,b.seqCycle=0}}initializeLevelExperience(){let _=0;for(let R=0;R<99;R++){let E=R+1,b=E+Math.pow(2,E/7)*300|0;_+=b,this.levelExperience[R]=_/4|0}}addMessage(_,R,E){if(_===0&&this.stickyChatInterfaceId!==-1)this.modalMessage=R,this.mouseClickButton=0;if(this.chatInterfaceId===-1)this.redrawChatback=!0;for(let b=99;b>0;b--)this.messageTextType[b]=this.messageTextType[b-1],this.messageTextSender[b]=this.messageTextSender[b-1],this.messageText[b]=this.messageText[b-1];this.messageTextType[0]=_,this.messageTextSender[0]=E,this.messageText[0]=R}async updateVarp(_){let R=S0.instances[_].clientcode;if(R!==0){let E=this.varps[_];if(R===1){if(E===1)w.setBrightness(0.9);if(E===2)w.setBrightness(0.8);if(E===3)w.setBrightness(0.7);if(E===4)w.setBrightness(0.6);_0.iconCache?.clear(),this.redrawTitleBackground=!0}if(R===3){let b=this.midiActive;if(E===0)this.midiVolume=128,U_(128),this.midiActive=!0;if(E===1)this.midiVolume=96,U_(96),this.midiActive=!0;if(E===2)this.midiVolume=64,U_(64),this.midiActive=!0;if(E===3)this.midiVolume=32,U_(32),this.midiActive=!0;if(E===4)this.midiActive=!1;if(this.midiActive!==b){if(this.midiActive&&this.currentMidi)await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,!1);else S_(!1);this.nextMusicDelay=0}}if(R===4){if(E===0)this.waveVolume=128,$_(128),this.waveEnabled=!0;if(E===1)this.waveVolume=96,$_(96),this.waveEnabled=!0;if(E===2)this.waveVolume=64,$_(64),this.waveEnabled=!0;if(E===3)this.waveVolume=32,$_(32),this.waveEnabled=!0;if(E===4)this.waveEnabled=!1}if(R===5)this.mouseButtonsOption=E;if(R===6)this.chatEffects=E;if(R===8)this.splitPrivateChat=E,this.redrawChatback=!0}}handleChatMouseInput(_,R){let E=0;for(let b=0;b<100;b++){if(!this.messageText[b])continue;let G=this.messageTextType[b],N=this.chatScrollOffset+70+4-E*14;if(N<-20)break;if(G===0)E++;if((G===1||G===2)&&(G===1||this.publicChatSetting===0||this.publicChatSetting===1&&this.isFriend(this.messageTextSender[b]))){if(R>N-14&&R<=N&&this.localPlayer&&this.messageTextSender[b]!==this.localPlayer.name){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageTextSender[b],this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageTextSender[b],this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageTextSender[b],this.menuAction[this.menuSize]=406,this.menuSize++}E++}if((G===3||G===7)&&this.splitPrivateChat===0&&(G===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageTextSender[b]))){if(R>N-14&&R<=N){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageTextSender[b],this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageTextSender[b],this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageTextSender[b],this.menuAction[this.menuSize]=406,this.menuSize++}E++}if(G===4&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageTextSender[b]))){if(R>N-14&&R<=N)this.menuOption[this.menuSize]="Accept trade @whi@"+this.messageTextSender[b],this.menuAction[this.menuSize]=903,this.menuSize++;E++}if((G===5||G===6)&&this.splitPrivateChat===0&&this.privateChatSetting<2)E++;if(G===8&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageTextSender[b]))){if(R>N-14&&R<=N)this.menuOption[this.menuSize]="Accept duel @whi@"+this.messageTextSender[b],this.menuAction[this.menuSize]=363,this.menuSize++;E++}}}handlePrivateChatInput(_){if(this.splitPrivateChat===0)return;let R=0;if(this.systemUpdateTimer!==0)R=1;for(let E=0;E<100;E++)if(this.messageText[E]!==null){let b=this.messageTextType[E];if((b===3||b===7)&&(b===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageTextSender[E]))){let G=329-R*13;if(this.mouseX>8&&this.mouseX<520&&_-11>G-10&&_-11<=G+3){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageTextSender[E],this.menuAction[this.menuSize]=2034,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageTextSender[E],this.menuAction[this.menuSize]=2436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageTextSender[E],this.menuAction[this.menuSize]=2406,this.menuSize++}if(R++,R>=5)return}if((b===5||b===6)&&this.privateChatSetting<2){if(R++,R>=5)return}}}handleInterfaceInput(_,R,E,b,G,N){if(_.comType!==0||!_.childId||_.hide||R<b||E<G||R>b+_.width||E>G+_.height||!_.childX||!_.childY)return;let L=_.childId.length;for(let H=0;H<L;H++){let I=_.childX[H]+b,Q=_.childY[H]+G-N,q=s.instances[_.childId[H]];if(I+=q.x,Q+=q.y,(q.overLayer>=0||q.overColour!==0)&&R>=I&&E>=Q&&R<I+q.width&&E<Q+q.height)if(q.overLayer>=0)this.lastHoveredInterfaceId=q.overLayer;else this.lastHoveredInterfaceId=q.id;if(q.comType===0){if(this.handleInterfaceInput(q,R,E,I,Q,q.scrollPosition),q.scroll>q.height)this.handleScrollInput(R,E,q.scroll,q.height,!0,I+q.width,Q,q)}else if(q.comType===2){let O=0;for(let U=0;U<q.height;U++)for(let $=0;$<q.width;$++){let K=I+$*(q.marginX+32),u=Q+U*(q.marginY+32);if(O<20&&q.invSlotOffsetX&&q.invSlotOffsetY)K+=q.invSlotOffsetX[O],u+=q.invSlotOffsetY[O];if(R<K||E<u||R>=K+32||E>=u+32){O++;continue}if(this.hoveredSlot=O,this.hoveredSlotParentId=q.id,!q.invSlotObjId||q.invSlotObjId[O]<=0){O++;continue}let F=_0.get(q.invSlotObjId[O]-1);if(this.objSelected===1&&q.interactable){if(q.id!==this.objSelectedInterface||O!==this.objSelectedSlot)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+F.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=O,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else if(this.spellSelected===1&&q.interactable){if((this.activeSpellFlags&16)===16)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+F.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=O,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else{if(q.interactable){for(let k=4;k>=3;k--)if(F.iop&&F.iop[k]){if(this.menuOption[this.menuSize]=F.iop[k]+" @lre@"+F.name,k===3)this.menuAction[this.menuSize]=478;else if(k===4)this.menuAction[this.menuSize]=347;this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=O,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else if(k===4)this.menuOption[this.menuSize]="Drop @lre@"+F.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=O,this.menuParamC[this.menuSize]=q.id,this.menuSize++}if(q.usable)this.menuOption[this.menuSize]="Use @lre@"+F.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=O,this.menuParamC[this.menuSize]=q.id,this.menuSize++;if(q.interactable&&F.iop){for(let k=2;k>=0;k--)if(F.iop[k]){if(this.menuOption[this.menuSize]=F.iop[k]+" @lre@"+F.name,k===0)this.menuAction[this.menuSize]=405;else if(k===1)this.menuAction[this.menuSize]=38;else if(k===2)this.menuAction[this.menuSize]=422;this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=O,this.menuParamC[this.menuSize]=q.id,this.menuSize++}}if(q.iops){for(let k=4;k>=0;k--)if(q.iops[k]){if(this.menuOption[this.menuSize]=q.iops[k]+" @lre@"+F.name,k===0)this.menuAction[this.menuSize]=602;else if(k===1)this.menuAction[this.menuSize]=596;else if(k===2)this.menuAction[this.menuSize]=22;else if(k===3)this.menuAction[this.menuSize]=892;else if(k===4)this.menuAction[this.menuSize]=415;this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=O,this.menuParamC[this.menuSize]=q.id,this.menuSize++}}if(this.menuOption[this.menuSize]="Examine @lre@"+F.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=F.id,q.invSlotObjCount)this.menuParamC[this.menuSize]=q.invSlotObjCount[O];this.menuSize++}O++}}else if(R>=I&&E>=Q&&R<I+q.width&&E<Q+q.height){if(q.buttonType===1){let O=!1;if(q.clientCode!==0)O=this.handleSocialMenuOption(q);if(!O&&q.option)this.menuOption[this.menuSize]=q.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else if(q.buttonType===2&&this.spellSelected===0){let O=q.actionVerb;if(O&&O.indexOf(" ")!==-1)O=O.substring(0,O.indexOf(" "));this.menuOption[this.menuSize]=O+" @gre@"+q.action,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else if(q.buttonType===3)this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=q.id,this.menuSize++;else if(q.buttonType===4&&q.option)this.menuOption[this.menuSize]=q.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=q.id,this.menuSize++;else if(q.buttonType===5&&q.option)this.menuOption[this.menuSize]=q.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=q.id,this.menuSize++;else if(q.buttonType===6&&!this.pressedContinueOption&&q.option)this.menuOption[this.menuSize]=q.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=q.id,this.menuSize++}}}handleSocialMenuOption(_){let R=_.clientCode;if(R>=1&&R<=200){if(R>=101)R-=101;else R--;return this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[R],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[R],this.menuAction[this.menuSize]=679,this.menuSize++,!0}else if(R>=401&&R<=500)return this.menuOption[this.menuSize]="Remove @whi@"+_.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0;return!1}handleViewportOptions(){if(this.objSelected===0&&this.spellSelected===0)this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++;let _=-1;for(let R=0;R<J.pickedCount;R++){let E=J.picked[R],b=E&127,G=E>>7&127,N=E>>29&3,L=E>>14&32767;if(E===_)continue;if(_=E,N===2&&this.scene&&this.scene.getInfo(this.currentLevel,b,G,E)>=0){let H=Q0.get(L);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+H.name,this.menuAction[this.menuSize]=450,this.menuParamA[this.menuSize]=E,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++;else if(this.spellSelected!==1){if(H.op){for(let I=4;I>=0;I--)if(H.op[I]){if(this.menuOption[this.menuSize]=H.op[I]+" @cya@"+H.name,I===0)this.menuAction[this.menuSize]=285;if(I===1)this.menuAction[this.menuSize]=504;if(I===2)this.menuAction[this.menuSize]=364;if(I===3)this.menuAction[this.menuSize]=581;if(I===4)this.menuAction[this.menuSize]=1501;this.menuParamA[this.menuSize]=E,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++}}this.menuOption[this.menuSize]="Examine @cya@"+H.name,this.menuAction[this.menuSize]=1175,this.menuParamA[this.menuSize]=E,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++}else if((this.activeSpellFlags&4)===4)this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+H.name,this.menuAction[this.menuSize]=55,this.menuParamA[this.menuSize]=E,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++}if(N===1){let H=this.npcs[L];if(H&&H.npcType&&H.npcType.size===1&&(H.x&127)===64&&(H.z&127)===64)for(let I=0;I<this.npcCount;I++){let Q=this.npcs[this.npcIds[I]];if(Q&&Q!==H&&Q.npcType&&Q.npcType.size===1&&Q.x===H.x&&Q.z===H.z)this.addNpcOptions(Q.npcType,this.npcIds[I],b,G)}if(H&&H.npcType)this.addNpcOptions(H.npcType,L,b,G)}if(N===0){let H=this.players[L];if(H&&(H.x&127)===64&&(H.z&127)===64){for(let I=0;I<this.npcCount;I++){let Q=this.npcs[this.npcIds[I]];if(Q&&Q.npcType&&Q.npcType.size===1&&Q.x===H.x&&Q.z===H.z)this.addNpcOptions(Q.npcType,this.npcIds[I],b,G)}for(let I=0;I<this.playerCount;I++){let Q=this.players[this.playerIds[I]];if(Q&&Q!==H&&Q.x===H.x&&Q.z===H.z)this.addPlayerOptions(Q,this.playerIds[I],b,G)}}if(H)this.addPlayerOptions(H,L,b,G)}if(N===3){let H=this.objStacks[this.currentLevel][b][G];if(!H)continue;for(let I=H.tail();I;I=H.prev()){let Q=_0.get(I.index);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+Q.name,this.menuAction[this.menuSize]=217,this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++;else if(this.spellSelected!==1){for(let q=4;q>=0;q--)if(Q.op&&Q.op[q]){if(this.menuOption[this.menuSize]=Q.op[q]+" @lre@"+Q.name,q===0)this.menuAction[this.menuSize]=224;if(q===1)this.menuAction[this.menuSize]=993;if(q===2)this.menuAction[this.menuSize]=99;if(q===3)this.menuAction[this.menuSize]=746;if(q===4)this.menuAction[this.menuSize]=877;this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++}else if(q===2)this.menuOption[this.menuSize]="Take @lre@"+Q.name,this.menuAction[this.menuSize]=99,this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++;this.menuOption[this.menuSize]="Examine @lre@"+Q.name,this.menuAction[this.menuSize]=1102,this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++}else if((this.activeSpellFlags&1)===1)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+Q.name,this.menuAction[this.menuSize]=965,this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=G,this.menuSize++}}}}addNpcOptions(_,R,E,b){if(this.menuSize>=400)return;let G=_.name;if(_.vislevel!==0&&this.localPlayer)G=G+this.getCombatLevelColorTag(this.localPlayer.combatLevel,_.vislevel)+" (level-"+_.vislevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+G,this.menuAction[this.menuSize]=900,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++;else if(this.spellSelected!==1){let N;if(_.op){for(N=4;N>=0;N--)if(_.op[N]&&_.op[N]?.toLowerCase()!=="attack"){if(this.menuOption[this.menuSize]=_.op[N]+" @yel@"+G,N===0)this.menuAction[this.menuSize]=728;else if(N===1)this.menuAction[this.menuSize]=542;else if(N===2)this.menuAction[this.menuSize]=6;else if(N===3)this.menuAction[this.menuSize]=963;else if(N===4)this.menuAction[this.menuSize]=245;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++}}if(_.op){for(N=4;N>=0;N--)if(_.op[N]&&_.op[N]?.toLowerCase()==="attack"){let L=0;if(this.localPlayer&&_.vislevel>this.localPlayer.combatLevel)L=2000;if(this.menuOption[this.menuSize]=_.op[N]+" @yel@"+G,N===0)this.menuAction[this.menuSize]=L+728;else if(N===1)this.menuAction[this.menuSize]=L+542;else if(N===2)this.menuAction[this.menuSize]=L+6;else if(N===3)this.menuAction[this.menuSize]=L+963;else if(N===4)this.menuAction[this.menuSize]=L+245;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++}}this.menuOption[this.menuSize]="Examine @yel@"+G,this.menuAction[this.menuSize]=1607,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++}else if((this.activeSpellFlags&2)===2)this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+G,this.menuAction[this.menuSize]=265,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++}addPlayerOptions(_,R,E,b){if(_===this.localPlayer||this.menuSize>=400)return;let G=null;if(this.localPlayer)G=_.name+this.getCombatLevelColorTag(this.localPlayer.combatLevel,_.combatLevel)+" (level-"+_.combatLevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+G,this.menuAction[this.menuSize]=367,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++;else if(this.spellSelected!==1){if(this.menuOption[this.menuSize]="Follow @whi@"+G,this.menuAction[this.menuSize]=1544,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++,this.overrideChat===0)this.menuOption[this.menuSize]="Trade with @whi@"+G,this.menuAction[this.menuSize]=1373,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++;if(this.wildernessLevel>0){if(this.menuOption[this.menuSize]="Attack @whi@"+G,this.localPlayer&&this.localPlayer.combatLevel>=_.combatLevel)this.menuAction[this.menuSize]=151;else this.menuAction[this.menuSize]=2151;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++}if(this.worldLocationState===1)this.menuOption[this.menuSize]="Fight @whi@"+G,this.menuAction[this.menuSize]=151,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++;if(this.worldLocationState===2)this.menuOption[this.menuSize]="Duel-with @whi@"+G,this.menuAction[this.menuSize]=1101,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++}else if((this.activeSpellFlags&8)===8)this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+G,this.menuAction[this.menuSize]=651,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=E,this.menuParamC[this.menuSize]=b,this.menuSize++;for(let N=0;N<this.menuSize;N++)if(this.menuAction[N]===660){this.menuOption[N]="Walk here @whi@"+G;return}}getCombatLevelColorTag(_,R){let E=_-R;if(E<-9)return"@red@";else if(E<-6)return"@or3@";else if(E<-3)return"@or2@";else if(E<0)return"@or1@";else if(E>9)return"@gre@";else if(E>6)return"@gr3@";else if(E>3)return"@gr2@";else if(E>0)return"@gr1@";else return"@yel@"}handleInput(){if(this.objDragArea===0){if(this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.handlePrivateChatInput(this.mouseY),this.lastHoveredInterfaceId=0,this.mouseX>8&&this.mouseY>11&&this.mouseX<520&&this.mouseY<345)if(this.viewportInterfaceId===-1)this.handleViewportOptions();else this.handleInterfaceInput(s.instances[this.viewportInterfaceId],this.mouseX,this.mouseY,8,11,0);if(this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex)this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>562&&this.mouseY>231&&this.mouseX<752&&this.mouseY<492){if(this.sidebarInterfaceId!==-1)this.handleInterfaceInput(s.instances[this.sidebarInterfaceId],this.mouseX,this.mouseY,562,231,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.handleInterfaceInput(s.instances[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,562,231,0)}if(this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex)this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>22&&this.mouseY>375&&this.mouseX<431&&this.mouseY<471)if(this.chatInterfaceId===-1)this.handleChatMouseInput(this.mouseX-22,this.mouseY-375);else this.handleInterfaceInput(s.instances[this.chatInterfaceId],this.mouseX,this.mouseY,22,375,0);if(this.chatInterfaceId!==-1&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex)this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId;let _=!1;while(!_){_=!0;for(let R=0;R<this.menuSize-1;R++)if(this.menuAction[R]<1000&&this.menuAction[R+1]>1000){let E=this.menuOption[R];this.menuOption[R]=this.menuOption[R+1],this.menuOption[R+1]=E;let b=this.menuAction[R];this.menuAction[R]=this.menuAction[R+1],this.menuAction[R+1]=b;let G=this.menuParamB[R];this.menuParamB[R]=this.menuParamB[R+1],this.menuParamB[R+1]=G;let N=this.menuParamC[R];this.menuParamC[R]=this.menuParamC[R+1],this.menuParamC[R+1]=N;let L=this.menuParamA[R];this.menuParamA[R]=this.menuParamA[R+1],this.menuParamA[R+1]=L,_=!1}}}}showContextMenu(){let _=0;if(this.fontBold12){_=this.fontBold12.stringWidth("Choose Option");let G;for(let N=0;N<this.menuSize;N++)if(G=this.fontBold12.stringWidth(this.menuOption[N]),G>_)_=G}_+=8;let R=this.menuSize*15+21,E,b;if(this.mouseClickX>8&&this.mouseClickY>11&&this.mouseClickX<520&&this.mouseClickY<345){if(E=this.mouseClickX-(_/2|0)-8,E+_>512)E=512-_;else if(E<0)E=0;if(b=this.mouseClickY-11,b+R>334)b=334-R;else if(b<0)b=0;this.menuVisible=!0,this.menuArea=0,this.menuX=E,this.menuY=b,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>562&&this.mouseClickY>231&&this.mouseClickX<752&&this.mouseClickY<492){if(E=this.mouseClickX-(_/2|0)-562,E<0)E=0;else if(E+_>190)E=190-_;if(b=this.mouseClickY-231,b<0)b=0;else if(b+R>261)b=261-R;this.menuVisible=!0,this.menuArea=1,this.menuX=E,this.menuY=b,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>22&&this.mouseClickY>375&&this.mouseClickX<501&&this.mouseClickY<471){if(E=this.mouseClickX-(_/2|0)-22,E<0)E=0;else if(E+_>479)E=479-_;if(b=this.mouseClickY-375,b<0)b=0;else if(b+R>96)b=96-R;this.menuVisible=!0,this.menuArea=2,this.menuX=E,this.menuY=b,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}}tryMove(_,R,E,b,G,N,L,H,I,Q,q){let O=this.levelCollisionMap[this.currentLevel];if(!O)return!1;let U=104,$=104;for(let Z=0;Z<U;Z++)for(let g=0;g<$;g++){let M=o.index(Z,g);this.bfsDirection[M]=0,this.bfsCost[M]=99999999}let K=_,u=R,F=o.index(_,R);this.bfsDirection[F]=99,this.bfsCost[F]=0;let k=0,j=0;this.bfsStepX[k]=_,this.bfsStepZ[k++]=R;let m=!1,Y=this.bfsStepX.length,X=O.flags;while(j!==k){if(K=this.bfsStepX[j],u=this.bfsStepZ[j],j=(j+1)%Y,K===E&&u===b){m=!0;break}if(I!==h.WALL_STRAIGHT.id){if((I<h.WALLDECOR_STRAIGHT_OFFSET.id||I===h.CENTREPIECE_STRAIGHT.id)&&O.reachedWall(K,u,E,b,I-1,H)){m=!0;break}if(I<h.CENTREPIECE_STRAIGHT.id&&O.reachedWallDecoration(K,u,E,b,I-1,H)){m=!0;break}}if(N!==0&&L!==0&&O.reachedLoc(K,u,E,b,N,L,Q)){m=!0;break}let Z=this.bfsCost[o.index(K,u)]+1,g=o.index(K-1,u);if(K>0&&this.bfsDirection[g]===0&&(X[g]&2621704)===0)this.bfsStepX[k]=K-1,this.bfsStepZ[k]=u,k=(k+1)%Y,this.bfsDirection[g]=2,this.bfsCost[g]=Z;if(g=o.index(K+1,u),K<U-1&&this.bfsDirection[g]===0&&(X[g]&2621824)===0)this.bfsStepX[k]=K+1,this.bfsStepZ[k]=u,k=(k+1)%Y,this.bfsDirection[g]=8,this.bfsCost[g]=Z;if(g=o.index(K,u-1),u>0&&this.bfsDirection[g]===0&&(X[g]&2621698)===0)this.bfsStepX[k]=K,this.bfsStepZ[k]=u-1,k=(k+1)%Y,this.bfsDirection[g]=1,this.bfsCost[g]=Z;if(g=o.index(K,u+1),u<$-1&&this.bfsDirection[g]===0&&(X[g]&2621728)===0)this.bfsStepX[k]=K,this.bfsStepZ[k]=u+1,k=(k+1)%Y,this.bfsDirection[g]=4,this.bfsCost[g]=Z;if(g=o.index(K-1,u-1),K>0&&u>0&&this.bfsDirection[g]===0&&(X[g]&2621710)===0&&(X[o.index(K-1,u)]&2621704)===0&&(X[o.index(K,u-1)]&2621698)===0)this.bfsStepX[k]=K-1,this.bfsStepZ[k]=u-1,k=(k+1)%Y,this.bfsDirection[g]=3,this.bfsCost[g]=Z;if(g=o.index(K+1,u-1),K<U-1&&u>0&&this.bfsDirection[g]===0&&(X[g]&2621827)===0&&(X[o.index(K+1,u)]&2621824)===0&&(X[o.index(K,u-1)]&2621698)===0)this.bfsStepX[k]=K+1,this.bfsStepZ[k]=u-1,k=(k+1)%Y,this.bfsDirection[g]=9,this.bfsCost[g]=Z;if(g=o.index(K-1,u+1),K>0&&u<$-1&&this.bfsDirection[g]===0&&(X[g]&2621752)===0&&(X[o.index(K-1,u)]&2621704)===0&&(X[o.index(K,u+1)]&2621728)===0)this.bfsStepX[k]=K-1,this.bfsStepZ[k]=u+1,k=(k+1)%Y,this.bfsDirection[g]=6,this.bfsCost[g]=Z;if(g=o.index(K+1,u+1),K<U-1&&u<$-1&&this.bfsDirection[g]===0&&(X[g]&2621920)===0&&(X[o.index(K+1,u)]&2621824)===0&&(X[o.index(K,u+1)]&2621728)===0)this.bfsStepX[k]=K+1,this.bfsStepZ[k]=u+1,k=(k+1)%Y,this.bfsDirection[g]=12,this.bfsCost[g]=Z}if(this.tryMoveNearest=0,!m){if(q){let Z=100;for(let g=1;g<2;g++){for(let M=E-g;M<=E+g;M++)for(let S=b-g;S<=b+g;S++){let A=o.index(M,S);if(M>=0&&S>=0&&M<104&&S<104&&this.bfsCost[A]<Z)Z=this.bfsCost[A],K=M,u=S,this.tryMoveNearest=1,m=!0}if(m)break}}if(!m)return!1}j=0,this.bfsStepX[j]=K,this.bfsStepZ[j++]=u;let B=this.bfsDirection[o.index(K,u)],z=B;while(K!==_||u!==R){if(z!==B)B=z,this.bfsStepX[j]=K,this.bfsStepZ[j++]=u;if((z&2)!==0)K++;else if((z&8)!==0)K--;if((z&1)!==0)u++;else if((z&4)!==0)u--;z=this.bfsDirection[o.index(K,u)]}if(j>0){Y=Math.min(j,25),j--;let Z=this.bfsStepX[j],g=this.bfsStepZ[j];if(G===0)this.out.p1isaac(181),this.out.p1(Y+Y+3);else if(G===1)this.out.p1isaac(165),this.out.p1(Y+Y+3+14);else if(G===2)this.out.p1isaac(93),this.out.p1(Y+Y+3);if(this.actionKey[5]===1)this.out.p1(1);else this.out.p1(0);this.out.p2(Z+this.sceneBaseTileX),this.out.p2(g+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let M=1;M<Y;M++)j--,this.out.p1(this.bfsStepX[j]-Z),this.out.p1(this.bfsStepZ[j]-g);return!0}return G!==1}readPlayerInfo(_,R){this.entityRemovalCount=0,this.entityUpdateCount=0,this.readLocalPlayer(_),this.readPlayers(_),this.readNewPlayers(_,R),this.readPlayerUpdates(_);for(let E=0;E<this.entityRemovalCount;E++){let b=this.entityRemovalIds[E],G=this.players[b];if(!G)continue;if(G.cycle!==this.loopCycle)this.players[b]=null}if(_.pos!==R)throw new Error;for(let E=0;E<this.playerCount;E++)if(!this.players[this.playerIds[E]])throw new Error}readLocalPlayer(_){if(_.bits(),_.gBit(1)!==0){let E=_.gBit(2);if(E===0)this.entityUpdateIds[this.entityUpdateCount++]=2047;else if(E===1){let b=_.gBit(3);if(this.localPlayer?.step(!1,b),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(E===2){let b=_.gBit(3);this.localPlayer?.step(!0,b);let G=_.gBit(3);if(this.localPlayer?.step(!0,G),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(E===3){this.currentLevel=_.gBit(2);let b=_.gBit(7),G=_.gBit(7),N=_.gBit(1);if(this.localPlayer?.move(N===1,b,G),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}}}readPlayers(_){let R=_.gBit(8);if(R<this.playerCount)for(let E=R;E<this.playerCount;E++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[E];if(R>this.playerCount)throw new Error;this.playerCount=0;for(let E=0;E<R;E++){let b=this.playerIds[E],G=this.players[b];if(_.gBit(1)===0){if(this.playerIds[this.playerCount++]=b,G)G.cycle=this.loopCycle}else{let L=_.gBit(2);if(L===0){if(this.playerIds[this.playerCount++]=b,G)G.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=b}else if(L===1){if(this.playerIds[this.playerCount++]=b,G)G.cycle=this.loopCycle;let H=_.gBit(3);if(G?.step(!1,H),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=b}else if(L===2){if(this.playerIds[this.playerCount++]=b,G)G.cycle=this.loopCycle;let H=_.gBit(3);G?.step(!0,H);let I=_.gBit(3);if(G?.step(!0,I),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=b}else if(L===3)this.entityRemovalIds[this.entityRemovalCount++]=b}}}readNewPlayers(_,R){let E;while(_.bitPos+10<R*8){if(E=_.gBit(11),E===2047)break;if(!this.players[E]){this.players[E]=new K0;let I=this.playerAppearanceBuffer[E];if(I)this.players[E]?.read(I)}this.playerIds[this.playerCount++]=E;let b=this.players[E];if(b)b.cycle=this.loopCycle;let G=_.gBit(5);if(G>15)G-=32;let N=_.gBit(5);if(N>15)N-=32;let L=_.gBit(1);if(this.localPlayer)b?.move(L===1,this.localPlayer.routeFlagX[0]+G,this.localPlayer.routeFlagZ[0]+N);if(_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=E}_.bytes()}readPlayerUpdates(_){for(let R=0;R<this.entityUpdateCount;R++){let E=this.entityUpdateIds[R],b=this.players[E];if(!b)continue;let G=_.g1();if((G&128)!==0)G+=_.g1()<<8;this.readPlayerUpdatesBlocks(b,E,G,_)}}readPlayerUpdatesBlocks(_,R,E,b){if(_.lastMask=E,_.lastMaskCycle=this.loopCycle,(E&1)!==0){let G=b.g1(),N=new Uint8Array(G),L=new f(N);b.gdata(G,0,N),this.playerAppearanceBuffer[R]=L,_.read(L)}if((E&2)!==0){let G=b.g2();if(G===65535)G=-1;if(G===_.primarySeqId)_.primarySeqLoop=0;let N=b.g1();if(G===-1||_.primarySeqId===-1||r.instances[G].seqPriority>r.instances[_.primarySeqId].seqPriority||r.instances[_.primarySeqId].seqPriority===0)_.primarySeqId=G,_.primarySeqFrame=0,_.primarySeqCycle=0,_.primarySeqDelay=N,_.primarySeqLoop=0}if((E&4)!==0){if(_.targetId=b.g2(),_.targetId===65535)_.targetId=-1}if((E&8)!==0){if(_.chat=b.gjstr(),_.chatColor=0,_.chatStyle=0,_.chatTimer=150,_.name)this.addMessage(2,_.chat,_.name)}if((E&16)!==0)_.damage=b.g1(),_.damageType=b.g1(),_.combatCycle=this.loopCycle+400,_.health=b.g1(),_.totalHealth=b.g1();if((E&32)!==0)_.targetTileX=b.g2(),_.targetTileZ=b.g2(),_.lastFaceX=_.targetTileX,_.lastFaceZ=_.targetTileZ;if((E&64)!==0){let G=b.g2(),N=b.g1(),L=b.g1(),H=b.pos;if(_.name){let I=l.toBase37(_.name),Q=!1;if(N<=1){for(let q=0;q<this.ignoreCount;q++)if(this.ignoreName37[q]===I){Q=!0;break}}if(!Q&&this.overrideChat===0)try{let q=f0.unpack(b,L),O=P0.filter(q);if(_.chat=O,_.chatColor=G>>8,_.chatStyle=G&255,_.chatTimer=150,N>1)this.addMessage(1,O,_.name);else this.addMessage(2,O,_.name)}catch(q){}}b.pos=H+L}if((E&256)!==0){_.spotanimId=b.g2();let G=b.g4();if(_.spotanimOffset=G>>16,_.spotanimLastCycle=this.loopCycle+(G&65535),_.spotanimFrame=0,_.spotanimCycle=0,_.spotanimLastCycle>this.loopCycle)_.spotanimFrame=-1;if(_.spotanimId===65535)_.spotanimId=-1}if((E&512)!==0)_.forceMoveStartSceneTileX=b.g1(),_.forceMoveStartSceneTileZ=b.g1(),_.forceMoveEndSceneTileX=b.g1(),_.forceMoveEndSceneTileZ=b.g1(),_.forceMoveEndCycle=b.g2()+this.loopCycle,_.forceMoveStartCycle=b.g2()+this.loopCycle,_.forceMoveFaceDirection=b.g1(),_.routeLength=0,_.routeFlagX[0]=_.forceMoveEndSceneTileX,_.routeFlagZ[0]=_.forceMoveEndSceneTileZ}readNpcInfo(_,R){this.entityRemovalCount=0,this.entityUpdateCount=0,this.readNpcs(_),this.readNewNpcs(_,R),this.readNpcUpdates(_);for(let E=0;E<this.entityRemovalCount;E++){let b=this.entityRemovalIds[E],G=this.npcs[b];if(!G)continue;if(G.cycle!==this.loopCycle)G.npcType=null,this.npcs[b]=null}if(_.pos!==R)throw new Error;for(let E=0;E<this.npcCount;E++)if(!this.npcs[this.npcIds[E]])throw new Error}readNpcs(_){_.bits();let R=_.gBit(8);if(R<this.npcCount)for(let E=R;E<this.npcCount;E++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[E];if(R>this.npcCount)throw new Error;this.npcCount=0;for(let E=0;E<R;E++){let b=this.npcIds[E],G=this.npcs[b];if(_.gBit(1)===0){if(this.npcIds[this.npcCount++]=b,G)G.cycle=this.loopCycle}else{let L=_.gBit(2);if(L===0){if(this.npcIds[this.npcCount++]=b,G)G.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=b}else if(L===1){if(this.npcIds[this.npcCount++]=b,G)G.cycle=this.loopCycle;let H=_.gBit(3);if(G?.step(!1,H),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=b}else if(L===2){if(this.npcIds[this.npcCount++]=b,G)G.cycle=this.loopCycle;let H=_.gBit(3);G?.step(!0,H);let I=_.gBit(3);if(G?.step(!0,I),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=b}else if(L===3)this.entityRemovalIds[this.entityRemovalCount++]=b}}}readNewNpcs(_,R){while(_.bitPos+21<R*8){let E=_.gBit(13);if(E===8191)break;if(!this.npcs[E])this.npcs[E]=new H_;let b=this.npcs[E];if(this.npcIds[this.npcCount++]=E,b)b.cycle=this.loopCycle,b.npcType=w0.get(_.gBit(11)),b.size=b.npcType.size,b.seqWalkId=b.npcType.walkanim,b.seqTurnAroundId=b.npcType.walkanim_b,b.seqTurnLeftId=b.npcType.walkanim_r,b.seqTurnRightId=b.npcType.walkanim_l,b.seqStandId=b.npcType.readyanim;else _.gBit(11);let G=_.gBit(5);if(G>15)G-=32;let N=_.gBit(5);if(N>15)N-=32;if(this.localPlayer)b?.move(!1,this.localPlayer.routeFlagX[0]+G,this.localPlayer.routeFlagZ[0]+N);if(_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=E}_.bytes()}readNpcUpdates(_){for(let R=0;R<this.entityUpdateCount;R++){let E=this.entityUpdateIds[R],b=this.npcs[E];if(!b)continue;let G=_.g1();if(b.lastMask=G,b.lastMaskCycle=this.loopCycle,(G&2)!==0){let N=_.g2();if(N===65535)N=-1;if(N===b.primarySeqId)b.primarySeqLoop=0;let L=_.g1();if(N===-1||b.primarySeqId===-1||r.instances[N].seqPriority>r.instances[b.primarySeqId].seqPriority||r.instances[b.primarySeqId].seqPriority===0)b.primarySeqId=N,b.primarySeqFrame=0,b.primarySeqCycle=0,b.primarySeqDelay=L,b.primarySeqLoop=0}if((G&4)!==0){if(b.targetId=_.g2(),b.targetId===65535)b.targetId=-1}if((G&8)!==0)b.chat=_.gjstr(),b.chatTimer=100;if((G&16)!==0)b.damage=_.g1(),b.damageType=_.g1(),b.combatCycle=this.loopCycle+400,b.health=_.g1(),b.totalHealth=_.g1();if((G&32)!==0)b.npcType=w0.get(_.g2()),b.seqWalkId=b.npcType.walkanim,b.seqTurnAroundId=b.npcType.walkanim_b,b.seqTurnLeftId=b.npcType.walkanim_r,b.seqTurnRightId=b.npcType.walkanim_l,b.seqStandId=b.npcType.readyanim;if((G&64)!==0){b.spotanimId=_.g2();let N=_.g4();if(b.spotanimOffset=N>>16,b.spotanimLastCycle=this.loopCycle+(N&65535),b.spotanimFrame=0,b.spotanimCycle=0,b.spotanimLastCycle>this.loopCycle)b.spotanimFrame=-1;if(b.spotanimId===65535)b.spotanimId=-1}if((G&128)!==0)b.targetTileX=_.g2(),b.targetTileZ=_.g2(),b.lastFaceX=b.targetTileX,b.lastFaceZ=b.targetTileZ}}updatePlayers(){for(let _=-1;_<this.playerCount;_++){let R;if(_===-1)R=2047;else R=this.playerIds[_];let E=this.players[R];if(E)this.updateEntity(E)}if(p.cyclelogic6++,p.cyclelogic6>1406){p.cyclelogic6=0,this.out.p1isaac(219),this.out.p1(0);let _=this.out.pos;if(this.out.p1(162),this.out.p1(22),(Math.random()*2|0)===0)this.out.p1(84);if(this.out.p2(31824),this.out.p2(13490),(Math.random()*2|0)===0)this.out.p1(123);if((Math.random()*2|0)===0)this.out.p1(134);this.out.p1(100),this.out.p1(94),this.out.p2(35521),this.out.psize1(this.out.pos-_)}}updateEntity(_){if(_.x<128||_.z<128||_.x>=13184||_.z>=13184)_.primarySeqId=-1,_.spotanimId=-1,_.forceMoveEndCycle=0,_.forceMoveStartCycle=0,_.x=_.routeFlagX[0]*128+_.size*64,_.z=_.routeFlagZ[0]*128+_.size*64,_.routeLength=0;if(_===this.localPlayer&&(_.x<1536||_.z<1536||_.x>=11776||_.z>=11776))_.primarySeqId=-1,_.spotanimId=-1,_.forceMoveEndCycle=0,_.forceMoveStartCycle=0,_.x=_.routeFlagX[0]*128+_.size*64,_.z=_.routeFlagZ[0]*128+_.size*64,_.routeLength=0;if(_.forceMoveEndCycle>this.loopCycle)this.updateForceMovement(_);else if(_.forceMoveStartCycle>=this.loopCycle)this.startForceMovement(_);else this.updateMovement(_);this.updateFacingDirection(_),this.updateSequences(_)}pushPlayers(){if(!this.localPlayer)return;if(this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ)this.flagSceneTileX=0;for(let _=-1;_<this.playerCount;_++){let R,E;if(_===-1)R=this.localPlayer,E=33538048;else R=this.players[this.playerIds[_]],E=this.playerIds[_]<<14;if(!R||!R.isVisibleNow())continue;R.lowMemory=(p.lowMemory&&this.playerCount>50||this.playerCount>200)&&_!==-1&&R.secondarySeqId===R.seqStandId;let b=R.x>>7,G=R.z>>7;if(b<0||b>=104||G<0||G>=104)continue;if(!R.locModel||this.loopCycle<R.locStartCycle||this.loopCycle>=R.locStopCycle){if((R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[b][G]===this.sceneCycle)continue;this.tileLastOccupiedCycle[b][G]=this.sceneCycle}R.y=this.getHeightmapY(this.currentLevel,R.x,R.z),this.scene?.addTemporary(this.currentLevel,R.x,R.y,R.z,null,R,E,R.yaw,60,R.seqStretches)}else R.lowMemory=!1,R.y=this.getHeightmapY(this.currentLevel,R.x,R.z),this.scene?.addTemporary2(this.currentLevel,R.x,R.y,R.z,R.minTileX,R.minTileZ,R.maxTileX,R.maxTileZ,null,R,E,R.yaw)}}updateNpcs(){for(let _=0;_<this.npcCount;_++){let R=this.npcIds[_],E=this.npcs[R];if(E&&E.npcType)this.updateEntity(E)}}pushNpcs(){for(let _=0;_<this.npcCount;_++){let R=this.npcs[this.npcIds[_]],E=(this.npcIds[_]<<14)+536870911+1|0;if(!R||!R.isVisibleNow())continue;let b=R.x>>7,G=R.z>>7;if(b<0||b>=104||G<0||G>=104)continue;if(R.size===1&&(R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[b][G]===this.sceneCycle)continue;this.tileLastOccupiedCycle[b][G]=this.sceneCycle}this.scene?.addTemporary(this.currentLevel,R.x,this.getHeightmapY(this.currentLevel,R.x,R.z),R.z,null,R,E,R.yaw,(R.size-1)*64+60,R.seqStretches)}}pushProjectiles(){for(let _=this.projectiles.head();_;_=this.projectiles.next())if(_.projLevel!==this.currentLevel||this.loopCycle>_.lastCycle)_.unlink();else if(this.loopCycle>=_.startCycle){if(_.projTarget>0){let R=this.npcs[_.projTarget-1];if(R)_.updateVelocity(R.x,this.getHeightmapY(_.projLevel,R.x,R.z)-_.projOffsetY,R.z,this.loopCycle)}if(_.projTarget<0){let R=-_.projTarget-1,E;if(R===this.localPid)E=this.localPlayer;else E=this.players[R];if(E)_.updateVelocity(E.x,this.getHeightmapY(_.projLevel,E.x,E.z)-_.projOffsetY,E.z,this.loopCycle)}_.update(this.sceneDelta),this.scene?.addTemporary(this.currentLevel,_.x|0,_.y|0,_.z|0,null,_,-1,_.yaw,60,!1)}}pushSpotanims(){for(let _=this.spotanims.head();_;_=this.spotanims.next())if(_.spotLevel!==this.currentLevel||_.seqComplete)_.unlink();else if(this.loopCycle>=_.startCycle)if(_.update(this.sceneDelta),_.seqComplete)_.unlink();else this.scene?.addTemporary(_.spotLevel,_.x,_.y,_.z,null,_,-1,0,60,!1)}pushLocs(){for(let _=this.locList.head();_;_=this.locList.next()){let R=!1;if(_.seqCycle+=this.sceneDelta,_.seqFrame===-1)_.seqFrame=0,R=!0;if(_.seq.seqDelay){while(_.seqCycle>_.seq.seqDelay[_.seqFrame])if(_.seqCycle-=_.seq.seqDelay[_.seqFrame]+1,_.seqFrame++,R=!0,_.seqFrame>=_.seq.seqFrameCount){if(_.seqFrame-=_.seq.replayoff,_.seqFrame<0||_.seqFrame>=_.seq.seqFrameCount){_.unlink(),R=!1;break}}}if(R&&this.scene){let{heightmapSW:E,heightmapNE:b,heightmapNW:G}=_,N=0;if(_.heightmapSE===0)N=this.scene.getWallTypecode(E,b,G);else if(_.heightmapSE===1)N=this.scene.getDecorTypecode(E,G,b);else if(_.heightmapSE===2)N=this.scene.getLocTypecode(E,b,G);else if(_.heightmapSE===3)N=this.scene.getGroundDecorTypecode(E,b,G);if(this.levelHeightmap&&N!==0&&(N>>14&32767)===_.index){let L=this.levelHeightmap[E][b][G],H=this.levelHeightmap[E][b+1][G],I=this.levelHeightmap[E][b+1][G+1],Q=this.levelHeightmap[E][b][G+1],q=Q0.get(_.index),O=-1;if(_.seqFrame!==-1&&_.seq.seqFrames)O=_.seq.seqFrames[_.seqFrame];if(_.heightmapSE===2){let U=this.scene.getInfo(E,b,G,N),$=U&31,K=U>>6;if($===h.CENTREPIECE_DIAGONAL.id)$=h.CENTREPIECE_STRAIGHT.id;this.scene?.setLocModel(E,b,G,q.getModel($,K,L,H,I,Q,O))}else if(_.heightmapSE===1)this.scene?.setWallDecorationModel(E,b,G,q.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,L,H,I,Q,O));else if(_.heightmapSE===0){let U=this.scene.getInfo(E,b,G,N),$=U&31,K=U>>6;if($===h.WALL_L.id){let u=K+1&3;this.scene?.setWallModels(b,G,E,q.getModel(h.WALL_L.id,K+4,L,H,I,Q,O),q.getModel(h.WALL_L.id,u,L,H,I,Q,O))}else this.scene?.setWallModel(E,b,G,q.getModel($,K,L,H,I,Q,O))}else if(_.heightmapSE===3){let $=this.scene.getInfo(E,b,G,N)>>6;this.scene?.setGroundDecorationModel(E,b,G,q.getModel(h.GROUND_DECOR.id,$,L,H,I,Q,O))}}else _.unlink()}}}updateEntityChats(){for(let _=-1;_<this.playerCount;_++){let R;if(_===-1)R=2047;else R=this.playerIds[_];let E=this.players[R];if(E&&E.chatTimer>0){if(E.chatTimer--,E.chatTimer===0)E.chat=null}}for(let _=0;_<this.npcCount;_++){let R=this.npcIds[_],E=this.npcs[R];if(E&&E.chatTimer>0){if(E.chatTimer--,E.chatTimer===0)E.chat=null}}}updateForceMovement(_){let R=_.forceMoveEndCycle-this.loopCycle,E=_.forceMoveStartSceneTileX*128+_.size*64,b=_.forceMoveStartSceneTileZ*128+_.size*64;if(_.x+=(E-_.x)/R|0,_.z+=(b-_.z)/R|0,_.seqTrigger=0,_.forceMoveFaceDirection===0)_.dstYaw=1024;if(_.forceMoveFaceDirection===1)_.dstYaw=1536;if(_.forceMoveFaceDirection===2)_.dstYaw=0;if(_.forceMoveFaceDirection===3)_.dstYaw=512}startForceMovement(_){if(_.forceMoveStartCycle===this.loopCycle||_.primarySeqId===-1||_.primarySeqDelay!==0||_.primarySeqCycle+1>r.instances[_.primarySeqId].seqDelay[_.primarySeqFrame]){let R=_.forceMoveStartCycle-_.forceMoveEndCycle,E=this.loopCycle-_.forceMoveEndCycle,b=_.forceMoveStartSceneTileX*128+_.size*64,G=_.forceMoveStartSceneTileZ*128+_.size*64,N=_.forceMoveEndSceneTileX*128+_.size*64,L=_.forceMoveEndSceneTileZ*128+_.size*64;_.x=(b*(R-E)+N*E)/R|0,_.z=(G*(R-E)+L*E)/R|0}if(_.seqTrigger=0,_.forceMoveFaceDirection===0)_.dstYaw=1024;if(_.forceMoveFaceDirection===1)_.dstYaw=1536;if(_.forceMoveFaceDirection===2)_.dstYaw=0;if(_.forceMoveFaceDirection===3)_.dstYaw=512;_.yaw=_.dstYaw}updateFacingDirection(_){if(_.targetId!==-1&&_.targetId<32768){let E=this.npcs[_.targetId];if(E){let b=_.x-E.x,G=_.z-E.z;if(b!==0||G!==0)_.dstYaw=(Math.atan2(b,G)*325.949|0)&2047}}if(_.targetId>=32768){let E=_.targetId-32768;if(E===this.localPid)E=2047;let b=this.players[E];if(b){let G=_.x-b.x,N=_.z-b.z;if(G!==0||N!==0)_.dstYaw=(Math.atan2(G,N)*325.949|0)&2047}}if((_.targetTileX!==0||_.targetTileZ!==0)&&(_.routeLength===0||_.seqTrigger>0)){let E=_.x-(_.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX)*64,b=_.z-(_.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ)*64;if(E!==0||b!==0)_.dstYaw=(Math.atan2(E,b)*325.949|0)&2047;_.targetTileX=0,_.targetTileZ=0}let R=_.dstYaw-_.yaw&2047;if(R!==0){if(R<32||R>2016)_.yaw=_.dstYaw;else if(R>1024)_.yaw-=32;else _.yaw+=32;if(_.yaw&=2047,_.secondarySeqId===_.seqStandId&&_.yaw!==_.dstYaw){if(_.seqTurnId!==-1){_.secondarySeqId=_.seqTurnId;return}_.secondarySeqId=_.seqWalkId}}}updateSequences(_){_.seqStretches=!1;let R;if(_.secondarySeqId!==-1){if(R=r.instances[_.secondarySeqId],_.secondarySeqCycle++,R.seqDelay&&_.secondarySeqFrame<R.seqFrameCount&&_.secondarySeqCycle>R.seqDelay[_.secondarySeqFrame])_.secondarySeqCycle=0,_.secondarySeqFrame++;if(_.secondarySeqFrame>=R.seqFrameCount)_.secondarySeqCycle=0,_.secondarySeqFrame=0}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){R=r.instances[_.primarySeqId],_.primarySeqCycle++;while(R.seqDelay&&_.primarySeqFrame<R.seqFrameCount&&_.primarySeqCycle>R.seqDelay[_.primarySeqFrame])_.primarySeqCycle-=R.seqDelay[_.primarySeqFrame],_.primarySeqFrame++;if(_.primarySeqFrame>=R.seqFrameCount){if(_.primarySeqFrame-=R.replayoff,_.primarySeqLoop++,_.primarySeqLoop>=R.replaycount)_.primarySeqId=-1;if(_.primarySeqFrame<0||_.primarySeqFrame>=R.seqFrameCount)_.primarySeqId=-1}_.seqStretches=R.stretches}if(_.primarySeqDelay>0)_.primarySeqDelay--;if(_.spotanimId!==-1&&this.loopCycle>=_.spotanimLastCycle){if(_.spotanimFrame<0)_.spotanimFrame=0;R=T0.instances[_.spotanimId].seq,_.spotanimCycle++;while(R&&R.seqDelay&&_.spotanimFrame<R.seqFrameCount&&_.spotanimCycle>R.seqDelay[_.spotanimFrame])_.spotanimCycle-=R.seqDelay[_.spotanimFrame],_.spotanimFrame++;if(R&&_.spotanimFrame>=R.seqFrameCount){if(_.spotanimFrame<0||_.spotanimFrame>=R.seqFrameCount)_.spotanimId=-1}}}updateMovement(_){if(_.secondarySeqId=_.seqStandId,_.routeLength===0){_.seqTrigger=0;return}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){if(!r.instances[_.primarySeqId].walkmerge){_.seqTrigger++;return}}let{x:R,z:E}=_,b=_.routeFlagX[_.routeLength-1]*128+_.size*64,G=_.routeFlagZ[_.routeLength-1]*128+_.size*64;if(b-R<=256&&b-R>=-256&&G-E<=256&&G-E>=-256){if(R<b)if(E<G)_.dstYaw=1280;else if(E>G)_.dstYaw=1792;else _.dstYaw=1536;else if(R>b)if(E<G)_.dstYaw=768;else if(E>G)_.dstYaw=256;else _.dstYaw=512;else if(E<G)_.dstYaw=1024;else _.dstYaw=0;let N=_.dstYaw-_.yaw&2047;if(N>1024)N-=2048;let L=_.seqTurnAroundId;if(N>=-256&&N<=256)L=_.seqWalkId;else if(N>=256&&N<768)L=_.seqTurnRightId;else if(N>=-768&&N<=-256)L=_.seqTurnLeftId;if(L===-1)L=_.seqWalkId;_.secondarySeqId=L;let H=4;if(_.yaw!==_.dstYaw&&_.targetId===-1)H=2;if(_.routeLength>2)H=6;if(_.routeLength>3)H=8;if(_.seqTrigger>0&&_.routeLength>1)H=8,_.seqTrigger--;if(_.routeRun[_.routeLength-1])H<<=1;if(H>=8&&_.secondarySeqId===_.seqWalkId&&_.seqRunId!==-1)_.secondarySeqId=_.seqRunId;if(R<b){if(_.x+=H,_.x>b)_.x=b}else if(R>b){if(_.x-=H,_.x<b)_.x=b}if(E<G){if(_.z+=H,_.z>G)_.z=G}else if(E>G){if(_.z-=H,_.z<G)_.z=G}if(_.x===b&&_.z===G)_.routeLength--}else _.x=b,_.z=G}getTopLevel(){let _=3;if(this.cameraPitch<310&&this.localPlayer){let R=this.cameraX>>7,E=this.cameraZ>>7,b=this.localPlayer.x>>7,G=this.localPlayer.z>>7;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel;let N;if(b>R)N=b-R;else N=R-b;let L;if(G>E)L=G-E;else L=E-G;let H,I;if(N>L){H=L*65536/N|0,I=32768;while(R!==b){if(R<b)R++;else if(R>b)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel;if(I+=H,I>=65536){if(I-=65536,E<G)E++;else if(E>G)E--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel}}}else{H=N*65536/L|0,I=32768;while(E!==G){if(E<G)E++;else if(E>G)E--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel;if(I+=H,I>=65536){if(I-=65536,R<b)R++;else if(R>b)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][E]&4)!==0)_=this.currentLevel}}}}if(this.localPlayer&&this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7]&4)!==0)_=this.currentLevel;return _}getTopLevelCutscene(){if(!this.levelTileFlags)return 0;return this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ)-this.cameraY>=800||(this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7]&4)===0?3:this.currentLevel}getHeightmapY(_,R,E){if(!this.levelHeightmap)return 0;let b=Math.min(R>>7,104-1),G=Math.min(E>>7,104-1),N=_;if(_<3&&this.levelTileFlags&&(this.levelTileFlags[1][b][G]&2)===2)N=_+1;let L=R&127,H=E&127,I=this.levelHeightmap[N][b][G]*(128-L)+this.levelHeightmap[N][b+1][G]*L>>7,Q=this.levelHeightmap[N][b][G+1]*(128-L)+this.levelHeightmap[N][b+1][G+1]*L>>7;return I*(128-H)+Q*H>>7}orbitCamera(_,R,E,b,G,N){let L=2048-G&2047,H=2048-b&2047,I=0,Q=0,q=N,O,U,$;if(L!==0)O=w.sin[L],U=w.cos[L],$=Q*U-N*O>>16,q=Q*O+N*U>>16,Q=$;if(H!==0)O=w.sin[H],U=w.cos[H],$=q*O+I*U>>16,q=q*U-I*O>>16,I=$;this.cameraX=_-I,this.cameraY=R-Q,this.cameraZ=E-q,this.cameraPitch=G,this.cameraYaw=b}updateOrbitCamera(){if(!this.localPlayer)return;let _=this.localPlayer.x+this.cameraAnticheatOffsetX,R=this.localPlayer.z+this.cameraAnticheatOffsetZ;if(this.orbitCameraX-_<-500||this.orbitCameraX-_>500||this.orbitCameraZ-R<-500||this.orbitCameraZ-R>500)this.orbitCameraX=_,this.orbitCameraZ=R;if(this.orbitCameraX!==_)this.orbitCameraX+=(_-this.orbitCameraX)/16|0;if(this.orbitCameraZ!==R)this.orbitCameraZ+=(R-this.orbitCameraZ)/16|0;if(this.actionKey[1]===1)this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0;else if(this.actionKey[2]===1)this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0;else this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0;if(this.actionKey[3]===1)this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0;else if(this.actionKey[4]===1)this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0;else this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0;if(this.orbitCameraYaw=(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0)&2047,this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0,this.orbitCameraPitch<128)this.orbitCameraPitch=128;if(this.orbitCameraPitch>383)this.orbitCameraPitch=383;let E=this.orbitCameraX>>7,b=this.orbitCameraZ>>7,G=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ),N=0;if(this.levelHeightmap){if(E>3&&b>3&&E<100&&b<100)for(let H=E-4;H<=E+4;H++)for(let I=b-4;I<=b+4;I++){let Q=this.currentLevel;if(Q<3&&this.levelTileFlags&&(this.levelTileFlags[1][H][I]&2)===2)Q++;let q=G-this.levelHeightmap[Q][H][I];if(q>N)N=q}}let L=N*192;if(L>98048)L=98048;if(L<32768)L=32768;if(L>this.cameraPitchClamp)this.cameraPitchClamp+=(L-this.cameraPitchClamp)/24|0;else if(L<this.cameraPitchClamp)this.cameraPitchClamp+=(L-this.cameraPitchClamp)/80|0}applyCutscene(){let _=this.cutsceneSrcLocalTileX*128+64,R=this.cutsceneSrcLocalTileZ*128+64,E=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;if(this.cameraX<_){if(this.cameraX+=this.cutsceneMoveSpeed+((_-this.cameraX)*this.cutsceneMoveAcceleration/1000|0),this.cameraX>_)this.cameraX=_}if(this.cameraX>_){if(this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-_)*this.cutsceneMoveAcceleration/1000|0),this.cameraX<_)this.cameraX=_}if(this.cameraY<E){if(this.cameraY+=this.cutsceneMoveSpeed+((E-this.cameraY)*this.cutsceneMoveAcceleration/1000|0),this.cameraY>E)this.cameraY=E}if(this.cameraY>E){if(this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-E)*this.cutsceneMoveAcceleration/1000|0),this.cameraY<E)this.cameraY=E}if(this.cameraZ<R){if(this.cameraZ+=this.cutsceneMoveSpeed+((R-this.cameraZ)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ>R)this.cameraZ=R}if(this.cameraZ>R){if(this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-R)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ<R)this.cameraZ=R}_=this.cutsceneDstLocalTileX*128+64,R=this.cutsceneDstLocalTileZ*128+64,E=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;let b=_-this.cameraX,G=E-this.cameraY,N=R-this.cameraZ,L=Math.sqrt(b*b+N*N)|0,H=(Math.atan2(G,L)*325.949|0)&2047,I=(Math.atan2(b,N)*-325.949|0)&2047;if(H<128)H=128;if(H>383)H=383;if(this.cameraPitch<H){if(this.cameraPitch+=this.cutsceneRotateSpeed+((H-this.cameraPitch)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch>H)this.cameraPitch=H}if(this.cameraPitch>H){if(this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-H)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch<H)this.cameraPitch=H}let Q=I-this.cameraYaw;if(Q>1024)Q-=2048;if(Q<-1024)Q+=2048;if(Q>0)this.cameraYaw+=this.cutsceneRotateSpeed+(Q*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;if(Q<0)this.cameraYaw-=this.cutsceneRotateSpeed+(-Q*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;let q=I-this.cameraYaw;if(q>1024)q-=2048;if(q<-1024)q+=2048;if(q<0&&Q>0||q>0&&Q<0)this.cameraYaw=I}readZonePacket(_,R){let E=_.g1(),b=this.baseX+(E>>4&7),G=this.baseZ+(E&7);if(R===59){let N=_.g1(),L=_.g2(),H=N>>2,I=N&3,Q=h.of(H).layer;if(b>=0&&G>=0&&b<104&&G<104)this.appendLoc(-1,L,I,Q,G,H,this.currentLevel,b,0)}else if(R===76){let N=_.g1(),L=N>>2,H=N&3,I=h.of(L).layer;if(b>=0&&G>=0&&b<104&&G<104)this.appendLoc(-1,-1,H,I,G,L,this.currentLevel,b,0)}else if(R===42){let L=_.g1()>>2,H=h.of(L).layer,I=_.g2();if(b>=0&&G>=0&&b<104&&G<104&&this.scene){let Q=0;if(H===0)Q=this.scene.getWallTypecode(this.currentLevel,b,G);else if(H===1)Q=this.scene.getDecorTypecode(this.currentLevel,G,b);else if(H===2)Q=this.scene.getLocTypecode(this.currentLevel,b,G);else if(H===3)Q=this.scene.getGroundDecorTypecode(this.currentLevel,b,G);if(Q!==0){let q=new G0(Q>>14&32767,this.currentLevel,H,b,G,r.instances[I],!1);this.locList.addTail(q)}}}else if(R===223){let N=_.g2(),L=_.g2();if(b>=0&&G>=0&&b<104&&G<104){let H=new r0(N,L);if(!this.objStacks[this.currentLevel][b][G])this.objStacks[this.currentLevel][b][G]=new m0;this.objStacks[this.currentLevel][b][G]?.addTail(H),this.sortObjStacks(b,G)}}else if(R===49){let N=_.g2();if(b>=0&&G>=0&&b<104&&G<104){let L=this.objStacks[this.currentLevel][b][G];if(L){for(let H=L.head();H;H=L.next())if(H.index===(N&32767)){H.unlink();break}if(!L.head())this.objStacks[this.currentLevel][b][G]=null;this.sortObjStacks(b,G)}}}else if(R===69){let N=b+_.g1b(),L=G+_.g1b(),H=_.g2b(),I=_.g2(),Q=_.g1(),q=_.g1(),O=_.g2(),U=_.g2(),$=_.g1(),K=_.g1();if(b>=0&&G>=0&&b<104&&G<104&&N>=0&&L>=0&&N<104&&L<104){b=b*128+64,G=G*128+64,N=N*128+64,L=L*128+64;let u=new Q_(I,this.currentLevel,b,this.getHeightmapY(this.currentLevel,b,G)-Q,G,O+this.loopCycle,U+this.loopCycle,$,K,H,q);u.updateVelocity(N,this.getHeightmapY(this.currentLevel,N,L)-q,L,O+this.loopCycle),this.projectiles.addTail(u)}}else if(R===191){let N=_.g2(),L=_.g1(),H=_.g2();if(b>=0&&G>=0&&b<104&&G<104){b=b*128+64,G=G*128+64;let I=new q_(N,this.currentLevel,b,G,this.getHeightmapY(this.currentLevel,b,G)-L,this.loopCycle,H);this.spotanims.addTail(I)}}else if(R===50){let N=_.g2(),L=_.g2(),H=_.g2();if(b>=0&&G>=0&&b<104&&G<104&&H!==this.localPid){let I=new r0(N,L);if(!this.objStacks[this.currentLevel][b][G])this.objStacks[this.currentLevel][b][G]=new m0;this.objStacks[this.currentLevel][b][G]?.addTail(I),this.sortObjStacks(b,G)}}else if(R===23){let N=_.g1(),L=N>>2,H=N&3,I=h.of(L).layer,Q=_.g2(),q=_.g2(),O=_.g2(),U=_.g2(),$=_.g1b(),K=_.g1b(),u=_.g1b(),F=_.g1b(),k;if(U===this.localPid)k=this.localPlayer;else k=this.players[U];if(k&&this.levelHeightmap){this.appendLoc(q+this.loopCycle,-1,H,I,G,L,this.currentLevel,b,O+this.loopCycle);let j=this.levelHeightmap[this.currentLevel][b][G],m=this.levelHeightmap[this.currentLevel][b+1][G],Y=this.levelHeightmap[this.currentLevel][b+1][G+1],X=this.levelHeightmap[this.currentLevel][b][G+1],B=Q0.get(Q);k.locStartCycle=q+this.loopCycle,k.locStopCycle=O+this.loopCycle,k.locModel=B.getModel(L,H,j,m,Y,X,-1);let{width:z,length:Z}=B;if(H===1||H===3)z=B.length,Z=B.width;k.locOffsetX=b*128+z*64,k.locOffsetZ=G*128+Z*64,k.locOffsetY=this.getHeightmapY(this.currentLevel,k.locOffsetX,k.locOffsetZ);let g;if($>u)g=$,$=u,u=g;if(K>F)g=K,K=F,F=g;k.minTileX=b+$,k.maxTileX=b+u,k.minTileZ=G+K,k.maxTileZ=G+F}}else if(R===151){let N=_.g2(),L=_.g2(),H=_.g2();if(b>=0&&G>=0&&b<104&&G<104){let I=this.objStacks[this.currentLevel][b][G];if(I){for(let Q=I.head();Q;Q=I.next())if(Q.index===(N&32767)&&Q.count===L){Q.count=H;break}this.sortObjStacks(b,G)}}}}updateTextures(_){if(!p.lowMemory){if(w.textureCycle[17]>=_){let R=w.textures[17];if(!R)return;let E=R.width2d*R.height2d-1,b=R.width2d*this.sceneDelta*2,G=R.pixels,N=this.textureBuffer;for(let L=0;L<=E;L++)N[L]=G[L-b&E];R.pixels=N,this.textureBuffer=G,w.pushTexture(17)}if(w.textureCycle[24]>=_){let R=w.textures[24];if(!R)return;let E=R.width2d*R.height2d-1,b=R.width2d*this.sceneDelta*2,G=R.pixels,N=this.textureBuffer;for(let L=0;L<=E;L++)N[L]=G[L-b&E];R.pixels=N,this.textureBuffer=G,w.pushTexture(24)}}}updateFlames(){if(!this.flameBuffer3||!this.flameBuffer2||!this.flameBuffer0||!this.flameLineOffset)return;let _=256;for(let R=10;R<117;R++)if((Math.random()*100|0)<50)this.flameBuffer3[R+(_-2<<7)]=255;for(let R=0;R<100;R++){let E=(Math.random()*124|0)+2,b=(Math.random()*128|0)+128,G=E+(b<<7);this.flameBuffer3[G]=192}for(let R=1;R<_-1;R++)for(let E=1;E<127;E++){let b=E+(R<<7);this.flameBuffer2[b]=(this.flameBuffer3[b-1]+this.flameBuffer3[b+1]+this.flameBuffer3[b-128]+this.flameBuffer3[b+128])/4|0}if(this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length)this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[Math.random()*12|0]);for(let R=1;R<_-1;R++)for(let E=1;E<127;E++){let b=E+(R<<7),G=this.flameBuffer2[b+128]-(this.flameBuffer0[b+this.flameCycle0&this.flameBuffer0.length-1]/5|0);if(G<0)G=0;this.flameBuffer3[b]=G}for(let R=0;R<_-1;R++)this.flameLineOffset[R]=this.flameLineOffset[R+1];if(this.flameLineOffset[_-1]=Math.sin(this.loopCycle/14)*16+Math.sin(this.loopCycle/15)*14+Math.sin(this.loopCycle/16)*12|0,this.flameGradientCycle0>0)this.flameGradientCycle0-=4;if(this.flameGradientCycle1>0)this.flameGradientCycle1-=4;if(this.flameGradientCycle0===0&&this.flameGradientCycle1===0){let R=Math.random()*2000|0;if(R===0)this.flameGradientCycle0=1024;else if(R===1)this.flameGradientCycle1=1024}}mix(_,R,E){let b=256-R;return((_&16711935)*b+(E&16711935)*R&4278255360)+((_&65280)*b+(E&65280)*R&16711680)>>8}drawFlames(){if(!this.flameGradient||!this.flameGradient0||!this.flameGradient1||!this.flameGradient2||!this.flameLineOffset||!this.flameBuffer3)return;let _=256;if(this.flameGradientCycle0>0)for(let b=0;b<256;b++)if(this.flameGradientCycle0>768)this.flameGradient[b]=this.mix(this.flameGradient0[b],1024-this.flameGradientCycle0,this.flameGradient1[b]);else if(this.flameGradientCycle0>256)this.flameGradient[b]=this.flameGradient1[b];else this.flameGradient[b]=this.mix(this.flameGradient1[b],256-this.flameGradientCycle0,this.flameGradient0[b]);else if(this.flameGradientCycle1>0)for(let b=0;b<256;b++)if(this.flameGradientCycle1>768)this.flameGradient[b]=this.mix(this.flameGradient0[b],1024-this.flameGradientCycle1,this.flameGradient2[b]);else if(this.flameGradientCycle1>256)this.flameGradient[b]=this.flameGradient2[b];else this.flameGradient[b]=this.mix(this.flameGradient2[b],256-this.flameGradientCycle1,this.flameGradient0[b]);else for(let b=0;b<256;b++)this.flameGradient[b]=this.flameGradient0[b];for(let b=0;b<33920;b++)if(this.imageTitle0&&this.imageFlamesLeft)this.imageTitle0.pixels[b]=this.imageFlamesLeft.pixels[b];let R=0,E=1152;for(let b=1;b<_-1;b++){let N=(this.flameLineOffset[b]*(_-b)/_|0)+22;if(N<0)N=0;R+=N;for(let L=N;L<128;L++){let H=this.flameBuffer3[R++];if(H===0)E++;else{let I=H,Q=256-H;if(H=this.flameGradient[H],this.imageTitle0){let q=this.imageTitle0.pixels[E];this.imageTitle0.pixels[E++]=((H&16711935)*I+(q&16711935)*Q&4278255360)+((H&65280)*I+(q&65280)*Q&16711680)>>8}}}E+=N}this.imageTitle0?.draw(0,0);for(let b=0;b<33920;b++)if(this.imageTitle1&&this.imageFlamesRight)this.imageTitle1.pixels[b]=this.imageFlamesRight.pixels[b];R=0,E=1176;for(let b=1;b<_-1;b++){let G=this.flameLineOffset[b]*(_-b)/_|0,N=103-G;E+=G;for(let L=0;L<N;L++){let H=this.flameBuffer3[R++];if(H===0)E++;else{let I=H,Q=256-H;if(H=this.flameGradient[H],this.imageTitle1){let q=this.imageTitle1.pixels[E];this.imageTitle1.pixels[E++]=((H&16711935)*I+(q&16711935)*Q&4278255360)+((H&65280)*I+(q&65280)*Q&16711680)>>8}}}R+=128-N,E+=128-N-G}this.imageTitle1?.draw(661,0)}}export{p as Client};

//# debugId=A3CF54119763E92164756E2164756E21
