import{playWave as s,setWaveVolume as h,BZip2 as vt,playMidi as wt,stopMidi as l,setMidiVolume as o}from"./deps.js";var n=document.getElementById("canvas"),a=n.getContext("2d",{willReadFrequently:!0}),d=document.createElement("canvas"),u=document.createElement("img"),f=d.getContext("2d",{willReadFrequently:!0});class i{key=0n;next=null;prev=null;unlink(){null!=this.prev&&(this.prev.next=this.next,this.next&&(this.next.prev=this.prev),this.next=null,this.prev=null)}}class t extends i{next2=null;prev2=null;unlink2(){null!==this.prev2&&(this.prev2.next2=this.next2,this.next2&&(this.next2.prev2=this.prev2),this.next2=null,this.prev2=null)}}class D extends t{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind=(e,t,i)=>{this.pixels=e,this.width2d=t,this.height2d=i,this.setBounds(0,0,t,i)};static resetBounds=()=>{this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0};static setBounds=(e,t,i,s)=>{e<0&&(e=0),i>this.width2d&&(i=this.width2d),s>this.height2d&&(s=this.height2d),this.top=t=t<0?0:t,this.bottom=s,this.left=e,this.right=i,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0};static clear=()=>{var t=this.width2d*this.height2d;for(let e=0;e<t;e++)this.pixels[e]=0};static drawRect=(e,t,i,s,a)=>{this.drawHorizontalLine(e,t,a,i),this.drawHorizontalLine(e,t+s-1,a,i),this.drawVerticalLine(e,t,a,s),this.drawVerticalLine(e+i-1,t,a,s)};static drawHorizontalLine=(e,t,i,s)=>{if(!(t<this.top||t>=this.bottom)){e<this.left&&(s-=this.left-e,e=this.left),e+s>this.right&&(s=this.right-e);var a=e+t*this.width2d;for(let e=0;e<s;e++)this.pixels[a+e]=i}};static drawVerticalLine=(e,t,i,s)=>{if(!(e<this.left||e>=this.right)){t<this.top&&(s-=this.top-t,t=this.top),t+s>this.bottom&&(s=this.bottom-t);var a=e+t*this.width2d;for(let e=0;e<s;e++)this.pixels[a+e*this.width2d]=i}};static drawLine=(e,t,i,s,a)=>{var r=Math.abs(i-e),h=Math.abs(s-t),l=e<i?1:-1,n=t<s?1:-1;let o=r-h;for(;;){if(e>=this.left&&e<this.right&&t>=this.top&&t<this.bottom&&(this.pixels[e+t*this.width2d]=a),e===i&&t===s)break;var c=2*o;-h<c&&(o-=h,e+=l),c<r&&(o+=r,t+=n)}};static fillRect=(e,t,i,s,a)=>{e<this.left&&(i-=this.left-e,e=this.left),t<this.top&&(s-=this.top-t,t=this.top),e+i>this.right&&(i=this.right-e),t+s>this.bottom&&(s=this.bottom-t);var r=this.width2d-i;let h=e+t*this.width2d;for(let e=-s;e<0;e++){for(let e=-i;e<0;e++)this.pixels[h++]=a;h+=r}};static fillRectAlpha(e,t,i,s,a,r){e<this.left&&(i-=this.left-e,e=this.left),t<this.top&&(s-=this.top-t,t=this.top),e+i>this.right&&(i=this.right-e),t+s>this.bottom&&(s=this.bottom-t);var h=256-r,l=(a>>16&255)*r,n=(a>>8&255)*r,o=(255&a)*r,c=this.width2d-i;let d=e+t*this.width2d;for(let e=0;e<s;e++){for(let e=-i;e<0;e++){var u=(this.pixels[d]>>16&255)*h,f=(this.pixels[d]>>8&255)*h,p=(255&this.pixels[d])*h;this.pixels[d++]=(l+u>>8<<16)+(n+f>>8<<8)+(o+p>>8)}d+=c}}static fillCircle(a,r,h,e,t){var l=256-t,n=(e>>16&255)*t,o=(e>>8&255)*t,c=(255&e)*t;let i=r-h,s=(i<0&&(i=0),r+h);s>=this.height2d&&(s=this.height2d-1);for(let e=i;e<=s;e++){var d=e-r,d=0|Math.sqrt(h*h-d*d);let t=a-d,i=(t<0&&(t=0),a+d),s=(i>=this.width2d&&(i=this.width2d-1),t+e*this.width2d);for(let e=t;e<=i;e++){var u=(this.pixels[s]>>16&255)*l,f=(this.pixels[s]>>8&255)*l,p=(255&this.pixels[s])*l;this.pixels[s++]=(n+u>>8<<16)+(o+f>>8<<8)+(c+p>>8)}}}static setPixel=(e,t,i)=>{e<this.left||e>=this.right||t<this.top||t>=this.bottom||(this.pixels[e+t*this.width2d]=i)}}class O{sentinel=new i;cursor=null;constructor(){this.sentinel.next=this.sentinel,this.sentinel.prev=this.sentinel}addTail(e){e.prev&&e.unlink(),e.prev=this.sentinel.prev,e.next=this.sentinel,e.prev&&(e.prev.next=e),e.next.prev=e}addHead(e){e.prev&&e.unlink(),e.prev=this.sentinel,e.next=this.sentinel.next,(e.prev.next=e).next&&(e.next.prev=e)}removeHead(){var e=this.sentinel.next;return e===this.sentinel?null:(e?.unlink(),e)}head(){var e=this.sentinel.next;return e===this.sentinel?this.cursor=null:(this.cursor=e?.next||null,e)}tail(){var e=this.sentinel.prev;return e===this.sentinel?this.cursor=null:(this.cursor=e?.prev||null,e)}next(){var e=this.cursor;return e===this.sentinel?this.cursor=null:(this.cursor=e?.next||null,e)}prev(){var e=this.cursor;return e===this.sentinel?this.cursor=null:(this.cursor=e?.prev||null,e)}clear(){for(;;){var e=this.sentinel.next;if(e===this.sentinel)return;e?.unlink()}}}var p=async t=>new Promise(e=>setTimeout(e,t)),F=async e=>new Uint8Array(await(await fetch(e)).arrayBuffer());function g(e,t,i,s,a){for(;a--;)i[s++]=e[t++]}class ht extends t{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new O;static cacheMid=new O;static cacheMax=new O;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let e=0;e<32;e++)ht.bitmask[e]=(1<<e)-1;ht.bitmask[32]=4294967295;for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)1==(1&t)?t=t>>>1^ht.CRC32_POLYNOMIAL:t>>>=1;ht.crctable[e]=t}}static crc32=t=>{let i=4294967295;for(let e=0;e<t.length;e++)i=i>>>8^ht.crctable[255&(i^t[e])];return~i};view;data;pos=0;bitPos=0;random=null;constructor(e){if(!e)throw Error("Input src packet array was null!");super(),e instanceof Int8Array?this.data=new Uint8Array(e):this.data=e,this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.length-this.pos}static alloc=e=>{let t=null;return 0===e&&0<ht.cacheMinCount?(ht.cacheMinCount--,t=ht.cacheMin.removeHead()):1===e&&0<ht.cacheMidCount?(ht.cacheMidCount--,t=ht.cacheMid.removeHead()):2===e&&0<ht.cacheMaxCount&&(ht.cacheMaxCount--,t=ht.cacheMax.removeHead()),t?(t.pos=0,t):0===e?new ht(new Uint8Array(100)):1===e?new ht(new Uint8Array(5e3)):new ht(new Uint8Array(3e4))};release(){this.pos=0,100===this.view.byteLength&&ht.cacheMinCount<1e3?(ht.cacheMin.addTail(this),ht.cacheMinCount++):5e3===this.view.byteLength&&ht.cacheMidCount<250?(ht.cacheMid.addTail(this),ht.cacheMidCount++):3e4===this.view.byteLength&&ht.cacheMaxCount<50&&(ht.cacheMax.addTail(this),ht.cacheMaxCount++)}get g1(){return this.view.getUint8(this.pos++)}get g1b(){return this.view.getInt8(this.pos++)}get g2(){var e=this.view.getUint16(this.pos);return this.pos+=2,e}get g2b(){var e=this.view.getInt16(this.pos);return this.pos+=2,e}get g3(){var e=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,e}get g4(){var e=this.view.getInt32(this.pos);return this.pos+=4,e}get g8(){var e=this.view.getBigInt64(this.pos);return this.pos+=8,e}get gsmart(){return this.view.getUint8(this.pos)<128?this.g1-64:this.g2-49152}get gsmarts(){return this.view.getUint8(this.pos)<128?this.g1:this.g2-32768}get gjstr(){var e,t=this.view,i=t.byteLength;let s="";for(;10!==(e=t.getUint8(this.pos++))&&this.pos<i;)s+=String.fromCharCode(e);return s}gdata(e,t,i){i.set(this.data.subarray(this.pos,this.pos+e),t),this.pos+=e}p1isaac(e){this.view.setUint8(this.pos++,e+(this.random?.nextInt??0)&255)}p1(e){this.view.setUint8(this.pos++,e)}p2(e){this.view.setUint16(this.pos,e),this.pos+=2}ip2(e){this.view.setUint16(this.pos,e,!0),this.pos+=2}p3(e){this.view.setUint8(this.pos++,e>>16),this.view.setUint16(this.pos,e),this.pos+=2}p4(e){this.view.setInt32(this.pos,e),this.pos+=4}ip4(e){this.view.setInt32(this.pos,e,!0),this.pos+=4}p8(e){this.view.setBigInt64(this.pos,e),this.pos+=8}pjstr(t){var i=this.view,s=t.length;for(let e=0;e<s;e++)i.setUint8(this.pos++,t.charCodeAt(e));i.setUint8(this.pos++,10)}pdata(e,t,i){this.data.set(e.subarray(i,i+t),this.pos),this.pos+=t-i}psize1(e){this.view.setUint8(this.pos-e-1,e)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(e){let t=this.bitPos>>>3,i=8-(7&this.bitPos),s=0;for(this.bitPos+=e;e>i;i=8)s+=(this.view.getUint8(t++)&ht.bitmask[i])<<e-i,e-=i;return e===i?s+=this.view.getUint8(t)&ht.bitmask[i]:s+=this.view.getUint8(t)>>>i-e&ht.bitmask[e],s}rsaenc(e,t){var i=this.pos,s=(this.pos=0,new Uint8Array(i)),i=(this.gdata(i,0,s),(t=>{let i=0n;for(let e=0;e<t.length;e++)i=i<<8n|BigInt(t[e]);return i})(s)),s=(e=>{for(var t=[];0n<e;)t.unshift(+(""+(0xffn&e))),e>>=8n;return 128&t[0]&&t.unshift(0),new Uint8Array(t)})(((e,t,i)=>{let s=1n;for(;0n<t;)t%2n===1n&&(s=s*e%i),e=e*e%i,t>>=1n;return s})(i,t,e));this.pos=0,this.p1(s.length),this.pdata(s,s.length,0)}}class b extends t{pixels;width;height;cropX;cropY;cropW;cropH;palette;constructor(e,t,i){super(),this.pixels=new Int8Array(e*t),this.width=this.cropW=e,this.height=this.cropH=t,this.cropX=this.cropY=0,this.palette=i}static fromArchive=(e,t,i=0)=>{var s=new ht(e.read(t+".dat")),a=new ht(e.read("index.dat")),t=(a.pos=s.g2,a.g2),e=a.g2,r=a.g1,h=new Int32Array(r);for(let e=1;e<r;e++)h[e]=a.g3,0===h[e]&&(h[e]=1);for(let e=0;e<i;e++)a.pos+=2,s.pos+=a.g2*a.g2,a.pos+=1;if(s.pos>s.length||a.pos>a.length)throw Error();var l=a.g1,n=a.g1,o=a.g2,c=a.g2,o=new b(o,c,h),d=(o.cropX=l,o.cropY=n,o.cropW=t,o.cropH=e,o.pixels),c=a.g1;if(0===c){var u=o.width*o.height;for(let e=0;e<u;e++)d[e]=s.g1b}else if(1===c){var f=o.width,p=o.height;for(let t=0;t<f;t++)for(let e=0;e<p;e++)d[t+e*f]=s.g1b}return o};draw(e,t){let i=(e=(e|0)+this.cropX)+(t=(t|0)+this.cropY)*D.width2d,s=0,a=this.height,r=this.width,h=D.width2d-r,l=0;var n;t<D.top&&(n=D.top-t,a-=n,t=D.top,s+=n*r,i+=n*D.width2d),t+a>D.bottom&&(a-=t+a-D.bottom),e<D.left&&(n=D.left-e,r-=n,e=D.left,s+=n,i+=n,l+=n,h+=n),e+r>D.right&&(t=e+r-D.right,r-=t,l+=t,h+=t),0<r&&0<a&&this.copyImage(r,a,this.pixels,s,l,D.pixels,i,h)}flipHorizontally(){var i=this.pixels,s=this.width,e=this.height;for(let t=0;t<e;t++){var a=s/2|0;for(let e=0;e<a;e++){var r=e+t*s,h=s-e-1+t*s,l=i[r];i[r]=i[h],i[h]=l}}}flipVertically(){var i=this.pixels,s=this.width,a=this.height;for(let t=0;t<(a/2|0);t++)for(let e=0;e<s;e++){var r=e+t*s,h=e+(a-t-1)*s,l=i[r];i[r]=i[h],i[h]=l}}translate(a,r,h){for(let s=0;s<this.palette.length;s++){let e=this.palette[s]>>16&255,t=((e+=a)<0?e=0:255<e&&(e=255),this.palette[s]>>8&255),i=((t+=r)<0?t=0:255<t&&(t=255),255&this.palette[s]);(i+=h)<0?i=0:255<i&&(i=255),this.palette[s]=(e<<16)+(t<<8)+i}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;var i=new Int8Array(this.cropW*this.cropH);let s=0;for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++)i[(e+this.cropX>>1)+(t+this.cropY>>1)*this.cropW]=this.pixels[s++];this.pixels=i,this.width=this.cropW,this.height=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width!==this.cropW||this.height!==this.cropH){var s=new Int8Array(this.cropW*this.cropH);let i=0;for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++)s[e+this.cropX+(t+this.cropY)*this.cropW]=this.pixels[i++];this.pixels=s,this.width=this.cropW,this.height=this.cropH,this.cropX=0,this.cropY=0}}copyImage(t,i,s,a,r,h,l,n){var o=-(t>>2);t=-(3&t);for(let e=-i;e<0;e++){for(let e=o;e<0;e++){var c=s[a++];0===c?l++:h[l++]=this.palette[255&c],0===(c=s[a++])?l++:h[l++]=this.palette[255&c],0===(c=s[a++])?l++:h[l++]=this.palette[255&c],0===(c=s[a++])?l++:h[l++]=this.palette[255&c]}for(let e=t;e<0;e++){var d=s[a++];0===d?l++:h[l++]=this.palette[255&d]}l+=n,a+=r}}clip(r,h,l,n){try{var o=this.width;this.height;let e=0,t=0;var c=this.cropW,d=this.cropH,u=(c<<16)/l|0,f=(d<<16)/n|0;r=r+(this.cropX*l+c-1)/c|0,h=h+(this.cropY*n+d-1)/d|0,this.cropX*l%c!=0&&(e=(c-this.cropX*l%c<<16)/l|0),this.cropY*n%d!=0&&(t=(d-this.cropY*n%d<<16)/n|0),l=l*(this.width-(e>>16))/c|0,n=n*(this.height-(t>>16))/d|0;let i=r+h*D.width2d,s=D.width2d-l,a;h<D.top&&(n-=a=D.top-h,h=0,i+=a*D.width2d,t+=f*a),h+n>D.bottom&&(n-=h+n-D.bottom),r<D.left&&(l-=a=D.left-r,r=0,i+=a,e+=u*a,s+=a),r+l>D.right&&(l-=a=r+l-D.right,s+=a),this.plot_scale(D.pixels,this.pixels,this.palette,e,t,i,s,l,n,u,f,o)}catch(e){}}plot_scale(t,i,s,a,r,h,l,n,o,c,d,u){try{var f=a;for(let e=-o;e<0;e++){var p=(r>>16)*u;for(let e=-n;e<0;e++){var m=i[(a>>16)+p];0==m?h++:t[h++]=s[255&m],a+=c}r+=d,a=f,h+=l}}catch(e){}}}class lt extends Array{constructor(t,i){super(t);for(let e=0;e<t;e++)this[e]=i}}class C extends Array{constructor(e,i,s){super(e);for(let t=0;t<e;t++){this[t]=Array(i);for(let e=0;e<i;e++)this[t][e]=s}}}class y extends Array{constructor(e,s,a,r){super(e);for(let i=0;i<e;i++){this[i]=Array(s);for(let t=0;t<s;t++){this[i][t]=Array(a);for(let e=0;e<a;e++)this[i][t][e]=r}}}}class v extends Array{constructor(e,t,a,r,h){super(e);for(let s=0;s<e;s++){this[s]=Array(t);for(let i=0;i<t;i++){this[s][i]=Array(a);for(let t=0;t<a;t++){this[s][i][t]=Array(r);for(let e=0;e<r;e++)this[s][i][t][e]=h}}}}}class W extends Array{constructor(e,i,s){super(e);for(let t=0;t<e;t++){this[t]=Array(i);for(let e=0;e<i;e++)this[t][e]=new Uint8Array(s)}}}class w extends Array{constructor(t,i){super(t);for(let e=0;e<t;e++)this[e]=new Int32Array(i)}}class Z extends Array{constructor(e,i,s){super(e);for(let t=0;t<e;t++){this[t]=Array(i);for(let e=0;e<i;e++)this[t][e]=new Int32Array(s)}}}class _ extends D{static lowMemory=!1;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static palette=new Int32Array(65536);static textures=new lt(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new lt(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texturePalette=new lt(50,null);static opaque=!1;static textureTranslucent=new lt(50,!1);static averageTextureRGB=new Int32Array(50);static{for(let e=1;e<512;e++)this.reciprocal15[e]=32768/e|0;for(let e=1;e<2048;e++)this.reciprocal16[e]=65536/e|0;for(let e=0;e<2048;e++)this.sin[e]=65536*Math.sin(.0030679615757712823*e)|0,this.cos[e]=65536*Math.cos(.0030679615757712823*e)|0}static init2D=()=>{this.lineOffset=new Int32Array(D.height2d);for(let e=0;e<D.height2d;e++)this.lineOffset[e]=D.width2d*e;this.centerX=D.width2d/2|0,this.centerY=D.height2d/2|0};static init3D=(t,i)=>{this.lineOffset=new Int32Array(i);for(let e=0;e<i;e++)this.lineOffset[e]=t*e;this.centerX=t/2|0,this.centerY=i/2|0};static clearTexels=()=>{this.texelPool=null,this.activeTexels.fill(null)};static unpackTextures=t=>{for(let e=this.textureCount=0;e<50;e++)try{this.textures[e]=b.fromArchive(t,e.toString()),this.lowMemory&&128===this.textures[e]?.cropW?this.textures[e]?.shrink():this.textures[e]?.crop(),this.textureCount++}catch(e){}};static getAverageTextureRGB=e=>{if(0!==this.averageTextureRGB[e])return this.averageTextureRGB[e];var t=this.texturePalette[e];if(!t)return 0;let i=0,s=0,a=0;var r=t.length;for(let e=0;e<r;e++)i+=t[e]>>16&255,s+=t[e]>>8&255,a+=255&t[e];let h=((i/r|0)<<16)+((s/r|0)<<8)+(a/r|0);return 0===(h=this.setGamma(h,1.4))&&(h=1),this.averageTextureRGB[e]=h};static setBrightness=e=>{var i=e+.03*Math.random()-.015;let t=0;for(let e=0;e<512;e++){var h=(e/8|0)/64+.0078125,l=(7&e)/8+.0625;for(let e=0;e<128;e++){var n=e/128;let s=n,a=n,r=n;if(0!=l){let e;n=2*n-(e=n<.5?n*(1+l):n+l-n*l);let t=.3333333333333333+h,i=(1<t&&t--,h-.3333333333333333);i<0&&i++,s=6*t<1?n+6*(e-n)*t:2*t<1?e:3*t<2?n+(e-n)*(.6666666666666666-t)*6:n,a=6*h<1?n+6*(e-n)*h:2*h<1?e:3*h<2?n+(e-n)*(.6666666666666666-h)*6:n,r=6*i<1?n+6*(e-n)*i:2*i<1?e:3*i<2?n+(e-n)*(.6666666666666666-i)*6:n}var n=256*s|0,o=256*a|0,c=256*r|0;this.palette[t++]=this.setGamma((n<<16)+(o<<8)+c,i)}}for(let t=0;t<50;t++){var s=this.textures[t];if(s){var a=s.palette;this.texturePalette[t]=new Int32Array(a.length);for(let e=0;e<a.length;e++){var r=this.texturePalette[t];r&&(r[e]=this.setGamma(a[e],i))}}}for(let e=0;e<50;e++)this.pushTexture(e)};static setGamma=(e,t)=>((256*Math.pow((e>>16)/256,t)|0)<<16)+((256*Math.pow((e>>8&255)/256,t)|0)<<8)+(256*Math.pow((255&e)/256,t)|0);static initPool=e=>{this.texelPool||(this.poolSize=e,this.lowMemory?this.texelPool=new w(e,16384):this.texelPool=new w(e,65536),this.activeTexels.fill(null))};static fillGouraudTriangle=(e,t,i,s,a,r,h,l,n)=>{let o=0,c=0,d=(a!==s&&(o=(t-e<<16)/(a-s)|0,c=(l-h<<15)/(a-s)|0),0),u=0,f=(r!==a&&(d=(i-t<<16)/(r-a)|0,u=(n-l<<15)/(r-a)|0),0),p=0;if(r!==s&&(f=(e-i<<16)/(s-r)|0,p=(h-n<<15)/(s-r)|0),s<=a&&s<=r){if(s<D.bottom)if((a=a>D.bottom?D.bottom:a)<(r=r>D.bottom?D.bottom:r))if(i=e<<=16,n=h<<=15,s<0&&(i-=f*s,e-=o*s,n-=p*s,h-=c*s,s=0),t<<=16,l<<=15,a<0&&(t-=d*a,l-=u*a,a=0),s!==a&&f<o||s===a&&f>d)for(r-=a,a-=s,s=_.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawGouraudScanline(i>>16,t>>16,n>>7,l>>7,D.pixels,s,0),i+=f,t+=d,n+=p,l+=u,s+=D.width2d}this.drawGouraudScanline(i>>16,e>>16,n>>7,h>>7,D.pixels,s,0),i+=f,e+=o,n+=p,h+=c,s+=D.width2d}else for(r-=a,a-=s,s=_.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawGouraudScanline(t>>16,i>>16,l>>7,n>>7,D.pixels,s,0),i+=f,t+=d,n+=p,l+=u,s+=D.width2d}this.drawGouraudScanline(e>>16,i>>16,h>>7,n>>7,D.pixels,s,0),i+=f,e+=o,n+=p,h+=c,s+=D.width2d}else if(t=e<<=16,l=h<<=15,s<0&&(t-=f*s,e-=o*s,l-=p*s,h-=c*s,s=0),i<<=16,n<<=15,r<0&&(i-=d*r,n-=u*r,r=0),s!==r&&f<o||s===r&&d>o)for(a-=r,r-=s,s=_.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawGouraudScanline(i>>16,e>>16,n>>7,h>>7,D.pixels,s,0),i+=d,e+=o,n+=u,h+=c,s+=D.width2d}this.drawGouraudScanline(t>>16,e>>16,l>>7,h>>7,D.pixels,s,0),t+=f,e+=o,l+=p,h+=c,s+=D.width2d}else for(a-=r,r-=s,s=_.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawGouraudScanline(e>>16,i>>16,h>>7,n>>7,D.pixels,s,0),i+=d,e+=o,n+=u,h+=c,s+=D.width2d}this.drawGouraudScanline(e>>16,t>>16,h>>7,l>>7,D.pixels,s,0),t+=f,e+=o,l+=p,h+=c,s+=D.width2d}}else if(a<=r){if(a<D.bottom)if((r=r>D.bottom?D.bottom:r)<(s=s>D.bottom?D.bottom:s))if(e=t<<=16,h=l<<=15,a<0&&(e-=o*a,t-=d*a,h-=c*a,l-=u*a,a=0),i<<=16,n<<=15,r<0&&(i-=f*r,n-=p*r,r=0),a!==r&&o<d||a===r&&o>f)for(s-=r,r-=a,a=_.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawGouraudScanline(e>>16,i>>16,h>>7,n>>7,D.pixels,a,0),e+=o,i+=f,h+=c,n+=p,a+=D.width2d}this.drawGouraudScanline(e>>16,t>>16,h>>7,l>>7,D.pixels,a,0),e+=o,t+=d,h+=c,l+=u,a+=D.width2d}else for(s-=r,r-=a,a=_.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawGouraudScanline(i>>16,e>>16,n>>7,h>>7,D.pixels,a,0),e+=o,i+=f,h+=c,n+=p,a+=D.width2d}this.drawGouraudScanline(t>>16,e>>16,l>>7,h>>7,D.pixels,a,0),e+=o,t+=d,h+=c,l+=u,a+=D.width2d}else if(i=t<<=16,n=l<<=15,a<0&&(i-=o*a,t-=d*a,n-=c*a,l-=u*a,a=0),e<<=16,h<<=15,s<0&&(e-=f*s,h-=p*s,s=0),r-=s,s-=a,a=_.lineOffset[a],o<d)for(;;){if(--s<0)for(;;){if(--r<0)return;this.drawGouraudScanline(e>>16,t>>16,h>>7,l>>7,D.pixels,a,0),e+=f,t+=d,h+=p,l+=u,a+=D.width2d}this.drawGouraudScanline(i>>16,t>>16,n>>7,l>>7,D.pixels,a,0),i+=o,t+=d,n+=c,l+=u,a+=D.width2d}else for(;;){if(--s<0)for(;;){if(--r<0)return;this.drawGouraudScanline(t>>16,e>>16,l>>7,h>>7,D.pixels,a,0),e+=f,t+=d,h+=p,l+=u,a+=D.width2d}this.drawGouraudScanline(t>>16,i>>16,l>>7,n>>7,D.pixels,a,0),i+=o,t+=d,n+=c,l+=u,a+=D.width2d}}else if(r<D.bottom)if((s=s>D.bottom?D.bottom:s)<(a=a>D.bottom?D.bottom:a))if(t=i<<=16,l=n<<=15,r<0&&(t-=d*r,i-=f*r,l-=u*r,n-=p*r,r=0),e<<=16,h<<=15,s<0&&(e-=o*s,h-=c*s,s=0),a-=s,s-=r,r=_.lineOffset[r],d<f)for(;;){if(--s<0)for(;;){if(--a<0)return;this.drawGouraudScanline(t>>16,e>>16,l>>7,h>>7,D.pixels,r,0),t+=d,e+=o,l+=u,h+=c,r+=D.width2d}this.drawGouraudScanline(t>>16,i>>16,l>>7,n>>7,D.pixels,r,0),t+=d,i+=f,l+=u,n+=p,r+=D.width2d}else for(;;){if(--s<0)for(;;){if(--a<0)return;this.drawGouraudScanline(e>>16,t>>16,h>>7,l>>7,D.pixels,r,0),t+=d,e+=o,l+=u,h+=c,r+=D.width2d}this.drawGouraudScanline(i>>16,t>>16,n>>7,l>>7,D.pixels,r,0),t+=d,i+=f,l+=u,n+=p,r+=D.width2d}else if(e=i<<=16,h=n<<=15,r<0&&(e-=d*r,i-=f*r,h-=u*r,n-=p*r,r=0),t<<=16,l<<=15,a<0&&(t-=o*a,l-=c*a,a=0),s-=a,a-=r,r=_.lineOffset[r],d<f)for(;;){if(--a<0)for(;;){if(--s<0)return;this.drawGouraudScanline(t>>16,i>>16,l>>7,n>>7,D.pixels,r,0),t+=o,i+=f,l+=c,n+=p,r+=D.width2d}this.drawGouraudScanline(e>>16,i>>16,h>>7,n>>7,D.pixels,r,0),e+=d,i+=f,h+=u,n+=p,r+=D.width2d}else for(;;){if(--a<0)for(;;){if(--s<0)return;this.drawGouraudScanline(i>>16,t>>16,n>>7,l>>7,D.pixels,r,0),t+=o,i+=f,l+=c,n+=p,r+=D.width2d}this.drawGouraudScanline(i>>16,e>>16,n>>7,h>>7,D.pixels,r,0),e+=d,i+=f,h+=u,n+=p,r+=D.width2d}};static drawGouraudScanline=(t,i,s,a,r,h,l)=>{let n;if(_.jagged){let e;if(_.clipX){if(e=3<i-t?(a-s)/(i-t)|0:0,i>D.boundX&&(i=D.boundX),t<0&&(s-=t*e,t=0),i<=t)return;h+=t,l=i-t>>2,e<<=2}else{if(!(t<i))return;h+=t,l=i-t>>2,e=0<l?(a-s)*_.reciprocal15[l]>>15:0}if(0===_.alpha)for(;;){if(--l<0){if(0<(l=i-t&3)){for(n=_.palette[s>>8];r[h++]=n,0<--l;);return}break}n=_.palette[s>>8],s+=e,r[h++]=n,r[h++]=n,r[h++]=n,r[h++]=n}else for(var o=_.alpha,c=256-_.alpha;;){if(--l<0){if(0<(l=i-t&3))for(n=((16711935&(n=_.palette[s>>8]))*c>>8&16711935)+((65280&n)*c>>8&65280);r[h++]=n+((16711935&r[h])*o>>8&16711935)+((65280&r[h])*o>>8&65280),0<--l;);break}n=_.palette[s>>8],s+=e,n=((16711935&n)*c>>8&16711935)+((65280&n)*c>>8&65280),r[h++]=n+((16711935&r[h])*o>>8&16711935)+((65280&r[h])*o>>8&65280),r[h++]=n+((16711935&r[h])*o>>8&16711935)+((65280&r[h])*o>>8&65280),r[h++]=n+((16711935&r[h])*o>>8&16711935)+((65280&r[h])*o>>8&65280),r[h++]=n+((16711935&r[h])*o>>8&16711935)+((65280&r[h])*o>>8&65280)}}else if(t<i){var e=(a-s)/(i-t)|0;if(!(_.clipX&&(t<0&&(s-=t*e,t=0),(i=i>D.boundX?D.boundX:i)<=t)))if(h+=t,l=i-t,0===_.alpha)for(;r[h++]=_.palette[s>>8],s+=e,0<--l;);else for(var d=_.alpha,u=256-_.alpha;n=_.palette[s>>8],s+=e,n=((16711935&n)*u>>8&16711935)+((65280&n)*u>>8&65280),r[h++]=n+((16711935&r[h])*d>>8&16711935)+((65280&r[h])*d>>8&65280),0<--l;);}};static fillTriangle=(e,t,i,s,a,r,h)=>{let l=0,n=(a!==s&&(l=(t-e<<16)/(a-s)|0),0),o=(r!==a&&(n=(i-t<<16)/(r-a)|0),0);if(r!==s&&(o=(e-i<<16)/(s-r)|0),s<=a&&s<=r){if(s<D.bottom)if((a=a>D.bottom?D.bottom:a)<(r=r>D.bottom?D.bottom:r))if(i=e<<=16,s<0&&(i-=o*s,e-=l*s,s=0),t<<=16,a<0&&(t-=n*a,a=0),s!==a&&o<l||s===a&&o>n)for(r-=a,a-=s,s=this.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawScanline(i>>16,t>>16,D.pixels,s,h),i+=o,t+=n,s+=D.width2d}this.drawScanline(i>>16,e>>16,D.pixels,s,h),i+=o,e+=l,s+=D.width2d}else for(r-=a,a-=s,s=this.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawScanline(t>>16,i>>16,D.pixels,s,h),i+=o,t+=n,s+=D.width2d}this.drawScanline(e>>16,i>>16,D.pixels,s,h),i+=o,e+=l,s+=D.width2d}else if(t=e<<=16,s<0&&(t-=o*s,e-=l*s,s=0),i<<=16,r<0&&(i-=n*r,r=0),s!==r&&o<l||s===r&&n>l)for(a-=r,r-=s,s=this.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawScanline(i>>16,e>>16,D.pixels,s,h),i+=n,e+=l,s+=D.width2d}this.drawScanline(t>>16,e>>16,D.pixels,s,h),t+=o,e+=l,s+=D.width2d}else for(a-=r,r-=s,s=this.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawScanline(e>>16,i>>16,D.pixels,s,h),i+=n,e+=l,s+=D.width2d}this.drawScanline(e>>16,t>>16,D.pixels,s,h),t+=o,e+=l,s+=D.width2d}}else if(a<=r){if(a<D.bottom)if((r=r>D.bottom?D.bottom:r)<(s=s>D.bottom?D.bottom:s))if(e=t<<=16,a<0&&(e-=l*a,t-=n*a,a=0),i<<=16,r<0&&(i-=o*r,r=0),a!==r&&l<n||a===r&&l>o)for(s-=r,r-=a,a=this.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawScanline(e>>16,i>>16,D.pixels,a,h),e+=l,i+=o,a+=D.width2d}this.drawScanline(e>>16,t>>16,D.pixels,a,h),e+=l,t+=n,a+=D.width2d}else for(s-=r,r-=a,a=this.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawScanline(i>>16,e>>16,D.pixels,a,h),e+=l,i+=o,a+=D.width2d}this.drawScanline(t>>16,e>>16,D.pixels,a,h),e+=l,t+=n,a+=D.width2d}else if(i=t<<=16,a<0&&(i-=l*a,t-=n*a,a=0),e<<=16,s<0&&(e-=o*s,s=0),l<n)for(r-=s,s-=a,a=this.lineOffset[a];;){if(--s<0)for(;;){if(--r<0)return;this.drawScanline(e>>16,t>>16,D.pixels,a,h),e+=o,t+=n,a+=D.width2d}this.drawScanline(i>>16,t>>16,D.pixels,a,h),i+=l,t+=n,a+=D.width2d}else for(r-=s,s-=a,a=this.lineOffset[a];;){if(--s<0)for(;;){if(--r<0)return;this.drawScanline(t>>16,e>>16,D.pixels,a,h),e+=o,t+=n,a+=D.width2d}this.drawScanline(t>>16,i>>16,D.pixels,a,h),i+=l,t+=n,a+=D.width2d}}else if(r<D.bottom)if((s=s>D.bottom?D.bottom:s)<(a=a>D.bottom?D.bottom:a))if(t=i<<=16,r<0&&(t-=n*r,i-=o*r,r=0),e<<=16,s<0&&(e-=l*s,s=0),n<o)for(a-=s,s-=r,r=this.lineOffset[r];;){if(--s<0)for(;;){if(--a<0)return;this.drawScanline(t>>16,e>>16,D.pixels,r,h),t+=n,e+=l,r+=D.width2d}this.drawScanline(t>>16,i>>16,D.pixels,r,h),t+=n,i+=o,r+=D.width2d}else for(a-=s,s-=r,r=this.lineOffset[r];;){if(--s<0)for(;;){if(--a<0)return;this.drawScanline(e>>16,t>>16,D.pixels,r,h),t+=n,e+=l,r+=D.width2d}this.drawScanline(i>>16,t>>16,D.pixels,r,h),t+=n,i+=o,r+=D.width2d}else if(e=i<<=16,r<0&&(e-=n*r,i-=o*r,r=0),t<<=16,a<0&&(t-=l*a,a=0),n<o)for(s-=a,a-=r,r=this.lineOffset[r];;){if(--a<0)for(;;){if(--s<0)return;this.drawScanline(t>>16,i>>16,D.pixels,r,h),t+=l,i+=o,r+=D.width2d}this.drawScanline(e>>16,i>>16,D.pixels,r,h),e+=n,i+=o,r+=D.width2d}else for(s-=a,a-=r,r=this.lineOffset[r];;){if(--a<0)for(;;){if(--s<0)return;this.drawScanline(i>>16,t>>16,D.pixels,r,h),t+=l,i+=o,r+=D.width2d}this.drawScanline(i>>16,e>>16,D.pixels,r,h),e+=n,i+=o,r+=D.width2d}};static fillTexturedTriangle=(e,t,i,s,a,r,h,l,n,o,c,d,u,f,p,m,g,C,y)=>{var v=this.getTexels(y),y=(this.opaque=!this.textureTranslucent[y],o-u),u=c-p,p=d-g,g=f-o,f=m-c,m=C-d;let w=g*c-f*o<<14;var T=f*d-m*c<<8,S=m*o-g*d<<5;let A=y*c-u*o<<14;var O=u*d-p*c<<8,I=p*o-y*d<<5;let L=u*g-y*f<<14;var b=p*f-u*m<<8,E=y*m-p*g<<5;let x=0,_=0,R=(a!==s&&(x=(t-e<<16)/(a-s)|0,_=(l-h<<16)/(a-s)|0),0),k=0,P=(r!==a&&(R=(i-t<<16)/(r-a)|0,k=(n-l<<16)/(r-a)|0),0),B=0;if(r!==s&&(P=(e-i<<16)/(s-r)|0,B=(h-n<<16)/(s-r)|0),s<=a&&s<=r){if(s<D.bottom)if((a=a>D.bottom?D.bottom:a)<(r=r>D.bottom?D.bottom:r)){i=e<<=16,n=h<<=16,s<0&&(i-=P*s,e-=x*s,n-=B*s,h-=_*s,s=0),t<<=16,l<<=16,a<0&&(t-=R*a,l-=k*a,a=0);C=s-this.centerY;if(w+=S*C,A+=I*C,L+=E*C,w|=0,A|=0,L|=0,s!==a&&P<x||s===a&&P>R)for(r-=a,a-=s,s=this.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawTexturedScanline(i>>16,t>>16,D.pixels,s,v,0,0,w,A,L,T,O,b,n>>8,l>>8),i+=P,t+=R,n+=B,l+=k,s+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(i>>16,e>>16,D.pixels,s,v,0,0,w,A,L,T,O,b,n>>8,h>>8),i+=P,e+=x,n+=B,h+=_,s+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}else for(r-=a,a-=s,s=this.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawTexturedScanline(t>>16,i>>16,D.pixels,s,v,0,0,w,A,L,T,O,b,l>>8,n>>8),i+=P,t+=R,n+=B,l+=k,s+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(e>>16,i>>16,D.pixels,s,v,0,0,w,A,L,T,O,b,h>>8,n>>8),i+=P,e+=x,n+=B,h+=_,s+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}}else{t=e<<=16,l=h<<=16,s<0&&(t-=P*s,e-=x*s,l-=B*s,h-=_*s,s=0),i<<=16,n<<=16,r<0&&(i-=R*r,n-=k*r,r=0);c=s-this.centerY;if(w+=S*c,A+=I*c,L+=E*c,w|=0,A|=0,L|=0,(s===r||P>=x)&&(s!==r||R<=x))for(a-=r,r-=s,s=this.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawTexturedScanline(e>>16,i>>16,D.pixels,s,v,0,0,w,A,L,T,O,b,h>>8,n>>8),i+=R,e+=x,n+=k,h+=_,s+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(e>>16,t>>16,D.pixels,s,v,0,0,w,A,L,T,O,b,h>>8,l>>8),t+=P,e+=x,l+=B,h+=_,s+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}else for(a-=r,r-=s,s=this.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawTexturedScanline(i>>16,e>>16,D.pixels,s,v,0,0,w,A,L,T,O,b,n>>8,h>>8),i+=R,e+=x,n+=k,h+=_,s+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(t>>16,e>>16,D.pixels,s,v,0,0,w,A,L,T,O,b,l>>8,h>>8),t+=P,e+=x,l+=B,h+=_,s+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}}}else if(a<=r){if(a<D.bottom)if((r=r>D.bottom?D.bottom:r)<(s=s>D.bottom?D.bottom:s)){e=t<<=16,h=l<<=16,a<0&&(e-=x*a,t-=R*a,h-=_*a,l-=k*a,a=0),i<<=16,n<<=16,r<0&&(i-=P*r,n-=B*r,r=0);o=a-this.centerY;if(w+=S*o,A+=I*o,L+=E*o,w|=0,A|=0,L|=0,a!==r&&x<R||a===r&&x>P)for(s-=r,r-=a,a=this.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawTexturedScanline(e>>16,i>>16,D.pixels,a,v,0,0,w,A,L,T,O,b,h>>8,n>>8),e+=x,i+=P,h+=_,n+=B,a+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(e>>16,t>>16,D.pixels,a,v,0,0,w,A,L,T,O,b,h>>8,l>>8),e+=x,t+=R,h+=_,l+=k,a+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}else for(s-=r,r-=a,a=this.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawTexturedScanline(i>>16,e>>16,D.pixels,a,v,0,0,w,A,L,T,O,b,n>>8,h>>8),e+=x,i+=P,h+=_,n+=B,a+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(t>>16,e>>16,D.pixels,a,v,0,0,w,A,L,T,O,b,l>>8,h>>8),e+=x,t+=R,h+=_,l+=k,a+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}}else{i=t<<=16,n=l<<=16,a<0&&(i-=x*a,t-=R*a,n-=_*a,l-=k*a,a=0),e<<=16,h<<=16,s<0&&(e-=P*s,h-=B*s,s=0);d=a-this.centerY;if(w+=S*d,A+=I*d,L+=E*d,w|=0,A|=0,L|=0,r-=s,s-=a,a=this.lineOffset[a],x<R)for(;;){if(--s<0)for(;;){if(--r<0)return;this.drawTexturedScanline(e>>16,t>>16,D.pixels,a,v,0,0,w,A,L,T,O,b,h>>8,l>>8),e+=P,t+=R,h+=B,l+=k,a+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(i>>16,t>>16,D.pixels,a,v,0,0,w,A,L,T,O,b,n>>8,l>>8),i+=x,t+=R,n+=_,l+=k,a+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}else for(;;){if(--s<0)for(;;){if(--r<0)return;this.drawTexturedScanline(t>>16,e>>16,D.pixels,a,v,0,0,w,A,L,T,O,b,l>>8,h>>8),e+=P,t+=R,h+=B,l+=k,a+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(t>>16,i>>16,D.pixels,a,v,0,0,w,A,L,T,O,b,l>>8,n>>8),i+=x,t+=R,n+=_,l+=k,a+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}}}else if(r<D.bottom)if((s=s>D.bottom?D.bottom:s)<(a=a>D.bottom?D.bottom:a)){t=i<<=16,l=n<<=16,r<0&&(t-=R*r,i-=P*r,l-=k*r,n-=B*r,r=0),e<<=16,h<<=16,s<0&&(e-=x*s,h-=_*s,s=0);f=r-this.centerY;if(w+=S*f,A+=I*f,L+=E*f,w|=0,A|=0,L|=0,a-=s,s-=r,r=this.lineOffset[r],R<P)for(;;){if(--s<0)for(;;){if(--a<0)return;this.drawTexturedScanline(t>>16,e>>16,D.pixels,r,v,0,0,w,A,L,T,O,b,l>>8,h>>8),t+=R,e+=x,l+=k,h+=_,r+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(t>>16,i>>16,D.pixels,r,v,0,0,w,A,L,T,O,b,l>>8,n>>8),t+=R,i+=P,l+=k,n+=B,r+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}else for(;;){if(--s<0)for(;;){if(--a<0)return;this.drawTexturedScanline(e>>16,t>>16,D.pixels,r,v,0,0,w,A,L,T,O,b,h>>8,l>>8),t+=R,e+=x,l+=k,h+=_,r+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(i>>16,t>>16,D.pixels,r,v,0,0,w,A,L,T,O,b,n>>8,l>>8),t+=R,i+=P,l+=k,n+=B,r+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}}else{e=i<<=16,h=n<<=16,r<0&&(e-=R*r,i-=P*r,h-=k*r,n-=B*r,r=0),t<<=16,l<<=16,a<0&&(t-=x*a,l-=_*a,a=0);u=r-this.centerY;if(w+=S*u,A+=I*u,L+=E*u,w|=0,A|=0,L|=0,s-=a,a-=r,r=this.lineOffset[r],R<P)for(;;){if(--a<0)for(;;){if(--s<0)return;this.drawTexturedScanline(t>>16,i>>16,D.pixels,r,v,0,0,w,A,L,T,O,b,l>>8,n>>8),t+=x,i+=P,l+=_,n+=B,r+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(e>>16,i>>16,D.pixels,r,v,0,0,w,A,L,T,O,b,h>>8,n>>8),e+=R,i+=P,h+=k,n+=B,r+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}else for(;;){if(--a<0)for(;;){if(--s<0)return;this.drawTexturedScanline(i>>16,t>>16,D.pixels,r,v,0,0,w,A,L,T,O,b,n>>8,l>>8),t+=x,i+=P,l+=_,n+=B,r+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}this.drawTexturedScanline(i>>16,e>>16,D.pixels,r,v,0,0,w,A,L,T,O,b,n>>8,h>>8),e+=R,i+=P,h+=k,n+=B,r+=D.width2d,w+=S,A+=I,L+=E,w|=0,A|=0,L|=0}}};static drawTexturedScanline=(o,c,d,u,f,p,m,g,C,y,v,w,T,S,A)=>{if(!(c<=o)){let e,t;if(this.clipX){if(e=(A-S)/(c-o)|0,c>D.boundX&&(c=D.boundX),o<0&&(S-=o*e,o=0),c<=o)return;t=c-o>>3,e<<=12}else e=7<c-o?(t=c-o>>3,(A-S)*this.reciprocal15[t]>>6):t=0;S<<=9,u+=o;let i,s,a,r,h,l,n;if(this.lowMemory&&f)if(i=0,s=0,g=g+(v>>3)*(r=o-this.centerX)|0,C=C+(w>>3)*r|0,y=y+(T>>3)*r|0,0!==(a=y>>12)&&(p=g/a|0,m=C/a|0,p<0?p=0:4032<p&&(p=4032)),g=g+v|0,C=C+w|0,y=y+T|0,0!==(a=y>>12)&&(i=g/a|0,s=C/a|0,i<7?i=7:4032<i&&(i=4032)),h=i-p>>3,l=s-m>>3,p+=S>>3&786432,n=S>>23,this.opaque){for(;0<t--;)d[u++]=f[(4032&m)+(p>>6)]>>>n,p+=h,m+=l,d[u++]=f[(4032&m)+(p>>6)]>>>n,p+=h,m+=l,d[u++]=f[(4032&m)+(p>>6)]>>>n,p+=h,m+=l,d[u++]=f[(4032&m)+(p>>6)]>>>n,p+=h,m+=l,d[u++]=f[(4032&m)+(p>>6)]>>>n,p+=h,m+=l,d[u++]=f[(4032&m)+(p>>6)]>>>n,p+=h,m+=l,d[u++]=f[(4032&m)+(p>>6)]>>>n,p+=h,m+=l,d[u++]=f[(4032&m)+(p>>6)]>>>n,p=i,m=s,g+=v,C+=w,y+=T,0!==(a=y>>12)&&(i=g/a|0,s=C/a|0,i<7?i=7:4032<i&&(i=4032)),h=i-p>>3,l=s-m>>3,p+=(S+=e)>>3&786432,n=S>>23;for(t=c-o&7;0<t--;)d[u++]=f[(4032&m)+(p>>6)]>>>n,p+=h,m+=l}else{for(;0<t--;){var O;0!=(O=f[(4032&m)+(p>>6)]>>>n)&&(d[u]=O),u+=1,p+=h,0!=(O=f[(4032&(m+=l))+(p>>6)]>>>n)&&(d[u]=O),u++,p+=h,0!=(O=f[(4032&(m+=l))+(p>>6)]>>>n)&&(d[u]=O),u++,p+=h,0!=(O=f[(4032&(m+=l))+(p>>6)]>>>n)&&(d[u]=O),u++,p+=h,0!=(O=f[(4032&(m+=l))+(p>>6)]>>>n)&&(d[u]=O),u++,p+=h,0!=(O=f[(4032&(m+=l))+(p>>6)]>>>n)&&(d[u]=O),u++,p+=h,0!=(O=f[(4032&(m+=l))+(p>>6)]>>>n)&&(d[u]=O),u++,p+=h,0!=(O=f[(4032&(m+=l))+(p>>6)]>>>n)&&(d[u]=O),u+=1,p=i,m=s,g=g+v|0,C=C+w|0,y=y+T|0,0!==(a=y>>12)&&(i=g/a|0,s=C/a|0,i<7?i=7:4032<i&&(i=4032)),h=i-p>>3,l=s-m>>3,p+=(S+=e)>>3&786432,n=S>>23}for(t=c-o&7;0<t--;){var I;0!=(I=f[(4032&m)+(p>>6)]>>>n)&&(d[u]=I),u++,p+=h,m+=l}}else if(i=0,s=0,g=g+(v>>3)*(r=o-this.centerX)|0,C=C+(w>>3)*r|0,y=y+(T>>3)*r|0,0!==(a=y>>14)&&(p=g/a|0,m=C/a|0,p<0?p=0:16256<p&&(p=16256)),g=g+v|0,C=C+w|0,y=y+T|0,0!==(a=y>>14)&&(i=g/a|0,s=C/a|0,i<7?i=7:16256<i&&(i=16256)),h=i-p>>3,l=s-m>>3,p+=6291456&S,n=S>>23,this.opaque&&f){for(;0<t--;)d[u++]=f[(16256&m)+(p>>7)]>>>n,p+=h,m+=l,d[u++]=f[(16256&m)+(p>>7)]>>>n,p+=h,m+=l,d[u++]=f[(16256&m)+(p>>7)]>>>n,p+=h,m+=l,d[u++]=f[(16256&m)+(p>>7)]>>>n,p+=h,m+=l,d[u++]=f[(16256&m)+(p>>7)]>>>n,p+=h,m+=l,d[u++]=f[(16256&m)+(p>>7)]>>>n,p+=h,m+=l,d[u++]=f[(16256&m)+(p>>7)]>>>n,p+=h,m+=l,d[u++]=f[(16256&m)+(p>>7)]>>>n,p=i,m=s,g=g+v|0,C=C+w|0,y=y+T|0,0!==(a=y>>14)&&(i=g/a|0,s=C/a|0,i<7?i=7:16256<i&&(i=16256)),h=i-p>>3,l=s-m>>3,p+=6291456&(S+=e),n=S>>23;for(t=c-o&7;0<t--;)d[u++]=f[(16256&m)+(p>>7)]>>>n,p+=h,m+=l}else{for(;0<t--&&f;){var L;0!=(L=f[(16256&m)+(p>>7)]>>>n)&&(d[u]=L),u+=1,p+=h,0!=(L=f[(16256&(m+=l))+(p>>7)]>>>n)&&(d[u]=L),u++,p+=h,0!=(L=f[(16256&(m+=l))+(p>>7)]>>>n)&&(d[u]=L),u++,p+=h,0!=(L=f[(16256&(m+=l))+(p>>7)]>>>n)&&(d[u]=L),u++,p+=h,0!=(L=f[(16256&(m+=l))+(p>>7)]>>>n)&&(d[u]=L),u++,p+=h,0!=(L=f[(16256&(m+=l))+(p>>7)]>>>n)&&(d[u]=L),u++,p+=h,0!=(L=f[(16256&(m+=l))+(p>>7)]>>>n)&&(d[u]=L),u++,p+=h,0!=(L=f[(16256&(m+=l))+(p>>7)]>>>n)&&(d[u]=L),u++,p=i,m=s,g=g+v|0,C=C+w|0,y=y+T|0,0!==(a=y>>14)&&(i=g/a|0,s=C/a|0,i<7?i=7:16256<i&&(i=16256)),h=i-p>>3,l=s-m>>3,p+=6291456&(S+=e),n=S>>23}for(t=c-o&7;0<t--&&f;){var b;0!=(b=f[(16256&m)+(p>>7)]>>>n)&&(d[u]=b),u++,p+=h,m+=l}}}};static drawScanline=(t,i,s,a,r)=>{if(this.clipX&&(i>D.boundX&&(i=D.boundX),t<0)&&(t=0),!(i<=t)){a+=t;let e=i-t>>2;if(0===this.alpha)for(;;){if(--e<0)for(e=i-t&3;;){if(--e<0)return;s[a++]=r}s[a++]=r,s[a++]=r,s[a++]=r,s[a++]=r}var h=this.alpha,l=256-this.alpha;for(r=((16711935&r)*l>>8&16711935)+((65280&r)*l>>8&65280);;){if(--e<0)for(e=i-t&3;;){if(--e<0)return;s[a++]=r+((16711935&s[a])*h>>8&16711935)+((65280&s[a])*h>>8&65280)}s[a++]=r+((16711935&s[a])*h>>8&16711935)+((65280&s[a])*h>>8&65280),s[a++]=r+((16711935&s[a])*h>>8&16711935)+((65280&s[a])*h>>8&65280),s[a++]=r+((16711935&s[a])*h>>8&16711935)+((65280&s[a])*h>>8&65280),s[a++]=r+((16711935&s[a])*h>>8&16711935)+((65280&s[a])*h>>8&65280)}}};static pushTexture=e=>{this.activeTexels[e]&&this.texelPool&&(this.texelPool[this.poolSize++]=this.activeTexels[e],this.activeTexels[e]=null)};static getTexels=t=>{if(this.textureCycle[t]=this.cycle++,this.activeTexels[t])return this.activeTexels[t];let s;if(0<this.poolSize&&this.texelPool)s=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let t=0,i=-1;for(let e=0;e<this.textureCount;e++)this.activeTexels[e]&&(this.textureCycle[e]<t||-1===i)&&(t=this.textureCycle[e],i=e);s=this.activeTexels[i],this.activeTexels[i]=null}this.activeTexels[t]=s;var i=this.textures[t],a=this.texturePalette[t];if(!s||!i||!a)return null;if(this.lowMemory){this.textureTranslucent[t]=!1;for(let e=0;e<4096;e++){var r=s[e]=16316671&a[i.pixels[e]];0==r&&(this.textureTranslucent[t]=!0),s[e+4096]=r-(r>>>3)&16316671,s[e+8192]=r-(r>>>2)&16316671,s[e+12288]=r-(r>>>2)-(r>>>3)&16316671}}else{if(64===i.width)for(let t=0;t<128;t++)for(let e=0;e<128;e++)s[e+(t<<7|0)]=a[i.pixels[(e>>1)+(t>>1<<6|0)]];else for(let e=0;e<16384;e++)s[e]=a[i.pixels[e]];this.textureTranslucent[t]=!1;for(let e=0;e<16384;e++){s[e]&=16316671;var h=s[e];0===h&&(this.textureTranslucent[t]=!0),s[e+16384]=h-(h>>>3)&16316671,s[e+32768]=h-(h>>>2)&16316671,s[e+49152]=h-(h>>>2)-(h>>>3)&16316671}}return s}}class E{image;width;height;ctx;paint;pixels;constructor(e,t,i=a){this.ctx=i,this.image=this.ctx.getImageData(0,0,e,t),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(e*t),this.width=e,this.height=t,this.bind()}clear(){this.pixels.fill(0)}bind(){D.bind(this.pixels,this.width,this.height)}draw(e,t){this.#setPixels(),this.ctx.putImageData(this.image,e,t)}#setPixels(){var t=this.pixels.length,i=this.pixels,s=this.paint;for(let e=0;e<t;e++){var a=i[e];s[e]=a>>16&255|(a>>8&255)<<8|(255&a)<<16|4278190080}}}var T=["F11","F12"],e=new Map;e.set("ArrowLeft",{code:37,ch:1}),e.set("ArrowRight",{code:39,ch:2}),e.set("ArrowUp",{code:38,ch:3}),e.set("ArrowDown",{code:40,ch:4}),e.set("Control",{code:17,ch:5}),e.set("Shift",{code:16,ch:6}),e.set("Alt",{code:18,ch:7}),e.set("Backspace",{code:8,ch:8}),e.set("Tab",{code:9,ch:9}),e.set("Enter",{code:10,ch:10}),e.set("Escape",{code:27,ch:27}),e.set(" ",{code:32,ch:32}),e.set("Delete",{code:127,ch:127}),e.set("Home",{code:36,ch:1e3}),e.set("End",{code:35,ch:1001}),e.set("PageUp",{code:33,ch:1002}),e.set("PageDown",{code:34,ch:1003}),e.set("F1",{code:112,ch:1008}),e.set("F2",{code:113,ch:1009}),e.set("F3",{code:114,ch:1010}),e.set("F4",{code:115,ch:1011}),e.set("F5",{code:116,ch:1012}),e.set("F6",{code:117,ch:1013}),e.set("F7",{code:118,ch:1014}),e.set("F8",{code:119,ch:1015}),e.set("F9",{code:120,ch:1016}),e.set("F10",{code:121,ch:1017}),e.set("F11",{code:122,ch:1018}),e.set("F12",{code:123,ch:1019}),e.set("CapsLock",{code:20,ch:65535}),e.set("Meta",{code:524,ch:65535}),e.set("Insert",{code:155,ch:65535}),e.set("`",{code:192,ch:96}),e.set("~",{code:192,ch:126}),e.set("!",{code:49,ch:33}),e.set("@",{code:50,ch:64}),e.set("#",{code:51,ch:35}),e.set("$",{code:52,ch:36}),e.set("%",{code:53,ch:37}),e.set("^",{code:54,ch:94}),e.set("&",{code:55,ch:38}),e.set("*",{code:56,ch:42}),e.set("(",{code:57,ch:40}),e.set(")",{code:48,ch:41}),e.set("-",{code:45,ch:45}),e.set("_",{code:45,ch:95}),e.set("=",{code:61,ch:61}),e.set("+",{code:61,ch:43}),e.set("[",{code:91,ch:91}),e.set("{",{code:91,ch:123}),e.set("]",{code:93,ch:93}),e.set("}",{code:93,ch:125}),e.set("\\",{code:92,ch:92}),e.set("|",{code:92,ch:124}),e.set(";",{code:59,ch:59}),e.set(":",{code:59,ch:58}),e.set("'",{code:222,ch:39}),e.set('"',{code:222,ch:34}),e.set(",",{code:44,ch:44}),e.set("<",{code:44,ch:60}),e.set(".",{code:46,ch:46}),e.set(">",{code:46,ch:62}),e.set("/",{code:47,ch:47}),e.set("?",{code:47,ch:63}),e.set("0",{code:48,ch:48}),e.set("1",{code:49,ch:49}),e.set("2",{code:50,ch:50}),e.set("3",{code:51,ch:51}),e.set("4",{code:52,ch:52}),e.set("5",{code:53,ch:53}),e.set("6",{code:54,ch:54}),e.set("7",{code:55,ch:55}),e.set("8",{code:56,ch:56}),e.set("9",{code:57,ch:57}),e.set("a",{code:65,ch:97}),e.set("b",{code:66,ch:98}),e.set("c",{code:67,ch:99}),e.set("d",{code:68,ch:100}),e.set("e",{code:69,ch:101}),e.set("f",{code:70,ch:102}),e.set("g",{code:71,ch:103}),e.set("h",{code:72,ch:104}),e.set("i",{code:73,ch:105}),e.set("j",{code:74,ch:106}),e.set("k",{code:75,ch:107}),e.set("l",{code:76,ch:108}),e.set("m",{code:77,ch:109}),e.set("n",{code:78,ch:110}),e.set("o",{code:79,ch:111}),e.set("p",{code:80,ch:112}),e.set("q",{code:81,ch:113}),e.set("r",{code:82,ch:114}),e.set("s",{code:83,ch:115}),e.set("t",{code:84,ch:116}),e.set("u",{code:85,ch:117}),e.set("v",{code:86,ch:118}),e.set("w",{code:87,ch:119}),e.set("x",{code:88,ch:120}),e.set("y",{code:89,ch:121}),e.set("z",{code:90,ch:122}),e.set("A",{code:65,ch:65}),e.set("B",{code:66,ch:66}),e.set("C",{code:67,ch:67}),e.set("D",{code:68,ch:68}),e.set("E",{code:69,ch:69}),e.set("F",{code:70,ch:70}),e.set("G",{code:71,ch:71}),e.set("H",{code:72,ch:72}),e.set("I",{code:73,ch:73}),e.set("J",{code:74,ch:74}),e.set("K",{code:75,ch:75}),e.set("L",{code:76,ch:76}),e.set("M",{code:77,ch:77}),e.set("N",{code:78,ch:78}),e.set("O",{code:79,ch:79}),e.set("P",{code:80,ch:80}),e.set("Q",{code:81,ch:81}),e.set("R",{code:82,ch:82}),e.set("S",{code:83,ch:83}),e.set("T",{code:84,ch:84}),e.set("U",{code:85,ch:85}),e.set("V",{code:86,ch:86}),e.set("W",{code:87,ch:87}),e.set("X",{code:88,ch:88}),e.set("Y",{code:89,ch:89}),e.set("Z",{code:90,ch:90});class nt{static enabled=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled=()=>{this.outBuffer=ht.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.enabled=!0};static setDisabled=()=>{this.enabled=!1,this.outBuffer=null};static flush=()=>{let e=null;return this.oldBuffer&&this.enabled&&(e=this.oldBuffer),this.oldBuffer=null,e};static stop=()=>{let e=null;return this.outBuffer&&0<this.outBuffer.pos&&this.enabled&&(e=this.outBuffer),this.setDisabled(),e};static mousePressed=(t,i,s)=>{if(this.enabled&&0<=t&&t<789&&0<=i&&i<532){this.trackedCount++;var a=performance.now();let e=(a-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=a,this.ensureCapacity(5),1===s?this.outBuffer?.p1(1):this.outBuffer?.p1(2),this.outBuffer?.p1(e),this.outBuffer?.p3(t+(i<<10))}};static mouseReleased=t=>{if(this.enabled){this.trackedCount++;var i=performance.now();let e=(i-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=i,this.ensureCapacity(2),1===t?this.outBuffer?.p1(3):this.outBuffer?.p1(4),this.outBuffer?.p1(e)}};static mouseMoved=(t,i)=>{if(this.enabled&&0<=t&&t<789&&0<=i&&i<532){var s=performance.now();if(50<=s-this.lastMoveTime){this.lastMoveTime=s,this.trackedCount++;let e=(s-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=s,t-this.lastX<8&&-8<=t-this.lastX&&i-this.lastY<8&&-8<=i-this.lastY?(this.ensureCapacity(3),this.outBuffer?.p1(5),this.outBuffer?.p1(e),this.outBuffer?.p1(t+(i-this.lastY+8<<4)+8-this.lastX)):t-this.lastX<128&&-128<=t-this.lastX&&i-this.lastY<128&&-128<=i-this.lastY?(this.ensureCapacity(4),this.outBuffer?.p1(6),this.outBuffer?.p1(e),this.outBuffer?.p1(t+128-this.lastX),this.outBuffer?.p1(i+128-this.lastY)):(this.ensureCapacity(5),this.outBuffer?.p1(7),this.outBuffer?.p1(e),this.outBuffer?.p3(t+(i<<10))),this.lastX=t,this.lastY=i}}};static keyPressed=t=>{if(this.enabled){this.trackedCount++;var i=performance.now();let e=(i-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=i,1e3===t?t=11:1001===t?t=12:1002===t?t=14:1003===t?t=15:1008<=t&&(t-=992),this.ensureCapacity(3),this.outBuffer?.p1(8),this.outBuffer?.p1(e),this.outBuffer?.p1(t)}};static keyReleased=t=>{if(this.enabled){this.trackedCount++;var i=performance.now();let e=(i-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=i,1e3===t?t=11:1001===t?t=12:1002===t?t=14:1003===t?t=15:1008<=t&&(t-=992),this.ensureCapacity(3),this.outBuffer?.p1(9),this.outBuffer?.p1(e),this.outBuffer?.p1(t)}};static focusGained=()=>{if(this.enabled){this.trackedCount++;var t=performance.now();let e=(t-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=t,this.ensureCapacity(2),this.outBuffer?.p1(10),this.outBuffer?.p1(e)}};static focusLost=()=>{if(this.enabled){this.trackedCount++;var t=performance.now();let e=(t-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=t,this.ensureCapacity(2),this.outBuffer?.p1(11),this.outBuffer?.p1(e)}};static mouseEntered=()=>{if(this.enabled){this.trackedCount++;var t=performance.now();let e=(t-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=t,this.ensureCapacity(2),this.outBuffer?.p1(12),this.outBuffer?.p1(e)}};static mouseExited=()=>{if(this.enabled){this.trackedCount++;var t=performance.now();let e=(t-this.lastTime)/10|0;250<e&&(e=250),this.lastTime=t,this.ensureCapacity(2),this.outBuffer?.p1(13),this.outBuffer?.p1(e)}};static ensureCapacity=e=>{this.outBuffer&&500<=this.outBuffer.pos+e&&(e=this.outBuffer,this.outBuffer=ht.alloc(1),this.oldBuffer=e)}}class I{id;debugname=null;constructor(e){this.id=e}decodeType(e){for(;;){var t=e.g1;if(0===t)break;this.decode(t,e)}return this}}class x extends I{static count=0;static instances=[];static unpack=e=>{var t=new ht(e.read("flo.dat"));this.count=t.g2;for(let e=0;e<this.count;e++)this.instances[e]=new x(e).decodeType(t)};static hsl24to16=(e,t,i)=>(179<i&&(t=t/2|0),192<i&&(t=t/2|0),217<i&&(t=t/2|0),((e/4|0)<<10)+(((t=243<i?t/2|0:t)/32|0)<<7)+(i/2|0));static mulHSL=(e,t)=>-1===e?12345678:((t=t*(127&e)/128|0)<2?t=2:126<t&&(t=126),(65408&e)+t);static adjustLightness=(e,t)=>-2===e?12345678:-1===e?(t<0?t=0:127<t&&(t=127),127-t):((t=t*(127&e)/128|0)<2?t=2:126<t&&(t=126),(65408&e)+t);rgb=0;texture=-1;opcode3=!1;occlude=!0;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;decode(e,t){1===e?(this.rgb=t.g3,this.setColor(this.rgb)):2===e?this.texture=t.g1:3===e?this.opcode3=!0:5===e?this.occlude=!1:6===e&&(this.debugname=t.gjstr)}setColor(e){var t=(e>>16&255)/256,i=(e>>8&255)/256,e=(255&e)/256;let s=i<t?i:t,a=(e<s&&(s=e),t<i?i:t),r=(e>a&&(a=e),0),h=0;var l=(s+a)/2;s!==a&&(l<.5&&(h=(a-s)/(a+s)),.5<=l&&(h=(a-s)/(2-a-s)),t===a?r=(i-e)/(a-s):i===a?r=(e-t)/(a-s)+2:e===a&&(r=(t-i)/(a-s)+4)),r/=6,this.hue=256*r|0,this.saturation=256*h|0,this.lightness=256*l|0,this.saturation<0?this.saturation=0:255<this.saturation&&(this.saturation=255),this.lightness<0?this.lightness=0:255<this.lightness&&(this.lightness=255),this.luminance=.5<l?(1-l)*h*512|0:l*h*512|0,this.luminance<1&&(this.luminance=1),this.chroma=r*this.luminance|0;let n=this.hue+(16*Math.random()|0)-8,o=(n<0?n=0:255<n&&(n=255),this.saturation+(48*Math.random()|0)-24),c=(o<0?o=0:255<o&&(o=255),this.lightness+(48*Math.random()|0)-24);c<0?c=0:255<c&&(c=255),this.hsl=x.hsl24to16(n,o,c)}}class z{static instances=[];static unpack=e=>{var t=new ht(e.read("base_head.dat")),i=new ht(e.read("base_type.dat")),s=new ht(e.read("base_label.dat")),a=t.g2;t.pos+=2;for(let e=0;e<a;e++){var r=t.g2,h=t.g1,l=new Uint8Array(h),n=new lt(h,null);for(let e=0;e<h;e++){l[e]=i.g1;var o=s.g1,c=new Uint8Array(o);for(let e=0;e<o;e++)c[e]=s.g1;n[e]=c}this.instances[r]=new z,this.instances[r].length=h,this.instances[r].types=l,this.instances[r].labels=n}};length=0;types=null;labels=null}class G{static instances=[];static unpack=e=>{var t=new ht(e.read("frame_head.dat")),a=new ht(e.read("frame_tran1.dat")),r=new ht(e.read("frame_tran2.dat")),h=new ht(e.read("frame_del.dat")),i=t.g2,l=(t.pos+=2,new Int32Array(500)),n=new Int32Array(500),o=new Int32Array(500),c=new Int32Array(500);for(let e=0;e<i;e++){var d=t.g2,u=this.instances[d]=new G,d=(u.delay=h.g1,t.g2),f=z.instances[d],p=(u.base=f,t.g1);let i=-1,s=0;for(let t=0;t<p;t++){if(!f.types)throw Error("SeqBase not loaded!!!");var m=a.g1;if(0<m){if(0!==f.types[t])for(let e=t-1;e>i;e--)if(0===f.types[e]){l[s]=e,n[s]=0,o[s]=0,c[s]=0,s++;break}l[s]=t;let e=0;3===f.types[l[s]]&&(e=128),n[s]=0==(1&m)?e:r.gsmart,o[s]=0==(2&m)?e:r.gsmart,c[s]=0==(4&m)?e:r.gsmart,i=t,s++}}u.length=s,u.bases=new Int32Array(s),u.x=new Int32Array(s),u.y=new Int32Array(s),u.z=new Int32Array(s);for(let e=0;e<s;e++)u.bases[e]=l[e],u.x[e]=n[e],u.y[e]=o[e],u.z[e]=c[e]}};delay=0;base=null;length=0;bases=null;x=null;y=null;z=null}class R extends I{static count=0;static instances=[];static unpack=e=>{var t=new ht(e.read("seq.dat"));this.count=t.g2;for(let e=0;e<this.count;e++){var i=new R(e).decodeType(t);0===i.frameCount&&(i.frameCount=1,i.frames=new Int16Array(1),i.frames[0]=-1,i.iframes=new Int16Array(1),i.iframes[0]=-1,i.delay=new Int16Array(1),i.delay[0]=-1),this.instances[e]=i}};frameCount=0;frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=!1;priority=5;righthand=-1;lefthand=-1;replaycount=99;duration=0;decode(e,t){if(1===e){this.frameCount=t.g1,this.frames=new Int16Array(this.frameCount),this.iframes=new Int16Array(this.frameCount),this.delay=new Int16Array(this.frameCount);for(let e=0;e<this.frameCount;e++)this.frames[e]=t.g2,this.iframes[e]=t.g2,65535===this.iframes[e]&&(this.iframes[e]=-1),this.delay[e]=t.g2,0===this.delay[e]&&(this.delay[e]=G.instances[this.frames[e]].delay),0===this.delay[e]&&(this.delay[e]=1),this.duration+=this.delay[e]}else if(2===e)this.replayoff=t.g2;else if(3===e){var i=t.g1;this.walkmerge=new Int32Array(i+1);for(let e=0;e<i;e++)this.walkmerge[e]=t.g1;this.walkmerge[i]=9999999}else 4===e?this.stretches=!0:5===e?this.priority=t.g1:6===e?this.righthand=t.g2:7===e?this.lefthand=t.g2:8===e&&(this.replaycount=t.g1)}}class L{bucketCount;buckets;constructor(t){this.buckets=[],this.bucketCount=t;for(let e=0;e<t;e++)this.buckets[e]=new i}get(t){var i=this.buckets[+(""+(t&BigInt(this.bucketCount-1)))];if(i.next)for(let e=i.next;e!==i;e=e.next)if(e&&e.key===t)return e;return null}put(e,t){t.prev&&t.unlink();var i=this.buckets[+(""+(e&BigInt(this.bucketCount-1)))];t.prev=i.prev,t.next=i,t.prev&&(t.prev.next=t),(t.next.prev=t).key=e}}class V{head=new t;constructor(){this.head.next2=this.head,this.head.prev2=this.head}push(e){e.prev2&&e.unlink2(),e.prev2=this.head.prev2,e.next2=this.head,e.prev2&&(e.prev2.next2=e),e.next2.prev2=e}pop(){var e=this.head.next2;return e===this.head?null:(e?.unlink2(),e)}}class U{capacity;hashtable=new L(1024);history=new V;available;constructor(e){this.capacity=e,this.available=e}get(e){e=this.hashtable.get(e);return e&&this.history.push(e),e}put(e,t){var i;0===this.available?((i=this.history.pop())?.unlink(),i?.unlink2()):this.available--,this.hashtable.put(e,t),this.history.push(t)}clear(){for(;;){var e=this.history.pop();if(!e)return void(this.available=this.capacity);e.unlink(),e.unlink2()}}}class S{static WALL=0;static WALL_DECOR=1;static GROUND=2;static GROUND_DECOR=3}class k{static WALL_STRAIGHT=new k(0,S.WALL);static WALL_DIAGONAL_CORNER=new k(1,S.WALL);static WALL_L=new k(2,S.WALL);static WALL_SQUARE_CORNER=new k(3,S.WALL);static WALLDECOR_STRAIGHT_NOOFFSET=new k(4,S.WALL_DECOR);static WALLDECOR_STRAIGHT_OFFSET=new k(5,S.WALL_DECOR);static WALLDECOR_DIAGONAL_OFFSET=new k(6,S.WALL_DECOR);static WALLDECOR_DIAGONAL_NOOFFSET=new k(7,S.WALL_DECOR);static WALLDECOR_DIAGONAL_BOTH=new k(8,S.WALL_DECOR);static WALL_DIAGONAL=new k(9,S.GROUND);static CENTREPIECE_STRAIGHT=new k(10,S.GROUND);static CENTREPIECE_DIAGONAL=new k(11,S.GROUND);static ROOF_STRAIGHT=new k(12,S.GROUND);static ROOF_DIAGONAL_WITH_ROOFEDGE=new k(13,S.GROUND);static ROOF_DIAGONAL=new k(14,S.GROUND);static ROOF_L_CONCAVE=new k(15,S.GROUND);static ROOF_L_CONVEX=new k(16,S.GROUND);static ROOF_FLAT=new k(17,S.GROUND);static ROOFEDGE_STRAIGHT=new k(18,S.GROUND);static ROOFEDGE_DIAGONAL_CORNER=new k(19,S.GROUND);static ROOFEDGE_L=new k(20,S.GROUND);static ROOFEDGE_SQUARE_CORNER=new k(21,S.GROUND);static GROUND_DECOR=new k(22,S.GROUND_DECOR);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(t){var i=this.values();for(let e=0;e<i.length;e++){var s=i[e];if(s.id===t)return s}throw Error("shape not found")}id;layer;constructor(e,t){this.id=e,this.layer=t}}class N{static WEST=0;static NORTH=1;static EAST=2;static SOUTH=3}class q{vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColorsOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1;data=null}class j{x=0;y=0;z=0;w=0}class ot extends t{static metadata=null;static head=null;static face1=null;static face2=null;static face3=null;static face4=null;static face5=null;static point1=null;static point2=null;static point3=null;static point4=null;static point5=null;static vertex1=null;static vertex2=null;static axis=null;static faceClippedX=new lt(4096,!1);static faceNearClipped=new lt(4096,!1);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new w(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new w(12,2e3);static tmpPriority10FaceDepth=new Int32Array(2e3);static tmpPriority11FaceDepth=new Int32Array(2e3);static tmpPriorityDepthSum=new Int32Array(12);static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColor=new Int32Array(10);static baseX=0;static baseY=0;static baseZ=0;static checkHover=!1;static mouseX=0;static mouseY=0;static pickedCount=0;static pickedBitsets=new Int32Array(1e3);static checkHoverFace=!1;static unpack(e){try{ot.head=new ht(e.read("ob_head.dat")),ot.face1=new ht(e.read("ob_face1.dat")),ot.face2=new ht(e.read("ob_face2.dat")),ot.face3=new ht(e.read("ob_face3.dat")),ot.face4=new ht(e.read("ob_face4.dat")),ot.face5=new ht(e.read("ob_face5.dat")),ot.point1=new ht(e.read("ob_point1.dat")),ot.point2=new ht(e.read("ob_point2.dat")),ot.point3=new ht(e.read("ob_point3.dat")),ot.point4=new ht(e.read("ob_point4.dat")),ot.point5=new ht(e.read("ob_point5.dat")),ot.vertex1=new ht(e.read("ob_vertex1.dat")),ot.vertex2=new ht(e.read("ob_vertex2.dat")),ot.axis=new ht(e.read("ob_axis.dat")),ot.head.pos=0,ot.point1.pos=0,ot.point2.pos=0,ot.point3.pos=0,ot.point4.pos=0,ot.vertex1.pos=0,ot.vertex2.pos=0;var n=ot.head.g2;ot.metadata=new lt(n+100,null);let t=0,i=0,s=0,a=0,r=0,h=0,l=0;for(let e=0;e<n;e++){var o=ot.head.g2,c=new q,d=(c.vertexCount=ot.head.g2,c.faceCount=ot.head.g2,c.texturedFaceCount=ot.head.g1,c.vertexFlagsOffset=ot.point1.pos,c.vertexXOffset=ot.point2.pos,c.vertexYOffset=ot.point3.pos,c.vertexZOffset=ot.point4.pos,c.faceVerticesOffset=ot.vertex1.pos,c.faceOrientationsOffset=ot.vertex2.pos,ot.head.g1),u=ot.head.g1,f=ot.head.g1,p=ot.head.g1,m=ot.head.g1;for(let e=0;e<c.vertexCount;e++){var g=ot.point1.g1;0!=(1&g)&&ot.point2.gsmart,0!=(2&g)&&ot.point3.gsmart,0!=(4&g)&&ot.point4.gsmart}for(let e=0;e<c.faceCount;e++)1===ot.vertex2.g1&&(ot.vertex1.gsmart,ot.vertex1.gsmart),ot.vertex1.gsmart;c.faceColorsOffset=s,s+=2*c.faceCount,1===d&&(c.faceInfosOffset=a,a+=c.faceCount),255===u?(c.facePrioritiesOffset=r,r+=c.faceCount):c.facePrioritiesOffset=-u-1,1===f&&(c.faceAlphasOffset=h,h+=c.faceCount),1===p&&(c.faceLabelsOffset=l,l+=c.faceCount),1===m&&(c.vertexLabelsOffset=i,i+=c.vertexCount),c.faceTextureAxisOffset=t,t+=c.texturedFaceCount,ot.metadata[o]=c}}catch(e){}}static unpack317(t,i){if(null===ot.metadata&&(ot.metadata=[]),null===t)(s=new q).vertexCount=0,s.faceCount=0,s.texturedFaceCount=0,ot.metadata[i]=s;else{var s=new ht(t),a=(s.pos=s.length-18,new q),t=(a.data=t,a.vertexCount=s.g2,a.faceCount=s.g2,a.texturedFaceCount=s.g1,ot.metadata[i]=a,s.g1),i=s.g1,r=s.g1,h=s.g1,l=s.g1,n=s.g2,o=s.g2,c=s.g2,s=s.g2;let e=0;a.vertexFlagsOffset=e,e+=a.vertexCount,a.faceOrientationsOffset=e,e+=a.faceCount,a.facePrioritiesOffset=e,255===i?e+=a.faceCount:a.facePrioritiesOffset=-i-1,a.faceLabelsOffset=e,1===h?e+=a.faceCount:a.faceLabelsOffset=-1,a.faceInfosOffset=e,1===t?e+=a.faceCount:a.faceInfosOffset=-1,a.vertexLabelsOffset=e,1===l?e+=a.vertexCount:a.vertexLabelsOffset=-1,a.faceAlphasOffset=e,1===r?e+=a.faceCount:a.faceAlphasOffset=-1,a.faceVerticesOffset=e,e+=s,a.faceColorsOffset=e,e+=2*a.faceCount,a.faceTextureAxisOffset=e,e+=6*a.texturedFaceCount,a.vertexXOffset=e,e+=n,a.vertexYOffset=e,e+=o,a.vertexZOffset=e,e+=c}}static mulColorLightness(e,t,i){return 2==(2&i)?(t<0?t=0:127<t&&(t=127),127-t):((t=t*(127&e)>>7)<2?t=2:126<t&&(t=126),(65408&e)+t)}static modelCopyFaces=(t,e,i)=>{var s=t.vertexCount,a=t.faceCount,r=t.texturedFaceCount;let h;if(e){h=new Int32Array(s);for(let e=0;e<s;e++)h[e]=t.vertexY[e]}else h=t.vertexY;let l,n,o,c,d=null,u=null;if(i){l=new Int32Array(a),n=new Int32Array(a),o=new Int32Array(a);for(let e=0;e<a;e++)t.faceColorA&&(l[e]=t.faceColorA[e]),t.faceColorB&&(n[e]=t.faceColorB[e]),t.faceColorC&&(o[e]=t.faceColorC[e]);if(c=new Int32Array(a),t.faceInfo)for(let e=0;e<a;e++)c[e]=t.faceInfo[e];else for(let e=0;e<a;e++)c[e]=0;d=new lt(s,null);for(let e=0;e<s;e++){var f,p=d[e]=new j;t.vertexNormal&&(f=t.vertexNormal[e])&&(p.x=f.x,p.y=f.y,p.z=f.z,p.w=f.w)}u=t.vertexNormalOriginal}else l=t.faceColorA,n=t.faceColorB,o=t.faceColorC,c=t.faceInfo;return new ot({vertexCount:s,vertexX:t.vertexX,vertexY:h,vertexZ:t.vertexZ,faceCount:a,faceVertexA:t.faceVertexA,faceVertexB:t.faceVertexB,faceVertexC:t.faceVertexC,faceColorA:l,faceColorB:n,faceColorC:o,faceInfo:c,facePriority:t.facePriority,faceAlpha:t.faceAlpha,faceColor:t.faceColor,priority:t.priority,texturedFaceCount:r,texturedVertexA:t.texturedVertexA,texturedVertexB:t.texturedVertexB,texturedVertexC:t.texturedVertexC,minX:t.minX,maxX:t.maxX,minZ:t.minZ,maxZ:t.maxZ,radius:t.radius,minY:t.minY,maxY:t.maxY,maxDepth:t.maxDepth,minDepth:t.minDepth,vertexNormal:d,vertexNormalOriginal:u})};static modelShareColored=(t,e,i,s)=>{var a=t.vertexCount,r=t.faceCount,h=t.texturedFaceCount;let l,n,o;if(s)l=t.vertexX,n=t.vertexY,o=t.vertexZ;else{l=new Int32Array(a),n=new Int32Array(a),o=new Int32Array(a);for(let e=0;e<a;e++)l[e]=t.vertexX[e],n[e]=t.vertexY[e],o[e]=t.vertexZ[e]}let c;if(e)c=t.faceColor;else{c=new Int32Array(r);for(let e=0;e<r;e++)t.faceColor&&(c[e]=t.faceColor[e])}let d;if(i)d=t.faceAlpha;else if(d=new Int32Array(r),t.faceAlpha)for(let e=0;e<r;e++)d[e]=t.faceAlpha[e];else for(let e=0;e<r;e++)d[e]=0;return new ot({vertexCount:a,vertexX:l,vertexY:n,vertexZ:o,faceCount:r,faceVertexA:t.faceVertexA,faceVertexB:t.faceVertexB,faceVertexC:t.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:t.faceInfo,facePriority:t.facePriority,faceAlpha:d,faceColor:c,priority:t.priority,texturedFaceCount:h,texturedVertexA:t.texturedVertexA,texturedVertexB:t.texturedVertexB,texturedVertexC:t.texturedVertexC,vertexLabel:t.vertexLabel,faceLabel:t.faceLabel})};static modelShareAlpha=(t,e)=>{var i=t.vertexCount,s=t.faceCount,a=t.texturedFaceCount,r=new Int32Array(i),h=new Int32Array(i),l=new Int32Array(i);for(let e=0;e<i;e++)r[e]=t.vertexX[e],h[e]=t.vertexY[e],l[e]=t.vertexZ[e];let n;if(e)n=t.faceAlpha;else if(n=new Int32Array(s),t.faceAlpha)for(let e=0;e<s;e++)n[e]=t.faceAlpha[e];else for(let e=0;e<s;e++)n[e]=0;return new ot({vertexCount:i,vertexX:r,vertexY:h,vertexZ:l,faceCount:s,faceVertexA:t.faceVertexA,faceVertexB:t.faceVertexB,faceVertexC:t.faceVertexC,faceColorA:t.faceColorA,faceColorB:t.faceColorB,faceColorC:t.faceColorC,faceInfo:t.faceInfo,facePriority:t.facePriority,faceAlpha:n,faceColor:t.faceColor,priority:t.priority,texturedFaceCount:a,texturedVertexA:t.texturedVertexA,texturedVertexB:t.texturedVertexB,texturedVertexC:t.texturedVertexC,labelVertices:t.labelVertices,labelFaces:t.labelFaces})};static modelFromModelsBounds=(t,i)=>{let s=!1,a=!1,r=!1,h=!1,l=0,n=0,o=0,c=-1;for(let e=0;e<i;e++){var d=t[e];d&&(l+=d.vertexCount,n+=d.faceCount,o+=d.texturedFaceCount,s||=null!==d.faceInfo,!d.facePriority&&(c=-1===c?d.priority:c)===d.priority||(a=!0),r||=null!==d.faceAlpha,h||=null!==d.faceColor)}var u=new Int32Array(l),f=new Int32Array(l),p=new Int32Array(l),m=new Int32Array(n),g=new Int32Array(n),C=new Int32Array(n),y=new Int32Array(n),v=new Int32Array(n),w=new Int32Array(n),T=new Int32Array(o),S=new Int32Array(o),A=new Int32Array(o);let O=null,I=(s&&(O=new Int32Array(n)),null),L=(a&&(I=new Int32Array(n)),null),b=(r&&(L=new Int32Array(n)),null);h&&(b=new Int32Array(n)),l=0,n=0;for(let e=o=0;e<i;e++){var E=t[e];if(E){var x=l;for(let e=0;e<E.vertexCount;e++)u[l]=E.vertexX[e],f[l]=E.vertexY[e],p[l]=E.vertexZ[e],l++;for(let e=0;e<E.faceCount;e++)m[n]=E.faceVertexA[e]+x,g[n]=E.faceVertexB[e]+x,C[n]=E.faceVertexC[e]+x,E.faceColorA&&(y[n]=E.faceColorA[e]),E.faceColorB&&(v[n]=E.faceColorB[e]),E.faceColorC&&(w[n]=E.faceColorC[e]),s&&(E.faceInfo?O&&(O[n]=E.faceInfo[e]):O&&(O[n]=0)),a&&(E.facePriority?I&&(I[n]=E.facePriority[e]):I&&(I[n]=E.priority)),r&&(E.faceAlpha?L&&(L[n]=E.faceAlpha[e]):L&&(L[n]=0)),h&&E.faceColor&&b&&(b[n]=E.faceColor[e]),n++;for(let e=0;e<E.texturedFaceCount;e++)T[o]=E.texturedVertexA[e]+x,S[o]=E.texturedVertexB[e]+x,A[o]=E.texturedVertexC[e]+x,o++}}var e=new ot({vertexCount:l,vertexX:u,vertexY:f,vertexZ:p,faceCount:n,faceVertexA:m,faceVertexB:g,faceVertexC:C,faceColorA:y,faceColorB:v,faceColorC:w,faceInfo:O,facePriority:I,faceAlpha:L,faceColor:b,priority:c,texturedFaceCount:o,texturedVertexA:T,texturedVertexB:S,texturedVertexC:A});return e.calculateBoundsCylinder(),e};static modelFromModels=(t,i)=>{let s=!1,a=!1,r=!1,h=!1,l=0,n=0,o=0,c=-1;for(let e=0;e<i;e++){var d=t[e];d&&(l+=d.vertexCount,n+=d.faceCount,o+=d.texturedFaceCount,s||=null!==d.faceInfo,!d.facePriority&&(c=-1===c?d.priority:c)===d.priority||(a=!0),r||=null!==d.faceAlpha,h||=null!==d.faceLabel)}var u=new Int32Array(l),f=new Int32Array(l),p=new Int32Array(l),m=new Int32Array(l),g=new Int32Array(n),C=new Int32Array(n),y=new Int32Array(n),v=new Int32Array(o),w=new Int32Array(o),T=new Int32Array(o);let S=null,A=(s&&(S=new Int32Array(n)),null),O=(a&&(A=new Int32Array(n)),null),I=(r&&(O=new Int32Array(n)),null);h&&(I=new Int32Array(n));var L=new Int32Array(n),b=(l=0,n=0,(e,t,i,s,a,r,h)=>{let l=-1;var n=e.vertexX[t],o=e.vertexY[t],c=e.vertexZ[t];for(let e=0;e<h;e++)if(n===i[e]&&o===s[e]&&c===a[e]){l=e;break}return-1===l&&(i[h]=n,s[h]=o,a[h]=c,r&&e.vertexLabel&&(r[h]=e.vertexLabel[t]),l=h++),{vertex:l,vertexCount:h}});for(let e=o=0;e<i;e++){var E=t[e];if(E){for(let e=0;e<E.faceCount;e++){s&&(E.faceInfo?S&&(S[n]=E.faceInfo[e]):S&&(S[n]=0)),a&&(E.facePriority?A&&(A[n]=E.facePriority[e]):A&&(A[n]=E.priority)),r&&(E.faceAlpha?O&&(O[n]=E.faceAlpha[e]):O&&(O[n]=0)),h&&E.faceLabel&&I&&(I[n]=E.faceLabel[e]),E.faceColor&&(L[n]=E.faceColor[e]);var x=b(E,E.faceVertexA[e],u,f,p,m,l),_=(l=x.vertexCount,b(E,E.faceVertexB[e],u,f,p,m,l)),R=(l=_.vertexCount,b(E,E.faceVertexC[e],u,f,p,m,l));l=R.vertexCount,g[n]=x.vertex,C[n]=_.vertex,y[n]=R.vertex,n++}for(let e=0;e<E.texturedFaceCount;e++){var k=b(E,E.texturedVertexA[e],u,f,p,m,l),P=(l=k.vertexCount,b(E,E.texturedVertexB[e],u,f,p,m,l)),B=(l=P.vertexCount,b(E,E.texturedVertexC[e],u,f,p,m,l));l=B.vertexCount,v[o]=k.vertex,w[o]=P.vertex,T[o]=B.vertex,o++}}}return new ot({vertexCount:l,vertexX:u,vertexY:f,vertexZ:p,faceCount:n,faceVertexA:g,faceVertexB:C,faceVertexC:y,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:S,facePriority:A,faceAlpha:O,faceColor:L,priority:c,texturedFaceCount:o,texturedVertexA:v,texturedVertexB:w,texturedVertexC:T,vertexLabel:m,faceLabel:I})};static model=e=>{if(!ot.metadata)throw Error("cant loading model metadata!!!!!");e=ot.metadata[e];if(!e)throw Error("cant loading model metadata!!!!!");if(!(ot.head&&ot.face1&&ot.face2&&ot.face3&&ot.face4&&ot.face5&&ot.point1&&ot.point2&&ot.point3&&ot.point4&&ot.point5&&ot.vertex1&&ot.vertex2&&ot.axis))throw Error("cant loading model!!!!!");var t=e.vertexCount,i=e.faceCount,s=e.texturedFaceCount,a=new Int32Array(t),r=new Int32Array(t),h=new Int32Array(t),l=new Int32Array(i),n=new Int32Array(i),o=new Int32Array(i),c=new Int32Array(s),d=new Int32Array(s),u=new Int32Array(s);let f=null,p=(0<=e.vertexLabelsOffset&&(f=new Int32Array(t)),null),m=(0<=e.faceInfosOffset&&(p=new Int32Array(i)),null),g=0,C=(0<=e.facePrioritiesOffset?m=new Int32Array(i):g=-e.facePrioritiesOffset-1,null),y=(0<=e.faceAlphasOffset&&(C=new Int32Array(i)),null);0<=e.faceLabelsOffset&&(y=new Int32Array(i));var v=new Int32Array(i);ot.point1.pos=e.vertexFlagsOffset,ot.point2.pos=e.vertexXOffset,ot.point3.pos=e.vertexYOffset,ot.point4.pos=e.vertexZOffset,ot.point5.pos=e.vertexLabelsOffset;let w=0,T=0,S=0,A,O,I;for(let e=0;e<t;e++){var L=ot.point1.g1;(A=0)!=(1&L)&&(A=ot.point2.gsmart),(O=0)!=(2&L)&&(O=ot.point3.gsmart),(I=0)!=(4&L)&&(I=ot.point4.gsmart),a[e]=w+A,r[e]=T+O,h[e]=S+I,w=a[e],T=r[e],S=h[e],f&&(f[e]=ot.point5.g1)}ot.face1.pos=e.faceColorsOffset,ot.face2.pos=e.faceInfosOffset,ot.face3.pos=e.facePrioritiesOffset,ot.face4.pos=e.faceAlphasOffset,ot.face5.pos=e.faceLabelsOffset;for(let e=0;e<i;e++)v[e]=ot.face1.g2,p&&(p[e]=ot.face2.g1),m&&(m[e]=ot.face3.g1),C&&(C[e]=ot.face4.g1),y&&(y[e]=ot.face5.g1);ot.vertex1.pos=e.faceVerticesOffset,ot.vertex2.pos=e.faceOrientationsOffset,A=0,O=0;let b=I=0;for(let e=0;e<i;e++){var E=ot.vertex2.g1;1===E?(A=ot.vertex1.gsmart+b,b=A,O=ot.vertex1.gsmart+b,b=O,I=ot.vertex1.gsmart+b,b=I):2===E?(O=I,I=ot.vertex1.gsmart+b,b=I):3===E?(A=I,I=ot.vertex1.gsmart+b,b=I):4===E&&(E=A,A=O,O=E,I=ot.vertex1.gsmart+b,b=I),l[e]=A,n[e]=O,o[e]=I}ot.axis.pos=6*e.faceTextureAxisOffset;for(let e=0;e<s;e++)c[e]=ot.axis.g2,d[e]=ot.axis.g2,u[e]=ot.axis.g2;return new ot({vertexCount:t,vertexX:a,vertexY:r,vertexZ:h,faceCount:i,faceVertexA:l,faceVertexB:n,faceVertexC:o,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:p,facePriority:m,faceAlpha:C,faceColor:v,priority:g,texturedFaceCount:s,texturedVertexA:c,texturedVertexB:d,texturedVertexC:u,vertexLabel:f,faceLabel:y})};static model317=(M,e)=>{if(!ot.metadata||!ot.metadata[e])throw Error("No model metadata");e=ot.metadata[e];if(e.data=M,!e.data.length)throw Error("No model data");var t=e.vertexCount,i=e.faceCount,s=e.texturedFaceCount,a=new Int32Array(t),r=new Int32Array(t),h=new Int32Array(t),l=new Int32Array(i),n=new Int32Array(i),o=new Int32Array(i),c=new Int32Array(s),d=new Int32Array(s),u=new Int32Array(s);let f=null,p=(0<=e.vertexLabelsOffset&&(f=new Int32Array(t)),null),m=(0<=e.faceInfosOffset&&(p=new Int32Array(i)),null),g=0,C=(0<=e.facePrioritiesOffset?m=new Int32Array(i):g=-e.facePrioritiesOffset-1,null),y=(0<=e.faceAlphasOffset&&(C=new Int32Array(i)),null);0<=e.faceLabelsOffset&&(y=new Int32Array(i));var v=new Int32Array(i),w=new ht(e.data),T=(w.pos=e.vertexFlagsOffset,new ht(e.data)),S=(T.pos=e.vertexXOffset,new ht(e.data)),A=(S.pos=e.vertexYOffset,new ht(e.data)),O=(A.pos=e.vertexZOffset,new ht(e.data));O.pos=e.vertexLabelsOffset;let I=0,L=0,b=0,E,x,_;for(let e=0;e<t;e++){var R=w.g1;(E=0)!=(1&R)&&(E=T.gsmart),(x=0)!=(2&R)&&(x=S.gsmart),(_=0)!=(4&R)&&(_=A.gsmart),a[e]=I+E,r[e]=L+x,h[e]=b+_,I=a[e],L=r[e],b=h[e],f&&(f[e]=O.g1)}var Y=new ht(e.data),N=(Y.pos=e.faceColorsOffset,new ht(e.data)),X=(N.pos=e.faceInfosOffset,new ht(e.data)),H=(X.pos=e.facePrioritiesOffset,new ht(e.data)),F=(H.pos=e.faceAlphasOffset,new ht(e.data));F.pos=e.faceLabelsOffset;for(let e=0;e<i;e++)v[e]=Y.g2,p&&(p[e]=N.g1),m&&(m[e]=X.g1),C&&(C[e]=H.g1),y&&(y[e]=F.g1);var k=new ht(e.data),W=(k.pos=e.faceVerticesOffset,new ht(e.data));W.pos=e.faceOrientationsOffset,E=0,x=0;let P=_=0;for(let e=0;e<i;e++){var B=W.g1;1===B?(E=k.gsmart+P,P=E,x=k.gsmart+P,P=x,_=k.gsmart+P,P=_):2===B?(x=_,_=k.gsmart+P,P=_):3===B?(E=_,_=k.gsmart+P,P=_):4===B&&(B=E,E=x,x=B,_=k.gsmart+P,P=_),l[e]=E,n[e]=x,o[e]=_}var D=new ht(e.data);D.pos=e.faceTextureAxisOffset;for(let e=0;e<s;e++)c[e]=D.g2,d[e]=D.g2,u[e]=D.g2;return new ot({vertexCount:t,vertexX:a,vertexY:r,vertexZ:h,faceCount:i,faceVertexA:l,faceVertexB:n,faceVertexC:o,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:p,facePriority:m,faceAlpha:C,faceColor:v,priority:g,texturedFaceCount:s,texturedVertexA:c,texturedVertexB:d,texturedVertexC:u,vertexLabel:f,faceLabel:y})};vertexCount;vertexX;vertexY;vertexZ;faceCount;faceVertexA;faceVertexB;faceVertexC;faceColorA;faceColorB;faceColorC;faceInfo;facePriority;faceAlpha;faceColor;priority;texturedFaceCount;texturedVertexA;texturedVertexB;texturedVertexC;minX;maxX;minZ;maxZ;radius;minY;maxY;maxDepth;minDepth;vertexLabel;faceLabel;labelVertices;labelFaces;vertexNormal;vertexNormalOriginal;objRaise=0;pickable=!1;pickedFace=-1;pickedFaceDepth=-1;constructor(e){super(),this.vertexCount=e.vertexCount,this.vertexX=e.vertexX,this.vertexY=e.vertexY,this.vertexZ=e.vertexZ,this.faceCount=e.faceCount,this.faceVertexA=e.faceVertexA,this.faceVertexB=e.faceVertexB,this.faceVertexC=e.faceVertexC,this.faceColorA=e.faceColorA,this.faceColorB=e.faceColorB,this.faceColorC=e.faceColorC,this.faceInfo=e.faceInfo,this.facePriority=e.facePriority,this.faceAlpha=e.faceAlpha,this.faceColor=e.faceColor,this.priority=e.priority,this.texturedFaceCount=e.texturedFaceCount,this.texturedVertexA=e.texturedVertexA,this.texturedVertexB=e.texturedVertexB,this.texturedVertexC=e.texturedVertexC,this.minX=e.minX??0,this.maxX=e.maxX??0,this.minZ=e.minZ??0,this.maxZ=e.maxZ??0,this.radius=e.radius??0,this.minY=e.minY??0,this.maxY=e.maxY??0,this.maxDepth=e.maxDepth??0,this.minDepth=e.minDepth??0,this.vertexLabel=e.vertexLabel??null,this.faceLabel=e.faceLabel??null,this.labelVertices=e.labelVertices??null,this.labelFaces=e.labelFaces??null,this.vertexNormal=e.vertexNormal??null,this.vertexNormalOriginal=e.vertexNormalOriginal??null}calculateBoundsCylinder(){this.maxY=0,this.radius=0;for(let e=this.minY=0;e<this.vertexCount;e++){var t=this.vertexX[e],i=this.vertexY[e],s=this.vertexZ[e],i=(-i>this.maxY&&(this.maxY=-i),i>this.minY&&(this.minY=i),t*t+s*s);i>this.radius&&(this.radius=i)}this.radius=.99+Math.sqrt(this.radius)|0,this.minDepth=.99+Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0,this.maxDepth=this.minDepth+(.99+Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0)}calculateBoundsY(){this.maxY=0;for(let e=this.minY=0;e<this.vertexCount;e++){var t=this.vertexY[e];-t>this.maxY&&(this.maxY=-t),t>this.minY&&(this.minY=t)}this.minDepth=.99+Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0,this.maxDepth=this.minDepth+(.99+Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0)}createLabelReferences(){if(this.vertexLabel){var i=new Int32Array(256);let t=0;for(let e=0;e<this.vertexCount;e++){var s=this.vertexLabel[e];i[s]++,s>t&&(t=s)}this.labelVertices=new lt(t+1,null);for(let e=0;e<=t;e++)this.labelVertices[e]=new Int32Array(i[e]),i[e]=0;let e=0;for(;e<this.vertexCount;){var a=this.vertexLabel[e],r=this.labelVertices[a];r&&(r[i[a]++]=e++)}this.vertexLabel=null}if(this.faceLabel){var h=new Int32Array(256);let t=0;for(let e=0;e<this.faceCount;e++){var l=this.faceLabel[e];h[l]++,l>t&&(t=l)}this.labelFaces=new lt(t+1,null);for(let e=0;e<=t;e++)this.labelFaces[e]=new Int32Array(h[e]),h[e]=0;let e=0;for(;e<this.faceCount;){var n=this.faceLabel[e],o=this.labelFaces[n];o&&(o[h[n]++]=e++)}this.faceLabel=null}}applyTransforms(e,s,a){if(-1!==e)if(a&&-1!==s){var r=G.instances[e],h=G.instances[s],l=r.base;ot.baseX=0,ot.baseY=0;let t=ot.baseZ=0,i=a[t++];for(let e=0;e<r.length;e++)if(r.bases){for(var n=r.bases[e];n>i;)i=a[t++];l&&l.types&&r.x&&r.y&&r.z&&l.labels&&(n!==i||0===l.types[n])&&this.applyTransform2(r.x[e],r.y[e],r.z[e],l.labels[n],l.types[n])}ot.baseX=0,ot.baseY=0,ot.baseZ=0,t=0,i=a[t++];for(let e=0;e<h.length;e++)if(h.bases){for(var o=h.bases[e];o>i;)i=a[t++];l&&l.types&&h.x&&h.y&&h.z&&l.labels&&(o===i||0===l.types[o])&&this.applyTransform2(h.x[e],h.y[e],h.z[e],l.labels[o],l.types[o])}}else this.applyTransform(e)}applyTransform(e){if(this.labelVertices&&-1!==e&&G.instances[e]){var t,i=G.instances[e],s=i.base;ot.baseX=0,ot.baseY=0;for(let e=ot.baseZ=0;e<i.length;e++)i.bases&&i.x&&i.y&&i.z&&s&&s.labels&&s.types&&(t=i.bases[e],this.applyTransform2(i.x[e],i.y[e],i.z[e],s.labels[t],s.types[t]))}}rotateY90(){for(let e=0;e<this.vertexCount;e++){var t=this.vertexX[e];this.vertexX[e]=this.vertexZ[e],this.vertexZ[e]=-t}}rotateX(e){var t=_.sin[e],i=_.cos[e];for(let e=0;e<this.vertexCount;e++){var s=this.vertexY[e]*i-this.vertexZ[e]*t>>16;this.vertexZ[e]=this.vertexY[e]*t+this.vertexZ[e]*i>>16,this.vertexY[e]=s}}translate(t,i,s){for(let e=0;e<this.vertexCount;e++)this.vertexX[e]+=i,this.vertexY[e]+=t,this.vertexZ[e]+=s}recolor(t,i){if(this.faceColor)for(let e=0;e<this.faceCount;e++)this.faceColor[e]===t&&(this.faceColor[e]=i)}rotateY180(){for(let e=0;e<this.vertexCount;e++)this.vertexZ[e]=-this.vertexZ[e];for(let e=0;e<this.faceCount;e++){var t=this.faceVertexA[e];this.faceVertexA[e]=this.faceVertexC[e],this.faceVertexC[e]=t}}scale(t,i,s){for(let e=0;e<this.vertexCount;e++)this.vertexX[e]=this.vertexX[e]*t/128|0,this.vertexY[e]=this.vertexY[e]*i/128|0,this.vertexZ[e]=this.vertexZ[e]*s/128|0}calculateNormals(r,e,h,l,n,t){var o=e*(0|Math.sqrt(h*h+l*l+n*n))>>8;if(this.faceColorA&&this.faceColorB&&this.faceColorC||(this.faceColorA=new Int32Array(this.faceCount),this.faceColorB=new Int32Array(this.faceCount),this.faceColorC=new Int32Array(this.faceCount)),!this.vertexNormal){this.vertexNormal=new lt(this.vertexCount,null);for(let e=0;e<this.vertexCount;e++)this.vertexNormal[e]=new j}for(let a=0;a<this.faceCount;a++){var c=this.faceVertexA[a],d=this.faceVertexB[a],u=this.faceVertexC[a],f=this.vertexX[d]-this.vertexX[c],p=this.vertexY[d]-this.vertexY[c],m=this.vertexZ[d]-this.vertexZ[c],g=this.vertexX[u]-this.vertexX[c],C=this.vertexY[u]-this.vertexY[c],y=this.vertexZ[u]-this.vertexZ[c];let t=p*y-C*m,i=m*g-y*f,s=f*C-g*p;for(;8192<t||8192<i||8192<s||t<-8192||i<-8192||s<-8192;)t>>=1,i>>=1,s>>=1;let e=0|Math.sqrt(t*t+i*i+s*s);if(e<=0&&(e=1),t=256*t/e|0,i=256*i/e|0,s=256*s/e|0,this.faceInfo&&0!=(1&this.faceInfo[a])){m=r+((h*t+l*i+n*s)/(o+(o/2|0))|0);this.faceColor&&(this.faceColorA[a]=ot.mulColorLightness(this.faceColor[a],m,this.faceInfo[a]))}else{let e=this.vertexNormal[c];e&&(e.x+=t,e.y+=i,e.z+=s,e.w++),(e=this.vertexNormal[d])&&(e.x+=t,e.y+=i,e.z+=s,e.w++),(e=this.vertexNormal[u])&&(e.x+=t,e.y+=i,e.z+=s,e.w++)}}if(t)this.applyLighting(r,o,h,l,n);else{this.vertexNormalOriginal=new lt(this.vertexCount,null);for(let e=0;e<this.vertexCount;e++){var i=this.vertexNormal[e],s=new j;i&&(s.x=i.x,s.y=i.y,s.z=i.z,s.w=i.w),this.vertexNormalOriginal[e]=s}}t?this.calculateBoundsCylinder():this.calculateBoundsAABB()}applyLighting(t,i,s,a,r){for(let e=0;e<this.faceCount;e++){var h,l,n=this.faceVertexA[e],o=this.faceVertexB[e],c=this.faceVertexC[e];!this.faceInfo&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC?(h=this.faceColor[e],(l=this.vertexNormal[n])&&(this.faceColorA[e]=ot.mulColorLightness(h,t+((s*l.x+a*l.y+r*l.z)/(i*l.w)|0),0)),(l=this.vertexNormal[o])&&(this.faceColorB[e]=ot.mulColorLightness(h,t+((s*l.x+a*l.y+r*l.z)/(i*l.w)|0),0)),(l=this.vertexNormal[c])&&(this.faceColorC[e]=ot.mulColorLightness(h,t+((s*l.x+a*l.y+r*l.z)/(i*l.w)|0),0))):this.faceInfo&&0==(1&this.faceInfo[e])&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC&&(h=this.faceColor[e],l=this.faceInfo[e],(n=this.vertexNormal[n])&&(this.faceColorA[e]=ot.mulColorLightness(h,t+((s*n.x+a*n.y+r*n.z)/(i*n.w)|0),l)),(n=this.vertexNormal[o])&&(this.faceColorB[e]=ot.mulColorLightness(h,t+((s*n.x+a*n.y+r*n.z)/(i*n.w)|0),l)),o=this.vertexNormal[c])&&(this.faceColorC[e]=ot.mulColorLightness(h,t+((s*o.x+a*o.y+r*o.z)/(i*o.w)|0),l))}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo)for(let e=0;e<this.faceCount;e++)if(2==(2&this.faceInfo[e]))return;this.faceColor=null}drawSimple(r,h,l,e,n,o,c){var d=_.sin[r],u=_.cos[r],f=_.sin[h],p=_.cos[h],m=_.sin[l],g=_.cos[l],C=_.sin[e],y=_.cos[e],v=o*C+c*y>>16;for(let a=0;a<this.vertexCount;a++){let e=this.vertexX[a],t=this.vertexY[a],i=this.vertexZ[a],s;0!==l&&(s=t*m+e*g>>16,t=t*g-e*m>>16,e=s),0!==r&&(s=t*u-i*d>>16,i=t*d+i*u>>16,t=s),0!==h&&(s=i*f+e*p>>16,i=i*p-e*f>>16,e=s),e+=n,t+=o,i+=c,s=t*y-i*C>>16,i=t*C+i*y>>16,t=s,ot.vertexScreenX&&ot.vertexScreenY&&ot.vertexScreenZ&&(ot.vertexScreenZ[a]=i-v,ot.vertexScreenX[a]=_.centerX+((e<<9)/i|0),ot.vertexScreenY[a]=_.centerY+((t<<9)/i|0)),0<this.texturedFaceCount&&ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&ot.vertexViewSpaceZ&&(ot.vertexViewSpaceX[a]=e,ot.vertexViewSpaceY[a]=t,ot.vertexViewSpaceZ[a]=i)}try{this.draw2(!1,!1,0)}catch(e){}}draw(o,c,d,u,f,p,m,g,C){var y=g*f-p*u>>16,v=m*c+y*d>>16,w=this.radius*d>>16,T=v+w;if(!(T<=50||3500<=v)){var S=g*u+p*f>>16;let n=S-this.radius<<9;if(!((n/T|0)>=D.centerX2d)){let l=S+this.radius<<9;if(!((l/T|0)<=-D.centerX2d)){var y=m*d-y*c>>16,A=this.radius*c>>16;let s=y+A<<9;if(!((s/T|0)<=-D.centerY2d)){let i=y-(A+(this.maxY*d>>16))<<9;if(!((i/T|0)>=D.centerY2d)){let a=v-(w+(this.maxY*c>>16))<=50,t=!1;if(0<C&&ot.checkHover){let e=v-w;e<=50&&(e=50),0<S?(n=n/T|0,l=l/e|0):(l=l/T|0,n=n/e|0),0<y?(i=i/T|0,s=s/e|0):(s=s/T|0,i=i/e|0);A=ot.mouseX-_.centerX,w=ot.mouseY-_.centerY;A>n&&A<l&&w>i&&w<s&&(this.pickable?ot.pickedBitsets[ot.pickedCount++]=C:t=!0)}var O=_.centerX,I=_.centerY;let r=0,h=0;0!==o&&(r=_.sin[o],h=_.cos[o]);for(let s=0;s<this.vertexCount;s++){let e=this.vertexX[s];var L=this.vertexY[s];let t=this.vertexZ[s],i;0!==o&&(i=t*r+e*h>>16,t=t*h-e*r>>16,e=i),e+=p,L+=m,t+=g,i=t*u+e*f>>16,t=t*f-e*u>>16,e=i,i=L*d-t*c>>16,t=L*c+t*d>>16,L=i,ot.vertexScreenZ&&(ot.vertexScreenZ[s]=t-v),50<=t&&ot.vertexScreenX&&ot.vertexScreenY?(ot.vertexScreenX[s]=O+((e<<9)/t|0),ot.vertexScreenY[s]=I+((L<<9)/t|0)):ot.vertexScreenX&&(ot.vertexScreenX[s]=-5e3,a=!0),(a||0<this.texturedFaceCount)&&ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&ot.vertexViewSpaceZ&&(ot.vertexViewSpaceX[s]=e,ot.vertexViewSpaceY[s]=L,ot.vertexViewSpaceZ[s]=t)}try{this.draw2(a,t,C)}catch(e){}}}}}}}draw2(t,i,s,o=!1){ot.checkHoverFace&&(this.pickedFace=-1,this.pickedFaceDepth=-1);for(let e=0;e<this.maxDepth;e++)ot.tmpDepthFaceCount&&(ot.tmpDepthFaceCount[e]=0);for(let e=0;e<this.faceCount;e++){var a,r,h,l,n,c,d,u,f,p;this.faceInfo&&-1===this.faceInfo[e]||ot.vertexScreenX&&ot.vertexScreenY&&ot.vertexScreenZ&&ot.tmpDepthFaces&&ot.tmpDepthFaceCount&&(c=this.faceVertexA[e],d=this.faceVertexB[e],u=this.faceVertexC[e],a=ot.vertexScreenX[c],r=ot.vertexScreenX[d],h=ot.vertexScreenX[u],p=ot.vertexScreenY[c],l=ot.vertexScreenY[d],n=ot.vertexScreenY[u],c=ot.vertexScreenZ[c],d=ot.vertexScreenZ[d],u=ot.vertexScreenZ[u],!t||-5e3!==a&&-5e3!==r&&-5e3!==h?(i&&this.pointWithinTriangle(ot.mouseX,ot.mouseY,p,l,n,a,r,h)&&(ot.pickedBitsets[ot.pickedCount++]=s,i=!1),(a-r)*(n-l)-(p-l)*(h-r)<=0||(ot.faceNearClipped&&(ot.faceNearClipped[e]=!1),ot.faceClippedX&&(ot.faceClippedX[e]=a<0||r<0||h<0||a>D.boundX||r>D.boundX||h>D.boundX),ot.tmpDepthFaces&&ot.tmpDepthFaceCount&&(f=((c+d+u)/3|0)+this.minDepth,ot.tmpDepthFaces[f][ot.tmpDepthFaceCount[f]++]=e,ot.checkHoverFace)&&this.pointWithinTriangle(ot.mouseX,ot.mouseY,p,l,n,a,r,h)&&this.pickedFaceDepth<f&&(this.pickedFace=e,this.pickedFaceDepth=f))):(ot.faceNearClipped&&(ot.faceNearClipped[e]=!0),ot.tmpDepthFaces&&ot.tmpDepthFaceCount&&(p=((c+d+u)/3|0)+this.minDepth,ot.tmpDepthFaces[p][ot.tmpDepthFaceCount[p]++]=e)))}if(!this.facePriority&&ot.tmpDepthFaceCount)for(let e=this.maxDepth-1;0<=e;e--){var m=ot.tmpDepthFaceCount[e];if(!(m<=0)&&ot.tmpDepthFaces){var g=ot.tmpDepthFaces[e];for(let e=0;e<m;e++)try{this.drawFace(g[e],o)}catch(e){}}}else{for(let e=0;e<12;e++)ot.tmpPriorityFaceCount&&ot.tmpPriorityDepthSum&&(ot.tmpPriorityFaceCount[e]=0,ot.tmpPriorityDepthSum[e]=0);if(ot.tmpDepthFaceCount)for(let t=this.maxDepth-1;0<=t;t--){var C=ot.tmpDepthFaceCount[t];if(0<C&&ot.tmpDepthFaces){var y,v,w,T=ot.tmpDepthFaces[t];for(let e=0;e<C;e++)this.facePriority&&ot.tmpPriorityFaceCount&&ot.tmpPriorityFaces&&(y=T[e],v=this.facePriority[y],w=ot.tmpPriorityFaceCount[v]++,ot.tmpPriorityFaces[v][w]=y,v<10&&ot.tmpPriorityDepthSum?ot.tmpPriorityDepthSum[v]+=t:10===v&&ot.tmpPriority10FaceDepth?ot.tmpPriority10FaceDepth[w]=t:ot.tmpPriority11FaceDepth&&(ot.tmpPriority11FaceDepth[w]=t))}}let h=0,l=(ot.tmpPriorityFaceCount&&ot.tmpPriorityDepthSum&&(0<ot.tmpPriorityFaceCount[1]||0<ot.tmpPriorityFaceCount[2])&&(h=(ot.tmpPriorityDepthSum[1]+ot.tmpPriorityDepthSum[2])/(ot.tmpPriorityFaceCount[1]+ot.tmpPriorityFaceCount[2])|0),0),n=(ot.tmpPriorityFaceCount&&ot.tmpPriorityDepthSum&&(0<ot.tmpPriorityFaceCount[3]||0<ot.tmpPriorityFaceCount[4])&&(l=(ot.tmpPriorityDepthSum[3]+ot.tmpPriorityDepthSum[4])/(ot.tmpPriorityFaceCount[3]+ot.tmpPriorityFaceCount[4])|0),0);if(ot.tmpPriorityFaceCount&&ot.tmpPriorityDepthSum&&(0<ot.tmpPriorityFaceCount[6]||0<ot.tmpPriorityFaceCount[8])&&(n=(ot.tmpPriorityDepthSum[6]+ot.tmpPriorityDepthSum[8])/(ot.tmpPriorityFaceCount[6]+ot.tmpPriorityFaceCount[8])|0),ot.tmpPriorityFaceCount&&ot.tmpPriorityFaces){let t=0,i=ot.tmpPriorityFaceCount[10],s=ot.tmpPriorityFaces[10],a=ot.tmpPriority10FaceDepth;t===i&&(t=0,i=ot.tmpPriorityFaceCount[11],s=ot.tmpPriorityFaces[11],a=ot.tmpPriority11FaceDepth);let r;r=t<i&&a?a[t]:-1e3;for(let e=0;e<10;e++){for(;0===e&&r>h;)try{this.drawFace(s[t++],o),t===i&&s!==ot.tmpPriorityFaces[11]&&(t=0,i=ot.tmpPriorityFaceCount[11],s=ot.tmpPriorityFaces[11],a=ot.tmpPriority11FaceDepth),r=t<i&&a?a[t]:-1e3}catch(e){}for(;3===e&&r>l;)try{this.drawFace(s[t++],o),t===i&&s!==ot.tmpPriorityFaces[11]&&(t=0,i=ot.tmpPriorityFaceCount[11],s=ot.tmpPriorityFaces[11],a=ot.tmpPriority11FaceDepth),r=t<i&&a?a[t]:-1e3}catch(e){}for(;5===e&&r>n;)try{this.drawFace(s[t++],o),t===i&&s!==ot.tmpPriorityFaces[11]&&(t=0,i=ot.tmpPriorityFaceCount[11],s=ot.tmpPriorityFaces[11],a=ot.tmpPriority11FaceDepth),r=t<i&&a?a[t]:-1e3}catch(e){}var S=ot.tmpPriorityFaceCount[e],A=ot.tmpPriorityFaces[e];for(let e=0;e<S;e++)try{this.drawFace(A[e],o)}catch(e){}}for(;-1e3!==r;)try{this.drawFace(s[t++],o),t===i&&s!==ot.tmpPriorityFaces[11]&&(t=0,s=ot.tmpPriorityFaces[11],i=ot.tmpPriorityFaceCount[11],a=ot.tmpPriority11FaceDepth),r=t<i&&a?a[t]:-1e3}catch(e){}}}}drawFace(t,i=!1){if(ot.faceNearClipped&&ot.faceNearClipped[t])this.drawNearClippedFace(t,i);else{var s,a,r=this.faceVertexA[t],h=this.faceVertexB[t],l=this.faceVertexC[t];ot.faceClippedX&&(_.clipX=ot.faceClippedX[t]),this.faceAlpha?_.alpha=this.faceAlpha[t]:_.alpha=0;let e;e=this.faceInfo?3&this.faceInfo[t]:0,i&&ot.vertexScreenX&&ot.vertexScreenY&&this.faceColorA&&this.faceColorB&&this.faceColorC?(_.drawLine(ot.vertexScreenX[r],ot.vertexScreenY[r],ot.vertexScreenX[h],ot.vertexScreenY[h],_.palette[this.faceColorA[t]]),_.drawLine(ot.vertexScreenX[h],ot.vertexScreenY[h],ot.vertexScreenX[l],ot.vertexScreenY[l],_.palette[this.faceColorB[t]]),_.drawLine(ot.vertexScreenX[l],ot.vertexScreenY[l],ot.vertexScreenX[r],ot.vertexScreenY[r],_.palette[this.faceColorC[t]])):0===e&&this.faceColorA&&this.faceColorB&&this.faceColorC&&ot.vertexScreenX&&ot.vertexScreenY?_.fillGouraudTriangle(ot.vertexScreenX[r],ot.vertexScreenX[h],ot.vertexScreenX[l],ot.vertexScreenY[r],ot.vertexScreenY[h],ot.vertexScreenY[l],this.faceColorA[t],this.faceColorB[t],this.faceColorC[t]):1===e&&this.faceColorA&&ot.vertexScreenX&&ot.vertexScreenY?_.fillTriangle(ot.vertexScreenX[r],ot.vertexScreenX[h],ot.vertexScreenX[l],ot.vertexScreenY[r],ot.vertexScreenY[h],ot.vertexScreenY[l],_.palette[this.faceColorA[t]]):2===e&&this.faceInfo&&this.faceColor&&this.faceColorA&&this.faceColorB&&this.faceColorC&&ot.vertexScreenX&&ot.vertexScreenY&&ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&ot.vertexViewSpaceZ?(i=this.faceInfo[t]>>2,a=this.texturedVertexA[i],s=this.texturedVertexB[i],i=this.texturedVertexC[i],_.fillTexturedTriangle(ot.vertexScreenX[r],ot.vertexScreenX[h],ot.vertexScreenX[l],ot.vertexScreenY[r],ot.vertexScreenY[h],ot.vertexScreenY[l],this.faceColorA[t],this.faceColorB[t],this.faceColorC[t],ot.vertexViewSpaceX[a],ot.vertexViewSpaceY[a],ot.vertexViewSpaceZ[a],ot.vertexViewSpaceX[s],ot.vertexViewSpaceX[i],ot.vertexViewSpaceY[s],ot.vertexViewSpaceY[i],ot.vertexViewSpaceZ[s],ot.vertexViewSpaceZ[i],this.faceColor[t])):3===e&&this.faceInfo&&this.faceColor&&this.faceColorA&&ot.vertexScreenX&&ot.vertexScreenY&&ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&ot.vertexViewSpaceZ&&(a=this.faceInfo[t]>>2,s=this.texturedVertexA[a],i=this.texturedVertexB[a],a=this.texturedVertexC[a],_.fillTexturedTriangle(ot.vertexScreenX[r],ot.vertexScreenX[h],ot.vertexScreenX[l],ot.vertexScreenY[r],ot.vertexScreenY[h],ot.vertexScreenY[l],this.faceColorA[t],this.faceColorA[t],this.faceColorA[t],ot.vertexViewSpaceX[s],ot.vertexViewSpaceY[s],ot.vertexViewSpaceZ[s],ot.vertexViewSpaceX[i],ot.vertexViewSpaceX[a],ot.vertexViewSpaceY[i],ot.vertexViewSpaceY[a],ot.vertexViewSpaceZ[i],ot.vertexViewSpaceZ[a],this.faceColor[t]))}}drawNearClippedFace(t,i=!1){let e=0;ot.vertexViewSpaceZ&&(p=_.centerX,h=_.centerY,l=this.faceVertexA[t],c=this.faceVertexB[t],a=this.faceVertexC[t],u=ot.vertexViewSpaceZ[l],o=ot.vertexViewSpaceZ[c],f=ot.vertexViewSpaceZ[a],50<=u&&ot.vertexScreenX&&ot.vertexScreenY&&this.faceColorA?(ot.clippedX[e]=ot.vertexScreenX[l],ot.clippedY[e]=ot.vertexScreenY[l],ot.clippedColor[e++]=this.faceColorA[t]):ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&this.faceColorA&&(r=ot.vertexViewSpaceX[l],n=ot.vertexViewSpaceY[l],s=this.faceColorA[t],50<=f&&this.faceColorC&&(d=(50-u)*_.reciprocal16[f-u],ot.clippedX[e]=p+((r+((ot.vertexViewSpaceX[a]-r)*d>>16)<<9)/50|0),ot.clippedY[e]=h+((n+((ot.vertexViewSpaceY[a]-n)*d>>16)<<9)/50|0),ot.clippedColor[e++]=s+((this.faceColorC[t]-s)*d>>16)),50<=o)&&this.faceColorB&&(d=(50-u)*_.reciprocal16[o-u],ot.clippedX[e]=p+((r+((ot.vertexViewSpaceX[c]-r)*d>>16)<<9)/50|0),ot.clippedY[e]=h+((n+((ot.vertexViewSpaceY[c]-n)*d>>16)<<9)/50|0),ot.clippedColor[e++]=s+((this.faceColorB[t]-s)*d>>16)),50<=o&&ot.vertexScreenX&&ot.vertexScreenY&&this.faceColorB?(ot.clippedX[e]=ot.vertexScreenX[c],ot.clippedY[e]=ot.vertexScreenY[c],ot.clippedColor[e++]=this.faceColorB[t]):ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&this.faceColorB&&(r=ot.vertexViewSpaceX[c],n=ot.vertexViewSpaceY[c],s=this.faceColorB[t],50<=u&&this.faceColorA&&(d=(50-o)*_.reciprocal16[u-o],ot.clippedX[e]=p+((r+((ot.vertexViewSpaceX[l]-r)*d>>16)<<9)/50|0),ot.clippedY[e]=h+((n+((ot.vertexViewSpaceY[l]-n)*d>>16)<<9)/50|0),ot.clippedColor[e++]=s+((this.faceColorA[t]-s)*d>>16)),50<=f)&&this.faceColorC&&(d=(50-o)*_.reciprocal16[f-o],ot.clippedX[e]=p+((r+((ot.vertexViewSpaceX[a]-r)*d>>16)<<9)/50|0),ot.clippedY[e]=h+((n+((ot.vertexViewSpaceY[a]-n)*d>>16)<<9)/50|0),ot.clippedColor[e++]=s+((this.faceColorC[t]-s)*d>>16)),50<=f&&ot.vertexScreenX&&ot.vertexScreenY&&this.faceColorC?(ot.clippedX[e]=ot.vertexScreenX[a],ot.clippedY[e]=ot.vertexScreenY[a],ot.clippedColor[e++]=this.faceColorC[t]):ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&this.faceColorC&&(r=ot.vertexViewSpaceX[a],n=ot.vertexViewSpaceY[a],s=this.faceColorC[t],50<=o&&this.faceColorB&&(d=(50-f)*_.reciprocal16[o-f],ot.clippedX[e]=p+((r+((ot.vertexViewSpaceX[c]-r)*d>>16)<<9)/50|0),ot.clippedY[e]=h+((n+((ot.vertexViewSpaceY[c]-n)*d>>16)<<9)/50|0),ot.clippedColor[e++]=s+((this.faceColorB[t]-s)*d>>16)),50<=u)&&this.faceColorA&&(a=(50-f)*_.reciprocal16[u-f],ot.clippedX[e]=p+((r+((ot.vertexViewSpaceX[l]-r)*a>>16)<<9)/50|0),ot.clippedY[e]=h+((n+((ot.vertexViewSpaceY[l]-n)*a>>16)<<9)/50|0),ot.clippedColor[e++]=s+((this.faceColorA[t]-s)*a>>16)));var s,a,r,h,l,n,o=ot.clippedX[0],c=ot.clippedX[1],d=ot.clippedX[2],u=ot.clippedY[0],f=ot.clippedY[1],p=ot.clippedY[2];if(!((o-c)*(p-f)-(u-f)*(d-c)<=0))if(_.clipX=!1,3===e){(o<0||c<0||d<0||o>D.boundX||c>D.boundX||d>D.boundX)&&(_.clipX=!0);let e;e=this.faceInfo?3&this.faceInfo[t]:0,i?(_.drawLine(o,c,u,f,ot.clippedColor[0]),_.drawLine(c,d,f,p,ot.clippedColor[1]),_.drawLine(d,o,p,u,ot.clippedColor[2])):0===e?_.fillGouraudTriangle(o,c,d,u,f,p,ot.clippedColor[0],ot.clippedColor[1],ot.clippedColor[2]):1===e&&this.faceColorA?_.fillTriangle(o,c,d,u,f,p,_.palette[this.faceColorA[t]]):2===e&&this.faceInfo&&this.faceColor&&ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&ot.vertexViewSpaceZ?(r=this.faceInfo[t]>>2,h=this.texturedVertexA[r],l=this.texturedVertexB[r],n=this.texturedVertexC[r],_.fillTexturedTriangle(o,c,d,u,f,p,ot.clippedColor[0],ot.clippedColor[1],ot.clippedColor[2],ot.vertexViewSpaceX[h],ot.vertexViewSpaceY[h],ot.vertexViewSpaceZ[h],ot.vertexViewSpaceX[l],ot.vertexViewSpaceX[n],ot.vertexViewSpaceY[l],ot.vertexViewSpaceY[n],ot.vertexViewSpaceZ[l],ot.vertexViewSpaceZ[n],this.faceColor[t])):3===e&&this.faceInfo&&this.faceColor&&this.faceColorA&&ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&ot.vertexViewSpaceZ&&(s=this.faceInfo[t]>>2,a=this.texturedVertexA[s],r=this.texturedVertexB[s],h=this.texturedVertexC[s],_.fillTexturedTriangle(o,c,d,u,f,p,this.faceColorA[t],this.faceColorA[t],this.faceColorA[t],ot.vertexViewSpaceX[a],ot.vertexViewSpaceY[a],ot.vertexViewSpaceZ[a],ot.vertexViewSpaceX[r],ot.vertexViewSpaceX[h],ot.vertexViewSpaceY[r],ot.vertexViewSpaceY[h],ot.vertexViewSpaceZ[r],ot.vertexViewSpaceZ[h],this.faceColor[t]))}else if(4===e){(o<0||c<0||d<0||o>D.boundX||c>D.boundX||d>D.boundX||ot.clippedX[3]<0||ot.clippedX[3]>D.boundX)&&(_.clipX=!0);let e;e=this.faceInfo?3&this.faceInfo[t]:0,i?(_.drawLine(o,c,u,f,ot.clippedColor[0]),_.drawLine(c,d,f,p,ot.clippedColor[1]),_.drawLine(d,ot.clippedX[3],p,ot.clippedY[3],ot.clippedColor[2]),_.drawLine(ot.clippedX[3],o,ot.clippedY[3],u,ot.clippedColor[3])):0===e?(_.fillGouraudTriangle(o,c,d,u,f,p,ot.clippedColor[0],ot.clippedColor[1],ot.clippedColor[2]),_.fillGouraudTriangle(o,d,ot.clippedX[3],u,p,ot.clippedY[3],ot.clippedColor[0],ot.clippedColor[2],ot.clippedColor[3])):1===e?this.faceColorA&&(l=_.palette[this.faceColorA[t]],_.fillTriangle(o,c,d,u,f,p,l),_.fillTriangle(o,d,ot.clippedX[3],u,p,ot.clippedY[3],l)):2===e&&this.faceInfo&&this.faceColor&&ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&ot.vertexViewSpaceZ?(n=this.faceInfo[t]>>2,s=this.texturedVertexA[n],a=this.texturedVertexB[n],r=this.texturedVertexC[n],_.fillTexturedTriangle(o,c,d,u,f,p,ot.clippedColor[0],ot.clippedColor[1],ot.clippedColor[2],ot.vertexViewSpaceX[s],ot.vertexViewSpaceY[s],ot.vertexViewSpaceZ[s],ot.vertexViewSpaceX[a],ot.vertexViewSpaceX[r],ot.vertexViewSpaceY[a],ot.vertexViewSpaceY[r],ot.vertexViewSpaceZ[a],ot.vertexViewSpaceZ[r],this.faceColor[t]),_.fillTexturedTriangle(o,d,ot.clippedX[3],u,p,ot.clippedY[3],ot.clippedColor[0],ot.clippedColor[2],ot.clippedColor[3],ot.vertexViewSpaceX[s],ot.vertexViewSpaceY[s],ot.vertexViewSpaceZ[s],ot.vertexViewSpaceX[a],ot.vertexViewSpaceX[r],ot.vertexViewSpaceY[a],ot.vertexViewSpaceY[r],ot.vertexViewSpaceZ[a],ot.vertexViewSpaceZ[r],this.faceColor[t])):3===e&&this.faceInfo&&this.faceColor&&this.faceColorA&&ot.vertexViewSpaceX&&ot.vertexViewSpaceY&&ot.vertexViewSpaceZ&&(h=this.faceInfo[t]>>2,i=this.texturedVertexA[h],l=this.texturedVertexB[h],n=this.texturedVertexC[h],_.fillTexturedTriangle(o,c,d,u,f,p,this.faceColorA[t],this.faceColorA[t],this.faceColorA[t],ot.vertexViewSpaceX[i],ot.vertexViewSpaceY[i],ot.vertexViewSpaceZ[i],ot.vertexViewSpaceX[l],ot.vertexViewSpaceX[n],ot.vertexViewSpaceY[l],ot.vertexViewSpaceY[n],ot.vertexViewSpaceZ[l],ot.vertexViewSpaceZ[n],this.faceColor[t]),_.fillTexturedTriangle(o,d,ot.clippedX[3],u,p,ot.clippedY[3],this.faceColorA[t],this.faceColorA[t],this.faceColorA[t],ot.vertexViewSpaceX[i],ot.vertexViewSpaceY[i],ot.vertexViewSpaceZ[i],ot.vertexViewSpaceX[l],ot.vertexViewSpaceX[n],ot.vertexViewSpaceY[l],ot.vertexViewSpaceY[n],ot.vertexViewSpaceZ[l],ot.vertexViewSpaceZ[n],this.faceColor[t]))}}applyTransform2(s,a,r,i,e){if(i){var h=i.length;if(0===e){let t=0;ot.baseX=0,ot.baseY=0;for(let e=ot.baseZ=0;e<h;e++)if(this.labelVertices){var l=i[e];if(l<this.labelVertices.length){var n=this.labelVertices[l];if(n)for(let e=0;e<n.length;e++){var o=n[e];ot.baseX+=this.vertexX[o],ot.baseY+=this.vertexY[o],ot.baseZ+=this.vertexZ[o],t++}}}0<t?(ot.baseX=(ot.baseX/t|0)+s,ot.baseY=(ot.baseY/t|0)+a,ot.baseZ=(ot.baseZ/t|0)+r):(ot.baseX=s,ot.baseY=a,ot.baseZ=r)}else if(1===e)for(let e=0;e<h;e++){var t=i[e];if(this.labelVertices&&!(t>=this.labelVertices.length)){var c=this.labelVertices[t];if(c)for(let e=0;e<c.length;e++){var d=c[e];this.vertexX[d]+=s,this.vertexY[d]+=a,this.vertexZ[d]+=r}}}else if(2===e)for(let e=0;e<h;e++){var u=i[e];if(this.labelVertices&&!(u>=this.labelVertices.length)){var f=this.labelVertices[u];if(f)for(let i=0;i<f.length;i++){var p=f[i],m=(this.vertexX[p]-=ot.baseX,this.vertexY[p]-=ot.baseY,this.vertexZ[p]-=ot.baseZ,8*(255&s)),g=8*(255&a),C=8*(255&r);let e,t;0!=C&&(e=_.sin[C],t=_.cos[C],C=this.vertexY[p]*e+this.vertexX[p]*t>>16,this.vertexY[p]=this.vertexY[p]*t-this.vertexX[p]*e>>16,this.vertexX[p]=C),0!=m&&(e=_.sin[m],t=_.cos[m],C=this.vertexY[p]*t-this.vertexZ[p]*e>>16,this.vertexZ[p]=this.vertexY[p]*e+this.vertexZ[p]*t>>16,this.vertexY[p]=C),0!=g&&(e=_.sin[g],t=_.cos[g],m=this.vertexZ[p]*e+this.vertexX[p]*t>>16,this.vertexZ[p]=this.vertexZ[p]*t-this.vertexX[p]*e>>16,this.vertexX[p]=m),this.vertexX[p]+=ot.baseX,this.vertexY[p]+=ot.baseY,this.vertexZ[p]+=ot.baseZ}}}else if(3===e)for(let e=0;e<h;e++){var y=i[e];if(this.labelVertices&&!(y>=this.labelVertices.length)){var v=this.labelVertices[y];if(v)for(let e=0;e<v.length;e++){var w=v[e];this.vertexX[w]-=ot.baseX,this.vertexY[w]-=ot.baseY,this.vertexZ[w]-=ot.baseZ,this.vertexX[w]=this.vertexX[w]*s/128|0,this.vertexY[w]=this.vertexY[w]*a/128|0,this.vertexZ[w]=this.vertexZ[w]*r/128|0,this.vertexX[w]+=ot.baseX,this.vertexY[w]+=ot.baseY,this.vertexZ[w]+=ot.baseZ}}}else if(5===e&&this.labelFaces&&this.faceAlpha)for(let e=0;e<h;e++){var T=i[e];if(!(T>=this.labelFaces.length)){var S=this.labelFaces[T];if(S)for(let e=0;e<S.length;e++){var A=S[e];this.faceAlpha[A]+=8*s,this.faceAlpha[A]<0&&(this.faceAlpha[A]=0),255<this.faceAlpha[A]&&(this.faceAlpha[A]=255)}}}}}calculateBoundsAABB(){this.maxY=0,this.radius=0,this.minY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let e=0;e<this.vertexCount;e++){var t=this.vertexX[e],i=this.vertexY[e],s=this.vertexZ[e],i=(t<this.minX&&(this.minX=t),t>this.maxX&&(this.maxX=t),s<this.minZ&&(this.minZ=s),s>this.maxZ&&(this.maxZ=s),-i>this.maxY&&(this.maxY=-i),i>this.minY&&(this.minY=i),t*t+s*s);i>this.radius&&(this.radius=i)}this.radius=0|Math.sqrt(this.radius),this.minDepth=0|Math.sqrt(this.radius*this.radius+this.maxY*this.maxY),this.maxDepth=this.minDepth+(0|Math.sqrt(this.radius*this.radius+this.minY*this.minY))}pointWithinTriangle(e,t,i,s,a,r,h,l){return!(t<i&&t<s&&t<a||i<t&&s<t&&a<t||e<r&&e<h&&e<l||!(e<=r||e<=h||e<=l))}drawFaceOutline(e){var t,i;ot.vertexScreenX&&ot.vertexScreenY&&this.faceColorA&&this.faceColorB&&this.faceColorC&&(t=this.faceVertexA[e],i=this.faceVertexB[e],e=this.faceVertexC[e],_.drawLine(ot.vertexScreenX[t],ot.vertexScreenY[t],ot.vertexScreenX[i],ot.vertexScreenY[i],_.palette[1e3]),_.drawLine(ot.vertexScreenX[i],ot.vertexScreenY[i],ot.vertexScreenX[e],ot.vertexScreenY[e],_.palette[1e3]),_.drawLine(ot.vertexScreenX[e],ot.vertexScreenY[e],ot.vertexScreenX[t],ot.vertexScreenY[t],_.palette[1e3]))}}class P extends I{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static modelCacheStatic=new U(500);static modelCacheDynamic=new U(30);static unpack=e=>{this.dat=new ht(e.read("loc.dat"));var t=new ht(e.read("loc.idx"));this.count=t.g2,this.offsets=new Int32Array(this.count);let i=2;for(let e=0;e<this.count;e++)this.offsets[e]=i,i+=t.g2;this.cache=new lt(10,null);for(let e=0;e<10;e++)this.cache[e]=new P(-1)};static get=t=>{if(!this.cache||!this.offsets||!this.dat)throw Error("LocType not loaded!!!");for(let e=0;e<10;e++){var i=this.cache[e];if(i&&i.id===t)return i}this.cachePos=(this.cachePos+1)%10;var e=this.cache[this.cachePos];return this.dat.pos=this.offsets[t],e.id=t,e.reset(),e.decodeType(this.dat),e.shapes||(e.shapes=new Int32Array(1)),-1===e.active2&&e.shapes&&(e.active=0<e.shapes.length&&e.shapes[0]===k.CENTREPIECE_STRAIGHT.id,e.op)&&(e.active=!0),e};models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=!1;active2=-1;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;disposeAlpha=!1;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;offsetx=0;offsety=0;offsetz=0;forcedecor=!1;decode(e,t){if(1===e){var i=t.g1;this.models=new Int32Array(i),this.shapes=new Int32Array(i);for(let e=0;e<i;e++)this.models[e]=t.g2,this.shapes[e]=t.g1}else if(2===e)this.name=t.gjstr;else if(3===e)this.desc=t.gjstr;else if(14===e)this.width=t.g1;else if(15===e)this.length=t.g1;else if(17===e)this.blockwalk=!1;else if(18===e)this.blockrange=!1;else if(19===e)this.active2=t.g1,1===this.active2&&(this.active=!0);else if(21===e)this.hillskew=!0;else if(22===e)this.sharelight=!0;else if(23===e)this.occlude=!0;else if(24===e)this.anim=t.g2,65535===this.anim&&(this.anim=-1);else if(25===e)this.disposeAlpha=!0;else if(28===e)this.wallwidth=t.g1;else if(29===e)this.ambient=t.g1b;else if(39===e)this.contrast=t.g1b;else if(30<=e&&e<39)this.op||(this.op=new lt(5,null)),this.op[e-30]=t.gjstr,"hidden"==this.op[e-30]?.toLowerCase()&&(this.op[e-30]=null);else if(40===e){var s=t.g1;this.recol_s=new Uint16Array(s),this.recol_d=new Uint16Array(s);for(let e=0;e<s;e++)this.recol_s[e]=t.g2,this.recol_d[e]=t.g2}else 60===e?this.mapfunction=t.g2:62===e?this.mirror=!0:64===e?this.shadow=!1:65===e?this.resizex=t.g2:66===e?this.resizey=t.g2:67===e?this.resizez=t.g2:68===e?this.mapscene=t.g2:69===e?this.forceapproach=t.g1:70===e?this.offsetx=t.g2b:71===e?this.offsety=t.g2b:72===e?this.offsetz=t.g2b:73===e&&(this.forcedecor=!0)}getModel(t,e,i,s,a,r,h){if(!this.shapes)return null;let l=-1;for(let e=0;e<this.shapes.length;e++)if(this.shapes[e]===t){l=e;break}if(-1===l)return null;var n=BigInt(BigInt(this.id)<<6n)+BigInt(BigInt(l)<<3n)+BigInt(e)+BigInt(BigInt(h)+1n<<32n);let o=P.modelCacheDynamic?.get(n);if(o){if((this.hillskew||this.sharelight)&&(o=ot.modelCopyFaces(o,this.hillskew,this.sharelight)),this.hillskew){var c=(i+s+a+r)/4|0;for(let e=0;e<o.vertexCount;e++){var d=o.vertexX[e],u=o.vertexZ[e],f=i+((s-i)*(d+64)/128|0);o.vertexY[e]+=f+((r+((a-r)*(d+64)/128|0)-f)*(u+64)/128|0)-c}o.calculateBoundsY()}return o}if(!this.models)return null;if(l>=this.models.length)return null;let p=this.models[l];if(-1===p)return null;var m=this.mirror!==3<e;m&&(p+=65536);let g=P.modelCacheStatic?.get(BigInt(p));g||(g=ot.model(65535&p),m&&g.rotateY180(),P.modelCacheStatic?.put(BigInt(p),g));var m=128!==this.resizex||128!==this.resizey||128!==this.resizez,C=0!==this.offsetx||0!==this.offsety||0!==this.offsetz;let y=ot.modelShareColored(g,!this.recol_s,!this.disposeAlpha,e===N.WEST&&-1===h&&!m&&!C);for(-1!==h&&(y.createLabelReferences(),y.applyTransform(h),y.labelFaces=null,y.labelVertices=null);0<e--;)y.rotateY90();if(this.recol_s&&this.recol_d)for(let e=0;e<this.recol_s.length;e++)y.recolor(this.recol_s[e],this.recol_d[e]);if(m&&y.scale(this.resizex,this.resizey,this.resizez),C&&y.translate(this.offsety,this.offsetx,this.offsetz),y.calculateNormals(64+(255&this.ambient),5*(255&this.contrast)+768,-50,-10,-50,!this.sharelight),this.blockwalk&&(y.objRaise=y.maxY),P.modelCacheDynamic?.put(n,y),(this.hillskew||this.sharelight)&&(y=ot.modelCopyFaces(y,this.hillskew,this.sharelight)),this.hillskew){var v=(i+s+a+r)/4|0;for(let e=0;e<y.vertexCount;e++){var w=y.vertexX[e],T=y.vertexZ[e],S=i+((s-i)*(w+64)/128|0);y.vertexY[e]+=S+((r+((a-r)*(w+64)/128|0)-S)*(T+64)/128|0)-v}y.calculateBoundsY()}return y}reset(){this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.active=!1,this.active2=-1,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.wallwidth=16,this.ambient=0,this.contrast=0,this.op=null,this.disposeAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.offsetx=0,this.offsety=0,this.offsetz=0,this.forcedecor=!1}}class ct{static RED=16711680;static GREEN=65280;static BLUE=255;static YELLOW=16776960;static CYAN=65535;static MAGENTA=16711935;static WHITE=16777215;static BLACK=0;static LIGHTRED=16748608;static DARKRED=8388608;static DARKBLUE=128;static ORANGE1=16756736;static ORANGE2=16740352;static ORANGE3=16723968;static GREEN1=12648192;static GREEN2=8453888;static GREEN3=4259584;static PROGRESS_RED=9179409;static OPTIONS_MENU=6116423;static SCROLLBAR_TRACK=2301979;static SCROLLBAR_GRIP_FOREGROUND=5063219;static SCROLLBAR_GRIP_HIGHLIGHT=7759444;static SCROLLBAR_GRIP_LOWLIGHT=3353893;static TRADE_MESSAGE=8388736;static DUEL_MESSAGE=13350793;static CHAT_COLORS=Int32Array.of(ct.YELLOW,ct.RED,ct.GREEN,ct.CYAN,ct.MAGENTA,ct.WHITE);static HAIR_DARK_BROWN=6798;static HAIR_WHITE=107;static HAIR_LIGHT_GREY=10283;static HAIR_DARK_GREY=16;static HAIR_APRICOT=4797;static HAIR_STRAW=7744;static HAIR_LIGHT_BROWN=5799;static HAIR_BROWN=4634;static HAIR_TURQUOISE=33697;static HAIR_GREEN=22433;static HAIR_GINGER=2983;static HAIR_MAGENTA=54193;static BODY_KHAKI=8741;static BODY_CHARCOAL=12;static BODY_CRIMSON=64030;static BODY_NAVY=43162;static BODY_STRAW=7735;static BODY_WHITE=8404;static BODY_RED=1701;static BODY_BLUE=38430;static BODY_GREEN=24094;static BODY_YELLOW=10153;static BODY_PURPLE=56621;static BODY_ORANGE=4783;static BODY_ROSE=1341;static BODY_LIME=16578;static BODY_CYAN=35003;static BODY_EMERALD=25239;static BODY_RECOLOR_KHAKI=9104;static BODY_RECOLOR_CHARCOAL=10275;static BODY_RECOLOR_CRIMSON=7595;static BODY_RECOLOR_NAVY=3610;static BODY_RECOLOR_STRAW=7975;static BODY_RECOLOR_WHITE=8526;static BODY_RECOLOR_RED=918;static BODY_RECOLOR_BLUE=38802;static BODY_RECOLOR_GREEN=24466;static BODY_RECOLOR_YELLOW=10145;static BODY_RECOLOR_PURPLE=58654;static BODY_RECOLOR_ORANGE=5027;static BODY_RECOLOR_ROSE=1457;static BODY_RECOLOR_LIME=16565;static BODY_RECOLOR_CYAN=34991;static BODY_RECOLOR_EMERALD=25486;static FEET_BROWN=4626;static FEET_KHAKI=11146;static FEET_ASHEN=6439;static FEET_DARK=12;static FEET_TERRACOTTA=4758;static FEET_GREY=10270;static SKIN=4574;static SKIN_DARKER=4550;static SKIN_DARKER_DARKER=4537;static SKIN_DARKER_DARKER_DARKER=5681;static SKIN_DARKER_DARKER_DARKER_DARKER=5673;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER=5790;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER=6806;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER=8076}class B extends t{pixels;width;height;cropX;cropY;cropW;cropH;constructor(e,t){super(),this.pixels=new Int32Array(e*t),this.width=this.cropW=e,this.height=this.cropH=t,this.cropX=this.cropY=0}static fromJpeg=async(e,t)=>{e=e.read(t+".dat");if(!e)throw Error(t+" jpeg not found!");255!==(t=e)[0]&&(t[0]=255),URL.revokeObjectURL(u.src),u.src=URL.createObjectURL(new Blob([t],{type:"image/jpeg"})),await new Promise(e=>u.onload=()=>e()),f.clearRect(0,0,d.width,d.height),t=u.naturalWidth,e=u.naturalHeight,d.width=t,d.height=e,f.drawImage(u,0,0);var t=await f.getImageData(0,0,t,e),e=new B(t.width,t.height),i=new Uint32Array(t.data.buffer),s=e.pixels;for(let e=0;e<s.length;e++){var a=i[e];s[e]=(a>>24&255)<<24|(255&a)<<16|(a>>8&255)<<8|a>>16&255}return e};static fromArchive=(e,t,i=0)=>{var s=new ht(e.read(t+".dat")),a=new ht(e.read("index.dat")),t=(a.pos=s.g2,a.g2),e=a.g2,r=[],h=a.g1-1;for(let e=0;e<h;e++)r[e+1]=a.g3,0===r[e+1]&&(r[e+1]=1);for(let e=0;e<i;e++)a.pos+=2,s.pos+=a.g2*a.g2,a.pos+=1;if(s.pos>s.length||a.pos>a.length)throw Error();var l=a.g1,n=a.g1,o=a.g2,c=a.g2,d=new B(o,c),o=(d.cropX=l,d.cropY=n,d.cropW=t,d.cropH=e,a.g1);if(0===o){var u=d.width*d.height;for(let e=0;e<u;e++)d.pixels[e]=r[s.g1]}else if(1===o){var f=d.width;for(let t=0;t<f;t++){var p=d.height;for(let e=0;e<p;e++)d.pixels[t+e*f]=r[s.g1]}}return d};bind(){D.bind(this.pixels,this.width,this.height)}draw(e,t){let i=(e=(e|0)+this.cropX)+(t=(t|0)+this.cropY)*D.width2d,s=0,a=this.height,r=this.width,h=D.width2d-r,l=0;var n;t<D.top&&(n=D.top-t,a-=n,t=D.top,s+=n*r,i+=n*D.width2d),t+a>D.bottom&&(a-=t+a-D.bottom),e<D.left&&(n=D.left-e,r-=n,e=D.left,s+=n,i+=n,l+=n,h+=n),e+r>D.right&&(t=e+r-D.right,r-=t,l+=t,h+=t),0<r&&0<a&&this.copyImageDraw(r,a,this.pixels,s,l,D.pixels,i,h)}drawAlpha(e,t,i){let s=(t=(t|0)+this.cropX)+(i=(i|0)+this.cropY)*D.width2d,a=0,r=this.height,h=this.width,l=D.width2d-h,n=0;var o;i<D.top&&(o=D.top-i,r-=o,i=D.top,a+=o*h,s+=o*D.width2d),i+r>D.bottom&&(r-=i+r-D.bottom),t<D.left&&(o=D.left-t,h-=o,t=D.left,a+=o,s+=o,n+=o,l+=o),t+h>D.right&&(i=t+h-D.right,h-=i,n+=i,l+=i),0<h&&0<r&&this.copyPixelsAlpha(h,r,this.pixels,a,n,D.pixels,s,l,e)}blitOpaque(e,t){let i=(e=(e|0)+this.cropX)+(t=(t|0)+this.cropY)*D.width2d,s=0,a=this.height,r=this.width,h=D.width2d-r,l=0;var n;t<D.top&&(n=D.top-t,a-=n,t=D.top,s+=n*r,i+=n*D.width2d),t+a>D.bottom&&(a-=t+a-D.bottom),e<D.left&&(n=D.left-e,r-=n,e=D.left,s+=n,i+=n,l+=n,h+=n),e+r>D.right&&(t=e+r-D.right,r-=t,l+=t,h+=t),0<r&&0<a&&this.copyImageBlitOpaque(r,a,this.pixels,s,l,D.pixels,i,h)}flipHorizontally(){var i=this.pixels,s=this.width,e=this.height;for(let t=0;t<e;t++){var a=s/2|0;for(let e=0;e<a;e++){var r=e+t*s,h=s-e-1+t*s,l=i[r];i[r]=i[h],i[h]=l}}}flipVertically(){var i=this.pixels,s=this.width,a=this.height;for(let t=0;t<(a/2|0);t++)for(let e=0;e<s;e++){var r=e+t*s,h=e+(a-t-1)*s,l=i[r];i[r]=i[h],i[h]=l}}translate(a,r,h){for(let s=0;s<this.pixels.length;s++){var l=this.pixels[s];if(0!==l){let e=l>>16&255,t=((e+=a)<1?e=1:255<e&&(e=255),l>>8&255),i=((t+=r)<1?t=1:255<t&&(t=255),255&l);(i+=h)<1?i=1:255<i&&(i=255),this.pixels[s]=(e<<16)+(t<<8)+i}}}crop(a,r,h,l){a|=0,r|=0,h|=0,l|=0;try{var n=this.width;let e=0,t=0;var o,c,d,u=this.cropW,f=this.cropH,p=(u<<16)/h|0,m=(f<<16)/l|0;a+=(this.cropX*h+u-1)/u|0,r+=(this.cropY*l+f-1)/f|0,this.cropX*h%u!=0&&(e=(u-this.cropX*h%u<<16)/h|0),this.cropY*l%f!=0&&(t=(f-this.cropY*l%f<<16)/l|0),h=h*(this.width-(e>>16))/u|0,l=l*(this.height-(t>>16))/f|0;let i=a+r*D.width2d,s=D.width2d-h;r<D.top&&(l-=o=D.top-r,r=0,i+=o*D.width2d,t+=m*o),r+l>D.bottom&&(l-=r+l-D.bottom),a<D.left&&(h-=c=D.left-a,a=0,i+=c,e+=p*c,s+=c),a+h>D.right&&(h-=d=a+h-D.right,s+=d),this.scale(h,l,this.pixels,e,t,D.pixels,s,i,n,p,m)}catch(e){}}drawRotatedMasked(t,i,s,l,n,o,a,c,d,u){t|=0,i|=0,s|=0,l|=0;try{var f=-s/2|0,p=-l/2|0,m=(65536*Math.sin(d/326.11)|0)*u>>8,g=(65536*Math.cos(d/326.11)|0)*u>>8;let e=(a<<16)+p*m+f*g,r=p*g-f*m+(c<<16),h=t+i*D.width2d;for(let a=0;a<l;a++){var C=n[a];let t=h+C,i=e+g*C,s=r-m*C;for(let e=-o[a];e<0;e++)D.pixels[t++]=this.pixels[(i>>16)+(s>>16)*this.width],i+=g,s-=m;e+=m,r+=g,h+=D.width2d}}catch(e){}}drawMasked(e,t,i){let s=(e=(e|0)+this.cropX)+(t=(t|0)+this.cropY)*D.width2d,a=0,r=this.height,h=this.width,l=D.width2d-h,n=0;var o;t<D.top&&(o=D.top-t,r-=o,t=D.top,a+=o*h,s+=o*D.width2d),t+r>D.bottom&&(r-=t+r-D.bottom),e<D.left&&(o=D.left-e,h-=o,e=D.left,a+=o,s+=o,n+=o,l+=o),e+h>D.right&&(t=e+h-D.right,h-=t,n+=t,l+=t),0<h&&0<r&&this.copyPixelsMasked(h,r,this.pixels,n,a,D.pixels,s,l,i.pixels)}scale(t,i,s,a,r,h,l,n,o,c,d){try{var u=a;for(let e=-i;e<0;e++){var f=(r>>16)*o;for(let e=-t;e<0;e++){var p=s[(a>>16)+f];0===p?n++:h[n++]=p,a+=c}r+=d,a=u,n+=l}}catch(e){}}copyImageBlitOpaque(t,i,s,a,r,h,l,n){var o=-(t>>2);t=-(3&t);for(let e=-i;e<0;e++){for(let e=o;e<0;e++)h[l++]=s[a++],h[l++]=s[a++],h[l++]=s[a++],h[l++]=s[a++];for(let e=t;e<0;e++)h[l++]=s[a++];l+=n,a+=r}}copyPixelsAlpha(t,i,s,a,r,h,l,n,o){var c=256-o;for(let e=-i;e<0;e++){for(let e=-t;e<0;e++){var d,u=s[a++];0===u?l++:(d=h[l],h[l++]=((16711935&u)*o+(16711935&d)*c&4278255360)+((65280&u)*o+(65280&d)*c&16711680)>>8)}l+=n,a+=r}}copyImageDraw(t,i,s,a,r,h,l,n){var o=-(t>>2);t=-(3&t);for(let e=-i;e<0;e++){for(let e=o;e<0;e++){var c=s[a++];0===c?l++:h[l++]=c,0===(c=s[a++])?l++:h[l++]=c,0===(c=s[a++])?l++:h[l++]=c,0===(c=s[a++])?l++:h[l++]=c}for(let e=t;e<0;e++){var d=s[a++];0===d?l++:h[l++]=d}l+=n,a+=r}}copyPixelsMasked(t,i,s,a,r,h,l,n,o){var c=-(t>>2);t=-(3&t);for(let e=-i;e<0;e++){for(let e=c;e<0;e++){var d=s[r++];0!==d&&0===o[l]?h[l++]=d:l++,0!==(d=s[r++])&&0===o[l]?h[l++]=d:l++,0!==(d=s[r++])&&0===o[l]?h[l++]=d:l++,0!==(d=s[r++])&&0===o[l]?h[l++]=d:l++}for(let e=t;e<0;e++){var u=s[r++];0!==u&&0===o[l]?h[l++]=u:l++}l+=n,r+=a}}}class dt extends I{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static membersWorld=!0;static modelCache=new U(50);static iconCache=new U(200);static unpack=(e,t)=>{this.membersWorld=t,this.dat=new ht(e.read("obj.dat"));var i=new ht(e.read("obj.idx"));this.count=i.g2,this.offsets=new Int32Array(this.count);let s=2;for(let e=0;e<this.count;e++)this.offsets[e]=s,s+=i.g2;this.cache=new lt(10,null);for(let e=0;e<10;e++)this.cache[e]=new dt(-1)};static get=t=>{if(!this.cache||!this.offsets||!this.dat)throw Error("ObjType not loaded!!!");for(let e=0;e<10;e++){var i=this.cache[e];if(i&&i.id===t)return i}this.cachePos=(this.cachePos+1)%10;var e=this.cache[this.cachePos];return this.dat.pos=this.offsets[t],e.id=t,e.reset(),e.decodeType(this.dat),-1!==e.certtemplate&&e.toCertificate(),!this.membersWorld&&e.members&&(e.name="Members Object",e.desc="Login to a members' server to use this object.",e.op=null,e.iop=null),e};static getIcon=(t,i)=>{if(dt.iconCache){let e=dt.iconCache.get(BigInt(t));if(e&&e.cropH!==i&&-1!==e.cropH&&(e.unlink(),e=null),e)return e}let s=dt.get(t);if(s.countobj||(i=-1),s.countobj&&s.countco&&1<i){let t=-1;for(let e=0;e<10;e++)i>=s.countco[e]&&0!==s.countco[e]&&(t=s.countobj[e]);-1!==t&&(s=dt.get(t))}var a=new B(32,32),e=_.centerX,r=_.centerY,h=_.lineOffset,l=D.pixels,n=D.width2d,o=D.height2d,c=D.left,d=D.right,u=D.top,f=D.bottom,p=(_.jagged=!1,D.bind(a.pixels,32,32),D.fillRect(0,0,32,32,ct.BLACK),_.init2D(),s.getInterfaceModel(1)),m=_.sin[s.xan2d]*s.zoom2d>>16,g=_.cos[s.xan2d]*s.zoom2d>>16;p.drawSimple(0,s.yan2d,s.zan2d,s.xan2d,s.xof2d,m+(p.maxY/2|0)+s.yof2d,g+s.yof2d);for(let t=31;0<=t;t--)for(let e=31;0<=e;e--)0===a.pixels[t+32*e]&&(0<t&&1<a.pixels[t+32*e-1]||0<e&&1<a.pixels[t+32*(e-1)]||t<31&&1<a.pixels[t+32*e+1]||e<31&&1<a.pixels[t+32*(e+1)])&&(a.pixels[t+32*e]=1);for(let t=31;0<=t;t--)for(let e=31;0<=e;e--)0===a.pixels[t+32*e]&&0<t&&0<e&&0<a.pixels[t+32*(e-1)-1]&&(a.pixels[t+32*e]=3153952);return-1!==s.certtemplate&&(p=(m=this.getIcon(s.certlink,10)).cropW,g=m.cropH,m.cropW=32,m.cropH=32,m.crop(5,5,22,22),m.cropW=p,m.cropH=g),dt.iconCache?.put(BigInt(t),a),D.bind(l,n,o),D.setBounds(c,u,d,f),_.centerX=e,_.centerY=r,_.lineOffset=h,_.jagged=!0,s.stackable?a.cropW=33:a.cropW=32,a.cropH=i,a};model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2e3;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;decode(e,t){if(1===e)this.model=t.g2;else if(2===e)this.name=t.gjstr;else if(3===e)this.desc=t.gjstr;else if(4===e)this.zoom2d=t.g2;else if(5===e)this.xan2d=t.g2;else if(6===e)this.yan2d=t.g2;else if(7===e)this.xof2d=t.g2b,32767<this.xof2d&&(this.xof2d-=65536);else if(8===e)this.yof2d=t.g2b,32767<this.yof2d&&(this.yof2d-=65536);else if(9===e)this.code9=!0;else if(10===e)this.code10=t.g2;else if(11===e)this.stackable=!0;else if(12===e)this.cost=t.g4;else if(16===e)this.members=!0;else if(23===e)this.manwear=t.g2,this.manwearOffsetY=t.g1b;else if(24===e)this.manwear2=t.g2;else if(25===e)this.womanwear=t.g2,this.womanwearOffsetY=t.g1b;else if(26===e)this.womanwear2=t.g2;else if(30<=e&&e<35)this.op||(this.op=new lt(5,null)),this.op[e-30]=t.gjstr,"hidden"==this.op[e-30]?.toLowerCase()&&(this.op[e-30]=null);else if(35<=e&&e<40)this.iop||(this.iop=new lt(5,null)),this.iop[e-35]=t.gjstr;else if(40===e){var i=t.g1;this.recol_s=new Uint16Array(i),this.recol_d=new Uint16Array(i);for(let e=0;e<i;e++)this.recol_s[e]=t.g2,this.recol_d[e]=t.g2}else 78===e?this.manwear3=t.g2:79===e?this.womanwear3=t.g2:90===e?this.manhead=t.g2:91===e?this.womanhead=t.g2:92===e?this.manhead2=t.g2:93===e?this.womanhead2=t.g2:95===e?this.zan2d=t.g2:97===e?this.certlink=t.g2:98===e?this.certtemplate=t.g2:100<=e&&e<110&&(this.countobj&&this.countco||(this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10)),this.countobj[e-100]=t.g2,this.countco[e-100]=t.g2)}getWornModel(e){let t=this.manwear;if(-1===(t=1===e?this.womanwear:t))return null;let i=this.manwear2,s=this.manwear3,a=(1===e&&(i=this.womanwear2,s=this.womanwear3),ot.model(t));var r,h;if(-1!==i&&(h=ot.model(i),a=-1===s?(r=[a,h],ot.modelFromModels(r,2)):(r=ot.model(s),h=[a,h,r],ot.modelFromModels(h,3))),0===e&&0!==this.manwearOffsetY&&a.translate(this.manwearOffsetY,0,0),1===e&&0!==this.womanwearOffsetY&&a.translate(this.womanwearOffsetY,0,0),this.recol_s&&this.recol_d)for(let e=0;e<this.recol_s.length;e++)a.recolor(this.recol_s[e],this.recol_d[e]);return a}getHeadModel(e){let t=this.manhead;if(-1===(t=1===e?this.womanhead:t))return null;let i=this.manhead2,s=(1===e&&(i=this.womanhead2),ot.model(t));if(-1!==i&&(e=ot.model(i),e=[s,e],s=ot.modelFromModels(e,2)),this.recol_s&&this.recol_d)for(let e=0;e<this.recol_s.length;e++)s.recolor(this.recol_s[e],this.recol_d[e]);return s}getInterfaceModel(i){if(this.countobj&&this.countco&&1<i){let t=-1;for(let e=0;e<10;e++)i>=this.countco[e]&&0!==this.countco[e]&&(t=this.countobj[e]);if(-1!==t)return dt.get(t).getInterfaceModel(1)}if(dt.modelCache){var e=dt.modelCache.get(BigInt(this.id));if(e)return e}var t=ot.model(this.model);if(this.recol_s&&this.recol_d)for(let e=0;e<this.recol_s.length;e++)t.recolor(this.recol_s[e],this.recol_d[e]);return t.calculateNormals(64,768,-50,-10,-50,!0),t.pickable=!0,dt.modelCache?.put(BigInt(this.id),t),t}toCertificate(){var e=dt.get(this.certtemplate),e=(this.model=e.model,this.zoom2d=e.zoom2d,this.xan2d=e.xan2d,this.yan2d=e.yan2d,this.zan2d=e.zan2d,this.xof2d=e.xof2d,this.yof2d=e.yof2d,this.recol_s=e.recol_s,this.recol_d=e.recol_d,dt.get(this.certlink));this.name=e.name,this.members=e.members,this.cost=e.cost;let t="a";var i=(e.name||"").toLowerCase()[0]||"";"a"!=i&&"e"!=i&&"i"!=i&&"o"!=i&&"u"!=i||(t="an"),this.desc=`Swap this note at any bank for ${t} ${e.name}.`,this.stackable=!0}reset(){this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2e3,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.op=null,this.iop=null,this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1}}class Tt extends I{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static modelCache=new U(30);static unpack=e=>{this.dat=new ht(e.read("npc.dat"));var t=new ht(e.read("npc.idx"));this.count=t.g2,this.offsets=new Int32Array(this.count);let i=2;for(let e=0;e<this.count;e++)this.offsets[e]=i,i+=t.g2;this.cache=new lt(20,null);for(let e=0;e<20;e++)this.cache[e]=new Tt(-1)};static get=t=>{if(!this.cache||!this.offsets||!this.dat)throw Error("NpcType not loaded!!!");for(let e=0;e<20;e++){var i=this.cache[e];if(i&&i.id===t)return i}this.cachePos=(this.cachePos+1)%20;var e=this.cache[this.cachePos]=new Tt(t);return this.dat.pos=this.offsets[t],e.decodeType(this.dat),e};name=null;desc=null;size=1;models=null;heads=null;disposeAlpha=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;decode(e,t){if(1===e){var i=t.g1;this.models=new Uint16Array(i);for(let e=0;e<i;e++)this.models[e]=t.g2}else if(2===e)this.name=t.gjstr;else if(3===e)this.desc=t.gjstr;else if(12===e)this.size=t.g1b;else if(13===e)this.readyanim=t.g2;else if(14===e)this.walkanim=t.g2;else if(16===e)this.disposeAlpha=!0;else if(17===e)this.walkanim=t.g2,this.walkanim_b=t.g2,this.walkanim_r=t.g2,this.walkanim_l=t.g2;else if(30<=e&&e<40)this.op||(this.op=new lt(5,null)),this.op[e-30]=t.gjstr,"hidden"==this.op[e-30]?.toLowerCase()&&(this.op[e-30]=null);else if(40===e){var s=t.g1;this.recol_s=new Uint16Array(s),this.recol_d=new Uint16Array(s);for(let e=0;e<s;e++)this.recol_s[e]=t.g2,this.recol_d[e]=t.g2}else if(60===e){var a=t.g1;this.heads=new Uint16Array(a);for(let e=0;e<a;e++)this.heads[e]=t.g2}else 90===e?this.resizex=t.g2:91===e?this.resizey=t.g2:92===e?this.resizez=t.g2:93===e?this.minimap=!1:95===e?this.vislevel=t.g2:97===e?this.resizeh=t.g2:98===e&&(this.resizev=t.g2)}getSequencedModel(e,t,i){var s=null;let a=null;if(Tt.modelCache&&!(a=Tt.modelCache.get(BigInt(this.id)))&&this.models){var r=new lt(this.models.length,null);for(let e=0;e<this.models.length;e++)r[e]=ot.model(this.models[e]);if(a=1===r.length?r[0]:ot.modelFromModels(r,r.length),this.recol_s&&this.recol_d)for(let e=0;e<this.recol_s.length;e++)a?.recolor(this.recol_s[e],this.recol_d[e]);a?.createLabelReferences(),a?.calculateNormals(64,850,-30,-50,-30,!0),a&&Tt.modelCache.put(BigInt(this.id),a)}return a?(s=ot.modelShareAlpha(a,!this.disposeAlpha),-1!==e&&-1!==t?s.applyTransforms(e,t,i):-1!==e&&s.applyTransform(e),128===this.resizeh&&128===this.resizev||s.scale(this.resizeh,this.resizev,this.resizeh),s.calculateBoundsCylinder(),s.labelFaces=null,s.labelVertices=null,1===this.size&&(s.pickable=!0),s):null}getHeadModel(){if(!this.heads)return null;var t=new lt(this.heads.length,null);for(let e=0;e<this.heads.length;e++)t[e]=ot.model(this.heads[e]);let i;if(i=1===t.length?t[0]:ot.modelFromModels(t,t.length),this.recol_s&&this.recol_d)for(let e=0;e<this.recol_s.length;e++)i?.recolor(this.recol_s[e],this.recol_d[e]);return i}}class K extends I{static count=0;static instances=[];static unpack=e=>{var t=new ht(e.read("idk.dat"));this.count=t.g2;for(let e=0;e<this.count;e++)this.instances[e]=new K(e).decodeType(t)};type=-1;models=null;heads=new Int32Array(5).fill(-1);recol_s=new Int32Array(6);recol_d=new Int32Array(6);disable=!1;decode(e,t){if(1===e)this.type=t.g1;else if(2===e){var i=t.g1;this.models=new Int32Array(i);for(let e=0;e<i;e++)this.models[e]=t.g2}else 3===e?this.disable=!0:40<=e&&e<50?this.recol_s[e-40]=t.g2:50<=e&&e<60?this.recol_d[e-50]=t.g2:60<=e&&e<70&&(this.heads[e-60]=t.g2)}getModel(){if(!this.models)return null;var t=new lt(this.models.length,null);for(let e=0;e<this.models.length;e++)t[e]=ot.model(this.models[e]);let i;i=1===t.length?t[0]:ot.modelFromModels(t,t.length);for(let e=0;e<6&&0!==this.recol_s[e];e++)i?.recolor(this.recol_s[e],this.recol_d[e]);return i}getHeadModel(){let t=0;var i=new lt(5,null);for(let e=0;e<5;e++)-1!==this.heads[e]&&(i[t++]=ot.model(this.heads[e]));var s=ot.modelFromModels(i,t);for(let e=0;e<6&&0!==this.recol_s[e];e++)s.recolor(this.recol_s[e],this.recol_d[e]);return s}}class J extends I{static count=0;static instances=[];static modelCache=new U(30);static unpack=e=>{var t=new ht(e.read("spotanim.dat"));this.count=t.g2;for(let e=0;e<this.count;e++)this.instances[e]=new J(e).decodeType(t)};model=0;anim=-1;seq=null;disposeAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;orientation=0;ambient=0;contrast=0;decode(e,t){1===e?this.model=t.g2:2===e?(this.anim=t.g2,R.instances&&(this.seq=R.instances[this.anim])):3===e?this.disposeAlpha=!0:4===e?this.resizeh=t.g2:5===e?this.resizev=t.g2:6===e?this.orientation=t.g2:7===e?this.ambient=t.g1:8===e?this.contrast=t.g1:40<=e&&e<50?this.recol_s[e-40]=t.g2:50<=e&&e<60&&(this.recol_d[e-50]=t.g2)}getModel(){var t=J.modelCache?.get(BigInt(this.id));if(!t){t=ot.model(this.model);for(let e=0;e<6;e++)0!==this.recol_s[0]&&t.recolor(this.recol_s[e],this.recol_d[e]);J.modelCache?.put(BigInt(this.id),t)}return t}}class Q extends I{static count=0;static instances=[];static code3=[];static code3Count=0;static unpack=e=>{var t=new ht(e.read("varp.dat"));this.count=t.g2;for(let e=0;e<this.count;e++)this.instances[e]=new Q(e).decodeType(t)};scope=0;type=0;code3=!1;protect=!0;clientcode=0;code7=0;transmit=!1;code8=!1;decode(e,t){1===e?this.scope=t.g1:2===e?this.type=t.g1:3===e?(this.code3=!0,Q.code3[Q.code3Count++]=this.id):4===e?this.protect=!1:5===e?this.clientcode=t.g2:6===e?this.transmit=!0:7===e?this.code7=t.g4:8===e?this.code8=!0:10===e&&(this.debugname=t.gjstr)}}class ut{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37=t=>{t=t.trim();let i=0n;for(let e=0;e<t.length&&e<12;e++){var s=t.charCodeAt(e);i*=37n,65<=s&&s<=90?i+=BigInt(1+s-65):97<=s&&s<=122?i+=BigInt(1+s-97):48<=s&&s<=57&&(i+=BigInt(27+s-48))}return i};static fromBase37=e=>{if(e<0n||6582952005840035281n<=e)return"invalid_name";if(e%37n===0n)return"invalid_name";let t=0;for(var i=Array(12);0n!==e;){var s=e;e/=37n,i[11-t++]=this.BASE37_LOOKUP[+(""+(s-37n*e))]}return i.slice(12-t).join("")};static toSentenceCase=e=>{var t=[...e.toLowerCase()];let i=!0;for(let e=0;e<t.length;e++){var s=t[e];i&&"a"<=s&&s<="z"&&(t[e]=s.toUpperCase(),i=!1),"."!==s&&"!"!==s||(i=!0)}return t.join("")};static toAsterisks=t=>{let i="";for(let e=0;e<t.length;e++)i+="*";return i};static formatIPv4=e=>(e>>24&255)+"."+(e>>16&255)+"."+(e>>8&255)+"."+(255&e);static formatName=e=>{if(0===e.length)return e;var t=[...e];for(let e=0;e<t.length;e++)"_"===t[e]&&(t[e]=" ",e+1<t.length)&&"a"<=t[e+1]&&t[e+1]<="z"&&(t[e+1]=String.fromCharCode(65+t[e+1].charCodeAt(0)-97));return"a"<=t[0]&&t[0]<="z"&&(t[0]=String.fromCharCode(65+t[0].charCodeAt(0)-97)),t.join("")};static hashCode=e=>{var t=e.toUpperCase();let i=0n;for(let e=0;e<t.length;e++)i=(i=61n*i+BigInt(t.charCodeAt(e))-32n)+(i>>56n)&0xffffffffffffffn;return i}}class ft{static instances=[];static imageCache=null;static modelCache=null;static TYPE_LAYER=0;static TYPE_UNUSED=1;static TYPE_INV=2;static TYPE_RECT=3;static TYPE_TEXT=4;static TYPE_GRAPHIC=5;static TYPE_MODEL=6;static TYPE_INV_TEXT=7;static BUTTON_OK=1;static BUTTON_TARGET=2;static BUTTON_CLOSE=3;static BUTTON_TOGGLE=4;static BUTTON_SELECT=5;static BUTTON_CONTINUE=6;static CC_FRIENDS_START=1;static CC_FRIENDS_END=100;static CC_FRIENDS_UPDATE_START=101;static CC_FRIENDS_UPDATE_END=200;static CC_ADD_FRIEND=201;static CC_DEL_FRIEND=202;static CC_FRIENDS_SIZE=203;static CC_LOGOUT=205;static CC_CHANGE_HEAD_L=300;static CC_CHANGE_HEAD_R=301;static CC_CHANGE_JAW_L=302;static CC_CHANGE_JAW_R=303;static CC_CHANGE_TORSO_L=304;static CC_CHANGE_TORSO_R=305;static CC_CHANGE_ARMS_L=306;static CC_CHANGE_ARMS_R=307;static CC_CHANGE_HANDS_L=308;static CC_CHANGE_HANDS_R=309;static CC_CHANGE_LEGS_L=310;static CC_CHANGE_LEGS_R=311;static CC_CHANGE_FEET_L=312;static CC_CHANGE_FEET_R=313;static CC_RECOLOUR_HAIR_L=314;static CC_RECOLOUR_HAIR_R=315;static CC_RECOLOUR_TORSO_L=316;static CC_RECOLOUR_TORSO_R=317;static CC_RECOLOUR_LEGS_L=318;static CC_RECOLOUR_LEGS_R=319;static CC_RECOLOUR_FEET_L=320;static CC_RECOLOUR_FEET_R=321;static CC_RECOLOUR_SKIN_L=322;static CC_RECOLOUR_SKIN_R=323;static CC_SWITCH_TO_MALE=324;static CC_SWITCH_TO_FEMALE=325;static CC_ACCEPT_DESIGN=326;static CC_DESIGN_PREVIEW=327;static CC_IGNORES_START=401;static CC_IGNORES_END=500;static CC_ADD_IGNORE=501;static CC_DEL_IGNORE=502;static CC_IGNORES_SIZE=503;static CC_REPORT_INPUT=600;static CC_REPORT_RULE1=601;static CC_REPORT_RULE2=602;static CC_REPORT_RULE3=603;static CC_REPORT_RULE4=604;static CC_REPORT_RULE5=605;static CC_REPORT_RULE6=606;static CC_REPORT_RULE7=607;static CC_REPORT_RULE8=608;static CC_REPORT_RULE9=609;static CC_REPORT_RULE10=610;static CC_REPORT_RULE11=611;static CC_REPORT_RULE12=612;static CC_MOD_MUTE=613;static CC_LAST_LOGIN_INFO=650;static CC_UNREAD_MESSAGES=651;static CC_RECOVERY1=652;static CC_RECOVERY2=653;static CC_RECOVERY3=654;static CC_LAST_LOGIN_INFO2=655;static unpack=(e,t,i)=>{this.imageCache=new U(5e4),this.modelCache=new U(5e4);var s=new ht(e.read("data"));let a=-1;for(s.pos+=2;s.pos<s.length;){let e=s.g2;65535===e&&(a=s.g2,e=s.g2);var r=this.instances[e]=new ft,h=(r.id=e,r.layer=a,r.type=s.g1,r.buttonType=s.g1,r.clientCode=s.g2,r.width=s.g2,r.height=s.g2,r.overLayer=s.g1,r.overLayer=0===r.overLayer?-1:(r.overLayer-1<<8)+s.g1,s.g1);if(0<h){r.scriptComparator=new Uint8Array(h),r.scriptOperand=new Uint16Array(h);for(let e=0;e<h;e++)r.scriptComparator[e]=s.g1,r.scriptOperand[e]=s.g2}var l,n,o,c,d,u=s.g1;if(0<u){r.scripts=new lt(u,null);for(let e=0;e<u;e++){var f=s.g2,p=new Uint16Array(f);r.scripts[e]=p;for(let e=0;e<f;e++)p[e]=s.g2}}if(r.type===ft.TYPE_LAYER){r.scroll=s.g2,r.hide=1===s.g1;var m=s.g1;r.childId=Array(m),r.childX=Array(m),r.childY=Array(m);for(let e=0;e<m;e++)r.childId[e]=s.g2,r.childX[e]=s.g2b,r.childY[e]=s.g2b}if(r.type===ft.TYPE_UNUSED&&(s.pos+=3),r.type===ft.TYPE_INV){r.invSlotObjId=new Int32Array(r.width*r.height),r.invSlotObjCount=new Int32Array(r.width*r.height),r.draggable=1===s.g1,r.interactable=1===s.g1,r.usable=1===s.g1,r.marginX=s.g1,r.marginY=s.g1,r.invSlotOffsetX=new Int16Array(20),r.invSlotOffsetY=new Int16Array(20),r.invSlotSprite=new lt(20,null);for(let e=0;e<20;e++)1===s.g1&&(r.invSlotOffsetX[e]=s.g2b,r.invSlotOffsetY[e]=s.g2b,0<(l=s.gjstr).length)&&(n=l.lastIndexOf(","),r.invSlotSprite[e]=this.getImage(t,l.substring(0,n),parseInt(l.substring(1+n),10)));r.iops=new lt(5,null);for(let e=0;e<5;e++){var g=s.gjstr;0===(r.iops[e]=g).length&&(r.iops[e]=null)}}if(r.type===ft.TYPE_RECT&&(r.fill=1===s.g1),r.type!==ft.TYPE_TEXT&&r.type!==ft.TYPE_UNUSED||(r.center=1===s.g1,o=s.g1,i&&(r.font=i[o]),r.shadowed=1===s.g1),r.type===ft.TYPE_TEXT&&(r.text=s.gjstr,r.activeText=s.gjstr),r.type!==ft.TYPE_UNUSED&&r.type!==ft.TYPE_RECT&&r.type!==ft.TYPE_TEXT||(r.colour=s.g4),r.type!==ft.TYPE_RECT&&r.type!==ft.TYPE_TEXT||(r.activeColour=s.g4,r.overColour=s.g4),r.type===ft.TYPE_GRAPHIC&&(0<(o=s.gjstr).length&&(c=o.lastIndexOf(","),r.graphic=this.getImage(t,o.substring(0,c),parseInt(o.substring(1+c),10))),0<(c=s.gjstr).length)&&(d=c.lastIndexOf(","),r.activeGraphic=this.getImage(t,c.substring(0,d),parseInt(c.substring(1+d),10))),r.type===ft.TYPE_MODEL&&(0!==(d=s.g1)&&(r.model=this.getModel((d-1<<8)+s.g1)),0!==(C=s.g1)&&(r.activeModel=this.getModel((C-1<<8)+s.g1)),r.anim=s.g1,0===r.anim?r.anim=-1:r.anim=(r.anim-1<<8)+s.g1,r.activeAnim=s.g1,0===r.activeAnim?r.activeAnim=-1:r.activeAnim=(r.activeAnim-1<<8)+s.g1,r.zoom=s.g2,r.xan=s.g2,r.yan=s.g2),r.type===ft.TYPE_INV_TEXT){r.invSlotObjId=new Int32Array(r.width*r.height),r.invSlotObjCount=new Int32Array(r.width*r.height),r.center=1===s.g1;var C=s.g1;i&&(r.font=i[C]),r.shadowed=1===s.g1,r.colour=s.g4,r.marginX=s.g2b,r.marginY=s.g2b,r.interactable=1===s.g1,r.iops=new lt(5,null);for(let e=0;e<5;e++){var y=s.gjstr;0===(r.iops[e]=y).length&&(r.iops[e]=null)}}r.buttonType!==ft.BUTTON_TARGET&&r.type!==ft.TYPE_INV||(r.actionVerb=s.gjstr,r.action=s.gjstr,r.actionTarget=s.g2),r.buttonType!==ft.BUTTON_OK&&r.buttonType!==ft.BUTTON_TOGGLE&&r.buttonType!==ft.BUTTON_SELECT&&r.buttonType!==ft.BUTTON_CONTINUE||(r.option=s.gjstr,0===r.option.length&&(r.buttonType===ft.BUTTON_OK?r.option="Ok":r.buttonType===ft.BUTTON_TOGGLE||r.buttonType===ft.BUTTON_SELECT?r.option="Select":r.buttonType===ft.BUTTON_CONTINUE&&(r.option="Continue")))}this.imageCache=null,this.modelCache=null};static getImage=(e,t,i)=>{var s=ut.hashCode(t)<<8n|BigInt(i);if(this.imageCache){var a=this.imageCache.get(s);if(a)return a}let r;try{r=B.fromArchive(e,t,i),this.imageCache?.put(s,r)}catch(e){return null}return r};static getModel=e=>{if(this.modelCache){var t=this.modelCache.get(BigInt(e));if(t)return t}t=ot.model(e);return this.modelCache?.put(BigInt(e),t),t};id=-1;layer=-1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;scripts=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;invSlotOffsetX=null;invSlotOffsetY=null;invSlotSprite=null;iops=null;fill=!1;center=!1;font=null;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=null;activeModel=null;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null;x=0;y=0;scrollPosition=0;invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;getModel(e,t,i){let s=this.model;return(s=i?this.activeModel:s)?-1!==e||-1!==t||s.faceColor?(i=ot.modelShareColored(s,!0,!0,!1),-1===e&&-1===t||i.createLabelReferences(),-1!==e&&i.applyTransform(e),-1!==t&&i.applyTransform(t),i.calculateNormals(64,768,-50,-10,-50,!0),i):s:null}getAbsoluteX(){if(this.layer===this.id)return this.x;let e=ft.instances[this.layer];if(!e.childId||!e.childX||!e.childY)return this.x;var t=e.childId.indexOf(this.id);if(-1==t)return this.x;let i=e.childX[t];for(;e.layer!==e.id;){var s=ft.instances[e.layer];s.childId&&s.childX&&s.childY&&-1!=(t=s.childId.indexOf(e.id))&&(i+=s.childX[t]),e=s}return i}getAbsoluteY(){if(this.layer===this.id)return this.y;let e=ft.instances[this.layer];if(!e.childId||!e.childX||!e.childY)return this.y;var t=e.childId.indexOf(this.id);if(-1==t)return this.y;let i=e.childY[t];for(;e.layer!==e.id;){var s=ft.instances[e.layer];s.childId&&s.childX&&s.childY&&-1!=(t=s.childId.indexOf(e.id))&&(i+=s.childY[t]),e=s}return i}outline(e){var t=this.getAbsoluteX(),i=this.getAbsoluteY();D.drawRect(t,i,this.width,this.height,e)}move(e,t){var i,s;this.layer!==this.id&&(this.x=0,this.y=0,(i=ft.instances[this.layer]).childId)&&i.childX&&i.childY&&-1!=(s=i.childId.indexOf(this.id))&&(i.childX[s]=e,i.childY[s]=t)}delete(){var e,t;this.layer!==this.id&&(e=ft.instances[this.layer]).childId&&e.childX&&e.childY&&-1!=(t=e.childId.indexOf(this.id))&&(e.childId.splice(t,1),e.childX.splice(t,1),e.childY.splice(t,1))}}class M{static OPEN=0;static WALL_NORTH_WEST=1;static WALL_NORTH=2;static WALL_NORTH_EAST=4;static WALL_EAST=8;static WALL_SOUTH_EAST=M.WALL_NORTH_WEST<<4;static WALL_SOUTH=M.WALL_NORTH<<4;static WALL_SOUTH_WEST=M.WALL_NORTH_EAST<<4;static WALL_WEST=M.WALL_EAST<<4;static LOC=256;static WALL_NORTH_WEST_PROJ_BLOCKER=512;static WALL_NORTH_PROJ_BLOCKER=1024;static WALL_NORTH_EAST_PROJ_BLOCKER=2048;static WALL_EAST_PROJ_BLOCKER=4096;static WALL_SOUTH_EAST_PROJ_BLOCKER=M.WALL_NORTH_WEST_PROJ_BLOCKER<<4;static WALL_SOUTH_PROJ_BLOCKER=M.WALL_NORTH_PROJ_BLOCKER<<4;static WALL_SOUTH_WEST_PROJ_BLOCKER=M.WALL_NORTH_EAST_PROJ_BLOCKER<<4;static WALL_WEST_PROJ_BLOCKER=M.WALL_EAST_PROJ_BLOCKER<<4;static LOC_PROJ_BLOCKER=M.LOC<<9;static ANTIMACRO=524288;static FLOOR=2097152;static FLOOR_BLOCKED=M.FLOOR|M.ANTIMACRO;static WALK_BLOCKED=M.LOC|M.FLOOR_BLOCKED;static BLOCK_SOUTH=M.WALL_NORTH|M.WALK_BLOCKED;static BLOCK_WEST=M.WALL_EAST|M.WALK_BLOCKED;static BLOCK_SOUTH_WEST=M.WALL_NORTH|M.WALL_NORTH_EAST|M.BLOCK_WEST;static BLOCK_NORTH=M.WALL_SOUTH|M.WALK_BLOCKED;static BLOCK_NORTH_WEST=M.WALL_EAST|M.WALL_SOUTH_EAST|M.BLOCK_NORTH;static BLOCK_EAST=M.WALL_WEST|M.WALK_BLOCKED;static BLOCK_SOUTH_EAST=M.WALL_NORTH_WEST|M.WALL_NORTH|M.BLOCK_EAST;static BLOCK_NORTH_EAST=M.WALL_SOUTH|M.WALL_SOUTH_WEST|M.BLOCK_EAST;static BOUNDS=16777215}class ${static NORTH=1;static EAST=2;static SOUTH=4;static WEST=8}class pt{static LEVELS=4;static SIZE=104;static index=(e,t)=>e*pt.SIZE+t;offsetX;offsetZ;sizeX;sizeZ;flags;constructor(){this.offsetX=0,this.offsetZ=0,this.sizeX=pt.SIZE,this.sizeZ=pt.SIZE,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset=()=>{for(let t=0;t<this.sizeX;t++)for(let e=0;e<this.sizeZ;e++){var i=pt.index(t,e);0===t||0===e||t===this.sizeX-1||e===this.sizeZ-1?this.flags[i]=M.BOUNDS:this.flags[i]=M.OPEN}};addFloor=(e,t)=>{this.flags[pt.index(e-this.offsetX,t-this.offsetZ)]|=M.FLOOR};removeFloor=(e,t)=>{this.flags[pt.index(e-this.offsetX,t-this.offsetZ)]&=~M.FLOOR};addLoc=(e,t,i,s,a,r)=>{let h=M.LOC;r&&(h|=M.LOC_PROJ_BLOCKER);var l=e-this.offsetX,n=t-this.offsetZ;a!==N.NORTH&&a!==N.SOUTH||(r=i,i=s,s=r);for(let t=l;t<l+i;t++)if(0<=t&&t<this.sizeX)for(let e=n;e<n+s;e++)0<=e&&e<this.sizeZ&&this.add(t,e,h)};removeLoc=(e,t,i,s,a,r)=>{let h=M.LOC;r&&(h|=M.LOC_PROJ_BLOCKER);var l=e-this.offsetX,n=t-this.offsetZ;a!==N.NORTH&&a!==N.SOUTH||(r=i,i=s,s=r);for(let t=l;t<l+i;t++)if(0<=t&&t<this.sizeX)for(let e=n;e<n+s;e++)0<=e&&e<this.sizeZ&&this.remove(t,e,h)};addWall=(e,t,i,s,a)=>{var r=e-this.offsetX,h=t-this.offsetZ,l=a?M.WALL_WEST_PROJ_BLOCKER:M.WALL_WEST,n=a?M.WALL_EAST_PROJ_BLOCKER:M.WALL_EAST,o=a?M.WALL_NORTH_PROJ_BLOCKER:M.WALL_NORTH,c=a?M.WALL_SOUTH_PROJ_BLOCKER:M.WALL_SOUTH,d=a?M.WALL_NORTH_WEST_PROJ_BLOCKER:M.WALL_NORTH_WEST,u=a?M.WALL_SOUTH_EAST_PROJ_BLOCKER:M.WALL_SOUTH_EAST,f=a?M.WALL_NORTH_EAST_PROJ_BLOCKER:M.WALL_NORTH_EAST,p=a?M.WALL_SOUTH_WEST_PROJ_BLOCKER:M.WALL_SOUTH_WEST;i===k.WALL_STRAIGHT.id?s===N.WEST?(this.add(r,h,l),this.add(r-1,h,n)):s===N.NORTH?(this.add(r,h,o),this.add(r,1+h,c)):s===N.EAST?(this.add(r,h,n),this.add(1+r,h,l)):s===N.SOUTH&&(this.add(r,h,c),this.add(r,h-1,o)):i===k.WALL_DIAGONAL_CORNER.id||i===k.WALL_SQUARE_CORNER.id?s===N.WEST?(this.add(r,h,d),this.add(r-1,1+h,u)):s===N.NORTH?(this.add(r,h,f),this.add(1+r,1+h,p)):s===N.EAST?(this.add(r,h,u),this.add(1+r,h-1,d)):s===N.SOUTH&&(this.add(r,h,p),this.add(r-1,h-1,f)):i===k.WALL_L.id&&(s===N.WEST?(this.add(r,h,o|l),this.add(r-1,h,n),this.add(r,1+h,c)):s===N.NORTH?(this.add(r,h,o|n),this.add(r,1+h,c),this.add(1+r,h,l)):s===N.EAST?(this.add(r,h,c|n),this.add(1+r,h,l),this.add(r,h-1,o)):s===N.SOUTH&&(this.add(r,h,c|l),this.add(r,h-1,o),this.add(r-1,h,n))),a&&this.addWall(e,t,i,s,!1)};removeWall=(e,t,i,s,a)=>{var r=e-this.offsetX,h=t-this.offsetZ,l=a?M.WALL_WEST_PROJ_BLOCKER:M.WALL_WEST,n=a?M.WALL_EAST_PROJ_BLOCKER:M.WALL_EAST,o=a?M.WALL_NORTH_PROJ_BLOCKER:M.WALL_NORTH,c=a?M.WALL_SOUTH_PROJ_BLOCKER:M.WALL_SOUTH,d=a?M.WALL_NORTH_WEST_PROJ_BLOCKER:M.WALL_NORTH_WEST,u=a?M.WALL_SOUTH_EAST_PROJ_BLOCKER:M.WALL_SOUTH_EAST,f=a?M.WALL_NORTH_EAST_PROJ_BLOCKER:M.WALL_NORTH_EAST,p=a?M.WALL_SOUTH_WEST_PROJ_BLOCKER:M.WALL_SOUTH_WEST;i===k.WALL_STRAIGHT.id?s===N.WEST?(this.remove(r,h,l),this.remove(r-1,h,n)):s===N.NORTH?(this.remove(r,h,o),this.remove(r,1+h,c)):s===N.EAST?(this.remove(r,h,n),this.remove(1+r,h,l)):s===N.SOUTH&&(this.remove(r,h,c),this.remove(r,h-1,o)):i===k.WALL_DIAGONAL_CORNER.id||i===k.WALL_SQUARE_CORNER.id?s===N.WEST?(this.remove(r,h,d),this.remove(r-1,1+h,u)):s===N.NORTH?(this.remove(r,h,f),this.remove(1+r,1+h,p)):s===N.EAST?(this.remove(r,h,u),this.remove(1+r,h-1,d)):s===N.SOUTH&&(this.remove(r,h,p),this.remove(r-1,h-1,f)):i===k.WALL_L.id&&(s===N.WEST?(this.remove(r,h,o|l),this.remove(r-1,h,n),this.remove(r,1+h,c)):s===N.NORTH?(this.remove(r,h,o|n),this.remove(r,1+h,c),this.remove(1+r,h,l)):s===N.EAST?(this.remove(r,h,c|n),this.remove(1+r,h,l),this.remove(r,h-1,o)):s===N.SOUTH&&(this.remove(r,h,c|l),this.remove(r,h-1,o),this.remove(r-1,h,n))),a&&this.removeWall(e,t,i,s,!1)};reachedWall=(e,t,i,s,a,r)=>{if(e===i&&t===s)return!0;var e=e-this.offsetX,t=t-this.offsetZ,i=i-this.offsetX,s=s-this.offsetZ,h=pt.index(e,t);if(a===k.WALL_STRAIGHT.id){if(r===N.WEST){if(e==i-1&&t==s)return!0;if(e==i&&t==1+s&&(this.flags[h]&M.BLOCK_NORTH)===M.OPEN)return!0;if(e==i&&t==s-1&&(this.flags[h]&M.BLOCK_SOUTH)===M.OPEN)return!0}else if(r===N.NORTH){if(e==i&&t==1+s)return!0;if(e==i-1&&t==s&&(this.flags[h]&M.BLOCK_WEST)===M.OPEN)return!0;if(e==1+i&&t==s&&(this.flags[h]&M.BLOCK_EAST)===M.OPEN)return!0}else if(r===N.EAST){if(e==1+i&&t==s)return!0;if(e==i&&t==1+s&&(this.flags[h]&M.BLOCK_NORTH)===M.OPEN)return!0;if(e==i&&t==s-1&&(this.flags[h]&M.BLOCK_SOUTH)===M.OPEN)return!0}else if(r===N.SOUTH){if(e==i&&t==s-1)return!0;if(e==i-1&&t==s&&(this.flags[h]&M.BLOCK_WEST)===M.OPEN)return!0;if(e==1+i&&t==s&&(this.flags[h]&M.BLOCK_EAST)===M.OPEN)return!0}}else if(a===k.WALL_L.id){if(r===N.WEST){if(e==i-1&&t==s)return!0;if(e==i&&t==1+s)return!0;if(e==1+i&&t==s&&(this.flags[h]&M.BLOCK_EAST)===M.OPEN)return!0;if(e==i&&t==s-1&&(this.flags[h]&M.BLOCK_SOUTH)===M.OPEN)return!0}else if(r===N.NORTH){if(e==i-1&&t==s&&(this.flags[h]&M.BLOCK_WEST)===M.OPEN)return!0;if(e==i&&t==1+s)return!0;if(e==1+i&&t==s)return!0;if(e==i&&t==s-1&&(this.flags[h]&M.BLOCK_SOUTH)===M.OPEN)return!0}else if(r===N.EAST){if(e==i-1&&t==s&&(this.flags[h]&M.BLOCK_WEST)===M.OPEN)return!0;if(e==i&&t==1+s&&(this.flags[h]&M.BLOCK_NORTH)===M.OPEN)return!0;if(e==1+i&&t==s)return!0;if(e==i&&t==s-1)return!0}else if(r===N.SOUTH){if(e==i-1&&t==s)return!0;if(e==i&&t==1+s&&(this.flags[h]&M.BLOCK_NORTH)===M.OPEN)return!0;if(e==1+i&&t==s&&(this.flags[h]&M.BLOCK_EAST)===M.OPEN)return!0;if(e==i&&t==s-1)return!0}}else if(a===k.WALL_DIAGONAL.id){if(e==i&&t==1+s&&(this.flags[h]&M.WALL_SOUTH)===M.OPEN)return!0;if(e==i&&t==s-1&&(this.flags[h]&M.WALL_NORTH)===M.OPEN)return!0;if(e==i-1&&t==s&&(this.flags[h]&M.WALL_EAST)===M.OPEN)return!0;if(e==1+i&&t==s&&(this.flags[h]&M.WALL_WEST)===M.OPEN)return!0}return!1};reachedWallDecoration=(e,t,i,s,a,r)=>{if(e===i&&t===s)return!0;var e=e-this.offsetX,t=t-this.offsetZ,i=i-this.offsetX,s=s-this.offsetZ,h=pt.index(e,t);if(a===k.WALLDECOR_DIAGONAL_OFFSET.id||a===k.WALLDECOR_DIAGONAL_NOOFFSET.id){if((r=a===k.WALLDECOR_DIAGONAL_NOOFFSET.id?r+2&3:r)===N.WEST){if(e==1+i&&t==s&&(this.flags[h]&M.WALL_WEST)===M.OPEN)return!0;if(e==i&&t==s-1&&(this.flags[h]&M.WALL_NORTH)===M.OPEN)return!0}else if(r===N.NORTH){if(e==i-1&&t==s&&(this.flags[h]&M.WALL_EAST)===M.OPEN)return!0;if(e==i&&t==s-1&&(this.flags[h]&M.WALL_NORTH)===M.OPEN)return!0}else if(r===N.EAST){if(e==i-1&&t==s&&(this.flags[h]&M.WALL_EAST)===M.OPEN)return!0;if(e==i&&t==1+s&&(this.flags[h]&M.WALL_SOUTH)===M.OPEN)return!0}else if(r===N.SOUTH){if(e==1+i&&t==s&&(this.flags[h]&M.WALL_WEST)===M.OPEN)return!0;if(e==i&&t==1+s&&(this.flags[h]&M.WALL_SOUTH)===M.OPEN)return!0}}else if(a===k.WALLDECOR_DIAGONAL_BOTH.id){if(e==i&&t==1+s&&(this.flags[h]&M.WALL_SOUTH)===M.OPEN)return!0;if(e==i&&t==s-1&&(this.flags[h]&M.WALL_NORTH)===M.OPEN)return!0;if(e==i-1&&t==s&&(this.flags[h]&M.WALL_EAST)===M.OPEN)return!0;if(e==1+i&&t==s&&(this.flags[h]&M.WALL_WEST)===M.OPEN)return!0}return!1};reachedLoc=(e,t,i,s,a,r,h)=>{var a=i+a-1,r=s+r-1,l=pt.index(e-this.offsetX,t-this.offsetZ);return i<=e&&e<=a&&s<=t&&t<=r||e===i-1&&s<=t&&t<=r&&(this.flags[l]&M.WALL_EAST)===M.OPEN&&(h&$.WEST)===M.OPEN||e===1+a&&s<=t&&t<=r&&(this.flags[l]&M.WALL_WEST)===M.OPEN&&(h&$.EAST)===M.OPEN||t===s-1&&i<=e&&e<=a&&(this.flags[l]&M.WALL_NORTH)===M.OPEN&&(h&$.SOUTH)===M.OPEN||t===1+r&&i<=e&&e<=a&&(this.flags[l]&M.WALL_SOUTH)===M.OPEN&&(h&$.NORTH)===M.OPEN};add=(e,t,i)=>{this.flags[pt.index(e,t)]|=i};remove=(e,t,i)=>{this.flags[pt.index(e,t)]&=M.BOUNDS-i}}class ee{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(e,t,i,s,a,r,h,l,n,o,c){this.minTileX=e,this.maxTileX=t,this.minTileZ=i,this.maxTileZ=s,this.type=a,this.minX=r,this.maxX=h,this.minZ=l,this.maxZ=n,this.minY=o,this.maxY=c}}class te{y;x;z;model;bitset;info;constructor(e,t,i,s,a,r){this.y=e,this.x=t,this.z=i,this.model=s,this.bitset=a,this.info=r}}class ie{level;y;x;z;model;entity;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;bitset;info;distance=0;cycle=0;constructor(e,t,i,s,a,r,h,l,n,o,c,d,u){this.level=e,this.y=t,this.x=i,this.z=s,this.model=a,this.entity=r,this.yaw=h,this.minSceneTileX=l,this.maxSceneTileX=n,this.minSceneTileZ=o,this.maxSceneTileZ=c,this.bitset=d,this.info=u}}class se{y;x;z;topObj;middleObj;bottomObj;bitset;offset;constructor(e,t,i,s,a,r,h,l){this.y=e,this.x=t,this.z=i,this.topObj=s,this.middleObj=a,this.bottomObj=r,this.bitset=h,this.offset=l}}class ae extends i{level;x;z;occludeLevel;locs;locSpan;underlay=null;overlay=null;wall=null;wallDecoration=null;groundDecoration=null;objStack=null;bridge=null;locCount=0;locSpans=0;drawLevel=0;visible=!1;update=!1;containsLocs=!1;checkLocSpans=0;blockLocSpans=0;inverseBlockLocSpans=0;backWallTypes=0;constructor(e,t,i){super(),this.occludeLevel=this.level=e,this.x=t,this.z=i,this.locs=new lt(5,null),this.locSpan=new Int32Array(5)}}class Y{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=3*this.FULL_SQUARE/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;angle;backgroundRgb;foregroundRgb;constructor(e,t,l,n,o,c,d,u,i,f,a,p,s,m,g,C,y,r,v){this.flat=!(y!==n||y!==m||y!==u),this.shape=t,this.angle=c,this.backgroundRgb=s,this.foregroundRgb=i;var w=Y.SHAPE_POINTS[t],T=w.length,S=(this.vertexX=new Int32Array(T),this.vertexY=new Int32Array(T),this.vertexZ=new Int32Array(T),new Int32Array(T)),A=new Int32Array(T),O=e*Y.FULL_SQUARE,I=r*Y.FULL_SQUARE;for(let h=0;h<T;h++){let e=w[h];12<(e=8<(e=0==(1&e)&&e<=8?1+(e-c-c-1&7):e)&&e<=12?9+(e-c-9&3):e)&&e<=16&&(e=13+(e-c-13&3));let t,i,s,a,r;r=1===e?(t=O,i=I,s=y,a=d,f):2===e?(t=O+Y.HALF_SQUARE,i=I,s=y+n>>1,a=d+v>>1,f+l>>1):3===e?(t=O+Y.FULL_SQUARE,i=I,s=n,a=v,l):4===e?(t=O+Y.FULL_SQUARE,i=I+Y.HALF_SQUARE,s=n+m>>1,a=v+o>>1,l+g>>1):5===e?(t=O+Y.FULL_SQUARE,i=I+Y.FULL_SQUARE,s=m,a=o,g):6===e?(t=O+Y.HALF_SQUARE,i=I+Y.FULL_SQUARE,s=m+u>>1,a=o+C>>1,g+p>>1):7===e?(t=O,i=I+Y.FULL_SQUARE,s=u,a=C,p):8===e?(t=O,i=I+Y.HALF_SQUARE,s=u+y>>1,a=C+d>>1,p+f>>1):9===e?(t=O+Y.HALF_SQUARE,i=I+Y.CORNER_SMALL,s=y+n>>1,a=d+v>>1,f+l>>1):10===e?(t=O+Y.CORNER_BIG,i=I+Y.HALF_SQUARE,s=n+m>>1,a=v+o>>1,l+g>>1):11===e?(t=O+Y.HALF_SQUARE,i=I+Y.CORNER_BIG,s=m+u>>1,a=o+C>>1,g+p>>1):12===e?(t=O+Y.CORNER_SMALL,i=I+Y.HALF_SQUARE,s=u+y>>1,a=C+d>>1,p+f>>1):13===e?(t=O+Y.CORNER_SMALL,i=I+Y.CORNER_SMALL,s=y,a=d,f):14===e?(t=O+Y.CORNER_BIG,i=I+Y.CORNER_SMALL,s=n,a=v,l):15===e?(t=O+Y.CORNER_BIG,i=I+Y.CORNER_BIG,s=m,a=o,g):(t=O+Y.CORNER_SMALL,i=I+Y.CORNER_BIG,s=u,a=C,p),this.vertexX[h]=t,this.vertexY[h]=s,this.vertexZ[h]=i,S[h]=a,A[h]=r}var h=Y.SHAPE_PATHS[t],L=h.length/4|0;this.triangleVertexA=new Int32Array(L),this.triangleVertexB=new Int32Array(L),this.triangleVertexC=new Int32Array(L),this.triangleColorA=new Int32Array(L),this.triangleColorB=new Int32Array(L),this.triangleColorC=new Int32Array(L),this.triangleTextureIds=-1!==a?new Int32Array(L):null;let b=0;for(let s=0;s<L;s++){var E=h[b];let e=h[b+1],t=h[b+2],i=h[b+3];b+=4,e<4&&(e=e-c&3),t<4&&(t=t-c&3),i<4&&(i=i-c&3),this.triangleVertexA[s]=e,this.triangleVertexB[s]=t,this.triangleVertexC[s]=i,0===E?(this.triangleColorA[s]=S[e],this.triangleColorB[s]=S[t],this.triangleColorC[s]=S[i],this.triangleTextureIds&&(this.triangleTextureIds[s]=-1)):(this.triangleColorA[s]=A[e],this.triangleColorB[s]=A[t],this.triangleColorC[s]=A[i],this.triangleTextureIds&&(this.triangleTextureIds[s]=a))}}}class re{static PLAIN=0;static DIAGONAL=1;static LEFT_SEMI_DIAGONAL_SMALL=2;static RIGHT_SEMI_DIAGONAL_SMALL=3;static LEFT_SEMI_DIAGONAL_BIG=4;static RIGHT_SEMI_DIAGONAL_BIG=5;static HALF_SQUARE=6;static CORNER_SMALL=7;static CORNER_BIG=8;static FAN_SMALL=9;static FAN_BIG=10;static TRAPEZIUM=11}class he{southwestColor;southeastColor;northeastColor;northwestColor;textureId;color;flat;constructor(e,t,i,s,a,r,h){this.southwestColor=e,this.southeastColor=t,this.northeastColor=i,this.northwestColor=s,this.textureId=a,this.color=r,this.flat=h}}class le{y;x;z;typeA;typeB;modelA;modelB;bitset;info;constructor(e,t,i,s,a,r,h,l,n){this.y=e,this.x=t,this.z=i,this.typeA=s,this.typeB=a,this.modelA=r,this.modelB=h,this.bitset=l,this.info=n}}class ne{y;x;z;type;angle;model;bitset;info;constructor(e,t,i,s,a,r,h,l){this.y=e,this.x=t,this.z=i,this.type=s,this.angle=a,this.model=r,this.bitset=h,this.info=l}}class X{static visibilityMatrix=new v(8,32,51,51,!1);static locBuffer=new lt(100,null);static levelOccluderCount=new Int32Array(pt.LEVELS);static levelOccluders=new C(pt.LEVELS,500,null);static activeOccluders=new lt(500,null);static drawTileQueue=new O;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=!1;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS=Int8Array.of(0,0,2,0,0,2,1,1,0);static WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS=Int8Array.of(2,0,0,2,0,0,0,4,4);static WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS=Int8Array.of(0,4,4,8,0,0,8,0,0);static WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=!0;static init=(e,t,s,a,r)=>{this.viewportLeft=0,this.viewportTop=0,this.viewportRight=e,this.viewportBottom=t,this.viewportCenterX=e/2|0,this.viewportCenterY=t/2|0;var l=new v(9,32,53,53,!1);for(let t=128;t<=384;t+=32)for(let e=0;e<2048;e+=64){this.sinEyePitch=_.sin[t],this.cosEyePitch=_.cos[t],this.sinEyeYaw=_.sin[e],this.cosEyeYaw=_.cos[e];var h=(t-128)/32|0,n=e/64|0;for(let i=-26;i<=26;i++)for(let e=-26;e<=26;e++){var o=128*i,c=128*e;let t=!1;for(let e=-s;e<=a;e+=128)if(this.testPoint(o,c,r[h]+e)){t=!0;break}l[h][n][i+25+1][e+25+1]=t}}for(let h=0;h<8;h++)for(let r=0;r<32;r++)for(let a=-25;a<25;a++)for(let s=-25;s<25;s++){let i=!1;e:for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++){if(l[h][r][a+t+25+1][s+e+25+1]){i=!0;break e}if(l[h][(r+1)%31][a+t+25+1][s+e+25+1]){i=!0;break e}if(l[h+1][r][a+t+25+1][s+e+25+1]){i=!0;break e}if(l[h+1][(r+1)%31][a+t+25+1][s+e+25+1]){i=!0;break e}}this.visibilityMatrix[h][r][a+25][s+25]=i}};static addOccluder=(e,t,i,s,a,r,h,l)=>{X.levelOccluders[e][X.levelOccluderCount[e]++]=new ee(i/128|0,r/128|0,a/128|0,l/128|0,t,i,r,a,l,s,h)};static testPoint=(e,t,i)=>{var s=t*this.sinEyeYaw+e*this.cosEyeYaw>>16,t=t*this.cosEyeYaw-e*this.sinEyeYaw>>16,e=i*this.sinEyePitch+t*this.cosEyePitch>>16,i=i*this.cosEyePitch-t*this.sinEyePitch>>16;return!(e<50||3500<e)&&(t=this.viewportCenterX+((s<<9)/e|0),s=this.viewportCenterY+((i<<9)/e|0),t>=this.viewportLeft)&&t<=this.viewportRight&&s>=this.viewportTop&&s<=this.viewportBottom};maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;temporaryLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;temporaryLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(e,t,i,s){this.maxLevel=i,this.maxTileX=s,this.maxTileZ=t,this.levelTiles=new y(i,s,t,null),this.levelTileOcclusionCycles=new Z(i,s+1,t+1),this.levelHeightmaps=e,this.temporaryLocs=new lt(5e3,null),this.mergeIndexA=new Int32Array(1e4),this.mergeIndexB=new Int32Array(1e4),this.reset()}reset=()=>{for(let i=0;i<this.maxLevel;i++)for(let t=0;t<this.maxTileX;t++)for(let e=0;e<this.maxTileZ;e++)this.levelTiles[i][t][e]=null;for(let t=0;t<pt.LEVELS;t++){for(let e=0;e<X.levelOccluderCount[t];e++)X.levelOccluders[t][e]=null;X.levelOccluderCount[t]=0}for(let e=0;e<this.temporaryLocCount;e++)this.temporaryLocs[e]=null;this.temporaryLocCount=0,X.locBuffer.fill(null)};setMinLevel=i=>{this.minLevel=i;for(let t=0;t<this.maxTileX;t++)for(let e=0;e<this.maxTileZ;e++)this.levelTiles[i][t][e]=new ae(i,t,e)};setBridge=(t,i)=>{var e=this.levelTiles[0][t][i];for(let e=0;e<3;e++){this.levelTiles[e][t][i]=this.levelTiles[e+1][t][i];var s=this.levelTiles[e][t][i];s&&s.level--}this.levelTiles[0][t][i]||(this.levelTiles[0][t][i]=new ae(0,t,i));var a=this.levelTiles[0][t][i];a&&(a.bridge=e),this.levelTiles[3][t][i]=null};setDrawLevel=(e,t,i,s)=>{e=this.levelTiles[e][t][i];e&&(e.drawLevel=s)};setTile=(t,i,s,e,a,r,h,l,n,o,c,d,u,f,p,m,g,C,y,v)=>{if(e===re.PLAIN){for(let e=t;0<=e;e--)this.levelTiles[e][i][s]||(this.levelTiles[e][i][s]=new ae(e,i,s));var w=this.levelTiles[t][i][s];w&&(w.underlay=new he(c,d,u,f,-1,y,!1))}else if(e===re.DIAGONAL){for(let e=t;0<=e;e--)this.levelTiles[e][i][s]||(this.levelTiles[e][i][s]=new ae(e,i,s));w=this.levelTiles[t][i][s];w&&(w.underlay=new he(p,m,g,C,r,v,h===l&&h===n&&h===o))}else{for(let e=t;0<=e;e--)this.levelTiles[e][i][s]||(this.levelTiles[e][i][s]=new ae(e,i,s));w=this.levelTiles[t][i][s];w&&(w.overlay=new Y(i,e,m,l,u,a,c,o,v,p,r,C,y,n,g,f,h,s,d))}};addGroundDecoration=(e,t,i,s,a,r,h)=>{this.levelTiles[t][i][s]||(this.levelTiles[t][i][s]=new ae(t,i,s));t=this.levelTiles[t][i][s];t&&(t.groundDecoration=new te(a,128*i+64,128*s+64,e,r,h))};removeGroundDecoration=(e,t,i)=>{e=this.levelTiles[e][t][i];e&&(e.groundDecoration=null)};addObjStack=(e,t,i,s,a,r,h,l)=>{let n=0;var o=this.levelTiles[s][e][t];if(o)for(let e=0;e<o.locCount;e++){var c=o.locs[e];c&&c.model&&(c=c.model.objRaise)>n&&(n=c)}else this.levelTiles[s][e][t]=new ae(s,e,t);s=this.levelTiles[s][e][t];s&&(s.objStack=new se(i,128*e+64,128*t+64,r,h,l,a,n))};removeObjStack=(e,t,i)=>{e=this.levelTiles[e][t][i];e&&(e.objStack=null)};addWall=(t,i,s,e,a,r,h,l,n,o)=>{if(h||l){for(let e=t;0<=e;e--)this.levelTiles[e][i][s]||(this.levelTiles[e][i][s]=new ae(e,i,s));t=this.levelTiles[t][i][s];t&&(t.wall=new le(e,128*i+64,128*s+64,a,r,h,l,n,o))}};removeWall=(e,t,i,s)=>{e=this.levelTiles[e][t][i];1===s&&e&&(e.wall=null)};setWallDecoration=(t,i,s,e,a,r,h,l,n,o,c)=>{if(l){for(let e=t;0<=e;e--)this.levelTiles[e][i][s]||(this.levelTiles[e][i][s]=new ae(e,i,s));t=this.levelTiles[t][i][s];t&&(t.wallDecoration=new ne(e,128*i+a+64,128*s+r+64,c,o,l,h,n))}};removeWallDecoration=(e,t,i)=>{e=this.levelTiles[e][t][i];e&&(e.wallDecoration=null)};setWallDecorationOffset=(e,t,i,s)=>{var e=this.levelTiles[e][t][i];e&&(e=e.wallDecoration)&&(i=128*i+64,e.x=(t=128*t+64)+((e.x-t)*s/16|0),e.z=i+((e.z-i)*s/16|0))};setWallDecorationModel=(e,t,i,s)=>{s&&(e=this.levelTiles[e][t][i])&&(t=e.wallDecoration)&&(t.model=s)};setGroundDecorationModel=(e,t,i,s)=>{s&&(e=this.levelTiles[e][t][i])&&(t=e.groundDecoration)&&(t.model=s)};setWallModel=(e,t,i,s)=>{s&&(e=this.levelTiles[e][t][i])&&(t=e.wall)&&(t.modelA=s)};setWallModels=(e,t,i,s,a)=>{s&&(i=this.levelTiles[i][e][t])&&(e=i.wall)&&(e.modelA=s,e.modelB=a)};addLoc=(e,t,i,s,a,r,h,l,n,o,c)=>!a&&!r||this.addLoc2(128*t+64*n,128*i+64*o,s,e,t,i,n,o,a,r,h,l,c,!1);addTemporary=(e,t,i,s,a,r,h,l,n,o)=>{if(!a&&!r)return!0;let c=t-n,d=s-n,u=t+n,f=s+n;return o&&(640<l&&l<1408&&(f+=128),1152<l&&l<1920&&(u+=128),(1664<l||l<384)&&(d-=128),128<l)&&l<896&&(c-=128),c=c/128|0,d=d/128|0,u=u/128|0,f=f/128|0,this.addLoc2(t,s,i,e,c,d,u+1-c,f-d+1,a,r,h,0,l,!0)};addTemporary2=(e,t,i,s,a,r,h,l,n,o,c,d)=>!n&&!o||this.addLoc2(t,s,i,e,a,r,h+1-a,l-r+1,n,o,c,0,d,!0);removeLoc=(e,t,i)=>{var s=this.levelTiles[e][t][i];if(s)for(let e=0;e<s.locCount;e++){var a=s.locs[e];if(a&&2==(a.bitset>>29&3)&&a.minSceneTileX===t&&a.minSceneTileZ===i)return void this.removeLoc2(a)}};setLocModel=(e,t,i,s)=>{if(s){var a=this.levelTiles[e][t][i];if(a)for(let e=0;e<a.locCount;e++){var r=a.locs[e];if(r&&2==(r.bitset>>29&3))return void(r.model=s)}}};clearTemporaryLocs=()=>{for(let e=0;e<this.temporaryLocCount;e++){var t=this.temporaryLocs[e];t&&this.removeLoc2(t),this.temporaryLocs[e]=null}this.temporaryLocCount=0};getWallBitset=(e,t,i)=>{e=this.levelTiles[e][t][i];return e&&e.wall?e.wall.bitset:0};getWallDecorationBitset=(e,t,i)=>{e=this.levelTiles[e][i][t];return e&&e.wallDecoration?e.wallDecoration.bitset:0};getLocBitset=(e,t,i)=>{var s=this.levelTiles[e][t][i];if(s)for(let e=0;e<s.locCount;e++){var a=s.locs[e];if(a&&2==(a.bitset>>29&3)&&a.minSceneTileX===t&&a.minSceneTileZ===i)return a.bitset}return 0};getGroundDecorationBitset=(e,t,i)=>{e=this.levelTiles[e][t][i];return e&&e.groundDecoration?e.groundDecoration.bitset:0};getInfo=(e,t,i,s)=>{var a=this.levelTiles[e][t][i];if(a){if(a.wall&&a.wall.bitset===s)return 255&a.wall.info;if(a.wallDecoration&&a.wallDecoration.bitset===s)return 255&a.wallDecoration.info;if(a.groundDecoration&&a.groundDecoration.bitset===s)return 255&a.groundDecoration.info;for(let e=0;e<a.locCount;e++){var r=a.locs[e];if(r&&r.bitset===s)return 255&r.info}}return-1};buildModels=(a,e,r,h,l)=>{var n=e*(0|Math.sqrt(r*r+h*h+l*l))>>8;for(let s=0;s<this.maxLevel;s++)for(let i=0;i<this.maxTileX;i++)for(let t=0;t<this.maxTileZ;t++){var o=this.levelTiles[s][i][t];if(o){var c=o.wall;c&&c.modelA&&c.modelA.vertexNormal&&(this.mergeLocNormals(s,i,t,1,1,c.modelA),c.modelB&&c.modelB.vertexNormal&&(this.mergeLocNormals(s,i,t,1,1,c.modelB),this.mergeNormals(c.modelA,c.modelB,0,0,0,!1),c.modelB.applyLighting(a,n,r,h,l)),c.modelA.applyLighting(a,n,r,h,l));for(let e=0;e<o.locCount;e++){var d=o.locs[e];d&&d.model&&d.model.vertexNormal&&(this.mergeLocNormals(s,i,t,d.maxSceneTileX+1-d.minSceneTileX,d.maxSceneTileZ-d.minSceneTileZ+1,d.model),d.model.applyLighting(a,n,r,h,l))}c=o.groundDecoration;c&&c.model&&c.model.vertexNormal&&(this.mergeGroundDecorationNormals(s,i,t,c.model),c.model.applyLighting(a,n,r,h,l))}}};mergeGroundDecorationNormals=(e,t,i,s)=>{var a;t<this.maxTileX&&(a=this.levelTiles[e][t+1][i])&&a.groundDecoration&&a.groundDecoration.model&&a.groundDecoration.model.vertexNormal&&this.mergeNormals(s,a.groundDecoration.model,128,0,0,!0),i<this.maxTileX&&(a=this.levelTiles[e][t][i+1])&&a.groundDecoration&&a.groundDecoration.model&&a.groundDecoration.model.vertexNormal&&this.mergeNormals(s,a.groundDecoration.model,0,0,128,!0),t<this.maxTileX&&i<this.maxTileZ&&(a=this.levelTiles[e][t+1][i+1])&&a.groundDecoration&&a.groundDecoration.model&&a.groundDecoration.model.vertexNormal&&this.mergeNormals(s,a.groundDecoration.model,128,0,128,!0),t<this.maxTileX&&0<i&&(a=this.levelTiles[e][t+1][i-1])&&a.groundDecoration&&a.groundDecoration.model&&a.groundDecoration.model.vertexNormal&&this.mergeNormals(s,a.groundDecoration.model,128,0,-128,!0)};mergeLocNormals=(s,a,r,h,l,n)=>{let o=!0,e=a;var c=a+h,d=r-1,u=r+l;for(let i=s;i<=s+1;i++)if(i!==this.maxLevel){for(let t=e;t<=c;t++)if(!(t<0||t>=this.maxTileX))for(let e=d;e<=u;e++)if(!(e<0||e>=this.maxTileZ||o&&t<c&&e<u&&(e>=r||t===a))){var f=this.levelTiles[i][t][e];if(f){var p=128*(t-a)+64*(1-h),m=128*(e-r)+64*(1-l),g=((this.levelHeightmaps[i][t][e]+this.levelHeightmaps[i][t+1][e]+this.levelHeightmaps[i][t][e+1]+this.levelHeightmaps[i][t+1][e+1])/4|0)-((this.levelHeightmaps[s][a][r]+this.levelHeightmaps[s][a+1][r]+this.levelHeightmaps[s][a][r+1]+this.levelHeightmaps[s][a+1][r+1])/4|0),C=f.wall;C&&C.modelA&&C.modelA.vertexNormal&&this.mergeNormals(n,C.modelA,p,g,m,o),C&&C.modelB&&C.modelB.vertexNormal&&this.mergeNormals(n,C.modelB,p,g,m,o);for(let e=0;e<f.locCount;e++){var y,v=f.locs[e];v&&v.model&&v.model.vertexNormal&&(y=v.maxSceneTileX+1-v.minSceneTileX,this.mergeNormals(n,v.model,128*(v.minSceneTileX-a)+64*(y-h),g,128*(v.minSceneTileZ-r)+64*(v.maxSceneTileZ+1-v.minSceneTileZ-l),o))}}}e--,o=!1}};mergeNormals=(i,s,e,a,r,t)=>{this.tmpMergeIndex++;let h=0;var l=s.vertexX,n=s.vertexCount;if(i.vertexNormal&&i.vertexNormalOriginal)for(let t=0;t<i.vertexCount;t++){var o=i.vertexNormal[t],c=i.vertexNormalOriginal[t];if(c&&0!==c.w){var d=i.vertexY[t]-a;if(!(d>s.minY)){var u=i.vertexX[t]-e;if(!(u<s.minX||u>s.maxX)){var f=i.vertexZ[t]-r;if(!(f<s.minZ||f>s.maxZ)&&s.vertexNormal&&s.vertexNormalOriginal)for(let e=0;e<n;e++){var p=s.vertexNormal[e],m=s.vertexNormalOriginal[e];u!==l[e]||f!==s.vertexZ[e]||d!==s.vertexY[e]||m&&0===m.w||(o&&p&&m&&(o.x+=m.x,o.y+=m.y,o.z+=m.z,o.w+=m.w,p.x+=c.x,p.y+=c.y,p.z+=c.z,p.w+=c.w,h++),this.mergeIndexA[t]=this.tmpMergeIndex,this.mergeIndexB[e]=this.tmpMergeIndex)}}}}}if(!(h<3)&&t){if(i.faceInfo)for(let e=0;e<i.faceCount;e++)this.mergeIndexA[i.faceVertexA[e]]===this.tmpMergeIndex&&this.mergeIndexA[i.faceVertexB[e]]===this.tmpMergeIndex&&this.mergeIndexA[i.faceVertexC[e]]===this.tmpMergeIndex&&(i.faceInfo[e]=-1);if(s.faceInfo)for(let e=0;e<s.faceCount;e++)this.mergeIndexB[s.faceVertexA[e]]===this.tmpMergeIndex&&this.mergeIndexB[s.faceVertexB[e]]===this.tmpMergeIndex&&this.mergeIndexB[s.faceVertexC[e]]===this.tmpMergeIndex&&(s.faceInfo[e]=-1)}};drawMinimapTile=(e,i,s,a,r,h)=>{e=this.levelTiles[e][i][s];if(e){i=e.underlay;if(i){var t=i.color;if(0!==t)for(let e=0;e<4;e++)a[r]=t,a[r+1]=t,a[r+2]=t,a[r+3]=t,r+=h}else{s=e.overlay;if(s){var i=s.shape,e=s.angle,l=s.backgroundRgb,n=s.foregroundRgb,o=X.MINIMAP_TILE_MASK[i],c=X.MINIMAP_TILE_ROTATION_MAP[e];let t=0;if(0!==l)for(let e=0;e<4;e++)a[r]=0===o[c[t++]]?l:n,a[r+1]=0===o[c[t++]]?l:n,a[r+2]=0===o[c[t++]]?l:n,a[r+3]=0===o[c[t++]]?l:n,r+=h;else for(let e=0;e<4;e++)0!==o[c[t++]]&&(a[r]=n),0!==o[c[t++]]&&(a[r+1]=n),0!==o[c[t++]]&&(a[r+2]=n),0!==o[c[t++]]&&(a[r+3]=n),r+=h}}}};click=(e,t)=>{X.takingInput=!0,X.mouseX=e,X.mouseY=t,X.clickTileX=-1,X.clickTileZ=-1};draw=(e,s,t,a,i,r,h)=>{e<0?e=0:e>=128*this.maxTileX&&(e=128*this.maxTileX-1),t<0?t=0:t>=128*this.maxTileZ&&(t=128*this.maxTileZ-1),X.cycle++,X.sinEyePitch=_.sin[r],X.cosEyePitch=_.cos[r],X.sinEyeYaw=_.sin[i],X.cosEyeYaw=_.cos[i],X.visibilityMap=X.visibilityMatrix[(r-128)/32|0][i/64|0],X.eyeX=e,X.eyeY=s,X.eyeZ=t,X.eyeTileX=e/128|0,X.eyeTileZ=t/128|0,X.topLevel=a,X.minDrawTileX=X.eyeTileX-25,X.minDrawTileX<0&&(X.minDrawTileX=0),X.minDrawTileZ=X.eyeTileZ-25,X.minDrawTileZ<0&&(X.minDrawTileZ=0),X.maxDrawTileX=X.eyeTileX+25,X.maxDrawTileX>this.maxTileX&&(X.maxDrawTileX=this.maxTileX),X.maxDrawTileZ=X.eyeTileZ+25,X.maxDrawTileZ>this.maxTileZ&&(X.maxDrawTileZ=this.maxTileZ),this.updateActiveOccluders(),X.tilesRemaining=0;for(let i=this.minLevel;i<this.maxLevel;i++){var l=this.levelTiles[i];for(let t=X.minDrawTileX;t<X.maxDrawTileX;t++)for(let e=X.minDrawTileZ;e<X.maxDrawTileZ;e++){var n=l[t][e];n&&(n.drawLevel<=a&&(X.visibilityMap[t+25-X.eyeTileX][e+25-X.eyeTileZ]||2e3<=this.levelHeightmaps[i][t][e]-s)?(n.visible=!0,n.update=!0,n.containsLocs=0<n.locCount,X.tilesRemaining++):(n.visible=!1,n.update=!1,n.checkLocSpans=0))}}for(let e=this.minLevel;e<this.maxLevel;e++){var o=this.levelTiles[e];for(let e=-25;e<=0;e++){var c=X.eyeTileX+e,d=X.eyeTileX-e;if(!(c<X.minDrawTileX&&d>=X.maxDrawTileX))for(let t=-25;t<=0;t++){var u=X.eyeTileZ+t,f=X.eyeTileZ-t;let e;if(c>=X.minDrawTileX&&(u>=X.minDrawTileZ&&(e=o[c][u])&&e.visible&&this.drawTile(e,!0,h),f<X.maxDrawTileZ)&&(e=o[c][f])&&e.visible&&this.drawTile(e,!0,h),d<X.maxDrawTileX&&(u>=X.minDrawTileZ&&(e=o[d][u])&&e.visible&&this.drawTile(e,!0,h),f<X.maxDrawTileZ)&&(e=o[d][f])&&e.visible&&this.drawTile(e,!0,h),0===X.tilesRemaining)return void(X.takingInput=!1)}}}for(let e=this.minLevel;e<this.maxLevel;e++){var p=this.levelTiles[e];for(let e=-25;e<=0;e++){var m=X.eyeTileX+e,g=X.eyeTileX-e;if(!(m<X.minDrawTileX&&g>=X.maxDrawTileX))for(let t=-25;t<=0;t++){var C=X.eyeTileZ+t,y=X.eyeTileZ-t;let e;if(m>=X.minDrawTileX&&(C>=X.minDrawTileZ&&(e=p[m][C])&&e.visible&&this.drawTile(e,!1,h),y<X.maxDrawTileZ)&&(e=p[m][y])&&e.visible&&this.drawTile(e,!1,h),g<X.maxDrawTileX&&(C>=X.minDrawTileZ&&(e=p[g][C])&&e.visible&&this.drawTile(e,!1,h),y<X.maxDrawTileZ)&&(e=p[g][y])&&e.visible&&this.drawTile(e,!1,h),0===X.tilesRemaining)return void(X.takingInput=!1)}}}};addLoc2=(e,t,i,s,a,r,h,l,n,o,c,d,u,f)=>{if(!n&&!o)return!1;for(let t=a;t<a+h;t++)for(let e=r;e<r+l;e++){if(t<0||e<0||t>=this.maxTileX||e>=this.maxTileZ)return!1;var p=this.levelTiles[s][t][e];if(p&&5<=p.locCount)return!1}var m=new ie(s,i,e,t,n,o,u,a,a+h-1,r,r+l-1,c,d);for(let i=a;i<a+h;i++)for(let t=r;t<r+l;t++){let e=0;i>a&&(e|=1),i<a+h-1&&(e+=4),t>r&&(e+=8),t<r+l-1&&(e+=2);for(let e=s;0<=e;e--)this.levelTiles[e][i][t]||(this.levelTiles[e][i][t]=new ae(e,i,t));var g=this.levelTiles[s][i][t];g&&(g.locs[g.locCount]=m,g.locSpan[g.locCount]=e,g.locSpans|=e,g.locCount++)}return f&&(this.temporaryLocs[this.temporaryLocCount++]=m),!0};removeLoc2=i=>{for(let t=i.minSceneTileX;t<=i.maxSceneTileX;t++)for(let e=i.minSceneTileZ;e<=i.maxSceneTileZ;e++){var s=this.levelTiles[i.level][t][e];if(s){for(let t=0;t<s.locCount;t++)if(s.locs[t]===i){s.locCount--;for(let e=t;e<s.locCount;e++)s.locs[e]=s.locs[e+1],s.locSpan[e]=s.locSpan[e+1];s.locs[s.locCount]=null;break}for(let e=s.locSpans=0;e<s.locCount;e++)s.locSpans|=s.locSpan[e]}}};updateActiveOccluders=()=>{var t=X.levelOccluderCount[X.topLevel],i=X.levelOccluders[X.topLevel];for(let e=X.activeOccluderCount=0;e<t;e++){var h=i[e];if(h){let t,s,a,r;if(1===h.type){if(0<=(t=h.minTileX+25-X.eyeTileX)&&t<=50){(s=h.minTileZ+25-X.eyeTileZ)<0&&(s=0),50<(a=h.maxTileZ+25-X.eyeTileZ)&&(a=50);let e=!1;for(;s<=a;)if(X.visibilityMap&&X.visibilityMap[t][s++]){e=!0;break}if(e){if(32<(r=X.eyeX-h.minX))h.mode=1;else{if(-32<=r)continue;h.mode=2,r=-r}h.minDeltaZ=(h.minZ-X.eyeZ<<8)/r|0,h.maxDeltaZ=(h.maxZ-X.eyeZ<<8)/r|0,h.minDeltaY=(h.minY-X.eyeY<<8)/r|0,h.maxDeltaY=(h.maxY-X.eyeY<<8)/r|0,X.activeOccluders[X.activeOccluderCount++]=h}}}else if(2===h.type){if(0<=(t=h.minTileZ+25-X.eyeTileZ)&&t<=50){(s=h.minTileX+25-X.eyeTileX)<0&&(s=0),50<(a=h.maxTileX+25-X.eyeTileX)&&(a=50);let e=!1;for(;s<=a;)if(X.visibilityMap&&X.visibilityMap[s++][t]){e=!0;break}if(e){if(32<(r=X.eyeZ-h.minZ))h.mode=3;else{if(-32<=r)continue;h.mode=4,r=-r}h.minDeltaX=(h.minX-X.eyeX<<8)/r|0,h.maxDeltaX=(h.maxX-X.eyeX<<8)/r|0,h.minDeltaY=(h.minY-X.eyeY<<8)/r|0,h.maxDeltaY=(h.maxY-X.eyeY<<8)/r|0,X.activeOccluders[X.activeOccluderCount++]=h}}}else if(4===h.type&&128<(t=h.minY-X.eyeY)&&((s=h.minTileZ+25-X.eyeTileZ)<0&&(s=0),50<(a=h.maxTileZ+25-X.eyeTileZ)&&(a=50),s<=a)){let e=h.minTileX+25-X.eyeTileX,i=(e<0&&(e=0),50<(r=h.maxTileX+25-X.eyeTileX)&&(r=50),!1);e:for(let t=e;t<=r;t++)for(let e=s;e<=a;e++)if(X.visibilityMap&&X.visibilityMap[t][e]){i=!0;break e}i&&(h.mode=5,h.minDeltaX=(h.minX-X.eyeX<<8)/t|0,h.maxDeltaX=(h.maxX-X.eyeX<<8)/t|0,h.minDeltaZ=(h.minZ-X.eyeZ<<8)/t|0,h.maxDeltaZ=(h.maxZ-X.eyeZ<<8)/t|0,X.activeOccluders[X.activeOccluderCount++]=h)}}}};drawTile=(a,s,r)=>{for(X.drawTileQueue.addTail(a);;){let a;do{if(!(a=X.drawTileQueue.removeHead()))return}while(!a.update);var h=a.x,l=a.z,n=a.level,o=a.occludeLevel,c=this.levelTiles[n];if(a.visible){if(s){if(0<n){var d=this.levelTiles[n-1][h][l];if(d&&d.update)continue}if(h<=X.eyeTileX&&h>X.minDrawTileX){d=c[h-1][l];if(d&&d.update&&(d.visible||0==(1&a.locSpans)))continue}if(h>=X.eyeTileX&&h<X.maxDrawTileX-1){var u=c[h+1][l];if(u&&u.update&&(u.visible||0==(4&a.locSpans)))continue}if(l<=X.eyeTileZ&&l>X.minDrawTileZ){u=c[h][l-1];if(u&&u.update&&(u.visible||0==(8&a.locSpans)))continue}if(l>=X.eyeTileZ&&l<X.maxDrawTileZ-1){var f=c[h][l+1];if(f&&f.update&&(f.visible||0==(2&a.locSpans)))continue}}else s=!0;if(a.visible=!1,a.bridge){var p=a.bridge,f=(p.underlay?this.tileVisible(0,h,l)||this.drawTileUnderlay(p.underlay,0,h,l,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw):p.overlay&&!this.tileVisible(0,h,l)&&this.drawTileOverlay(h,l,p.overlay,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw),p.wall);f&&f.modelA?.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,f.x-X.eyeX,f.y-X.eyeY,f.z-X.eyeZ,f.bitset);for(let e=0;e<p.locCount;e++){var m=p.locs[e];if(m){let e=m.model;(e=e||(m.entity?.draw(r)??null))?.draw(m.yaw,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,m.x-X.eyeX,m.y-X.eyeY,m.z-X.eyeZ,m.bitset)}}}let e=!1,t=(a.underlay?this.tileVisible(o,h,l)||(e=!0,this.drawTileUnderlay(a.underlay,o,h,l,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw)):a.overlay&&!this.tileVisible(o,h,l)&&(e=!0,this.drawTileOverlay(h,l,a.overlay,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw)),0),i=0;var g=a.wall,C=a.wallDecoration;if((g||C)&&(X.eyeTileX===h?t+=1:X.eyeTileX<h&&(t+=2),X.eyeTileZ===l?t+=3:X.eyeTileZ>l&&(t+=6),i=X.FRONT_WALL_TYPES[t],a.backWallTypes=X.BACK_WALL_TYPES[t]),g&&(0==(g.typeA&X.DIRECTION_ALLOW_WALL_CORNER_TYPE[t])?a.checkLocSpans=0:16===g.typeA?(a.checkLocSpans=3,a.blockLocSpans=X.WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS[t],a.inverseBlockLocSpans=3-a.blockLocSpans):32===g.typeA?(a.checkLocSpans=6,a.blockLocSpans=X.WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS[t],a.inverseBlockLocSpans=6-a.blockLocSpans):64===g.typeA?(a.checkLocSpans=12,a.blockLocSpans=X.WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS[t],a.inverseBlockLocSpans=12-a.blockLocSpans):(a.checkLocSpans=9,a.blockLocSpans=X.WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS[t],a.inverseBlockLocSpans=9-a.blockLocSpans),0==(g.typeA&i)||this.wallVisible(o,h,l,g.typeA)||g.modelA?.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,g.x-X.eyeX,g.y-X.eyeY,g.z-X.eyeZ,g.bitset),0==(g.typeB&i)||this.wallVisible(o,h,l,g.typeB)||g.modelB?.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,g.x-X.eyeX,g.y-X.eyeY,g.z-X.eyeZ,g.bitset)),C&&!this.visible(o,h,l,C.model.maxY))if(0!=(C.type&i))C.model.draw(C.angle,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,C.x-X.eyeX,C.y-X.eyeY,C.z-X.eyeZ,C.bitset);else if(0!=(768&C.type)){var y,v,g=C.x-X.eyeX,w=C.y-X.eyeY,T=C.z-X.eyeZ,S=C.angle;let e;e=S===N.NORTH||S===N.EAST?-g:g;let t;t=S===N.EAST||S===N.SOUTH?-T:T,0!=(256&C.type)&&t<e&&(y=g+X.WALL_DECORATION_INSET_X[S],v=T+X.WALL_DECORATION_INSET_Z[S],C.model.draw(512*S+256,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,y,w,v,C.bitset)),0!=(512&C.type)&&t>e&&(y=g+X.WALL_DECORATION_OUTSET_X[S],v=T+X.WALL_DECORATION_OUTSET_Z[S],C.model.draw(512*S+1280&2047,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,y,w,v,C.bitset))}e&&((g=a.groundDecoration)&&g.model?.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,g.x-X.eyeX,g.y-X.eyeY,g.z-X.eyeZ,g.bitset),T=a.objStack)&&0===T.offset&&(T.bottomObj&&T.bottomObj.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,T.x-X.eyeX,T.y-X.eyeY,T.z-X.eyeZ,T.bitset),T.middleObj&&T.middleObj.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,T.x-X.eyeX,T.y-X.eyeY,T.z-X.eyeZ,T.bitset),T.topObj)&&T.topObj.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,T.x-X.eyeX,T.y-X.eyeY,T.z-X.eyeZ,T.bitset);S=a.locSpans;0!==S&&(h<X.eyeTileX&&0!=(4&S)&&(w=c[h+1][l])&&w.update&&X.drawTileQueue.addTail(w),l<X.eyeTileZ&&0!=(2&S)&&(C=c[h][l+1])&&C.update&&X.drawTileQueue.addTail(C),h>X.eyeTileX&&0!=(1&S)&&(g=c[h-1][l])&&g.update&&X.drawTileQueue.addTail(g),l>X.eyeTileZ)&&0!=(8&S)&&(C=c[h][l-1])&&C.update&&X.drawTileQueue.addTail(C)}if(0!==a.checkLocSpans){let t=!0;for(let e=0;e<a.locCount;e++){var i=a.locs[e];if(i&&(i.cycle!==X.cycle&&(a.locSpan[e]&a.checkLocSpans)===a.blockLocSpans)){t=!1;break}}t&&((g=a.wall)&&!this.wallVisible(o,h,l,g.typeA)&&g.modelA?.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,g.x-X.eyeX,g.y-X.eyeY,g.z-X.eyeZ,g.bitset),a.checkLocSpans=0)}if(a.containsLocs){var Y=a.locCount;a.containsLocs=!1;let s=0;e:for(let e=0;e<Y;e++){var A=a.locs[e];if(A&&A.cycle!==X.cycle){for(let i=A.minSceneTileX;i<=A.maxSceneTileX;i++)for(let t=A.minSceneTileZ;t<=A.maxSceneTileZ;t++){var O=c[i][t];if(O){if(!O.visible){if(0===O.checkLocSpans)continue;let e=0;if(i>A.minSceneTileX&&(e+=1),i<A.maxSceneTileX&&(e+=4),t>A.minSceneTileZ&&(e+=8),t<A.maxSceneTileZ&&(e+=2),(e&O.checkLocSpans)!==a.inverseBlockLocSpans)continue}a.containsLocs=!0;continue e}}X.locBuffer[s++]=A;let e=X.eyeTileX-A.minSceneTileX;var t=A.maxSceneTileX-X.eyeTileX,t=(t>e&&(e=t),X.eyeTileZ-A.minSceneTileZ),I=A.maxSceneTileZ-X.eyeTileZ;A.distance=t<I?e+I:e+t}}for(;;){let t=-50,i=-1;for(let e=0;e<s;e++){var L=X.locBuffer[e];L&&L.cycle!==X.cycle&&L.distance>t&&(t=L.distance,i=e)}if(-1===i)break;var b=X.locBuffer[i];if(b){b.cycle=X.cycle;let e=b.model;(e=e||(b.entity?.draw(r)??null))&&!this.locVisible(o,b.minSceneTileX,b.maxSceneTileX,b.minSceneTileZ,b.maxSceneTileZ,e.maxY)&&e.draw(b.yaw,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,b.x-X.eyeX,b.y-X.eyeY,b.z-X.eyeZ,b.bitset);for(let t=b.minSceneTileX;t<=b.maxSceneTileX;t++)for(let e=b.minSceneTileZ;e<=b.maxSceneTileZ;e++){var E=c[t][e];!E||0===E.checkLocSpans&&(t===h&&e===l||!E.update)||X.drawTileQueue.addTail(E)}}}if(a.containsLocs)continue}if(a.update&&0===a.checkLocSpans){if(h<=X.eyeTileX&&h>X.minDrawTileX){C=c[h-1][l];if(C&&C.update)continue}if(h>=X.eyeTileX&&h<X.maxDrawTileX-1){var e=c[h+1][l];if(e&&e.update)continue}if(l<=X.eyeTileZ&&l>X.minDrawTileZ){e=c[h][l-1];if(e&&e.update)continue}if(l>=X.eyeTileZ&&l<X.maxDrawTileZ-1){var x=c[h][l+1];if(x&&x.update)continue}a.update=!1,X.tilesRemaining--;x=a.objStack;if(x&&0!==x.offset&&(x.bottomObj&&x.bottomObj.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,x.x-X.eyeX,x.y-X.eyeY-x.offset,x.z-X.eyeZ,x.bitset),x.middleObj&&x.middleObj.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,x.x-X.eyeX,x.y-X.eyeY-x.offset,x.z-X.eyeZ,x.bitset),x.topObj)&&x.topObj.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,x.x-X.eyeX,x.y-X.eyeY-x.offset,x.z-X.eyeZ,x.bitset),0!==a.backWallTypes){var _=a.wallDecoration;if(_&&!this.visible(o,h,l,_.model.maxY))if(0!=(_.type&a.backWallTypes))_.model.draw(_.angle,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,_.x-X.eyeX,_.y-X.eyeY,_.z-X.eyeZ,_.bitset);else if(0!=(768&_.type)){var R,k,P=_.x-X.eyeX,B=_.y-X.eyeY,D=_.z-X.eyeZ,M=_.angle;let e;e=M===N.NORTH||M===N.EAST?-P:P;let t;t=M===N.EAST||M===N.SOUTH?-D:D,0!=(256&_.type)&&t>=e&&(R=P+X.WALL_DECORATION_INSET_X[M],k=D+X.WALL_DECORATION_INSET_Z[M],_.model.draw(512*M+256,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,R,B,k,_.bitset)),0!=(512&_.type)&&t<=e&&(R=P+X.WALL_DECORATION_OUTSET_X[M],k=D+X.WALL_DECORATION_OUTSET_Z[M],_.model.draw(512*M+1280&2047,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,R,B,k,_.bitset))}P=a.wall;P&&(0==(P.typeB&a.backWallTypes)||this.wallVisible(o,h,l,P.typeB)||P.modelB?.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,P.x-X.eyeX,P.y-X.eyeY,P.z-X.eyeZ,P.bitset),0==(P.typeA&a.backWallTypes)||this.wallVisible(o,h,l,P.typeA)||P.modelA?.draw(0,X.sinEyePitch,X.cosEyePitch,X.sinEyeYaw,X.cosEyeYaw,P.x-X.eyeX,P.y-X.eyeY,P.z-X.eyeZ,P.bitset))}n<this.maxLevel-1&&(D=this.levelTiles[n+1][h][l])&&D.update&&X.drawTileQueue.addTail(D),h<X.eyeTileX&&(M=c[h+1][l])&&M.update&&X.drawTileQueue.addTail(M),l<X.eyeTileZ&&(B=c[h][l+1])&&B.update&&X.drawTileQueue.addTail(B),h>X.eyeTileX&&(_=c[h-1][l])&&_.update&&X.drawTileQueue.addTail(_),l>X.eyeTileZ&&(n=c[h][l-1])&&n.update&&X.drawTileQueue.addTail(n)}}};drawTileUnderlay=(e,t,i,s,a,r,h,l)=>{var n,o,c,d,u,f,p,m,g=o=128+(A=m=(i<<7)-X.eyeX),C=p=128+(S=n=(s<<7)-X.eyeZ),y=this.levelHeightmaps[t][i][s]-X.eyeY,v=this.levelHeightmaps[t][i+1][s]-X.eyeY,w=this.levelHeightmaps[t][i+1][s+1]-X.eyeY,t=this.levelHeightmaps[t][i][s+1]-X.eyeY,T=S*h+A*l>>16,S=S*l-A*h>>16,A=T;T=y*r-S*a>>16,S=y*a+S*r>>16,y=T,S<50||(T=n*h+g*l>>16,n=n*l-g*h>>16,g=T,T=v*r-n*a>>16,n=v*a+n*r>>16,v=T,n<50)||(T=C*h+o*l>>16,C=C*l-o*h>>16,o=T,T=w*r-C*a>>16,C=w*a+C*r>>16,w=T,C<50)||(T=p*h+m*l>>16,p=p*l-m*h>>16,m=T,T=t*r-p*a>>16,p=t*a+p*r>>16,t=T,p<50)||(l=_.centerX+((A<<9)/S|0),h=_.centerY+((y<<9)/S|0),a=_.centerX+((g<<9)/n|0),r=_.centerY+((v<<9)/n|0),T=_.centerX+((o<<9)/C|0),c=_.centerY+((w<<9)/C|0),d=_.centerX+((m<<9)/p|0),u=_.centerY+((t<<9)/p|0),(_.alpha=0)<(T-d)*(r-u)-(c-u)*(a-d)&&(_.clipX=T<0||d<0||a<0||T>D.boundX||d>D.boundX||a>D.boundX,X.takingInput&&this.pointInsideTriangle(X.mouseX,X.mouseY,c,u,r,T,d,a)&&(X.clickTileX=i,X.clickTileZ=s),-1===e.textureId?12345678!==e.northeastColor&&_.fillGouraudTriangle(T,d,a,c,u,r,e.northeastColor,e.northwestColor,e.southeastColor):X.lowMemory?(f=X.TEXTURE_HSL[e.textureId],_.fillGouraudTriangle(T,d,a,c,u,r,this.mulLightness(f,e.northeastColor),this.mulLightness(f,e.northwestColor),this.mulLightness(f,e.southeastColor))):e.flat?_.fillTexturedTriangle(T,d,a,c,u,r,e.northeastColor,e.northwestColor,e.southeastColor,A,y,S,g,m,v,t,n,p,e.textureId):_.fillTexturedTriangle(T,d,a,c,u,r,e.northeastColor,e.northwestColor,e.southeastColor,o,w,C,m,g,t,v,p,n,e.textureId)),(l-a)*(u-r)-(h-r)*(d-a)<=0)||(_.clipX=l<0||a<0||d<0||l>D.boundX||a>D.boundX||d>D.boundX,X.takingInput&&this.pointInsideTriangle(X.mouseX,X.mouseY,h,r,u,l,a,d)&&(X.clickTileX=i,X.clickTileZ=s),-1!==e.textureId?X.lowMemory?(f=X.TEXTURE_HSL[e.textureId],_.fillGouraudTriangle(l,a,d,h,r,u,this.mulLightness(f,e.southwestColor),this.mulLightness(f,e.southeastColor),this.mulLightness(f,e.northwestColor))):_.fillTexturedTriangle(l,a,d,h,r,u,e.southwestColor,e.southeastColor,e.northwestColor,A,y,S,g,m,v,t,n,p,e.textureId):12345678!==e.southwestColor&&_.fillGouraudTriangle(l,a,d,h,r,u,e.southwestColor,e.southeastColor,e.northwestColor))};drawTileOverlay=(t,i,s,a,r,h,l)=>{let n=s.vertexX.length;for(let e=0;e<n;e++){var o=s.vertexX[e]-X.eyeX,c=s.vertexY[e]-X.eyeY,d=(u=s.vertexZ[e]-X.eyeZ)*h+o*l>>16,u=u*l-o*h>>16,o=d,d=c*r-u*a>>16;if(u=c*a+u*r>>16,c=d,u<50)return;s.triangleTextureIds&&(Y.tmpViewspaceX[e]=o,Y.tmpViewspaceY[e]=c,Y.tmpViewspaceZ[e]=u),Y.tmpScreenX[e]=_.centerX+((o<<9)/u|0),Y.tmpScreenY[e]=_.centerY+((c<<9)/u|0)}_.alpha=0,n=s.triangleVertexA.length;for(let e=0;e<n;e++){var f,p=s.triangleVertexA[e],m=s.triangleVertexB[e],g=s.triangleVertexC[e],C=Y.tmpScreenX[p],y=Y.tmpScreenX[m],v=Y.tmpScreenX[g],w=Y.tmpScreenY[p],T=Y.tmpScreenY[m],S=Y.tmpScreenY[g];0<(C-y)*(S-T)-(w-T)*(v-y)&&(_.clipX=C<0||y<0||v<0||C>D.boundX||y>D.boundX||v>D.boundX,X.takingInput&&this.pointInsideTriangle(X.mouseX,X.mouseY,w,T,S,C,y,v)&&(X.clickTileX=t,X.clickTileZ=i),s.triangleTextureIds&&-1!==s.triangleTextureIds[e]?X.lowMemory?(f=X.TEXTURE_HSL[s.triangleTextureIds[e]],_.fillGouraudTriangle(C,y,v,w,T,S,this.mulLightness(f,s.triangleColorA[e]),this.mulLightness(f,s.triangleColorB[e]),this.mulLightness(f,s.triangleColorC[e]))):s.flat?_.fillTexturedTriangle(C,y,v,w,T,S,s.triangleColorA[e],s.triangleColorB[e],s.triangleColorC[e],Y.tmpViewspaceX[0],Y.tmpViewspaceY[0],Y.tmpViewspaceZ[0],Y.tmpViewspaceX[1],Y.tmpViewspaceX[3],Y.tmpViewspaceY[1],Y.tmpViewspaceY[3],Y.tmpViewspaceZ[1],Y.tmpViewspaceZ[3],s.triangleTextureIds[e]):_.fillTexturedTriangle(C,y,v,w,T,S,s.triangleColorA[e],s.triangleColorB[e],s.triangleColorC[e],Y.tmpViewspaceX[p],Y.tmpViewspaceY[p],Y.tmpViewspaceZ[p],Y.tmpViewspaceX[m],Y.tmpViewspaceX[g],Y.tmpViewspaceY[m],Y.tmpViewspaceY[g],Y.tmpViewspaceZ[m],Y.tmpViewspaceZ[g],s.triangleTextureIds[e]):12345678!==s.triangleColorA[e]&&_.fillGouraudTriangle(C,y,v,w,T,S,s.triangleColorA[e],s.triangleColorB[e],s.triangleColorC[e]))}};tileVisible=(e,t,i)=>{var s,a=this.levelTileOcclusionCycles[e][t][i];return!(a===-X.cycle||a!==X.cycle&&(this.occluded(1+(a=t<<7),this.levelHeightmaps[e][t][i],1+(s=i<<7))&&this.occluded(128+a-1,this.levelHeightmaps[e][t+1][i],1+s)&&this.occluded(128+a-1,this.levelHeightmaps[e][t+1][i+1],128+s-1)&&this.occluded(1+a,this.levelHeightmaps[e][t][i+1],128+s-1)?(this.levelTileOcclusionCycles[e][t][i]=X.cycle,0):(this.levelTileOcclusionCycles[e][t][i]=-X.cycle,1)))};wallVisible=(e,t,i,s)=>{if(!this.tileVisible(e,t,i))return!1;var a=t<<7,r=i<<7,t=this.levelHeightmaps[e][t][i]-1,i=t-120,h=t-230,l=t-238;if(s<16){if(1===s){if(a>X.eyeX){if(!this.occluded(a,t,r))return!1;if(!this.occluded(a,t,128+r))return!1}if(0<e){if(!this.occluded(a,i,r))return!1;if(!this.occluded(a,i,128+r))return!1}return this.occluded(a,h,r)?this.occluded(a,h,128+r):!1}if(2===s){if(r<X.eyeZ){if(!this.occluded(a,t,128+r))return!1;if(!this.occluded(128+a,t,128+r))return!1}if(0<e){if(!this.occluded(a,i,128+r))return!1;if(!this.occluded(128+a,i,128+r))return!1}return this.occluded(a,h,128+r)?this.occluded(128+a,h,128+r):!1}if(4===s){if(a<X.eyeX){if(!this.occluded(128+a,t,r))return!1;if(!this.occluded(128+a,t,128+r))return!1}if(0<e){if(!this.occluded(128+a,i,r))return!1;if(!this.occluded(128+a,i,128+r))return!1}return this.occluded(128+a,h,r)?this.occluded(128+a,h,128+r):!1}if(8===s){if(r>X.eyeZ){if(!this.occluded(a,t,r))return!1;if(!this.occluded(128+a,t,r))return!1}if(0<e){if(!this.occluded(a,i,r))return!1;if(!this.occluded(128+a,i,r))return!1}return this.occluded(a,h,r)?this.occluded(128+a,h,r):!1}}return!!this.occluded(64+a,l,64+r)&&(16===s?this.occluded(a,h,128+r):32===s?this.occluded(128+a,h,128+r):64===s?this.occluded(128+a,h,r):128!==s||this.occluded(a,h,r))};visible=(e,t,i,s)=>{var a,r;return!!this.tileVisible(e,t,i)&&this.occluded(1+(a=t<<7),this.levelHeightmaps[e][t][i]-s,1+(r=i<<7))&&this.occluded(128+a-1,this.levelHeightmaps[e][t+1][i]-s,1+r)&&this.occluded(128+a-1,this.levelHeightmaps[e][t+1][i+1]-s,128+r-1)&&this.occluded(1+a,this.levelHeightmaps[e][t][i+1]-s,128+r-1)};locVisible=(e,t,i,s,a,r)=>{let h,l;if(t===i&&s===a)return!!this.tileVisible(e,t,s)&&(h=t<<7,l=s<<7,this.occluded(h+1,this.levelHeightmaps[e][t][s]-r,l+1))&&this.occluded(h+128-1,this.levelHeightmaps[e][t+1][s]-r,l+1)&&this.occluded(h+128-1,this.levelHeightmaps[e][t+1][s+1]-r,l+128-1)&&this.occluded(h+1,this.levelHeightmaps[e][t][s+1]-r,l+128-1);for(h=t;h<=i;h++)for(l=s;l<=a;l++)if(this.levelTileOcclusionCycles[e][h][l]===-X.cycle)return!1;l=1+(t<<7);var n=2+(s<<7),t=this.levelHeightmaps[e][t][s]-r;return!!this.occluded(l,t,n)&&!!this.occluded(r=(i<<7)-1,t,n)&&(n=(a<<7)-1,!!this.occluded(l,t,n))&&this.occluded(r,t,n)};occluded=(t,i,s)=>{for(let e=0;e<X.activeOccluderCount;e++){var a=X.activeOccluders[e];if(a)if(1===a.mode){var r=a.minX-t;if(0<r){var h=a.minZ+(a.minDeltaZ*r>>8),l=a.maxZ+(a.maxDeltaZ*r>>8),n=a.minY+(a.minDeltaY*r>>8),r=a.maxY+(a.maxDeltaY*r>>8);if(h<=s&&s<=l&&n<=i&&i<=r)return!0}}else if(2===a.mode){h=t-a.minX;if(0<h){var l=a.minZ+(a.minDeltaZ*h>>8),n=a.maxZ+(a.maxDeltaZ*h>>8),r=a.minY+(a.minDeltaY*h>>8),o=a.maxY+(a.maxDeltaY*h>>8);if(l<=s&&s<=n&&r<=i&&i<=o)return!0}}else if(3===a.mode){o=a.minZ-s;if(0<o){var c=a.minX+(a.minDeltaX*o>>8),d=a.maxX+(a.maxDeltaX*o>>8),u=a.minY+(a.minDeltaY*o>>8),f=a.maxY+(a.maxDeltaY*o>>8);if(c<=t&&t<=d&&u<=i&&i<=f)return!0}}else if(4===a.mode){c=s-a.minZ;if(0<c){var d=a.minX+(a.minDeltaX*c>>8),u=a.maxX+(a.maxDeltaX*c>>8),f=a.minY+(a.minDeltaY*c>>8),p=a.maxY+(a.maxDeltaY*c>>8);if(d<=t&&t<=u&&f<=i&&i<=p)return!0}}else if(5===a.mode){p=i-a.minY;if(0<p){var m=a.minX+(a.minDeltaX*p>>8),g=a.maxX+(a.maxDeltaX*p>>8),C=a.minZ+(a.minDeltaZ*p>>8),a=a.maxZ+(a.maxDeltaZ*p>>8);if(m<=t&&t<=g&&C<=s&&s<=a)return!0}}}return!1};pointInsideTriangle=(e,t,i,s,a,r,h,l)=>{var n;return!(t<i&&t<s&&t<a||i<t&&s<t&&a<t||e<r&&e<h&&e<l||r<e&&h<e&&l<e||!(0<((t-i)*(h-r)-(e-r)*(s-i))*(n=(t-s)*(l-h)-(e-h)*(a-s))))&&0<n*((t-a)*(r-l)-(e-l)*(i-a))};mulLightness=(e,t)=>((t=(127-t)*(127&e)/160|0)<2?t=2:126<t&&(t=126),(65408&e)+t)}class A extends i{heightmapSW;heightmapSE;heightmapNE;heightmapNW;index;seq;seqFrame;seqCycle;constructor(e,t,i,s,a,r,h){super(),this.heightmapSW=t,this.heightmapSE=i,this.heightmapNE=s,this.heightmapNW=a,this.index=e,this.seq=r,h&&-1!==r.replayoff&&this.seq.delay?(this.seqFrame=Math.random()*this.seq.frameCount|0,this.seqCycle=Math.random()*this.seq.delay[this.seqFrame]|0):(this.seqFrame=-1,this.seqCycle=0)}}class mt{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(17*Math.random()|0)-8;static randomLightnessOffset=(33*Math.random()|0)-16;static lowMemory=!0;static levelBuilt=0;static fullbright=!1;static perlin=(e,t)=>{let i=this.perlinScale(e+45365,t+91923,4)+(this.perlinScale(e+10294,t+37821,2)-128>>1)+(this.perlinScale(e,t,1)-128>>2)-128;return(i=35+(.3*i|0))<10?i=10:60<i&&(i=60),i};static perlinScale=(e,t,i)=>{var s=e/i|0,e=e&i-1,a=t/i|0,t=t&i-1,r=this.smoothNoise(s,a),h=this.smoothNoise(1+s,a),l=this.smoothNoise(s,1+a),s=this.smoothNoise(1+s,1+a),a=this.interpolate(r,h,e,i),r=this.interpolate(l,s,e,i);return this.interpolate(a,r,t,i)};static interpolate=(e,t,i,s)=>{i=65536-_.cos[1024*i/s|0]>>1;return(e*(65536-i)>>16)+(t*i>>16)};static smoothNoise=(e,t)=>((this.noise(e-1,t-1)+this.noise(e+1,t-1)+this.noise(e-1,t+1)+this.noise(e+1,t+1))/16|0)+((this.noise(e-1,t)+this.noise(e+1,t)+this.noise(e,t-1)+this.noise(e,t+1))/8|0)+(this.noise(e,t)/4|0);static noise=(e,t)=>{e+=57*t,t=BigInt(e<<13^e);return 255&+(""+((t*(t*t*15731n+789221n)+1376312589n&0x7fffffffn)>>19n))};static addLoc=(s,a,r,h,t,i,e,l,n,o,c)=>{var d=t[c][a][r],u=t[c][a+1][r],f=t[c][a+1][r+1],t=t[c][a][r+1],c=d+u+f+t>>2,p=P.get(l);let m=a+(r<<7)+(l<<14)+1073741824|0;p.active||(m+=-2147483648),m|=0;var g=((o<<6)+n|0)<<24>>24;if(n===k.GROUND_DECOR.id)h?.addGroundDecoration(p.getModel(k.GROUND_DECOR.id,o,d,u,f,t,-1),s,a,r,c,m,g),p.blockwalk&&p.active&&e?.addFloor(a,r),-1!==p.anim&&i.addTail(new A(l,s,3,a,r,R.instances[p.anim],!0));else if(n===k.CENTREPIECE_STRAIGHT.id||n===k.CENTREPIECE_DIAGONAL.id){var C=p.getModel(k.CENTREPIECE_STRAIGHT.id,o,d,u,f,t,-1);if(C){let e=0;n===k.CENTREPIECE_DIAGONAL.id&&(e+=256);let t,i;i=o===N.NORTH||o===N.SOUTH?(t=p.length,p.width):(t=p.width,p.length),h?.addLoc(s,a,r,c,C,null,m,g,t,i,e)}p.blockwalk&&e?.addLoc(a,r,p.width,p.length,o,p.blockrange),-1!==p.anim&&i.addTail(new A(l,s,2,a,r,R.instances[p.anim],!0))}else if(n>=k.ROOF_STRAIGHT.id)h?.addLoc(s,a,r,c,p.getModel(n,o,d,u,f,t,-1),null,m,g,1,1,0),p.blockwalk&&e?.addLoc(a,r,p.width,p.length,o,p.blockrange),-1!==p.anim&&i.addTail(new A(l,s,2,a,r,R.instances[p.anim],!0));else if(n===k.WALL_STRAIGHT.id)h?.addWall(s,a,r,c,mt.ROTATION_WALL_TYPE[o],0,p.getModel(k.WALL_STRAIGHT.id,o,d,u,f,t,-1),null,m,g),p.blockwalk&&e?.addWall(a,r,n,o,p.blockrange),-1!==p.anim&&i.addTail(new A(l,s,0,a,r,R.instances[p.anim],!0));else if(n===k.WALL_DIAGONAL_CORNER.id)h?.addWall(s,a,r,c,mt.ROTATION_WALL_CORNER_TYPE[o],0,p.getModel(k.WALL_DIAGONAL_CORNER.id,o,d,u,f,t,-1),null,m,g),p.blockwalk&&e?.addWall(a,r,n,o,p.blockrange),-1!==p.anim&&i.addTail(new A(l,s,0,a,r,R.instances[p.anim],!0));else if(n===k.WALL_L.id){var C=o+1&3;h?.addWall(s,a,r,c,mt.ROTATION_WALL_TYPE[o],mt.ROTATION_WALL_TYPE[C],p.getModel(k.WALL_L.id,o+4,d,u,f,t,-1),p.getModel(k.WALL_L.id,C,d,u,f,t,-1),m,g),p.blockwalk&&e?.addWall(a,r,n,o,p.blockrange),-1!==p.anim&&i.addTail(new A(l,s,0,a,r,R.instances[p.anim],!0))}else if(n===k.WALL_SQUARE_CORNER.id)h?.addWall(s,a,r,c,mt.ROTATION_WALL_CORNER_TYPE[o],0,p.getModel(k.WALL_SQUARE_CORNER.id,o,d,u,f,t,-1),null,m,g),p.blockwalk&&e?.addWall(a,r,n,o,p.blockrange),-1!==p.anim&&i.addTail(new A(l,s,0,a,r,R.instances[p.anim],!0));else if(n===k.WALL_DIAGONAL.id)h?.addLoc(s,a,r,c,p.getModel(n,o,d,u,f,t,-1),null,m,g,1,1,0),p.blockwalk&&e?.addLoc(a,r,p.width,p.length,o,p.blockrange),-1!==p.anim&&i.addTail(new A(l,s,2,a,r,R.instances[p.anim],!0));else if(n===k.WALLDECOR_STRAIGHT_NOOFFSET.id)h?.setWallDecoration(s,a,r,c,0,0,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,d,u,f,t,-1),g,512*o,mt.ROTATION_WALL_TYPE[o]),-1!==p.anim&&i.addTail(new A(l,s,1,a,r,R.instances[p.anim],!0));else if(n===k.WALLDECOR_STRAIGHT_OFFSET.id){let e=16;h&&0<(C=h.getWallBitset(s,a,r))&&(e=P.get(C>>14&32767).wallwidth),h?.setWallDecoration(s,a,r,c,mt.WALL_DECORATION_ROTATION_FORWARD_X[o]*e,mt.WALL_DECORATION_ROTATION_FORWARD_Z[o]*e,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,d,u,f,t,-1),g,512*o,mt.ROTATION_WALL_TYPE[o]),-1!==p.anim&&i.addTail(new A(l,s,1,a,r,R.instances[p.anim],!0))}else n===k.WALLDECOR_DIAGONAL_OFFSET.id?(h?.setWallDecoration(s,a,r,c,0,0,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,d,u,f,t,-1),g,o,256),-1!==p.anim&&i.addTail(new A(l,s,1,a,r,R.instances[p.anim],!0))):n===k.WALLDECOR_DIAGONAL_NOOFFSET.id?(h?.setWallDecoration(s,a,r,c,0,0,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,d,u,f,t,-1),g,o,512),-1!==p.anim&&i.addTail(new A(l,s,1,a,r,R.instances[p.anim],!0))):n===k.WALLDECOR_DIAGONAL_BOTH.id&&(h?.setWallDecoration(s,a,r,c,0,0,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,d,u,f,t,-1),g,o,768),-1!==p.anim)&&i.addTail(new A(l,s,1,a,r,R.instances[p.anim],!0))};maxTileX;maxTileZ;levelHeightmap;levelTileFlags;levelTileUnderlayIds;levelTileOverlayIds;levelTileOverlayShape;levelTileOverlayRotation;levelShademap;levelLightmap;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;levelOccludemap;constructor(e,t,i,s){this.maxTileX=e,this.maxTileZ=t,this.levelHeightmap=i,this.levelTileFlags=s,this.levelTileUnderlayIds=new W(pt.LEVELS,e,t),this.levelTileOverlayIds=new W(pt.LEVELS,e,t),this.levelTileOverlayShape=new W(pt.LEVELS,e,t),this.levelTileOverlayRotation=new W(pt.LEVELS,e,t),this.levelOccludemap=new Z(pt.LEVELS,e+1,t+1),this.levelShademap=new W(pt.LEVELS,e+1,t+1),this.levelLightmap=new w(e+1,t+1),this.blendChroma=new Int32Array(t),this.blendSaturation=new Int32Array(t),this.blendLightness=new Int32Array(t),this.blendLuminance=new Int32Array(t),this.blendMagnitude=new Int32Array(t)}build=(u,a)=>{for(let s=0;s<pt.LEVELS;s++)for(let i=0;i<pt.SIZE;i++)for(let t=0;t<pt.SIZE;t++)if(1==(1&this.levelTileFlags[s][i][t])){let e=s;2==(2&this.levelTileFlags[1][i][t])&&e--,0<=e&&a[e]?.addFloor(i,t)}mt.randomHueOffset+=(5*Math.random()|0)-2,mt.randomHueOffset<-8?mt.randomHueOffset=-8:8<mt.randomHueOffset&&(mt.randomHueOffset=8),mt.randomLightnessOffset+=(5*Math.random()|0)-2,mt.randomLightnessOffset<-16?mt.randomLightnessOffset=-16:16<mt.randomLightnessOffset&&(mt.randomLightnessOffset=16);for(let d=0;d<pt.LEVELS;d++){var i=this.levelShademap[d];for(let t=1;t<this.maxTileZ-1;t++)for(let e=1;e<this.maxTileX-1;e++){var s=this.levelHeightmap[d][e+1][t]-this.levelHeightmap[d][e-1][t],r=this.levelHeightmap[d][e][t+1]-this.levelHeightmap[d][e][t-1],h=0|Math.sqrt(s*s+r*r+65536),l=(i[e-1][t]>>2)+(i[e+1][t]>>3)+(i[e][t-1]>>2)+(i[e][t+1]>>3)+(i[e][t]>>1);this.levelLightmap[e][t]=96+((-50*((s<<8)/h|0)+-10*(65536/h|0)+-50*((r<<8)/h|0))/213|0)-l}for(let e=0;e<this.maxTileZ;e++)this.blendChroma[e]=0,this.blendSaturation[e]=0,this.blendLightness[e]=0,this.blendLuminance[e]=0,this.blendMagnitude[e]=0;for(let c=-5;c<this.maxTileX+5;c++){for(let t=0;t<this.maxTileZ;t++){var n=c+5;let e;0<=n&&n<this.maxTileX&&0<(n=255&this.levelTileUnderlayIds[d][n][t])&&(n=x.instances[n-1],this.blendChroma[t]+=n.chroma,this.blendSaturation[t]+=n.saturation,this.blendLightness[t]+=n.lightness,this.blendLuminance[t]+=n.luminance,e=this.blendMagnitude[t]++);var n=c-5;0<=n&&n<this.maxTileX&&0<(n=255&this.levelTileUnderlayIds[d][n][t])&&(n=x.instances[n-1],this.blendChroma[t]-=n.chroma,this.blendSaturation[t]-=n.saturation,this.blendLightness[t]-=n.lightness,this.blendLuminance[t]-=n.luminance,e=this.blendMagnitude[t]--)}if(1<=c&&c<this.maxTileX-1){let i=0,h=0,l=0,n=0,o=0;for(let r=-5;r<this.maxTileZ+5;r++){var f=r+5,f=(0<=f&&f<this.maxTileZ&&(i+=this.blendChroma[f],h+=this.blendSaturation[f],l+=this.blendLightness[f],n+=this.blendLuminance[f],o+=this.blendMagnitude[f]),r-5);if(0<=f&&f<this.maxTileZ&&(i-=this.blendChroma[f],h-=this.blendSaturation[f],l-=this.blendLightness[f],n-=this.blendLuminance[f],o-=this.blendMagnitude[f]),1<=r&&r<this.maxTileZ-1&&(!mt.lowMemory||0==(16&this.levelTileFlags[d][c][r])&&this.getDrawLevel(d,c,r)===mt.levelBuilt)){var f=255&this.levelTileUnderlayIds[d][c][r],p=255&this.levelTileOverlayIds[d][c][r];if(0<f||0<p){var m=this.levelHeightmap[d][c][r],g=this.levelHeightmap[d][c+1][r],C=this.levelHeightmap[d][c+1][r+1],y=this.levelHeightmap[d][c][r+1],v=this.levelLightmap[c][r],w=this.levelLightmap[c+1][r],T=this.levelLightmap[c+1][r+1],S=this.levelLightmap[c][r+1];let s=-1,t=-1;if(0<f){var A=256*i/n|0,O=h/o|0;let e=l/o|0;s=x.hsl24to16(A,O,e);A=A+mt.randomHueOffset&255;(e+=mt.randomLightnessOffset)<0?e=0:255<e&&(e=255),t=x.hsl24to16(A,O,e)}if(0<d){let e=0!=f||this.levelTileOverlayShape[d][c][r]===re.PLAIN;(e=0<p&&!x.instances[p-1].occlude?!1:e)&&m===g&&m===C&&m===y&&(this.levelOccludemap[d][c][r]|=2340)}let a=0;if(-1!==s&&(a=_.palette[x.mulHSL(t,96)]),0==p)u?.setTile(d,c,r,re.PLAIN,N.WEST,-1,m,g,C,y,x.mulHSL(s,v),x.mulHSL(s,w),x.mulHSL(s,T),x.mulHSL(s,S),ct.BLACK,ct.BLACK,ct.BLACK,ct.BLACK,a,ct.BLACK);else{A=this.levelTileOverlayShape[d][c][r]+1,O=this.levelTileOverlayRotation[d][c][r],f=x.instances[p-1];let e=f.texture,t,i;0<=e?(i=_.getAverageTextureRGB(e),t=-1):f.rgb===ct.MAGENTA?(i=0,t=-2,e=-1):(t=x.hsl24to16(f.hue,f.saturation,f.lightness),i=_.palette[x.adjustLightness(f.hsl,96)]),u?.setTile(d,c,r,A,O,e,m,g,C,y,x.mulHSL(s,v),x.mulHSL(s,w),x.mulHSL(s,T),x.mulHSL(s,S),x.adjustLightness(t,v),x.adjustLightness(t,w),x.adjustLightness(t,T),x.adjustLightness(t,S),a,i)}}}}}}for(let t=1;t<this.maxTileZ-1;t++)for(let e=1;e<this.maxTileX-1;e++)u?.setDrawLevel(d,e,t,this.getDrawLevel(d,e,t))}mt.fullbright||u?.buildModels(64,768,-50,-10,-50);for(let t=0;t<this.maxTileX;t++)for(let e=0;e<this.maxTileZ;e++)2==(2&this.levelTileFlags[1][t][e])&&u?.setBridge(t,e);if(!mt.fullbright){let o=1,c=2,d=4;for(let e=0;e<pt.LEVELS;e++){0<e&&(o<<=3,c<<=3,d<<=3);for(let n=0;n<=e;n++)for(let l=0;l<=this.maxTileZ;l++)for(let h=0;h<=this.maxTileX;h++){if(0!=(this.levelOccludemap[n][h][l]&o)){let i=l,s=l,a=n,r=n;for(;0<i&&0!=(this.levelOccludemap[n][h][i-1]&o);)i--;for(;s<this.maxTileZ&&0!=(this.levelOccludemap[n][h][s+1]&o);)s++;e:for(;0<a;){for(let e=i;e<=s;e++)if(0==(this.levelOccludemap[a-1][h][e]&o))break e;a--}e:for(;r<e;){for(let e=i;e<=s;e++)if(0==(this.levelOccludemap[r+1][h][e]&o))break e;r++}if(8<=(r+1-a)*(s+1-i)){var t=this.levelHeightmap[r][h][i]-240,I=this.levelHeightmap[a][h][i];X.addOccluder(e,1,128*h,t,128*i,128*h,I,128*s+128);for(let t=a;t<=r;t++)for(let e=i;e<=s;e++)this.levelOccludemap[t][h][e]&=~o}}if(0!=(this.levelOccludemap[n][h][l]&c)){let i=h,s=h,a=n,r=n;for(;0<i&&0!=(this.levelOccludemap[n][i-1][l]&c);)i--;for(;s<this.maxTileX&&0!=(this.levelOccludemap[n][s+1][l]&c);)s++;e:for(;0<a;){for(let e=i;e<=s;e++)if(0==(this.levelOccludemap[a-1][e][l]&c))break e;a--}e:for(;r<e;){for(let e=i;e<=s;e++)if(0==(this.levelOccludemap[r+1][e][l]&c))break e;r++}if(8<=(r+1-a)*(s+1-i)){t=this.levelHeightmap[r][i][l]-240,I=this.levelHeightmap[a][i][l];X.addOccluder(e,2,128*i,t,128*l,128*s+128,I,128*l);for(let t=a;t<=r;t++)for(let e=i;e<=s;e++)this.levelOccludemap[t][e][l]&=~c}}if(0!=(this.levelOccludemap[n][h][l]&d)){let i=h,s=h,a=l,r=l;for(;0<a&&0!=(this.levelOccludemap[n][h][a-1]&d);)a--;for(;r<this.maxTileZ&&0!=(this.levelOccludemap[n][h][r+1]&d);)r++;e:for(;0<i;){for(let e=a;e<=r;e++)if(0==(this.levelOccludemap[n][i-1][e]&d))break e;i--}e:for(;s<this.maxTileX;){for(let e=a;e<=r;e++)if(0==(this.levelOccludemap[n][s+1][e]&d))break e;s++}if(4<=(s+1-i)*(r+1-a)){var L=this.levelHeightmap[n][i][a];X.addOccluder(e,4,128*i,L,128*a,128*s+128,L,128*r+128);for(let t=i;t<=s;t++)for(let e=a;e<=r;e++)this.levelOccludemap[n][t][e]&=~d}}}}}};clearLandscape=(e,s,t,a)=>{let r=0;for(let e=0;e<x.count;e++)if("water"==x.instances[e].debugname?.toLowerCase()){r=e+1<<24>>24;break}for(let i=e;i<e+t;i++)for(let t=s;t<s+a;t++)if(0<=t&&t<this.maxTileX&&0<=i&&i<this.maxTileZ){this.levelTileOverlayIds[0][t][i]=r;for(let e=0;e<pt.LEVELS;e++)this.levelHeightmap[e][t][i]=0,this.levelTileFlags[e][t][i]=0}};readLandscape=(a,r,h,l,e)=>{var n=new ht(e);for(let s=0;s<pt.LEVELS;s++)for(let i=0;i<64;i++)for(let t=0;t<64;t++){var o=i+h,c=t+l;let e;if(0<=o&&o<pt.SIZE&&0<=c&&c<pt.SIZE)for(this.levelTileFlags[s][o][c]=0;;){if(0===(e=n.g1)){0===s?this.levelHeightmap[0][o][c]=8*-mt.perlin(o+a+932731,c+556238+r):this.levelHeightmap[s][o][c]=this.levelHeightmap[s-1][o][c]-240;break}if(1===e){let e=n.g1;1===e&&(e=0),0===s?this.levelHeightmap[0][o][c]=8*-e:this.levelHeightmap[s][o][c]=this.levelHeightmap[s-1][o][c]-8*e;break}e<=49?(this.levelTileOverlayIds[s][o][c]=n.g1b,this.levelTileOverlayShape[s][o][c]=((e-2)/4|0)<<24>>24,this.levelTileOverlayRotation[s][o][c]=(e-2&3)<<24>>24):e<=81?this.levelTileFlags[s][o][c]=e-49<<24>>24:this.levelTileUnderlayIds[s][o][c]=e-81<<24>>24}else for(;;){if(0===(e=n.g1))break;if(1===e){n.g1;break}e<=49&&n.g1}}};readLocs=(i,s,a,e,t,r)=>{var h=new ht(e);let l=-1;for(;;){var n=h.gsmarts;if(0===n)return;l+=n;let e=0;for(;;){var o=h.gsmarts;if(0===o)break;var o=63&(e+=o-1),c=e>>6&63,d=e>>12,u=h.g1,f=u>>2,u=3&u,c=c+t,o=o+r;if(0<c&&0<o&&c<pt.SIZE-1&&o<pt.SIZE-1){let e=d,t=null;0<=(e=2==(2&this.levelTileFlags[1][c][o])?d-1:e)&&(t=a[e]),this.addLoc(d,c,o,i,s,t,l,f,u)}}}};addLoc=(a,r,h,i,t,e,s,l,n)=>{if(mt.lowMemory){if(0!=(16&this.levelTileFlags[a][r][h]))return;if(this.getDrawLevel(a,r,h)!==mt.levelBuilt)return}var o=this.levelHeightmap[a][r][h],c=this.levelHeightmap[a][r+1][h],d=this.levelHeightmap[a][r+1][h+1],u=this.levelHeightmap[a][r][h+1],f=o+c+d+u>>2,p=P.get(s);let m=r+(h<<7)+(s<<14)+1073741824|0;p.active||(m+=-2147483648),m|=0;var g=((n<<6)+l|0)<<24>>24;if(l===k.GROUND_DECOR.id)mt.lowMemory&&!p.active&&!p.forcedecor||(i?.addGroundDecoration(p.getModel(k.GROUND_DECOR.id,n,o,c,d,u,-1),a,r,h,f,m,g),p.blockwalk&&p.active&&e?.addFloor(r,h),-1===p.anim)||t.addTail(new A(s,a,3,r,h,R.instances[p.anim],!0));else if(l===k.CENTREPIECE_STRAIGHT.id||l===k.CENTREPIECE_DIAGONAL.id){var C=p.getModel(k.CENTREPIECE_STRAIGHT.id,n,o,c,d,u,-1);if(C){let e=0;l===k.CENTREPIECE_DIAGONAL.id&&(e+=256);let t,s;if(s=n===N.NORTH||n===N.SOUTH?(t=p.length,p.width):(t=p.width,p.length),i?.addLoc(a,r,h,f,C,null,m,g,t,s,e)&&p.shadow)for(let i=0;i<=t;i++)for(let t=0;t<=s;t++){let e=C.radius/4|0;(e=30<e?30:e)>this.levelShademap[a][r+i][h+t]&&(this.levelShademap[a][r+i][h+t]=e<<24>>24)}}p.blockwalk&&e?.addLoc(r,h,p.width,p.length,n,p.blockrange),-1!==p.anim&&t.addTail(new A(s,a,2,r,h,R.instances[p.anim],!0))}else if(l>=k.ROOF_STRAIGHT.id)i?.addLoc(a,r,h,f,p.getModel(l,n,o,c,d,u,-1),null,m,g,1,1,0),l>=k.ROOF_STRAIGHT.id&&l<=k.ROOF_FLAT.id&&l!==k.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&0<a&&(this.levelOccludemap[a][r][h]|=2340),p.blockwalk&&e?.addLoc(r,h,p.width,p.length,n,p.blockrange),-1!==p.anim&&t.addTail(new A(s,a,2,r,h,R.instances[p.anim],!0));else if(l===k.WALL_STRAIGHT.id)i?.addWall(a,r,h,f,mt.ROTATION_WALL_TYPE[n],0,p.getModel(k.WALL_STRAIGHT.id,n,o,c,d,u,-1),null,m,g),n===N.WEST?(p.shadow&&(this.levelShademap[a][r][h]=50,this.levelShademap[a][r][h+1]=50),p.occlude&&(this.levelOccludemap[a][r][h]|=585)):n===N.NORTH?(p.shadow&&(this.levelShademap[a][r][h+1]=50,this.levelShademap[a][r+1][h+1]=50),p.occlude&&(this.levelOccludemap[a][r][h+1]|=1170)):n===N.EAST?(p.shadow&&(this.levelShademap[a][r+1][h]=50,this.levelShademap[a][r+1][h+1]=50),p.occlude&&(this.levelOccludemap[a][r+1][h]|=585)):n===N.SOUTH&&(p.shadow&&(this.levelShademap[a][r][h]=50,this.levelShademap[a][r+1][h]=50),p.occlude)&&(this.levelOccludemap[a][r][h]|=1170),p.blockwalk&&e?.addWall(r,h,l,n,p.blockrange),-1!==p.anim&&t.addTail(new A(s,a,0,r,h,R.instances[p.anim],!0)),16!==p.wallwidth&&i?.setWallDecorationOffset(a,r,h,p.wallwidth);else if(l===k.WALL_DIAGONAL_CORNER.id)i?.addWall(a,r,h,f,mt.ROTATION_WALL_CORNER_TYPE[n],0,p.getModel(k.WALL_DIAGONAL_CORNER.id,n,o,c,d,u,-1),null,m,g),p.shadow&&(n===N.WEST?this.levelShademap[a][r][h+1]=50:n===N.NORTH?this.levelShademap[a][r+1][h+1]=50:n===N.EAST?this.levelShademap[a][r+1][h]=50:n===N.SOUTH&&(this.levelShademap[a][r][h]=50)),p.blockwalk&&e?.addWall(r,h,l,n,p.blockrange),-1!==p.anim&&t.addTail(new A(s,a,0,r,h,R.instances[p.anim],!0));else if(l===k.WALL_L.id){var y=n+1&3;i?.addWall(a,r,h,f,mt.ROTATION_WALL_TYPE[n],mt.ROTATION_WALL_TYPE[y],p.getModel(k.WALL_L.id,n+4,o,c,d,u,-1),p.getModel(k.WALL_L.id,y,o,c,d,u,-1),m,g),p.occlude&&(n===N.WEST?(this.levelOccludemap[a][r][h]|=265,this.levelOccludemap[a][r][h+1]|=1170):n===N.NORTH?(this.levelOccludemap[a][r][h+1]|=1170,this.levelOccludemap[a][r+1][h]|=585):n===N.EAST?(this.levelOccludemap[a][r+1][h]|=585,this.levelOccludemap[a][r][h]|=1170):n===N.SOUTH&&(this.levelOccludemap[a][r][h]|=1170,this.levelOccludemap[a][r][h]|=585)),p.blockwalk&&e?.addWall(r,h,l,n,p.blockrange),-1!==p.anim&&t.addTail(new A(s,a,0,r,h,R.instances[p.anim],!0)),16!==p.wallwidth&&i?.setWallDecorationOffset(a,r,h,p.wallwidth)}else if(l===k.WALL_SQUARE_CORNER.id)i?.addWall(a,r,h,f,mt.ROTATION_WALL_CORNER_TYPE[n],0,p.getModel(k.WALL_SQUARE_CORNER.id,n,o,c,d,u,-1),null,m,g),p.shadow&&(n===N.WEST?this.levelShademap[a][r][h+1]=50:n===N.NORTH?this.levelShademap[a][r+1][h+1]=50:n===N.EAST?this.levelShademap[a][r+1][h]=50:n===N.SOUTH&&(this.levelShademap[a][r][h]=50)),p.blockwalk&&e?.addWall(r,h,l,n,p.blockrange),-1!==p.anim&&t.addTail(new A(s,a,0,r,h,R.instances[p.anim],!0));else if(l===k.WALL_DIAGONAL.id)i?.addLoc(a,r,h,f,p.getModel(l,n,o,c,d,u,-1),null,m,g,1,1,0),p.blockwalk&&e?.addLoc(r,h,p.width,p.length,n,p.blockrange),-1!==p.anim&&t.addTail(new A(s,a,2,r,h,R.instances[p.anim],!0));else if(l===k.WALLDECOR_STRAIGHT_NOOFFSET.id)i?.setWallDecoration(a,r,h,f,0,0,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,o,c,d,u,-1),g,512*n,mt.ROTATION_WALL_TYPE[n]),-1!==p.anim&&t.addTail(new A(s,a,1,r,h,R.instances[p.anim],!0));else if(l===k.WALLDECOR_STRAIGHT_OFFSET.id){let e=16;i&&0<(y=i.getWallBitset(a,r,h))&&(e=P.get(y>>14&32767).wallwidth),i?.setWallDecoration(a,r,h,f,mt.WALL_DECORATION_ROTATION_FORWARD_X[n]*e,mt.WALL_DECORATION_ROTATION_FORWARD_Z[n]*e,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,o,c,d,u,-1),g,512*n,mt.ROTATION_WALL_TYPE[n]),-1!==p.anim&&t.addTail(new A(s,a,1,r,h,R.instances[p.anim],!0))}else l===k.WALLDECOR_DIAGONAL_OFFSET.id?(i?.setWallDecoration(a,r,h,f,0,0,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,o,c,d,u,-1),g,n,256),-1!==p.anim&&t.addTail(new A(s,a,1,r,h,R.instances[p.anim],!0))):l===k.WALLDECOR_DIAGONAL_NOOFFSET.id?(i?.setWallDecoration(a,r,h,f,0,0,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,o,c,d,u,-1),g,n,512),-1!==p.anim&&t.addTail(new A(s,a,1,r,h,R.instances[p.anim],!0))):l===k.WALLDECOR_DIAGONAL_BOTH.id&&(i?.setWallDecoration(a,r,h,f,0,0,m,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,N.WEST,o,c,d,u,-1),g,n,768),-1!==p.anim)&&t.addTail(new A(s,a,1,r,h,R.instances[p.anim],!0))};getDrawLevel=(e,t,i)=>0==(8&this.levelTileFlags[e][t][i])?e<=0||0==(2&this.levelTileFlags[1][t][i])?e:e-1:0}class oe extends i{}class ce extends oe{x=0;z=0;yaw=0;seqStretches=!1;size=1;seqStandId=-1;seqTurnId=-1;seqWalkId=-1;seqTurnAroundId=-1;seqTurnLeftId=-1;seqTurnRightId=-1;seqRunId=-1;chat=null;chatTimer=100;chatColor=0;chatStyle=0;damage=0;damageType=0;combatCycle=-1e3;health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimOffset=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;height=0;dstYaw=0;pathLength=0;pathTileX=new Int32Array(10);pathTileZ=new Int32Array(10);pathRunning=new lt(10,!1);seqTrigger=0;lastMask=-1;lastMaskCycle=-1;lastFaceX=-1;lastFaceZ=-1;move(e,t,i){if(-1!==this.primarySeqId&&R.instances[this.primarySeqId].priority<=1&&(this.primarySeqId=-1),!e){var e=t-this.pathTileX[0],s=i-this.pathTileZ[0];if(-8<=e&&e<=8&&-8<=s&&s<=8){this.pathLength<9&&this.pathLength++;for(let e=this.pathLength;0<e;e--)this.pathTileX[e]=this.pathTileX[e-1],this.pathTileZ[e]=this.pathTileZ[e-1],this.pathRunning[e]=this.pathRunning[e-1];return this.pathTileX[0]=t,this.pathTileZ[0]=i,void(this.pathRunning[0]=!1)}}this.pathLength=0,this.seqTrigger=0,this.pathTileX[0]=t,this.pathTileZ[0]=i,this.x=128*this.pathTileX[0]+64*this.size,this.z=128*this.pathTileZ[0]+64*this.size}step(e,t){let i=this.pathTileX[0],s=this.pathTileZ[0];0===t?(i--,s++):1===t?s++:2===t?(i++,s++):3===t?i--:4===t?i++:5===t?(i--,s--):6===t?s--:7===t&&(i++,s--),-1!==this.primarySeqId&&R.instances[this.primarySeqId].priority<=1&&(this.primarySeqId=-1),this.pathLength<9&&this.pathLength++;for(let e=this.pathLength;0<e;e--)this.pathTileX[e]=this.pathTileX[e-1],this.pathTileZ[e]=this.pathTileZ[e-1],this.pathRunning[e]=this.pathRunning[e-1];this.pathTileX[0]=i,this.pathTileZ[0]=s,this.pathRunning[0]=e}}class r extends ce{static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static CHANGE_TYPE=32;static SPOTANIM=64;static FACE_COORD=128;type=null;draw(e){var t,i,s;return this.type?-1===this.spotanimId||-1===this.spotanimFrame?this.getSequencedModel():(s=this.getSequencedModel())?(i=J.instances[this.spotanimId],(t=ot.modelShareColored(i.getModel(),!0,!i.disposeAlpha,!1)).translate(-this.spotanimOffset,0,0),t.createLabelReferences(),i.seq&&i.seq.frames&&t.applyTransform(i.seq.frames[this.spotanimFrame]),t.labelFaces=null,t.labelVertices=null,128===i.resizeh&&128===i.resizev||t.scale(i.resizeh,i.resizev,i.resizeh),t.calculateNormals(64+i.ambient,850+i.contrast,-30,-50,-30,!0),i=[s,t],s=ot.modelFromModelsBounds(i,2),1===this.type.size&&(s.pickable=!0),s):null:null}isVisible(){return null!==this.type}getSequencedModel(){if(!this.type)return null;if(0<=this.primarySeqId&&0===this.primarySeqDelay){var t=R.instances[this.primarySeqId].frames;if(t){t=t[this.primarySeqFrame];let e=-1;return 0<=this.secondarySeqId&&this.secondarySeqId!==this.seqStandId&&(i=R.instances[this.secondarySeqId].frames)&&(e=i[this.secondarySeqFrame]),this.type.getSequencedModel(t,e,R.instances[this.primarySeqId].walkmerge)}}let e=-1;0<=this.secondarySeqId&&(i=R.instances[this.secondarySeqId].frames)&&(e=i[this.secondarySeqFrame]);var i,t=this.type.getSequencedModel(e,-1,null);return t?(this.height=t.maxY,t):null}}class c extends ce{static APPEARANCE=1;static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static FACE_COORD=32;static CHAT=64;static BIG_UPDATE=128;static SPOTANIM=256;static EXACT_MOVE=512;static TORSO_RECOLORS=[ct.BODY_RECOLOR_KHAKI,ct.BODY_RECOLOR_CHARCOAL,ct.BODY_RECOLOR_CRIMSON,ct.BODY_RECOLOR_NAVY,ct.BODY_RECOLOR_STRAW,ct.BODY_RECOLOR_WHITE,ct.BODY_RECOLOR_RED,ct.BODY_RECOLOR_BLUE,ct.BODY_RECOLOR_GREEN,ct.BODY_RECOLOR_YELLOW,ct.BODY_RECOLOR_PURPLE,ct.BODY_RECOLOR_ORANGE,ct.BODY_RECOLOR_ROSE,ct.BODY_RECOLOR_LIME,ct.BODY_RECOLOR_CYAN,ct.BODY_RECOLOR_EMERALD];static DESIGN_IDK_COLORS=[[ct.HAIR_DARK_BROWN,ct.HAIR_WHITE,ct.HAIR_LIGHT_GREY,ct.HAIR_DARK_GREY,ct.HAIR_APRICOT,ct.HAIR_STRAW,ct.HAIR_LIGHT_BROWN,ct.HAIR_BROWN,ct.HAIR_TURQUOISE,ct.HAIR_GREEN,ct.HAIR_GINGER,ct.HAIR_MAGENTA],[ct.BODY_KHAKI,ct.BODY_CHARCOAL,ct.BODY_CRIMSON,ct.BODY_NAVY,ct.BODY_STRAW,ct.BODY_WHITE,ct.BODY_RED,ct.BODY_BLUE,ct.BODY_GREEN,ct.BODY_YELLOW,ct.BODY_PURPLE,ct.BODY_ORANGE,ct.BODY_ROSE,ct.BODY_LIME,ct.BODY_CYAN,ct.BODY_EMERALD],[ct.BODY_EMERALD-1,ct.BODY_KHAKI+1,ct.BODY_CHARCOAL,ct.BODY_CRIMSON,ct.BODY_NAVY,ct.BODY_STRAW,ct.BODY_WHITE,ct.BODY_RED,ct.BODY_BLUE,ct.BODY_GREEN,ct.BODY_YELLOW,ct.BODY_PURPLE,ct.BODY_ORANGE,ct.BODY_ROSE,ct.BODY_LIME,ct.BODY_CYAN],[ct.FEET_BROWN,ct.FEET_KHAKI,ct.FEET_ASHEN,ct.FEET_DARK,ct.FEET_TERRACOTTA,ct.FEET_GREY],[ct.SKIN_DARKER,ct.SKIN_DARKER_DARKER,ct.SKIN_DARKER_DARKER_DARKER,ct.SKIN_DARKER_DARKER_DARKER_DARKER,ct.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER,ct.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER,ct.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER,ct.SKIN]];static modelCache=new U(200);name=null;visible=!1;gender=0;headicons=0;appearances=new Uint16Array(12);colors=new Uint16Array(5);combatLevel=0;appearanceHashcode=0n;y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;lowMemory=!1;draw(e){if(!this.visible)return null;let t=this.getSequencedModel();var i,s;return this.height=t.maxY,t.pickable=!0,this.lowMemory||(-1!==this.spotanimId&&-1!==this.spotanimFrame&&(s=J.instances[this.spotanimId],(i=ot.modelShareColored(s.getModel(),!0,!s.disposeAlpha,!1)).translate(-this.spotanimOffset,0,0),i.createLabelReferences(),s.seq&&s.seq.frames&&i.applyTransform(s.seq.frames[this.spotanimFrame]),i.labelFaces=null,i.labelVertices=null,128===s.resizeh&&128===s.resizev||i.scale(s.resizeh,s.resizev,s.resizeh),i.calculateNormals(s.ambient+64,s.contrast+850,-30,-50,-30,!0),s=[t,i],t=ot.modelFromModelsBounds(s,2)),this.locModel&&(e>=this.locStopCycle&&(this.locModel=null),e>=this.locStartCycle)&&e<this.locStopCycle&&(i=this.locModel)&&(i.translate(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),512===this.dstYaw?(i.rotateY90(),i.rotateY90(),i.rotateY90()):1024===this.dstYaw?(i.rotateY90(),i.rotateY90()):1536===this.dstYaw&&i.rotateY90(),s=[t,i],t=ot.modelFromModelsBounds(s,2),512===this.dstYaw?i.rotateY90():1024===this.dstYaw?(i.rotateY90(),i.rotateY90()):1536===this.dstYaw&&(i.rotateY90(),i.rotateY90(),i.rotateY90()),i.translate(this.y-this.locOffsetY,this.x-this.locOffsetX,this.z-this.locOffsetZ)),t.pickable=!0),t}isVisible(){return this.visible}read(i){i.pos=0,this.gender=i.g1,this.headicons=i.g1;for(let e=0;e<12;e++){var t=i.g1;this.appearances[e]=0===t?0:(t<<8)+i.g1}for(let t=0;t<5;t++){let e=i.g1;(e<0||e>=c.DESIGN_IDK_COLORS[t].length)&&(e=0),this.colors[t]=e}this.seqStandId=i.g2,65535===this.seqStandId&&(this.seqStandId=-1),this.seqTurnId=i.g2,65535===this.seqTurnId&&(this.seqTurnId=-1),this.seqWalkId=i.g2,65535===this.seqWalkId&&(this.seqWalkId=-1),this.seqTurnAroundId=i.g2,65535===this.seqTurnAroundId&&(this.seqTurnAroundId=-1),this.seqTurnLeftId=i.g2,65535===this.seqTurnLeftId&&(this.seqTurnLeftId=-1),this.seqTurnRightId=i.g2,65535===this.seqTurnRightId&&(this.seqTurnRightId=-1),this.seqRunId=i.g2,65535===this.seqRunId&&(this.seqRunId=-1),this.name=ut.formatName(ut.fromBase37(i.g8)),this.combatLevel=i.g1,this.visible=!0,this.appearanceHashcode=0n;for(let e=0;e<12;e++)this.appearanceHashcode<<=0x4n,256<=this.appearances[e]&&(this.appearanceHashcode+=BigInt(this.appearances[e])-256n);256<=this.appearances[0]&&(this.appearanceHashcode+=BigInt(this.appearances[0])-256n>>4n),256<=this.appearances[1]&&(this.appearanceHashcode+=BigInt(this.appearances[1])-256n>>8n);for(let e=0;e<5;e++)this.appearanceHashcode<<=0x3n,this.appearanceHashcode+=BigInt(this.colors[e]);this.appearanceHashcode<<=0x1n,this.appearanceHashcode+=BigInt(this.gender)}getHeadModel(){if(!this.visible)return null;var t=new lt(12,null);let i=0;for(let e=0;e<12;e++){var s=this.appearances[e];256<=s&&s<512&&(t[i++]=K.instances[s-256].getHeadModel()),512<=s&&(s=dt.get(s-512).getHeadModel(this.gender))&&(t[i++]=s)}var a=ot.modelFromModels(t,i);for(let e=0;e<5;e++)0!==this.colors[e]&&(a.recolor(c.DESIGN_IDK_COLORS[e][0],c.DESIGN_IDK_COLORS[e][this.colors[e]]),1===e)&&a.recolor(c.TORSO_RECOLORS[0],c.TORSO_RECOLORS[this.colors[e]]);return a}getSequencedModel(){let e=this.appearanceHashcode,t=-1,i=-1,s=-1,a=-1;var r,h;0<=this.primarySeqId&&0===this.primarySeqDelay?((h=R.instances[this.primarySeqId]).frames&&(t=h.frames[this.primarySeqFrame]),0<=this.secondarySeqId&&this.secondarySeqId!==this.seqStandId&&(r=R.instances[this.secondarySeqId].frames)&&(i=r[this.secondarySeqFrame]),0<=h.righthand&&(s=h.righthand,e+=BigInt(s-this.appearances[5])<<8n),0<=h.lefthand&&(a=h.lefthand,e+=BigInt(a-this.appearances[3])<<16n)):0<=this.secondarySeqId&&(r=R.instances[this.secondarySeqId].frames)&&(t=r[this.secondarySeqFrame]);let l=c.modelCache?.get(e);if(!l){var n,o=new lt(12,null);let i=0;for(let t=0;t<12;t++){let e=this.appearances[t];0<=a&&3===t&&(e=a),256<=(e=0<=s&&5===t?s:e)&&e<512&&(n=K.instances[e-256].getModel())&&(o[i++]=n),512<=e&&(n=dt.get(e-512).getWornModel(this.gender))&&(o[i++]=n)}l=ot.modelFromModels(o,i);for(let e=0;e<5;e++)0!==this.colors[e]&&(l.recolor(c.DESIGN_IDK_COLORS[e][0],c.DESIGN_IDK_COLORS[e][this.colors[e]]),1===e)&&l.recolor(c.TORSO_RECOLORS[0],c.TORSO_RECOLORS[this.colors[e]]);l.createLabelReferences(),l.calculateNormals(64,850,-30,-50,-30,!0),c.modelCache?.put(e,l)}return this.lowMemory?l:(h=ot.modelShareAlpha(l,!0),-1!==t&&-1!==i?h.applyTransforms(t,i,R.instances[this.primarySeqId].walkmerge):-1!==t&&h.applyTransform(t),h.calculateBoundsCylinder(),h.labelFaces=null,h.labelVertices=null,h)}}class de extends i{plane;layer;x;z;locIndex;angle;shape;lastCycle;constructor(e,t,i,s,a,r,h,l){super(),this.plane=e,this.layer=t,this.x=i,this.z=s,this.locIndex=a,this.angle=r,this.shape=h,this.lastCycle=l}}class ue extends i{plane;layer;x;z;locIndex;angle;shape;lastLocIndex;lastAngle;lastShape;constructor(e,t,i,s,a,r,h,l,n,o){super(),this.plane=e,this.layer=t,this.x=i,this.z=s,this.locIndex=a,this.angle=r,this.shape=h,this.lastLocIndex=l,this.lastAngle=n,this.lastShape=o}}class fe extends i{index;count;constructor(e,t){super(),this.index=e,this.count=t}}class pe extends oe{spotanim;level;srcX;srcZ;srcY;offsetY;startCycle;lastCycle;peakPitch;arc;target;mobile=!1;x=0;z=0;y=0;velocityX=0;velocityZ=0;velocity=0;velocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(e,t,i,s,a,r,h,l,n,o,c){super(),this.spotanim=J.instances[e],this.level=t,this.srcX=i,this.srcZ=a,this.srcY=s,this.startCycle=r,this.lastCycle=h,this.peakPitch=l,this.arc=n,this.target=o,this.offsetY=c}updateVelocity(e,t,i,s){this.mobile||(a=e-this.srcX,r=i-this.srcZ,this.x=this.srcX+a*this.arc/(a=Math.sqrt(a*a+r*r)),this.z=this.srcZ+r*this.arc/a,this.y=this.srcY);var a,r=this.lastCycle+1-s;this.velocityX=(e-this.x)/r,this.velocityZ=(i-this.z)/r,this.velocity=Math.sqrt(this.velocityX*this.velocityX+this.velocityZ*this.velocityZ),this.mobile||(this.velocityY=-this.velocity*Math.tan(.02454369*this.peakPitch)),this.accelerationY=2*(t-this.y-this.velocityY*r)/(r*r)}update(e){if(this.mobile=!0,this.x+=this.velocityX*e,this.z+=this.velocityZ*e,this.y+=this.velocityY*e+.5*this.accelerationY*e*e,this.velocityY+=this.accelerationY*e,this.yaw=2047&(325.949*Math.atan2(this.velocityX,this.velocityZ)+1024|0),this.pitch=2047&(325.949*Math.atan2(this.velocityY,this.velocity)|0),this.spotanim.seq&&this.spotanim.seq.delay)for(this.seqCycle+=e;this.seqCycle>this.spotanim.seq.delay[this.seqFrame];)this.seqCycle-=this.spotanim.seq.delay[this.seqFrame]+1,this.seqFrame++,this.seqFrame>=this.spotanim.seq.frameCount&&(this.seqFrame=0)}draw(){var e=this.spotanim.getModel(),e=ot.modelShareColored(e,!0,!this.spotanim.disposeAlpha,!1);return this.spotanim.seq&&this.spotanim.seq.frames&&(e.createLabelReferences(),e.applyTransform(this.spotanim.seq.frames[this.seqFrame]),e.labelFaces=null,e.labelVertices=null),128===this.spotanim.resizeh&&128===this.spotanim.resizev||e.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh),e.rotateX(this.pitch),e.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,!0),e}}class me extends oe{type;level;x;z;y;startCycle;seqComplete=!1;seqFrame=0;seqCycle=0;constructor(e,t,i,s,a,r,h){super(),this.type=J.instances[e],this.level=t,this.x=i,this.z=s,this.y=a,this.startCycle=r+h}update(e){if(this.type.seq&&this.type.seq.delay)for(this.seqCycle+=e;this.seqCycle>this.type.seq.delay[this.seqFrame];)this.seqCycle-=this.type.seq.delay[this.seqFrame]+1,this.seqFrame++,this.seqFrame>=this.type.seq.frameCount&&(this.seqFrame=0,this.seqComplete=!0)}draw(){var e=this.type.getModel(),e=ot.modelShareColored(e,!0,!this.type.disposeAlpha,!1);return!this.seqComplete&&this.type.seq&&this.type.seq.frames&&(e.createLabelReferences(),e.applyTransform(this.type.seq.frames[this.seqFrame]),e.labelFaces=null,e.labelVertices=null),128===this.type.resizeh&&128===this.type.resizev||e.scale(this.type.resizeh,this.type.resizev,this.type.resizeh),0!==this.type.orientation&&(90===this.type.orientation?e.rotateY90():180===this.type.orientation?(e.rotateY90(),e.rotateY90()):270===this.type.orientation&&(e.rotateY90(),e.rotateY90(),e.rotateY90())),e.calculateNormals(64+this.type.ambient,850+this.type.contrast,-30,-50,-30,!0),e}}class ge{seed;constructor(e){this.seed=(0x5deece66dn^e)&(1n<<48n)-1n}setSeed(e){this.seed=(0x5deece66dn^e)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(e){return this.seed=0x5deece66dn*this.seed+0xbn&(1n<<48n)-1n,+(""+this.seed)>>>48-e}}class H extends t{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];static{var i=navigator.userAgent.includes("Capacitor");for(let t=0;t<256;t++){let e=H.CHARSET.indexOf(String.fromCharCode(t));i&&63<=e&&e--,-1===e&&(e=74),H.CHARCODESET[t]=e}}charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new ge(BigInt(Date.now()));height=0;static fromArchive=(e,t)=>{var s=new ht(e.read(t+".dat")),a=new ht(e.read("index.dat")),t=(a.pos=s.g2+4,a.g1),r=(0<t&&(a.pos+=3*(t-1)),new H);for(let i=0;i<94;i++){r.charOffsetX[i]=a.g1,r.charOffsetY[i]=a.g1;var h=r.charMaskWidth[i]=a.g2,l=r.charMaskHeight[i]=a.g2,n=a.g1;if(r.charMask[i]=new Int8Array(h*l),0===n)for(let e=0;e<h*l;e++)r.charMask[i][e]=s.g1b;else if(1===n)for(let t=0;t<h;t++)for(let e=0;e<l;e++)r.charMask[i][t+e*h]=s.g1b;l>r.height&&(r.height=l),r.charOffsetX[i]=1,r.charAdvance[i]=h+2;{let t=0;for(let e=l/7|0;e<l;e++)t+=r.charMask[i][e*h];t<=(l/7|0)&&(r.charAdvance[i]--,r.charOffsetX[i]=0)}{let t=0;for(let e=l/7|0;e<l;e++)t+=r.charMask[i][h+e*h-1];t<=(l/7|0)&&r.charAdvance[i]--}}r.charAdvance[94]=r.charAdvance[8];for(let e=0;e<256;e++)r.drawWidth[e]=r.charAdvance[H.CHARCODESET[e]];return r};drawString(t,i,s,a){if(s){t|=0;var r=s.length;i=(i|0)-this.height;for(let e=0;e<r;e++){var h=H.CHARCODESET[s.charCodeAt(e)];94!==h&&this.drawChar(this.charMask[h],t+this.charOffsetX[h],i+this.charOffsetY[h],this.charMaskWidth[h],this.charMaskHeight[h],a),t+=this.charAdvance[h]}}}drawStringTaggable(t,i,s,a,r){t|=0;var h,l=s.length;i=(0|i)-this.height;for(let e=0;e<l;e++)"@"==(s[0|e]||"")&&e+4<l&&"@"==(s[0|e+4]||"")?(a=this.evaluateTag(s.substring(e+1,e+4)),e+=4):(94!==(h=H.CHARCODESET[s.charCodeAt(e)])&&(r&&this.drawChar(this.charMask[h],t+this.charOffsetX[h]+1,i+this.charOffsetY[h]+1,this.charMaskWidth[h],this.charMaskHeight[h],ct.BLACK),this.drawChar(this.charMask[h],t+this.charOffsetX[h],i+this.charOffsetY[h],this.charMaskWidth[h],this.charMaskHeight[h],a)),t+=this.charAdvance[h])}stringWidth(t){if(!t)return 0;var i=t.length;let s=0;for(let e=0;e<i;e++)"@"==(t[0|e]||"")&&e+4<i&&"@"==(t[0|e+4]||"")?e+=4:s+=this.drawWidth[t.charCodeAt(e)];return s}drawStringTaggableCenter(e,t,i,s,a){t|=0,this.drawStringTaggable((e|=0)-(this.stringWidth(i)/2|0),t,i,s,a)}drawStringCenter(e,t,i,s){i&&(t|=0,this.drawString((e|=0)-(this.stringWidth(i)/2|0),t,i,s))}drawStringTooltip(t,e,i,s,a,r){t|=0,e|=0,this.random.setSeed(BigInt(r));var h,l=192+(31&this.random.nextInt()),n=e-this.height;for(let e=0;e<i.length;e++)"@"==(i[0|e]||"")&&e+4<i.length&&"@"==(i[0|e+4]||"")?(s=this.evaluateTag(i.substring(e+1,e+4)),e+=4):(94!==(h=H.CHARCODESET[i.charCodeAt(e)])&&(a&&this.drawCharAlpha(t+this.charOffsetX[h]+1,n+this.charOffsetY[h]+1,this.charMaskWidth[h],this.charMaskHeight[h],ct.BLACK,192,this.charMask[h]),this.drawCharAlpha(t+this.charOffsetX[h],n+this.charOffsetY[h],this.charMaskWidth[h],this.charMaskHeight[h],s,l,this.charMask[h])),t+=this.charAdvance[h],0==(3&this.random.nextInt())&&t++)}drawStringRight(e,t,i,s,a=!0){e|=0,t|=0,a&&this.drawString(e-this.stringWidth(i)+1,t+1,i,ct.BLACK),this.drawString(e-this.stringWidth(i),t,i,s)}drawCenteredWave(t,e,i,s,a){if(i){e|=0,t=(t|=0)-(this.stringWidth(i)/2|0);var r=e-this.height;for(let e=0;e<i.length;e++){var h=H.CHARCODESET[i.charCodeAt(e)];94!=h&&this.drawChar(this.charMask[h],t+this.charOffsetX[h],r+this.charOffsetY[h]+(5*Math.sin(e/2+a/5)|0),this.charMaskWidth[h],this.charMaskHeight[h],s),t+=this.charAdvance[h]}}}drawChar(e,t,i,s,a,r){s|=0,a|=0;let h=(t|=0)+(i|=0)*D.width2d,l=D.width2d-s,n=0,o=0;var c;i<D.top&&(a-=c=D.top-i,i=D.top,o+=c*s,h+=c*D.width2d),i+a>=D.bottom&&(a-=i+a+1-D.bottom),t<D.left&&(s-=c=D.left-t,t=D.left,o+=c,h+=c,n+=c,l+=c),t+s>=D.right&&(s-=i=t+s+1-D.right,n+=i,l+=i),0<s&&0<a&&this.drawMask(s,a,e,o,n,D.pixels,h,l,r)}drawCharAlpha(e,t,i,s,a,r,h){i|=0,s|=0;let l=(e|=0)+(t|=0)*D.width2d,n=D.width2d-i,o=0,c=0;var d;t<D.top&&(s-=d=D.top-t,t=D.top,c+=d*i,l+=d*D.width2d),t+s>=D.bottom&&(s-=t+s+1-D.bottom),e<D.left&&(i-=d=D.left-e,e=D.left,c+=d,l+=d,o+=d,n+=d),e+i>=D.right&&(i-=t=e+i+1-D.right,o+=t,n+=t),0<i&&0<s&&this.drawMaskAlpha(i,s,D.pixels,l,n,h,c,o,a,r)}drawMask(t,i,s,a,r,h,l,n,o){var c=-((t|=0)>>2);t=-(3&t);for(let e=-(i|=0);e<0;e++){for(let e=c;e<0;e++)0===s[a++]?l++:h[l++]=o,0===s[a++]?l++:h[l++]=o,0===s[a++]?l++:h[l++]=o,0===s[a++]?l++:h[l++]=o;for(let e=t;e<0;e++)0===s[a++]?l++:h[l++]=o;l+=n,a+=r}}drawMaskAlpha(t,i,s,a,r,h,l,n,e,o){t|=0;var c,d=((16711935&e)*o&4278255360)+((65280&e)*o&16711680)>>8,u=256-o;for(let e=-(i|=0);e<0;e++){for(let e=-t;e<0;e++)0===h[l++]?a++:(c=s[a],s[a++]=(((16711935&c)*u&4278255360)+((65280&c)*u&16711680)>>8)+d);a+=r,l+=n}}evaluateTag(e){return"red"===e?ct.RED:"gre"===e?ct.GREEN:"blu"===e?ct.BLUE:"yel"===e?ct.YELLOW:"cya"===e?ct.CYAN:"mag"===e?ct.MAGENTA:"whi"===e?ct.WHITE:"bla"===e?ct.BLACK:"lre"===e?ct.LIGHTRED:"dre"===e?ct.DARKRED:"dbl"===e?ct.DARKBLUE:"or1"===e?ct.ORANGE1:"or2"===e?ct.ORANGE2:"or3"===e?ct.ORANGE3:"gr1"===e?ct.GREEN1:"gr2"===e?ct.GREEN2:"gr3"===e?ct.GREEN3:ct.BLACK}split(i,s){if(0===i.length)return[i];for(var e=[];0<i.length;){if(this.stringWidth(i)<=s&&!~i.indexOf("|")){e.push(i);break}let t=i.length;for(let e=0;e<i.length;e++)if(" "===i[e]){if(s<this.stringWidth(i.substring(0,e)))break;t=e}else if("|"===i[e]){t=e;break}e.push(i.substring(0,t)),i=i.substring(t+1)}return e}}class Ce{socket;wsin;wsout;closed=!1;ioerror=!1;static openSocket=async(s,a)=>new Promise((e,t)=>{let i=new WebSocket((a?"wss":"ws")+"://"+s,"binary");i.addEventListener("open",()=>{e(i)}),i.addEventListener("error",()=>{t(i)})});constructor(e){e.onclose=this.onclose,e.onerror=this.onerror,this.wsin=new we(e,5e3),this.wsout=new ye(e,5e3),this.socket=e}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(e,t){this.wsout.write(e,t)}async read(){return this.closed?0:this.wsin.fastByte()??await this.wsin.slowByte()}async readBytes(e,t,i){if(!this.closed)for(;0<i;){var s=this.wsin.fastBytes(e,t,i)??await this.wsin.slowBytes(e,t,i);if(s.length<=0)throw Error("EOF");t+=s.length,i-=s.length}}close(){this.closed=!0,this.socket.close(),this.wsin.close(),this.wsout.close()}onclose=e=>{this.closed||this.close()};onerror=e=>{this.closed||(this.ioerror=!0,this.close())}}class ye{socket;limit;closed=!1;ioerror=!1;constructor(e,t){this.socket=e,this.limit=t}write(e,t){if(!this.closed){if(this.ioerror)throw this.ioerror=!1,Error("Error in writer thread");if(t>this.limit||e.length>this.limit)throw Error("buffer overflow");try{this.socket.send(e.subarray(0,t))}catch(e){this.ioerror=!0}}}close(){this.closed=!0}}class ve extends i{bytes;position;constructor(e){super(),this.bytes=e,this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class we{limit;queue=new O;event=null;callback=null;total=0;closed=!1;constructor(e,t){this.limit=t,e.binaryType="arraybuffer",e.onmessage=this.onmessage}get available(){return this.total}onmessage=e=>{if(this.closed)throw Error("WebSocketReader is closed!");e=new ve(new Uint8Array(e.data));if(this.event?this.queue.addTail(e):this.event=e,this.total+=e.len,this.callback&&(this.callback(this.event),this.callback=null,this.total>this.limit))throw Error("buffer overflow")};readFastByte(){return this.event&&0<this.event.available?this.event.read:null}async readSlowByte(e){for(this.event=this.queue.removeHead();this.total<e;)await Promise.race([new Promise(e=>this.callback=e),p(2e3).then(()=>{if(this.closed)throw Error("WebSocketReader closed while reading.")})]);return this.event?this.event.read:this.readSlowByte(e)}fastBytes(e,t,i){if(this.closed)throw Error("WebSocketReader is closed!");if(!(this.event&&this.event.available>=i))return null;for(;0<i;){var s=this.readFastByte();if(null===s)throw Error("EOF - tried to read a fast byte when there was not enough immediate bytes.");e[t++]=s,this.total--,i--}return e}async slowBytes(e,t,i){if(this.closed)throw Error("WebSocketReader is closed!");for(;0<i;)e[t++]=this.readFastByte()??await this.readSlowByte(i),this.total--,i--;return e}fastByte(){if(this.closed)throw Error("WebSocketReader is closed!");var e=this.readFastByte();return null===e?null:(this.total--,e)}async slowByte(){if(this.closed)throw Error("WebSocketReader is closed!");var e=await this.readSlowByte(1);return this.total--,e}close(){this.closed=!0,this.callback=null,this.total=0,this.event=null,this.queue.clear()}}class gt{static REBUILD_GETMAPS=150;static NO_TIMEOUT=108;static IDLE_TIMER=70;static EVENT_TRACKING=81;static EVENT_CAMERA_POSITION=189;static ANTICHEAT_OPLOGIC1=7;static ANTICHEAT_OPLOGIC2=88;static ANTICHEAT_OPLOGIC3=30;static ANTICHEAT_OPLOGIC4=176;static ANTICHEAT_OPLOGIC5=220;static ANTICHEAT_OPLOGIC6=66;static ANTICHEAT_OPLOGIC7=17;static ANTICHEAT_OPLOGIC8=2;static ANTICHEAT_OPLOGIC9=238;static ANTICHEAT_CYCLELOGIC1=233;static ANTICHEAT_CYCLELOGIC2=146;static ANTICHEAT_CYCLELOGIC3=215;static ANTICHEAT_CYCLELOGIC4=236;static ANTICHEAT_CYCLELOGIC5=85;static ANTICHEAT_CYCLELOGIC6=219;static OPOBJ1=140;static OPOBJ2=40;static OPOBJ3=200;static OPOBJ4=178;static OPOBJ5=247;static OPOBJT=138;static OPOBJU=239;static OPNPC1=194;static OPNPC2=8;static OPNPC3=27;static OPNPC4=113;static OPNPC5=100;static OPNPCT=134;static OPNPCU=202;static OPLOC1=245;static OPLOC2=172;static OPLOC3=96;static OPLOC4=97;static OPLOC5=116;static OPLOCT=9;static OPLOCU=75;static OPPLAYER1=164;static OPPLAYER2=53;static OPPLAYER3=185;static OPPLAYER4=206;static OPPLAYERT=177;static OPPLAYERU=248;static OPHELD1=195;static OPHELD2=71;static OPHELD3=133;static OPHELD4=157;static OPHELD5=211;static OPHELDT=48;static OPHELDU=130;static INV_BUTTON1=31;static INV_BUTTON2=59;static INV_BUTTON3=212;static INV_BUTTON4=38;static INV_BUTTON5=6;static IF_BUTTON=155;static RESUME_PAUSEBUTTON=235;static CLOSE_MODAL=231;static RESUME_P_COUNTDIALOG=237;static TUTORIAL_CLICKSIDE=175;static MOVE_OPCLICK=93;static REPORT_ABUSE=190;static MOVE_MINIMAPCLICK=165;static INV_BUTTOND=159;static IGNORELIST_DEL=171;static IGNORELIST_ADD=79;static IF_PLAYERDESIGN=52;static CHAT_SETMODE=244;static MESSAGE_PRIVATE=148;static FRIENDLIST_DEL=11;static FRIENDLIST_ADD=118;static CLIENT_CHEAT=4;static MESSAGE_PUBLIC=158;static MOVE_GAMECLICK=181}class Te{db;constructor(e){e.onerror=this.onerror,e.onclose=this.onclose,this.db=e}static openDatabase=async()=>new Promise((t,i)=>{var e=indexedDB.open("lostcity",1);e.onsuccess=e=>{e=e.target;t(e.result)},e.onupgradeneeded=e=>{e.target.result.createObjectStore("cache")},e.onerror=e=>{e=e.target;i(e.result)}});async cacheload(i){return new Promise(e=>{let t=this.db.transaction("cache","readonly").objectStore("cache").get(i);t.onsuccess=()=>{t.result?e(new Uint8Array(t.result)):e(void 0)},t.onerror=()=>{e(void 0)}})}async cachesave(s,a){return new Promise((e,t)=>{var i=this.db.transaction("cache","readwrite").objectStore("cache").put(a,s);i.onsuccess=()=>{e()},i.onerror=()=>{e()}})}onclose=e=>{};onerror=e=>{};genHash=e=>{var t=e.trim();let i=0;for(let e=0;e<t.length&&e<12;e++){var s=t[0|e]||"";i*=37,"A"<=s&&s<="Z"?i+=1+s.charCodeAt(0)-65:"a"<=s&&s<="z"?i+=1+s.charCodeAt(0)-97:"0"<=s&&s<="9"&&(i+=27+s.charCodeAt(0)-48)}return i}}class Se{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(t){for(let e=0;e<t.length;e++)this.rsl[e]=t[e];this.init()}get nextInt(){return 0==this.count--&&(this.isaac(),this.count=255),this.rsl[this.count]}init(){let t=2654435769,i=2654435769,s=2654435769,a=2654435769,r=2654435769,h=2654435769,l=2654435769,n=2654435769;for(let e=0;e<4;e++)t^=i<<11,a+=t,i=(i+=s)^s>>>2,r+=i,s=(s+=a)^a<<8,h+=s,a=(a+=r)^r>>>16,l+=a,r=(r+=h)^h<<10,n+=r,h=(h+=l)^l>>>4,t+=h,l=(l+=n)^n<<8,i+=l,n=(n+=t)^t>>>9,s+=n,t+=i;for(let e=0;e<256;e+=8)t+=this.rsl[e],i+=this.rsl[e+1],s+=this.rsl[e+2],a+=this.rsl[e+3],r+=this.rsl[e+4],h+=this.rsl[e+5],l+=this.rsl[e+6],n+=this.rsl[e+7],t^=i<<11,a+=t,i=(i+=s)^s>>>2,r+=i,s=(s+=a)^a<<8,h+=s,a=(a+=r)^r>>>16,l+=a,r=(r+=h)^h<<10,n+=r,h=(h+=l)^l>>>4,t+=h,l=(l+=n)^n<<8,i+=l,n=(n+=t)^t>>>9,s+=n,t+=i,this.mem[e]=t,this.mem[e+1]=i,this.mem[e+2]=s,this.mem[e+3]=a,this.mem[e+4]=r,this.mem[e+5]=h,this.mem[e+6]=l,this.mem[e+7]=n;for(let e=0;e<256;e+=8)t+=this.mem[e],i+=this.mem[e+1],s+=this.mem[e+2],a+=this.mem[e+3],r+=this.mem[e+4],h+=this.mem[e+5],l+=this.mem[e+6],n+=this.mem[e+7],t^=i<<11,a+=t,i=(i+=s)^s>>>2,r+=i,s=(s+=a)^a<<8,h+=s,a=(a+=r)^r>>>16,l+=a,r=(r+=h)^h<<10,n+=r,h=(h+=l)^l>>>4,t+=h,l=(l+=n)^n<<8,i+=l,n=(n+=t)^t>>>9,s+=n,t+=i,this.mem[e]=t,this.mem[e+1]=i,this.mem[e+2]=s,this.mem[e+3]=a,this.mem[e+4]=r,this.mem[e+5]=h,this.mem[e+6]=l,this.mem[e+7]=n;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let e=0;e<256;e++){var t=this.mem[e],i=3&e;0==i?this.a^=this.a<<13:1==i?this.a^=this.a>>>6:2==i?this.a^=this.a<<2:3==i&&(this.a^=this.a>>>16),this.a+=this.mem[e+128&255],this.mem[e]=i=this.mem[t>>>2&255]+this.a+this.b,this.rsl[e]=this.b=this.mem[i>>>8>>>2&255]+t}}}import{BZip2 as Ae}from"./deps.js";class Oe{static genHash=t=>{let i=0;t=t.toUpperCase();for(let e=0;e<t.length;e++)i=61*i+t.charCodeAt(e)-32|0;return i};buffer;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(e){let t=new ht(new Uint8Array(e));var i=t.g3;i===t.g3?(this.buffer=e,this.compressedWhole=!1):(this.buffer=Ae.decompress(e.subarray(6),i,!0),t=new ht(new Uint8Array(this.buffer)),this.compressedWhole=!0),this.fileCount=t.g2,this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let s=t.pos+10*this.fileCount;for(let e=0;e<this.fileCount;e++)this.fileHash.push(t.g4),this.fileUnpackedSize.push(t.g3),this.filePackedSize.push(t.g3),this.fileOffset.push(s),s+=this.filePackedSize[e]}read(e){e=Oe.genHash(e),e=this.fileHash.indexOf(e);return-1==e?null:this.readIndex(e)}readIndex(e){var t,i;return e<0||e>=this.fileCount?null:this.fileUnpacked[e]||(i=(t=this.fileOffset[e])+this.filePackedSize[e],t=new Uint8Array(this.buffer.subarray(t,t+i)),this.compressedWhole?this.fileUnpacked[e]=t:(i=Ae.decompress(t,this.fileUnpackedSize[e],!0),this.fileUnpacked[e]=i))}}class St{static CLIENTPROT_SCRAMBLED=[95,218,67,50,253,222,194,60,101,128,8,251,92,111,24,33,223,66,232,59,227,113,153,105,126,98,167,102,177,238,62,190,147,23,150,151,156,144,193,155,81,0,198,22,137,210,179,16,168,170,32,181,248,141,58,87,208,106,180,191,221,241,40,176,196,154,65,145,230,78,30,161,188,41,14,129,18,199,47,247,225,34,51,10,159,75,12,56,61,31,39,91,46,242,134,5,122,123,209,228,104,195,21,3,11,44,107,172,6,186,110,215,205,103,27,185,124,77,252,117,86,115,127,207,52,79,43,97,219,116,169,7,118,162,108,36,20,233,88,135,80,19,42,237,57,152,71,9,250,17,4,119,234,130,26,200,189,163,254,245,197,171,220,235,140,244,184,94,211,231,99,246,121,212,112,204,63,148,83,178,1,255,131,13,183,142,236,45,55,35,243,136,37,85,100,160,38,224,146,174,82,48,109,132,125,90,143,138,240,173,165,164,192,175,29,74,28,114,213,73,64,206,76,139,96,2,229,15,93,25,239,202,49,70,214,201,72,203,68,89,69,157,216,217,249,120,226,84,149,187,54,53,158,166,182,133,0];static SERVERPROT_SIZES=[0,-2,4,6,-1,0,0,2,0,0,0,0,5,4,2,2,0,0,0,0,2,-2,2,14,0,6,3,0,4,0,0,0,3,0,0,0,0,0,0,0,0,-1,4,2,6,0,6,0,0,3,7,0,0,0,-1,0,0,0,0,4,0,0,0,0,0,0,0,0,1,15,0,0,0,0,6,0,2,0,0,0,2,0,0,0,1,0,0,4,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,-2,0,0,2,0,0,0,2,9,0,0,0,0,0,4,0,0,0,3,7,9,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,3,2,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,-2,2,0,0,0,0,0,6,0,0,0,2,0,2,0,0,0,-2,0,0,4,0,0,0,0,6,0,0,-2,-2,0,0,0,0,0,0,-2,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0]}class Ct{static IF_OPENCHATMODAL=14;static IF_OPENMAINSIDEMODAL=28;static IF_CLOSE=129;static IF_OPENSIDEOVERLAY=167;static IF_OPENMAINMODAL=168;static IF_OPENSIDEMODAL=195;static IF_SETCOLOUR=2;static IF_SETHIDE=26;static IF_SETOBJECT=46;static IF_SHOWSIDE=84;static IF_SETMODEL=87;static IF_SETRECOL=103;static IF_SETANIM=146;static IF_SETPLAYERHEAD=197;static IF_SETTEXT=201;static IF_SETNPCHEAD=204;static IF_SETPOSITION=209;static TUTORIAL_FLASHSIDE=126;static TUTORIAL_OPENCHAT=185;static UPDATE_INV_STOP_TRANSMIT=15;static UPDATE_INV_FULL=98;static UPDATE_INV_PARTIAL=213;static CAM_LOOKAT=74;static CAM_SHAKE=13;static CAM_MOVETO=3;static CAM_RESET=239;static NPC_INFO=1;static PLAYER_INFO=184;static FINISH_TRACKING=133;static ENABLE_TRACKING=226;static MESSAGE_GAME=4;static UPDATE_IGNORELIST=21;static CHAT_FILTER_SETTINGS=32;static MESSAGE_PRIVATE=41;static UPDATE_FRIENDLIST=152;static UNSET_MAP_FLAG=19;static UPDATE_RUNWEIGHT=22;static HINT_ARROW=25;static UPDATE_REBOOT_TIMER=43;static UPDATE_STAT=44;static UPDATE_RUNENERGY=68;static RESET_ANIMS=136;static UPDATE_PID=139;static LAST_LOGIN_INFO=140;static LOGOUT=142;static P_COUNTDIALOG=243;static SET_MULTIWAY=254;static DATA_LOC_DONE=20;static DATA_LAND_DONE=80;static DATA_LAND=132;static DATA_LOC=220;static REBUILD_NORMAL=237;static VARP_SMALL=150;static VARP_LARGE=175;static RESET_CLIENT_VARCACHE=193;static SYNTH_SOUND=12;static MIDI_SONG=54;static MIDI_JINGLE=212;static UPDATE_ZONE_PARTIAL_FOLLOWS=7;static UPDATE_ZONE_FULL_FOLLOWS=135;static UPDATE_ZONE_PARTIAL_ENCLOSED=162;static LOC_MERGE=23;static LOC_ANIM=42;static OBJ_DEL=49;static OBJ_REVEAL=50;static LOC_ADD_CHANGE=59;static MAP_PROJANIM=69;static LOC_DEL=76;static OBJ_COUNT=151;static MAP_ANIM=191;static OBJ_ADD=223}class At{static PERIOD=new Uint16Array("dot".split("").map(e=>e.charCodeAt(0)));static AMPERSAT=new Uint16Array("(a)".split("").map(e=>e.charCodeAt(0)));static SLASH=new Uint16Array("slash".split("").map(e=>e.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack=e=>{var t=new ht(e.read("fragmentsenc.txt")),i=new ht(e.read("badenc.txt")),s=new ht(e.read("domainenc.txt")),e=new ht(e.read("tldlist.txt"));this.read(i,s,t,e)};static filter=e=>{var e=[...e],e=(this.format(e),e.join("").trim()),i=e.toLowerCase(),s=[...i];this.filterTlds(s),this.filterBadWords(s),this.filterDomains(s),this.filterFragments(s);for(let e=0;e<this.whitelist.length;e++){let t=-1;for(;~(t=i.indexOf(this.whitelist[e],t+1));){var a=[...this.whitelist[e]];for(let e=0;e<a.length;e++)s[e+t]=a[e]}}return this.replaceUppercases(s,[...e]),this.formatUppercases(s),s.join("").trim()};static read=(e,t,i,s)=>{this.readBadWords(e),this.readDomains(t),this.readFragments(i),this.readTld(s)};static readTld=t=>{var i=t.g4;for(let e=0;e<i;e++)this.tldTypes[e]=t.g1,this.tlds[e]=new Uint16Array(t.g1).map(()=>t.g1)};static readBadWords=t=>{var i=t.g4;for(let e=0;e<i;e++){this.bads[e]=new Uint16Array(t.g1).map(()=>t.g1);var s=Array(t.g1).fill([]).map(()=>[t.g1b,t.g1b]);0<s.length&&(this.badCombinations[e]=s)}};static readDomains=t=>{var i=t.g4;for(let e=0;e<i;e++)this.domains[e]=new Uint16Array(t.g1).map(()=>t.g1)};static readFragments=t=>{var i=t.g4;for(let e=0;e<i;e++)this.fragments[e]=t.g2};static filterTlds=t=>{var i=[...t],s=[...t];this.filterBadCombinations(null,i,this.PERIOD),this.filterBadCombinations(null,s,this.SLASH);for(let e=0;e<this.tlds.length;e++)this.filterTld(s,this.tldTypes[e],t,this.tlds[e],i)};static filterBadWords=t=>{for(let e=0;e<2;e++)for(let e=this.bads.length-1;0<=e;e--)this.filterBadCombinations(this.badCombinations[e],t,this.bads[e])};static filterDomains=t=>{var i=[...t],s=[...t];this.filterBadCombinations(null,i,this.AMPERSAT),this.filterBadCombinations(null,s,this.PERIOD);for(let e=this.domains.length-1;0<=e;e--)this.filterDomain(s,i,this.domains[e],t)};static filterFragments=a=>{for(let s=0;s<a.length;){var r=this.indexOfNumber(a,s);if(-1===r)return;let t=!1;for(let e=s;0<=e&&e<r&&!t;e++)this.isSymbol(a[e])||this.isNotLowercaseAlpha(a[e])||(t=!0);let e=0,i=(0===(e=t?0:e)&&(e=1,s=r),0);for(let e=r;e<a.length&&e<s;e++)i=10*i+a[e].charCodeAt(0)-48;i<=255&&s-r<=8?e++:e=0,4===e&&(this.maskChars(r,s,a),e=0),s=this.indexOfNonNumber(s,a)}};static isBadFragment=e=>{if(this.isNumericalChars(e))return!0;var t=this.getInteger(e),i=this.fragments,e=i.length;if(t===i[0]||t===i[e-1])return!0;let s=0,a=e-1;for(;s<=a;){var r=(s+a)/2|0;if(t===i[r])return!0;t<i[r]?a=r-1:s=1+r}return!1};static getInteger=t=>{if(6<t.length)return 0;let i=0;for(let e=0;e<t.length;e++){var s=t[t.length-e-1];if(this.isLowercaseAlpha(s))i=38*i+s.charCodeAt(0)+1-97;else if("'"===s)i=38*i+27;else if(this.isNumerical(s))i=38*i+s.charCodeAt(0)+28-48;else if("\0"!==s)return 0}return i};static indexOfNumber=(t,i)=>{for(let e=i;e<t.length&&0<=e;e++)if(this.isNumerical(t[e]))return e;return-1};static indexOfNonNumber=(t,i)=>{for(let e=t;e<i.length&&0<=e;e++)if(!this.isNumerical(i[e]))return e;return i.length};static getEmulatedDomainCharLen=(e,t,i)=>t===i||"o"===t&&"0"===i?1:"o"===t&&"("===i&&")"===e?2:"c"===t&&("("===i||"<"===i||"["===i)||"e"===t&&"€"===i||"s"===t&&"$"===i||"l"===t&&"i"===i?1:0;static filterDomain=(t,i,s,a)=>{var r=s.length,h=a.length;for(let e=0;e<=h-r;e++){var l,{matched:n,currentIndex:o}=this.findMatchingDomain(e,s,a);n&&(n=this.prefixSymbolStatus(e,a,3,i,["@"]),l=this.suffixSymbolStatus(o-1,a,3,t,[".",","]),2<n||2<l)&&this.maskChars(e,o,a)}};static findMatchingDomain=(e,t,i)=>{var s=t.length;let a=e,r=0;for(;a<i.length&&r<s;){var h=i[a],l=a+1<i.length?i[a+1]:"\0",n=this.getEmulatedDomainCharLen(l,String.fromCharCode(t[r]),h);if(0<n)a+=n,r++;else{if(0===r)break;n=this.getEmulatedDomainCharLen(l,String.fromCharCode(t[r-1]),h);if(0<n)a+=n,1===r&&e++;else{if(r>=s||!this.isSymbol(h))break;a++}}}return{matched:r>=s,currentIndex:a}};static filterBadCombinations=(i,h,s)=>{if(!(s.length>h.length))for(let r=0;r<=h.length-s.length;r++){var l=r,{currentIndex:n,badIndex:o,hasSymbol:c,hasNumber:a,hasDigit:d}=this.processBadCharacters(h,s,l);let e=h[l=n],t=l+1<h.length?h[l+1]:"\0";if(o>=s.length&&(!a||!d)){let s=!0,a;if(c){let e=!1,t=!1;if((r-1<0||this.isSymbol(h[r-1])&&"'"!==h[r-1])&&(e=!0),(l>=h.length||this.isSymbol(h[l])&&"'"!==h[l])&&(t=!0),!e||!t){let i=!1;for(a=r-2,e&&(a=r);!i&&a<l;){if(0<=a&&(!this.isSymbol(h[a])||"'"===h[a])){var u=[];let e;for(e=0;e<3&&a+e<h.length&&(!this.isSymbol(h[a+e])||"'"===h[a+e]);e++)u[e]=h[a+e];let t=!0;0===e&&(t=!1),(t=e<3&&0<=a-1&&(!this.isSymbol(h[a-1])||"'"===h[a-1])?!1:t)&&!this.isBadFragment(u)&&(i=!0)}a++}i||(s=!1)}}else{e=" ",0<=r-1&&(e=h[r-1]),t=" ",l<h.length&&(t=h[l]);n=this.getIndex(e),o=this.getIndex(t);i&&this.comboMatches(n,i,o)&&(s=!1)}if(s){let t=0,i=0;for(let e=r;e<l;e++)this.isNumerical(h[e])?t++:this.isAlpha(h[e])&&i++;t<=i&&this.maskChars(r,l,h)}}}};static processBadCharacters=(t,i,s)=>{let a=s,r=0,h=0,l=!1,n=!1,o=!1;for(;a<t.length&&(!n||!o)&&!(a>=t.length||n&&o);){var c=t[a],d=a+1<t.length?t[a+1]:"\0";let e;if(r<i.length&&0<(e=this.getEmulatedBadCharLen(d,String.fromCharCode(i[r]),c)))1===e&&this.isNumerical(c)&&(n=!0),2===e&&(this.isNumerical(c)||this.isNumerical(d))&&(n=!0),a+=e,r++;else{if(0===r)break;if(0<(d=this.getEmulatedBadCharLen(d,String.fromCharCode(i[r-1]),c)))a+=d;else{if(r>=i.length||!this.isNotLowercaseAlpha(c))break;if(this.isSymbol(c)&&"'"!==c&&(l=!0),this.isNumerical(c)&&(o=!0),a++,90<(100*++h/(a-s)|0))break}}}return{currentIndex:a,badIndex:r,hasSymbol:l,hasNumber:n,hasDigit:o}};static getEmulatedBadCharLen=(e,t,i)=>{if(t===i)return 1;if("a"<=t&&t<="m"){if("a"===t)return"4"!==i&&"@"!==i&&"^"!==i?"/"===i&&"\\"===e?2:0:1;if("b"===t)return"6"!==i&&"8"!==i?"1"===i&&"3"===e?2:0:1;if("c"===t)return"("!==i&&"<"!==i&&"{"!==i&&"["!==i?0:1;if("d"===t)return"["===i&&")"===e?2:0;if("e"===t)return"3"!==i&&"€"!==i?0:1;if("f"===t)return"p"===i&&"h"===e?2:"£"===i?1:0;if("g"===t)return"9"!==i&&"6"!==i?0:1;if("h"===t)return"#"===i?1:0;if("i"===t)return"y"!==i&&"l"!==i&&"j"!==i&&"1"!==i&&"!"!==i&&":"!==i&&";"!==i&&"|"!==i?0:1;if("j"===t)return 0;if("k"===t)return 0;if("l"===t)return"1"!==i&&"|"!==i&&"i"!==i?0:1;if("m"===t)return 0}if("n"<=t&&t<="z"){if("n"===t)return 0;if("o"===t)return"0"!==i&&"*"!==i?"("===i&&")"===e||"["===i&&"]"===e||"{"===i&&"}"===e||"<"===i&&">"===e?2:0:1;if("p"===t)return 0;if("q"===t)return 0;if("r"===t)return 0;if("s"===t)return"5"!==i&&"z"!==i&&"$"!==i&&"2"!==i?0:1;if("t"===t)return"7"!==i&&"+"!==i?0:1;if("u"===t)return"v"===i?1:"\\"===i&&"/"===e||"\\"===i&&"|"===e||"|"===i&&"/"===e?2:0;if("v"===t)return"\\"===i&&"/"===e||"\\"===i&&"|"===e||"|"===i&&"/"===e?2:0;if("w"===t)return"v"===i&&"v"===e?2:0;if("x"===t)return")"===i&&"("===e||"}"===i&&"{"===e||"]"===i&&"["===e||">"===i&&"<"===e?2:0;if("y"===t)return 0;if("z"===t)return 0}return"0"<=t&&t<="9"?"0"===t?"o"===i||"O"===i?1:"("===i&&")"===e||"{"===i&&"}"===e||"["===i&&"]"===e?2:0:"1"===t&&"l"===i?1:0:","===t?"."===i?1:0:"."===t?","===i?1:0:"!"===t&&"i"===i?1:0};static comboMatches=(e,t,i)=>{let s=0,a=t.length-1;for(;s<=a;){var r=(s+a)/2|0;if(t[r][0]===e&&t[r][1]===i)return!0;e<t[r][0]||e===t[r][0]&&i<t[r][1]?a=r-1:s=1+r}return!1};static getIndex=e=>this.isLowercaseAlpha(e)?1+e.charCodeAt(0)-97:"'"===e?28:this.isNumerical(e)?29+e.charCodeAt(0)-48:27;static filterTld=(r,t,h,e,l)=>{if(!(e.length>h.length))for(let a=0;a<=h.length-e.length;a++){var{currentIndex:n,tldIndex:o}=this.processTlds(h,e,a);if(!(o<e.length)){let e=!1;var o=this.prefixSymbolStatus(a,h,3,l,[",","."]),c=this.suffixSymbolStatus(n-1,h,5,r,["\\","/"]);if(1===t&&0<o&&0<c&&(e=!0),2===t&&(2<o&&0<c||0<o&&2<c)&&(e=!0),e=3===t&&0<o&&2<c?!0:e){let e=a,t=n-1,i=!1,s;if(2<o){if(4===o)for(i=!1,s=a-1;0<=s;s--)if(i){if("*"!==l[s])break;e=s}else"*"===l[s]&&(e=s,i=!0);for(i=!1,s=e-1;0<=s;s--)if(i){if(this.isSymbol(h[s]))break;e=s}else this.isSymbol(h[s])||(i=!0,e=s)}if(2<c){if(4===c)for(i=!1,s=t+1;s<h.length;s++)if(i){if("*"!==r[s])break;t=s}else"*"===r[s]&&(t=s,i=!0);for(i=!1,s=t+1;s<h.length;s++)if(i){if(this.isSymbol(h[s]))break;t=s}else this.isSymbol(h[s])||(i=!0,t=s)}this.maskChars(e,t+1,h)}}}};static processTlds=(e,t,i)=>{let s=0;for(;i<e.length&&s<t.length;){var a,r=e[i],h=i+1<e.length?e[i+1]:"\0";if(0<(a=this.getEmulatedDomainCharLen(h,String.fromCharCode(t[s]),r)))i+=a,s++;else{if(0===s)break;if(0<(a=this.getEmulatedDomainCharLen(h,String.fromCharCode(t[s-1]),r)))i+=a;else{if(!this.isSymbol(r))break;i++}}}return{currentIndex:i,tldIndex:s}};static isSymbol=e=>!this.isAlpha(e)&&!this.isNumerical(e);static isNotLowercaseAlpha=e=>!this.isLowercaseAlpha(e)||"v"===e||"x"===e||"j"===e||"q"===e||"z"===e;static isAlpha=e=>this.isLowercaseAlpha(e)||this.isUppercaseAlpha(e);static isNumerical=e=>"0"<=e&&e<="9";static isLowercaseAlpha=e=>"a"<=e&&e<="z";static isUppercaseAlpha=e=>"A"<=e&&e<="Z";static isNumericalChars=t=>{for(let e=0;e<t.length;e++)if(!this.isNumerical(t[e])&&"\0"!==t[e])return!1;return!0};static maskChars=(t,i,s)=>{for(let e=t;e<i;e++)s[e]="*"};static maskedCountBackwards=(t,i)=>{let s=0;for(let e=i-1;0<=e&&this.isSymbol(t[e]);e--)"*"===t[e]&&s++;return s};static maskedCountForwards=(t,i)=>{let s=0;for(let e=i+1;e<t.length&&this.isSymbol(t[e]);e++)"*"===t[e]&&s++;return s};static maskedCharsStatus=(e,t,i,s,a)=>s<=(a?this.maskedCountBackwards(t,i):this.maskedCountForwards(t,i))?4:this.isSymbol(a?e[i-1]:e[i+1])?1:0;static prefixSymbolStatus=(t,i,e,s,a)=>{if(0===t)return 2;for(let e=t-1;0<=e&&this.isSymbol(i[e]);e--)if(a.includes(i[e]))return 3;return this.maskedCharsStatus(i,s,t,e,!0)};static suffixSymbolStatus=(t,i,e,s,a)=>{if(t+1===i.length)return 2;for(let e=t+1;e<i.length&&this.isSymbol(i[e]);e++)if(a.includes(i[e]))return 3;return this.maskedCharsStatus(i,s,t,e,!1)};static format=t=>{let i=0;for(let e=0;e<t.length;e++)this.isCharacterAllowed(t[e])?t[i]=t[e]:t[i]=" ",0!==i&&" "===t[i]&&" "===t[i-1]||i++;for(let e=i;e<t.length;e++)t[e]=" "};static isCharacterAllowed=e=>" "<=e&&e<=""||" "===e||e===`
`||"\t"===e||"£"===e||"€"===e;static replaceUppercases=(t,i)=>{for(let e=0;e<i.length;e++)"*"!==t[e]&&this.isUppercaseAlpha(i[e])&&(t[e]=i[e])};static formatUppercases=t=>{let i=!0;for(let e=0;e<t.length;e++){var s=t[e];this.isAlpha(s)?i?this.isLowercaseAlpha(s)&&(i=!1):this.isUppercaseAlpha(s)&&(t[e]=String.fromCharCode(97+s.charCodeAt(0)-65)):i=!0}}}class Ot{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","£","$","%",'"',"[","]"];static charBuffer=[];static unpack=(t,i)=>{let s=0,a=-1;for(let e=0;e<i&&s<100;e++){var r=t.g1,h=r>>4&15;-1!==a?(this.charBuffer[s++]=this.TABLE[(a<<4)+h-195],a=-1):h<13?this.charBuffer[s++]=this.TABLE[h]:a=h,h=15&r,-1!==a?(this.charBuffer[s++]=this.TABLE[(a<<4)+h-195],a=-1):h<13?this.charBuffer[s++]=this.TABLE[h]:a=h}let l=!0;for(let e=0;e<s;e++){var n=this.charBuffer[e];l&&"a"<=n&&n<="z"&&(this.charBuffer[e]=n.toUpperCase(),l=!1),"."!==n&&"!"!==n||(l=!0)}return this.charBuffer.slice(0,s).join("")};static pack=(i,s)=>{s=(s=80<s.length?s.substring(0,80):s).toLowerCase();let a=-1;for(let e=0;e<s.length;e++){var r=s[0|e]||"";let t=0;for(let e=0;e<this.TABLE.length;e++)if(r===this.TABLE[e]){t=e;break}12<t&&(t+=195),-1===a?t<13?a=t:i.p1(t):a=t<13?(i.p1((a<<4)+t),-1):(i.p1((a<<4)+(t>>4)),15&t)}-1!==a&&i.p1(a<<4)}}class Ie{start=0;end=0;form=0;length=0;shapeDelta=null;shapePeak=null;threshold=0;position=0;delta=0;amplitude=0;ticks=0;read(t){this.form=t.g1,this.start=t.g4,this.end=t.g4,this.length=t.g1,this.shapeDelta=new Int32Array(this.length),this.shapePeak=new Int32Array(this.length);for(let e=0;e<this.length;e++)this.shapeDelta[e]=t.g2,this.shapePeak[e]=t.g2}reset(){this.threshold=0,this.position=0,this.delta=0,this.amplitude=0,this.ticks=0}evaluate(e){return this.ticks>=this.threshold&&this.shapePeak&&this.shapeDelta&&(this.amplitude=this.shapePeak[this.position++]<<15,this.position>=this.length&&(this.position=this.length-1),this.threshold=this.shapeDelta[this.position]/65536*e|0,this.threshold>this.ticks)&&(this.delta=((this.shapePeak[this.position]<<15)-this.amplitude)/(this.threshold-this.ticks)|0),this.amplitude+=this.delta,this.ticks++,this.amplitude-this.delta>>15}}class m{static buffer=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;release=null;attack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);start=0;length=500;reverbVolume=100;reverbDelay=0;static init=()=>{this.noise=new Int32Array(32768);for(let e=0;e<32768;e++)this.noise[e]=.5<Math.random()?1:-1;this.sin=new Int32Array(32768);for(let e=0;e<32768;e++)this.sin[e]=16384*Math.sin(e/5215.1903)|0;this.buffer=new Int32Array(220500)};generate(o,t){for(let e=0;e<o;e++)m.buffer[e]=0;if(!(t<10)){var c,d,u,i=o/t|0;this.frequencyBase?.reset(),this.amplitudeBase?.reset();let e=0,a=0,r=0,h=(this.frequencyModRate&&this.frequencyModRange&&(this.frequencyModRate.reset(),this.frequencyModRange.reset(),e=32.768*(this.frequencyModRate.end-this.frequencyModRate.start)/i|0,a=32.768*this.frequencyModRate.start/i|0),0),l=0,n=0;this.amplitudeModRate&&this.amplitudeModRange&&(this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),h=32.768*(this.amplitudeModRate.end-this.amplitudeModRate.start)/i|0,l=32.768*this.amplitudeModRate.start/i|0);for(let e=0;e<5;e++)this.frequencyBase&&0!==this.harmonicVolume[e]&&(m.tmpPhases[e]=0,m.tmpDelays[e]=this.harmonicDelay[e]*i,m.tmpVolumes[e]=(this.harmonicVolume[e]<<14)/100|0,m.tmpSemitones[e]=32.768*(this.frequencyBase.end-this.frequencyBase.start)*Math.pow(1.0057929410678534,this.harmonicSemitone[e])/i|0,m.tmpStarts[e]=32.768*this.frequencyBase.start/i|0);if(this.frequencyBase&&this.amplitudeBase)for(let s=0;s<o;s++){let t=this.frequencyBase.evaluate(o),i=this.amplitudeBase.evaluate(o);this.frequencyModRate&&this.frequencyModRange&&(d=this.frequencyModRate.evaluate(o),c=this.frequencyModRange.evaluate(o),t+=this.generate2(c,r,this.frequencyModRate.form)>>1,r+=(d*e>>16)+a),this.amplitudeModRate&&this.amplitudeModRange&&(c=this.amplitudeModRate.evaluate(o),d=this.amplitudeModRange.evaluate(o),i=i*(32768+(this.generate2(d,n,this.amplitudeModRate.form)>>1))>>15,n+=(c*h>>16)+l);for(let e=0;e<5;e++)0!==this.harmonicVolume[e]&&(u=s+m.tmpDelays[e])<o&&(m.buffer[u]+=this.generate2(i*m.tmpVolumes[e]>>15,m.tmpPhases[e],this.frequencyBase.form),m.tmpPhases[e]+=(t*m.tmpSemitones[e]>>16)+m.tmpStarts[e])}if(this.release&&this.attack){this.release.reset(),this.attack.reset();let i=0,s=!0;for(let t=0;t<o;t++){var f=this.release.evaluate(o),p=this.attack.evaluate(o);let e;e=s?this.release.start+((this.release.end-this.release.start)*f>>8):this.release.start+((this.release.end-this.release.start)*p>>8),(i+=256)>=e&&(i=0,s=!s),s&&(m.buffer[t]=0)}}if(0<this.reverbDelay&&0<this.reverbVolume){var s=this.reverbDelay*i;for(let e=s;e<o;e++)m.buffer[e]+=m.buffer[e-s]*this.reverbVolume/100|0,m.buffer[e]|=0}for(let e=0;e<o;e++)m.buffer[e]<-32768&&(m.buffer[e]=-32768),32767<m.buffer[e]&&(m.buffer[e]=32767)}return m.buffer}generate2(e,t,i){return 1===i?(32767&t)<16384?e:-e:2===i?m.sin[32767&t]*e>>14:3===i?((32767&t)*e>>14)-e:4===i?m.noise[32767&(t/2607|0)]*e:0}read(t){this.frequencyBase=new Ie,this.frequencyBase.read(t),this.amplitudeBase=new Ie,this.amplitudeBase.read(t),0!==t.g1&&(t.pos--,this.frequencyModRate=new Ie,this.frequencyModRate.read(t),this.frequencyModRange=new Ie,this.frequencyModRange.read(t)),0!==t.g1&&(t.pos--,this.amplitudeModRate=new Ie,this.amplitudeModRate.read(t),this.amplitudeModRange=new Ie,this.amplitudeModRange.read(t)),0!==t.g1&&(t.pos--,this.release=new Ie,this.release.read(t),this.attack=new Ie,this.attack.read(t));for(let e=0;e<10;e++){var i=t.gsmarts;if(0===i)break;this.harmonicVolume[e]=i,this.harmonicSemitone[e]=t.gsmart,this.harmonicDelay[e]=t.gsmarts}this.reverbDelay=t.gsmarts,this.reverbVolume=t.gsmarts,this.length=t.g2,this.start=t.g2}}class yt{static delays=new Int32Array(1e3);static waveBytes=null;static waveBuffer=null;static tracks=new lt(1e3,null);tones=new lt(10,null);loopBegin=0;loopEnd=0;static unpack=e=>{var t=new ht(e.read("sounds.dat"));for(this.waveBytes=new Uint8Array(441e3),this.waveBuffer=new ht(this.waveBytes),m.init();;){var i=t.g2;if(65535===i)break;var s=new yt;s.read(t),this.tracks[i]=s,this.delays[i]=s.trim()}};static generate=(e,t)=>this.tracks[e]?this.tracks[e]?.getWave(t)??null:null;read(t){for(let e=0;e<10;e++)0!==t.g1&&(t.pos--,this.tones[e]=new m,this.tones[e]?.read(t));this.loopBegin=t.g2,this.loopEnd=t.g2}trim(){let t=9999999;for(let e=0;e<10;e++)this.tones[e]&&(this.tones[e].start/20|0)<t&&(t=this.tones[e].start/20|0);if(9999999===(t=this.loopBegin<this.loopEnd&&(this.loopBegin/20|0)<t?this.loopBegin/20|0:t)||0===t)return 0;for(let e=0;e<10;e++)this.tones[e]&&(this.tones[e].start-=20*t);return this.loopBegin<this.loopEnd&&(this.loopBegin-=20*t,this.loopEnd-=20*t),t}getWave(e){e=this.generate(e);return yt.waveBuffer.pos=0,yt.waveBuffer?.p4(1380533830),yt.waveBuffer?.ip4(e+36),yt.waveBuffer?.p4(1463899717),yt.waveBuffer?.p4(1718449184),yt.waveBuffer?.ip4(16),yt.waveBuffer?.ip2(1),yt.waveBuffer?.ip2(1),yt.waveBuffer?.ip4(22050),yt.waveBuffer?.ip4(22050),yt.waveBuffer?.ip2(1),yt.waveBuffer?.ip2(8),yt.waveBuffer?.p4(1684108385),yt.waveBuffer?.ip4(e),yt.waveBuffer.pos+=e,yt.waveBuffer}generate(t){let i=0;for(let e=0;e<10;e++)this.tones[e]&&this.tones[e].length+this.tones[e].start>i&&(i=this.tones[e].length+this.tones[e].start);if(0===i)return 0;var s=22050*i/1e3|0,a=22050*this.loopBegin/1e3|0,r=22050*this.loopEnd/1e3|0;let h=s+(r-a)*((t=a<0||r<0||s<r||r<=a?0:t)-1);for(let e=44;e<h+44;e++)yt.waveBytes&&(yt.waveBytes[e]=-128);for(let e=0;e<10;e++)if(this.tones[e]){var l=22050*this.tones[e].length/1e3|0,n=22050*this.tones[e].start/1e3|0,o=this.tones[e].generate(l,this.tones[e].length);for(let e=0;e<l;e++)yt.waveBytes&&(yt.waveBytes[e+n+44]+=o[e]>>8<<24>>24)}if(1<t){a+=44,r+=44,s+=44;var c=(h+=44)-s;for(let e=s-1;e>=r;e--)yt.waveBytes&&(yt.waveBytes[e+c]=yt.waveBytes[e]);for(let e=1;e<t;e++){var d=(r-a)*e;for(let e=a;e<r;e++)yt.waveBytes&&(yt.waveBytes[e+d]=yt.waveBytes[e])}h-=44}return h}}class Client extends class{slowestMS=0;averageMS=[];averageIndexMS=0;drawArea=null;state=0;deltime=20;mindel=1;otim=[];fps=0;fpos=0;frameTime=[];redrawScreen=!0;resizeToFit=!1;tfps=50;hasFocus=!0;ingame=!1;idleCycles=Date.now();mouseButton=0;mouseX=0;mouseY=0;mouseClickButton=0;mouseClickX=0;mouseClickY=0;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;input=null;touching=!1;startedInViewport=!1;startedInTabArea=!1;time=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;constructor(e=!1){n.tabIndex=-1,a.fillStyle="black",a.fillRect(0,0,n.width,n.height),this.resizeToFit=e,this.resizeToFit?this.resize(window.innerWidth,window.innerHeight):this.resize(n.width,n.height)}get width(){return n.width}get height(){return n.height}resize(e,t){n.width=e,n.height=t,this.drawArea=new E(e,t),_.init2D()}async run(){n.addEventListener("resize",()=>{this.resizeToFit&&this.resize(window.innerWidth,window.innerHeight)},!1),n.onfocus=this.onfocus.bind(this),n.onblur=this.onblur.bind(this),n.onmousedown=this.onmousedown.bind(this),n.onmouseup=this.onmouseup.bind(this),n.onmouseenter=this.onmouseenter.bind(this),n.onmouseleave=this.onmouseleave.bind(this),n.onmousemove=this.onmousemove.bind(this),n.onkeydown=this.onkeydown.bind(this),n.onkeyup=this.onkeyup.bind(this),this.isMobile&&(n.ontouchstart=this.ontouchstart.bind(this),n.ontouchend=this.ontouchend.bind(this),n.ontouchmove=this.ontouchmove.bind(this)),n.oncontextmenu=e=>{e.preventDefault()},window.oncontextmenu=e=>{e.preventDefault()},await this.showProgress(0,"Loading..."),await this.load();for(let e=0;e<10;e++)this.otim[e]=performance.now();var e;let t=0,i=256,s=1,a=0;for(;0<=this.state;){if(0<this.state&&(this.state--,0===this.state))return void this.shutdown();var r=i,h=s,l=(i=300,s=1,e=performance.now(),this.otim[t]);if(0===l?(i=r,s=h):l<e&&(i=2560*this.deltime/(e-l)|0),i<25?i=25:256<i&&(i=256,s=this.deltime-(e-l)/10|0),this.otim[t]=e,t=(t+1)%10,1<s)for(let e=0;e<10;e++)0!==this.otim[e]&&(this.otim[e]+=s);for(s<this.mindel&&(s=this.mindel),await p(s);a<256;)await this.update(),this.mouseClickButton=0,this.keyQueueReadPos=this.keyQueueWritePos,a+=i;a&=255,0<this.deltime&&(this.fps=1e3*i/(256*this.deltime)|0);r=performance.now();await this.draw(),this.frameTime[this.fpos]=(performance.now()-r)/1e3,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50&&0<(h=1e3/this.tfps-(performance.now()-e))&&await p(h)}-1===this.state&&this.shutdown()}shutdown(){this.state=-2}setFramerate(e){this.deltime=1e3/e|0}setTargetedFramerate(e){this.tfps=Math.max(Math.min(50,0|e),0)}start(){0<=this.state&&(this.state=0)}stop(){0<=this.state&&(this.state=4e3/this.deltime|0)}destroy(){this.state=-1}async load(){}async update(){}async draw(){}async refresh(){}async showProgress(e,t){var i=this.width,s=this.height,s=(this.redrawScreen&&(a.fillStyle="black",a.fillRect(0,0,i,s),this.redrawScreen=!1),s/2-18);a.fillStyle="rgb(140, 17, 17)",a.rect((i/2|0)-152,s,304,34),a.fillRect((i/2|0)-150,2+s,3*e,30),a.fillStyle="black",a.fillRect((i/2|0)-150+3*e,2+s,300-3*e,30),a.font="bold 13px helvetica, sans-serif",a.textAlign="center",a.fillStyle="white",a.fillText(t,i/2|0,22+s),await p(5)}pollKey(){let e=-1;return this.keyQueueWritePos!==this.keyQueueReadPos&&(e=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127),e}get ms(){var t=this.frameTime.length;let i=0;for(let e=0;e<t;e++)i+=this.frameTime[e];var e=i/t*1e3;return e>this.slowestMS&&(this.slowestMS=e),this.averageMS[this.averageIndexMS]=e,this.averageIndexMS=(this.averageIndexMS+1)%250,e}get msAvg(){return this.averageMS.reduce((e,t)=>e+t,0)/250}onkeydown(t){this.idleCycles=Date.now();var i=e.get(t.key);if(i&&(0!==t.code.length||t.isTrusted)){let e=i.ch;t.ctrlKey&&(65<=e&&e<=93||95==e?e-=64:97<=e&&e<=122&&(e-=96)),0<e&&e<128&&(this.actionKey[e]=1),4<e&&(this.keyQueue[this.keyQueueWritePos]=e,this.keyQueueWritePos=this.keyQueueWritePos+1&127),nt.enabled&&nt.keyPressed(e),T.includes(t.key)||t.preventDefault()}}onkeyup(t){this.idleCycles=Date.now();var i=e.get(t.key);if(i&&(0!==t.code.length||t.isTrusted)){let e=i.ch;t.ctrlKey&&(65<=e&&e<=93||95==e?e-=64:97<=e&&e<=122&&(e-=96)),0<e&&e<128&&(this.actionKey[e]=0),nt.enabled&&nt.keyReleased(e),T.includes(t.key)||t.preventDefault()}}onmousedown(e){if(this.touching=!1,(0<e.clientX||0<e.clientY)&&this.setMousePosition(e),this.idleCycles=Date.now(),this.mouseClickX=this.mouseX,this.mouseClickY=this.mouseY,this.isMobile&&!this.isCapacitor){if(this.insideChatInputArea()||this.insideUsernameArea()||this.inPasswordArea())return this.mouseClickButton=1,void(this.mouseButton=1);e.timeStamp>=this.time+500?(this.mouseClickButton=2,this.mouseButton=2):(this.mouseClickButton=1,this.mouseButton=1)}else 2===e.button?(this.mouseClickButton=2,this.mouseButton=2):(this.mouseClickButton=1,this.mouseButton=1);nt.enabled&&nt.mousePressed(this.mouseClickX,this.mouseClickY,e.button)}onmouseup(e){this.setMousePosition(e),this.idleCycles=Date.now(),this.mouseButton=0,nt.enabled&&nt.mouseReleased(e.button)}onmouseenter(e){this.setMousePosition(e),nt.enabled&&nt.mouseEntered()}onmouseleave(e){this.setMousePosition(e),this.idleCycles=Date.now(),this.mouseX=-1,this.mouseY=-1,this.mouseButton=0,this.mouseClickX=-1,this.mouseClickY=-1,nt.enabled&&nt.mouseExited()}onmousemove(e){this.setMousePosition(e),this.idleCycles=Date.now(),nt.enabled&&nt.mouseMoved(this.mouseX,this.mouseY)}onfocus(e){this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),nt.enabled&&nt.focusGained()}onblur(e){this.hasFocus=!1;for(let e=0;e<128;e++)this.actionKey[e]=0;nt.enabled&&nt.focusLost()}ontouchstart(e){var t,i;this.isMobile&&(null!==this.input&&(this.input.parentNode?.removeChild(this.input),this.input=null),this.touching=!0,i=0|(t=e.changedTouches[0]).clientX,this.onmousemove(new MouseEvent("mousemove",{clientX:i,clientY:0|t.clientY})),this.sx=this.nx=this.mx=0|t.screenX,this.sy=this.ny=this.my=0|t.screenY,this.time=e.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea())}ontouchend(e){var t,i,s;this.isMobile&&this.touching&&(t=0|(s=e.changedTouches[0]).clientX,i=0|s.clientY,this.onmousemove(new MouseEvent("mousemove",{clientX:t,clientY:i})),this.nx=0|s.screenX,this.ny=0|s.screenY,this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.startedInViewport&&!this.insideViewportArea()||this.startedInTabArea&&!this.insideTabArea()?this.touching=!1:this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()?(null!==this.input&&(this.input.parentNode?.contains(this.input)&&this.input.parentNode?.removeChild(this.input),this.input=null),s=document.createElement("input"),this.insideUsernameArea()?(s.setAttribute("id","username"),s.setAttribute("placeholder","Username")):this.inPasswordArea()?(s.setAttribute("id","password"),s.setAttribute("placeholder","Password")):this.insideChatInputArea()?(s.setAttribute("id","chatinput"),s.setAttribute("placeholder","Chatinput")):this.insideChatPopupArea()&&(s.setAttribute("id","chatpopup"),s.setAttribute("placeholder","Chatpopup")),this.isAndroid?s.setAttribute("type","password"):s.setAttribute("type",this.inPasswordArea()?"password":"text"),s.setAttribute("autofocus","autofocus"),s.setAttribute("spellcheck","false"),s.setAttribute("autocomplete","off"),s.setAttribute("style",`position: fixed; left: ${t}px; top: ${i}px; width: 1px; height: 1px; opacity: 0;`),document.body.appendChild(s),s.focus(),s.click(),this.isAndroid&&(s.oninput=e=>{var t;e instanceof InputEvent&&null!==(t=e.data)&&"insertText"===e.inputType&&this.onkeydown(new KeyboardEvent("keydown",{key:t,code:t}))}),s.onkeydown=e=>{this.isAndroid&&"Enter"!==e.key&&"Backspace"!==e.key||this.onkeydown(new KeyboardEvent("keydown",{key:e.key,code:e.key}))},s.onkeyup=e=>{this.isAndroid&&"Enter"!==e.key&&"Backspace"!==e.key||this.onkeyup(new KeyboardEvent("keyup",{key:e.key,code:e.key}))},s.onfocus=e=>{this.input?.parentNode?.removeChild(this.input),this.input=null,this.onfocus(e)},this.input=s,this.touching=!1):(s=e.timeStamp>=this.time+500,e=16<Math.abs(this.sx-this.nx)||16<Math.abs(this.sy-this.ny),s&&!e&&(this.touching=!0,this.onmousedown(new MouseEvent("mousedown",{clientX:t,clientY:i,button:2})))))}ontouchmove(e){var t,i;this.isMobile&&this.touching&&(1<e.touches.length||(e.preventDefault(),t=0|(e=e.changedTouches[0]).clientX,i=0|e.clientY,this.onmousemove(new MouseEvent("mousemove",{clientX:t,clientY:i})),this.nx=0|e.screenX,this.ny=0|e.screenY,this.startedInViewport&&-1===this.getViewportInterfaceId()?(0<this.mx-this.nx?this.rotate(2):this.mx-this.nx<0&&this.rotate(0),0<this.my-this.ny?this.rotate(3):this.my-this.ny<0&&this.rotate(1)):!this.startedInTabArea&&-1===this.getViewportInterfaceId()||this.onmousedown(new MouseEvent("mousedown",{clientX:t,clientY:i,button:1})),this.mx=this.nx,this.my=this.ny))}get isMobile(){return["Android","webOS","iPhone","iPad","iPod","BlackBerry","Windows Phone"].some(e=>navigator.userAgent.includes(e))}get isAndroid(){return["Android"].some(e=>navigator.userAgent.includes(e))}get isCapacitor(){return["Capacitor"].some(e=>navigator.userAgent.includes(e))}insideViewportArea(){return this.ingame&&8<=this.mouseX&&this.mouseX<=520&&11<=this.mouseY&&this.mouseY<=345}insideChatInputArea(){return this.ingame&&-1===this.getChatInterfaceId()&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&11<=this.mouseX&&this.mouseX<=506&&449<=this.mouseY&&this.mouseY<=482}insideChatPopupArea(){return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&11<=this.mouseX&&this.mouseX<=506&&383<=this.mouseY&&this.mouseY<=482}insideTabArea(){return this.ingame&&562<=this.mouseX&&this.mouseX<=752&&231<=this.mouseY&&this.mouseY<=492}insideUsernameArea(){return!this.ingame&&2===this.getTitleScreenState()&&301<=this.mouseX&&this.mouseX<=562&&262<=this.mouseY&&this.mouseY<=279}inPasswordArea(){return!this.ingame&&2===this.getTitleScreenState()&&301<=this.mouseX&&this.mouseX<=562&&279<=this.mouseY&&this.mouseY<=296}rotate(e){0===e?(this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowLeft",code:"ArrowLeft"}))):1===e?(this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowUp",code:"ArrowUp"}))):2===e?(this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowRight",code:"ArrowRight"}))):3===e&&(this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown"})))}isFullScreen(){return null!==document.fullscreenElement}setMousePosition(a){var e=n.getBoundingClientRect();const r=a.clientX-e.left,h=a.clientY-e.top;if(this.isFullScreen()){a=789/532;let e=0,t=0,i=0,s=0;a<=window.innerWidth/window.innerHeight?(e=window.innerHeight*a,t=window.innerHeight,i=(window.innerWidth-e)/2):(e=window.innerWidth,t=window.innerWidth/a,s=(window.innerHeight-t)/2);var a=789/e,l=532/t;this.mouseX=(r-i)*a|0,this.mouseY=(h-s)*l|0}else{a=n.width/e.width,l=n.height/e.height;this.mouseX=r*a|0,this.mouseY=h*l|0}this.mouseX<0&&(this.mouseX=0),this.mouseY<0&&(this.mouseY=0),789<this.mouseX&&(this.mouseX=789),532<this.mouseY&&(this.mouseY=532)}mapCoord(e,t,i,s,a){return(e-t)*(a-s)/(i-t)+s}}{static clientversion=225;static nodeId=10;static members=!0;static lowMemory=!1;static loginExp=BigInt("58778699976184461502525193738213253649000149147835990136706041084440742975821");static loginMod=BigInt("7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789");static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;static setHighMemory=()=>{X.lowMemory=!1,_.lowMemory=!1,Client.lowMemory=!1,mt.lowMemory=!1};static setLowMemory=()=>{X.lowMemory=!0,_.lowMemory=!0,Client.lowMemory=!0,mt.lowMemory=!0};MAX_PLAYER_COUNT=2048;LOCAL_PLAYER_INDEX=2047;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;errorMessage=null;db=null;loopCycle=0;archiveChecksums=[];stream=null;in=ht.alloc(1);out=ht.alloc(1);loginout=ht.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;packetType=0;packetSize=0;lastPacketType0=0;lastPacketType1=0;lastPacketType2=0;titleArchive=null;redrawTitleBackground=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";username="";password="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBacktop2=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new lt(13,null);imageMinimap=null;imageCompass=null;imageMapscene=new lt(50,null);imageMapfunction=new lt(50,null);imageHitmarks=new lt(20,null);imageHeadicons=new lt(20,null);imageMapflag=null;imageCrosses=new lt(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new lt(1e3,null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new ft;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];publicChatSetting=0;privateChatSetting=0;tradeChatSetting=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialAction=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new lt(100,null);messageSender=new lt(100,null);messageType=new Int32Array(100);messageIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;mouseButtonsOption=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceID=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1e3);activeMapFunctionZ=new Int32Array(1e3);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;cameraOffsetCycle=0;cameraAnticheatOffsetX=0;cameraAnticheatOffsetZ=0;cameraAnticheatAngle=0;cameraOffsetXModifier=2;cameraOffsetZModifier=2;cameraOffsetYawModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new lt(5,!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;minimapOffsetCycle=0;minimapAnticheatAngle=0;minimapZoom=0;minimapZoomModifier=1;minimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLocData=null;sceneMapIndex=null;mapLastBaseX=0;mapLastBaseZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new lt(pt.LEVELS,null);currentLevel=0;cameraMovedWrite=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new w(pt.SIZE,pt.SIZE);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new lt(this.MAX_PLAYER_COUNT,null);playerCount=0;playerIds=new Int32Array(this.MAX_PLAYER_COUNT);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(this.MAX_PLAYER_COUNT);entityRemovalIds=new Int32Array(1e3);playerAppearanceBuffer=new lt(this.MAX_PLAYER_COUNT,null);npcs=new lt(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new O;spotanims=new O;locList=new O;temporaryLocs=new O;levelObjStacks=new y(pt.LEVELS,pt.SIZE,pt.SIZE,null);spawnedLocations=new O;bfsStepX=new Int32Array(4e3);bfsStepZ=new Int32Array(4e3);bfsDirection=new Int32Array(pt.SIZE*pt.SIZE);bfsCost=new Int32Array(pt.SIZE*pt.SIZE);tryMoveNearest=0;localPlayer=null;energy=0;inMultizone=0;localPid=-1;weightCarried=0;heartbeatTimer=0;wildernessLevel=0;worldLocationState=0;rights=!1;designGenderMale=!0;updateDesignModel=!1;designIdentikits=new Int32Array(7);designColors=new Int32Array(5);friendCount=0;chatCount=0;static MAX_CHATS=50;chatX=new Int32Array(Client.MAX_CHATS);chatY=new Int32Array(Client.MAX_CHATS);chatHeight=new Int32Array(Client.MAX_CHATS);chatWidth=new Int32Array(Client.MAX_CHATS);chatColors=new Int32Array(Client.MAX_CHATS);chatStyles=new Int32Array(Client.MAX_CHATS);chatTimers=new Int32Array(Client.MAX_CHATS);chats=new lt(Client.MAX_CHATS,null);friendName=new lt(100,null);friendName37=new BigInt64Array(100);friendWorld=new Int32Array(100);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=64;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=!0;currentMidi=null;midiCrc=0;midiSize=0;midiVolume=64;displayFps=!1;constructor(e,t,i){super(),void 0!==e&&void 0!==t&&void 0!==i&&(Client.nodeId=e,Client.members=i,t?Client.setLowMemory():Client.setHighMemory(),this.run())}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}unloadTitle=()=>{this.flameActive=!1,this.flamesInterval&&(clearInterval(this.flamesInterval),this.flamesInterval=null),this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null};loadArchive=async(e,t,i,s)=>{let a=5,r=await this.db?.cacheload(e);if(!(r=r&&ht.crc32(r)!==i?void 0:r)){for(;!r;){await this.showProgress(s,"Requesting "+t);try{r=await F("/"+e+i)}catch(e){r=void 0;for(let e=a;0<e;e--)await this.showProgress(s,`Error loading - Will retry in ${e} secs.`),await p(1e3);60<(a*=2)&&(a=60)}}await this.db?.cachesave(e,r)}return new Oe(r)};setMidi=async(t,i,s,a)=>{try{let e=await this.db?.cacheload(t+".mid");if(!(e=e&&12345678!==i&&ht.crc32(e)!==i?void 0:e)||!e.length)try{s!==(e=await F(`/${t}_${i}.mid`)).length&&(e=e.slice(0,s))}catch(e){}if(e)try{await this.db?.cachesave(t+".mid",e);var r=vt.decompress(e,-1,!1,!0);wt(r,this.midiVolume,a)}catch(e){}}catch(e){}};drawError=()=>{a.fillStyle="black",a.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.flameActive=!1;let e=35;this.errorLoading?(a.font="bold 16px helvetica, sans-serif",a.textAlign="left",a.fillStyle="yellow",a.fillText("Sorry, an error has occured whilst loading RuneScape",30,e),e+=50,a.fillStyle="white",a.fillText("To fix this try the following (in order):",30,e),e+=50,a.font="bold 12px helvetica, sans-serif",a.fillText("1: Try closing ALL open web-browser windows, and reloading",30,e),e+=30,a.fillText("2: Try clearing your web-browsers cache",30,e),e+=30,a.fillText("3: Try using a different game-world",30,e),e+=30,a.fillText("4: Try rebooting your computer",30,e)):this.errorHost?(a.font="bold 20px helvetica, sans-serif",a.textAlign="left",a.fillStyle="white",a.fillText("Error - unable to load game!",50,50),a.fillText("To play RuneScape make sure you play from",50,100),a.fillText("an approved domain",50,150)):this.errorStarted&&(a.font="bold 13px helvetica, sans-serif",a.textAlign="left",a.fillStyle="yellow",a.fillText("Error a copy of RuneScape already appears to be loaded",30,e),e+=50,a.fillStyle="white",a.fillText("To fix this try the following (in order):",30,e),e+=50,a.font="bold 12px helvetica, sans-serif",a.fillText("1: Try closing ALL open web-browser windows, and reloading",30,e),e+=30,a.fillText("2: Try rebooting your computer, and reloading",30,e)),this.errorMessage&&(e+=50,a.fillStyle="red",a.fillText("Error: "+this.errorMessage,30,e))};executeInterfaceScript=t=>{if(!t.scriptComparator)return!1;for(let e=0;e<t.scriptComparator.length;e++){var i=this.executeClientscript1(t,e);if(!t.scriptOperand)return!1;var s=t.scriptOperand[e];if(2===t.scriptComparator[e]){if(s<=i)return!1}else if(3===t.scriptComparator[e]){if(i<=s)return!1}else if(4===t.scriptComparator[e]){if(i===s)return!1}else if(i!==s)return!1}return!0};drawScrollbar=(e,t,i,s,a)=>{this.imageScrollbar0?.draw(e,t),this.imageScrollbar1?.draw(e,t+a-16),D.fillRect(e,t+16,16,a-32,ct.SCROLLBAR_TRACK);let r=(a-32)*a/s|0;i=(a-(r=r<8?8:r)-32)*i/(s-a)|0;D.fillRect(e,t+i+16,16,r,ct.SCROLLBAR_GRIP_FOREGROUND),D.drawVerticalLine(e,t+i+16,ct.SCROLLBAR_GRIP_HIGHLIGHT,r),D.drawVerticalLine(e+1,t+i+16,ct.SCROLLBAR_GRIP_HIGHLIGHT,r),D.drawHorizontalLine(e,t+i+16,ct.SCROLLBAR_GRIP_HIGHLIGHT,16),D.drawHorizontalLine(e,t+i+17,ct.SCROLLBAR_GRIP_HIGHLIGHT,16),D.drawVerticalLine(e+15,t+i+16,ct.SCROLLBAR_GRIP_LOWLIGHT,r),D.drawVerticalLine(e+14,t+i+17,ct.SCROLLBAR_GRIP_LOWLIGHT,r-1),D.drawHorizontalLine(e,t+i+r+15,ct.SCROLLBAR_GRIP_LOWLIGHT,16),D.drawHorizontalLine(e+1,t+i+r+14,ct.SCROLLBAR_GRIP_LOWLIGHT,15)};updateInterfaceAnimation=(e,t)=>{let i=!1;var s=ft.instances[e];if(!s.childId)return!1;for(let e=0;e<s.childId.length&&-1!==s.childId[e];e++){var a=ft.instances[s.childId[e]];if(1===a.type&&(i||=this.updateInterfaceAnimation(a.id,t)),6===a.type&&(-1!==a.anim||-1!==a.activeAnim)){var r=this.executeInterfaceScript(a);let e;if(-1!==(e=r?a.activeAnim:a.anim)){var h=R.instances[e];if(a.seqCycle+=t,h.delay)for(;a.seqCycle>h.delay[a.seqFrame];)a.seqCycle-=h.delay[a.seqFrame]+1,a.seqFrame++,a.seqFrame>=h.frameCount&&(a.seqFrame-=h.replayoff,a.seqFrame<0||a.seqFrame>=h.frameCount)&&(a.seqFrame=0),i=!0}}}return i};drawInterface=(t,i,s,a,r=!1)=>{if(0===t.type&&t.childId&&(!t.hide||this.viewportHoveredInterfaceIndex===t.id||this.sidebarHoveredInterfaceIndex===t.id||this.chatHoveredInterfaceIndex===t.id)){var e=D.left,h=D.top,l=D.right,n=D.bottom,o=(D.setBounds(i,s,i+t.width,s+t.height),t.childId.length);for(let e=0;e<o;e++)if(t.childX&&t.childY){var c=t.childX[e]+i,d=t.childY[e]+s-a,u=ft.instances[t.childId[e]];if(c+=u.x,d+=u.y,r&&D.drawRect(c,d,u.width,u.height,ct.WHITE),0<u.clientCode&&this.updateInterfaceContent(u),u.type===ft.TYPE_LAYER)u.scrollPosition>u.scroll-u.height&&(u.scrollPosition=u.scroll-u.height),u.scrollPosition<0&&(u.scrollPosition=0),this.drawInterface(u,c,d,u.scrollPosition,r),u.scroll>u.height&&this.drawScrollbar(c+u.width,d,u.scrollPosition,u.scroll,u.height);else if(u.type===ft.TYPE_INV){let a=0;for(let t=0;t<u.height;t++)for(let e=0;e<u.width;e++)if(u.invSlotOffsetX&&u.invSlotOffsetY&&u.invSlotObjId&&u.invSlotObjCount){let i=c+e*(u.marginX+32),s=d+t*(u.marginY+32);if(a<20&&(i+=u.invSlotOffsetX[a],s+=u.invSlotOffsetY[a]),0<u.invSlotObjId[a]){let e=0,t=0;var f=u.invSlotObjId[a]-1;(-32<=i&&i<=512&&-32<=s&&s<=334||0!==this.objDragArea&&this.objDragSlot===a)&&(f=dt.getIcon(f,u.invSlotObjCount[a]),0!==this.objDragArea&&this.objDragSlot===a&&this.objDragInterfaceId===u.id?(e=this.mouseX-this.objGrabX,t=this.mouseY-this.objGrabY,e<5&&-5<e&&(e=0),t<5&&-5<t&&(t=0),this.objDragCycles<5&&(e=0,t=0),f.drawAlpha(128,i+e,s+t)):0!==this.selectedArea&&this.selectedItem===a&&this.selectedInterface===u.id?f.drawAlpha(128,i,s):f.draw(i,s),33!==f.cropW&&1===u.invSlotObjCount[a]||(f=u.invSlotObjCount[a],this.fontPlain11?.drawString(i+e+1,s+10+t,this.formatObjCount(f),ct.BLACK),this.fontPlain11?.drawString(i+e,s+9+t,this.formatObjCount(f),ct.YELLOW)))}else u.invSlotSprite&&a<20&&u.invSlotSprite[a]?.draw(i,s);a++}}else if(u.type===ft.TYPE_RECT)u.fill?D.fillRect(c,d,u.width,u.height,u.colour):D.drawRect(c,d,u.width,u.height,u.colour);else if(u.type===ft.TYPE_TEXT){var p=u.font;let i=u.colour,s=u.text;if(this.chatHoveredInterfaceIndex!==u.id&&this.sidebarHoveredInterfaceIndex!==u.id&&this.viewportHoveredInterfaceIndex!==u.id||0===u.overColour||(i=u.overColour),this.executeInterfaceScript(u)&&(i=u.activeColour,u.activeText)&&0<u.activeText.length&&(s=u.activeText),u.buttonType===ft.BUTTON_CONTINUE&&this.pressedContinueOption&&(s="Please wait...",i=u.colour),p&&s)for(let t=d+p.height;0<s.length;t+=p.height){if(~s.indexOf("%")){for(;;){var m=s.indexOf("%1");if(-1==m)break;s=s.substring(0,m)+this.getIntString(this.executeClientscript1(u,0))+s.substring(2+m)}for(;;){var g=s.indexOf("%2");if(-1==g)break;s=s.substring(0,g)+this.getIntString(this.executeClientscript1(u,1))+s.substring(2+g)}for(;;){var C=s.indexOf("%3");if(-1==C)break;s=s.substring(0,C)+this.getIntString(this.executeClientscript1(u,2))+s.substring(2+C)}for(;;){var y=s.indexOf("%4");if(-1==y)break;s=s.substring(0,y)+this.getIntString(this.executeClientscript1(u,3))+s.substring(2+y)}for(;;){var v=s.indexOf("%5");if(-1==v)break;s=s.substring(0,v)+this.getIntString(this.executeClientscript1(u,4))+s.substring(2+v)}}var w=s.indexOf("\\n");let e;s=-1!=w?(e=s.substring(0,w),s.substring(2+w)):(e=s,""),u.center?p.drawStringTaggableCenter(c+(u.width/2|0),t,e,i,u.shadowed):p.drawStringTaggable(c,t,e,i,u.shadowed)}}else if(u.type===ft.TYPE_GRAPHIC){let e;(e=this.executeInterfaceScript(u)?u.activeGraphic:u.graphic)?.draw(c,d)}else if(u.type===ft.TYPE_MODEL){var T,S=_.centerX,A=_.centerY,O=(_.centerX=c+(u.width/2|0),_.centerY=d+(u.height/2|0),_.sin[u.xan]*u.zoom>>16),I=_.cos[u.xan]*u.zoom>>16,L=this.executeInterfaceScript(u);let e,t=null;-1===(e=L?u.activeAnim:u.anim)?t=u.getModel(-1,-1,L):(T=R.instances[e]).frames&&T.iframes&&(t=u.getModel(T.frames[u.seqFrame],T.iframes[u.seqFrame],L)),t&&t.drawSimple(0,u.yan,0,u.xan,0,O,I),_.centerX=S,_.centerY=A}else if(u.type===ft.TYPE_INV_TEXT){var b=u.font;if(b&&u.invSlotObjId&&u.invSlotObjCount){let s=0;for(let i=0;i<u.height;i++)for(let t=0;t<u.width;t++){if(0<u.invSlotObjId[s]){var E=dt.get(u.invSlotObjId[s]-1);let e=E.name;if(!(e=!E.stackable&&1===u.invSlotObjCount[s]?e:e+" x"+this.formatObjCountTagged(u.invSlotObjCount[s])))continue;var E=c+t*(u.marginX+115),x=d+i*(u.marginY+12);u.center?b.drawStringTaggableCenter(E+(u.width/2|0),x,e,u.colour,u.shadowed):b.drawStringTaggable(E,x,e,u.colour,u.shadowed)}s++}}}}D.setBounds(e,h,l,n)}};updateInterfaceContent=i=>{let e=i.clientCode;if(e>=ft.CC_FRIENDS_START&&e<=ft.CC_FRIENDS_END)--e>=this.friendCount?(i.text="",i.buttonType=0):(i.text=this.friendName[e],i.buttonType=1);else if(e>=ft.CC_FRIENDS_UPDATE_START&&e<=ft.CC_FRIENDS_UPDATE_END)(e-=ft.CC_FRIENDS_UPDATE_START)>=this.friendCount?(i.text="",i.buttonType=0):(0===this.friendWorld[e]?i.text="@red@Offline":this.friendWorld[e]===Client.nodeId?i.text="@gre@World-"+(this.friendWorld[e]-9):i.text="@yel@World-"+(this.friendWorld[e]-9),i.buttonType=1);else if(e===ft.CC_FRIENDS_SIZE)i.scroll=15*this.friendCount+20,i.scroll<=i.height&&(i.scroll=i.height+1);else if(e>=ft.CC_IGNORES_START&&e<=ft.CC_IGNORES_END)(e-=ft.CC_IGNORES_START)>=this.ignoreCount?(i.text="",i.buttonType=0):(i.text=ut.formatName(ut.fromBase37(this.ignoreName37[e])),i.buttonType=1);else if(e===ft.CC_IGNORES_SIZE)i.scroll=15*this.ignoreCount+20,i.scroll<=i.height&&(i.scroll=i.height+1);else if(e===ft.CC_DESIGN_PREVIEW){if(i.xan=150,i.yan=2047&(256*Math.sin(this.loopCycle/40)|0),this.updateDesignModel){this.updateDesignModel=!1;var s=new lt(7,null);let t=0;for(let e=0;e<7;e++){var a=this.designIdentikits[e];0<=a&&(s[t++]=K.instances[a].getModel())}var r=ot.modelFromModels(s,t);for(let e=0;e<5;e++)0!==this.designColors[e]&&(r.recolor(c.DESIGN_IDK_COLORS[e][0],c.DESIGN_IDK_COLORS[e][this.designColors[e]]),1===e)&&r.recolor(c.TORSO_RECOLORS[0],c.TORSO_RECOLORS[this.designColors[e]]);this.localPlayer&&(h=R.instances[this.localPlayer.seqStandId].frames)&&(r.createLabelReferences(),r.applyTransform(h[0]),r.calculateNormals(64,850,-30,-50,-30,!0),i.model=r)}}else if(e===ft.CC_SWITCH_TO_MALE)this.genderButtonImage0||(this.genderButtonImage0=i.graphic,this.genderButtonImage1=i.activeGraphic),this.designGenderMale?i.graphic=this.genderButtonImage1:i.graphic=this.genderButtonImage0;else if(e===ft.CC_SWITCH_TO_FEMALE)this.genderButtonImage0||(this.genderButtonImage0=i.graphic,this.genderButtonImage1=i.activeGraphic),this.designGenderMale?i.graphic=this.genderButtonImage0:i.graphic=this.genderButtonImage1;else if(e===ft.CC_REPORT_INPUT)i.text=this.reportAbuseInput,this.loopCycle%20<10?i.text=i.text+"|":i.text=i.text+" ";else if(e===ft.CC_MOD_MUTE)this.rights?this.reportAbuseMuteOption?(i.colour=ct.RED,i.text="Moderator option: Mute player for 48 hours: <ON>"):(i.colour=ct.WHITE,i.text="Moderator option: Mute player for 48 hours: <OFF>"):i.text="";else if(e===ft.CC_LAST_LOGIN_INFO||e===ft.CC_LAST_LOGIN_INFO2)if(0===this.lastAddress)i.text="";else{let e;e=0===this.daysSinceLastLogin?"earlier today":1===this.daysSinceLastLogin?"yesterday":this.daysSinceLastLogin+" days ago";var h=ut.formatIPv4(this.lastAddress);i.text="You last logged in "+e+("127.0.0.1"===h?".":" from: "+h)}else if(e===ft.CC_UNREAD_MESSAGES)0===this.unreadMessages&&(i.text="0 unread messages",i.colour=ct.YELLOW),1===this.unreadMessages&&(i.text="1 unread message",i.colour=ct.GREEN),1<this.unreadMessages&&(i.text=this.unreadMessages+" unread messages",i.colour=ct.GREEN);else if(e===ft.CC_RECOVERY1)if(201===this.daysSinceRecoveriesChanged)i.text="";else if(200===this.daysSinceRecoveriesChanged)i.text="You have not yet set any password recovery questions.";else{let e;e=0===this.daysSinceRecoveriesChanged?"Earlier today":1===this.daysSinceRecoveriesChanged?"Yesterday":this.daysSinceRecoveriesChanged+" days ago",i.text=e+" you changed your recovery questions"}else e===ft.CC_RECOVERY2?201===this.daysSinceRecoveriesChanged?i.text="":200===this.daysSinceRecoveriesChanged?i.text="We strongly recommend you do so now to secure your account.":i.text="If you do not remember making this change then cancel it immediately":e===ft.CC_RECOVERY3&&(201===this.daysSinceRecoveriesChanged?i.text="":(this.daysSinceRecoveriesChanged,i.text="Do this from the 'account management' area on our front webpage"))};executeClientscript1=(i,s)=>{if(!i.scripts||s>=i.scripts.length)return-2;try{var a=i.scripts[s];if(!a)return-1;let t=0,e=0;for(;;){var r,h,l=a[e++];if(0===l)return t;if(1===l)t+=this.skillLevel[a[e++]];else if(2===l)t+=this.skillBaseLevel[a[e++]];else if(3===l)t+=this.skillExperience[a[e++]];else if(4===l){var n=ft.instances[a[e++]],o=a[e++]+1;if(n.invSlotObjId&&n.invSlotObjCount)for(let e=0;e<n.invSlotObjId.length;e++)n.invSlotObjId[e]===o&&(t+=n.invSlotObjCount[e]);else t+=0}else if(5===l)t+=this.varps[a[e++]];else if(6===l)t+=this.levelExperience[this.skillBaseLevel[a[e++]]-1];else if(7===l)t+=100*this.varps[a[e++]]/46875|0;else if(8===l)t+=this.localPlayer?.combatLevel||0;else if(9===l)for(let e=0;e<19;e++)18===e&&(e=20),t+=this.skillBaseLevel[e];else if(10===l){var c=ft.instances[a[e++]],d=a[e++]+1;for(let e=0;e<c.invSlotObjId.length;e++)if(c.invSlotObjId[e]===d){t+=999999999;break}}else 11===l?t+=this.energy:12===l?t+=this.weightCarried:13===l&&(r=this.varps[a[e++]],h=a[e++],t+=0==(r&1<<h)?0:1)}}catch(e){return-1}};getIntString=e=>e<999999999?""+e:"*";formatObjCountTagged=e=>{let t=""+e;for(let e=t.length-3;0<e;e-=3)t=t.substring(0,e)+","+t.substring(e);return 8<t.length?t="@gre@"+t.substring(0,t.length-8)+" million @whi@("+t+")":4<t.length&&(t="@cya@"+t.substring(0,t.length-4)+"K @whi@("+t+")")," "+t};formatObjCount=e=>e<1e5?""+e:e<1e7?(e/1e3|0)+"K":(e/1e6|0)+"M";async load(){if(this.isMobile&&Client.lowMemory&&this.setTargetedFramerate(30),this.alreadyStarted)this.errorStarted=!0;else{this.alreadyStarted=!0;try{await this.showProgress(10,"Connecting to fileserver");try{this.db=new Te(await Te.openDatabase())}catch(e){this.db=null}var t=new ht(await F("/crc"));for(let e=0;e<9;e++)this.archiveChecksums[e]=t.g4;Client.lowMemory||await this.setMidi("scape_main",12345678,4e4,!1);var e=await this.loadArchive("title","title screen",this.archiveChecksums[1],10),i=(this.titleArchive=e,this.fontPlain11=H.fromArchive(e,"p11"),this.fontPlain12=H.fromArchive(e,"p12"),this.fontBold12=H.fromArchive(e,"b12"),this.fontQuill8=H.fromArchive(e,"q8"),await this.loadTitleBackground(),this.loadTitleImages(),await this.loadArchive("config","config",this.archiveChecksums[2],15)),s=await this.loadArchive("interface","interface",this.archiveChecksums[3],20),a=await this.loadArchive("media","2d graphics",this.archiveChecksums[4],30),r=await this.loadArchive("models","3d graphics",this.archiveChecksums[5],40),h=await this.loadArchive("textures","textures",this.archiveChecksums[6],60),l=await this.loadArchive("wordenc","chat system",this.archiveChecksums[7],65),n=await this.loadArchive("sounds","sound effects",this.archiveChecksums[8],70);this.levelTileFlags=new W(pt.LEVELS,pt.SIZE,pt.SIZE),this.levelHeightmap=new Z(pt.LEVELS,pt.SIZE+1,pt.SIZE+1),this.levelHeightmap&&(this.scene=new X(this.levelHeightmap,pt.SIZE,pt.LEVELS,pt.SIZE));for(let e=0;e<pt.LEVELS;e++)this.levelCollisionMap[e]=new pt;this.imageMinimap=new B(512,512),await this.showProgress(75,"Unpacking media"),this.imageInvback=b.fromArchive(a,"invback",0),this.imageChatback=b.fromArchive(a,"chatback",0),this.imageMapback=b.fromArchive(a,"mapback",0),this.imageBackbase1=b.fromArchive(a,"backbase1",0),this.imageBackbase2=b.fromArchive(a,"backbase2",0),this.imageBackhmid1=b.fromArchive(a,"backhmid1",0);for(let e=0;e<13;e++)this.imageSideicons[e]=b.fromArchive(a,"sideicons",e);this.imageCompass=B.fromArchive(a,"compass",0);try{for(let e=0;e<50;e++)22!==e&&(this.imageMapscene[e]=b.fromArchive(a,"mapscene",e))}catch(e){}try{for(let e=0;e<50;e++)this.imageMapfunction[e]=B.fromArchive(a,"mapfunction",e)}catch(e){}try{for(let e=0;e<20;e++)this.imageHitmarks[e]=B.fromArchive(a,"hitmarks",e)}catch(e){}try{for(let e=0;e<20;e++)this.imageHeadicons[e]=B.fromArchive(a,"headicons",e)}catch(e){}this.imageMapflag=B.fromArchive(a,"mapflag",0);for(let e=0;e<8;e++)this.imageCrosses[e]=B.fromArchive(a,"cross",e);this.imageMapdot0=B.fromArchive(a,"mapdots",0),this.imageMapdot1=B.fromArchive(a,"mapdots",1),this.imageMapdot2=B.fromArchive(a,"mapdots",2),this.imageMapdot3=B.fromArchive(a,"mapdots",3),this.imageScrollbar0=b.fromArchive(a,"scrollbar",0),this.imageScrollbar1=b.fromArchive(a,"scrollbar",1),this.imageRedstone1=b.fromArchive(a,"redstone1",0),this.imageRedstone2=b.fromArchive(a,"redstone2",0),this.imageRedstone3=b.fromArchive(a,"redstone3",0),this.imageRedstone1h=b.fromArchive(a,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=b.fromArchive(a,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=b.fromArchive(a,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=b.fromArchive(a,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=b.fromArchive(a,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=b.fromArchive(a,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=b.fromArchive(a,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();var o=B.fromArchive(a,"backleft1",0),c=(this.areaBackleft1=new E(o.width,o.height),o.blitOpaque(0,0),B.fromArchive(a,"backleft2",0)),d=(this.areaBackleft2=new E(c.width,c.height),c.blitOpaque(0,0),B.fromArchive(a,"backright1",0)),u=(this.areaBackright1=new E(d.width,d.height),d.blitOpaque(0,0),B.fromArchive(a,"backright2",0)),f=(this.areaBackright2=new E(u.width,u.height),u.blitOpaque(0,0),B.fromArchive(a,"backtop1",0)),p=(this.areaBacktop1=new E(f.width,f.height),f.blitOpaque(0,0),B.fromArchive(a,"backtop2",0)),m=(this.areaBacktop2=new E(p.width,p.height),p.blitOpaque(0,0),B.fromArchive(a,"backvmid1",0)),g=(this.areaBackvmid1=new E(m.width,m.height),m.blitOpaque(0,0),B.fromArchive(a,"backvmid2",0)),C=(this.areaBackvmid2=new E(g.width,g.height),g.blitOpaque(0,0),B.fromArchive(a,"backvmid3",0)),y=(this.areaBackvmid3=new E(C.width,C.height),C.blitOpaque(0,0),B.fromArchive(a,"backhmid2",0)),v=(this.areaBackhmid2=new E(y.width,y.height),y.blitOpaque(0,0),(21*Math.random()|0)-10),w=(21*Math.random()|0)-10,T=(21*Math.random()|0)-10,S=(41*Math.random()|0)-20;for(let e=0;e<50;e++)this.imageMapfunction[e]&&this.imageMapfunction[e]?.translate(v+S,w+S,T+S),this.imageMapscene[e]&&this.imageMapscene[e]?.translate(v+S,w+S,T+S);await this.showProgress(80,"Unpacking textures"),_.unpackTextures(h),_.setBrightness(.8),_.initPool(20),await this.showProgress(83,"Unpacking models"),ot.unpack(r),z.unpack(r),G.unpack(r),await this.showProgress(86,"Unpacking config"),R.unpack(i),P.unpack(i),x.unpack(i),dt.unpack(i,Client.members),Tt.unpack(i),K.unpack(i),J.unpack(i),Q.unpack(i),Client.lowMemory||(await this.showProgress(90,"Unpacking sounds"),yt.unpack(n)),await this.showProgress(92,"Unpacking interfaces"),ft.unpack(s,a,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.showProgress(97,"Preparing game engine");for(let s=0;s<33;s++){let t=999,i=0;for(let e=0;e<35;e++)if(0===this.imageMapback.pixels[e+s*this.imageMapback.width])999===t&&(t=e);else if(999!==t){i=e;break}this.compassMaskLineOffsets[s]=t,this.compassMaskLineLengths[s]=i-t}for(let s=9;s<160;s++){let t=999,i=0;for(let e=10;e<168;e++)if(0===this.imageMapback.pixels[e+s*this.imageMapback.width]&&(34<e||34<s))999===t&&(t=e);else if(999!==t){i=e;break}this.minimapMaskLineOffsets[s-9]=t-21,this.minimapMaskLineLengths[s-9]=i-t}_.init3D(479,96),this.areaChatbackOffsets=_.lineOffset,_.init3D(190,261),this.areaSidebarOffsets=_.lineOffset,_.init3D(512,334),this.areaViewportOffsets=_.lineOffset;var A=new Int32Array(9);for(let e=0;e<9;e++){var O=32*e+128+15,I=3*O+600,L=_.sin[O];A[e]=I*L>>16}X.init(512,334,500,800,A),At.unpack(l),this.initializeLevelExperience()}catch(e){this.errorLoading=!0,e instanceof Error&&(this.errorMessage=e.message)}}}async update(){this.errorStarted||this.errorLoading||this.errorHost||(this.loopCycle++,this.ingame?await this.updateGame():await this.updateTitleScreen())}async draw(){this.errorStarted||this.errorLoading||this.errorHost?this.drawError():(this.ingame?this.drawGame():await this.drawTitleScreen(),this.dragCycles=0)}async refresh(){this.redrawTitleBackground=!0}showProgress=async(e,t)=>{await this.loadTitle(),this.titleArchive?(this.imageTitle4?.bind(),this.fontBold12?.drawStringCenter(180,54,"RuneScape is loading - please wait...",ct.WHITE),D.drawRect(28,62,304,34,ct.PROGRESS_RED),D.drawRect(29,63,302,32,ct.BLACK),D.fillRect(30,64,3*e,30,ct.PROGRESS_RED),D.fillRect(30+3*e,64,300-3*e,30,ct.BLACK),this.fontBold12?.drawStringCenter(180,85,t,ct.WHITE),this.imageTitle4?.draw(214,186),this.redrawTitleBackground&&(this.redrawTitleBackground=!1,this.flameActive||(this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(661,0)),this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186)),await p(5)):await super.showProgress(e,t)};runFlames=()=>{this.flameActive&&(this.updateFlames(),this.updateFlames(),this.drawFlames())};loadTitle=async()=>{this.imageTitle2||(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new E(128,265),D.clear(),this.imageTitle1=new E(128,265),D.clear(),this.imageTitle2=new E(533,186),D.clear(),this.imageTitle3=new E(360,146),D.clear(),this.imageTitle4=new E(360,200),D.clear(),this.imageTitle5=new E(214,267),D.clear(),this.imageTitle6=new E(215,267),D.clear(),this.imageTitle7=new E(86,79),D.clear(),this.imageTitle8=new E(87,79),D.clear(),this.titleArchive&&(await this.loadTitleBackground(),this.loadTitleImages()),this.redrawTitleBackground=!0)};loadTitleBackground=async()=>{var e;this.titleArchive&&(e=await B.fromJpeg(this.titleArchive,"title"),this.imageTitle0?.bind(),e.blitOpaque(0,0),this.imageTitle1?.bind(),e.blitOpaque(-661,0),this.imageTitle2?.bind(),e.blitOpaque(-128,0),this.imageTitle3?.bind(),e.blitOpaque(-214,-386),this.imageTitle4?.bind(),e.blitOpaque(-214,-186),this.imageTitle5?.bind(),e.blitOpaque(0,-265),this.imageTitle6?.bind(),e.blitOpaque(-128,-186),this.imageTitle7?.bind(),e.blitOpaque(-128,-186),this.imageTitle8?.bind(),e.blitOpaque(-574,-186),e.flipHorizontally(),this.imageTitle0?.bind(),e.blitOpaque(394,0),this.imageTitle1?.bind(),e.blitOpaque(-267,0),this.imageTitle2?.bind(),e.blitOpaque(266,0),this.imageTitle3?.bind(),e.blitOpaque(180,-386),this.imageTitle4?.bind(),e.blitOpaque(180,-186),this.imageTitle5?.bind(),e.blitOpaque(394,-265),this.imageTitle6?.bind(),e.blitOpaque(-180,-265),this.imageTitle7?.bind(),e.blitOpaque(212,-186),this.imageTitle8?.bind(),e.blitOpaque(-180,-186),e=B.fromArchive(this.titleArchive,"logo"),this.imageTitle2?.bind(),e.draw((this.width/2|0)-(e.width/2|0)-128,18))};updateFlameBuffer=s=>{if(this.flameBuffer0&&this.flameBuffer1){var a,r;this.flameBuffer0.fill(0);for(let e=0;e<5e3;e++)this.flameBuffer0[128*Math.random()*256|0]=256*Math.random()|0;for(let e=0;e<20;e++){for(let t=1;t<255;t++)for(let e=1;e<127;e++){var i=e+(t<<7);this.flameBuffer1[i]=(this.flameBuffer0[i-1]+this.flameBuffer0[i+1]+this.flameBuffer0[i-128]+this.flameBuffer0[i+128])/4|0}var t=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=t}if(s){let i=0;for(let t=0;t<s.height;t++)for(let e=0;e<s.width;e++)0!==s.pixels[i++]&&(a=e+s.cropX+16,r=t+s.cropY+16,this.flameBuffer0[a+(r<<7)]=0)}}};loadTitleImages=()=>{if(this.titleArchive){this.imageTitlebox=b.fromArchive(this.titleArchive,"titlebox"),this.imageTitlebutton=b.fromArchive(this.titleArchive,"titlebutton");for(let e=0;e<12;e++)this.imageRunes[e]=b.fromArchive(this.titleArchive,"runes",e);this.imageFlamesLeft=new B(128,265),this.imageFlamesRight=new B(128,265),this.imageTitle0&&g(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920),this.imageTitle1&&g(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920),this.flameGradient0=new Int32Array(256);for(let e=0;e<64;e++)this.flameGradient0[e]=262144*e;for(let e=0;e<64;e++)this.flameGradient0[e+64]=1024*e+ct.RED;for(let e=0;e<64;e++)this.flameGradient0[e+128]=4*e+ct.YELLOW;for(let e=0;e<64;e++)this.flameGradient0[e+192]=ct.WHITE;this.flameGradient1=new Int32Array(256);for(let e=0;e<64;e++)this.flameGradient1[e]=1024*e;for(let e=0;e<64;e++)this.flameGradient1[e+64]=4*e+ct.GREEN;for(let e=0;e<64;e++)this.flameGradient1[e+128]=262144*e+ct.CYAN;for(let e=0;e<64;e++)this.flameGradient1[e+192]=ct.WHITE;this.flameGradient2=new Int32Array(256);for(let e=0;e<64;e++)this.flameGradient2[e]=4*e;for(let e=0;e<64;e++)this.flameGradient2[e+64]=262144*e+ct.BLUE;for(let e=0;e<64;e++)this.flameGradient2[e+128]=1024*e+ct.MAGENTA;for(let e=0;e<64;e++)this.flameGradient2[e+192]=ct.WHITE;this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),this.showProgress(10,"Connecting to fileserver").then(()=>{this.flameActive||(this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames,35))})}};updateTitleScreen=async()=>{if(0===this.titleScreenState){var e=(this.width/2|0)-80,t=20+(this.height/2|0);t+=20,1===this.mouseClickButton&&this.mouseClickX>=e-75&&this.mouseClickX<=75+e&&this.mouseClickY>=t-20&&this.mouseClickY<=20+t&&(this.titleScreenState=3,this.titleLoginField=0),e=80+(this.width/2|0),1===this.mouseClickButton&&this.mouseClickX>=e-75&&this.mouseClickX<=75+e&&this.mouseClickY>=t-20&&this.mouseClickY<=20+t&&(this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0)}else if(2===this.titleScreenState){e=(this.height/2|0)-40,t=(e=e+30+25,1===this.mouseClickButton&&this.mouseClickY>=e-15&&this.mouseClickY<e&&(this.titleLoginField=0),e+=15,1===this.mouseClickButton&&this.mouseClickY>=e-15&&this.mouseClickY<e&&(this.titleLoginField=1),(this.width/2|0)-80),e=50+(this.height/2|0);for(e+=20,1===this.mouseClickButton&&this.mouseClickX>=t-75&&this.mouseClickX<=75+t&&this.mouseClickY>=e-20&&this.mouseClickY<=20+e&&await this.login(this.username,this.password,!1),t=80+(this.width/2|0),1===this.mouseClickButton&&this.mouseClickX>=t-75&&this.mouseClickX<=75+t&&this.mouseClickY>=e-20&&this.mouseClickY<=20+e&&(this.titleScreenState=0,this.username="",this.password="");;){var i=this.pollKey();if(-1===i)return;let t=!1;for(let e=0;e<H.CHARSET.length;e++)if(String.fromCharCode(i)===(H.CHARSET[0|e]||"")){t=!0;break}0===this.titleLoginField?(8===i&&0<this.username.length&&(this.username=this.username.substring(0,this.username.length-1)),9!==i&&10!==i&&13!==i||(this.titleLoginField=1),t&&(this.username=this.username+String.fromCharCode(i)),12<this.username.length&&(this.username=this.username.substring(0,12))):1===this.titleLoginField&&(8===i&&0<this.password.length&&(this.password=this.password.substring(0,this.password.length-1)),9!==i&&10!==i&&13!==i||(this.titleLoginField=0),t&&(this.password=this.password+String.fromCharCode(i)),20<this.password.length)&&(this.password=this.password.substring(0,20))}}else 3===this.titleScreenState&&(t=this.width/2|0,e=50+(this.height/2|0),e+=20,1===this.mouseClickButton)&&this.mouseClickX>=t-75&&this.mouseClickX<=75+t&&this.mouseClickY>=e-20&&this.mouseClickY<=20+e&&(this.titleScreenState=0)};drawTitleScreen=async()=>{await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0);if(0===this.titleScreenState)this.fontBold12?.drawStringTaggableCenter(180,80,"Welcome to RuneScape",ct.YELLOW,!0),this.imageTitlebutton?.draw(27,100),this.fontBold12?.drawStringTaggableCenter(100,125,"New user",ct.WHITE,!0),this.imageTitlebutton?.draw(187,100),this.fontBold12?.drawStringTaggableCenter(260,125,"Existing User",ct.WHITE,!0);else if(2===this.titleScreenState){let e=60;0<this.loginMessage0.length?(this.fontBold12?.drawStringTaggableCenter(180,e-15,this.loginMessage0,ct.YELLOW,!0),this.fontBold12?.drawStringTaggableCenter(180,e,this.loginMessage1,ct.YELLOW,!0)):this.fontBold12?.drawStringTaggableCenter(180,e-7,this.loginMessage1,ct.YELLOW,!0),e+=30,this.fontBold12?.drawStringTaggable(90,e,"Username: "+this.username+(0===this.titleLoginField&&this.loopCycle%40<20?"@yel@|":""),ct.WHITE,!0),e+=15,this.fontBold12?.drawStringTaggable(92,e,"Password: "+ut.toAsterisks(this.password)+(1===this.titleLoginField&&this.loopCycle%40<20?"@yel@|":""),ct.WHITE,!0),e=150,this.imageTitlebutton?.draw(27,e-20),this.fontBold12?.drawStringTaggableCenter(100,e+5,"Login",ct.WHITE,!0),this.imageTitlebutton?.draw(187,e-20),this.fontBold12?.drawStringTaggableCenter(260,e+5,"Cancel",ct.WHITE,!0)}else 3===this.titleScreenState&&(this.fontBold12?.drawStringTaggableCenter(180,40,"Create a free account",ct.YELLOW,!0),this.fontBold12?.drawStringTaggableCenter(180,65,"To create a new account you need to",ct.WHITE,!0),this.fontBold12?.drawStringTaggableCenter(180,80,"go back to the main RuneScape webpage",ct.WHITE,!0),this.fontBold12?.drawStringTaggableCenter(180,95,"and choose the red 'create account'",ct.WHITE,!0),this.fontBold12?.drawStringTaggableCenter(180,110,"button at the top right of that page.",ct.WHITE,!0),this.imageTitlebutton?.draw(107,130),this.fontBold12?.drawStringTaggableCenter(180,155,"Cancel",ct.WHITE,!0));this.imageTitle4?.draw(214,186),this.redrawTitleBackground&&(this.redrawTitleBackground=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186))};login=async(e,t,i)=>{try{i||(this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitleScreen()),this.stream=new Ce(await Ce.openSocket(window.location.host,"https:"===window.location.protocol)),await this.stream.readBytes(this.in.data,0,8),this.in.pos=0,this.serverSeed=this.in.g8;var s=new Int32Array([Math.floor(99999999*Math.random()),Math.floor(99999999*Math.random()),+(""+(this.serverSeed>>32n)),+(""+(this.serverSeed&BigInt(4294967295)))]);this.out.pos=0,this.out.p1(10),this.out.p4(s[0]),this.out.p4(s[1]),this.out.p4(s[2]),this.out.p4(s[3]),this.out.p4(await(async()=>{function e(t,i=0){for(let e=0;e<t.length;e++)i=(i<<5)-i+t.charCodeAt(e),i|=0;return i}let t=1337;try{t=e(navigator.platform,t),t=e(navigator.hardwareConcurrency.toString(),t),t=e(navigator.language.toString(),t),t=e(screen.width.toString(),t),t=e(screen.height.toString(),t);try{if(void 0!==navigator.gpu){var i,s=await navigator.gpu.requestAdapter();for(i in t=e(s.info.vendor,t),t=e(s.info.architecture,t),t=e(s.info.device,t),t=e(s.info.description,t),s.limits)t=e(s.limits[i].toString(),t)}}catch(e){}}catch(e){}return t})()),this.out.pjstr(e),this.out.pjstr(t),this.out.rsaenc(Client.loginMod,Client.loginExp),this.loginout.pos=0,i?this.loginout.p1(18):this.loginout.p1(16),this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(Client.clientversion),this.loginout.p1(Client.lowMemory?1:0);for(let e=0;e<9;e++)this.loginout.p4(this.archiveChecksums[e]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new Se(s);for(let e=0;e<4;e++)s[e]+=50;this.randomIn=new Se(s),this.stream?.write(this.loginout.data,this.loginout.pos);var a=await this.stream.read();if(1===a)await p(2e3),await this.login(e,t,i);else if(2===a||18===a){this.rights=18===a,nt.setDisabled(),this.ingame=!0,this.out.pos=0,this.in.pos=0,this.packetType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.packetSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=Date.now();for(let e=0;e<100;e++)this.messageText[e]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.cameraAnticheatOffsetX=(100*Math.random()|0)-50,this.cameraAnticheatOffsetZ=(110*Math.random()|0)-55,this.cameraAnticheatAngle=(80*Math.random()|0)-40,this.minimapAnticheatAngle=(120*Math.random()|0)-60,this.minimapZoom=(30*Math.random()|0)-20,this.orbitCameraYaw=(20*Math.random()|0)-10&2047,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0;for(let e=this.npcCount=0;e<this.MAX_PLAYER_COUNT;e++)this.players[e]=null,this.playerAppearanceBuffer[e]=null;for(let e=0;e<8192;e++)this.npcs[e]=null;this.localPlayer=this.players[this.LOCAL_PLAYER_INDEX]=new c,this.projectiles.clear(),this.spotanims.clear(),this.temporaryLocs.clear();for(let i=0;i<pt.LEVELS;i++)for(let t=0;t<pt.SIZE;t++)for(let e=0;e<pt.SIZE;e++)this.levelObjStacks[i][t][e]=null;this.spawnedLocations=new O,this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,this.designGenderMale=!0,this.validateCharacterDesign();for(let e=0;e<5;e++)this.designColors[e]=0;l(!0),Client.oplogic1=0,Client.oplogic2=0,Client.oplogic3=0,Client.oplogic4=0,Client.oplogic5=0,Client.oplogic6=0,Client.oplogic7=0,Client.oplogic8=0,Client.oplogic9=0,this.prepareGameScreen()}else 3===a?(this.loginMessage0="",this.loginMessage1="Invalid username or password."):4===a?(this.loginMessage0="Your account has been disabled.",this.loginMessage1="Please check your message-centre for details."):5===a?(this.loginMessage0="Your account is already logged in.",this.loginMessage1="Try again in 60 secs..."):6===a?(this.loginMessage0="RuneScape has been updated!",this.loginMessage1="Please reload this page."):7===a?(this.loginMessage0="This world is full.",this.loginMessage1="Please use a different world."):8===a?(this.loginMessage0="Unable to connect.",this.loginMessage1="Login server offline."):9===a?(this.loginMessage0="Login limit exceeded.",this.loginMessage1="Too many connections from your address."):10===a?(this.loginMessage0="Unable to connect.",this.loginMessage1="Bad session id."):11===a?(this.loginMessage1="Login server rejected session.",this.loginMessage1="Please try again."):12===a?(this.loginMessage0="You need a members account to login to this world.",this.loginMessage1="Please subscribe, or use a different world."):13===a?(this.loginMessage0="Could not complete login.",this.loginMessage1="Please try using a different world."):14===a?(this.loginMessage0="The server is being updated.",this.loginMessage1="Please wait 1 minute and try again."):15===a?(this.ingame=!0,this.out.pos=0,this.in.pos=0,this.packetType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.packetSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,this.menuVisible=!1):16===a?(this.loginMessage0="Login attempts exceeded.",this.loginMessage1="Please wait 1 minute and try again."):17===a&&(this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first")}catch(e){this.loginMessage0="",this.loginMessage1="Error connecting to server."}};updateGame=async()=>{if(null!==this.players){1<this.systemUpdateTimer&&this.systemUpdateTimer--,0<this.idleTimeout&&this.idleTimeout--;for(let e=0;e<5&&await this.read();e++);if(this.ingame){for(let t=0;t<this.waveCount;t++)if(this.waveDelay[t]<=0){try{var e=yt.generate(this.waveIds[t],this.waveLoops[t]);if(!e)throw Error();Date.now()+(e.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0)&&(this.lastWaveLength=e.pos,this.lastWaveStartTime=Date.now(),this.lastWaveId=this.waveIds[t],this.lastWaveLoops=this.waveLoops[t],await s(e.data.slice(0,e.pos)))}catch(e){}this.waveCount--;for(let e=t;e<this.waveCount;e++)this.waveIds[e]=this.waveIds[e+1],this.waveLoops[e]=this.waveLoops[e+1],this.waveDelay[e]=this.waveDelay[e+1];t--}else this.waveDelay[t]--;0<this.nextMusicDelay&&(this.nextMusicDelay-=20,this.nextMusicDelay<0&&(this.nextMusicDelay=0),0===this.nextMusicDelay)&&this.midiActive&&!Client.lowMemory&&this.currentMidi&&await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,!1);var t,i=nt.flush();i&&(this.out.p1isaac(gt.EVENT_TRACKING),this.out.p2(i.pos),this.out.pdata(i.data,i.pos,0),i.release()),this.idleNetCycles++,750<this.idleNetCycles&&await this.tryReconnect(),this.updatePlayers(),this.updateNpcs(),this.updateEntityChats(),this.updateTemporaryLocs(),(1===this.actionKey[1]||1===this.actionKey[2]||1===this.actionKey[3]||1===this.actionKey[4])&&5<this.cameraMovedWrite++&&(this.cameraMovedWrite=0,this.out.p1isaac(gt.EVENT_CAMERA_POSITION),this.out.p2(this.orbitCameraPitch),this.out.p2(this.orbitCameraYaw),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom)),this.sceneDelta++,0!==this.crossMode&&(this.crossCycle+=20,400<=this.crossCycle)&&(this.crossMode=0),0!==this.selectedArea&&(this.selectedCycle++,15<=this.selectedCycle)&&(2===this.selectedArea&&(this.redrawSidebar=!0),3===this.selectedArea&&(this.redrawChatback=!0),this.selectedArea=0),0!==this.objDragArea&&(this.objDragCycles++,(this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)&&(this.objGrabThreshold=!0),0===this.mouseButton)&&(2===this.objDragArea&&(this.redrawSidebar=!0),3===this.objDragArea&&(this.redrawChatback=!0),this.objDragArea=0,this.objGrabThreshold&&5<=this.objDragCycles?(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot&&((i=ft.instances[this.objDragInterfaceId]).invSlotObjId&&(t=i.invSlotObjId[this.hoveredSlot],i.invSlotObjId[this.hoveredSlot]=i.invSlotObjId[this.objDragSlot],i.invSlotObjId[this.objDragSlot]=t),i.invSlotObjCount&&(t=i.invSlotObjCount[this.hoveredSlot],i.invSlotObjCount[this.hoveredSlot]=i.invSlotObjCount[this.objDragSlot],i.invSlotObjCount[this.objDragSlot]=t),this.out.p1isaac(gt.INV_BUTTOND),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot))):(1===this.mouseButtonsOption||this.isAddFriendOption(this.menuSize-1))&&2<this.menuSize?this.showContextMenu():0<this.menuSize&&await this.useMenuOption(this.menuSize-1),this.selectedCycle=10,this.mouseClickButton=0),Client.cyclelogic3++,127<Client.cyclelogic3&&(Client.cyclelogic3=0,this.out.p1isaac(gt.ANTICHEAT_CYCLELOGIC3),this.out.p3(4991788)),-1!==X.clickTileX&&this.localPlayer&&(i=X.clickTileX,t=X.clickTileZ,i=this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],i,t,0,0,0,0,0,0,!0),X.clickTileX=-1,i)&&(this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=1,this.crossCycle=0),1===this.mouseClickButton&&this.modalMessage&&(this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0),await this.handleMouseInput(),this.handleMinimapInput(),this.handleTabInput(),this.handleChatSettingsInput(),1!==this.mouseButton&&1!==this.mouseClickButton||this.dragCycles++,2===this.sceneState&&this.updateOrbitCamera(),2===this.sceneState&&this.cutscene&&this.applyCutscene();for(let e=0;e<5;e++)this.cameraModifierCycle[e]++;await this.handleInputKey(),9e4<Date.now()-this.idleCycles&&(this.idleTimeout=250,this.idleCycles=Date.now()-1e4,this.out.p1isaac(gt.IDLE_TIMER)),this.cameraOffsetCycle++,500<this.cameraOffsetCycle&&(1==(1&(t=8*Math.random()|(this.cameraOffsetCycle=0)))&&(this.cameraAnticheatOffsetX+=this.cameraOffsetXModifier),2==(2&t)&&(this.cameraAnticheatOffsetZ+=this.cameraOffsetZModifier),4==(4&t))&&(this.cameraAnticheatAngle+=this.cameraOffsetYawModifier),this.cameraAnticheatOffsetX<-50&&(this.cameraOffsetXModifier=2),50<this.cameraAnticheatOffsetX&&(this.cameraOffsetXModifier=-2),this.cameraAnticheatOffsetZ<-55&&(this.cameraOffsetZModifier=2),55<this.cameraAnticheatOffsetZ&&(this.cameraOffsetZModifier=-2),this.cameraAnticheatAngle<-40&&(this.cameraOffsetYawModifier=1),40<this.cameraAnticheatAngle&&(this.cameraOffsetYawModifier=-1),this.minimapOffsetCycle++,500<this.minimapOffsetCycle&&(1==(1&(i=8*Math.random()|(this.minimapOffsetCycle=0)))&&(this.minimapAnticheatAngle+=this.minimapAngleModifier),2==(2&i))&&(this.minimapZoom+=this.minimapZoomModifier),this.minimapAnticheatAngle<-60&&(this.minimapAngleModifier=2),60<this.minimapAnticheatAngle&&(this.minimapAngleModifier=-2),this.minimapZoom<-20&&(this.minimapZoomModifier=1),10<this.minimapZoom&&(this.minimapZoomModifier=-1),Client.cyclelogic4++,110<Client.cyclelogic4&&(Client.cyclelogic4=0,this.out.p1isaac(gt.ANTICHEAT_CYCLELOGIC4),this.out.p4(0)),this.heartbeatTimer++,50<this.heartbeatTimer&&this.out.p1isaac(gt.NO_TIMEOUT);try{this.stream&&0<this.out.pos&&(this.stream.write(this.out.data,this.out.pos),this.out.pos=0,this.heartbeatTimer=0)}catch(e){await this.tryReconnect()}}}};drawGame=()=>{if(null!==this.players){this.redrawTitleBackground&&(this.redrawTitleBackground=!1,this.areaBackleft1?.draw(0,11),this.areaBackleft2?.draw(0,375),this.areaBackright1?.draw(729,5),this.areaBackright2?.draw(752,231),this.areaBacktop1?.draw(0,0),this.areaBacktop2?.draw(561,0),this.areaBackvmid1?.draw(520,11),this.areaBackvmid2?.draw(520,231),this.areaBackvmid3?.draw(501,375),this.areaBackhmid2?.draw(0,345),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,2!==this.sceneState)&&(this.areaViewport?.draw(8,11),this.areaMapback?.draw(561,5)),2===this.sceneState&&this.drawScene(),this.menuVisible&&1===this.menuArea&&(this.redrawSidebar=!0);let e=!1;if(-1!==this.sidebarInterfaceId&&(e=this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta))&&(this.redrawSidebar=!0),2===this.selectedArea&&(this.redrawSidebar=!0),2===this.objDragArea&&(this.redrawSidebar=!0),this.redrawSidebar&&(this.drawSidebar(),this.redrawSidebar=!1),-1===this.chatInterfaceId){this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,453<this.mouseX&&this.mouseX<565&&350<this.mouseY&&this.handleScrollInput(this.mouseX-22,this.mouseY-375,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let e=this.chatScrollHeight-this.chatInterface.scrollPosition-77;(e=e<0?0:e)>this.chatScrollHeight-77&&(e=this.chatScrollHeight-77),this.chatScrollOffset!==e&&(this.chatScrollOffset=e,this.redrawChatback=!0)}-1!==this.chatInterfaceId&&(e=this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta))&&(this.redrawChatback=!0),3===this.selectedArea&&(this.redrawChatback=!0),3===this.objDragArea&&(this.redrawChatback=!0),this.modalMessage&&(this.redrawChatback=!0),this.menuVisible&&2===this.menuArea&&(this.redrawChatback=!0),this.redrawChatback&&(this.drawChatback(),this.redrawChatback=!1),2===this.sceneState&&(this.drawMinimap(),this.areaMapback?.draw(561,5)),-1!==this.flashingTab&&(this.redrawSideicons=!0),this.redrawSideicons&&(-1!==this.flashingTab&&this.flashingTab===this.selectedTab&&(this.flashingTab=-1,this.out.p1isaac(gt.TUTORIAL_CLICKSIDE),this.out.p1(this.selectedTab)),this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),-1===this.sidebarInterfaceId&&(-1!==this.tabInterfaceId[this.selectedTab]&&(0===this.selectedTab?this.imageRedstone1?.draw(29,30):1===this.selectedTab?this.imageRedstone2?.draw(59,29):2===this.selectedTab?this.imageRedstone2?.draw(87,29):3===this.selectedTab?this.imageRedstone3?.draw(115,29):4===this.selectedTab?this.imageRedstone2h?.draw(156,29):5===this.selectedTab?this.imageRedstone2h?.draw(184,29):6===this.selectedTab&&this.imageRedstone1h?.draw(212,30)),-1!==this.tabInterfaceId[0]&&(0!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[0]?.draw(35,34),-1!==this.tabInterfaceId[1]&&(1!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[1]?.draw(59,32),-1!==this.tabInterfaceId[2]&&(2!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[2]?.draw(86,32),-1!==this.tabInterfaceId[3]&&(3!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[3]?.draw(121,33),-1!==this.tabInterfaceId[4]&&(4!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[4]?.draw(157,34),-1!==this.tabInterfaceId[5]&&(5!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[5]?.draw(185,32),-1!==this.tabInterfaceId[6])&&(6!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[6]?.draw(212,34),this.areaBackhmid1?.draw(520,165),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),-1===this.sidebarInterfaceId&&(-1!==this.tabInterfaceId[this.selectedTab]&&(7===this.selectedTab?this.imageRedstone1v?.draw(49,0):8===this.selectedTab?this.imageRedstone2v?.draw(81,0):9===this.selectedTab?this.imageRedstone2v?.draw(108,0):10===this.selectedTab?this.imageRedstone3v?.draw(136,1):11===this.selectedTab?this.imageRedstone2hv?.draw(178,0):12===this.selectedTab?this.imageRedstone2hv?.draw(205,0):13===this.selectedTab&&this.imageRedstone1hv?.draw(233,0)),-1!==this.tabInterfaceId[8]&&(8!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[7]?.draw(80,2),-1!==this.tabInterfaceId[9]&&(9!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[8]?.draw(107,3),-1!==this.tabInterfaceId[10]&&(10!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[9]?.draw(142,4),-1!==this.tabInterfaceId[11]&&(11!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[10]?.draw(179,2),-1!==this.tabInterfaceId[12]&&(12!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[11]?.draw(206,2),-1!==this.tabInterfaceId[13])&&(13!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[12]?.draw(230,2),this.areaBackbase2?.draw(501,492),this.areaViewport?.bind()),this.redrawPrivacySettings&&(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(57,33,"Public chat",ct.WHITE,!0),0===this.publicChatSetting&&this.fontPlain12?.drawStringTaggableCenter(57,46,"On",ct.GREEN,!0),1===this.publicChatSetting&&this.fontPlain12?.drawStringTaggableCenter(57,46,"Friends",ct.YELLOW,!0),2===this.publicChatSetting&&this.fontPlain12?.drawStringTaggableCenter(57,46,"Off",ct.RED,!0),3===this.publicChatSetting&&this.fontPlain12?.drawStringTaggableCenter(57,46,"Hide",ct.CYAN,!0),this.fontPlain12?.drawStringTaggableCenter(186,33,"Private chat",ct.WHITE,!0),0===this.privateChatSetting&&this.fontPlain12?.drawStringTaggableCenter(186,46,"On",ct.GREEN,!0),1===this.privateChatSetting&&this.fontPlain12?.drawStringTaggableCenter(186,46,"Friends",ct.YELLOW,!0),2===this.privateChatSetting&&this.fontPlain12?.drawStringTaggableCenter(186,46,"Off",ct.RED,!0),this.fontPlain12?.drawStringTaggableCenter(326,33,"Trade/duel",ct.WHITE,!0),0===this.tradeChatSetting&&this.fontPlain12?.drawStringTaggableCenter(326,46,"On",ct.GREEN,!0),1===this.tradeChatSetting&&this.fontPlain12?.drawStringTaggableCenter(326,46,"Friends",ct.YELLOW,!0),2===this.tradeChatSetting&&this.fontPlain12?.drawStringTaggableCenter(326,46,"Off",ct.RED,!0),this.fontPlain12?.drawStringTaggableCenter(462,38,"Report abuse",ct.WHITE,!0),this.areaBackbase1?.draw(0,471),this.areaViewport?.bind()),this.sceneDelta=0}};drawScene=()=>{if(this.sceneCycle++,this.pushPlayers(),this.pushNpcs(),this.pushProjectiles(),this.pushSpotanims(),this.pushLocs(),!this.cutscene){let e=this.orbitCameraPitch;(this.cameraPitchClamp/256|0)>e&&(e=this.cameraPitchClamp/256|0),this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>e&&(e=this.cameraModifierWobbleScale[4]+128);var t=this.orbitCameraYaw+this.cameraAnticheatAngle&2047;this.localPlayer&&this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,t,e,3*e+600),Client.cyclelogic2++,1802<Client.cyclelogic2&&(Client.cyclelogic2=0,this.out.p1isaac(gt.ANTICHEAT_CYCLELOGIC2),this.out.p1(0),t=this.out.pos,this.out.p2(29711),this.out.p1(70),this.out.p1(256*Math.random()|0),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),0==(2*Math.random()|0)&&this.out.p1(13),0==(2*Math.random()|0)&&this.out.p2(57856),this.out.p2(65536*Math.random()|0),this.out.psize1(this.out.pos-t))}let e;e=this.cutscene?this.getTopLevelCutscene():this.getTopLevel();var t=this.cameraX,i=this.cameraY,s=this.cameraZ,a=this.cameraPitch,r=this.cameraYaw;let h;for(let e=0;e<5;e++)this.cameraModifierEnabled[e]&&(h=Math.random()*(2*this.cameraModifierJitter[e]+1)-this.cameraModifierJitter[e]+Math.sin(this.cameraModifierCycle[e]*(this.cameraModifierWobbleSpeed[e]/100))*this.cameraModifierWobbleScale[e]|0,0===e&&(this.cameraX+=h),1===e&&(this.cameraY+=h),2===e&&(this.cameraZ+=h),3===e&&(this.cameraYaw=this.cameraYaw+h&2047),4===e)&&(this.cameraPitch+=h,this.cameraPitch<128&&(this.cameraPitch=128),383<this.cameraPitch)&&(this.cameraPitch=383);h=_.cycle,ot.checkHover=!0,ot.pickedCount=0,ot.mouseX=this.mouseX-8,ot.mouseY=this.mouseY-11,D.clear(),this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,e,this.cameraYaw,this.cameraPitch,this.loopCycle),this.scene?.clearTemporaryLocs(),this.draw2DEntityElements(),this.drawTileHint(),this.updateTextures(h),this.draw3DEntityElements(),this.areaViewport?.draw(8,11),this.cameraX=t,this.cameraY=i,this.cameraZ=s,this.cameraPitch=a,this.cameraYaw=r};clearCaches=()=>{P.modelCacheStatic?.clear(),P.modelCacheDynamic?.clear(),Tt.modelCache?.clear(),dt.modelCache?.clear(),dt.iconCache?.clear(),c.modelCache?.clear(),J.modelCache?.clear()};projectFromEntity=(e,t)=>{this.projectFromGround(e.x,t,e.z)};projectFromGround=(e,t,i)=>{e<128||i<128||13056<e||13056<i?(this.projectX=-1,this.projectY=-1):(t=this.getHeightmapY(this.currentLevel,e,i)-t,this.project(e,t,i))};project=(e,t,i)=>{var e=e-this.cameraX,t=t-this.cameraY,i=i-this.cameraZ,s=_.sin[this.cameraPitch],a=_.cos[this.cameraPitch],r=_.sin[this.cameraYaw],h=_.cos[this.cameraYaw],l=i*r+e*h>>16,i=i*h-e*r>>16,e=l,l=t*a-i*s>>16;i=t*s+i*a>>16,t=l,50<=i?(this.projectX=_.centerX+((e<<9)/i|0),this.projectY=_.centerY+((t<<9)/i|0)):(this.projectX=-1,this.projectY=-1)};draw2DEntityElements=()=>{this.chatCount=0;for(let e=-1;e<this.playerCount+this.npcCount;e++){let i=null;if((i=-1===e?this.localPlayer:e<this.playerCount?this.players[this.playerIds[e]]:this.npcs[this.npcIds[e-this.playerCount]])&&i.isVisible()){if(e<this.playerCount){let t=30;var s=i;if(0!==s.headicons&&(this.projectFromEntity(i,i.height+15),-1<this.projectX))for(let e=0;e<8;e++)0!=(s.headicons&1<<e)&&(this.imageHeadicons[e]?.draw(this.projectX-12,this.projectY-t),t-=25);0<=e&&10===this.hintType&&this.hintPlayer===this.playerIds[e]&&(this.projectFromEntity(i,i.height+15),-1<this.projectX)&&this.imageHeadicons[7]?.draw(this.projectX-12,this.projectY-t)}else 1===this.hintType&&this.hintNpc===this.npcIds[e-this.playerCount]&&this.loopCycle%20<10&&(this.projectFromEntity(i,i.height+15),-1<this.projectX)&&this.imageHeadicons[2]?.draw(this.projectX-12,this.projectY-28);if(i.chat&&(e>=this.playerCount||0===this.publicChatSetting||3===this.publicChatSetting||1===this.publicChatSetting&&this.isFriend(i.name))&&(this.projectFromEntity(i,i.height),-1<this.projectX)&&this.chatCount<Client.MAX_CHATS&&this.fontBold12&&(this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(i.chat)/2|0,this.chatHeight[this.chatCount]=this.fontBold12.height,this.chatX[this.chatCount]=this.projectX,this.chatY[this.chatCount]=this.projectY,this.chatColors[this.chatCount]=i.chatColor,this.chatStyles[this.chatCount]=i.chatStyle,this.chatTimers[this.chatCount]=i.chatTimer,this.chats[this.chatCount++]=i.chat,0===this.chatEffects&&1===i.chatStyle&&(this.chatHeight[this.chatCount]+=10,this.chatY[this.chatCount]+=5),0===this.chatEffects)&&2===i.chatStyle&&(this.chatWidth[this.chatCount]=60),i.combatCycle>this.loopCycle+100&&(this.projectFromEntity(i,i.height+15),-1<this.projectX)){let e=30*i.health/i.totalHealth|0;30<e&&(e=30),D.fillRect(this.projectX-15,this.projectY-3,e,5,ct.GREEN),D.fillRect(this.projectX-15+e,this.projectY-3,30-e,5,ct.RED)}i.combatCycle>this.loopCycle+330&&(this.projectFromEntity(i,i.height/2|0),-1<this.projectX)&&(this.imageHitmarks[i.damageType]?.draw(this.projectX-12,this.projectY-12),this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,i.damage.toString(),ct.BLACK),this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,i.damage.toString(),ct.WHITE))}}for(let s=0;s<this.chatCount;s++){var a=this.chatX[s];let t=this.chatY[s];var r=this.chatWidth[s],h=this.chatHeight[s];let i=!0;for(;i;){i=!1;for(let e=0;e<s;e++)t+2>this.chatY[e]-this.chatHeight[e]&&t-h<this.chatY[e]+2&&a-r<this.chatX[e]+this.chatWidth[e]&&a+r>this.chatX[e]-this.chatWidth[e]&&this.chatY[e]-this.chatHeight[e]<t&&(t=this.chatY[e]-this.chatHeight[e],i=!0)}this.projectX=this.chatX[s],this.projectY=this.chatY[s]=t;var l,n,o,c=this.chats[s];if(0===this.chatEffects){let e=ct.YELLOW;this.chatColors[s]<6&&(e=ct.CHAT_COLORS[this.chatColors[s]]),6===this.chatColors[s]&&(e=this.sceneCycle%20<10?ct.RED:ct.YELLOW),7===this.chatColors[s]&&(e=this.sceneCycle%20<10?ct.BLUE:ct.CYAN),8===this.chatColors[s]&&(e=this.sceneCycle%20<10?45056:8454016),9===this.chatColors[s]&&((l=150-this.chatTimers[s])<50?e=1280*l+ct.RED:l<100?e=ct.YELLOW-327680*(l-50):l<150&&(e=5*(l-100)+ct.GREEN)),10===this.chatColors[s]&&((l=150-this.chatTimers[s])<50?e=5*l+ct.RED:l<100?e=ct.MAGENTA-327680*(l-50):l<150&&(e=327680*(l-100)+ct.BLUE-5*(l-100))),11===this.chatColors[s]&&((n=150-this.chatTimers[s])<50?e=ct.WHITE-327685*n:n<100?e=327685*(n-50)+ct.GREEN:n<150&&(e=ct.WHITE-327680*(n-100))),0===this.chatStyles[s]&&(this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,c,ct.BLACK),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,c,e)),1===this.chatStyles[s]&&(this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,c,ct.BLACK,this.sceneCycle),this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,c,e,this.sceneCycle)),2===this.chatStyles[s]&&(n=this.fontBold12?.stringWidth(c)??0,o=(150-this.chatTimers[s])*(n+100)/150,D.setBounds(this.projectX-50,0,this.projectX+50,334),this.fontBold12?.drawString(this.projectX+50-o,this.projectY+1,c,ct.BLACK),this.fontBold12?.drawString(this.projectX+50-o,this.projectY,c,e),D.resetBounds())}else this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,c,ct.BLACK),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,c,ct.YELLOW)}};drawTileHint=()=>{2===this.hintType&&this.imageHeadicons[2]&&(this.projectFromGround((this.hintTileX-this.sceneBaseTileX<<7)+this.hintOffsetX,2*this.hintHeight,(this.hintTileZ-this.sceneBaseTileZ<<7)+this.hintOffsetZ),-1<this.projectX)&&this.loopCycle%20<10&&this.imageHeadicons[2].draw(this.projectX-12,this.projectY-28)};draw3DEntityElements=()=>{if(this.drawPrivateMessages(),1===this.crossMode&&this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-8,this.crossY-8-11),2===this.crossMode&&this.imageCrosses[4+(this.crossCycle/100|0)]?.draw(this.crossX-8-8,this.crossY-8-11),-1!==this.viewportInterfaceId&&(this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(ft.instances[this.viewportInterfaceId],0,0,0)),this.drawWildyLevel(),this.menuVisible?0===this.menuArea&&this.drawMenu():(this.handleInput(),this.drawTooltip()),1===this.inMultizone&&(0<this.wildernessLevel||1===this.worldLocationState?this.imageHeadicons[1]?.draw(472,258):this.imageHeadicons[1]?.draw(472,296)),0<this.wildernessLevel&&(this.imageHeadicons[0]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,ct.YELLOW)),1===this.worldLocationState&&(this.imageHeadicons[6]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",ct.YELLOW)),this.displayFps){let e=ct.YELLOW,t=(this.fps<15&&(e=ct.RED),this.fontPlain12?.drawStringRight(507,20,"Fps:"+this.fps,e),-1);void 0!==window.performance.memory&&(i=window.performance.memory,t=i.usedJSHeapSize/1024|0),-1!==t&&this.fontPlain12?.drawStringRight(507,35,"Mem:"+t+"k",ct.YELLOW)}var i,e;0!==this.systemUpdateTimer&&(e=(i=this.systemUpdateTimer/50|0)/60|0,(i%=60)<10?this.fontPlain12?.drawString(4,329,"System update in: "+e+":0"+i,ct.YELLOW):this.fontPlain12?.drawString(4,329,"System update in: "+e+":"+i,ct.YELLOW))};drawPrivateMessages=()=>{if(0!==this.splitPrivateChat){var s=this.fontPlain12;let i=0;0!==this.systemUpdateTimer&&(i=1);for(let t=0;t<100;t++)if(this.messageText[t]){var a=this.messageType[t];let e;if((3===a||7===a)&&(7===a||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(this.messageSender[t]))&&(e=329-13*i,s?.drawString(4,e,"From "+this.messageSender[t]+": "+this.messageText[t],ct.BLACK),s?.drawString(4,e-1,"From "+this.messageSender[t]+": "+this.messageText[t],ct.CYAN),5<=++i))return;if(5===a&&this.privateChatSetting<2&&(e=329-13*i,s?.drawString(4,e,this.messageText[t],ct.BLACK),s?.drawString(4,e-1,this.messageText[t],ct.CYAN),5<=++i))return;if(6===a&&this.privateChatSetting<2&&(e=329-13*i,s?.drawString(4,e,"To "+this.messageSender[t]+": "+this.messageText[t],ct.BLACK),s?.drawString(4,e-1,"To "+this.messageSender[t]+": "+this.messageText[t],ct.CYAN),5<=++i))return}}};drawWildyLevel=()=>{var e,t,i,s;this.localPlayer&&(e=(this.localPlayer.x>>7)+this.sceneBaseTileX,t=(this.localPlayer.z>>7)+this.sceneBaseTileZ,this.wildernessLevel=2944<=e&&e<3392&&3520<=t&&t<6400?1+((t-3520)/8|0):2944<=e&&e<3392&&9920<=t&&t<12800?1+((t-9920)/8|0):0,this.worldLocationState=0,3328<=e&&e<3392&&3200<=t&&t<3264&&(s=63&t,4<=(i=63&e)&&i<=29&&44<=s&&s<=58||36<=i&&i<=61&&44<=s&&s<=58||4<=i&&i<=29&&25<=s&&s<=39||36<=i&&i<=61&&25<=s&&s<=39||4<=i&&i<=29&&6<=s&&s<=20||36<=i&&i<=61&&6<=s&&s<=20)&&(this.worldLocationState=1),0===this.worldLocationState&&3328<=e&&e<=3393&&3203<=t&&t<=3325&&(this.worldLocationState=2),this.overrideChat=0,(3053<=e&&e<=3156&&3056<=t&&t<=3136||3072<=e&&e<=3118&&9492<=t&&t<=9535)&&(this.overrideChat=1),1===this.overrideChat)&&3139<=e&&e<=3199&&3008<=t&&t<=3062&&(this.overrideChat=0)};drawSidebar=()=>{this.areaSidebar?.bind(),this.areaSidebarOffsets&&(_.lineOffset=this.areaSidebarOffsets),this.imageInvback?.draw(0,0),-1!==this.sidebarInterfaceId?this.drawInterface(ft.instances[this.sidebarInterfaceId],0,0,0):-1!==this.tabInterfaceId[this.selectedTab]&&this.drawInterface(ft.instances[this.tabInterfaceId[this.selectedTab]],0,0,0),this.menuVisible&&1===this.menuArea&&this.drawMenu(),this.areaSidebar?.draw(562,231),this.areaViewport?.bind(),this.areaViewportOffsets&&(_.lineOffset=this.areaViewportOffsets)};drawChatback=()=>{if(this.areaChatback?.bind(),this.areaChatbackOffsets&&(_.lineOffset=this.areaChatbackOffsets),this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,ct.BLACK),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",ct.DARKBLUE);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",ct.BLACK),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",ct.DARKBLUE);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,ct.BLACK),this.fontBold12?.drawStringCenter(239,60,"Click to continue",ct.DARKBLUE);else if(-1!==this.chatInterfaceId)this.drawInterface(ft.instances[this.chatInterfaceId],0,0,0);else if(-1===this.stickyChatInterfaceId){var i=this.fontPlain12;let t=0;D.setBounds(0,0,463,77);for(let e=0;e<100;e++){var s,a,r=this.messageText[e];r&&(s=this.messageType[e],a=this.chatScrollOffset+70-14*t,0===s&&(0<a&&a<110&&i?.drawString(4,a,r,ct.BLACK),t++),1===s&&(0<a&&a<110&&(i?.drawString(4,a,this.messageSender[e]+":",ct.WHITE),i?.drawString(i.stringWidth(this.messageSender[e])+12,a,r,ct.BLUE)),t++),2===s&&(0===this.publicChatSetting||1===this.publicChatSetting&&this.isFriend(this.messageSender[e]))&&(0<a&&a<110&&(i?.drawString(4,a,this.messageSender[e]+":",ct.BLACK),i?.drawString(i.stringWidth(this.messageSender[e])+12,a,r,ct.BLUE)),t++),3!==s&&7!==s||0!==this.splitPrivateChat||!(7===s||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(this.messageSender[e]))||(0<a&&a<110&&(i?.drawString(4,a,"From "+this.messageSender[e]+":",ct.BLACK),i?.drawString(i.stringWidth("From "+this.messageSender[e])+12,a,r,ct.DARKRED)),t++),4===s&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(this.messageSender[e]))&&(0<a&&a<110&&i?.drawString(4,a,this.messageSender[e]+" "+this.messageText[e],ct.TRADE_MESSAGE),t++),5===s&&0===this.splitPrivateChat&&this.privateChatSetting<2&&(0<a&&a<110&&i?.drawString(4,a,r,ct.DARKRED),t++),6===s&&0===this.splitPrivateChat&&this.privateChatSetting<2&&(0<a&&a<110&&(i?.drawString(4,a,"To "+this.messageSender[e]+":",ct.BLACK),i?.drawString(i.stringWidth("To "+this.messageSender[e])+12,a,r,ct.DARKRED)),t++),8===s)&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(this.messageSender[e]))&&(0<a&&a<110&&i?.drawString(4,a,this.messageSender[e]+" "+this.messageText[e],ct.DUEL_MESSAGE),t++)}D.resetBounds(),this.chatScrollHeight=14*t+7,this.chatScrollHeight<78&&(this.chatScrollHeight=78),this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77),i?.drawString(4,90,ut.formatName(this.username)+":",ct.BLACK),i?.drawString(i.stringWidth(this.username+": ")+6,90,this.chatTyped+"*",ct.BLUE),D.drawHorizontalLine(0,77,ct.BLACK,479)}else this.drawInterface(ft.instances[this.stickyChatInterfaceId],0,0,0);this.menuVisible&&2===this.menuArea&&this.drawMenu(),this.areaChatback?.draw(22,375),this.areaViewport?.bind(),this.areaViewportOffsets&&(_.lineOffset=this.areaViewportOffsets)};drawMinimap=()=>{if(this.areaMapback?.bind(),this.localPlayer){var e=this.orbitCameraYaw+this.minimapAnticheatAngle&2047;let i=48+(this.localPlayer.x/32|0),s=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(21,9,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,i,s,e,this.minimapZoom+256),this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let e=0;e<this.activeMapFunctionCount;e++)i=4*this.activeMapFunctionX[e]+2-(this.localPlayer.x/32|0),s=4*this.activeMapFunctionZ[e]+2-(this.localPlayer.z/32|0),this.drawOnMinimap(s,this.activeMapFunctions[e],i);for(let t=0;t<pt.SIZE;t++)for(let e=0;e<pt.SIZE;e++)this.levelObjStacks[this.currentLevel][t][e]&&(i=4*t+2-(this.localPlayer.x/32|0),s=4*e+2-(this.localPlayer.z/32|0),this.drawOnMinimap(s,this.imageMapdot0,i));for(let e=0;e<this.npcCount;e++){var t=this.npcs[this.npcIds[e]];t&&t.isVisible()&&t.type&&t.type.minimap&&(i=(t.x/32|0)-(this.localPlayer.x/32|0),s=(t.z/32|0)-(this.localPlayer.z/32|0),this.drawOnMinimap(s,this.imageMapdot1,i))}for(let e=0;e<this.playerCount;e++){var a=this.players[this.playerIds[e]];if(a&&a.isVisible()&&a.name){i=(a.x/32|0)-(this.localPlayer.x/32|0),s=(a.z/32|0)-(this.localPlayer.z/32|0);let t=!1;var r=ut.toBase37(a.name);for(let e=0;e<this.friendCount;e++)if(r===this.friendName37[e]&&0!==this.friendWorld[e]){t=!0;break}t?this.drawOnMinimap(s,this.imageMapdot3,i):this.drawOnMinimap(s,this.imageMapdot2,i)}}0!==this.flagSceneTileX&&(i=4*this.flagSceneTileX+2-(this.localPlayer.x/32|0),s=4*this.flagSceneTileZ+2-(this.localPlayer.z/32|0),this.drawOnMinimap(s,this.imageMapflag,i)),D.fillRect(93,82,3,3,ct.WHITE),this.areaViewport?.bind()}};drawOnMinimap=(e,t,i)=>{var s,a,r,h;t&&(r=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,6400<(s=i*i+e*e)||(a=_.sin[r],r=_.cos[r],h=e*(a=256*a/(this.minimapZoom+256)|0)+i*(r=256*r/(this.minimapZoom+256)|0)>>16,e=e*r-i*a>>16,2500<s&&this.imageMapback?t.drawMasked(94+h-(t.cropW/2|0),83-e-(t.cropH/2|0),this.imageMapback):t.draw(94+h-(t.cropW/2|0),83-e-(t.cropH/2|0))))};createMinimap=s=>{if(this.imageMinimap){var a=this.imageMinimap.pixels,t=a.length;for(let e=0;e<t;e++)a[e]=0;for(let i=1;i<pt.SIZE-1;i++){let t=512*(pt.SIZE-1-i)*4+24628;for(let e=1;e<pt.SIZE-1;e++)this.levelTileFlags&&0==(24&this.levelTileFlags[s][e][i])&&this.scene?.drawMinimapTile(s,e,i,a,t,512),s<3&&this.levelTileFlags&&0!=(8&this.levelTileFlags[s+1][e][i])&&this.scene?.drawMinimapTile(s+1,e,i,a,t,512),t+=4}var i=(238+(20*Math.random()|0)-10<<16)+(238+(20*Math.random()|0)-10<<8)+(20*Math.random()|0)+238-10,r=238+(20*Math.random()|0)-10<<16;this.imageMinimap.bind();for(let t=1;t<pt.SIZE-1;t++)for(let e=1;e<pt.SIZE-1;e++)this.levelTileFlags&&0==(24&this.levelTileFlags[s][e][t])&&this.drawMinimapLoc(e,t,s,i,r),s<3&&this.levelTileFlags&&0!=(8&this.levelTileFlags[s+1][e][t])&&this.drawMinimapLoc(e,t,s+1,i,r);this.areaViewport?.bind();for(let a=this.activeMapFunctionCount=0;a<pt.SIZE;a++)for(let s=0;s<pt.SIZE;s++){var e=this.scene?.getGroundDecorationBitset(this.currentLevel,a,s)??0;if(0!==e){e=e>>14&32767,e=P.get(e).mapfunction;if(!(e<0)){let t=a,i=s;if(22!==e&&29!==e&&34!==e&&36!==e&&46!==e&&47!==e&&48!==e){var h=pt.SIZE,l=pt.SIZE,n=this.levelCollisionMap[this.currentLevel];if(n){var o=n.flags;for(let e=0;e<10;e++){var c=4*Math.random()|0;0==c&&0<t&&t>a-3&&(o[pt.index(t-1,i)]&M.BLOCK_WEST)===M.OPEN&&t--,1==c&&t<h-1&&t<a+3&&(o[pt.index(t+1,i)]&M.BLOCK_EAST)===M.OPEN&&t++,2==c&&0<i&&i>s-3&&(o[pt.index(t,i-1)]&M.BLOCK_SOUTH)===M.OPEN&&i--,3==c&&i<l-1&&i<s+3&&(o[pt.index(t,i+1)]&M.BLOCK_NORTH)===M.OPEN&&i++}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[e],this.activeMapFunctionX[this.activeMapFunctionCount]=t,this.activeMapFunctionZ[this.activeMapFunctionCount]=i,this.activeMapFunctionCount++}}}}};drawMinimapLoc=(t,i,s,a,r)=>{if(this.scene&&this.imageMinimap){var h=this.scene.getWallBitset(s,t,i);if(0!==h){var l=this.scene.getInfo(s,t,i,h),n=l>>6&3,l=31&l;let e=a;0<h&&(e=r);var a=this.imageMinimap.pixels,r=4*t+512*(103-i)*4+24624,o=h>>14&32767,o=P.get(o);-1===o.mapscene?(l!==k.WALL_STRAIGHT.id&&l!==k.WALL_L.id||(n===N.WEST?(a[r]=e,a[512+r]=e,a[1024+r]=e,a[1536+r]=e):n===N.NORTH?(a[r]=e,a[1+r]=e,a[2+r]=e,a[3+r]=e):n===N.EAST?(a[3+r]=e,a[3+r+512]=e,a[3+r+1024]=e,a[3+r+1536]=e):n===N.SOUTH&&(a[1536+r]=e,a[1536+r+1]=e,a[1536+r+2]=e,a[1536+r+3]=e)),l===k.WALL_SQUARE_CORNER.id&&(n===N.WEST?a[r]=e:n===N.NORTH?a[3+r]=e:n===N.EAST?a[3+r+1536]=e:n===N.SOUTH&&(a[1536+r]=e)),l===k.WALL_L.id&&(n===N.SOUTH?(a[r]=e,a[512+r]=e,a[1024+r]=e,a[1536+r]=e):n===N.WEST?(a[r]=e,a[1+r]=e,a[2+r]=e,a[3+r]=e):n===N.NORTH?(a[3+r]=e,a[3+r+512]=e,a[3+r+1024]=e,a[3+r+1536]=e):n===N.EAST&&(a[1536+r]=e,a[1536+r+1]=e,a[1536+r+2]=e,a[1536+r+3]=e))):(l=this.imageMapscene[o.mapscene])&&(n=(4*o.width-l.width)/2|0,a=(4*o.length-l.height)/2|0,l.draw(4*t+48+n,4*(pt.SIZE-i-o.length)+a+48))}if(0!==(h=this.scene.getLocBitset(s,t,i))){var r=this.scene.getInfo(s,t,i,h),l=r>>6&3,n=31&r,o=h>>14&32767,a=P.get(o);if(-1!==a.mapscene){var e,r=this.imageMapscene[a.mapscene];r&&(o=(4*a.width-r.width)/2|0,e=(4*a.length-r.height)/2|0,r.draw(4*t+48+o,4*(pt.SIZE-i-a.length)+e+48))}else if(n===k.WALL_DIAGONAL.id){let e=15658734;0<h&&(e=15597568);r=this.imageMinimap.pixels,o=4*t+512*(pt.SIZE-1-i)*4+24624;l===N.WEST||l===N.EAST?(r[1536+o]=e,r[1024+o+1]=e,r[512+o+2]=e,r[3+o]=e):(r[o]=e,r[512+o+1]=e,r[1024+o+2]=e,r[1536+o+3]=e)}}0!==(h=this.scene.getGroundDecorationBitset(s,t,i))&&-1!==(a=P.get(h>>14&32767)).mapscene&&(e=this.imageMapscene[a.mapscene])&&(n=(4*a.width-e.width)/2|0,l=(4*a.length-e.height)/2|0,e.draw(4*t+48+n,4*(pt.SIZE-i-a.length)+l+48))}};drawTooltip=()=>{if(!(this.menuSize<2&&0===this.objSelected&&0===this.spellSelected)){let e;e=1===this.objSelected&&this.menuSize<2?"Use "+this.objSelectedName+" with...":1===this.spellSelected&&this.menuSize<2?this.spellCaption+"...":this.menuOption[this.menuSize-1],2<this.menuSize&&(e=e+"@whi@ / "+(this.menuSize-2)+" more options"),this.fontBold12?.drawStringTooltip(4,15,e,ct.WHITE,!0,this.loopCycle/1e3|0)}};drawMenu=()=>{var i=this.menuX,s=this.menuY,a=this.menuWidth,e=this.menuHeight,t=ct.OPTIONS_MENU;D.fillRect(i,s,a,e,t),D.fillRect(i+1,s+1,a-2,16,ct.BLACK),D.drawRect(i+1,s+18,a-2,e-19,ct.BLACK),this.fontBold12?.drawString(i+3,s+14,"Choose Option",t);let r=this.mouseX,h=this.mouseY;0===this.menuArea&&(r-=8,h-=11),1===this.menuArea&&(r-=562,h-=231),2===this.menuArea&&(r-=22,h-=375);for(let t=0;t<this.menuSize;t++){var l=s+15*(this.menuSize-1-t)+31;let e=ct.WHITE;r>i&&r<i+a&&h>l-13&&h<l+3&&(e=ct.YELLOW),this.fontBold12?.drawStringTaggable(i+3,l,this.menuOption[t],e,!0)}};handleMouseInput=async()=>{if(0===this.objDragArea){let e=this.mouseClickButton;if(1===this.spellSelected&&520<=this.mouseClickX&&165<=this.mouseClickY&&this.mouseClickX<=788&&this.mouseClickY<=230&&(e=0),this.menuVisible){if(1!==e){let e=this.mouseX,t=this.mouseY;0===this.menuArea?(e-=8,t-=11):1===this.menuArea?(e-=562,t-=231):2===this.menuArea&&(e-=22,t-=375),(e<this.menuX-10||e>this.menuX+this.menuWidth+10||t<this.menuY-10||t>this.menuY+this.menuHeight+10)&&(this.menuVisible=!1,1===this.menuArea&&(this.redrawSidebar=!0),2===this.menuArea)&&(this.redrawChatback=!0)}if(1===e){var a=this.menuX,r=this.menuY,h=this.menuWidth;let t=this.mouseClickX,i=this.mouseClickY,s=(0===this.menuArea?(t-=8,i-=11):1===this.menuArea?(t-=562,i-=231):2===this.menuArea&&(t-=22,i-=375),-1);for(let e=0;e<this.menuSize;e++){var l=r+15*(this.menuSize-1-e)+31;t>a&&t<a+h&&i>l-13&&i<l+3&&(s=e)}-1!==s&&await this.useMenuOption(s),this.menuVisible=!1,1===this.menuArea?this.redrawSidebar=!0:2===this.menuArea&&(this.redrawChatback=!0)}}else{if(1===e&&0<this.menuSize){var t=this.menuAction[this.menuSize-1];if(602===t||596===t||22===t||892===t||415===t||405===t||38===t||422===t||478===t||347===t||188===t){var t=this.menuParamB[this.menuSize-1],i=this.menuParamC[this.menuSize-1];if(ft.instances[i].draggable)return this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=i,this.objDragSlot=t,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,ft.instances[i].layer===this.viewportInterfaceId&&(this.objDragArea=1),void(ft.instances[i].layer===this.chatInterfaceId&&(this.objDragArea=3))}}1===(e=1===e&&(1===this.mouseButtonsOption||this.isAddFriendOption(this.menuSize-1))&&2<this.menuSize?2:e)&&0<this.menuSize&&await this.useMenuOption(this.menuSize-1),2!==e||this.menuSize<=0||this.showContextMenu()}}};handleMinimapInput=()=>{var e,t,i,s,a;1===this.mouseClickButton&&this.localPlayer&&(e=this.mouseClickX-21-561,t=this.mouseClickY-9-5,0<=e)&&0<=t&&e<146&&t<151&&(e-=73,t-=75,a=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,i=_.sin[a],a=_.cos[a],i=i*(this.minimapZoom+256)>>8,a=a*(this.minimapZoom+256)>>8,s=this.localPlayer.x+(t*i+e*a>>11)>>7,a=this.localPlayer.z-(t*a-e*i>>11)>>7,this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],s,a,1,0,0,0,0,0,!0))&&(this.out.p1(e),this.out.p1(t),this.out.p2(this.orbitCameraYaw),this.out.p1(57),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom),this.out.p1(89),this.out.p2(this.localPlayer.x),this.out.p2(this.localPlayer.z),this.out.p1(this.tryMoveNearest),this.out.p1(63))};isAddFriendOption=e=>{if(e<0)return!1;let t=this.menuAction[e];return 2e3<=t&&(t-=2e3),406===t};useMenuOption=async t=>{if(!(t<0)){this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0);let i=this.menuAction[t];var s=this.menuParamA[t],e=this.menuParamB[t],a=this.menuParamC[t];if(2e3<=i&&(i-=2e3),903===i||363===i){let e=this.menuOption[t];var r=e.indexOf("@whi@");if(-1!=r){e=e.substring(5+r).trim();var h=ut.formatName(ut.fromBase37(ut.toBase37(e)));let t=!1;for(let e=0;e<this.playerCount;e++){var l=this.players[this.playerIds[e]];if(l&&l.name&&l.name.toLowerCase()==h.toLowerCase()&&this.localPlayer){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],l.pathTileX[0],l.pathTileZ[0],2,1,1,0,0,0,!1),903===i?this.out.p1isaac(gt.OPPLAYER4):363===i&&this.out.p1isaac(gt.OPPLAYER1),this.out.p2(this.playerIds[e]),t=!0;break}}t||this.addMessage(0,"Unable to find "+h,"")}}else if(450===i&&this.interactWithLoc(gt.OPLOCU,e,a,s))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface);else if(405===i||38===i||422===i||478===i||347===i)478===i?(0==(3&e)&&Client.oplogic5++,90<=Client.oplogic5&&this.out.p1isaac(gt.ANTICHEAT_OPLOGIC5),this.out.p1isaac(gt.OPHELD4)):347===i?this.out.p1isaac(gt.OPHELD5):422===i?this.out.p1isaac(gt.OPHELD3):405===i?(Client.oplogic3+=s,97<=Client.oplogic3&&(this.out.p1isaac(gt.ANTICHEAT_OPLOGIC3),this.out.p3(14953816)),this.out.p1isaac(gt.OPHELD1)):38===i&&this.out.p1isaac(gt.OPHELD2),this.out.p2(s),this.out.p2(e),this.out.p2(a),this.selectedCycle=0,this.selectedInterface=a,this.selectedItem=e,this.selectedArea=2,ft.instances[a].layer===this.viewportInterfaceId&&(this.selectedArea=1),ft.instances[a].layer===this.chatInterfaceId&&(this.selectedArea=3);else if(728===i||542===i||6===i||963===i||245===i){var r=this.npcs[s];r&&this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],r.pathTileX[0],r.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,542===i?this.out.p1isaac(gt.OPNPC2):6===i?(0==(3&s)&&Client.oplogic2++,124<=Client.oplogic2&&(this.out.p1isaac(gt.ANTICHEAT_OPLOGIC2),this.out.p4(0)),this.out.p1isaac(gt.OPNPC3)):963===i?this.out.p1isaac(gt.OPNPC4):728===i?this.out.p1isaac(gt.OPNPC1):245===i&&(0==(3&s)&&Client.oplogic4++,85<=Client.oplogic4&&(this.out.p1isaac(gt.ANTICHEAT_OPLOGIC4),this.out.p2(39596)),this.out.p1isaac(gt.OPNPC5)),this.out.p2(s))}else if(217===i)this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],e,a,2,0,0,0,0,0,!1)||this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],e,a,2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(gt.OPOBJU),this.out.p2(e+this.sceneBaseTileX),this.out.p2(a+this.sceneBaseTileZ),this.out.p2(s),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface));else if(1175===i){var r=s>>14&32767,r=P.get(r);let e;e=r.desc||"It's a "+r.name+".",this.addMessage(0,e,"")}else if(285===i)this.interactWithLoc(gt.OPLOC1,e,a,s);else if(881===i)this.out.p1isaac(gt.OPHELDU),this.out.p2(s),this.out.p2(e),this.out.p2(a),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=a,this.selectedItem=e,this.selectedArea=2,ft.instances[a].layer===this.viewportInterfaceId&&(this.selectedArea=1),ft.instances[a].layer===this.chatInterfaceId&&(this.selectedArea=3);else if(391===i)this.out.p1isaac(gt.OPHELDT),this.out.p2(s),this.out.p2(e),this.out.p2(a),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=a,this.selectedItem=e,this.selectedArea=2,ft.instances[a].layer===this.viewportInterfaceId&&(this.selectedArea=1),ft.instances[a].layer===this.chatInterfaceId&&(this.selectedArea=3);else if(660===i)this.menuVisible?this.scene?.click(e-8,a-11):this.scene?.click(this.mouseClickX-8,this.mouseClickY-11);else{if(188===i)return this.objSelected=1,this.objSelectedSlot=e,this.objSelectedInterface=a,this.objInterface=s,this.objSelectedName=dt.get(s).name,void(this.spellSelected=0);if(44===i)this.pressedContinueOption||(this.out.p1isaac(gt.RESUME_PAUSEBUTTON),this.out.p2(a),this.pressedContinueOption=!0);else if(1773===i){r=dt.get(s);let e;e=1e5<=a?a+" x "+r.name:r.desc||"It's a "+r.name+".",this.addMessage(0,e,"")}else if(900===i){r=this.npcs[s];r&&this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],r.pathTileX[0],r.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(gt.OPNPCU),this.out.p2(s),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface))}else if(1373===i||1544===i||151===i||1101===i){r=this.players[s];r&&this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],r.pathTileX[0],r.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,1101===i?this.out.p1isaac(gt.OPPLAYER1):151===i?(Client.oplogic8++,90<=Client.oplogic8&&(this.out.p1isaac(gt.ANTICHEAT_OPLOGIC8),this.out.p2(31114)),this.out.p1isaac(gt.OPPLAYER2)):1373===i?this.out.p1isaac(gt.OPPLAYER4):1544===i&&this.out.p1isaac(gt.OPPLAYER3),this.out.p2(s))}else if(265===i){r=this.npcs[s];r&&this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],r.pathTileX[0],r.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(gt.OPNPCT),this.out.p2(s),this.out.p2(this.activeSpellId))}else if(679===i){var r=this.menuOption[t],n=r.indexOf("@whi@");if(-1!=n){var o=ut.toBase37(r.substring(5+n).trim());let t=-1;for(let e=0;e<this.friendCount;e++)if(this.friendName37[e]===o){t=e;break}-1!==t&&0<this.friendWorld[t]&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=3,this.socialName37=this.friendName37[t],this.socialMessage="Enter message to send to "+this.friendName[t])}}else if(55===i)this.interactWithLoc(gt.OPLOCT,e,a,s)&&this.out.p2(this.activeSpellId);else if(224===i||993===i||99===i||746===i||877===i)this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],e,a,2,0,0,0,0,0,!1)||this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],e,a,2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,224===i?this.out.p1isaac(gt.OPOBJ1):746===i?this.out.p1isaac(gt.OPOBJ4):877===i?this.out.p1isaac(gt.OPOBJ5):99===i?this.out.p1isaac(gt.OPOBJ3):993===i&&this.out.p1isaac(gt.OPOBJ2),this.out.p2(e+this.sceneBaseTileX),this.out.p2(a+this.sceneBaseTileZ),this.out.p2(s));else if(1607===i){r=this.npcs[s];if(r&&r.type){let e;e=r.type.desc||"It's a "+r.type.name+".",this.addMessage(0,e,"")}}else if(504===i)this.interactWithLoc(gt.OPLOC2,e,a,s);else{if(930===i){var n=ft.instances[a];this.spellSelected=1,this.activeSpellId=a,this.activeSpellFlags=n.actionTarget,this.objSelected=0;let e=n.actionVerb,t=(e&&~e.indexOf(" ")&&(e=e.substring(0,e.indexOf(" "))),n.actionVerb);return t&&~t.indexOf(" ")&&(t=t.substring(1+t.indexOf(" "))),this.spellCaption=e+" "+n.action+" "+t,void(16===this.activeSpellFlags&&(this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0))}if(951===i){r=ft.instances[a];let e=!0;(e=0<r.clientCode?this.handleInterfaceAction(r):e)&&(this.out.p1isaac(gt.IF_BUTTON),this.out.p2(a))}else if(602===i||596===i||22===i||892===i||415===i)22===i?this.out.p1isaac(gt.INV_BUTTON3):415===i?(0==(3&a)&&Client.oplogic7++,55<=Client.oplogic7&&(this.out.p1isaac(gt.ANTICHEAT_OPLOGIC7),this.out.p4(0)),this.out.p1isaac(gt.INV_BUTTON5)):602===i?this.out.p1isaac(gt.INV_BUTTON1):892===i?(0==(3&e)&&Client.oplogic9++,130<=Client.oplogic9&&(this.out.p1isaac(gt.ANTICHEAT_OPLOGIC9),this.out.p1(177)),this.out.p1isaac(gt.INV_BUTTON4)):596===i&&this.out.p1isaac(gt.INV_BUTTON2),this.out.p2(s),this.out.p2(e),this.out.p2(a),this.selectedCycle=0,this.selectedInterface=a,this.selectedItem=e,this.selectedArea=2,ft.instances[a].layer===this.viewportInterfaceId&&(this.selectedArea=1),ft.instances[a].layer===this.chatInterfaceId&&(this.selectedArea=3);else if(581===i)0==(3&s)&&Client.oplogic1++,99<=Client.oplogic1&&(this.out.p1isaac(gt.ANTICHEAT_OPLOGIC1),this.out.p4(0)),this.interactWithLoc(gt.OPLOC4,e,a,s);else if(965===i)this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],e,a,2,0,0,0,0,0,!1)||this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],e,a,2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(gt.OPOBJT),this.out.p2(e+this.sceneBaseTileX),this.out.p2(a+this.sceneBaseTileZ),this.out.p2(s),this.out.p2(this.activeSpellId));else if(1501===i)Client.oplogic6+=this.sceneBaseTileZ,92<=Client.oplogic6&&(this.out.p1isaac(gt.ANTICHEAT_OPLOGIC6),this.out.p4(0)),this.interactWithLoc(gt.OPLOC5,e,a,s);else if(364===i)this.interactWithLoc(gt.OPLOC3,e,a,s);else if(1102===i){var n=dt.get(s);let e;e=n.desc||"It's a "+n.name+".",this.addMessage(0,e,"")}else if(960===i){this.out.p1isaac(gt.IF_BUTTON),this.out.p2(a);r=ft.instances[a];r.scripts&&r.scripts[0]&&5===r.scripts[0][0]&&(e=r.scripts[0][1],r.scriptOperand)&&this.varps[e]!==r.scriptOperand[0]&&(this.varps[e]=r.scriptOperand[0],await this.updateVarp(e),this.redrawSidebar=!0)}else if(34===i){n=this.menuOption[t],r=n.indexOf("@whi@");if(-1!=r){this.closeInterfaces(),this.reportAbuseInput=n.substring(5+r).trim(),this.reportAbuseMuteOption=!1;for(let e=0;e<ft.instances.length;e++)if(ft.instances[e]&&ft.instances[e].clientCode===ft.CC_REPORT_INPUT){this.reportAbuseInterfaceID=this.viewportInterfaceId=ft.instances[e].layer;break}}}else 947===i?this.closeInterfaces():367===i?(e=this.players[s])&&this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],e.pathTileX[0],e.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(gt.OPPLAYERU),this.out.p2(s),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)):465===i?(this.out.p1isaac(gt.IF_BUTTON),this.out.p2(a),(n=ft.instances[a]).scripts&&n.scripts[0]&&5===n.scripts[0][0]&&(r=n.scripts[0][1],this.varps[r]=1-this.varps[r],await this.updateVarp(r),this.redrawSidebar=!0)):406===i||436===i||557===i||556===i?-1!=(a=(e=this.menuOption[t]).indexOf("@whi@"))&&(n=ut.toBase37(e.substring(5+a).trim()),406===i?this.addFriend(n):436===i?this.addIgnore(n):557===i?this.removeFriend(n):556===i&&this.removeIgnore(n)):651===i&&(r=this.players[s])&&this.localPlayer&&(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],r.pathTileX[0],r.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(gt.OPPLAYERT),this.out.p2(s),this.out.p2(this.activeSpellId))}}this.objSelected=0,this.spellSelected=0}};handleInterfaceAction=t=>{t=t.clientCode;if(t===ft.CC_ADD_FRIEND&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=1,this.socialMessage="Enter name of friend to add to list"),t===ft.CC_DEL_FRIEND&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=2,this.socialMessage="Enter name of friend to delete from list"),t===ft.CC_LOGOUT)this.idleTimeout=250;else{if(t===ft.CC_ADD_IGNORE&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=4,this.socialMessage="Enter name of player to add to list"),t===ft.CC_DEL_IGNORE&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=5,this.socialMessage="Enter name of player to delete from list"),t>=ft.CC_CHANGE_HEAD_L&&t<=ft.CC_CHANGE_FEET_R){var i=(t-300)/2|0,s=1&t;let e=this.designIdentikits[i];if(-1!==e)for(;;)if(0==s&&--e<0&&(e=K.count-1),1==s&&++e>=K.count&&(e=0),!K.instances[e].disable&&K.instances[e].type===i+(this.designGenderMale?0:7)){this.designIdentikits[i]=e,this.updateDesignModel=!0;break}}if(t>=ft.CC_RECOLOUR_HAIR_L&&t<=ft.CC_RECOLOUR_SKIN_R){var a=(t-314)/2|0,r=1&t;let e=this.designColors[a];0==r&&--e<0&&(e=c.DESIGN_IDK_COLORS[a].length-1),1==r&&++e>=c.DESIGN_IDK_COLORS[a].length&&(e=0),this.designColors[a]=e,this.updateDesignModel=!0}if(t!==ft.CC_SWITCH_TO_MALE||this.designGenderMale||(this.designGenderMale=!0,this.validateCharacterDesign()),t===ft.CC_SWITCH_TO_FEMALE&&this.designGenderMale&&(this.designGenderMale=!1,this.validateCharacterDesign()),t!==ft.CC_ACCEPT_DESIGN)return t===ft.CC_MOD_MUTE&&(this.reportAbuseMuteOption=!this.reportAbuseMuteOption),t>=ft.CC_REPORT_RULE1&&t<=ft.CC_REPORT_RULE12&&(this.closeInterfaces(),0<this.reportAbuseInput.length)&&(this.out.p1isaac(gt.REPORT_ABUSE),this.out.p8(ut.toBase37(this.reportAbuseInput)),this.out.p1(t-601),this.out.p1(this.reportAbuseMuteOption?1:0)),!1;this.out.p1isaac(gt.IF_PLAYERDESIGN),this.out.p1(this.designGenderMale?0:1);for(let e=0;e<7;e++)this.out.p1(this.designIdentikits[e]);for(let e=0;e<5;e++)this.out.p1(this.designColors[e])}return!0};validateCharacterDesign=()=>{this.updateDesignModel=!0;for(let t=0;t<7;t++){this.designIdentikits[t]=-1;for(let e=0;e<K.count;e++)if(!K.instances[e].disable&&K.instances[e].type===t+(this.designGenderMale?0:7)){this.designIdentikits[t]=e;break}}};interactWithLoc=(e,s,a,r)=>{if(!this.localPlayer||!this.scene)return!1;var h=r>>14&32767,r=this.scene.getInfo(this.currentLevel,s,a,r);if(-1===r)return!1;var t=31&r,r=r>>6&3;if(t===k.CENTREPIECE_STRAIGHT.id||t===k.CENTREPIECE_DIAGONAL.id||t===k.GROUND_DECOR.id){var l=P.get(h);let e,t,i=(t=r===N.WEST||r===N.EAST?(e=l.width,l.length):(e=l.length,l.width),l.forceapproach);0!=r&&(i=(i<<r&15)+(i>>4-r)),this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],s,a,2,e,t,0,0,i,!1)}else this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],s,a,2,0,0,r,1+t,0,!1);return this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(e),this.out.p2(s+this.sceneBaseTileX),this.out.p2(a+this.sceneBaseTileZ),this.out.p2(h),!0};handleTabInput=()=>{1===this.mouseClickButton&&(549<=this.mouseClickX&&this.mouseClickX<=583&&195<=this.mouseClickY&&this.mouseClickY<231&&-1!==this.tabInterfaceId[0]?(this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0):579<=this.mouseClickX&&this.mouseClickX<=609&&194<=this.mouseClickY&&this.mouseClickY<231&&-1!==this.tabInterfaceId[1]?(this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0):607<=this.mouseClickX&&this.mouseClickX<=637&&194<=this.mouseClickY&&this.mouseClickY<231&&-1!==this.tabInterfaceId[2]?(this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0):635<=this.mouseClickX&&this.mouseClickX<=679&&194<=this.mouseClickY&&this.mouseClickY<229&&-1!==this.tabInterfaceId[3]?(this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0):676<=this.mouseClickX&&this.mouseClickX<=706&&194<=this.mouseClickY&&this.mouseClickY<231&&-1!==this.tabInterfaceId[4]?(this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0):704<=this.mouseClickX&&this.mouseClickX<=734&&194<=this.mouseClickY&&this.mouseClickY<231&&-1!==this.tabInterfaceId[5]?(this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0):732<=this.mouseClickX&&this.mouseClickX<=766&&195<=this.mouseClickY&&this.mouseClickY<231&&-1!==this.tabInterfaceId[6]?(this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0):550<=this.mouseClickX&&this.mouseClickX<=584&&492<=this.mouseClickY&&this.mouseClickY<528&&-1!==this.tabInterfaceId[7]?(this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0):582<=this.mouseClickX&&this.mouseClickX<=612&&492<=this.mouseClickY&&this.mouseClickY<529&&-1!==this.tabInterfaceId[8]?(this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0):609<=this.mouseClickX&&this.mouseClickX<=639&&492<=this.mouseClickY&&this.mouseClickY<529&&-1!==this.tabInterfaceId[9]?(this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0):637<=this.mouseClickX&&this.mouseClickX<=681&&493<=this.mouseClickY&&this.mouseClickY<528&&-1!==this.tabInterfaceId[10]?(this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0):679<=this.mouseClickX&&this.mouseClickX<=709&&492<=this.mouseClickY&&this.mouseClickY<529&&-1!==this.tabInterfaceId[11]?(this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0):706<=this.mouseClickX&&this.mouseClickX<=736&&492<=this.mouseClickY&&this.mouseClickY<529&&-1!==this.tabInterfaceId[12]?(this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0):734<=this.mouseClickX&&this.mouseClickX<=768&&492<=this.mouseClickY&&this.mouseClickY<528&&-1!==this.tabInterfaceId[13]&&(this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0),Client.cyclelogic1++,150<Client.cyclelogic1)&&(Client.cyclelogic1=0,this.out.p1isaac(gt.ANTICHEAT_CYCLELOGIC1),this.out.p1(43))};handleInputKey=async()=>{for(;;){let e;do{for(;;){if(-1===(e=this.pollKey()))return;if(-1!==this.viewportInterfaceId&&this.viewportInterfaceId===this.reportAbuseInterfaceID){8===e&&0<this.reportAbuseInput.length&&(this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1));break}if(this.showSocialInput){if(32<=e&&e<=122&&this.socialInput.length<80&&(this.socialInput=this.socialInput+String.fromCharCode(e),this.redrawChatback=!0),8===e&&0<this.socialInput.length&&(this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0),13===e||10===e){this.showSocialInput=!1,this.redrawChatback=!0;let e;1===this.socialAction&&(e=ut.toBase37(this.socialInput),this.addFriend(e)),2===this.socialAction&&0<this.friendCount&&(e=ut.toBase37(this.socialInput),this.removeFriend(e)),3===this.socialAction&&0<this.socialInput.length&&this.socialName37&&(this.out.p1isaac(gt.MESSAGE_PRIVATE),this.out.p1(0),i=this.out.pos,this.out.p8(this.socialName37),Ot.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-i),this.socialInput=ut.toSentenceCase(this.socialInput),this.socialInput=At.filter(this.socialInput),this.addMessage(6,this.socialInput,ut.formatName(ut.fromBase37(this.socialName37))),2===this.privateChatSetting)&&(this.privateChatSetting=1,this.redrawPrivacySettings=!0,this.out.p1isaac(gt.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting)),4===this.socialAction&&this.ignoreCount<100&&(e=ut.toBase37(this.socialInput),this.addIgnore(e)),5===this.socialAction&&0<this.ignoreCount&&(e=ut.toBase37(this.socialInput),this.removeIgnore(e))}}else if(this.chatbackInputOpen){if(48<=e&&e<=57&&this.chatbackInput.length<10&&(this.chatbackInput=this.chatbackInput+String.fromCharCode(e),this.redrawChatback=!0),8===e&&0<this.chatbackInput.length&&(this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0),13===e||10===e){if(0<this.chatbackInput.length){let e=0;try{e=parseInt(this.chatbackInput,10)}catch(e){}this.out.p1isaac(gt.RESUME_P_COUNTDIALOG),this.out.p4(e)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(-1===this.chatInterfaceId&&(32<=e&&e<=126&&this.chatTyped.length<80&&(this.chatTyped=this.chatTyped+String.fromCharCode(e),this.redrawChatback=!0),8===e&&0<this.chatTyped.length&&(this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0),13===e||10===e)&&0<this.chatTyped.length){if(this.chatTyped.startsWith("::"))if("::fpson"===this.chatTyped)this.displayFps=!0;else if("::fpsoff"===this.chatTyped)this.displayFps=!1;else if(this.chatTyped.startsWith("::fps "))try{var t=parseInt(this.chatTyped.substring(6))||50;this.setTargetedFramerate(t)}catch(e){}else this.out.p1isaac(gt.CLIENT_CHEAT),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let e=0,t=(this.chatTyped.startsWith("yellow:")?(e=0,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("red:")?(e=1,this.chatTyped=this.chatTyped.substring(4)):this.chatTyped.startsWith("green:")?(e=2,this.chatTyped=this.chatTyped.substring(6)):this.chatTyped.startsWith("cyan:")?(e=3,this.chatTyped=this.chatTyped.substring(5)):this.chatTyped.startsWith("purple:")?(e=4,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("white:")?(e=5,this.chatTyped=this.chatTyped.substring(6)):this.chatTyped.startsWith("flash1:")?(e=6,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("flash2:")?(e=7,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("flash3:")?(e=8,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("glow1:")?(e=9,this.chatTyped=this.chatTyped.substring(6)):this.chatTyped.startsWith("glow2:")?(e=10,this.chatTyped=this.chatTyped.substring(6)):this.chatTyped.startsWith("glow3:")&&(e=11,this.chatTyped=this.chatTyped.substring(6)),0);this.chatTyped.startsWith("wave:")&&(t=1,this.chatTyped=this.chatTyped.substring(5)),this.chatTyped.startsWith("scroll:")&&(t=2,this.chatTyped=this.chatTyped.substring(7)),this.out.p1isaac(gt.MESSAGE_PUBLIC),this.out.p1(0);var i=this.out.pos;this.out.p1(e),this.out.p1(t),Ot.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-i),this.chatTyped=ut.toSentenceCase(this.chatTyped),this.chatTyped=At.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name&&(this.localPlayer.chat=this.chatTyped,this.localPlayer.chatColor=e,this.localPlayer.chatStyle=t,this.localPlayer.chatTimer=150,this.addMessage(2,this.localPlayer.chat,this.localPlayer.name)),2===this.publicChatSetting&&(this.publicChatSetting=3,this.redrawPrivacySettings=!0,this.out.p1isaac(gt.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting))}this.chatTyped="",this.redrawChatback=!0}}}while((e<97||122<e)&&(e<65||90<e)&&(e<48||57<e)&&32!==e);this.reportAbuseInput.length<12&&(this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(e))}};handleChatSettingsInput=()=>{if(1===this.mouseClickButton)if(8<=this.mouseClickX&&this.mouseClickX<=108&&490<=this.mouseClickY&&this.mouseClickY<=522)this.publicChatSetting=(this.publicChatSetting+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(gt.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(137<=this.mouseClickX&&this.mouseClickX<=237&&490<=this.mouseClickY&&this.mouseClickY<=522)this.privateChatSetting=(this.privateChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(gt.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(275<=this.mouseClickX&&this.mouseClickX<=375&&490<=this.mouseClickY&&this.mouseClickY<=522)this.tradeChatSetting=(this.tradeChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(gt.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(416<=this.mouseClickX&&this.mouseClickX<=516&&490<=this.mouseClickY&&this.mouseClickY<=522){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let e=0;e<ft.instances.length;e++)if(ft.instances[e]&&600===ft.instances[e].clientCode)return void(this.reportAbuseInterfaceID=this.viewportInterfaceId=ft.instances[e].layer)}};handleScrollInput=(t,i,s,a,r,h,l,n)=>{if(this.scrollGrabbed?this.scrollInputPadding=32:this.scrollInputPadding=0,this.scrollGrabbed=!1,h<=t&&t<h+16&&l<=i&&i<l+16)n.scrollPosition-=4*this.dragCycles,r&&(this.redrawSidebar=!0);else if(h<=t&&t<h+16&&l+a-16<=i&&i<l+a)n.scrollPosition+=4*this.dragCycles,r&&(this.redrawSidebar=!0);else if(t>=h-this.scrollInputPadding&&t<h+this.scrollInputPadding+16&&l+16<=i&&i<l+a-16&&0<this.dragCycles){let e=(a-32)*a/s|0;t=i-l-((e=e<8?8:e)/2|0)-16,h=a-e-32;n.scrollPosition=(s-a)*t/h|0,r&&(this.redrawSidebar=!0),this.scrollGrabbed=!0}};prepareGameScreen=()=>{this.areaChatback||(this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new E(479,96),this.areaMapback=new E(168,160),D.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new E(190,261),this.areaViewport=new E(512,334),D.clear(),this.areaBackbase1=new E(501,61),this.areaBackbase2=new E(288,40),this.areaBackhmid1=new E(269,66),this.redrawTitleBackground=!0)};isFriend=t=>{if(!t)return!1;for(let e=0;e<this.friendCount;e++)if(t.toLowerCase()==this.friendName[e]?.toLowerCase())return!0;return!!this.localPlayer&&t.toLowerCase()==this.localPlayer.name?.toLowerCase()};addFriend=t=>{if(0n!==t)if(100<=this.friendCount)this.addMessage(0,"Your friends list is full. Max of 100 hit","");else{var i=ut.formatName(ut.fromBase37(t));for(let e=0;e<this.friendCount;e++)if(this.friendName37[e]===t)return void this.addMessage(0,i+" is already on your friend list","");for(let e=0;e<this.ignoreCount;e++)if(this.ignoreName37[e]===t)return void this.addMessage(0,"Please remove "+i+" from your ignore list first","");this.localPlayer&&this.localPlayer.name&&i!==this.localPlayer.name&&(this.friendName[this.friendCount]=i,this.friendName37[this.friendCount]=t,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(gt.FRIENDLIST_ADD),this.out.p8(t))}};removeFriend=e=>{if(0n!==e)for(let t=0;t<this.friendCount;t++)if(this.friendName37[t]===e){this.friendCount--,this.redrawSidebar=!0;for(let e=t;e<this.friendCount;e++)this.friendName[e]=this.friendName[e+1],this.friendWorld[e]=this.friendWorld[e+1],this.friendName37[e]=this.friendName37[e+1];return this.out.p1isaac(gt.FRIENDLIST_DEL),void this.out.p8(e)}};addIgnore=t=>{if(0n!==t)if(100<=this.ignoreCount)this.addMessage(0,"Your ignore list is full. Max of 100 hit","");else{var i=ut.formatName(ut.fromBase37(t));for(let e=0;e<this.ignoreCount;e++)if(this.ignoreName37[e]===t)return void this.addMessage(0,i+" is already on your ignore list","");for(let e=0;e<this.friendCount;e++)if(this.friendName37[e]===t)return void this.addMessage(0,"Please remove "+i+" from your friend list first","");this.ignoreName37[this.ignoreCount++]=t,this.redrawSidebar=!0,this.out.p1isaac(gt.IGNORELIST_ADD),this.out.p8(t)}};removeIgnore=e=>{if(0n!==e)for(let t=0;t<this.ignoreCount;t++)if(this.ignoreName37[t]===e){this.ignoreCount--,this.redrawSidebar=!0;for(let e=t;e<this.ignoreCount;e++)this.ignoreName37[e]=this.ignoreName37[e+1];return this.out.p1isaac(gt.IGNORELIST_DEL),void this.out.p8(e)}};sortObjStacks=(l,n)=>{var o=this.levelObjStacks[this.currentLevel][l][n];if(o){let i=-99999999,h=null;for(let t=o.head();t;t=o.next()){var s=dt.get(t.index);let e=s.cost;s.stackable&&(e*=t.count+1),e>i&&(i=e,h=t)}if(h){o.addHead(h);let t=-1,i=-1,s=0,a=0;for(let e=o.head();e;e=o.next())e.index!==h.index&&-1===t&&(t=e.index,s=e.count),e.index!==h.index&&e.index!==t&&-1===i&&(i=e.index,a=e.count);let e=null,r=(-1!==t&&(e=dt.get(t).getInterfaceModel(s)),null);-1!==i&&(r=dt.get(i).getInterfaceModel(a));var c=l+(n<<7)+1610612736|0,d=dt.get(h.index);this.scene?.addObjStack(l,n,this.getHeightmapY(this.currentLevel,128*l+64,128*n+64),this.currentLevel,c,d.getInterfaceModel(h.count),r,e)}}else this.scene?.removeObjStack(this.currentLevel,l,n)};addLoc=(t,i,s,a,r,h,l)=>{if(!(i<1||s<1||102<i||102<s)&&(!Client.lowMemory||t===this.currentLevel)&&this.scene){let e=0;if(l===S.WALL&&(e=this.scene.getWallBitset(t,i,s)),l===S.WALL_DECOR&&(e=this.scene.getWallDecorationBitset(t,s,i)),l===S.GROUND&&(e=this.scene.getLocBitset(t,i,s)),0!==(e=l===S.GROUND_DECOR?this.scene.getGroundDecorationBitset(t,i,s):e)){var n,o=this.scene.getInfo(t,i,s,e),c=e>>14&32767,d=31&o,o=o>>6;if(l===S.WALL&&(this.scene?.removeWall(t,i,s,1),(n=P.get(c)).blockwalk)&&this.levelCollisionMap[t]?.removeWall(i,s,d,o,n.blockrange),l===S.WALL_DECOR&&this.scene?.removeWallDecoration(t,i,s),l===S.GROUND){this.scene.removeLoc(t,i,s);d=P.get(c);if(i+d.width>pt.SIZE-1||s+d.width>pt.SIZE-1||i+d.length>pt.SIZE-1||s+d.length>pt.SIZE-1)return;d.blockwalk&&this.levelCollisionMap[t]?.removeLoc(i,s,d.width,d.length,o,d.blockrange)}l===S.GROUND_DECOR&&(this.scene?.removeGroundDecoration(t,i,s),(n=P.get(c)).blockwalk)&&n.active&&this.levelCollisionMap[t]?.removeFloor(i,s)}if(0<=a){let e=t;this.levelTileFlags&&t<3&&2==(2&this.levelTileFlags[1][i][s])&&(e=t+1),this.levelHeightmap&&mt.addLoc(t,i,s,this.scene,this.levelHeightmap,this.locList,this.levelCollisionMap[t],a,h,r,e)}}};closeInterfaces=()=>{this.out.p1isaac(gt.CLOSE_MODAL),-1!==this.sidebarInterfaceId&&(this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0),-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1),this.viewportInterfaceId=-1};async tryReconnect(){!(0<this.idleTimeout)&&(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",ct.BLACK),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",ct.WHITE),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",ct.BLACK),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",ct.WHITE),this.areaViewport?.draw(8,11),this.flagSceneTileX=0,this.stream?.close(),this.ingame=!1,await this.login(this.username,this.password,!0),this.ingame)||await this.logout()}logout=async()=>{this.stream&&this.stream.close(),this.stream=null,this.ingame=!1,this.titleScreenState=0,this.username="",this.password="",nt.setDisabled(),this.clearCaches(),this.scene?.reset();for(let e=0;e<pt.LEVELS;e++)this.levelCollisionMap[e]?.reset();l(!1),this.currentMidi=null,this.nextMusicDelay=0};read=async()=>{if(!this.stream)return!1;try{let e=this.stream.available;if(0===e)return!1;if(-1===this.packetType&&(await this.stream.readBytes(this.in.data,0,1),this.packetType=255&this.in.data[0],this.randomIn&&(this.packetType=this.packetType-this.randomIn.nextInt&255),this.packetSize=St.SERVERPROT_SIZES[this.packetType],e--),-1===this.packetSize){if(e<=0)return!1;await this.stream.readBytes(this.in.data,0,1),this.packetSize=255&this.in.data[0],e--}if(-2===this.packetSize){if(e<=1)return!1;await this.stream.readBytes(this.in.data,0,2),this.in.pos=0,this.packetSize=this.in.g2,e-=2}if(e<this.packetSize)return!1;var t,i,s,a,r,Y,N,h,l,X,n,H,F,W,o,Z,z,G,V,U,q,j,K,c,d,J,Q,$,ee,te,ie,se,ae,re,u,he,f,le,p,ne,oe,m,g,ce,C,de,ue,fe,pe,y,v,me,ge,Ce;if(this.in.pos=0,await this.stream.readBytes(this.in.data,0,this.packetSize),this.idleNetCycles=0,this.lastPacketType2=this.lastPacketType1,this.lastPacketType1=this.lastPacketType0,this.lastPacketType0=this.packetType,this.packetType===Ct.VARP_SMALL)return t=this.in.g2,i=this.in.g1b,this.varCache[t]=i,this.varps[t]!==i&&(this.varps[t]=i,await this.updateVarp(t),this.redrawSidebar=!0,-1!==this.stickyChatInterfaceId)&&(this.redrawChatback=!0),this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_FRIENDLIST){var ye,ve,we,w=this.in.g8,T=this.in.g1;let t=ut.formatName(ut.fromBase37(w));for(let e=0;e<this.friendCount;e++)if(w===this.friendName37[e]){this.friendWorld[e]!==T&&(this.friendWorld[e]=T,this.redrawSidebar=!0,0<T&&this.addMessage(5,t+" has logged in.",""),0===T)&&this.addMessage(5,t+" has logged out.",""),t=null;break}t&&this.friendCount<100&&(this.friendName37[this.friendCount]=w,this.friendName[this.friendCount]=t,this.friendWorld[this.friendCount]=T,this.friendCount++,this.redrawSidebar=!0);let i=!1;for(;!i;){i=!0;for(let e=0;e<this.friendCount-1;e++)(this.friendWorld[e]!==Client.nodeId&&this.friendWorld[e+1]===Client.nodeId||0===this.friendWorld[e]&&0!==this.friendWorld[e+1])&&(ye=this.friendWorld[e],this.friendWorld[e]=this.friendWorld[e+1],this.friendWorld[e+1]=ye,ve=this.friendName[e],this.friendName[e]=this.friendName[e+1],this.friendName[e+1]=ve,we=this.friendName37[e],this.friendName37[e]=this.friendName37[e+1],this.friendName37[e+1]=we,this.redrawSidebar=!0,i=!1)}return this.packetType=-1,!0}if(this.packetType===Ct.UPDATE_REBOOT_TIMER)return this.systemUpdateTimer=30*this.in.g2,this.packetType=-1,!0;if(this.packetType===Ct.DATA_LAND_DONE){var Te,S,Se=this.in.g1,Ae=this.in.g1;let t=-1;if(this.sceneMapIndex)for(let e=0;e<this.sceneMapIndex.length;e++)this.sceneMapIndex[e]===(Se<<8)+Ae&&(t=e);return-1!==t&&(Te=this.sceneMapLandData)&&(S=Te[t],-1!==t)&&S&&(this.db?.cachesave(`m${Se}_`+Ae,S),this.sceneState=1),this.packetType=-1,!0}if(this.packetType===Ct.NPC_INFO)return this.readNpcInfo(this.in,this.packetSize),this.packetType=-1,!0;if(this.packetType===Ct.REBUILD_NORMAL){var Oe=this.in.g2,Ie=this.in.g2;if(this.sceneCenterZoneX===Oe&&this.sceneCenterZoneZ===Ie&&0!==this.sceneState);else{this.sceneCenterZoneX=Oe,this.sceneCenterZoneZ=Ie,this.sceneBaseTileX=8*(this.sceneCenterZoneX-6),this.sceneBaseTileZ=8*(this.sceneCenterZoneZ-6),this.sceneState=1,this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",ct.BLACK),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",ct.WHITE),this.areaViewport?.draw(8,11);var A=(this.packetSize-2)/10|0;this.sceneMapLandData=new lt(A,null),this.sceneMapLocData=new lt(A,null),this.sceneMapIndex=new Int32Array(A),this.out.p1isaac(gt.REBUILD_GETMAPS),this.out.p1(0);let i=0;for(let t=0;t<A;t++){var O=this.in.g1,I=this.in.g1,Le=this.in.g4,be=this.in.g4;this.sceneMapIndex[t]=(O<<8)+I;let e;0!==Le&&((e=(e=await this.db?.cacheload(`m${O}_`+I))&&ht.crc32(e)!==Le?void 0:e)?this.sceneMapLandData[t]=e:(this.sceneState=0,this.out.p1(0),this.out.p1(O),this.out.p1(I),i+=3)),0!==be&&((e=(e=await this.db?.cacheload(`l${O}_`+I))&&ht.crc32(e)!==be?void 0:e)?this.sceneMapLocData[t]=e:(this.sceneState=0,this.out.p1(1),this.out.p1(O),this.out.p1(I),i+=3))}this.out.psize1(i),this.areaViewport?.bind(),0===this.sceneState&&(this.fontPlain12?.drawStringCenter(257,166,"Map area updated since last visit, so load will take longer this time only",ct.BLACK),this.fontPlain12?.drawStringCenter(256,165,"Map area updated since last visit, so load will take longer this time only",ct.WHITE)),this.areaViewport?.draw(8,11);var L=this.sceneBaseTileX-this.mapLastBaseX,b=this.sceneBaseTileZ-this.mapLastBaseZ;this.mapLastBaseX=this.sceneBaseTileX,this.mapLastBaseZ=this.sceneBaseTileZ;for(let e=0;e<8192;e++){var E=this.npcs[e];if(E){for(let e=0;e<10;e++)E.pathTileX[e]-=L,E.pathTileZ[e]-=b;E.x-=128*L,E.z-=128*b}}for(let e=0;e<this.MAX_PLAYER_COUNT;e++){var x=this.players[e];if(x){for(let e=0;e<10;e++)x.pathTileX[e]-=L,x.pathTileZ[e]-=b;x.x-=128*L,x.z-=128*b}}let e=0,t=pt.SIZE,s=1,a=(L<0&&(e=pt.SIZE-1,t=-1,s=-1),0),r=pt.SIZE,h=1;b<0&&(a=pt.SIZE-1,r=-1,h=-1);for(let i=e;i!==t;i+=s)for(let t=a;t!==r;t+=h){var _=i+L,Ee=t+b;for(let e=0;e<pt.LEVELS;e++)0<=_&&0<=Ee&&_<pt.SIZE&&Ee<pt.SIZE?this.levelObjStacks[e][i][t]=this.levelObjStacks[e][_][Ee]:this.levelObjStacks[e][i][t]=null}for(let e=this.spawnedLocations.head();e;e=this.spawnedLocations.next())e.x-=L,e.z-=b,(e.x<0||e.z<0||e.x>=pt.SIZE||e.z>=pt.SIZE)&&e.unlink();0!==this.flagSceneTileX&&(this.flagSceneTileX-=L,this.flagSceneTileZ-=b),this.cutscene=!1}return this.packetType=-1,!0}if(this.packetType===Ct.IF_SETPLAYERHEAD)return ft.instances[this.in.g2].model=this.localPlayer?.getHeadModel()||null,this.packetType=-1,!0;if(this.packetType===Ct.HINT_ARROW)return this.hintType=this.in.g1,1===this.hintType&&(this.hintNpc=this.in.g2),2<=this.hintType&&this.hintType<=6&&(2===this.hintType&&(this.hintOffsetX=64,this.hintOffsetZ=64),3===this.hintType&&(this.hintOffsetX=0,this.hintOffsetZ=64),4===this.hintType&&(this.hintOffsetX=128,this.hintOffsetZ=64),5===this.hintType&&(this.hintOffsetX=64,this.hintOffsetZ=0),6===this.hintType&&(this.hintOffsetX=64,this.hintOffsetZ=128),this.hintType=2,this.hintTileX=this.in.g2,this.hintTileZ=this.in.g2,this.hintHeight=this.in.g1),10===this.hintType&&(this.hintPlayer=this.in.g2),this.packetType=-1,!0;if(this.packetType===Ct.MIDI_SONG)return s=this.in.gjstr,a=this.in.g4,r=this.in.g4,s!==this.currentMidi&&this.midiActive&&!Client.lowMemory&&await this.setMidi(s,a,r,!0),this.currentMidi=s,this.midiCrc=a,this.midiSize=r,this.nextMusicDelay=0,this.packetType=-1,!0;if(this.packetType===Ct.LOGOUT)return await this.logout(),!(this.packetType=-1);if(this.packetType===Ct.DATA_LOC_DONE){var xe,_e,Re=this.in.g1,ke=this.in.g1;let t=-1;if(this.sceneMapIndex)for(let e=0;e<this.sceneMapIndex.length;e++)this.sceneMapIndex[e]===(Re<<8)+ke&&(t=e);return-1!==t&&(xe=this.sceneMapLocData)&&(_e=xe[t],-1!==t)&&_e&&(this.db?.cachesave(`l${Re}_`+ke,_e),this.sceneState=1),this.packetType=-1,!0}if(this.packetType===Ct.UNSET_MAP_FLAG)return this.flagSceneTileX=0,this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_PID)return this.localPid=this.in.g2,this.packetType=-1,!0;if(this.packetType===Ct.OBJ_COUNT||this.packetType===Ct.LOC_MERGE||this.packetType===Ct.OBJ_REVEAL||this.packetType===Ct.MAP_ANIM||this.packetType===Ct.MAP_PROJANIM||this.packetType===Ct.OBJ_DEL||this.packetType===Ct.OBJ_ADD||this.packetType===Ct.LOC_ANIM||this.packetType===Ct.LOC_DEL||this.packetType===Ct.LOC_ADD_CHANGE)return this.readZonePacket(this.in,this.packetType),this.packetType=-1,!0;if(this.packetType===Ct.IF_OPENMAINSIDEMODAL)return Y=this.in.g2,N=this.in.g2,-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0),this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0),this.viewportInterfaceId=Y,this.sidebarInterfaceId=N,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.packetType=-1,!0;if(this.packetType===Ct.VARP_LARGE)return h=this.in.g2,l=this.in.g4,this.varCache[h]=l,this.varps[h]!==l&&(this.varps[h]=l,await this.updateVarp(h),this.redrawSidebar=!0,-1!==this.stickyChatInterfaceId)&&(this.redrawChatback=!0),this.packetType=-1,!0;if(this.packetType===Ct.IF_SETANIM)return X=this.in.g2,ft.instances[X].anim=this.in.g2,this.packetType=-1,!0;if(this.packetType===Ct.IF_OPENSIDEOVERLAY){let e=this.in.g2;var Pe=this.in.g1;return 65535===e&&(e=-1),this.tabInterfaceId[Pe]=e,this.redrawSidebar=!0,this.redrawSideicons=!0,this.packetType=-1,!0}if(this.packetType===Ct.DATA_LOC){var Be,De=this.in.g1,Me=this.in.g1,Ye=this.in.g2,Ne=this.in.g2;let t=-1;if(this.sceneMapIndex)for(let e=0;e<this.sceneMapIndex.length;e++)this.sceneMapIndex[e]===(De<<8)+Me&&(t=e);return-1!==t&&this.sceneMapLocData&&(this.sceneMapLocData[t]&&this.sceneMapLocData[t]?.length===Ne||(this.sceneMapLocData[t]=new Uint8Array(Ne)),Be=this.sceneMapLocData[t])&&this.in.gdata(this.packetSize-6,Ye,Be),this.packetType=-1,!0}if(this.packetType===Ct.FINISH_TRACKING)return(n=nt.stop())&&(this.out.p1isaac(gt.EVENT_TRACKING),this.out.p2(n.pos),this.out.pdata(n.data,n.pos,0),n.release()),this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_INV_FULL){this.redrawSidebar=!0;var Xe=this.in.g2,R=ft.instances[Xe],He=this.in.g1;if(R.invSlotObjId&&R.invSlotObjCount){for(let t=0;t<He;t++){R.invSlotObjId[t]=this.in.g2;let e=this.in.g1;255===e&&(e=this.in.g4),R.invSlotObjCount[t]=e}for(let e=He;e<R.invSlotObjId.length;e++)R.invSlotObjId[e]=0,R.invSlotObjCount[e]=0}else for(let e=0;e<He;e++)this.in.g2,255===this.in.g1&&this.in.g4;return this.packetType=-1,!0}if(this.packetType===Ct.ENABLE_TRACKING)return nt.setEnabled(),this.packetType=-1,!0;if(this.packetType===Ct.P_COUNTDIALOG)return this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_INV_STOP_TRANSMIT){var k=ft.instances[this.in.g2];if(k.invSlotObjId)for(let e=0;e<k.invSlotObjId.length;e++)k.invSlotObjId[e]=-1,k.invSlotObjId[e]=0;return this.packetType=-1,!0}if(this.packetType===Ct.LAST_LOGIN_INFO){if(this.lastAddress=this.in.g4,this.daysSinceLastLogin=this.in.g2,this.daysSinceRecoveriesChanged=this.in.g1,this.unreadMessages=this.in.g2,0!==this.lastAddress&&-1===this.viewportInterfaceId){this.closeInterfaces();let t=650;201!==this.daysSinceRecoveriesChanged&&(t=655),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let e=0;e<ft.instances.length;e++)if(ft.instances[e]&&ft.instances[e].clientCode===t){this.viewportInterfaceId=ft.instances[e].layer;break}}return this.packetType=-1,!0}if(this.packetType===Ct.TUTORIAL_FLASHSIDE)return this.flashingTab=this.in.g1,this.flashingTab===this.selectedTab&&(3===this.flashingTab?this.selectedTab=1:this.selectedTab=3,this.redrawSidebar=!0),this.packetType=-1,!0;if(this.packetType===Ct.MIDI_JINGLE)return this.midiActive&&!Client.lowMemory&&(H=this.in.g2,F=this.in.data.subarray(this.in.pos,this.packetSize),W=vt.decompress(F,-1,!1,!0),wt(W,this.midiVolume,!1),this.nextMusicDelay=H),this.packetType=-1,!0;if(this.packetType===Ct.SET_MULTIWAY)return this.inMultizone=this.in.g1,this.packetType=-1,!0;if(this.packetType===Ct.SYNTH_SOUND)return o=this.in.g2,Z=this.in.g1,z=this.in.g2,this.waveEnabled&&!Client.lowMemory&&this.waveCount<50&&(this.waveIds[this.waveCount]=o,this.waveLoops[this.waveCount]=Z,this.waveDelay[this.waveCount]=z+yt.delays[o],this.waveCount++),this.packetType=-1,!0;if(this.packetType===Ct.IF_SETNPCHEAD)return G=this.in.g2,V=this.in.g2,U=Tt.get(V),ft.instances[G].model=U.getHeadModel(),this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_ZONE_PARTIAL_FOLLOWS)return this.baseX=this.in.g1,this.baseZ=this.in.g1,this.packetType=-1,!0;if(this.packetType===Ct.IF_SETRECOL)return q=this.in.g2,j=this.in.g2,K=this.in.g2,ft.instances[q].model?.recolor(j,K),this.packetType=-1,!0;if(this.packetType===Ct.CHAT_FILTER_SETTINGS)return this.publicChatSetting=this.in.g1,this.privateChatSetting=this.in.g1,this.tradeChatSetting=this.in.g1,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.packetType=-1,!0;if(this.packetType===Ct.IF_OPENSIDEMODAL)return c=this.in.g2,this.resetInterfaceAnimation(c),-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0),this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0),this.sidebarInterfaceId=c,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0;if(this.packetType===Ct.IF_OPENCHATMODAL)return d=this.in.g2,this.resetInterfaceAnimation(d),-1!==this.sidebarInterfaceId&&(this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0),this.chatInterfaceId=d,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0;if(this.packetType===Ct.IF_SETPOSITION)return J=this.in.g2,Q=this.in.g2b,$=this.in.g2b,(ee=ft.instances[J]).x=Q,ee.y=$,this.packetType=-1,!0;if(this.packetType===Ct.CAM_MOVETO)return this.cutscene=!0,this.cutsceneSrcLocalTileX=this.in.g1,this.cutsceneSrcLocalTileZ=this.in.g1,this.cutsceneSrcHeight=this.in.g2,this.cutsceneMoveSpeed=this.in.g1,this.cutsceneMoveAcceleration=this.in.g1,100<=this.cutsceneMoveAcceleration&&(this.cameraX=128*this.cutsceneSrcLocalTileX+64,this.cameraZ=128*this.cutsceneSrcLocalTileZ+64,this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight),this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_ZONE_FULL_FOLLOWS){this.baseX=this.in.g1,this.baseZ=this.in.g1;for(let t=this.baseX;t<this.baseX+8;t++)for(let e=this.baseZ;e<this.baseZ+8;e++)this.levelObjStacks[this.currentLevel][t][e]&&(this.levelObjStacks[this.currentLevel][t][e]=null,this.sortObjStacks(t,e));for(let e=this.spawnedLocations.head();e;e=this.spawnedLocations.next())e.x>=this.baseX&&e.x<this.baseX+8&&e.z>=this.baseZ&&e.z<this.baseZ+8&&e.plane===this.currentLevel&&(this.addLoc(e.plane,e.x,e.z,e.lastLocIndex,e.lastAngle,e.lastShape,e.layer),e.unlink());return this.packetType=-1,!0}if(this.packetType===Ct.DATA_LAND){var Fe,We=this.in.g1,Ze=this.in.g1,ze=this.in.g2,Ge=this.in.g2;let t=-1;if(this.sceneMapIndex)for(let e=0;e<this.sceneMapIndex.length;e++)this.sceneMapIndex[e]===(We<<8)+Ze&&(t=e);return-1!==t&&this.sceneMapLandData&&(this.sceneMapLandData[t]&&this.sceneMapLandData[t]?.length===Ge||(this.sceneMapLandData[t]=new Uint8Array(Ge)),Fe=this.sceneMapLandData[t])&&this.in.gdata(this.packetSize-6,ze,Fe),this.packetType=-1,!0}if(this.packetType===Ct.MESSAGE_PRIVATE){var Ve=this.in.g8,Ue=this.in.g4,qe=this.in.g1;let t=!1;for(let e=0;e<100;e++)if(this.messageIds[e]===Ue){t=!0;break}if(qe<=1)for(let e=0;e<this.ignoreCount;e++)if(this.ignoreName37[e]===Ve){t=!0;break}if(!t&&0===this.overrideChat)try{this.messageIds[this.privateMessageCount]=Ue,this.privateMessageCount=(this.privateMessageCount+1)%100;var je=Ot.unpack(this.in,this.packetSize-13),Ke=At.filter(je);1<qe?this.addMessage(7,Ke,ut.formatName(ut.fromBase37(Ve))):this.addMessage(3,Ke,ut.formatName(ut.fromBase37(Ve)))}catch(e){}return this.packetType=-1,!0}if(this.packetType===Ct.RESET_CLIENT_VARCACHE){for(let e=0;e<this.varps.length;e++)this.varps[e]!==this.varCache[e]&&(this.varps[e]=this.varCache[e],await this.updateVarp(e),this.redrawSidebar=!0);return this.packetType=-1,!0}if(this.packetType===Ct.IF_SETMODEL)return te=this.in.g2,ie=this.in.g2,ft.instances[te].model=ot.model(ie),this.packetType=-1,!0;if(this.packetType===Ct.TUTORIAL_OPENCHAT)return this.stickyChatInterfaceId=this.in.g2b,this.redrawChatback=!0,this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_RUNENERGY)return 12===this.selectedTab&&(this.redrawSidebar=!0),this.energy=this.in.g1,this.packetType=-1,!0;if(this.packetType===Ct.CAM_LOOKAT)return this.cutscene=!0,this.cutsceneDstLocalTileX=this.in.g1,this.cutsceneDstLocalTileZ=this.in.g1,this.cutsceneDstHeight=this.in.g2,this.cutsceneRotateSpeed=this.in.g1,this.cutsceneRotateAcceleration=this.in.g1,100<=this.cutsceneRotateAcceleration&&(se=128*this.cutsceneDstLocalTileX+64,ae=128*this.cutsceneDstLocalTileZ+64,re=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,u=se-this.cameraX,he=re-this.cameraY,le=0|Math.sqrt(u*u+(f=ae-this.cameraZ)*f),this.cameraPitch=2047&(325.949*Math.atan2(he,le)|0),this.cameraYaw=2047&(-325.949*Math.atan2(u,f)|0),this.cameraPitch<128&&(this.cameraPitch=128),383<this.cameraPitch)&&(this.cameraPitch=383),this.packetType=-1,!0;if(this.packetType===Ct.IF_SHOWSIDE)return this.selectedTab=this.in.g1,this.redrawSidebar=!0,this.redrawSideicons=!0,this.packetType=-1,!0;if(this.packetType===Ct.MESSAGE_GAME){var P=this.in.gjstr;let i;if(P.endsWith(":tradereq:")){var Je=P.substring(0,P.indexOf(":"));i=ut.toBase37(Je);let t=!1;for(let e=0;e<this.ignoreCount;e++)if(this.ignoreName37[e]===i){t=!0;break}t||0!==this.overrideChat||this.addMessage(4,"wishes to trade with you.",Je)}else if(P.endsWith(":duelreq:")){var Qe=P.substring(0,P.indexOf(":"));i=ut.toBase37(Qe);let t=!1;for(let e=0;e<this.ignoreCount;e++)if(this.ignoreName37[e]===i){t=!0;break}t||0!==this.overrideChat||this.addMessage(8,"wishes to duel with you.",Qe)}else this.addMessage(0,P,"");return this.packetType=-1,!0}if(this.packetType===Ct.IF_SETOBJECT)return p=this.in.g2,ne=this.in.g2,oe=this.in.g2,m=dt.get(ne),ft.instances[p].model=m.getInterfaceModel(50),ft.instances[p].xan=m.xan2d,ft.instances[p].yan=m.yan2d,ft.instances[p].zoom=100*m.zoom2d/oe|0,this.packetType=-1,!0;if(this.packetType===Ct.IF_OPENMAINMODAL)return g=this.in.g2,this.resetInterfaceAnimation(g),-1!==this.sidebarInterfaceId&&(this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0),-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0),this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0),this.viewportInterfaceId=g,this.pressedContinueOption=!1,this.packetType=-1,!0;if(this.packetType===Ct.IF_SETCOLOUR)return ce=this.in.g2,de=(C=this.in.g2)>>10&31,ue=C>>5&31,fe=31&C,ft.instances[ce].colour=(de<<19)+(ue<<11)+(fe<<3),this.packetType=-1,!0;if(this.packetType===Ct.RESET_ANIMS){for(let e=0;e<this.players.length;e++){var $e=this.players[e];$e&&($e.primarySeqId=-1)}for(let e=0;e<this.npcs.length;e++){var et=this.npcs[e];et&&(et.primarySeqId=-1)}return this.packetType=-1,!0}if(this.packetType===Ct.IF_SETHIDE)return pe=this.in.g2,ft.instances[pe].hide=1===this.in.g1,this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_IGNORELIST){this.ignoreCount=this.packetSize/8|0;for(let e=0;e<this.ignoreCount;e++)this.ignoreName37[e]=this.in.g8;return this.packetType=-1,!0}if(this.packetType===Ct.CAM_RESET){this.cutscene=!1;for(let e=0;e<5;e++)this.cameraModifierEnabled[e]=!1;return this.packetType=-1,!0}if(this.packetType===Ct.IF_CLOSE)return-1!==this.sidebarInterfaceId&&(this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0),-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0),this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0),this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0;if(this.packetType===Ct.IF_SETTEXT)return y=this.in.g2,ft.instances[y].text=this.in.gjstr,ft.instances[y].layer===this.tabInterfaceId[this.selectedTab]&&(this.redrawSidebar=!0),this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_STAT){this.redrawSidebar=!0;var B=this.in.g1,tt=this.in.g4,it=this.in.g1;this.skillExperience[B]=tt,this.skillLevel[B]=it,this.skillBaseLevel[B]=1;for(let e=0;e<98;e++)tt>=this.levelExperience[e]&&(this.skillBaseLevel[B]=e+2);return this.packetType=-1,!0}if(this.packetType===Ct.UPDATE_ZONE_PARTIAL_ENCLOSED){for(this.baseX=this.in.g1,this.baseZ=this.in.g1;this.in.pos<this.packetSize;){var st=this.in.g1;this.readZonePacket(this.in,st)}return this.packetType=-1,!0}if(this.packetType===Ct.UPDATE_RUNWEIGHT)return 12===this.selectedTab&&(this.redrawSidebar=!0),this.weightCarried=this.in.g2b,this.packetType=-1,!0;if(this.packetType===Ct.CAM_SHAKE)return v=this.in.g1,me=this.in.g1,ge=this.in.g1,Ce=this.in.g1,this.cameraModifierEnabled[v]=!0,this.cameraModifierJitter[v]=me,this.cameraModifierWobbleScale[v]=ge,this.cameraModifierWobbleSpeed[v]=Ce,this.cameraModifierCycle[v]=0,this.packetType=-1,!0;if(this.packetType===Ct.UPDATE_INV_PARTIAL){this.redrawSidebar=!0;for(var at=this.in.g2,D=ft.instances[at];this.in.pos<this.packetSize;){var M=this.in.g1,rt=this.in.g2;let e=this.in.g1;255===e&&(e=this.in.g4),D.invSlotObjId&&D.invSlotObjCount&&0<=M&&M<D.invSlotObjId.length&&(D.invSlotObjId[M]=rt,D.invSlotObjCount[M]=e)}return this.packetType=-1,!0}if(this.packetType===Ct.PLAYER_INFO)return this.readPlayerInfo(this.in,this.packetSize),1===this.sceneState&&(this.sceneState=2,mt.levelBuilt=this.currentLevel,this.buildScene()),Client.lowMemory&&2===this.sceneState&&mt.levelBuilt!==this.currentLevel&&(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",ct.BLACK),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",ct.WHITE),this.areaViewport?.draw(8,11),mt.levelBuilt=this.currentLevel,this.buildScene()),this.currentLevel!==this.minimapLevel&&2===this.sceneState&&(this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel)),this.packetType=-1,!0;await this.logout()}catch(e){await this.logout()}return!0};buildScene=()=>{this.minimapLevel=-1,this.temporaryLocs.clear(),this.locList.clear(),this.spotanims.clear(),this.projectiles.clear(),_.clearTexels(),this.clearCaches(),this.scene?.reset();for(let e=0;e<pt.LEVELS;e++)this.levelCollisionMap[e]?.reset();var t=new mt(pt.SIZE,pt.SIZE,this.levelHeightmap,this.levelTileFlags),i=(mt.lowMemory=Client.lowMemory,this.sceneMapLandData?.length??0);if(this.sceneMapIndex)for(let e=0;e<i;e++){var s=this.sceneMapIndex[e]>>8,a=255&this.sceneMapIndex[e];if(33==s&&71<=a&&a<=73){mt.lowMemory=!1;break}}if(Client.lowMemory?this.scene?.setMinLevel(this.currentLevel):this.scene?.setMinLevel(0),this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(gt.NO_TIMEOUT);for(let e=0;e<i;e++){var r=64*(this.sceneMapIndex[e]>>8)-this.sceneBaseTileX,h=64*(255&this.sceneMapIndex[e])-this.sceneBaseTileZ,l=this.sceneMapLandData[e];l?(l=vt.decompress(l,-1,!1,!0),t.readLandscape(8*(this.sceneCenterZoneX-6),8*(this.sceneCenterZoneZ-6),r,h,l)):this.sceneCenterZoneZ<800&&t.clearLandscape(h,r,64,64)}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(gt.NO_TIMEOUT);for(let e=0;e<i;e++){var n=64*(this.sceneMapIndex[e]>>8)-this.sceneBaseTileX,o=64*(255&this.sceneMapIndex[e])-this.sceneBaseTileZ,c=this.sceneMapLocData[e];c&&(c=vt.decompress(c,-1,!1,!0),t.readLocs(this.scene,this.locList,this.levelCollisionMap,c,n,o))}}this.out.p1isaac(gt.NO_TIMEOUT),t.build(this.scene,this.levelCollisionMap),this.areaViewport?.bind(),this.out.p1isaac(gt.NO_TIMEOUT);for(let e=this.locList.head();e;e=this.locList.next())2===(this.levelTileFlags&&2&this.levelTileFlags[1][e.heightmapNE][e.heightmapNW])&&(e.heightmapSW--,e.heightmapSW<0)&&e.unlink();for(let t=0;t<pt.SIZE;t++)for(let e=0;e<pt.SIZE;e++)this.sortObjStacks(t,e);for(let e=this.spawnedLocations.head();e;e=this.spawnedLocations.next())this.addLoc(e.plane,e.x,e.z,e.locIndex,e.angle,e.shape,e.layer);P.modelCacheStatic?.clear(),_.initPool(20)};resetInterfaceAnimation=e=>{var t=ft.instances[e];if(t.childId)for(let e=0;e<t.childId.length&&-1!==t.childId[e];e++){var i=ft.instances[t.childId[e]];1===i.type&&this.resetInterfaceAnimation(i.id),i.seqFrame=0,i.seqCycle=0}};initializeLevelExperience=()=>{let t=0;for(let e=0;e<99;e++){var i=e+1;t+=i+300*Math.pow(2,i/7)|0,this.levelExperience[e]=t/4|0}};addMessage=(e,t,i)=>{0===e&&-1!==this.stickyChatInterfaceId&&(this.modalMessage=t,this.mouseClickButton=0),-1===this.chatInterfaceId&&(this.redrawChatback=!0);for(let e=99;0<e;e--)this.messageType[e]=this.messageType[e-1],this.messageSender[e]=this.messageSender[e-1],this.messageText[e]=this.messageText[e-1];this.messageType[0]=e,this.messageSender[0]=i,this.messageText[0]=t};updateVarp=async e=>{var t,i=Q.instances[e].clientcode;0!==i&&(e=this.varps[e],1===i&&(1===e&&_.setBrightness(.9),2===e&&_.setBrightness(.8),3===e&&_.setBrightness(.7),4===e&&_.setBrightness(.6),dt.iconCache?.clear(),this.redrawTitleBackground=!0),3===i&&(t=this.midiActive,0===e&&(this.midiVolume=128,o(128),this.midiActive=!0),1===e&&(this.midiVolume=96,o(96),this.midiActive=!0),2===e&&(this.midiVolume=64,o(64),this.midiActive=!0),3===e&&(this.midiVolume=32,o(32),this.midiActive=!0),4===e&&(this.midiActive=!1),this.midiActive!==t)&&(this.midiActive&&this.currentMidi?await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,!1):l(!1),this.nextMusicDelay=0),4===i&&(0===e&&(this.waveVolume=128,h(128),this.waveEnabled=!0),1===e&&(this.waveVolume=96,h(96),this.waveEnabled=!0),2===e&&(this.waveVolume=64,h(64),this.waveEnabled=!0),3===e&&(this.waveVolume=32,h(32),this.waveEnabled=!0),4===e)&&(this.waveEnabled=!1),5===i&&(this.mouseButtonsOption=e),6===i&&(this.chatEffects=e),8===i)&&(this.splitPrivateChat=e,this.redrawChatback=!0)};handleChatMouseInput=(e,t)=>{let i=0;for(let e=0;e<100;e++)if(this.messageText[e]){var s=this.messageType[e],a=this.chatScrollOffset+70+4-14*i;if(a<-20)break;0===s&&i++,1!==s&&2!==s||!(1===s||0===this.publicChatSetting||1===this.publicChatSetting&&this.isFriend(this.messageSender[e]))||(a-14<t&&t<=a&&this.localPlayer&&this.messageSender[e]!==this.localPlayer.name&&(this.rights&&(this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=34,this.menuSize++),this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=406,this.menuSize++),i++),3!==s&&7!==s||0!==this.splitPrivateChat||!(7===s||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(this.messageSender[e]))||(a-14<t&&t<=a&&(this.rights&&(this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=34,this.menuSize++),this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=406,this.menuSize++),i++),4===s&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(this.messageSender[e]))&&(a-14<t&&t<=a&&(this.menuOption[this.menuSize]="Accept trade @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=903,this.menuSize++),i++),(5===s||6===s)&&0===this.splitPrivateChat&&this.privateChatSetting<2&&i++,8===s&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(this.messageSender[e]))&&(a-14<t&&t<=a&&(this.menuOption[this.menuSize]="Accept duel @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=363,this.menuSize++),i++)}};handlePrivateChatInput=i=>{if(0!==this.splitPrivateChat){let t=0;0!==this.systemUpdateTimer&&(t=1);for(let e=0;e<100;e++)if(null!==this.messageText[e]){var s=this.messageType[e];if((3===s||7===s)&&(7===s||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(this.messageSender[e]))){var a=329-13*t;if(8<this.mouseX&&this.mouseX<520&&a-10<i-11&&i-11<=3+a&&(this.rights&&(this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=2034,this.menuSize++),this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=2436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[e],this.menuAction[this.menuSize]=2406,this.menuSize++),5<=++t)return}if((5===s||6===s)&&this.privateChatSetting<2&&5<=++t)return}}};handleInterfaceInput=(t,r,h,i,s,a)=>{if(!(0!==t.type||!t.childId||t.hide||r<i||h<s||r>i+t.width||h>s+t.height)&&t.childX&&t.childY){var l=t.childId.length;for(let e=0;e<l;e++){var n=t.childX[e]+i,o=t.childY[e]+s-a,c=ft.instances[t.childId[e]];if(n+=c.x,o+=c.y,(0<=c.overLayer||0!==c.overColour)&&n<=r&&o<=h&&r<n+c.width&&h<o+c.height&&(0<=c.overLayer?this.lastHoveredInterfaceId=c.overLayer:this.lastHoveredInterfaceId=c.id),0===c.type)this.handleInterfaceInput(c,r,h,n,o,c.scrollPosition),c.scroll>c.height&&this.handleScrollInput(r,h,c.scroll,c.height,!0,n+c.width,o,c);else if(2===c.type){let a=0;for(let s=0;s<c.height;s++)for(let i=0;i<c.width;i++){let e=n+i*(c.marginX+32),t=o+s*(c.marginY+32);if(a<20&&c.invSlotOffsetX&&c.invSlotOffsetY&&(e+=c.invSlotOffsetX[a],t+=c.invSlotOffsetY[a]),r<e||h<t||r>=e+32||h>=t+32);else if(this.hoveredSlot=a,this.hoveredSlotParentId=c.id,c.invSlotObjId&&!(c.invSlotObjId[a]<=0)){var d=dt.get(c.invSlotObjId[a]-1);if(1===this.objSelected&&c.interactable)c.id===this.objSelectedInterface&&a===this.objSelectedSlot||(this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+d.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=d.id,this.menuParamB[this.menuSize]=a,this.menuParamC[this.menuSize]=c.id,this.menuSize++);else if(1===this.spellSelected&&c.interactable)16==(16&this.activeSpellFlags)&&(this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+d.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=d.id,this.menuParamB[this.menuSize]=a,this.menuParamC[this.menuSize]=c.id,this.menuSize++);else{if(c.interactable)for(let e=4;3<=e;e--)d.iop&&d.iop[e]?(this.menuOption[this.menuSize]=d.iop[e]+" @lre@"+d.name,3===e?this.menuAction[this.menuSize]=478:4===e&&(this.menuAction[this.menuSize]=347),this.menuParamA[this.menuSize]=d.id,this.menuParamB[this.menuSize]=a,this.menuParamC[this.menuSize]=c.id,this.menuSize++):4===e&&(this.menuOption[this.menuSize]="Drop @lre@"+d.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=d.id,this.menuParamB[this.menuSize]=a,this.menuParamC[this.menuSize]=c.id,this.menuSize++);if(c.usable&&(this.menuOption[this.menuSize]="Use @lre@"+d.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=d.id,this.menuParamB[this.menuSize]=a,this.menuParamC[this.menuSize]=c.id,this.menuSize++),c.interactable&&d.iop)for(let e=2;0<=e;e--)d.iop[e]&&(this.menuOption[this.menuSize]=d.iop[e]+" @lre@"+d.name,0===e?this.menuAction[this.menuSize]=405:1===e?this.menuAction[this.menuSize]=38:2===e&&(this.menuAction[this.menuSize]=422),this.menuParamA[this.menuSize]=d.id,this.menuParamB[this.menuSize]=a,this.menuParamC[this.menuSize]=c.id,this.menuSize++);if(c.iops)for(let e=4;0<=e;e--)c.iops[e]&&(this.menuOption[this.menuSize]=c.iops[e]+" @lre@"+d.name,0===e?this.menuAction[this.menuSize]=602:1===e?this.menuAction[this.menuSize]=596:2===e?this.menuAction[this.menuSize]=22:3===e?this.menuAction[this.menuSize]=892:4===e&&(this.menuAction[this.menuSize]=415),this.menuParamA[this.menuSize]=d.id,this.menuParamB[this.menuSize]=a,this.menuParamC[this.menuSize]=c.id,this.menuSize++);this.menuOption[this.menuSize]="Examine @lre@"+d.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=d.id,c.invSlotObjCount&&(this.menuParamC[this.menuSize]=c.invSlotObjCount[a]),this.menuSize++}}a++}}else if(n<=r&&o<=h&&r<n+c.width&&h<o+c.height)if(c.buttonType===ft.BUTTON_OK){let e=!1;!(e=0!==c.clientCode?this.handleSocialMenuOption(c):e)&&c.option&&(this.menuOption[this.menuSize]=c.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=c.id,this.menuSize++)}else if(c.buttonType===ft.BUTTON_TARGET&&0===this.spellSelected){let e=c.actionVerb;e&&~e.indexOf(" ")&&(e=e.substring(0,e.indexOf(" "))),this.menuOption[this.menuSize]=e+" @gre@"+c.action,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=c.id,this.menuSize++}else c.buttonType===ft.BUTTON_CLOSE?(this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=c.id,this.menuSize++):c.buttonType===ft.BUTTON_TOGGLE&&c.option?(this.menuOption[this.menuSize]=c.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=c.id,this.menuSize++):c.buttonType===ft.BUTTON_SELECT&&c.option?(this.menuOption[this.menuSize]=c.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=c.id,this.menuSize++):c.buttonType===ft.BUTTON_CONTINUE&&!this.pressedContinueOption&&c.option&&(this.menuOption[this.menuSize]=c.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=c.id,this.menuSize++)}}};handleSocialMenuOption=e=>{let t=e.clientCode;return t>=ft.CC_FRIENDS_START&&t<=ft.CC_FRIENDS_UPDATE_END?(t>=ft.CC_FRIENDS_UPDATE_START?t-=ft.CC_FRIENDS_UPDATE_START:t--,this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[t],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[t],this.menuAction[this.menuSize]=679,this.menuSize++,!0):t>=ft.CC_IGNORES_START&&t<=ft.CC_IGNORES_END&&(this.menuOption[this.menuSize]="Remove @whi@"+e.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0)};handleViewportOptions=()=>{0===this.objSelected&&0===this.spellSelected&&(this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++);let t=-1;for(let e=0;e<ot.pickedCount;e++){var i=ot.pickedBitsets[e],s=127&i,a=i>>7&127,r=i>>29&3,h=i>>14&32767;if(i!==t){if(t=i,2==r&&this.scene&&0<=this.scene.getInfo(this.currentLevel,s,a,i)){var l=P.get(h);if(1===this.objSelected)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+l.name,this.menuAction[this.menuSize]=450,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++;else if(1!==this.spellSelected){if(l.op)for(let e=4;0<=e;e--)l.op[e]&&(this.menuOption[this.menuSize]=l.op[e]+" @cya@"+l.name,0===e&&(this.menuAction[this.menuSize]=285),1===e&&(this.menuAction[this.menuSize]=504),2===e&&(this.menuAction[this.menuSize]=364),3===e&&(this.menuAction[this.menuSize]=581),4===e&&(this.menuAction[this.menuSize]=1501),this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++);this.menuOption[this.menuSize]="Examine @cya@"+l.name,this.menuAction[this.menuSize]=1175,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++}else 4==(4&this.activeSpellFlags)&&(this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+l.name,this.menuAction[this.menuSize]=55,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++)}if(1==r){var n=this.npcs[h];if(n&&n.type&&1===n.type.size&&64==(127&n.x)&&64==(127&n.z))for(let e=0;e<this.npcCount;e++){var o=this.npcs[this.npcIds[e]];o&&o!==n&&o.type&&1===o.type.size&&o.x===n.x&&o.z===n.z&&this.addNpcOptions(o.type,this.npcIds[e],s,a)}n&&n.type&&this.addNpcOptions(n.type,h,s,a)}if(0==r){var c=this.players[h];if(c&&64==(127&c.x)&&64==(127&c.z)){for(let e=0;e<this.npcCount;e++){var d=this.npcs[this.npcIds[e]];d&&d.type&&1===d.type.size&&d.x===c.x&&d.z===c.z&&this.addNpcOptions(d.type,this.npcIds[e],s,a)}for(let e=0;e<this.playerCount;e++){var u=this.players[this.playerIds[e]];u&&u!==c&&u.x===c.x&&u.z===c.z&&this.addPlayerOptions(u,this.playerIds[e],s,a)}}c&&this.addPlayerOptions(c,h,s,a)}if(3==r){var f=this.levelObjStacks[this.currentLevel][s][a];if(f)for(let t=f.tail();t;t=f.prev()){var p=dt.get(t.index);if(1===this.objSelected)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+p.name,this.menuAction[this.menuSize]=217,this.menuParamA[this.menuSize]=t.index,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++;else if(1!==this.spellSelected){for(let e=4;0<=e;e--)p.op&&p.op[e]?(this.menuOption[this.menuSize]=p.op[e]+" @lre@"+p.name,0===e&&(this.menuAction[this.menuSize]=224),1===e&&(this.menuAction[this.menuSize]=993),2===e&&(this.menuAction[this.menuSize]=99),3===e&&(this.menuAction[this.menuSize]=746),4===e&&(this.menuAction[this.menuSize]=877),this.menuParamA[this.menuSize]=t.index,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++):2===e&&(this.menuOption[this.menuSize]="Take @lre@"+p.name,this.menuAction[this.menuSize]=99,this.menuParamA[this.menuSize]=t.index,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++);this.menuOption[this.menuSize]="Examine @lre@"+p.name,this.menuAction[this.menuSize]=1102,this.menuParamA[this.menuSize]=t.index,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++}else 1==(1&this.activeSpellFlags)&&(this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+p.name,this.menuAction[this.menuSize]=965,this.menuParamA[this.menuSize]=t.index,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++)}}}}};addNpcOptions=(s,a,r,h)=>{if(!(400<=this.menuSize)){let i=s.name;if(0!==s.vislevel&&this.localPlayer&&(i=i+this.getCombatLevelColorTag(this.localPlayer.combatLevel,s.vislevel)+" (level-"+s.vislevel+")"),1===this.objSelected)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+i,this.menuAction[this.menuSize]=900,this.menuParamA[this.menuSize]=a,this.menuParamB[this.menuSize]=r,this.menuParamC[this.menuSize]=h,this.menuSize++;else if(1!==this.spellSelected){let t;if(s.op)for(t=4;0<=t;t--)s.op[t]&&"attack"!=s.op[t]?.toLowerCase()&&(this.menuOption[this.menuSize]=s.op[t]+" @yel@"+i,0===t?this.menuAction[this.menuSize]=728:1===t?this.menuAction[this.menuSize]=542:2===t?this.menuAction[this.menuSize]=6:3===t?this.menuAction[this.menuSize]=963:4===t&&(this.menuAction[this.menuSize]=245),this.menuParamA[this.menuSize]=a,this.menuParamB[this.menuSize]=r,this.menuParamC[this.menuSize]=h,this.menuSize++);if(s.op)for(t=4;0<=t;t--)if(s.op[t]&&"attack"==s.op[t]?.toLowerCase()){let e=0;this.localPlayer&&s.vislevel>this.localPlayer.combatLevel&&(e=2e3),this.menuOption[this.menuSize]=s.op[t]+" @yel@"+i,0===t?this.menuAction[this.menuSize]=e+728:1===t?this.menuAction[this.menuSize]=e+542:2===t?this.menuAction[this.menuSize]=e+6:3===t?this.menuAction[this.menuSize]=e+963:4===t&&(this.menuAction[this.menuSize]=e+245),this.menuParamA[this.menuSize]=a,this.menuParamB[this.menuSize]=r,this.menuParamC[this.menuSize]=h,this.menuSize++}this.menuOption[this.menuSize]="Examine @yel@"+i,this.menuAction[this.menuSize]=1607,this.menuParamA[this.menuSize]=a,this.menuParamB[this.menuSize]=r,this.menuParamC[this.menuSize]=h,this.menuSize++}else 2==(2&this.activeSpellFlags)&&(this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+i,this.menuAction[this.menuSize]=265,this.menuParamA[this.menuSize]=a,this.menuParamB[this.menuSize]=r,this.menuParamC[this.menuSize]=h,this.menuSize++)}};addPlayerOptions=(e,i,s,a)=>{if(!(e===this.localPlayer||400<=this.menuSize)){let t=null;this.localPlayer&&(t=e.name+this.getCombatLevelColorTag(this.localPlayer.combatLevel,e.combatLevel)+" (level-"+e.combatLevel+")"),1===this.objSelected?(this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+t,this.menuAction[this.menuSize]=367,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++):1!==this.spellSelected?(this.menuOption[this.menuSize]="Follow @whi@"+t,this.menuAction[this.menuSize]=1544,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++,0===this.overrideChat&&(this.menuOption[this.menuSize]="Trade with @whi@"+t,this.menuAction[this.menuSize]=1373,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++),0<this.wildernessLevel&&(this.menuOption[this.menuSize]="Attack @whi@"+t,this.localPlayer&&this.localPlayer.combatLevel>=e.combatLevel?this.menuAction[this.menuSize]=151:this.menuAction[this.menuSize]=2151,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++),1===this.worldLocationState&&(this.menuOption[this.menuSize]="Fight @whi@"+t,this.menuAction[this.menuSize]=151,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++),2===this.worldLocationState&&(this.menuOption[this.menuSize]="Duel-with @whi@"+t,this.menuAction[this.menuSize]=1101,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++)):8==(8&this.activeSpellFlags)&&(this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+t,this.menuAction[this.menuSize]=651,this.menuParamA[this.menuSize]=i,this.menuParamB[this.menuSize]=s,this.menuParamC[this.menuSize]=a,this.menuSize++);for(let e=0;e<this.menuSize;e++)if(660===this.menuAction[e])return void(this.menuOption[e]="Walk here @whi@"+t)}};getCombatLevelColorTag=(e,t)=>{e-=t;return e<-9?"@red@":e<-6?"@or3@":e<-3?"@or2@":e<0?"@or1@":9<e?"@gre@":6<e?"@gr3@":3<e?"@gr2@":0<e?"@gr1@":"@yel@"};handleInput=()=>{if(0===this.objDragArea){this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.handlePrivateChatInput(this.mouseY),this.lastHoveredInterfaceId=0,8<this.mouseX&&11<this.mouseY&&this.mouseX<520&&this.mouseY<345&&(-1===this.viewportInterfaceId?this.handleViewportOptions():this.handleInterfaceInput(ft.instances[this.viewportInterfaceId],this.mouseX,this.mouseY,8,11,0)),this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex&&(this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId),this.lastHoveredInterfaceId=0,562<this.mouseX&&231<this.mouseY&&this.mouseX<752&&this.mouseY<492&&(-1!==this.sidebarInterfaceId?this.handleInterfaceInput(ft.instances[this.sidebarInterfaceId],this.mouseX,this.mouseY,562,231,0):-1!==this.tabInterfaceId[this.selectedTab]&&this.handleInterfaceInput(ft.instances[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,562,231,0)),this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex&&(this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId),this.lastHoveredInterfaceId=0,22<this.mouseX&&375<this.mouseY&&this.mouseX<431&&this.mouseY<471&&(-1===this.chatInterfaceId?this.handleChatMouseInput(this.mouseX-22,this.mouseY-375):this.handleInterfaceInput(ft.instances[this.chatInterfaceId],this.mouseX,this.mouseY,22,375,0)),-1!==this.chatInterfaceId&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex&&(this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId);let t=!1;for(;!t;){t=!0;for(let e=0;e<this.menuSize-1;e++){var i;this.menuAction[e]<1e3&&1e3<this.menuAction[e+1]&&(i=this.menuOption[e],this.menuOption[e]=this.menuOption[e+1],this.menuOption[e+1]=i,i=this.menuAction[e],this.menuAction[e]=this.menuAction[e+1],this.menuAction[e+1]=i,i=this.menuParamB[e],this.menuParamB[e]=this.menuParamB[e+1],this.menuParamB[e+1]=i,i=this.menuParamC[e],this.menuParamC[e]=this.menuParamC[e+1],this.menuParamC[e+1]=i,i=this.menuParamA[e],this.menuParamA[e]=this.menuParamA[e+1],this.menuParamA[e+1]=i,t=!1)}}}};showContextMenu=()=>{let t=0;if(this.fontBold12){var i;t=this.fontBold12.stringWidth("Choose Option");for(let e=0;e<this.menuSize;e++)(i=this.fontBold12.stringWidth(this.menuOption[e]))>t&&(t=i)}t+=8;var e=15*this.menuSize+21;let s,a;8<this.mouseClickX&&11<this.mouseClickY&&this.mouseClickX<520&&this.mouseClickY<345&&(512<(s=this.mouseClickX-(t/2|0)-8)+t?s=512-t:s<0&&(s=0),334<(a=this.mouseClickY-11)+e?a=334-e:a<0&&(a=0),this.menuVisible=!0,this.menuArea=0,this.menuX=s,this.menuY=a,this.menuWidth=t,this.menuHeight=15*this.menuSize+22),562<this.mouseClickX&&231<this.mouseClickY&&this.mouseClickX<752&&this.mouseClickY<492&&((s=this.mouseClickX-(t/2|0)-562)<0?s=0:190<s+t&&(s=190-t),(a=this.mouseClickY-231)<0?a=0:261<a+e&&(a=261-e),this.menuVisible=!0,this.menuArea=1,this.menuX=s,this.menuY=a,this.menuWidth=t,this.menuHeight=15*this.menuSize+22),22<this.mouseClickX&&375<this.mouseClickY&&this.mouseClickX<501&&this.mouseClickY<471&&((s=this.mouseClickX-(t/2|0)-22)<0?s=0:479<s+t&&(s=479-t),(a=this.mouseClickY-375)<0?a=0:96<a+e&&(a=96-e),this.menuVisible=!0,this.menuArea=2,this.menuX=s,this.menuY=a,this.menuWidth=t,this.menuHeight=15*this.menuSize+22)};tryMove=(e,t,a,r,i,s,h,l,n,o,c)=>{var d=this.levelCollisionMap[this.currentLevel];if(!d)return!1;var u=pt.SIZE,f=pt.SIZE;for(let t=0;t<u;t++)for(let e=0;e<f;e++){var p=pt.index(t,e);this.bfsDirection[p]=0,this.bfsCost[p]=99999999}let m=e,g=t;var C=pt.index(e,t);this.bfsDirection[C]=99;let y=this.bfsCost[C]=0,v=0,w=(this.bfsStepX[y]=e,this.bfsStepZ[y++]=t,!1),T=this.bfsStepX.length;for(var S=d.flags;v!==y;){if(m=this.bfsStepX[v],g=this.bfsStepZ[v],v=(v+1)%T,m===a&&g===r){w=!0;break}if(n!==k.WALL_STRAIGHT.id){if((n<k.WALLDECOR_STRAIGHT_OFFSET.id||n===k.CENTREPIECE_STRAIGHT.id)&&d.reachedWall(m,g,a,r,n-1,l)){w=!0;break}if(n<k.CENTREPIECE_STRAIGHT.id&&d.reachedWallDecoration(m,g,a,r,n-1,l)){w=!0;break}}if(0!==s&&0!==h&&d.reachedLoc(m,g,a,r,s,h,o)){w=!0;break}var A=this.bfsCost[pt.index(m,g)]+1,O=pt.index(m-1,g);0<m&&0===this.bfsDirection[O]&&(S[O]&M.BLOCK_WEST)===M.OPEN&&(this.bfsStepX[y]=m-1,this.bfsStepZ[y]=g,y=(y+1)%T,this.bfsDirection[O]=2,this.bfsCost[O]=A),O=pt.index(m+1,g),m<u-1&&0===this.bfsDirection[O]&&(S[O]&M.BLOCK_EAST)===M.OPEN&&(this.bfsStepX[y]=m+1,this.bfsStepZ[y]=g,y=(y+1)%T,this.bfsDirection[O]=8,this.bfsCost[O]=A),O=pt.index(m,g-1),0<g&&0===this.bfsDirection[O]&&(S[O]&M.BLOCK_SOUTH)===M.OPEN&&(this.bfsStepX[y]=m,this.bfsStepZ[y]=g-1,y=(y+1)%T,this.bfsDirection[O]=1,this.bfsCost[O]=A),O=pt.index(m,g+1),g<f-1&&0===this.bfsDirection[O]&&(S[O]&M.BLOCK_NORTH)===M.OPEN&&(this.bfsStepX[y]=m,this.bfsStepZ[y]=g+1,y=(y+1)%T,this.bfsDirection[O]=4,this.bfsCost[O]=A),O=pt.index(m-1,g-1),0<m&&0<g&&0===this.bfsDirection[O]&&0==(S[O]&M.BLOCK_SOUTH_WEST)&&(S[pt.index(m-1,g)]&M.BLOCK_WEST)===M.OPEN&&(S[pt.index(m,g-1)]&M.BLOCK_SOUTH)===M.OPEN&&(this.bfsStepX[y]=m-1,this.bfsStepZ[y]=g-1,y=(y+1)%T,this.bfsDirection[O]=3,this.bfsCost[O]=A),O=pt.index(m+1,g-1),m<u-1&&0<g&&0===this.bfsDirection[O]&&0==(S[O]&M.BLOCK_SOUTH_EAST)&&(S[pt.index(m+1,g)]&M.BLOCK_EAST)===M.OPEN&&(S[pt.index(m,g-1)]&M.BLOCK_SOUTH)===M.OPEN&&(this.bfsStepX[y]=m+1,this.bfsStepZ[y]=g-1,y=(y+1)%T,this.bfsDirection[O]=9,this.bfsCost[O]=A),O=pt.index(m-1,g+1),0<m&&g<f-1&&0===this.bfsDirection[O]&&0==(S[O]&M.BLOCK_NORTH_WEST)&&(S[pt.index(m-1,g)]&M.BLOCK_WEST)===M.OPEN&&(S[pt.index(m,g+1)]&M.BLOCK_NORTH)===M.OPEN&&(this.bfsStepX[y]=m-1,this.bfsStepZ[y]=g+1,y=(y+1)%T,this.bfsDirection[O]=6,this.bfsCost[O]=A),O=pt.index(m+1,g+1),m<u-1&&g<f-1&&0===this.bfsDirection[O]&&0==(S[O]&M.BLOCK_NORTH_EAST)&&(S[pt.index(m+1,g)]&M.BLOCK_EAST)===M.OPEN&&(S[pt.index(m,g+1)]&M.BLOCK_NORTH)===M.OPEN&&(this.bfsStepX[y]=m+1,this.bfsStepZ[y]=g+1,y=(y+1)%T,this.bfsDirection[O]=12,this.bfsCost[O]=A)}if(this.tryMoveNearest=0,!w){if(c){let s=100;for(let i=1;i<2;i++){for(let t=a-i;t<=a+i;t++)for(let e=r-i;e<=r+i;e++){var I=pt.index(t,e);0<=t&&0<=e&&t<pt.SIZE&&e<pt.SIZE&&this.bfsCost[I]<s&&(s=this.bfsCost[I],m=t,g=e,this.tryMoveNearest=1,w=!0)}if(w)break}}if(!w)return!1}v=0,this.bfsStepX[v]=m,this.bfsStepZ[v++]=g;let L=this.bfsDirection[pt.index(m,g)],b=L;for(;m!==e||g!==t;)b!==L&&(L=b,this.bfsStepX[v]=m,this.bfsStepZ[v++]=g),0!=(b&$.EAST)?m++:0!=(b&$.WEST)&&m--,0!=(b&$.NORTH)?g++:0!=(b&$.SOUTH)&&g--,b=this.bfsDirection[pt.index(m,g)];if(0<v){T=Math.min(v,25),v--;var E=this.bfsStepX[v],x=this.bfsStepZ[v];0===i?(this.out.p1isaac(gt.MOVE_GAMECLICK),this.out.p1(T+T+3)):1===i?(this.out.p1isaac(gt.MOVE_MINIMAPCLICK),this.out.p1(T+T+3+14)):2===i&&(this.out.p1isaac(gt.MOVE_OPCLICK),this.out.p1(T+T+3)),1===this.actionKey[5]?this.out.p1(1):this.out.p1(0),this.out.p2(E+this.sceneBaseTileX),this.out.p2(x+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let e=1;e<T;e++)v--,this.out.p1(this.bfsStepX[v]-E),this.out.p1(this.bfsStepZ[v]-x);return!0}return 1!==i};readPlayerInfo=(e,t)=>{this.entityRemovalCount=0,this.entityUpdateCount=0,this.readLocalPlayer(e),this.readPlayers(e),this.readNewPlayers(e,t),this.readPlayerUpdates(e);for(let e=0;e<this.entityRemovalCount;e++){var i=this.entityRemovalIds[e],s=this.players[i];s&&s.cycle!==this.loopCycle&&(this.players[i]=null)}if(e.pos!==t)throw Error(`eek! Error packet size mismatch in getplayer pos:${e.pos} psize:`+t);for(let e=0;e<this.playerCount;e++)if(!this.players[this.playerIds[e]])throw Error(`eek! ${this.username} null entry in pl list - pos:${e} size:`+this.playerCount)};readLocalPlayer=e=>{var t,i,s;e.bits(),0!==e.gBit(1)&&(0===(i=e.gBit(2))?this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX:1===i?(t=e.gBit(3),this.localPlayer?.step(!1,t),1===e.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX)):2===i?(t=e.gBit(3),this.localPlayer?.step(!0,t),t=e.gBit(3),this.localPlayer?.step(!0,t),1===e.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX)):3===i&&(this.currentLevel=e.gBit(2),t=e.gBit(7),i=e.gBit(7),s=e.gBit(1),this.localPlayer?.move(1===s,t,i),1===e.gBit(1))&&(this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX))};readPlayers=t=>{var i=t.gBit(8);if(i<this.playerCount)for(let e=i;e<this.playerCount;e++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[e];if(i>this.playerCount)throw Error(`eek! ${this.username} Too many players`);for(let e=this.playerCount=0;e<i;e++){var s,a,r,h=this.playerIds[e],l=this.players[h];0===t.gBit(1)?(this.playerIds[this.playerCount++]=h,l&&(l.cycle=this.loopCycle)):0===(s=t.gBit(2))?(this.playerIds[this.playerCount++]=h,l&&(l.cycle=this.loopCycle),this.entityUpdateIds[this.entityUpdateCount++]=h):1===s?(this.playerIds[this.playerCount++]=h,l&&(l.cycle=this.loopCycle),a=t.gBit(3),l?.step(!1,a),1===t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=h)):2===s?(this.playerIds[this.playerCount++]=h,l&&(l.cycle=this.loopCycle),a=t.gBit(3),l?.step(!0,a),r=t.gBit(3),l?.step(!0,r),1===t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=h)):3===s&&(this.entityRemovalIds[this.entityRemovalCount++]=h)}};readNewPlayers=(i,e)=>{for(var s;i.bitPos+10<8*e&&2047!==(s=i.gBit(11));){!this.players[s]&&(this.players[s]=new c,a=this.playerAppearanceBuffer[s])&&this.players[s]?.read(a),this.playerIds[this.playerCount++]=s;var a=this.players[s];a&&(a.cycle=this.loopCycle);let e=i.gBit(5),t=(15<e&&(e-=32),i.gBit(5));15<t&&(t-=32);var r=i.gBit(1),r=(this.localPlayer&&a?.move(1===r,this.localPlayer.pathTileX[0]+e,this.localPlayer.pathTileZ[0]+t),i.gBit(1));1===r&&(this.entityUpdateIds[this.entityUpdateCount++]=s)}i.bytes()};readPlayerUpdates=t=>{for(let e=0;e<this.entityUpdateCount;e++){var i=this.entityUpdateIds[e],s=this.players[i];if(s){let e=t.g1;(e&c.BIG_UPDATE)===c.BIG_UPDATE&&(e+=t.g1<<8),this.readPlayerUpdatesBlocks(s,i,e,t)}}};readPlayerUpdatesBlocks=(i,e,t,s)=>{if(i.lastMask=t,i.lastMaskCycle=this.loopCycle,(t&c.APPEARANCE)===c.APPEARANCE&&(a=s.g1,r=new Uint8Array(a),h=new ht(r),s.gdata(a,0,r),this.playerAppearanceBuffer[e]=h,i.read(h)),(t&c.ANIM)===c.ANIM){let e=s.g2;(e=65535===e?-1:e)===i.primarySeqId&&(i.primarySeqLoop=0);var a=s.g1;(-1===e||-1===i.primarySeqId||R.instances[e].priority>R.instances[i.primarySeqId].priority||0===R.instances[i.primarySeqId].priority)&&(i.primarySeqId=e,i.primarySeqFrame=0,i.primarySeqCycle=0,i.primarySeqDelay=a,i.primarySeqLoop=0)}if((t&c.FACE_ENTITY)===c.FACE_ENTITY&&(i.targetId=s.g2,65535===i.targetId)&&(i.targetId=-1),(t&c.SAY)===c.SAY&&(i.chat=s.gjstr,i.chatColor=0,i.chatStyle=0,i.chatTimer=150,i.name)&&this.addMessage(2,i.chat,i.name),(t&c.DAMAGE)===c.DAMAGE&&(i.damage=s.g1,i.damageType=s.g1,i.combatCycle=this.loopCycle+400,i.health=s.g1,i.totalHealth=s.g1),(t&c.FACE_COORD)===c.FACE_COORD&&(i.targetTileX=s.g2,i.targetTileZ=s.g2,i.lastFaceX=i.targetTileX,i.lastFaceZ=i.targetTileZ),(t&c.CHAT)===c.CHAT){var r=s.g2,e=s.g1,h=s.g1,a=s.pos;if(i.name){var l=ut.toBase37(i.name);let t=!1;if(e<=1)for(let e=0;e<this.ignoreCount;e++)if(this.ignoreName37[e]===l){t=!0;break}if(!t&&0===this.overrideChat)try{var n=Ot.unpack(s,h),o=At.filter(n);i.chat=o,i.chatColor=r>>8,i.chatStyle=255&r,i.chatTimer=150,1<e?this.addMessage(1,o,i.name):this.addMessage(2,o,i.name)}catch(e){}}s.pos=a+h}(t&c.SPOTANIM)===c.SPOTANIM&&(i.spotanimId=s.g2,i.spotanimOffset=(n=s.g4)>>16,i.spotanimLastCycle=this.loopCycle+(65535&n),i.spotanimFrame=0,i.spotanimCycle=0,i.spotanimLastCycle>this.loopCycle&&(i.spotanimFrame=-1),65535===i.spotanimId)&&(i.spotanimId=-1),(t&c.EXACT_MOVE)===c.EXACT_MOVE&&(i.forceMoveStartSceneTileX=s.g1,i.forceMoveStartSceneTileZ=s.g1,i.forceMoveEndSceneTileX=s.g1,i.forceMoveEndSceneTileZ=s.g1,i.forceMoveEndCycle=s.g2+this.loopCycle,i.forceMoveStartCycle=s.g2+this.loopCycle,i.forceMoveFaceDirection=s.g1,i.pathLength=0,i.pathTileX[0]=i.forceMoveEndSceneTileX,i.pathTileZ[0]=i.forceMoveEndSceneTileZ)};readNpcInfo=(e,t)=>{this.entityRemovalCount=0,this.entityUpdateCount=0,this.readNpcs(e),this.readNewNpcs(e,t),this.readNpcUpdates(e);for(let e=0;e<this.entityRemovalCount;e++){var i=this.entityRemovalIds[e],s=this.npcs[i];s&&s.cycle!==this.loopCycle&&(s.type=null,this.npcs[i]=null)}if(e.pos!==t)throw Error(`eek! ${this.username} size mismatch in getnpcpos - pos:${e.pos} psize:`+t);for(let e=0;e<this.npcCount;e++)if(!this.npcs[this.npcIds[e]])throw Error(`eek! ${this.username} null entry in npc list - pos:${e} size:`+this.npcCount)};readNpcs=t=>{t.bits();var i=t.gBit(8);if(i<this.npcCount)for(let e=i;e<this.npcCount;e++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[e];if(i>this.npcCount)throw Error(`eek! ${this.username} Too many npcs`);for(let e=this.npcCount=0;e<i;e++){var s,a,r,h=this.npcIds[e],l=this.npcs[h];0===t.gBit(1)?(this.npcIds[this.npcCount++]=h,l&&(l.cycle=this.loopCycle)):0===(s=t.gBit(2))?(this.npcIds[this.npcCount++]=h,l&&(l.cycle=this.loopCycle),this.entityUpdateIds[this.entityUpdateCount++]=h):1===s?(this.npcIds[this.npcCount++]=h,l&&(l.cycle=this.loopCycle),a=t.gBit(3),l?.step(!1,a),1===t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=h)):2===s?(this.npcIds[this.npcCount++]=h,l&&(l.cycle=this.loopCycle),a=t.gBit(3),l?.step(!0,a),r=t.gBit(3),l?.step(!0,r),1===t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=h)):3===s&&(this.entityRemovalIds[this.entityRemovalCount++]=h)}};readNewNpcs=(i,e)=>{for(;i.bitPos+21<8*e;){var s=i.gBit(13);if(8191===s)break;this.npcs[s]||(this.npcs[s]=new r);var a=this.npcs[s];this.npcIds[this.npcCount++]=s,a?(a.cycle=this.loopCycle,a.type=Tt.get(i.gBit(11)),a.size=a.type.size,a.seqWalkId=a.type.walkanim,a.seqTurnAroundId=a.type.walkanim_b,a.seqTurnLeftId=a.type.walkanim_r,a.seqTurnRightId=a.type.walkanim_l,a.seqStandId=a.type.readyanim):i.gBit(11);let e=i.gBit(5),t=(15<e&&(e-=32),i.gBit(5));15<t&&(t-=32),this.localPlayer&&a?.move(!1,this.localPlayer.pathTileX[0]+e,this.localPlayer.pathTileZ[0]+t),1===i.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=s)}i.bytes()};readNpcUpdates=t=>{for(let e=0;e<this.entityUpdateCount;e++){var i=this.entityUpdateIds[e],i=this.npcs[i];if(i){var s=t.g1;if(i.lastMask=s,i.lastMaskCycle=this.loopCycle,(s&r.ANIM)===r.ANIM){let e=t.g2;(e=65535===e?-1:e)===i.primarySeqId&&(i.primarySeqLoop=0);var a=t.g1;(-1===e||-1===i.primarySeqId||R.instances[e].priority>R.instances[i.primarySeqId].priority||0===R.instances[i.primarySeqId].priority)&&(i.primarySeqId=e,i.primarySeqFrame=0,i.primarySeqCycle=0,i.primarySeqDelay=a,i.primarySeqLoop=0)}(s&r.FACE_ENTITY)===r.FACE_ENTITY&&(i.targetId=t.g2,65535===i.targetId)&&(i.targetId=-1),(s&r.SAY)===r.SAY&&(i.chat=t.gjstr,i.chatTimer=100),(s&r.DAMAGE)===r.DAMAGE&&(i.damage=t.g1,i.damageType=t.g1,i.combatCycle=this.loopCycle+400,i.health=t.g1,i.totalHealth=t.g1),(s&r.CHANGE_TYPE)===r.CHANGE_TYPE&&(i.type=Tt.get(t.g2),i.seqWalkId=i.type.walkanim,i.seqTurnAroundId=i.type.walkanim_b,i.seqTurnLeftId=i.type.walkanim_r,i.seqTurnRightId=i.type.walkanim_l,i.seqStandId=i.type.readyanim),(s&r.SPOTANIM)===r.SPOTANIM&&(i.spotanimId=t.g2,i.spotanimOffset=(a=t.g4)>>16,i.spotanimLastCycle=this.loopCycle+(65535&a),i.spotanimFrame=0,i.spotanimCycle=0,i.spotanimLastCycle>this.loopCycle&&(i.spotanimFrame=-1),65535===i.spotanimId)&&(i.spotanimId=-1),(s&r.FACE_COORD)===r.FACE_COORD&&(i.targetTileX=t.g2,i.targetTileZ=t.g2,i.lastFaceX=i.targetTileX,i.lastFaceZ=i.targetTileZ)}}};updatePlayers=()=>{for(let t=-1;t<this.playerCount;t++){let e;e=-1===t?this.LOCAL_PLAYER_INDEX:this.playerIds[t];var i=this.players[e];i&&this.updateEntity(i)}var e;Client.cyclelogic6++,1406<Client.cyclelogic6&&(Client.cyclelogic6=0,this.out.p1isaac(gt.ANTICHEAT_CYCLELOGIC6),this.out.p1(0),e=this.out.pos,this.out.p1(162),this.out.p1(22),0==(2*Math.random()|0)&&this.out.p1(84),this.out.p2(31824),this.out.p2(13490),0==(2*Math.random()|0)&&this.out.p1(123),0==(2*Math.random()|0)&&this.out.p1(134),this.out.p1(100),this.out.p1(94),this.out.p2(35521),this.out.psize1(this.out.pos-e))};updateEntity=e=>{(e.x<128||e.z<128||13184<=e.x||13184<=e.z)&&(e.primarySeqId=-1,e.spotanimId=-1,e.forceMoveEndCycle=0,e.forceMoveStartCycle=0,e.x=128*e.pathTileX[0]+64*e.size,e.z=128*e.pathTileZ[0]+64*e.size,e.pathLength=0),e===this.localPlayer&&(e.x<1536||e.z<1536||11776<=e.x||11776<=e.z)&&(e.primarySeqId=-1,e.spotanimId=-1,e.forceMoveEndCycle=0,e.forceMoveStartCycle=0,e.x=128*e.pathTileX[0]+64*e.size,e.z=128*e.pathTileZ[0]+64*e.size,e.pathLength=0),e.forceMoveEndCycle>this.loopCycle?this.updateForceMovement(e):e.forceMoveStartCycle>=this.loopCycle?this.startForceMovement(e):this.updateMovement(e),this.updateFacingDirection(e),this.updateSequences(e)};pushPlayers=()=>{if(this.localPlayer){this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ&&(this.flagSceneTileX=0);for(let i=-1;i<this.playerCount;i++){let e,t;if(t=-1===i?(e=this.localPlayer,this.LOCAL_PLAYER_INDEX<<14):(e=this.players[this.playerIds[i]],this.playerIds[i]<<14),e&&e.isVisible()){e.lowMemory=(Client.lowMemory&&50<this.playerCount||200<this.playerCount)&&-1!==i&&e.secondarySeqId===e.seqStandId;var s=e.x>>7,a=e.z>>7;if(!(s<0||s>=pt.SIZE||a<0||a>=pt.SIZE))if(!e.locModel||this.loopCycle<e.locStartCycle||this.loopCycle>=e.locStopCycle){if(64==(127&e.x)&&64==(127&e.z)){if(this.tileLastOccupiedCycle[s][a]===this.sceneCycle)continue;this.tileLastOccupiedCycle[s][a]=this.sceneCycle}e.y=this.getHeightmapY(this.currentLevel,e.x,e.z),this.scene?.addTemporary(this.currentLevel,e.x,e.y,e.z,null,e,t,e.yaw,60,e.seqStretches)}else e.lowMemory=!1,e.y=this.getHeightmapY(this.currentLevel,e.x,e.z),this.scene?.addTemporary2(this.currentLevel,e.x,e.y,e.z,e.minTileX,e.minTileZ,e.maxTileX,e.maxTileZ,null,e,t,e.yaw)}}}};updateNpcs=()=>{for(let e=0;e<this.npcCount;e++){var t=this.npcIds[e],t=this.npcs[t];t&&t.type&&this.updateEntity(t)}};pushNpcs=()=>{for(let e=0;e<this.npcCount;e++){var t=this.npcs[this.npcIds[e]],i=536870912+(this.npcIds[e]<<14)|0;if(t&&t.isVisible()){var s=t.x>>7,a=t.z>>7;if(!(s<0||s>=pt.SIZE||a<0||a>=pt.SIZE)){if(1===t.size&&64==(127&t.x)&&64==(127&t.z)){if(this.tileLastOccupiedCycle[s][a]===this.sceneCycle)continue;this.tileLastOccupiedCycle[s][a]=this.sceneCycle}this.scene?.addTemporary(this.currentLevel,t.x,this.getHeightmapY(this.currentLevel,t.x,t.z),t.z,null,t,i,t.yaw,64*(t.size-1)+60,t.seqStretches)}}}};pushProjectiles=()=>{for(let t=this.projectiles.head();t;t=this.projectiles.next())if(t.level!==this.currentLevel||this.loopCycle>t.lastCycle)t.unlink();else if(this.loopCycle>=t.startCycle){if(0<t.target&&(i=this.npcs[t.target-1])&&t.updateVelocity(i.x,this.getHeightmapY(t.level,i.x,i.z)-t.offsetY,i.z,this.loopCycle),t.target<0){var i=-t.target-1;let e;(e=i===this.localPid?this.localPlayer:this.players[i])&&t.updateVelocity(e.x,this.getHeightmapY(t.level,e.x,e.z)-t.offsetY,e.z,this.loopCycle)}t.update(this.sceneDelta),this.scene?.addTemporary(this.currentLevel,0|t.x,0|t.y,0|t.z,null,t,-1,t.yaw,60,!1)}};pushSpotanims=()=>{for(let e=this.spotanims.head();e;e=this.spotanims.next())e.level!==this.currentLevel||e.seqComplete?e.unlink():this.loopCycle>=e.startCycle&&(e.update(this.sceneDelta),e.seqComplete?e.unlink():this.scene?.addTemporary(e.level,e.x,e.y,e.z,null,e,-1,0,60,!1))};pushLocs=()=>{for(let s=this.locList.head();s;s=this.locList.next()){let e=!1;if(s.seqCycle+=this.sceneDelta,-1===s.seqFrame&&(s.seqFrame=0,e=!0),s.seq.delay)for(;s.seqCycle>s.seq.delay[s.seqFrame];)if(s.seqCycle-=s.seq.delay[s.seqFrame]+1,s.seqFrame++,e=!0,s.seqFrame>=s.seq.frameCount&&(s.seqFrame-=s.seq.replayoff,s.seqFrame<0||s.seqFrame>=s.seq.frameCount)){s.unlink(),e=!1;break}if(e&&this.scene){var a=s.heightmapSW,r=s.heightmapNE,h=s.heightmapNW;let i=0;if(0===s.heightmapSE?i=this.scene.getWallBitset(a,r,h):1===s.heightmapSE?i=this.scene.getWallDecorationBitset(a,h,r):2===s.heightmapSE?i=this.scene.getLocBitset(a,r,h):3===s.heightmapSE&&(i=this.scene.getGroundDecorationBitset(a,r,h)),this.levelHeightmap&&0!==i&&(i>>14&32767)===s.index){var l,n,o,c=this.levelHeightmap[a][r][h],d=this.levelHeightmap[a][r+1][h],u=this.levelHeightmap[a][r+1][h+1],f=this.levelHeightmap[a][r][h+1],p=P.get(s.index);let t=-1;if(-1!==s.seqFrame&&s.seq.frames&&(t=s.seq.frames[s.seqFrame]),2===s.heightmapSE){var m=this.scene.getInfo(a,r,h,i);let e=31&m;var m=m>>6;e===k.CENTREPIECE_DIAGONAL.id&&(e=k.CENTREPIECE_STRAIGHT.id),this.scene?.setLocModel(a,r,h,p.getModel(e,m,c,d,u,f,t))}else 1===s.heightmapSE?this.scene?.setWallDecorationModel(a,r,h,p.getModel(k.WALLDECOR_STRAIGHT_NOOFFSET.id,0,c,d,u,f,t)):0===s.heightmapSE?(n=(m=this.scene.getInfo(a,r,h,i))>>6,(l=31&m)===k.WALL_L.id?(o=1+n&3,this.scene?.setWallModels(r,h,a,p.getModel(k.WALL_L.id,4+n,c,d,u,f,t),p.getModel(k.WALL_L.id,o,c,d,u,f,t))):this.scene?.setWallModel(a,r,h,p.getModel(l,n,c,d,u,f,t))):3===s.heightmapSE&&(o=this.scene.getInfo(a,r,h,i)>>6,this.scene?.setGroundDecorationModel(a,r,h,p.getModel(k.GROUND_DECOR.id,o,c,d,u,f,t)))}else s.unlink()}}};updateEntityChats=()=>{for(let t=-1;t<this.playerCount;t++){let e;e=-1===t?this.LOCAL_PLAYER_INDEX:this.playerIds[t];var i=this.players[e];i&&0<i.chatTimer&&(i.chatTimer--,0===i.chatTimer)&&(i.chat=null)}for(let e=0;e<this.npcCount;e++){var t=this.npcIds[e],t=this.npcs[t];t&&0<t.chatTimer&&(t.chatTimer--,0===t.chatTimer)&&(t.chat=null)}};updateTemporaryLocs=()=>{if(2===this.sceneState){for(let e=this.temporaryLocs.head();e;e=this.temporaryLocs.next())this.loopCycle>=e.lastCycle&&(this.addLoc(e.plane,e.x,e.z,e.locIndex,e.angle,e.shape,e.layer),e.unlink());Client.cyclelogic5++,85<Client.cyclelogic5&&(Client.cyclelogic5=0,this.out.p1isaac(gt.ANTICHEAT_CYCLELOGIC5))}};updateForceMovement=e=>{var t=e.forceMoveEndCycle-this.loopCycle,i=128*e.forceMoveStartSceneTileZ+64*e.size;e.x+=(128*e.forceMoveStartSceneTileX+64*e.size-e.x)/t|0,e.z+=(i-e.z)/t|0,(e.seqTrigger=0)===e.forceMoveFaceDirection&&(e.dstYaw=1024),1===e.forceMoveFaceDirection&&(e.dstYaw=1536),2===e.forceMoveFaceDirection&&(e.dstYaw=0),3===e.forceMoveFaceDirection&&(e.dstYaw=512)};startForceMovement=e=>{var t,i,s,a;(e.forceMoveStartCycle===this.loopCycle||-1===e.primarySeqId||0!==e.primarySeqDelay||e.primarySeqCycle+1>R.instances[e.primarySeqId].delay[e.primarySeqFrame])&&(t=e.forceMoveStartCycle-e.forceMoveEndCycle,i=this.loopCycle-e.forceMoveEndCycle,s=128*e.forceMoveStartSceneTileZ+64*e.size,a=128*e.forceMoveEndSceneTileZ+64*e.size,e.x=((128*e.forceMoveStartSceneTileX+64*e.size)*(t-i)+(128*e.forceMoveEndSceneTileX+64*e.size)*i)/t|0,e.z=(s*(t-i)+a*i)/t|0),(e.seqTrigger=0)===e.forceMoveFaceDirection&&(e.dstYaw=1024),1===e.forceMoveFaceDirection&&(e.dstYaw=1536),2===e.forceMoveFaceDirection&&(e.dstYaw=0),3===e.forceMoveFaceDirection&&(e.dstYaw=512),e.yaw=e.dstYaw};updateFacingDirection=t=>{if(-1!==t.targetId&&t.targetId<32768&&(s=this.npcs[t.targetId])&&(i=t.x-s.x,s=t.z-s.z,0==i&&0==s||(t.dstYaw=2047&(325.949*Math.atan2(i,s)|0))),32768<=t.targetId){let e=t.targetId-32768;e===this.localPid&&(e=this.LOCAL_PLAYER_INDEX);var i=this.players[e];i&&(s=t.x-i.x,i=t.z-i.z,0==s&&0==i||(t.dstYaw=2047&(325.949*Math.atan2(s,i)|0)))}0===t.targetTileX&&0===t.targetTileZ||!(0===t.pathLength||0<t.seqTrigger)||(s=t.x-64*(t.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX),i=t.z-64*(t.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ),0==s&&0==i||(t.dstYaw=2047&(325.949*Math.atan2(s,i)|0)),t.targetTileX=0,t.targetTileZ=0);var s=t.dstYaw-t.yaw&2047;0!=s&&(s<32||2016<s?t.yaw=t.dstYaw:1024<s?t.yaw-=32:t.yaw+=32,t.yaw&=2047,t.secondarySeqId===t.seqStandId)&&t.yaw!==t.dstYaw&&(-1!==t.seqTurnId?t.secondarySeqId=t.seqTurnId:t.secondarySeqId=t.seqWalkId)};updateSequences=e=>{e.seqStretches=!1;let t;if(-1!==e.secondarySeqId&&(t=R.instances[e.secondarySeqId],e.secondarySeqCycle++,t.delay&&e.secondarySeqFrame<t.frameCount&&e.secondarySeqCycle>t.delay[e.secondarySeqFrame]&&(e.secondarySeqCycle=0,e.secondarySeqFrame++),e.secondarySeqFrame>=t.frameCount)&&(e.secondarySeqCycle=0,e.secondarySeqFrame=0),-1!==e.primarySeqId&&0===e.primarySeqDelay){for(t=R.instances[e.primarySeqId],e.primarySeqCycle++;t.delay&&e.primarySeqFrame<t.frameCount&&e.primarySeqCycle>t.delay[e.primarySeqFrame];)e.primarySeqCycle-=t.delay[e.primarySeqFrame],e.primarySeqFrame++;e.primarySeqFrame>=t.frameCount&&(e.primarySeqFrame-=t.replayoff,e.primarySeqLoop++,e.primarySeqLoop>=t.replaycount&&(e.primarySeqId=-1),e.primarySeqFrame<0||e.primarySeqFrame>=t.frameCount)&&(e.primarySeqId=-1),e.seqStretches=t.stretches}if(0<e.primarySeqDelay&&e.primarySeqDelay--,-1!==e.spotanimId&&this.loopCycle>=e.spotanimLastCycle){for(e.spotanimFrame<0&&(e.spotanimFrame=0),t=J.instances[e.spotanimId].seq,e.spotanimCycle++;t&&t.delay&&e.spotanimFrame<t.frameCount&&e.spotanimCycle>t.delay[e.spotanimFrame];)e.spotanimCycle-=t.delay[e.spotanimFrame],e.spotanimFrame++;t&&e.spotanimFrame>=t.frameCount&&(e.spotanimFrame<0||e.spotanimFrame>=t.frameCount)&&(e.spotanimId=-1)}};updateMovement=s=>{if(s.secondarySeqId=s.seqStandId,0===s.pathLength)s.seqTrigger=0;else{if(-1!==s.primarySeqId&&0===s.primarySeqDelay)if(!R.instances[s.primarySeqId].walkmerge)return void s.seqTrigger++;var a=s.x,r=s.z,h=128*s.pathTileX[s.pathLength-1]+64*s.size,l=128*s.pathTileZ[s.pathLength-1]+64*s.size;if(h-a<=256&&-256<=h-a&&l-r<=256&&-256<=l-r){s.dstYaw=a<h?r<l?1280:l<r?1792:1536:h<a?r<l?768:l<r?256:512:r<l?1024:0;let e=s.dstYaw-s.yaw&2047,t=(1024<e&&(e-=2048),s.seqTurnAroundId),i=(-256<=e&&e<=256?t=s.seqWalkId:256<=e&&e<768?t=s.seqTurnRightId:-768<=e&&e<=-256&&(t=s.seqTurnLeftId),-1===t&&(t=s.seqWalkId),s.secondarySeqId=t,4);s.yaw!==s.dstYaw&&-1===s.targetId&&(i=2),2<s.pathLength&&(i=6),3<s.pathLength&&(i=8),0<s.seqTrigger&&1<s.pathLength&&(i=8,s.seqTrigger--),s.pathRunning[s.pathLength-1]&&(i<<=1),8<=i&&s.secondarySeqId===s.seqWalkId&&-1!==s.seqRunId&&(s.secondarySeqId=s.seqRunId),a<h?(s.x+=i,h<s.x&&(s.x=h)):h<a&&(s.x-=i,s.x<h)&&(s.x=h),r<l?(s.z+=i,l<s.z&&(s.z=l)):l<r&&(s.z-=i,s.z<l)&&(s.z=l),s.x===h&&s.z===l&&s.pathLength--}else s.x=h,s.z=l}};getTopLevel=()=>{let h=3;if(this.cameraPitch<310&&this.localPlayer){let e=this.cameraX>>7,t=this.cameraZ>>7;var l=this.localPlayer.x>>7,n=this.localPlayer.z>>7;this.levelTileFlags&&0!=(4&this.levelTileFlags[this.currentLevel][e][t])&&(h=this.currentLevel);let i;i=l>e?l-e:e-l;let s;s=n>t?n-t:t-n;let a,r;if(i>s)for(a=65536*s/i|0,r=32768;e!==l;)e<l?e++:e>l&&e--,this.levelTileFlags&&0!=(4&this.levelTileFlags[this.currentLevel][e][t])&&(h=this.currentLevel),65536<=(r+=a)&&(r-=65536,t<n?t++:t>n&&t--,this.levelTileFlags)&&0!=(4&this.levelTileFlags[this.currentLevel][e][t])&&(h=this.currentLevel);else for(a=65536*i/s|0,r=32768;t!==n;)t<n?t++:t>n&&t--,this.levelTileFlags&&0!=(4&this.levelTileFlags[this.currentLevel][e][t])&&(h=this.currentLevel),65536<=(r+=a)&&(r-=65536,e<l?e++:e>l&&e--,this.levelTileFlags)&&0!=(4&this.levelTileFlags[this.currentLevel][e][t])&&(h=this.currentLevel)}return h=this.localPlayer&&this.levelTileFlags&&0!=(4&this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7])?this.currentLevel:h};getTopLevelCutscene=()=>this.levelTileFlags?800<=this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ)-this.cameraY||0==(4&this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7])?3:this.currentLevel:0;getHeightmapY=(e,t,i)=>{if(!this.levelHeightmap)return 0;var s=Math.min(t>>7,pt.SIZE-1),a=Math.min(i>>7,pt.SIZE-1);let r=e;e<3&&this.levelTileFlags&&2==(2&this.levelTileFlags[1][s][a])&&(r=e+1);e=127&t,t=127&i;return(this.levelHeightmap[r][s][a]*(128-e)+this.levelHeightmap[r][1+s][a]*e>>7)*(128-t)+(this.levelHeightmap[r][s][1+a]*(128-e)+this.levelHeightmap[r][1+s][1+a]*e>>7)*t>>7};orbitCamera=(e,t,i,s,a,r)=>{var h=2048-a&2047,l=2048-s&2047;let n=0,o=0,c=r,d,u,f;0!=h&&(d=_.sin[h],u=_.cos[h],f=o*u-r*d>>16,c=o*d+r*u>>16,o=f),0!=l&&(d=_.sin[l],u=_.cos[l],f=c*d+n*u>>16,c=c*u-n*d>>16,n=f),this.cameraX=e-n,this.cameraY=t-o,this.cameraZ=i-c,this.cameraPitch=a,this.cameraYaw=s};updateOrbitCamera=()=>{if(this.localPlayer){var t=this.localPlayer.x+this.cameraAnticheatOffsetX,i=this.localPlayer.z+this.cameraAnticheatOffsetZ,a=((this.orbitCameraX-t<-500||500<this.orbitCameraX-t||this.orbitCameraZ-i<-500||500<this.orbitCameraZ-i)&&(this.orbitCameraX=t,this.orbitCameraZ=i),this.orbitCameraX!==t&&(this.orbitCameraX+=(t-this.orbitCameraX)/16|0),this.orbitCameraZ!==i&&(this.orbitCameraZ+=(i-this.orbitCameraZ)/16|0),1===this.actionKey[1]?this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0:1===this.actionKey[2]?this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0:this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0,1===this.actionKey[3]?this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0:1===this.actionKey[4]?this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0:this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0,this.orbitCameraYaw=2047&(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0),this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0,this.orbitCameraPitch<128&&(this.orbitCameraPitch=128),383<this.orbitCameraPitch&&(this.orbitCameraPitch=383),this.orbitCameraX>>7),r=this.orbitCameraZ>>7,h=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ);let s=0;if(this.levelHeightmap&&3<a&&3<r&&a<100&&r<100)for(let i=a-4;i<=4+a;i++)for(let t=r-4;t<=4+r;t++){let e=this.currentLevel;e<3&&this.levelTileFlags&&2==(2&this.levelTileFlags[1][i][t])&&e++;var l=h-this.levelHeightmap[e][i][t];l>s&&(s=l)}let e=192*s;(e=(e=98048<e?98048:e)<32768?32768:e)>this.cameraPitchClamp?this.cameraPitchClamp+=(e-this.cameraPitchClamp)/24|0:e<this.cameraPitchClamp&&(this.cameraPitchClamp+=(e-this.cameraPitchClamp)/80|0)}};applyCutscene=()=>{var e=128*this.cutsceneSrcLocalTileX+64,t=128*this.cutsceneSrcLocalTileZ+64,i=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight,e=(this.cameraX<e&&(this.cameraX+=this.cutsceneMoveSpeed+((e-this.cameraX)*this.cutsceneMoveAcceleration/1e3|0),this.cameraX>e)&&(this.cameraX=e),this.cameraX>e&&(this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-e)*this.cutsceneMoveAcceleration/1e3|0),this.cameraX<e)&&(this.cameraX=e),this.cameraY<i&&(this.cameraY+=this.cutsceneMoveSpeed+((i-this.cameraY)*this.cutsceneMoveAcceleration/1e3|0),this.cameraY>i)&&(this.cameraY=i),this.cameraY>i&&(this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-i)*this.cutsceneMoveAcceleration/1e3|0),this.cameraY<i)&&(this.cameraY=i),this.cameraZ<t&&(this.cameraZ+=this.cutsceneMoveSpeed+((t-this.cameraZ)*this.cutsceneMoveAcceleration/1e3|0),this.cameraZ>t)&&(this.cameraZ=t),this.cameraZ>t&&(this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-t)*this.cutsceneMoveAcceleration/1e3|0),this.cameraZ<t)&&(this.cameraZ=t),e=128*this.cutsceneDstLocalTileX+64,t=128*this.cutsceneDstLocalTileZ+64,i=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,e-this.cameraX),i=i-this.cameraY,t=t-this.cameraZ;let s=2047&(325.949*Math.atan2(i,0|Math.sqrt(e*e+t*t))|0);i=2047&(-325.949*Math.atan2(e,t)|0);383<(s=s<128?128:s)&&(s=383),this.cameraPitch<s&&(this.cameraPitch+=this.cutsceneRotateSpeed+((s-this.cameraPitch)*this.cutsceneRotateAcceleration/1e3|0),this.cameraPitch>s)&&(this.cameraPitch=s),this.cameraPitch>s&&(this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-s)*this.cutsceneRotateAcceleration/1e3|0),this.cameraPitch<s)&&(this.cameraPitch=s);let a=i-this.cameraYaw,r=(1024<a&&(a-=2048),a<-1024&&(a+=2048),0<a&&(this.cameraYaw+=this.cutsceneRotateSpeed+(a*this.cutsceneRotateAcceleration/1e3|0),this.cameraYaw&=2047),a<0&&(this.cameraYaw-=this.cutsceneRotateSpeed+(-a*this.cutsceneRotateAcceleration/1e3|0),this.cameraYaw&=2047),i-this.cameraYaw);1024<r&&(r-=2048),r<-1024&&(r+=2048),(r<0&&0<a||0<r&&a<0)&&(this.cameraYaw=i)};readZonePacket=(t,i)=>{var n=t.g1;let o=this.baseX+(n>>4&7),c=this.baseZ+(7&n);if(i===Ct.LOC_ADD_CHANGE||i===Ct.LOC_DEL){var n=t.g1,d=n>>2,n=3&n,r=k.of(d).layer;let e;if(e=i===Ct.LOC_DEL?-1:t.g2,0<=o&&0<=c&&o<pt.SIZE&&c<pt.SIZE){let a=null;for(let e=this.spawnedLocations.head();e;e=this.spawnedLocations.next())if(e.plane===this.currentLevel&&e.x===o&&e.z===c&&e.layer===r){a=e;break}if(!a&&this.scene){let e=0,t=-1,i=0,s=0;r===S.WALL?e=this.scene.getWallBitset(this.currentLevel,o,c):r===S.WALL_DECOR?e=this.scene.getWallDecorationBitset(this.currentLevel,c,o):r===S.GROUND?e=this.scene.getLocBitset(this.currentLevel,o,c):r===S.GROUND_DECOR&&(e=this.scene.getGroundDecorationBitset(this.currentLevel,o,c)),0!==e&&(u=this.scene.getInfo(this.currentLevel,o,c,e),t=e>>14&32767,i=31&u,s=u>>6),a=new ue(this.currentLevel,r,o,c,0,N.WEST,k.WALL_STRAIGHT.id,t,s,i),this.spawnedLocations.addTail(a)}a&&(a.locIndex=e,a.shape=d,a.angle=n),this.addLoc(this.currentLevel,o,c,e,n,d,r)}}else if(i===Ct.LOC_ANIM){var u=t.g1>>2,n=k.of(u).layer,d=t.g2;if(0<=o&&0<=c&&o<pt.SIZE&&c<pt.SIZE&&this.scene){let e=0;n===S.WALL?e=this.scene.getWallBitset(this.currentLevel,o,c):n===S.WALL_DECOR?e=this.scene.getWallDecorationBitset(this.currentLevel,c,o):n===S.GROUND?e=this.scene.getLocBitset(this.currentLevel,o,c):n===S.GROUND_DECOR&&(e=this.scene.getGroundDecorationBitset(this.currentLevel,o,c)),0!==e&&(u=new A(e>>14&32767,this.currentLevel,n,o,c,R.instances[d],!1),this.locList.addTail(u))}}else if(i===Ct.OBJ_ADD){n=t.g2,d=t.g2;0<=o&&0<=c&&o<pt.SIZE&&c<pt.SIZE&&(u=new fe(n,d),this.levelObjStacks[this.currentLevel][o][c]||(this.levelObjStacks[this.currentLevel][o][c]=new O),this.levelObjStacks[this.currentLevel][o][c]?.addTail(u),this.sortObjStacks(o,c))}else if(i===Ct.OBJ_DEL){var s=t.g2;if(0<=o&&0<=c&&o<pt.SIZE&&c<pt.SIZE){var a=this.levelObjStacks[this.currentLevel][o][c];if(a){for(let e=a.head();e;e=a.next())if(e.index===(32767&s)){e.unlink();break}a.head()||(this.levelObjStacks[this.currentLevel][o][c]=null),this.sortObjStacks(o,c)}}}else if(i===Ct.MAP_PROJANIM){var n=o+t.g1b,d=c+t.g1b,u=t.g2b,f=t.g2,p=t.g1,m=t.g1,g=t.g2,C=t.g2,y=t.g1,v=t.g1;0<=o&&0<=c&&o<pt.SIZE&&c<pt.SIZE&&0<=n&&0<=d&&n<pt.SIZE&&d<pt.SIZE&&(o=128*o+64,c=128*c+64,n=128*n+64,d=128*d+64,(f=new pe(f,this.currentLevel,o,this.getHeightmapY(this.currentLevel,o,c)-p,c,g+this.loopCycle,C+this.loopCycle,y,v,u,m)).updateVelocity(n,this.getHeightmapY(this.currentLevel,n,d)-m,d,g+this.loopCycle),this.projectiles.addTail(f))}else if(i===Ct.MAP_ANIM){p=t.g2,C=t.g1,y=t.g2;0<=o&&0<=c&&o<pt.SIZE&&c<pt.SIZE&&(o=128*o+64,c=128*c+64,v=new me(p,this.currentLevel,o,c,this.getHeightmapY(this.currentLevel,o,c)-C,this.loopCycle,y),this.spotanims.addTail(v))}else if(i===Ct.OBJ_REVEAL){u=t.g2,n=t.g2,m=t.g2;0<=o&&0<=c&&o<pt.SIZE&&c<pt.SIZE&&m!==this.localPid&&(d=new fe(u,n),this.levelObjStacks[this.currentLevel][o][c]||(this.levelObjStacks[this.currentLevel][o][c]=new O),this.levelObjStacks[this.currentLevel][o][c]?.addTail(d),this.sortObjStacks(o,c))}else if(i===Ct.LOC_MERGE){g=t.g1,f=g>>2,p=3&g,C=k.of(f).layer,y=t.g2,v=t.g2,m=t.g2,u=t.g2;let s=t.g1b,a=t.g1b,r=t.g1b,h=t.g1b,l;if((l=u===this.localPid?this.localPlayer:this.players[u])&&this.levelHeightmap){n=new de(this.currentLevel,C,o,c,-1,p,f,v+this.loopCycle),d=(this.temporaryLocs.addTail(n),new de(this.currentLevel,C,o,c,y,p,f,m+this.loopCycle)),g=(this.temporaryLocs.addTail(d),this.levelHeightmap[this.currentLevel][o][c]),u=this.levelHeightmap[this.currentLevel][o+1][c],n=this.levelHeightmap[this.currentLevel][o+1][c+1],C=this.levelHeightmap[this.currentLevel][o][c+1],d=P.get(y);l.locStartCycle=v+this.loopCycle,l.locStopCycle=m+this.loopCycle,l.locModel=d.getModel(f,p,g,u,n,C,-1);let e=d.width,t=d.length;p!==N.NORTH&&p!==N.SOUTH||(e=d.length,t=d.width),l.locOffsetX=128*o+64*e,l.locOffsetZ=128*c+64*t,l.locOffsetY=this.getHeightmapY(this.currentLevel,l.locOffsetX,l.locOffsetZ);let i;s>r&&(i=s,s=r,r=i),a>h&&(i=a,a=h,h=i),l.minTileX=o+s,l.maxTileX=o+r,l.minTileZ=c+a,l.maxTileZ=c+h}}else if(i===Ct.OBJ_COUNT){var h=t.g2,l=t.g2,w=t.g2;if(0<=o&&0<=c&&o<pt.SIZE&&c<pt.SIZE){var T=this.levelObjStacks[this.currentLevel][o][c];if(T){for(let e=T.head();e;e=T.next())if(e.index===(32767&h)&&e.count===l){e.count=w;break}this.sortObjStacks(o,c)}}}};updateTextures=e=>{if(!Client.lowMemory){if(_.textureCycle[17]>=e){var t=_.textures[17];if(!t)return;var i=t.width*t.height-1,s=t.width*this.sceneDelta*2,a=t.pixels,r=this.textureBuffer;for(let e=0;e<=i;e++)r[e]=a[e-s&i];t.pixels=r,this.textureBuffer=a,_.pushTexture(17)}if(_.textureCycle[24]>=e){t=_.textures[24];if(t){var h=t.width*t.height-1,l=t.width*this.sceneDelta*2,n=t.pixels,o=this.textureBuffer;for(let e=0;e<=h;e++)o[e]=n[e-l&h];t.pixels=o,this.textureBuffer=n,_.pushTexture(24)}}}};updateFlames=()=>{if(this.flameBuffer3&&this.flameBuffer2&&this.flameBuffer0&&this.flameLineOffset){var e;for(let e=10;e<117;e++)(100*Math.random()|0)<50&&(this.flameBuffer3[e+32512]=255);for(let e=0;e<100;e++)this.flameBuffer3[2+(124*Math.random()|0)+(128+(128*Math.random()|0)<<7)]=192;for(let t=1;t<255;t++)for(let e=1;e<127;e++){var i=e+(t<<7);this.flameBuffer2[i]=(this.flameBuffer3[i-1]+this.flameBuffer3[i+1]+this.flameBuffer3[i-128]+this.flameBuffer3[i+128])/4|0}this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length&&(this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[12*Math.random()|0]));for(let i=1;i<255;i++)for(let t=1;t<127;t++){var s=t+(i<<7);let e=this.flameBuffer2[s+128]-(this.flameBuffer0[s+this.flameCycle0&this.flameBuffer0.length-1]/5|0);e<0&&(e=0),this.flameBuffer3[s]=e}for(let e=0;e<255;e++)this.flameLineOffset[e]=this.flameLineOffset[e+1];this.flameLineOffset[255]=16*Math.sin(this.loopCycle/14)+14*Math.sin(this.loopCycle/15)+12*Math.sin(this.loopCycle/16)|0,0<this.flameGradientCycle0&&(this.flameGradientCycle0-=4),0<this.flameGradientCycle1&&(this.flameGradientCycle1-=4),0===this.flameGradientCycle0&&0===this.flameGradientCycle1&&(0==(e=2e3*Math.random()|0)?this.flameGradientCycle0=1024:1==e&&(this.flameGradientCycle1=1024))}};mix=(e,t,i)=>{var s=256-t;return((16711935&e)*s+(16711935&i)*t&4278255360)+((65280&e)*s+(65280&i)*t&16711680)>>8};drawFlames=()=>{if(this.flameGradient&&this.flameGradient0&&this.flameGradient1&&this.flameGradient2&&this.flameLineOffset&&this.flameBuffer3){if(0<this.flameGradientCycle0)for(let e=0;e<256;e++)768<this.flameGradientCycle0?this.flameGradient[e]=this.mix(this.flameGradient0[e],1024-this.flameGradientCycle0,this.flameGradient1[e]):256<this.flameGradientCycle0?this.flameGradient[e]=this.flameGradient1[e]:this.flameGradient[e]=this.mix(this.flameGradient1[e],256-this.flameGradientCycle0,this.flameGradient0[e]);else if(0<this.flameGradientCycle1)for(let e=0;e<256;e++)768<this.flameGradientCycle1?this.flameGradient[e]=this.mix(this.flameGradient0[e],1024-this.flameGradientCycle1,this.flameGradient2[e]):256<this.flameGradientCycle1?this.flameGradient[e]=this.flameGradient2[e]:this.flameGradient[e]=this.mix(this.flameGradient2[e],256-this.flameGradientCycle1,this.flameGradient0[e]);else for(let e=0;e<256;e++)this.flameGradient[e]=this.flameGradient0[e];for(let e=0;e<33920;e++)this.imageTitle0&&this.imageFlamesLeft&&(this.imageTitle0.pixels[e]=this.imageFlamesLeft.pixels[e]);let i=0,s=1152;for(let e=1;e<255;e++){let t=22+(this.flameLineOffset[e]*(256-e)/256|0);t<0&&(t=0),i+=t;for(let e=t;e<128;e++){var a,r,h,l=this.flameBuffer3[i++];0===l?s++:(r=256-(a=l),l=this.flameGradient[l],this.imageTitle0&&(h=this.imageTitle0.pixels[s],this.imageTitle0.pixels[s++]=((16711935&l)*a+(16711935&h)*r&4278255360)+((65280&l)*a+(65280&h)*r&16711680)>>8))}s+=t}this.imageTitle0?.draw(0,0);for(let e=0;e<33920;e++)this.imageTitle1&&this.imageFlamesRight&&(this.imageTitle1.pixels[e]=this.imageFlamesRight.pixels[e]);i=0,s=1176;for(let e=1;e<255;e++){var t=this.flameLineOffset[e]*(256-e)/256|0,n=103-t;s+=t;for(let e=0;e<n;e++){var o,c,d,u=this.flameBuffer3[i++];0===u?s++:(c=256-(o=u),u=this.flameGradient[u],this.imageTitle1&&(d=this.imageTitle1.pixels[s],this.imageTitle1.pixels[s++]=((16711935&u)*o+(16711935&d)*c&4278255360)+((65280&u)*o+(65280&d)*c&16711680)>>8))}i+=128-n,s+=128-n-t}this.imageTitle1?.draw(661,0)}}}export{Client};