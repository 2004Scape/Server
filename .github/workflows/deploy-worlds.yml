name: Deploy to 2004scape.org world servers

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/deploy-worlds.yml'
      - 'data/**'
      - '!public/**'
      - 'public/js/teavm/classes.js'
      - 'src/**'
      - '!*.test.ts'
      - '!src/lostcity/web/**'
      - 'src/lostcity/web/routes/cache.js'
      - '!view/**'
      - 'view/webclient-inner.ejs'
  workflow_dispatch:

concurrency:
  group: deploy-worlds
  cancel-in-progress: true

jobs:
  deploy:
    strategy:
      matrix:
        world:
          - { number: 1, type: "Free", directory: "w1.225" }
          - { number: 2, type: "Members", directory: "w2.225" }
          - { number: 3, type: "Members", directory: "w3" }
          - { number: 4, type: "Free", directory: "w4" }
    name: Deploy to World ${{ matrix.world.number }} (${{ matrix.world.type }}) server
    runs-on: ubuntu-latest
    steps:
    - name: Executing commands over SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets['SSH_WORLD' + matrix.world.number + '_HOST'] }}
        username: ${{ secrets['SSH_WORLD' + matrix.world.number + '_USER'] }}
        key: ${{ secrets['SSH_WORLD' + matrix.world.number + '_KEY'] }}
        port: ${{ secrets['SSH_WORLD' + matrix.world.number + '_PORT'] }}
        script: |
          cd ${matrix.world.directory}
          pm2 stop w${matrix.world.number}-server
          git pull
          npm ci
          pm2 ${matrix.world.start_maintenance} w${matrix.world.number}-maintenance
          npm run client:clean
          npm run client:pack
          npm run server:clean
          npm run server:build
          pm2 ${matrix.world.stop_maintenance} w${matrix.world.number}-maintenance
          pm2 restart w${matrix.world.number}-server
